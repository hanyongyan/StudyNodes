ğŸ¤¤åŸºç¡€ç¯‡

- è®¤è¯†å¾®æœåŠ¡
- æœåŠ¡æ‹†åˆ†
- è¿œç¨‹è°ƒç”¨
- Eureka
- Ribbon
- Nacos
- Feign
- Gateway
- RabbitMQ
- Elasticsearch

ğŸ’»é«˜çº§ç¯‡

- JMeter
- Sentinel
- Seata
- Redis
- ã€‚ã€‚ã€‚

# è®¤è¯†å¾®æœåŠ¡

## å•ä½“æ¶æ„

**å•ä½“æ¶æ„**ï¼šå°†ä¸šåŠ¡çš„æ‰€æœ‰åŠŸèƒ½é›†ä¸­åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­å¼€å‘ï¼Œæ‰“æˆä¸€ä¸ªåŒ…éƒ¨ç½²ã€‚

![](https://cdn.xn2001.com/img/2021/20210901083809.png)

**ä¼˜ç‚¹**ï¼šæ¶æ„ç®€å•ï¼Œéƒ¨ç½²æˆæœ¬ä½

**ç¼ºç‚¹**ï¼šè€¦åˆåº¦é«˜ï¼ˆç»´æŠ¤å›°éš¾ã€å‡çº§å›°éš¾ï¼‰

## åˆ†å¸ƒå¼æ¶æ„

**åˆ†å¸ƒå¼æ¶æ„**ï¼šæ ¹æ®ä¸šåŠ¡åŠŸèƒ½å¯¹ç³»ç»Ÿåšæ‹†åˆ†ï¼Œæ¯ä¸ªä¸šåŠ¡åŠŸèƒ½æ¨¡å—ä½œä¸ºç‹¬ç«‹é¡¹ç›®å¼€å‘ï¼Œç§°ä¸ºä¸€ä¸ªæœåŠ¡ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092921.png)

**ä¼˜ç‚¹**ï¼šé™ä½æœåŠ¡è€¦åˆï¼Œæœ‰åˆ©äºæœåŠ¡å‡çº§å’Œæ‹“å±•

**ç¼ºç‚¹**ï¼šæœåŠ¡è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚

åˆ†å¸ƒå¼æ¶æ„è™½ç„¶é™ä½äº†æœåŠ¡è€¦åˆï¼Œä½†æ˜¯æœåŠ¡æ‹†åˆ†æ—¶ä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜éœ€è¦æ€è€ƒï¼š

- æœåŠ¡æ‹†åˆ†çš„ç²’åº¦å¦‚ä½•ç•Œå®šï¼Ÿ
- æœåŠ¡ä¹‹é—´å¦‚ä½•è°ƒç”¨ï¼Ÿ
- æœåŠ¡çš„è°ƒç”¨å…³ç³»å¦‚ä½•ç®¡ç†ï¼Ÿ

**äººä»¬éœ€è¦åˆ¶å®šä¸€å¥—è¡Œä¹‹æœ‰æ•ˆçš„æ ‡å‡†æ¥çº¦æŸåˆ†å¸ƒå¼æ¶æ„ã€‚**

## å¾®æœåŠ¡

å¾®æœåŠ¡çš„æ¶æ„ç‰¹å¾ï¼š

- å•ä¸€èŒè´£ï¼šå¾®æœåŠ¡æ‹†åˆ†ç²’åº¦æ›´å°ï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½å¯¹åº”å”¯ä¸€çš„ä¸šåŠ¡èƒ½åŠ›ï¼Œåšåˆ°å•ä¸€èŒè´£
- è‡ªæ²»ï¼šå›¢é˜Ÿç‹¬ç«‹ã€æŠ€æœ¯ç‹¬ç«‹ã€æ•°æ®ç‹¬ç«‹ï¼Œç‹¬ç«‹éƒ¨ç½²å’Œäº¤ä»˜
- é¢å‘æœåŠ¡ï¼šæœåŠ¡æä¾›ç»Ÿä¸€æ ‡å‡†çš„æ¥å£ï¼Œä¸è¯­è¨€å’ŒæŠ€æœ¯æ— å…³
- éš”ç¦»æ€§å¼ºï¼šæœåŠ¡è°ƒç”¨åšå¥½éš”ç¦»ã€å®¹é”™ã€é™çº§ï¼Œé¿å…å‡ºç°çº§è”é—®é¢˜

![](https://cdn.xn2001.com/img/2022/202205162352847.png)

å¾®æœåŠ¡çš„ä¸Šè¿°ç‰¹æ€§**å…¶å®æ˜¯åœ¨ç»™åˆ†å¸ƒå¼æ¶æ„åˆ¶å®šä¸€ä¸ªæ ‡å‡†**ï¼Œè¿›ä¸€æ­¥é™ä½æœåŠ¡ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæä¾›æœåŠ¡çš„ç‹¬ç«‹æ€§å’Œçµæ´»æ€§ã€‚åšåˆ°é«˜å†…èšï¼Œä½è€¦åˆã€‚

**å› æ­¤ï¼Œå¯ä»¥è®¤ä¸ºå¾®æœåŠ¡æ˜¯ä¸€ç§ç»è¿‡è‰¯å¥½æ¶æ„è®¾è®¡çš„åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆ ã€‚**

å…¶ä¸­åœ¨ Java é¢†åŸŸæœ€å¼•äººæ³¨ç›®çš„å°±æ˜¯ SpringCloud æä¾›çš„æ–¹æ¡ˆäº†ã€‚

## SpringCloud

SpringCloud æ˜¯ç›®å‰å›½å†…ä½¿ç”¨æœ€å¹¿æ³›çš„å¾®æœåŠ¡æ¡†æ¶ã€‚å®˜ç½‘åœ°å€ï¼šhttps://spring.io/projects/spring-cloudã€‚

SpringCloud é›†æˆäº†å„ç§å¾®æœåŠ¡åŠŸèƒ½ç»„ä»¶ï¼Œå¹¶åŸºäº SpringBoot å®ç°äº†è¿™äº›ç»„ä»¶çš„è‡ªåŠ¨è£…é…ï¼Œä»è€Œæä¾›äº†è‰¯å¥½çš„å¼€ç®±å³ç”¨ä½“éªŒã€‚

å…¶ä¸­å¸¸è§çš„ç»„ä»¶åŒ…æ‹¬ï¼š

![](https://cdn.xn2001.com/img/2021/20210901083717.png)

å¦å¤–ï¼ŒSpringCloud åº•å±‚æ˜¯ä¾èµ–äº SpringBoot çš„ï¼Œå¹¶ä¸”æœ‰ç‰ˆæœ¬çš„å…¼å®¹å…³ç³»ï¼Œå¦‚ä¸‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210901084050.png)

## å†…å®¹çŸ¥è¯†

![éœ€è¦å­¦ä¹ çš„å¾®æœåŠ¡çŸ¥è¯†å†…å®¹](https://cdn.xn2001.com/img/2021/20210901092925.png)

![æŠ€æœ¯æ ˆ](https://cdn.xn2001.com/img/2021/20210901084131.png)

![è‡ªåŠ¨åŒ–éƒ¨ç½²](https://cdn.xn2001.com/img/2021/20210901090737.png)

## æŠ€æœ¯æ ˆå¯¹æ¯”

![](https://cdn.xn2001.com/img/2021/20210901090726.png)

# æœåŠ¡æ‹†åˆ†

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/01-cloud-demo
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/01-cloud-demo

**æœåŠ¡æ‹†åˆ†æ³¨æ„äº‹é¡¹**

å•ä¸€èŒè´£ï¼šä¸åŒå¾®æœåŠ¡ï¼Œä¸è¦é‡å¤å¼€å‘ç›¸åŒä¸šåŠ¡

æ•°æ®ç‹¬ç«‹ï¼šä¸è¦è®¿é—®å…¶å®ƒå¾®æœåŠ¡çš„æ•°æ®åº“

é¢å‘æœåŠ¡ï¼šå°†è‡ªå·±çš„ä¸šåŠ¡æš´éœ²ä¸ºæ¥å£ï¼Œä¾›å…¶å®ƒå¾®æœåŠ¡è°ƒç”¨

![](https://cdn.xn2001.com/img/2021/20210901090745.png)

cloud-demoï¼šçˆ¶å·¥ç¨‹ï¼Œç®¡ç†ä¾èµ–

- order-serviceï¼šè®¢å•å¾®æœåŠ¡ï¼Œè´Ÿè´£è®¢å•ç›¸å…³ä¸šåŠ¡
- user-serviceï¼šç”¨æˆ·å¾®æœåŠ¡ï¼Œè´Ÿè´£ç”¨æˆ·ç›¸å…³ä¸šåŠ¡

è¦æ±‚ï¼š

- è®¢å•å¾®æœåŠ¡å’Œç”¨æˆ·å¾®æœåŠ¡éƒ½å¿…é¡»æœ‰**å„è‡ªçš„æ•°æ®åº“**ï¼Œç›¸äº’ç‹¬ç«‹
- è®¢å•æœåŠ¡å’Œç”¨æˆ·æœåŠ¡**éƒ½å¯¹å¤–æš´éœ² Restful çš„æ¥å£**
- è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œ**åªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„ Restful æ¥å£**ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“

å¾®æœåŠ¡é¡¹ç›®ä¸‹ï¼Œæ‰“å¼€ idea ä¸­çš„ Serviceï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯åŠ¨ã€‚

![](https://cdn.xn2001.com/img/2021/20210901090750.png)

å¯åŠ¨å®Œæˆåï¼Œè®¿é—® [http://localhost:8080/order/101](http://localhost:8080/order/101)

![](https://cdn.xn2001.com/img/2021/20210901090757.png)

# è¿œç¨‹è°ƒç”¨

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/02-cloud-restTemplate
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/02-cloud-restTemplate

æ­£å¦‚ä¸Šé¢çš„æœåŠ¡æ‹†åˆ†è¦æ±‚ä¸­æ‰€æåˆ°ï¼Œ

> è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œ**åªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„ Restful æ¥å£**ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“

å› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“ Java å¦‚ä½•å»å‘é€ http è¯·æ±‚ï¼ŒSpring æä¾›äº†ä¸€ä¸ª RestTemplate å·¥å…·ï¼Œåªéœ€è¦æŠŠå®ƒåˆ›å»ºå‡ºæ¥å³å¯ã€‚ï¼ˆå³æ³¨å…¥ Beanï¼‰

![](https://cdn.xn2001.com/img/2021/20210901090814.png)

å‘é€è¯·æ±‚ï¼Œè‡ªåŠ¨åºåˆ—åŒ–ä¸º Java å¯¹è±¡ã€‚

![](https://cdn.xn2001.com/img/2021/20210901090846.png)

å¯åŠ¨å®Œæˆåï¼Œè®¿é—®ï¼šhttp://localhost:8080/order/101

![](https://cdn.xn2001.com/img/2021/20210901090909.png)

åœ¨ä¸Šé¢ä»£ç çš„ url ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è°ƒç”¨æœåŠ¡çš„åœ°å€é‡‡ç”¨ç¡¬ç¼–ç ï¼Œè¿™åœ¨åç»­çš„å¼€å‘ä¸­è‚¯å®šæ˜¯ä¸ç†æƒ³çš„ï¼Œè¿™å°±éœ€è¦**æœåŠ¡æ³¨å†Œä¸­å¿ƒ**ï¼ˆEurekaï¼‰æ¥å¸®æˆ‘ä»¬è§£å†³è¿™ä¸ªäº‹æƒ…ã€‚

# Eurekaæ³¨å†Œä¸­å¿ƒ

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/03-cloud-eureka
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/03-cloud-eureka

æœ€å¹¿ä¸ºäººçŸ¥çš„æ³¨å†Œä¸­å¿ƒå°±æ˜¯ Eurekaï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210901090919.png)

**order-service å¦‚ä½•å¾—çŸ¥ user-service å®ä¾‹åœ°å€ï¼Ÿ**

- user-service æœåŠ¡å®ä¾‹å¯åŠ¨åï¼Œå°†è‡ªå·±çš„ä¿¡æ¯æ³¨å†Œåˆ° eureka-server(EurekaæœåŠ¡ç«¯)ï¼Œå«åš**æœåŠ¡æ³¨å†Œ**
- eureka-server ä¿å­˜æœåŠ¡åç§°åˆ°æœåŠ¡å®ä¾‹åœ°å€åˆ—è¡¨çš„æ˜ å°„å…³ç³»
- order-service æ ¹æ®æœåŠ¡åç§°ï¼Œæ‹‰å–å®ä¾‹åœ°å€åˆ—è¡¨ï¼Œè¿™ä¸ªå«**æœåŠ¡å‘ç°**æˆ–æœåŠ¡æ‹‰å–

**order-service å¦‚ä½•ä»å¤šä¸ª user-service å®ä¾‹ä¸­é€‰æ‹©å…·ä½“çš„å®ä¾‹ï¼Ÿ**

order-serviceä»å®ä¾‹åˆ—è¡¨ä¸­åˆ©ç”¨**è´Ÿè½½å‡è¡¡ç®—æ³•**é€‰ä¸­ä¸€ä¸ªå®ä¾‹åœ°å€ï¼Œå‘è¯¥å®ä¾‹åœ°å€å‘èµ·è¿œç¨‹è°ƒç”¨

**order-service å¦‚ä½•å¾—çŸ¥æŸä¸ª user-service å®ä¾‹æ˜¯å¦ä¾ç„¶å¥åº·ï¼Œæ˜¯ä¸æ˜¯å·²ç»å®•æœºï¼Ÿ**

- user-service ä¼š**æ¯éš”ä¸€æ®µæ—¶é—´(é»˜è®¤30ç§’)å‘ eureka-server å‘èµ·è¯·æ±‚**ï¼ŒæŠ¥å‘Šè‡ªå·±çŠ¶æ€ï¼Œç§°ä¸º**å¿ƒè·³**
- å½“è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å‘é€å¿ƒè·³æ—¶ï¼Œeureka-server ä¼šè®¤ä¸ºå¾®æœåŠ¡å®ä¾‹æ•…éšœï¼Œå°†è¯¥å®ä¾‹ä»æœåŠ¡åˆ—è¡¨ä¸­å‰”é™¤
- order-service æ‹‰å–æœåŠ¡æ—¶ï¼Œå°±èƒ½å°†æ•…éšœå®ä¾‹æ’é™¤äº†

---

æ¥ä¸‹æ¥æˆ‘ä»¬åŠ¨æ‰‹å®è·µçš„æ­¥éª¤åŒ…æ‹¬

![](https://cdn.xn2001.com/img/2021/20210901090932.png)

## æ­å»ºæ³¨å†Œä¸­å¿ƒ

**æ­å»º eureka-server**

å¼•å…¥ SpringCloud ä¸º eureka æä¾›çš„ starter ä¾èµ–ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ç”¨ **server**

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```

**ç¼–å†™å¯åŠ¨ç±»**

æ³¨æ„è¦æ·»åŠ ä¸€ä¸ª `@EnableEurekaServer` **æ³¨è§£**ï¼Œå¼€å¯ eureka çš„**æ³¨å†Œä¸­å¿ƒ**åŠŸèƒ½

```java
package com.xn2001.eureka;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer
public class EurekaApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaApplication.class, args);
    }
}
```

**ç¼–å†™é…ç½®æ–‡ä»¶**

ç¼–å†™ä¸€ä¸ª application.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yml
server:
  port: 10086
spring:
  application:
    name: eureka-server
eureka:
  client:
    service-url: 
      defaultZone: http://127.0.0.1:10086/eureka
```

å…¶ä¸­ `default-zone` æ˜¯å› ä¸ºå‰é¢é…ç½®ç±»å¼€å¯äº†æ³¨å†Œä¸­å¿ƒæ‰€éœ€è¦é…ç½®çš„ eureka çš„**åœ°å€ä¿¡æ¯**ï¼Œå› ä¸º eureka æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œè¿™é‡Œä¹Ÿè¦å°†è‡ªå·±æ³¨å†Œè¿›æ¥ï¼Œå½“åé¢ eureka **é›†ç¾¤**æ—¶ï¼Œè¿™é‡Œå°±å¯ä»¥å¡«å†™å¤šä¸ªï¼Œä½¿ç”¨ â€œ,â€ éš”å¼€ã€‚

å¯åŠ¨å®Œæˆåï¼Œè®¿é—® http://localhost:10086/

![](https://cdn.xn2001.com/img/2021/20210901090945.png)

## æœåŠ¡æ³¨å†Œ

> å°† user-serviceã€order-service éƒ½æ³¨å†Œåˆ° eureka

å¼•å…¥ SpringCloud ä¸º eureka æä¾›çš„ starter ä¾èµ–ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ç”¨ **client**

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ï¼š`@EnableEurekaClient`

åœ¨ application.yml æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„é…ç½®ï¼š

```yml
spring:
  application:
  	#nameï¼šorderservice
    name: userservice
eureka:
  client:
    service-url: 
      defaultZone: http:127.0.0.1:10086/eureka
```

3ä¸ªé¡¹ç›®å¯åŠ¨åï¼Œè®¿é—® http://localhost:10086/

![](https://cdn.xn2001.com/img/2021/20210901090958.png)

è¿™é‡Œå¦å¤–å†è¡¥å……ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ idea çš„å¤šå®ä¾‹å¯åŠ¨ï¼Œæ¥æŸ¥çœ‹ Eureka çš„é›†ç¾¤æ•ˆæœã€‚

![](https://cdn.xn2001.com/img/2021/20210901091005.png)

4ä¸ªé¡¹ç›®å¯åŠ¨åï¼Œè®¿é—® http://localhost:10086/

![](https://cdn.xn2001.com/img/2021/20210901091015.png)

## æœåŠ¡æ‹‰å–

> åœ¨ order-service ä¸­å®ŒæˆæœåŠ¡æ‹‰å–ï¼Œç„¶åé€šè¿‡è´Ÿè½½å‡è¡¡æŒ‘é€‰ä¸€ä¸ªæœåŠ¡ï¼Œå®ç°è¿œç¨‹è°ƒç”¨

ä¸‹é¢æˆ‘ä»¬è®© order-service å‘ eureka-server æ‹‰å– user-service çš„ä¿¡æ¯ï¼Œå®ç°æœåŠ¡å‘ç°ã€‚

é¦–å…ˆç»™ `RestTemplate` è¿™ä¸ª Bean æ·»åŠ ä¸€ä¸ª `@LoadBalanced` **æ³¨è§£**ï¼Œç”¨äºå¼€å¯**è´Ÿè½½å‡è¡¡**ã€‚ï¼ˆåé¢ä¼šè®²ï¼‰

```java
@Bean
@LoadBalanced
public RestTemplate restTemplate(){
    return new RestTemplate();
}
```

ä¿®æ”¹ OrderService è®¿é—®çš„urlè·¯å¾„ï¼Œç”¨**æœåŠ¡å**ä»£æ›¿ipã€ç«¯å£ï¼š

![](https://cdn.xn2001.com/img/2021/20210901091216.png)

spring ä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬ä» eureka-server ä¸­ï¼Œæ ¹æ® userservice è¿™ä¸ªæœåŠ¡åç§°ï¼Œè·å–å®ä¾‹åˆ—è¡¨åå»å®Œæˆè´Ÿè½½å‡è¡¡ã€‚

# Ribbonè´Ÿè½½å‡è¡¡

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/04-cloud-ribbon
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/04-cloud-ribbon

æˆ‘ä»¬æ·»åŠ äº† `@LoadBalanced` æ³¨è§£ï¼Œå³å¯å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸç†å‘¢ï¼Ÿ

**SpringCloud åº•å±‚æä¾›äº†ä¸€ä¸ªåä¸º Ribbon çš„ç»„ä»¶ï¼Œæ¥å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚**

![](https://cdn.xn2001.com/img/2021/20210901091242.png)

## æºç è·Ÿè¸ª

ä¸ºä»€ä¹ˆæˆ‘ä»¬åªè¾“å…¥äº† service åç§°å°±å¯ä»¥è®¿é—®äº†å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸éœ€è¦è·å–ipå’Œç«¯å£ï¼Œè¿™æ˜¾ç„¶æœ‰äººå¸®æˆ‘ä»¬æ ¹æ® service åç§°ï¼Œè·å–åˆ°äº†æœåŠ¡å®ä¾‹çš„ipå’Œç«¯å£ã€‚å®ƒå°±æ˜¯`LoadBalancerInterceptor`ï¼Œè¿™ä¸ªç±»ä¼šåœ¨å¯¹ RestTemplate çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œç„¶åä» Eureka æ ¹æ®æœåŠ¡ id è·å–æœåŠ¡åˆ—è¡¨ï¼Œéšååˆ©ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•å¾—åˆ°çœŸå®çš„æœåŠ¡åœ°å€ä¿¡æ¯ï¼Œæ›¿æ¢æœåŠ¡ idã€‚

æˆ‘ä»¬è¿›è¡Œæºç è·Ÿè¸ªï¼š

![](https://cdn.xn2001.com/img/2021/20210901091323.png)

è¿™é‡Œçš„ `intercept()` æ–¹æ³•ï¼Œæ‹¦æˆªäº†ç”¨æˆ·çš„ HttpRequest è¯·æ±‚ï¼Œç„¶ååšäº†å‡ ä»¶äº‹ï¼š

- `request.getURI()`ï¼šè·å–è¯·æ±‚uriï¼Œå³ http://user-service/user/8
- `originalUri.getHost()`ï¼šè·å–uriè·¯å¾„çš„ä¸»æœºåï¼Œå…¶å®å°±æ˜¯æœåŠ¡id `user-service`
- `this.loadBalancer.execute()`ï¼šå¤„ç†æœåŠ¡idï¼Œå’Œç”¨æˆ·è¯·æ±‚

è¿™é‡Œçš„ `this.loadBalancer` æ˜¯ `LoadBalancerClient` ç±»å‹

ç»§ç»­è·Ÿå…¥ `execute()` æ–¹æ³•ï¼š

![](https://cdn.xn2001.com/img/2021/20210901091330.png)

- `getLoadBalancer(serviceId)`ï¼šæ ¹æ®æœåŠ¡idè·å– `ILoadBalancer`ï¼Œè€Œ `ILoadBalancer` ä¼šæ‹¿ç€æœåŠ¡ id å» eureka ä¸­è·å–æœåŠ¡åˆ—è¡¨ã€‚
- `getServer(loadBalancer)`ï¼šåˆ©ç”¨å†…ç½®çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä»æœåŠ¡åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªã€‚åœ¨å›¾ä¸­**å¯ä»¥çœ‹åˆ°è·å–äº†8082ç«¯å£çš„æœåŠ¡**

å¯ä»¥çœ‹åˆ°è·å–æœåŠ¡æ—¶ï¼Œé€šè¿‡ä¸€ä¸ª `getServer()` æ–¹æ³•æ¥åšè´Ÿè½½å‡è¡¡:

 ![](https://cdn.xn2001.com/img/2021/20210901091345.png)

æˆ‘ä»¬ç»§ç»­è·Ÿå…¥ï¼š

![](https://cdn.xn2001.com/img/2021/20210901091355.png)

ç»§ç»­è·Ÿè¸ªæºç  `chooseServer()` æ–¹æ³•ï¼Œå‘ç°è¿™ä¹ˆä¸€æ®µä»£ç ï¼š

 ![](https://cdn.xn2001.com/img/2021/20210901091414.png)

æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª `rule` æ˜¯è°ï¼š

 ![](https://cdn.xn2001.com/img/2021/20210901091432.png)

è¿™é‡Œçš„ rule é»˜è®¤å€¼æ˜¯ä¸€ä¸ª `RoundRobinRule` ï¼Œçœ‹ç±»çš„ä»‹ç»ï¼š

![](https://cdn.xn2001.com/img/2021/20210901091442.png)

è´Ÿè½½å‡è¡¡é»˜è®¤ä½¿ç”¨äº†è½®è®­ç®—æ³•ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ã€‚

## æµç¨‹æ€»ç»“

SpringCloud Ribbon åº•å±‚é‡‡ç”¨äº†ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ‹¦æˆªäº† RestTemplate å‘å‡ºçš„è¯·æ±‚ï¼Œå¯¹åœ°å€åšäº†ä¿®æ”¹ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

- æ‹¦æˆªæˆ‘ä»¬çš„ `RestTemplate` è¯·æ±‚ http://userservice/user/1
- `RibbonLoadBalancerClient` ä¼šä»è¯·æ±‚urlä¸­è·å–æœåŠ¡åç§°ï¼Œä¹Ÿå°±æ˜¯ user-service
- `DynamicServerListLoadBalancer` æ ¹æ® user-service åˆ° eureka æ‹‰å–æœåŠ¡åˆ—è¡¨
- eureka è¿”å›åˆ—è¡¨ï¼Œlocalhost:8081ã€localhost:8082
- `IRule` åˆ©ç”¨å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œä¾‹å¦‚ localhost:8081
- `RibbonLoadBalancerClient` ä¿®æ”¹è¯·æ±‚åœ°å€ï¼Œç”¨ localhost:8081 æ›¿ä»£ userserviceï¼Œå¾—åˆ° http://localhost:8081/user/1ï¼Œå‘èµ·çœŸå®è¯·æ±‚

![](https://cdn.xn2001.com/img/2021/20210901091755.png)

## è´Ÿè½½å‡è¡¡ç­–ç•¥

è´Ÿè½½å‡è¡¡çš„è§„åˆ™éƒ½å®šä¹‰åœ¨ IRule æ¥å£ä¸­ï¼Œè€Œ IRule æœ‰å¾ˆå¤šä¸åŒçš„å®ç°ç±»ï¼š

![](https://cdn.xn2001.com/img/2021/20210901091811.png)

ä¸åŒè§„åˆ™çš„å«ä¹‰å¦‚ä¸‹ï¼š

| **å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ç±»**    | **è§„åˆ™æè¿°**                                                 |
| ------------------------- | ------------------------------------------------------------ |
| RoundRobinRule            | ç®€å•è½®è¯¢æœåŠ¡åˆ—è¡¨æ¥é€‰æ‹©æœåŠ¡å™¨ã€‚å®ƒæ˜¯Ribboné»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚ |
| AvailabilityFilteringRule | å¯¹ä»¥ä¸‹ä¸¤ç§æœåŠ¡å™¨è¿›è¡Œå¿½ç•¥ï¼šï¼ˆ1ï¼‰åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™å°æœåŠ¡å™¨å¦‚æœ3æ¬¡è¿æ¥å¤±è´¥ï¼Œè¿™å°æœåŠ¡å™¨å°±ä¼šè¢«è®¾ç½®ä¸ºâ€œçŸ­è·¯â€çŠ¶æ€ã€‚çŸ­è·¯çŠ¶æ€å°†æŒç»­30ç§’ï¼Œå¦‚æœå†æ¬¡è¿æ¥å¤±è´¥ï¼ŒçŸ­è·¯çš„æŒç»­æ—¶é—´å°±ä¼šå‡ ä½•çº§åœ°å¢åŠ ã€‚ ï¼ˆ2ï¼‰å¹¶å‘æ•°è¿‡é«˜çš„æœåŠ¡å™¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å™¨çš„å¹¶å‘è¿æ¥æ•°è¿‡é«˜ï¼Œé…ç½®äº†AvailabilityFilteringRule è§„åˆ™çš„å®¢æˆ·ç«¯ä¹Ÿä¼šå°†å…¶å¿½ç•¥ã€‚å¹¶å‘è¿æ¥æ•°çš„ä¸Šé™ï¼Œå¯ä»¥ç”±å®¢æˆ·ç«¯è®¾ç½®ã€‚ |
| WeightedResponseTimeRule  | ä¸ºæ¯ä¸€ä¸ªæœåŠ¡å™¨èµ‹äºˆä¸€ä¸ªæƒé‡å€¼ã€‚æœåŠ¡å™¨å“åº”æ—¶é—´è¶Šé•¿ï¼Œè¿™ä¸ªæœåŠ¡å™¨çš„æƒé‡å°±è¶Šå°ã€‚è¿™ä¸ªè§„åˆ™ä¼šéšæœºé€‰æ‹©æœåŠ¡å™¨ï¼Œè¿™ä¸ªæƒé‡å€¼ä¼šå½±å“æœåŠ¡å™¨çš„é€‰æ‹©ã€‚ |
| **ZoneAvoidanceRule**     | ä»¥åŒºåŸŸå¯ç”¨çš„æœåŠ¡å™¨ä¸ºåŸºç¡€è¿›è¡ŒæœåŠ¡å™¨çš„é€‰æ‹©ã€‚ä½¿ç”¨Zoneå¯¹æœåŠ¡å™¨è¿›è¡Œåˆ†ç±»ï¼Œè¿™ä¸ªZoneå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæœºæˆ¿ã€ä¸€ä¸ªæœºæ¶ç­‰ã€‚è€Œåå†å¯¹Zoneå†…çš„å¤šä¸ªæœåŠ¡åšè½®è¯¢ã€‚ |
| BestAvailableRule         | å¿½ç•¥é‚£äº›çŸ­è·¯çš„æœåŠ¡å™¨ï¼Œå¹¶é€‰æ‹©å¹¶å‘æ•°è¾ƒä½çš„æœåŠ¡å™¨ã€‚             |
| RandomRule                | éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å™¨ã€‚                                   |
| RetryRule                 | é‡è¯•æœºåˆ¶çš„é€‰æ‹©é€»è¾‘                                           |

é»˜è®¤çš„å®ç°å°±æ˜¯ `ZoneAvoidanceRule`ï¼Œ**æ˜¯ä¸€ç§è½®è¯¢æ–¹æ¡ˆ**ã€‚

## è‡ªå®šä¹‰ç­–ç•¥

é€šè¿‡å®šä¹‰ IRule å®ç°å¯ä»¥ä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

1 ä»£ç æ–¹å¼åœ¨ order-service ä¸­çš„ OrderApplication ç±»ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªæ–°çš„ IRuleï¼š

![](https://cdn.xn2001.com/img/2021/20210901091832.png)

2 é…ç½®æ–‡ä»¶æ–¹å¼ï¼šåœ¨ order-service çš„ application.yml æ–‡ä»¶ä¸­ï¼Œæ·»åŠ æ–°çš„é…ç½®ä¹Ÿå¯ä»¥ä¿®æ”¹è§„åˆ™ï¼š

```yml
userservice: # ç»™éœ€è¦è°ƒç”¨çš„å¾®æœåŠ¡é…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼ŒorderserviceæœåŠ¡å»è°ƒç”¨userserviceæœåŠ¡
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule # è´Ÿè½½å‡è¡¡è§„åˆ™ 
```

**æ³¨æ„**ï¼šä¸€èˆ¬ç”¨é»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä¸åšä¿®æ”¹ã€‚

## é¥¥é¥¿åŠ è½½

å½“æˆ‘ä»¬å¯åŠ¨ orderserviceï¼Œç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼Œæ—¶é—´æ¶ˆè€—ä¼šå¤§å¾ˆå¤šï¼Œè¿™æ˜¯å› ä¸º Ribbon æ‡’åŠ è½½çš„æœºåˆ¶ã€‚

![](https://cdn.xn2001.com/img/2021/20210901091850.png)

Ribbon é»˜è®¤æ˜¯é‡‡ç”¨æ‡’åŠ è½½ï¼Œå³ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰ä¼šå»åˆ›å»º LoadBalanceClientï¼Œæ‹‰å–é›†ç¾¤åœ°å€ï¼Œæ‰€ä»¥è¯·æ±‚æ—¶é—´ä¼šå¾ˆé•¿ã€‚

è€Œé¥¥é¥¿åŠ è½½åˆ™ä¼šåœ¨é¡¹ç›®å¯åŠ¨æ—¶åˆ›å»º LoadBalanceClientï¼Œé™ä½ç¬¬ä¸€æ¬¡è®¿é—®çš„è€—æ—¶ï¼Œé€šè¿‡ä¸‹é¢é…ç½®å¼€å¯é¥¥é¥¿åŠ è½½ï¼š

```yml
ribbon:
  eager-load:
    enabled: true
    clients: userservice # é¡¹ç›®å¯åŠ¨æ—¶ç›´æ¥å»æ‹‰å–userserviceçš„é›†ç¾¤ï¼Œå¤šä¸ªç”¨","éš”å¼€
```

# Nacosæ³¨å†Œä¸­å¿ƒ

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos

SpringCloudAlibaba æ¨å‡ºäº†ä¸€ä¸ªåä¸º Nacos çš„æ³¨å†Œä¸­å¿ƒï¼Œåœ¨å›½å¤–ä¹Ÿæœ‰å¤§é‡çš„ä½¿ç”¨ã€‚

![](https://cdn.xn2001.com/img/2021/20210901091857.png)

è§£å‹å¯åŠ¨ Nacosï¼Œè¯¦ç»†è¯·çœ‹ [Nacoså®‰è£…æŒ‡å—](https://www.xn2001.com/archives/661.html)

```
startup.cmd -m standalone
```

è®¿é—®ï¼šhttp://localhost:8848/nacos/

![](https://cdn.xn2001.com/img/2021/20210901091904.png)

## æœåŠ¡æ³¨å†Œ

è¿™é‡Œä¸Šæ¥å°±ç›´æ¥æœåŠ¡æ³¨å†Œï¼Œå¾ˆå¤šä¸œè¥¿å¯èƒ½æœ‰ç–‘æƒ‘ï¼Œå…¶å® Nacos æœ¬èº«å°±æ˜¯ä¸€ä¸ª SprintBoot é¡¹ç›®ï¼Œè¿™ç‚¹ä½ ä»å¯åŠ¨çš„æ§åˆ¶å°æ‰“å°å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ‰€ä»¥å°±ä¸å†éœ€è¦å»é¢å¤–æ­å»ºä¸€ä¸ªåƒ Eureka çš„æ³¨å†Œä¸­å¿ƒã€‚

**å¼•å…¥ä¾èµ–**

åœ¨ cloud-demo çˆ¶å·¥ç¨‹ä¸­å¼•å…¥ SpringCloudAlibaba çš„ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-dependencies</artifactId>
    <version>2.2.6.RELEASE</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
```

ç„¶ååœ¨ user-service å’Œ order-service ä¸­çš„pomæ–‡ä»¶ä¸­å¼•å…¥ nacos-discovery ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

**é…ç½®nacosåœ°å€**

åœ¨ user-service å’Œ order-service çš„ application.yml ä¸­æ·»åŠ  nacos åœ°å€ï¼š

```yaml
spring:
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
```

é¡¹ç›®é‡æ–°å¯åŠ¨åï¼Œå¯ä»¥çœ‹åˆ°ä¸‰ä¸ªæœåŠ¡éƒ½è¢«æ³¨å†Œè¿›äº† Nacos

![](https://cdn.xn2001.com/img/2021/20210901091918.png)

æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8080/order/101ï¼Œæ­£å¸¸è®¿é—®ï¼ŒåŒæ—¶è´Ÿè½½å‡è¡¡ä¹Ÿæ­£å¸¸ã€‚

## åˆ†çº§å­˜å‚¨æ¨¡å‹

ä¸€ä¸ª**æœåŠ¡**å¯ä»¥æœ‰å¤šä¸ª**å®ä¾‹**ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„ user-serviceï¼Œå¯ä»¥æœ‰:

- 127.0.0.1:8081
- 127.0.0.1:8082
- 127.0.0.1:8083

å‡å¦‚è¿™äº›å®ä¾‹åˆ†å¸ƒäºå…¨å›½å„åœ°çš„ä¸åŒæœºæˆ¿ï¼Œä¾‹å¦‚ï¼š

- 127.0.0.1:8081ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿
- 127.0.0.1:8082ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿
- 127.0.0.1:8083ï¼Œåœ¨æ­å·æœºæˆ¿

Nacoså°±å°†åŒä¸€æœºæˆ¿å†…çš„å®ä¾‹ï¼Œåˆ’åˆ†ä¸ºä¸€ä¸ª**é›†ç¾¤**ã€‚

![](https://cdn.xn2001.com/img/2021/20210901091928.png)

å¾®æœåŠ¡äº’ç›¸è®¿é—®æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½è®¿é—®åŒé›†ç¾¤å®ä¾‹ï¼Œå› ä¸ºæœ¬åœ°è®¿é—®é€Ÿåº¦æ›´å¿«ã€‚**å½“æœ¬é›†ç¾¤å†…ä¸å¯ç”¨æ—¶ï¼Œæ‰è®¿é—®å…¶å®ƒé›†ç¾¤ã€‚**ä¾‹å¦‚ï¼šæ­å·æœºæˆ¿å†…çš„ order-service åº”è¯¥ä¼˜å…ˆè®¿é—®åŒæœºæˆ¿çš„ user-serviceã€‚

![](https://cdn.xn2001.com/img/2021/20210901091937.png)

## é…ç½®é›†ç¾¤

æ¥ä¸‹æ¥æˆ‘ä»¬ç»™ user-service **é…ç½®é›†ç¾¤**

ä¿®æ”¹ user-service çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ é›†ç¾¤é…ç½®ï¼š

```yml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ # é›†ç¾¤åç§° HZæ­å·
```

é‡å¯ä¸¤ä¸ª user-service å®ä¾‹åï¼Œæˆ‘ä»¬å†å»å¯åŠ¨ä¸€ä¸ªä¸Šæµ·é›†ç¾¤çš„å®ä¾‹ã€‚

```
-Dserver.port=8083 -Dspring.cloud.nacos.discovery.cluster-name=SH
```

![](https://cdn.xn2001.com/img/2021/20210901091947.png)

æŸ¥çœ‹ nacos æ§åˆ¶å°

![](https://cdn.xn2001.com/img/2021/20210901091957.png)

## NacosRule

Ribbonçš„é»˜è®¤å®ç° `ZoneAvoidanceRule` å¹¶ä¸èƒ½å®ç°æ ¹æ®åŒé›†ç¾¤ä¼˜å…ˆæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬æŠŠè§„åˆ™æ”¹æˆ **NacosRule** å³å¯ã€‚æˆ‘ä»¬æ˜¯ç”¨ orderservice è°ƒç”¨ userserviceï¼Œæ‰€ä»¥åœ¨ orderservice é…ç½®è§„åˆ™ã€‚

```java
@Bean
public IRule iRule(){
    //é»˜è®¤ä¸ºè½®è¯¢è§„åˆ™ï¼Œè¿™é‡Œè‡ªå®šä¹‰ä¸ºéšæœºè§„åˆ™
    return new NacosRule();
}
```

å¦å¤–ï¼Œä½ åŒæ ·å¯ä»¥ä½¿ç”¨é…ç½®çš„å½¢å¼æ¥å®Œæˆï¼Œå…·ä½“å‚è€ƒä¸Šé¢çš„ Ribbon æ ç›®ã€‚

```yml
userservice:
  ribbon:
    NFLoadBalancerRuleClassName: com.alibaba.cloud.nacos.ribbon.NacosRule #è´Ÿè½½å‡è¡¡è§„åˆ™ 
```

ç„¶åï¼Œå†å¯¹ orderservice é…ç½®é›†ç¾¤ã€‚

```yml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ # é›†ç¾¤åç§°
```

ç°åœ¨æˆ‘å¯åŠ¨äº†å››ä¸ªæœåŠ¡ï¼Œåˆ†åˆ«æ˜¯ï¼š

- orderservice - HZ
- userservice - HZ
- userservice1 - HZ
- userservice2 - SH

è®¿é—®åœ°å€ï¼šhttp://localhost:8080/order/101

åœ¨è®¿é—®ä¸­æˆ‘ä»¬å‘ç°ï¼Œåªæœ‰åŒåœ¨ä¸€ä¸ª HZ é›†ç¾¤ä¸‹çš„ userserviceã€userservice1 ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ˜¯éšæœºçš„ã€‚

æˆ‘ä»¬è¯•ç€æŠŠ userserviceã€userservice2 åœæ‰ã€‚ä¾æ—§å¯ä»¥è®¿é—®ã€‚

åœ¨ userservice3 æ§åˆ¶å°å¯ä»¥çœ‹åˆ°å‘å‡ºäº†ä¸€ä¸²çš„è­¦å‘Šï¼Œå› ä¸º orderservice æœ¬èº«æ˜¯åœ¨ HZ é›†ç¾¤çš„ï¼Œè¿™æ³¢ HZ é›†ç¾¤æ²¡æœ‰äº† userserviceï¼Œå°±ä¼šå»åˆ«çš„é›†ç¾¤æ‰¾ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092012.png)

## æƒé‡é…ç½®

å®é™…éƒ¨ç½²ä¸­ä¼šå‡ºç°è¿™æ ·çš„åœºæ™¯ï¼š

æœåŠ¡å™¨è®¾å¤‡æ€§èƒ½æœ‰å·®å¼‚ï¼Œéƒ¨åˆ†å®ä¾‹æ‰€åœ¨æœºå™¨æ€§èƒ½è¾ƒå¥½ï¼Œå¦ä¸€äº›è¾ƒå·®ï¼Œæˆ‘ä»¬å¸Œæœ›æ€§èƒ½å¥½çš„æœºå™¨æ‰¿æ‹…æ›´å¤šçš„ç”¨æˆ·è¯·æ±‚ã€‚ä½†é»˜è®¤æƒ…å†µä¸‹ NacosRule æ˜¯åŒé›†ç¾¤å†…éšæœºæŒ‘é€‰ï¼Œä¸ä¼šè€ƒè™‘æœºå™¨çš„æ€§èƒ½é—®é¢˜ã€‚

å› æ­¤ï¼ŒNacos æä¾›äº†**æƒé‡é…ç½®æ¥æ§åˆ¶è®¿é—®é¢‘ç‡**ï¼Œ0~1 ä¹‹é—´ï¼Œæƒé‡è¶Šå¤§åˆ™è®¿é—®é¢‘ç‡è¶Šé«˜ï¼Œæƒé‡ä¿®æ”¹ä¸º 0ï¼Œåˆ™è¯¥å®ä¾‹æ°¸è¿œä¸ä¼šè¢«è®¿é—®ã€‚

åœ¨ Nacos æ§åˆ¶å°ï¼Œæ‰¾åˆ° user-service çš„å®ä¾‹åˆ—è¡¨ï¼Œç‚¹å‡»ç¼–è¾‘ï¼Œå³å¯ä¿®æ”¹æƒé‡ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092020.png)

åœ¨å¼¹å‡ºçš„ç¼–è¾‘çª—å£ï¼Œä¿®æ”¹æƒé‡

![](https://cdn.xn2001.com/img/2021/20210901092026.png)

å¦å¤–ï¼Œåœ¨æœåŠ¡å‡çº§çš„æ—¶å€™ï¼Œæœ‰ä¸€ç§è¾ƒå¥½çš„æ–¹æ¡ˆï¼šæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è°ƒæ•´æƒé‡æ¥è¿›è¡Œå¹³æ»‘å‡çº§ï¼Œä¾‹å¦‚ï¼šå…ˆæŠŠ userservice æƒé‡è°ƒèŠ‚ä¸º 0ï¼Œè®©ç”¨æˆ·å…ˆæµå‘ userservice2ã€userservice3ï¼Œå‡çº§ userserviceåï¼Œå†æŠŠæƒé‡ä» 0 è°ƒåˆ° 0.1ï¼Œè®©ä¸€éƒ¨åˆ†ç”¨æˆ·å…ˆä½“éªŒï¼Œç”¨æˆ·ä½“éªŒç¨³å®šåå°±å¯ä»¥å¾€ä¸Šè°ƒæƒé‡å•¦ã€‚

## ç¯å¢ƒéš”ç¦»

Nacos æä¾›äº† namespace æ¥å®ç°ç¯å¢ƒéš”ç¦»åŠŸèƒ½ã€‚

æ¯”å¦‚å¼€å‘ç¯å¢ƒå’Œä¸Šçº¿ç¯å¢ƒï¼Œä¸¤è€…æ•°æ®ä¸ç›¸é€š

- Nacos ä¸­å¯ä»¥æœ‰å¤šä¸ª namespace
- namespace ä¸‹å¯ä»¥æœ‰ groupã€service ç­‰
- ä¸åŒ namespace ä¹‹é—´**ç›¸äº’éš”ç¦»**ï¼Œä¾‹å¦‚ä¸åŒ namespace çš„æœåŠ¡äº’ç›¸ä¸å¯è§

![](https://cdn.xn2001.com/img/2021/20210901092032.png)

### åˆ›å»ºnamespace

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ serviceã€dataã€group éƒ½åœ¨åŒä¸€ä¸ª namespaceï¼Œåä¸º public(ä¿ç•™ç©ºé—´)ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092038.png)

æˆ‘ä»¬å¯ä»¥ç‚¹å‡»é¡µé¢æ–°å¢æŒ‰é’®ï¼Œæ·»åŠ ä¸€ä¸ª namespaceï¼š

![](https://cdn.xn2001.com/img/2021/20210901092050.png)



ç„¶åï¼Œå¡«å†™è¡¨å•ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092059.png)

å°±èƒ½åœ¨é¡µé¢çœ‹åˆ°ä¸€ä¸ªæ–°çš„ namespaceï¼š

![](https://cdn.xn2001.com/img/2021/20210901092114.png)

### é…ç½®namespace

ç»™å¾®æœåŠ¡é…ç½® namespace åªèƒ½é€šè¿‡ä¿®æ”¹é…ç½®æ¥å®ç°ã€‚

ä¾‹å¦‚ï¼Œä¿®æ”¹ order-service çš„ application.yml æ–‡ä»¶ï¼š

```yaml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ
        namespace: 492a7d5d-237b-46a1-a99a-fa8e98e4b0f9 # å‘½åç©ºé—´ID
```

é‡å¯ order-service åï¼Œè®¿é—®æ§åˆ¶å°ã€‚

**public**

![](https://cdn.xn2001.com/img/2021/20210901092143.png)

**dev**

![](https://cdn.xn2001.com/img/2021/20210901092130.png)

æ­¤æ—¶è®¿é—® order-serviceï¼Œå› ä¸º namespace ä¸åŒï¼Œä¼šå¯¼è‡´æ‰¾ä¸åˆ° userserviceï¼Œæ§åˆ¶å°ä¼šæŠ¥é”™ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092138.png)

## ä¸´æ—¶å®ä¾‹

Nacos çš„æœåŠ¡å®ä¾‹åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š

- **ä¸´æ—¶å®ä¾‹**ï¼šå¦‚æœå®ä¾‹å®•æœºè¶…è¿‡ä¸€å®šæ—¶é—´ï¼Œä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œ**é»˜è®¤çš„ç±»å‹**ã€‚
- éä¸´æ—¶å®ä¾‹ï¼šå¦‚æœå®ä¾‹å®•æœºï¼Œä¸ä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œä¹Ÿå¯ä»¥å«æ°¸ä¹…å®ä¾‹ã€‚

é…ç½®ä¸€ä¸ªæœåŠ¡å®ä¾‹ä¸ºæ°¸ä¹…å®ä¾‹ï¼š

```yaml
spring:
  cloud:
    nacos:
      discovery:
        ephemeral: false # è®¾ç½®ä¸ºéä¸´æ—¶å®ä¾‹
```

å¦å¤–ï¼ŒNacos é›†ç¾¤**é»˜è®¤é‡‡ç”¨APæ–¹å¼(å¯ç”¨æ€§)**ï¼Œå½“é›†ç¾¤ä¸­å­˜åœ¨éä¸´æ—¶å®ä¾‹æ—¶ï¼Œ**é‡‡ç”¨CPæ¨¡å¼(ä¸€è‡´æ€§)**ï¼›è€Œ Eureka é‡‡ç”¨APæ–¹å¼ï¼Œä¸å¯åˆ‡æ¢ã€‚ï¼ˆè¿™é‡Œè¯´çš„æ˜¯ CAP åŸç†ï¼Œåé¢ä¼šå†™åˆ°ï¼‰

æ¨èä½¿ç”¨ä¸´æ—¶å®ä¾‹

# Nacosé…ç½®ä¸­å¿ƒ

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos

Nacosé™¤äº†å¯ä»¥åšæ³¨å†Œä¸­å¿ƒï¼ŒåŒæ ·å¯ä»¥åšé…ç½®ç®¡ç†æ¥ä½¿ç”¨ã€‚

å½“å¾®æœåŠ¡éƒ¨ç½²çš„å®ä¾‹è¶Šæ¥è¶Šå¤šï¼Œè¾¾åˆ°æ•°åã€æ•°ç™¾æ—¶ï¼Œé€ä¸ªä¿®æ”¹å¾®æœåŠ¡é…ç½®å°±ä¼šè®©äººæŠ“ç‹‚ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å‡ºé”™ã€‚**æˆ‘ä»¬éœ€è¦ä¸€ç§ç»Ÿä¸€é…ç½®ç®¡ç†æ–¹æ¡ˆï¼Œå¯ä»¥é›†ä¸­ç®¡ç†æ‰€æœ‰å®ä¾‹çš„é…ç½®ã€‚**

![](https://cdn.xn2001.com/img/2021/20210901092150.png)



Nacos ä¸€æ–¹é¢å¯ä»¥å°†é…ç½®é›†ä¸­ç®¡ç†ï¼Œå¦ä¸€æ–¹å¯ä»¥åœ¨é…ç½®å˜æ›´æ—¶ï¼ŒåŠæ—¶é€šçŸ¥å¾®æœåŠ¡ï¼Œ**å®ç°é…ç½®çš„çƒ­æ›´æ–°ã€‚**

## åˆ›å»ºé…ç½®

åœ¨ Nacos æ§åˆ¶é¢æ¿ä¸­æ·»åŠ é…ç½®æ–‡ä»¶

![](https://cdn.xn2001.com/img/2021/20210901092159.png)

ç„¶ååœ¨å¼¹å‡ºçš„è¡¨å•ä¸­ï¼Œå¡«å†™é…ç½®ä¿¡æ¯ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092206.png)

**æ³¨æ„**ï¼šé¡¹ç›®çš„æ ¸å¿ƒé…ç½®ï¼Œéœ€è¦çƒ­æ›´æ–°çš„é…ç½®æ‰æœ‰æ”¾åˆ° nacos ç®¡ç†çš„å¿…è¦ã€‚åŸºæœ¬ä¸ä¼šå˜æ›´çš„ä¸€äº›é…ç½®(ä¾‹å¦‚æ•°æ®åº“è¿æ¥)è¿˜æ˜¯ä¿å­˜åœ¨å¾®æœåŠ¡æœ¬åœ°æ¯”è¾ƒå¥½ã€‚

## æ‹‰å–é…ç½®

é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£ Nacos è¯»å–é…ç½®æ–‡ä»¶çš„ç¯èŠ‚æ˜¯åœ¨å“ªä¸€æ­¥ï¼Œåœ¨æ²¡åŠ å…¥ Nacos é…ç½®ä¹‹å‰ï¼Œè·å–é…ç½®æ˜¯è¿™æ ·ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092215.png)

åŠ å…¥ Nacos é…ç½®ï¼Œå®ƒçš„è¯»å–æ˜¯åœ¨ application.yml ä¹‹å‰çš„ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092223.png)

è¿™æ—¶å€™å¦‚æœæŠŠ nacos åœ°å€æ”¾åœ¨ application.yml ä¸­ï¼Œæ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ï¼Œ**Nacos å°±æ— æ³•æ ¹æ®åœ°å€å»è·å–é…ç½®äº†ã€‚**

å› æ­¤ï¼Œnacos åœ°å€å¿…é¡»æ”¾åœ¨ä¼˜å…ˆçº§æœ€é«˜çš„ bootstrap.yml æ–‡ä»¶ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092228.png)

**å¼•å…¥ nacos-config ä¾èµ–**

é¦–å…ˆï¼Œåœ¨ user-service æœåŠ¡ä¸­ï¼Œå¼•å…¥ nacos-config çš„å®¢æˆ·ç«¯ä¾èµ–ï¼š

```xml
<!--nacosé…ç½®ç®¡ç†ä¾èµ–-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

**æ·»åŠ  bootstrap.yml**

ç„¶åï¼Œåœ¨ user-service ä¸­æ·»åŠ ä¸€ä¸ª bootstrap.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
spring:
  application:
    name: userservice # æœåŠ¡åç§°
  profiles:
    active: dev #å¼€å‘ç¯å¢ƒï¼Œè¿™é‡Œæ˜¯dev 
  cloud:
    nacos:
      server-addr: localhost:8848 # Nacosåœ°å€
      config:
        file-extension: yaml # æ–‡ä»¶åç¼€å
```

application.ymlä¸­é‡å¤çš„é…ç½®è®°å¾—åˆ é™¤æ‰ï¼Œé‡å¤çš„ä»£ç ä¸åˆ é™¤ä¹Ÿå¯ä»¥ï¼Œè¿œç«¯çš„é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§æ›´é«˜

æ ¹æ® spring.cloud.nacos.server-addr è·å– nacosåœ°å€ï¼Œå†æ ¹æ®`${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}`ä½œä¸ºæ–‡ä»¶idï¼Œæ¥è¯»å–é…ç½®ã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¾‹ä¸­ï¼Œå°±æ˜¯å»è¯»å– `userservice-dev.yaml`

![](https://cdn.xn2001.com/img/2021/20210901092237.png)

ä½¿ç”¨ä»£ç æ¥éªŒè¯æ˜¯å¦æ‹‰å–æˆåŠŸ

åœ¨ user-service ä¸­çš„ UserController ä¸­æ·»åŠ ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å– pattern.dateformat é…ç½®å¹¶ä½¿ç”¨ï¼š

```java
@Value("${pattern.dateformat}")
private String dateformat;

@GetMapping("now")
public String now(){
    //æ ¼å¼åŒ–æ—¶é—´
    return LocalDateTime.now().format(DateTimeFormatter.ofPattern(dateformat));
}
```

![](https://cdn.xn2001.com/img/2021/20210901092243.png)

å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ï¼šhttp://localhost:8081/user/now

![](https://cdn.xn2001.com/img/2021/20210901092251.png)

## é…ç½®çƒ­æ›´æ–°

æˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„ï¼Œæ˜¯ä¿®æ”¹ nacos ä¸­çš„é…ç½®åï¼Œå¾®æœåŠ¡ä¸­æ— éœ€é‡å¯å³å¯è®©é…ç½®ç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯**é…ç½®çƒ­æ›´æ–°**ã€‚

æœ‰ä¸¤ç§æ–¹å¼ï¼š1. ç”¨ `@value` è¯»å–é…ç½®æ—¶ï¼Œæ­é… `@RefreshScope`ï¼›2. ç›´æ¥ç”¨ `@ConfigurationProperties` è¯»å–é…ç½®

### @RefreshScope

æ–¹å¼ä¸€ï¼šåœ¨ `@Value` æ³¨å…¥çš„å˜é‡æ‰€åœ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ `@RefreshScope`

![](https://cdn.xn2001.com/img/2021/20210901092258.png)

### @ConfigurationProperties

`æ›´åŠ æ¨è`

æ–¹å¼äºŒï¼šä½¿ç”¨ `@ConfigurationProperties` æ³¨è§£è¯»å–é…ç½®æ–‡ä»¶ï¼Œå°±ä¸éœ€è¦åŠ  `@RefreshScope` æ³¨è§£ã€‚

åœ¨ user-service æœåŠ¡ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª PatternProperties ç±»ï¼Œè¯»å– `patterrn.dateformat` å±æ€§

```java
@Data
@Component
@ConfigurationProperties(prefix = "pattern")
public class PatternProperties {
    public String dateformat;
}
```

```java
@Autowired
private PatternProperties patternProperties;

@GetMapping("now2")
public String now2(){
    //æ ¼å¼åŒ–æ—¶é—´
    return LocalDateTime.now().format(DateTimeFormatter.ofPattern(patternProperties.dateformat));
}
```

## é…ç½®å…±äº«

å…¶å®åœ¨æœåŠ¡å¯åŠ¨æ—¶ï¼Œnacos ä¼šè¯»å–å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

- `[spring.application.name]-[spring.profiles.active].yaml`ï¼Œä¾‹å¦‚ï¼šuserservice-dev.yaml

- `[spring.application.name].yaml`ï¼Œä¾‹å¦‚ï¼šuserservice.yaml

è¿™é‡Œçš„ `[spring.application.name].yaml` ä¸åŒ…å«ç¯å¢ƒï¼Œ**å› æ­¤å¯ä»¥è¢«å¤šä¸ªç¯å¢ƒå…±äº«**ã€‚

**æ·»åŠ ä¸€ä¸ªç¯å¢ƒå…±äº«é…ç½®**

æˆ‘ä»¬åœ¨ nacos ä¸­æ·»åŠ ä¸€ä¸ª userservice.yaml æ–‡ä»¶ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092323.png)



**åœ¨ user-service ä¸­è¯»å–å…±äº«é…ç½®**

åœ¨ user-service æœåŠ¡ä¸­ï¼Œä¿®æ”¹ PatternProperties ç±»ï¼Œè¯»å–æ–°æ·»åŠ çš„å±æ€§ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092314.png)

åœ¨ user-service æœåŠ¡ä¸­ï¼Œä¿®æ”¹ UserControllerï¼Œæ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092331.png)



**è¿è¡Œä¸¤ä¸ª UserApplicationï¼Œä½¿ç”¨ä¸åŒçš„profile**

ä¿®æ”¹ UserApplication2 è¿™ä¸ªå¯åŠ¨é¡¹ï¼Œæ”¹å˜å…¶profileå€¼ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092345.png)

![](https://cdn.xn2001.com/img/2021/20210901092338.png)

è¿™æ ·ï¼ŒUserApplication(8081) ä½¿ç”¨çš„ profile æ˜¯ devï¼ŒUserApplication2(8082) ä½¿ç”¨çš„ profile æ˜¯test

å¯åŠ¨ UserApplication å’Œ UserApplication2

è®¿é—®åœ°å€ï¼šhttp://localhost:8081/user/propï¼Œç»“æœï¼š

![](https://cdn.xn2001.com/img/2021/20210901092400.png)

è®¿é—®åœ°å€ï¼šhttp://localhost:8082/user/propï¼Œç»“æœï¼š

![](https://cdn.xn2001.com/img/2021/20210901092419.png)

å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸ç®¡æ˜¯ devï¼Œè¿˜æ˜¯ test ç¯å¢ƒï¼Œéƒ½è¯»å–åˆ°äº† envSharedValue è¿™ä¸ªå±æ€§çš„å€¼ã€‚

ä¸Šé¢çš„éƒ½æ˜¯åŒä¸€ä¸ªå¾®æœåŠ¡ä¸‹ï¼Œ**é‚£ä¹ˆä¸åŒå¾®æœåŠ¡ä¹‹é—´å¯ä»¥ç¯å¢ƒå…±äº«å—ï¼Ÿ**

é€šè¿‡ä¸‹é¢çš„ä¸¤ç§æ–¹å¼æ¥æŒ‡å®šï¼š

- extension-configs
- shared-configs 

```yml
spring: 
  cloud:
    nacos:
      config:
        file-extension: yaml # æ–‡ä»¶åç¼€å
        extends-configs: # å¤šå¾®æœåŠ¡é—´å…±äº«çš„é…ç½®åˆ—è¡¨
          - dataId: common.yaml # è¦å…±äº«çš„é…ç½®æ–‡ä»¶id
```

```yml
spring: 
  cloud:
    nacos:
      config:
        file-extension: yaml # æ–‡ä»¶åç¼€å
        shared-configs: # å¤šå¾®æœåŠ¡é—´å…±äº«çš„é…ç½®åˆ—è¡¨
          - dataId: common.yaml # è¦å…±äº«çš„é…ç½®æ–‡ä»¶id
```

## é…ç½®ä¼˜å…ˆçº§

å½“ nacosã€æœåŠ¡æœ¬åœ°åŒæ—¶**å‡ºç°ç›¸åŒå±æ€§æ—¶**ï¼Œä¼˜å…ˆçº§æœ‰é«˜ä½ä¹‹åˆ†ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092501.png)

æ›´ç»†è‡´çš„é…ç½®

![](https://cdn.xn2001.com/img/2021/20210901092520.png)

# Nacosé›†ç¾¤

## æ¶æ„ä»‹ç»

![](https://cdn.xn2001.com/img/2021/202108181959897.png)

å…¶ä¸­åŒ…å« 3 ä¸ªNacos èŠ‚ç‚¹ï¼Œç„¶åä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ Nginx ä»£ç† 3 ä¸ª Nacosï¼Œæˆ‘ä»¬è®¡åˆ’çš„ Nacos é›†ç¾¤å¦‚ä¸‹å›¾ï¼ŒMySQL çš„ä¸»ä»å¤åˆ¶åç»­å†æ·»åŠ ã€‚

![](https://cdn.xn2001.com/img/2021/202108182000220.png)

ä¸‰ä¸ª Nacos èŠ‚ç‚¹çš„åœ°å€

| èŠ‚ç‚¹   | ip            | port |
| ------ | ------------- | ---- |
| nacos1 | 192.168.150.1 | 8845 |
| nacos2 | 192.168.150.1 | 8846 |
| nacos3 | 192.168.150.1 | 8847 |

## åˆå§‹åŒ–æ•°æ®åº“

Nacos é»˜è®¤æ•°æ®å­˜å‚¨åœ¨å†…åµŒæ•°æ®åº“ Derby ä¸­ï¼Œä¸å±äºç”Ÿäº§å¯ç”¨çš„æ•°æ®åº“ã€‚å®˜æ–¹æ¨èçš„æœ€ä½³å®è·µæ˜¯ä½¿ç”¨å¸¦æœ‰ä¸»ä»çš„é«˜å¯ç”¨æ•°æ®åº“é›†ç¾¤ï¼Œä¸»ä»æ¨¡å¼çš„é«˜å¯ç”¨æ•°æ®åº“ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥å•ç‚¹çš„æ•°æ®åº“ä¸ºä¾‹ã€‚

é¦–å…ˆæ–°å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œå‘½åä¸º nacosï¼Œè€Œåå¯¼å…¥ä¸‹é¢çš„ SQL

```sql
CREATE TABLE `config_info` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(255) DEFAULT NULL,
  `content` longtext NOT NULL COMMENT 'content',
  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  `src_user` text COMMENT 'source user',
  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
  `app_name` varchar(128) DEFAULT NULL,
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'ç§Ÿæˆ·å­—æ®µ',
  `c_desc` varchar(256) DEFAULT NULL,
  `c_use` varchar(64) DEFAULT NULL,
  `effect` varchar(64) DEFAULT NULL,
  `type` varchar(64) DEFAULT NULL,
  `c_schema` text,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info';

/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = config_info_aggr   */
/******************************************/
CREATE TABLE `config_info_aggr` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(255) NOT NULL COMMENT 'group_id',
  `datum_id` varchar(255) NOT NULL COMMENT 'datum_id',
  `content` longtext NOT NULL COMMENT 'å†…å®¹',
  `gmt_modified` datetime NOT NULL COMMENT 'ä¿®æ”¹æ—¶é—´',
  `app_name` varchar(128) DEFAULT NULL,
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'ç§Ÿæˆ·å­—æ®µ',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='å¢åŠ ç§Ÿæˆ·å­—æ®µ';


/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = config_info_beta   */
/******************************************/
CREATE TABLE `config_info_beta` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(128) NOT NULL COMMENT 'group_id',
  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
  `content` longtext NOT NULL COMMENT 'content',
  `beta_ips` varchar(1024) DEFAULT NULL COMMENT 'betaIps',
  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  `src_user` text COMMENT 'source user',
  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'ç§Ÿæˆ·å­—æ®µ',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_beta';

/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = config_info_tag   */
/******************************************/
CREATE TABLE `config_info_tag` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(128) NOT NULL COMMENT 'group_id',
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',
  `tag_id` varchar(128) NOT NULL COMMENT 'tag_id',
  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
  `content` longtext NOT NULL COMMENT 'content',
  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  `src_user` text COMMENT 'source user',
  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_tag';

/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = config_tags_relation   */
/******************************************/
CREATE TABLE `config_tags_relation` (
  `id` bigint(20) NOT NULL COMMENT 'id',
  `tag_name` varchar(128) NOT NULL COMMENT 'tag_name',
  `tag_type` varchar(64) DEFAULT NULL COMMENT 'tag_type',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(128) NOT NULL COMMENT 'group_id',
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',
  `nid` bigint(20) NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`nid`),
  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_tag_relation';

/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = group_capacity   */
/******************************************/
CREATE TABLE `group_capacity` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `group_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Group IDï¼Œç©ºå­—ç¬¦è¡¨ç¤ºæ•´ä¸ªé›†ç¾¤',
  `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'ä½¿ç”¨é‡',
  `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°ï¼Œï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'æœ€å¤§å˜æ›´å†å²æ•°é‡',
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_group_id` (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='é›†ç¾¤ã€å„Groupå®¹é‡ä¿¡æ¯è¡¨';

/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = his_config_info   */
/******************************************/
CREATE TABLE `his_config_info` (
  `id` bigint(64) unsigned NOT NULL,
  `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `data_id` varchar(255) NOT NULL,
  `group_id` varchar(128) NOT NULL,
  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
  `content` longtext NOT NULL,
  `md5` varchar(32) DEFAULT NULL,
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `src_user` text,
  `src_ip` varchar(50) DEFAULT NULL,
  `op_type` char(10) DEFAULT NULL,
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'ç§Ÿæˆ·å­—æ®µ',
  PRIMARY KEY (`nid`),
  KEY `idx_gmt_create` (`gmt_create`),
  KEY `idx_gmt_modified` (`gmt_modified`),
  KEY `idx_did` (`data_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='å¤šç§Ÿæˆ·æ”¹é€ ';


/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = tenant_capacity   */
/******************************************/
CREATE TABLE `tenant_capacity` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `tenant_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Tenant ID',
  `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'ä½¿ç”¨é‡',
  `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°',
  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'æœ€å¤§å˜æ›´å†å²æ•°é‡',
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='ç§Ÿæˆ·å®¹é‡ä¿¡æ¯è¡¨';


CREATE TABLE `tenant_info` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `kp` varchar(128) NOT NULL COMMENT 'kp',
  `tenant_id` varchar(128) default '' COMMENT 'tenant_id',
  `tenant_name` varchar(128) default '' COMMENT 'tenant_name',
  `tenant_desc` varchar(256) DEFAULT NULL COMMENT 'tenant_desc',
  `create_source` varchar(32) DEFAULT NULL COMMENT 'create_source',
  `gmt_create` bigint(20) NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` bigint(20) NOT NULL COMMENT 'ä¿®æ”¹æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='tenant_info';

CREATE TABLE `users` (
	`username` varchar(50) NOT NULL PRIMARY KEY,
	`password` varchar(500) NOT NULL,
	`enabled` boolean NOT NULL
);

CREATE TABLE `roles` (
	`username` varchar(50) NOT NULL,
	`role` varchar(50) NOT NULL,
	UNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE
);

CREATE TABLE `permissions` (
    `role` varchar(50) NOT NULL,
    `resource` varchar(255) NOT NULL,
    `action` varchar(8) NOT NULL,
    UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE
);

INSERT INTO users (username, password, enabled) VALUES ('nacos', '$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu', TRUE);

INSERT INTO roles (username, role) VALUES ('nacos', 'ROLE_ADMIN');
```

## é…ç½®Nacos

è¿›å…¥ nacos çš„ conf ç›®å½•ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ cluster.conf.exampleï¼Œé‡å‘½åä¸º cluster.conf

![](https://cdn.xn2001.com/img/2021/202108182004564.png)

æ·»åŠ å†…å®¹

```
127.0.0.1:8845
127.0.0.1.8846
127.0.0.1.8847
```

ç„¶åä¿®æ”¹ application.properties æ–‡ä»¶ï¼Œæ·»åŠ æ•°æ®åº“é…ç½®

```properties
spring.datasource.platform=mysql
db.num=1
db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC
db.user.0=root
db.password.0=123456
```

å°† nacos æ–‡ä»¶å¤¹å¤åˆ¶ä¸‰ä»½ï¼Œåˆ†åˆ«å‘½åä¸ºï¼šnacos1ã€nacos2ã€nacos3

![](https://cdn.xn2001.com/img/2021/202108182004103.png) 

ç„¶ååˆ†åˆ«ä¿®æ”¹ä¸‰ä¸ªæ–‡ä»¶å¤¹ä¸­çš„ application.propertiesï¼Œ

nacos1

```properties
server.port=8845
```

nacos2

```properties
server.port=8846
```

nacos3

```properties
server.port=8847
```

ç„¶ååˆ†åˆ«å¯åŠ¨ä¸‰ä¸ª nacos

```
startup.cmd
```

## Nginxåå‘ä»£ç†

ä¿®æ”¹ nginx æ–‡ä»¶å¤¹ä¸‹çš„ conf/nginx.conf æ–‡ä»¶ï¼Œé…ç½®å¦‚ä¸‹

```nginx
upstream nacos-cluster {
    server 127.0.0.1:8845;
	server 127.0.0.1:8846;
	server 127.0.0.1:8847;
}

server {
    listen       80;
    server_name  localhost;

    location /nacos {
        proxy_pass http://nacos-cluster;
    }
}
```

å¯åŠ¨ nginxï¼Œåœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost/nacos

åœ¨ä»£ç ä¸­çš„ application.yml æ–‡ä»¶é…ç½®æ”¹ä¸ºå¦‚ä¸‹ï¼š

```yaml
spring:
  cloud:
    nacos:
      server-addr: localhost:80 # Nacosåœ°å€
```

å®é™…éƒ¨ç½²æ—¶ï¼Œéœ€è¦ç»™åšåå‘ä»£ç†çš„ Nginx æœåŠ¡å™¨è®¾ç½®ä¸€ä¸ªåŸŸåï¼Œè¿™æ ·åç»­å¦‚æœæœ‰æœåŠ¡å™¨è¿ç§» Nacos çš„å®¢æˆ·ç«¯ä¹Ÿæ— éœ€æ›´æ”¹é…ç½®ã€‚Nacos çš„å„ä¸ªèŠ‚ç‚¹åº”è¯¥éƒ¨ç½²åˆ°å¤šä¸ªä¸åŒæœåŠ¡å™¨ï¼Œåšå¥½å®¹ç¾å’Œéš”ç¦»å·¥ä½œã€‚

# Feignè¿œç¨‹è°ƒç”¨

> ä»£ç å‚è€ƒ
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/06-cloud-feign
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/06-cloud-feign

æˆ‘ä»¬ä»¥å‰åˆ©ç”¨ RestTemplate å‘èµ·è¿œç¨‹è°ƒç”¨çš„ä»£ç ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092616.png)

- ä»£ç å¯è¯»æ€§å·®ï¼Œç¼–ç¨‹ä½“éªŒä¸ç»Ÿä¸€
- å‚æ•°å¤æ‚URLéš¾ä»¥ç»´æŠ¤

Feign æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ http å®¢æˆ·ç«¯ï¼Œå®˜æ–¹åœ°å€ï¼šhttps://github.com/OpenFeign/feign

å…¶ä½œç”¨å°±æ˜¯å¸®åŠ©æˆ‘ä»¬**ä¼˜é›…çš„å®ç° http è¯·æ±‚çš„å‘é€**ï¼Œè§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092639.png)

## Feignä½¿ç”¨

**å¼•å…¥ä¾èµ–**

æˆ‘ä»¬åœ¨ order-service å¼•å…¥ feign ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

**æ·»åŠ æ³¨è§£**

åœ¨ order-service å¯åŠ¨ç±»æ·»åŠ æ³¨è§£å¼€å¯ Feign

![](https://cdn.xn2001.com/img/2021/20210901092704.png)

**è¯·æ±‚æ¥å£**

åœ¨ order-service ä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå†…å®¹å¦‚ä¸‹

```java
package com.xn2001.order.client;

import com.xn2001.order.pojo.User;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

@FeignClient("userservice")
public interface UserClient {
    @GetMapping("/user/{id}")
    User findById(@PathVariable("id") Long id);
}
```

`@FeignClient("userservice")`ï¼šå…¶ä¸­å‚æ•°å¡«å†™çš„æ˜¯å¾®æœåŠ¡å

`@GetMapping("/user/{id}")`ï¼šå…¶ä¸­å‚æ•°å¡«å†™çš„æ˜¯è¯·æ±‚è·¯å¾„

è¿™ä¸ªå®¢æˆ·ç«¯ä¸»è¦æ˜¯åŸºäº SpringMVC çš„æ³¨è§£ `@GetMapping` æ¥å£°æ˜è¿œç¨‹è°ƒç”¨çš„ä¿¡æ¯

Feign å¯ä»¥å¸®åŠ©æˆ‘ä»¬å‘é€ http è¯·æ±‚ï¼Œæ— éœ€è‡ªå·±ä½¿ç”¨ RestTemplate æ¥å‘é€äº†ã€‚

**æµ‹è¯•**

```java
@Autowired
private UserClient userClient;

public Order queryOrderAndUserById(Long orderId) {
    // 1.æŸ¥è¯¢è®¢å•
    Order order = orderMapper.findById(orderId);
    // TODO: 2021/8/20 ä½¿ç”¨feignè¿œç¨‹è°ƒç”¨
    User user = userClient.findById(order.getUserId());
    // 3. å°†ç”¨æˆ·ä¿¡æ¯å°è£…è¿›è®¢å•
    order.setUser(user);
    // 4.è¿”å›
    return order;
}
```

## è‡ªå®šä¹‰é…ç½®

Feign å¯ä»¥æ”¯æŒå¾ˆå¤šçš„è‡ªå®šä¹‰é…ç½®ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| ç±»å‹                   | ä½œç”¨             | è¯´æ˜                                                   |
| ---------------------- | ---------------- | ------------------------------------------------------ |
| **feign.Logger.Level** | ä¿®æ”¹æ—¥å¿—çº§åˆ«     | åŒ…å«å››ç§ä¸åŒçš„çº§åˆ«ï¼šNONEã€BASICã€HEADERSã€FULL         |
| feign.codec.Decoder    | å“åº”ç»“æœçš„è§£æå™¨ | httpè¿œç¨‹è°ƒç”¨çš„ç»“æœåšè§£æï¼Œä¾‹å¦‚è§£æjsonå­—ç¬¦ä¸²ä¸ºjavaå¯¹è±¡ |
| feign.codec.Encoder    | è¯·æ±‚å‚æ•°ç¼–ç      | å°†è¯·æ±‚å‚æ•°ç¼–ç ï¼Œä¾¿äºé€šè¿‡httpè¯·æ±‚å‘é€                   |
| feign.Contract         | æ”¯æŒçš„æ³¨è§£æ ¼å¼   | é»˜è®¤æ˜¯SpringMVCçš„æ³¨è§£                                  |
| feign.Retryer          | å¤±è´¥é‡è¯•æœºåˆ¶     | è¯·æ±‚å¤±è´¥çš„é‡è¯•æœºåˆ¶ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ï¼Œä¸è¿‡ä¼šä½¿ç”¨Ribbonçš„é‡è¯• |

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé»˜è®¤å€¼å°±èƒ½æ»¡è¶³æˆ‘ä»¬ä½¿ç”¨ï¼Œå¦‚æœè¦è‡ªå®šä¹‰æ—¶ï¼Œåªéœ€è¦åˆ›å»ºè‡ªå®šä¹‰çš„ @Bean è¦†ç›–é»˜è®¤ Bean å³å¯ã€‚ä¸‹é¢ä»¥æ—¥å¿—ä¸ºä¾‹æ¥æ¼”ç¤ºå¦‚ä½•è‡ªå®šä¹‰é…ç½®ã€‚

åŸºäºé…ç½®æ–‡ä»¶ä¿®æ”¹ feign çš„æ—¥å¿—çº§åˆ«å¯ä»¥é’ˆå¯¹å•ä¸ªæœåŠ¡ï¼š

```yaml
feign:  
  client:
    config: 
      userservice: # é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®
        loggerLevel: FULL #  æ—¥å¿—çº§åˆ« 
```

**ä¹Ÿå¯ä»¥é’ˆå¯¹æ‰€æœ‰æœåŠ¡**ï¼š

```yaml
feign:  
  client:
    config: 
      default: # è¿™é‡Œç”¨defaultå°±æ˜¯å…¨å±€é…ç½®ï¼Œå¦‚æœæ˜¯å†™æœåŠ¡åç§°ï¼Œåˆ™æ˜¯é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®
        loggerLevel: FULL #  æ—¥å¿—çº§åˆ« 
```

è€Œæ—¥å¿—çš„çº§åˆ«åˆ†ä¸ºå››ç§ï¼š

- NONEï¼šä¸è®°å½•ä»»ä½•æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ˜¯é»˜è®¤å€¼ã€‚
- BASICï¼šä»…è®°å½•è¯·æ±‚çš„æ–¹æ³•ï¼ŒURLä»¥åŠå“åº”çŠ¶æ€ç å’Œæ‰§è¡Œæ—¶é—´
- HEADERSï¼šåœ¨BASICçš„åŸºç¡€ä¸Šï¼Œé¢å¤–è®°å½•äº†è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯
- FULLï¼šè®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”çš„æ˜ç»†ï¼ŒåŒ…æ‹¬å¤´ä¿¡æ¯ã€è¯·æ±‚ä½“ã€å…ƒæ•°æ®

ä¹Ÿå¯ä»¥åŸºäº **Java ä»£ç **æ¥ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Œå…ˆå£°æ˜ä¸€ä¸ªç±»ï¼Œç„¶åå£°æ˜ä¸€ä¸ª Logger.Level çš„å¯¹è±¡

```java
public class DefaultFeignConfiguration  {
    @Bean
    public Logger.Level feignLogLevel(){
        return Logger.Level.BASIC; // æ—¥å¿—çº§åˆ«ä¸ºBASIC
    }
}
```

å¦‚æœè¦**å…¨å±€ç”Ÿæ•ˆ**ï¼Œå°†å…¶æ”¾åˆ°å¯åŠ¨ç±»çš„ `@EnableFeignClients` è¿™ä¸ªæ³¨è§£ä¸­ï¼š

```java
@EnableFeignClients(defaultConfiguration = DefaultFeignConfiguration .class) 
```

å¦‚æœæ˜¯**å±€éƒ¨ç”Ÿæ•ˆ**ï¼Œåˆ™æŠŠå®ƒæ”¾åˆ°å¯¹åº”çš„ `@FeignClient` è¿™ä¸ªæ³¨è§£ä¸­ï¼š
å±€éƒ¨ç”Ÿæ•ˆè°ä½¿ç”¨æ”¾åˆ°è°ä¸Šé¢

```java
@FeignClient(value = "userservice", configuration = DefaultFeignConfiguration .class) 
@Service
public class OrderService{
    @Auwowired
    private userClient userClient;
}
```

## æ€§èƒ½ä¼˜åŒ–

Feign åº•å±‚å‘èµ· http è¯·æ±‚ï¼Œä¾èµ–äºå…¶å®ƒçš„æ¡†æ¶ã€‚å…¶åº•å±‚å®¢æˆ·ç«¯å®ç°æœ‰ï¼š

- **URLConnection**ï¼šé»˜è®¤å®ç°ï¼Œä¸æ”¯æŒè¿æ¥æ± 
- **Apache HttpClient** ï¼šæ”¯æŒè¿æ¥æ± 
- **OKHttp**ï¼šæ”¯æŒè¿æ¥æ± 

å› æ­¤æé«˜ Feign æ€§èƒ½çš„ä¸»è¦æ‰‹æ®µå°±æ˜¯ä½¿ç”¨**è¿æ¥æ± **ä»£æ›¿é»˜è®¤çš„ URLConnection

å¦å¤–ï¼Œæ—¥å¿—çº§åˆ«åº”è¯¥å°½é‡ç”¨ basic/noneï¼Œå¯ä»¥æœ‰æ•ˆæé«˜æ€§èƒ½ã€‚ï¼ˆæ—¥å¿—æ¶ˆè€—æ€§èƒ½ï¼‰

**è¿™é‡Œæˆ‘ä»¬ç”¨ Apache çš„HttpClientæ¥æ¼”ç¤ºè¿æ¥æ± ã€‚**Springåº•å±‚é»˜è®¤çš„ä¸€ç§å®ç°

åœ¨ order-service çš„ pom æ–‡ä»¶ä¸­å¼•å…¥ HttpClient ä¾èµ–

```xml
<!--httpClientçš„ä¾èµ– -->
<dependency>
    <groupId>io.github.openfeign</groupId>
    <artifactId>feign-httpclient</artifactId>
</dependency>
```

**é…ç½®è¿æ¥æ± **

åœ¨ order-service çš„ application.yml ä¸­æ·»åŠ é…ç½®

```yaml
feign:
  client:
    config:
      default: # defaultå…¨å±€çš„é…ç½®
        loggerLevel: BASIC # æ—¥å¿—çº§åˆ«ï¼ŒBASICå°±æ˜¯åŸºæœ¬çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯
  httpclient:
    enabled: true # å¼€å¯feignå¯¹HttpClientçš„æ”¯æŒ
    max-connections: 200 # æœ€å¤§çš„è¿æ¥æ•°
    max-connections-per-route: 50 # æ¯ä¸ªè·¯å¾„çš„æœ€å¤§è¿æ¥æ•°
```

åœ¨ FeignClientFactoryBean ä¸­çš„ loadBalance æ–¹æ³•ä¸­æ‰“æ–­ç‚¹

![](https://cdn.xn2001.com/img/2021/20210901092729.png)

Debug æ–¹å¼å¯åŠ¨ order-service  æœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ clientï¼Œåº•å±‚å°±æ˜¯ HttpClient

![](https://cdn.xn2001.com/img/2021/20210901092737.png)

## æœ€ä½³å®è·µ

### ç»§æ‰¿æ–¹å¼

ä¸€æ ·çš„ä»£ç å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥å…±äº«ï¼š

1ï¼‰å®šä¹‰ä¸€ä¸ª API æ¥å£ï¼Œåˆ©ç”¨å®šä¹‰æ–¹æ³•ï¼Œå¹¶åŸºäº SpringMVC æ³¨è§£åšå£°æ˜

2ï¼‰Feign å®¢æˆ·ç«¯ã€Controller éƒ½é›†æˆè¯¥æ¥å£

![](https://cdn.xn2001.com/img/2021/20210901092803.png)

ä¼˜ç‚¹

- ç®€å•
- å®ç°äº†ä»£ç å…±äº«

ç¼ºç‚¹

- æœåŠ¡æä¾›æ–¹ã€æœåŠ¡æ¶ˆè´¹æ–¹ç´§è€¦åˆ
- å‚æ•°åˆ—è¡¨ä¸­çš„æ³¨è§£æ˜ å°„å¹¶ä¸ä¼šç»§æ‰¿ï¼Œå› æ­¤ Controller ä¸­å¿…é¡»å†æ¬¡å£°æ˜æ–¹æ³•ã€å‚æ•°åˆ—è¡¨ã€æ³¨è§£

### æŠ½å–æ–¹å¼

å°† FeignClient æŠ½å–ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œå¹¶ä¸”æŠŠæ¥å£æœ‰å…³çš„ pojoã€é»˜è®¤çš„ Feign é…ç½®éƒ½æ”¾åˆ°è¿™ä¸ªæ¨¡å—ä¸­ï¼Œæä¾›ç»™æ‰€æœ‰æ¶ˆè´¹è€…ä½¿ç”¨ã€‚

ä¾‹å¦‚ï¼šå°† UserClientã€Userã€Feign çš„é»˜è®¤é…ç½®éƒ½æŠ½å–åˆ°ä¸€ä¸ª feign-api åŒ…ä¸­ï¼Œæ‰€æœ‰å¾®æœåŠ¡å¼•ç”¨è¯¥ä¾èµ–åŒ…ï¼Œå³å¯ç›´æ¥ä½¿ç”¨ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092811.png)

æ¥ä¸‹æ¥æˆ‘ä»¬å°±ç”¨è¯¥æ–¹æ³•åœ¨ä»£ç ä¸­å®ç°

**é¦–å…ˆåˆ›å»ºä¸€ä¸ª moduleï¼Œå‘½åä¸º feign-api**

![](https://cdn.xn2001.com/img/2021/20210901092835.png)

åœ¨ feign-api ä¸­ç„¶åå¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

order-serviceä¸­ çš„ UserClientã€User éƒ½å¤åˆ¶åˆ° feign-api é¡¹ç›®ä¸­

![](https://cdn.xn2001.com/img/2021/20210901092848.png)

æ¥ä¸‹æ¥åœ¨ order-service ä¸­ä½¿ç”¨ feign-api

ç”±äºæˆ‘ä»¬å·²ç»å°† UserClientã€User æ”¾åœ¨ fegin-api ä¸­å…±äº«äº† ï¼Œæ‰€ä»¥å¯ä»¥åˆ é™¤ order-service ä¸­çš„ UserClientã€Userï¼Œç„¶ååœ¨ order-service  ä¸­å¼•å…¥ feign-api 

```xml
<dependency>
    <groupId>com.xn2001.feign</groupId>
    <artifactId>feign-api</artifactId>
    <version>1.0</version>
</dependency>
```

**ä¿®æ”¹æ³¨è§£**

å½“å®šä¹‰çš„ FeignClient ä¸åœ¨ SpringBootApplication çš„æ‰«æåŒ…èŒƒå›´ä¸‹æ—¶ï¼Œè¿™äº› FeignClient å°±ä¸èƒ½ä½¿ç”¨ã€‚

**æ–¹æ³•ä¸€**ï¼šæŒ‡å®šFeginClientæ‰€åœ¨çš„åŒ…
è¿™ç§æƒ…å†µä¼šåŠ è½½æ‰€æœ‰çš„Client

ä¿®æ”¹ order-service å¯åŠ¨ç±»ä¸Šçš„ `@EnableFeignClients` æ³¨è§£

```java
@EnableFeignClients(basePackages = "com.xn2001.feign.clients")
```

**æ–¹æ³•äºŒ**ï¼šæŒ‡å®šFeginClientå­—èŠ‚ç ï¼ˆæ­¤å¤„çš„æ˜¯æ•°ç»„å½¢å¼ï¼Œä¹Ÿå¯ä»¥åŠ è½½å¤šä¸ªï¼‰

```java
@EnableFeignClients(clients = {UserClient.class})
```

æ­¤å¤„çš„åŠŸèƒ½å°±æ˜¯ä½¿å¾— Spring æ‰«æåˆ°å¯¹åº”çš„æ–‡ä»¶

# Gatewayç½‘å…³

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/07-cloud-gateway
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/07-cloud-gateway

Spring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰å“åº”å¼ç¼–ç¨‹å’Œäº‹ä»¶æµæŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚

Gateway ç½‘å…³æ˜¯æˆ‘ä»¬æœåŠ¡çš„å®ˆé—¨ç¥ï¼Œ**æ‰€æœ‰å¾®æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚**

ç½‘å…³çš„**æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§**ï¼š

- è¯·æ±‚è·¯ç”±
- æƒé™æ§åˆ¶
- é™æµ

![](https://cdn.xn2001.com/img/2021/20210901092857.png)



**æƒé™æ§åˆ¶**ï¼šç½‘å…³ä½œä¸ºå¾®æœåŠ¡å…¥å£ï¼Œéœ€è¦æ ¡éªŒç”¨æˆ·æ˜¯æ˜¯å¦æœ‰è¯·æ±‚èµ„æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œæ‹¦æˆªã€‚

**è·¯ç”±å’Œè´Ÿè½½å‡è¡¡**ï¼šä¸€åˆ‡è¯·æ±‚éƒ½å¿…é¡»å…ˆç»è¿‡ gatewayï¼Œä½†ç½‘å…³ä¸å¤„ç†ä¸šåŠ¡ï¼Œè€Œæ˜¯æ ¹æ®æŸç§è§„åˆ™ï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°æŸä¸ªå¾®æœåŠ¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšè·¯ç”±ã€‚å½“ç„¶è·¯ç”±çš„ç›®æ ‡æœåŠ¡æœ‰å¤šä¸ªæ—¶ï¼Œè¿˜éœ€è¦åšè´Ÿè½½å‡è¡¡ã€‚

**é™æµ**ï¼šå½“è¯·æ±‚æµé‡è¿‡é«˜æ—¶ï¼Œåœ¨ç½‘å…³ä¸­æŒ‰ç…§ä¸‹æµçš„å¾®æœåŠ¡èƒ½å¤Ÿæ¥å—çš„é€Ÿåº¦æ¥æ”¾è¡Œè¯·æ±‚ï¼Œé¿å…æœåŠ¡å‹åŠ›è¿‡å¤§ã€‚

åœ¨ SpringCloud ä¸­ç½‘å…³çš„å®ç°åŒ…æ‹¬ä¸¤ç§ï¼š

- gateway
- zuul

Zuul æ˜¯åŸºäº Servlet å®ç°ï¼Œå±äºé˜»å¡å¼ç¼–ç¨‹ã€‚è€Œ Spring Cloud Gateway åˆ™æ˜¯åŸºäº Spring5 ä¸­æä¾›çš„WebFluxï¼Œå±äºå“åº”å¼ç¼–ç¨‹çš„å®ç°ï¼Œå…·å¤‡æ›´å¥½çš„æ€§èƒ½ã€‚

## å…¥é—¨ä½¿ç”¨

1. åˆ›å»º SpringBoot å·¥ç¨‹ gatewayï¼Œå¼•å…¥ç½‘å…³ä¾èµ–
2. ç¼–å†™å¯åŠ¨ç±»
3. ç¼–å†™åŸºç¡€é…ç½®å’Œè·¯ç”±è§„åˆ™
4. å¯åŠ¨ç½‘å…³æœåŠ¡è¿›è¡Œæµ‹è¯•

```xml
<!--ç½‘å…³-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
<!--nacosæœåŠ¡å‘ç°ä¾èµ–-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

åˆ›å»º application.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
server:
  port: 10010 # ç½‘å…³ç«¯å£
spring:
  application:
    name: gateway # æœåŠ¡åç§°
  cloud:
    nacos:
      server-addr: localhost:8848 # nacosåœ°å€
    gateway:
      routes: # ç½‘å…³è·¯ç”±é…ç½®
        - id: user-service # è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯
          # uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€
          uri: lb://userservice # è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°
          predicates: # è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶
            - Path=/user/** # è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚
```

æˆ‘ä»¬å°†ç¬¦åˆ`Path` è§„åˆ™çš„ä¸€åˆ‡è¯·æ±‚ï¼Œéƒ½ä»£ç†åˆ° `uri`å‚æ•°æŒ‡å®šçš„åœ°å€ã€‚

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°† `/user/**` å¼€å¤´çš„è¯·æ±‚ï¼Œä»£ç†åˆ° `lb://userservice`ï¼Œå…¶ä¸­ lb æ˜¯è´Ÿè½½å‡è¡¡(LoadBalance)ï¼Œæ ¹æ®æœåŠ¡åæ‹‰å–æœåŠ¡åˆ—è¡¨ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚

é‡å¯ç½‘å…³ï¼Œè®¿é—® [http://localhost:10010/user/1](http://localhost:10010/user/1 ) æ—¶ï¼Œç¬¦åˆ `/user/**` è§„åˆ™ï¼Œè¯·æ±‚è½¬å‘åˆ° uriï¼š[http://userservice/user/1](http://userservice/user/1)

![](https://cdn.xn2001.com/img/2021/202108220125749.png)

å¤šä¸ª predicates çš„è¯ï¼Œè¦åŒæ—¶æ»¡è¶³è§„åˆ™ï¼Œä¸‹æ–‡æœ‰ä¾‹å­ã€‚

## æµç¨‹å›¾

![](https://cdn.xn2001.com/img/2021/202108220127419.png)

è·¯ç”±é…ç½®åŒ…æ‹¬ï¼š

1. è·¯ç”±idï¼šè·¯ç”±çš„å”¯ä¸€æ ‡ç¤º
2. è·¯ç”±ç›®æ ‡ï¼ˆuriï¼‰ï¼šè·¯ç”±çš„ç›®æ ‡åœ°å€ï¼Œhttpä»£è¡¨å›ºå®šåœ°å€ï¼Œlbä»£è¡¨æ ¹æ®æœåŠ¡åè´Ÿè½½å‡è¡¡
3. è·¯ç”±æ–­è¨€ï¼ˆpredicatesï¼‰ï¼šåˆ¤æ–­è·¯ç”±çš„è§„åˆ™
4. è·¯ç”±è¿‡æ»¤å™¨ï¼ˆfiltersï¼‰ï¼šå¯¹è¯·æ±‚æˆ–å“åº”åšå¤„ç†

## æ–­è¨€å·¥å‚

æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å†™çš„æ–­è¨€è§„åˆ™åªæ˜¯å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä¼šè¢« Predicate Factory è¯»å–å¹¶å¤„ç†ï¼Œè½¬å˜ä¸ºè·¯ç”±åˆ¤æ–­çš„æ¡ä»¶ã€‚

ä¾‹å¦‚ `Path=/user/**` æ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œè¿™ä¸ªè§„åˆ™æ˜¯ç”±

`org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory` ç±»æ¥å¤„ç†çš„ï¼Œåƒè¿™æ ·çš„æ–­è¨€å·¥å‚åœ¨ Spring Cloud Gateway è¿˜æœ‰åå‡ ä¸ª

| åç§°       | è¯´æ˜                           | ç¤ºä¾‹                                                         |
| ---------- | ------------------------------ | ------------------------------------------------------------ |
| After      | æ˜¯æŸä¸ªæ—¶é—´ç‚¹åçš„è¯·æ±‚           | -  After=2037-01-20T17:42:47.789-07:00[America/Denver]       |
| Before     | æ˜¯æŸä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚         | -  Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]       |
| Between    | æ˜¯æŸä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚       | -  Between=2037-01-20T17:42:47.789-07:00[America/Denver],  2037-01-21T17:42:47.789-07:00[America/Denver] |
| Cookie     | è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›cookie         | - Cookie=chocolate, ch.p                                     |
| Header     | è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›header         | - Header=X-Request-Id, \d+                                   |
| Host       | è¯·æ±‚å¿…é¡»æ˜¯è®¿é—®æŸä¸ªhostï¼ˆåŸŸåï¼‰ | -  Host=`**.somehost.org`, `**.anotherhost.org`              |
| Method     | è¯·æ±‚æ–¹å¼å¿…é¡»æ˜¯æŒ‡å®šæ–¹å¼         | - Method=GET,POST                                            |
| Path       | è¯·æ±‚è·¯å¾„å¿…é¡»ç¬¦åˆæŒ‡å®šè§„åˆ™       | - Path=/red/{segment},/blue/**                               |
| Query      | è¯·æ±‚å‚æ•°å¿…é¡»åŒ…å«æŒ‡å®šå‚æ•°       | - Query=name, Jackæˆ–è€…-  Query=name                          |
| RemoteAddr | è¯·æ±‚è€…çš„ipå¿…é¡»æ˜¯æŒ‡å®šèŒƒå›´       | - RemoteAddr=192.168.1.1/24                                  |
| Weight     | æƒé‡å¤„ç†                       |                                                              |

> å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories

ä¸€èˆ¬çš„ï¼Œæˆ‘ä»¬åªéœ€è¦æŒæ¡ Pathï¼ŒåŠ ä¸Šå®˜æ–¹æ–‡æ¡£çš„ä¾‹å­ï¼Œå°±å¯ä»¥åº”å¯¹å„ç§å·¥ä½œåœºæ™¯äº†ã€‚

```yaml
predicates:
  - Path=/order/**
  - After=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]
```

åƒè¿™æ ·çš„è§„åˆ™ï¼Œç°åœ¨æ˜¯ 2021å¹´8æœˆ22æ—¥01:32:42ï¼Œå¾ˆæ˜æ˜¾ After æ¡ä»¶ä¸æ»¡è¶³ï¼Œå¯ä»¥ä¸ä¼šè½¬å‘ï¼Œè·¯ç”±ä¸èµ·ä½œç”¨ã€‚

## è¿‡æ»¤å™¨å·¥å‚

GatewayFilter æ˜¯ç½‘å…³ä¸­æä¾›çš„ä¸€ç§è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡è¿”å›çš„å“åº”åšå¤„ç†ã€‚

![](https://cdn.xn2001.com/img/2021/202108220133487.png)

Springæä¾›äº†31ç§ä¸åŒçš„è·¯ç”±è¿‡æ»¤å™¨å·¥å‚ã€‚

> å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories

| **åç§°**             | **è¯´æ˜**                     |
| -------------------- | ---------------------------- |
| AddRequestHeader     | ç»™å½“å‰è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´     |
| RemoveRequestHeader  | ç§»é™¤è¯·æ±‚ä¸­çš„ä¸€ä¸ªè¯·æ±‚å¤´       |
| AddResponseHeader    | ç»™å“åº”ç»“æœä¸­æ·»åŠ ä¸€ä¸ªå“åº”å¤´   |
| RemoveResponseHeader | ä»å“åº”ç»“æœä¸­ç§»é™¤æœ‰ä¸€ä¸ªå“åº”å¤´ |
| RequestRateLimiter   | é™åˆ¶è¯·æ±‚çš„æµé‡               |

ä¸‹é¢æˆ‘ä»¬ä»¥ AddRequestHeader ä¸ºä¾‹ï¼š

![](https://cdn.xn2001.com/img/2021/202108220139913.png)

**éœ€æ±‚**ï¼šç»™æ‰€æœ‰è¿›å…¥ userservice çš„è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´ï¼š`sign=xn2001.com is eternal`

åªéœ€è¦ä¿®æ”¹ gateway æœåŠ¡çš„ application.ymlæ–‡ä»¶ï¼Œæ·»åŠ è·¯ç”±è¿‡æ»¤å³å¯ã€‚

```yaml
spring:
  cloud:
    gateway:
      routes: # ç½‘å…³è·¯ç”±é…ç½®
        - id: user-service # è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯
          # uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€
          uri: lb://userservice # è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°
          predicates: # è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶
            - Path=/user/** # è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚
          filters:
            - AddRequestHeader=sign, xn2001.com is eternal # æ·»åŠ è¯·æ±‚å¤´
```

å¦‚ä½•éªŒè¯ï¼Œæˆ‘ä»¬ä¿®æ”¹ userservice ä¸­çš„ä¸€ä¸ªæ¥å£

```java
@GetMapping("/{id}")
public User queryById(@PathVariable("id") Long id, @RequestHeader(value = "sign", required = false) String sign) {
    log.warn(sign);
    return userService.queryById(id);
}
```

é‡å¯ä¸¤ä¸ªæœåŠ¡ï¼Œè®¿é—®ï¼š[http://localhost:10010/user/1](http://localhost:10010/user/1)

å¯ä»¥çœ‹åˆ°æ§åˆ¶å°æ‰“å°å‡ºäº†è¿™ä¸ªè¯·æ±‚å¤´

![](https://cdn.xn2001.com/img/2021/202108220145565.png)

å½“ç„¶ï¼ŒGateway ä¹Ÿæ˜¯æœ‰**å…¨å±€è¿‡æ»¤å™¨**çš„ï¼Œå¦‚æœè¦**å¯¹æ‰€æœ‰çš„è·¯ç”±éƒ½ç”Ÿæ•ˆ**ï¼Œåˆ™å¯ä»¥å°†è¿‡æ»¤å™¨å·¥å‚å†™åˆ° default-filters ä¸‹ï¼š

```yaml
spring:
  cloud:
    gateway:
      default-filters:
        - AddRequestHeader=sign, xn2001.com is eternal # æ·»åŠ è¯·æ±‚å¤´
```

## å…¨å±€è¿‡æ»¤å™¨

ä¸Šé¢ä»‹ç»çš„è¿‡æ»¤å™¨å·¥å‚ï¼Œç½‘å…³æä¾›äº† 31 ç§ï¼Œä½†æ¯ä¸€ç§è¿‡æ»¤å™¨çš„ä½œç”¨éƒ½æ˜¯å›ºå®šçš„ã€‚**å¦‚æœæˆ‘ä»¬å¸Œæœ›æ‹¦æˆªè¯·æ±‚ï¼Œåšè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘åˆ™æ²¡åŠæ³•å®ç°**ã€‚

å…¨å±€è¿‡æ»¤å™¨çš„ä½œç”¨ä¹Ÿæ˜¯å¤„ç†ä¸€åˆ‡è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡å“åº”ï¼Œ**ä¸ GatewayFilter çš„ä½œç”¨ä¸€æ ·**ã€‚åŒºåˆ«åœ¨äº GlobalFilter çš„é€»è¾‘å¯ä»¥**å†™ä»£ç æ¥è‡ªå®šä¹‰è§„åˆ™**ï¼›è€Œ GatewayFilter é€šè¿‡é…ç½®å®šä¹‰ï¼Œå¤„ç†é€»è¾‘æ˜¯å›ºå®šçš„ã€‚

**éœ€æ±‚**ï¼šå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ï¼Œæ‹¦æˆªè¯·æ±‚ï¼Œåˆ¤æ–­è¯·æ±‚çš„å‚æ•°æ˜¯å¦æ»¡è¶³ä¸‹é¢æ¡ä»¶

- å‚æ•°ä¸­æ˜¯å¦æœ‰ authorization

- authorization å‚æ•°å€¼æ˜¯å¦ä¸º admin

å¦‚æœåŒæ—¶æ»¡è¶³åˆ™æ”¾è¡Œï¼Œå¦åˆ™æ‹¦æˆªã€‚

```java
@Component
public class AuthorizeFilter implements GlobalFilter, Ordered {

    // æµ‹è¯•ï¼šhttp://localhost:10010/order/101?authorization=admin
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // è·å–ç¬¬ä¸€ä¸ª authorization å‚æ•°
        String authorization = exchange.getRequest().getQueryParams().getFirst("authorization");
        if ("admin".equals(authorization)){
            // æ”¾è¡Œ
            return chain.filter(exchange);
        }
        // è®¾ç½®æ‹¦æˆªçŠ¶æ€ç ä¿¡æ¯
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        // è®¾ç½®æ‹¦æˆª
        return exchange.getResponse().setComplete();
    }

    // è®¾ç½®è¿‡æ»¤å™¨ä¼˜å…ˆçº§ï¼Œå€¼è¶Šä½ä¼˜å…ˆçº§è¶Šé«˜
    // ä¹Ÿå¯ä»¥ä½¿ç”¨ @Order æ³¨è§£
    @Override
    public int getOrder() {
        return 0;
    }
}
```

## è¿‡æ»¤å™¨é¡ºåº

è¯·æ±‚è¿›å…¥ç½‘å…³ä¼šç¢°åˆ°ä¸‰ç±»è¿‡æ»¤å™¨ï¼šDefaultFilterã€å½“å‰è·¯ç”±çš„è¿‡æ»¤å™¨ã€GlobalFilterï¼›

è¯·æ±‚è·¯ç”±åï¼Œä¼šå°†ä¸‰è€…åˆå¹¶åˆ°ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼ˆé›†åˆï¼‰ä¸­ï¼Œæ’åºåä¾æ¬¡æ‰§è¡Œæ¯ä¸ªè¿‡æ»¤å™¨.

![](https://cdn.xn2001.com/img/2021/202108230002747.png)



æ’åºçš„è§„åˆ™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

- æ¯ä¸€ä¸ªè¿‡æ»¤å™¨éƒ½å¿…é¡»æŒ‡å®šä¸€ä¸ª int ç±»å‹çš„ order å€¼ï¼Œ**order å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ‰§è¡Œé¡ºåºè¶Šé å‰**ã€‚
- GlobalFilter é€šè¿‡å®ç° Ordered æ¥å£ï¼Œæˆ–è€…ä½¿ç”¨ @Order æ³¨è§£æ¥æŒ‡å®š order å€¼ï¼Œç”±æˆ‘ä»¬è‡ªå·±æŒ‡å®šã€‚
- è·¯ç”±è¿‡æ»¤å™¨å’Œ defaultFilter çš„ order ç”± Spring æŒ‡å®šï¼Œé»˜è®¤æ˜¯æŒ‰ç…§å£°æ˜é¡ºåºä»1é€’å¢ã€‚
- å½“è¿‡æ»¤å™¨çš„ order å€¼ä¸€æ ·æ—¶ï¼Œ**ä¼šæŒ‰ç…§ defaultFilter > è·¯ç”±è¿‡æ»¤å™¨ > GlobalFilter çš„é¡ºåºæ‰§è¡Œã€‚**

## è·¨åŸŸé—®é¢˜

ä¸äº†è§£è·¨åŸŸé—®é¢˜çš„åŒå­¦å¯ä»¥ç™¾åº¦äº†è§£ä¸€ä¸‹ï¼›åœ¨ Gateway ç½‘å…³ä¸­è§£å†³è·¨åŸŸé—®é¢˜è¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚

```yaml
spring:
  cloud:
    gateway:
      globalcors: # å…¨å±€çš„è·¨åŸŸå¤„ç†
        add-to-simple-url-handler-mapping: true # è§£å†³optionsè¯·æ±‚è¢«æ‹¦æˆªé—®é¢˜
        corsConfigurations:
          '[/**]':
            allowedOrigins: # å…è®¸å“ªäº›ç½‘ç«™çš„è·¨åŸŸè¯·æ±‚ allowedOrigins: â€œ*â€ å…è®¸æ‰€æœ‰ç½‘ç«™
              - "http://localhost:8090"
            allowedMethods: # å…è®¸çš„è·¨åŸŸajaxçš„è¯·æ±‚æ–¹å¼
              - "GET"
              - "POST"
              - "DELETE"
              - "PUT"
              - "OPTIONS"
            allowedHeaders: "*" # å…è®¸åœ¨è¯·æ±‚ä¸­æºå¸¦çš„å¤´ä¿¡æ¯
            allowCredentials: true # æ˜¯å¦å…è®¸æºå¸¦cookie
            maxAge: 360000 # è¿™æ¬¡è·¨åŸŸæ£€æµ‹çš„æœ‰æ•ˆæœŸ
```



# Docker

## åˆè¯†Docker

**é¡¹ç›®éƒ¨ç½²çš„é—®é¢˜ï¼š**

å¤§å‹é¡¹ç›®ç»„ä»¶è¾ƒå¤šï¼Œè¿è¡Œç¯å¢ƒä¹Ÿè¾ƒä¸ºå¤æ‚ï¼Œéƒ¨ç½²æ—¶ä¼šç¢°åˆ°ä¸€äº›é—®é¢˜ï¼š

- ä¾èµ–å…³ç³»å¤æ‚ï¼Œå®¹æ˜“å‡ºç°å…¼å®¹æ€§é—®é¢˜
- å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒæœ‰å·®å¼‚



**Dockerå¦‚ä½•è§£å†³å¤§å‹é¡¹ç›®ä¾èµ–å…³ç³»å¤æ‚ï¼Œä¸åŒç»„ä»¶ä¾èµ–çš„å…¼å®¹æ€§é—®é¢˜ï¼Ÿ**

- Dockerå…è®¸åœ¨å¼€å‘ä¸­å°†åº”ç”¨ã€ä¾èµ–ã€å‡½æ•°åº“ã€é…ç½®ä¸€èµ·æ‰“åŒ…ï¼Œå½¢æˆå¯ç§»æ¤é•œåƒ
- Dockersåº”ç”¨è¿è¡Œåœ¨å®¹å™¨ä¸­ï¼Œä½¿ç”¨æ²™ç®±æœºåˆ¶ï¼Œç›¸äº’éš”ç¦»

Dockerå¦‚ä½•è§£å†³å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒæœ‰å·®å¼‚çš„é—®é¢˜

- Dockeré•œåƒä¸­åŒ…å«å®Œæ•´è¿è¡Œç¯å¢ƒï¼ŒåŒ…æ‹¬ç³»ç»Ÿå‡½æ•°åº“ï¼Œä»…ä¾èµ–ç³»ç»Ÿçš„Linuxå†…æ ¸ï¼Œå› æ­¤å¯ä»¥åœ¨ä»»æ„Linuxæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œã€‚

Dockeræ˜¯ä¸€ä¸ªå¿«é€Ÿäº¤ä»˜åº”ã€è¿è¡Œåº”ç”¨çš„æŠ€æœ¯

1. å¯ä»¥å°†ç¨‹åºåŠå…¶ä¾èµ–ã€è¿è¡Œç¯å¢ƒä¸€èµ·æ‰“åŒ…ä¸ºä¸€ä¸ªé•œåƒï¼Œå¯ä»¥è¿ç§»åˆ°ä»»æ„Linuxç³»ç»Ÿ
2. è¿è¡Œæ—¶åˆ©ç”¨æ²™ç®±æœºåˆ¶å½¢æˆéš”ç¦»å®¹å™¨ï¼Œå„ä¸ªåº”ç”¨äº’ä¸å¹²æ‰°
3. å¯åŠ¨ã€ç§»é™¤éƒ½å¯ä»¥é€šè¿‡ä¸€è¡Œå‘½ä»¤å®Œæˆï¼Œæ–¹ä¾¿å¿«æ·

### Dockerä¸è™šæ‹Ÿæœº

- Dockeræ˜¯ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ï¼›è™šæ‹Ÿæœºæ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸­çš„æ“ä½œç³»ç»Ÿ
- Dockerä½“ç§¯å°ã€å¯åŠ¨é€Ÿåº¦å¿«ã€æ€§èƒ½å¥½ï¼›è™šæ‹Ÿæœºä½“ç§¯å¤§ã€å¯åŠ¨é€Ÿåº¦æ…¢ã€æ€§èƒ½ä¸€èˆ¬

### é•œåƒå’Œå®¹å™¨

**é•œåƒï¼ˆImageï¼‰ï¼š**Dockerå°†åº”ç”¨ç¨‹åºæ‰€åŠå…¶æ‰€éœ€çš„ä¾èµ–ã€å‡½æ•°åº“ã€ç¯å¢ƒã€é…ç½®ç­‰æ–‡ä»¶æ‰“åŒ…åˆ°ä¸€èµ·ï¼Œç§°ä¸ºé•œåƒã€‚ï¼ˆåªè¯»ï¼‰

**å®¹å™¨ï¼ˆContainerï¼‰ï¼š**é•œåƒä¸­çš„åº”ç”¨ç¨‹åºè¿è¡Œåå½¢æˆçš„è¿›ç¨‹å°±æ˜¯å®¹å™¨ï¼Œåªæ˜¯Cockerä¼šç»™å®¹å™¨åšéš”ç¦»ï¼Œå¯¹å¤–ä¸å¯è§ã€‚

<img src="https://sm-1301822562.cos.ap-nanjing.myqcloud.com/myTypora/image-20220909085607559.png" alt="image-20220909085607559" style="zoom:50%;" />

DockerHubï¼šDockerHubæ˜¯ä¸€ä¸ªDockeré•œåƒçš„æ‰˜ç®¡å¹³å°ã€‚è¿™æ ·çš„å¹³å°ç§°ä¸ºDocker Registry

## Dockerçš„åŸºæœ¬æ“ä½œ

## Dockerfileè‡ªå®šä¹‰é•œåƒ

## Docker-Compose

## DoockeræœåŠ¡é•œåƒ

# RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/08-rabbitmq-demo
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/08-rabbitmq-demo

## åŒæ­¥å¼‚æ­¥é€šè®¯

**å¾®æœåŠ¡é—´é€šè®¯æœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼**

åŒæ­¥é€šè®¯ï¼šå°±åƒæ‰“ç”µè¯ï¼Œéœ€è¦å®æ—¶å“åº”ã€‚

å¼‚æ­¥é€šè®¯ï¼šå°±åƒå‘é‚®ä»¶ï¼Œä¸éœ€è¦é©¬ä¸Šå›å¤ã€‚

![](https://cdn.xn2001.com/img/2021/20210904133345.png)

ä¸¤ç§æ–¹å¼å„æœ‰ä¼˜åŠ£ï¼Œæ‰“ç”µè¯å¯ä»¥ç«‹å³å¾—åˆ°å“åº”ï¼Œä½†æ˜¯ä½ å´ä¸èƒ½è·Ÿå¤šä¸ªäººåŒæ—¶é€šè¯ã€‚å‘é€é‚®ä»¶å¯ä»¥åŒæ—¶ä¸å¤šä¸ªäººæ”¶å‘é‚®ä»¶ï¼Œä½†æ˜¯å¾€å¾€å“åº”ä¼šæœ‰å»¶è¿Ÿã€‚

æˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„ **Feign è°ƒç”¨**å°±å±äº**åŒæ­¥æ–¹å¼**ï¼Œè™½ç„¶è°ƒç”¨å¯ä»¥å®æ—¶å¾—åˆ°ç»“æœï¼Œä½†å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š

![](https://cdn.xn2001.com/img/2021/20210904133517.png)

**åŒæ­¥è°ƒç”¨çš„ä¼˜ç‚¹**ï¼š

- æ—¶æ•ˆæ€§è¾ƒå¼ºï¼Œå¯ä»¥ç«‹å³å¾—åˆ°ç»“æœ

**åŒæ­¥è°ƒç”¨çš„ç¼ºç‚¹**ï¼š

- è€¦åˆåº¦é«˜
- æ€§èƒ½å’Œååèƒ½åŠ›ä¸‹é™
- æœ‰é¢å¤–çš„èµ„æºæ¶ˆè€—
- æœ‰çº§è”å¤±è´¥é—®é¢˜

å¼‚æ­¥è°ƒç”¨åˆ™å¯ä»¥é¿å…ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬ä»¥è´­ä¹°å•†å“ä¸ºä¾‹ï¼Œç”¨æˆ·æ”¯ä»˜åéœ€è¦è°ƒç”¨è®¢å•æœåŠ¡å®Œæˆè®¢å•çŠ¶æ€ä¿®æ”¹ï¼Œè°ƒç”¨ç‰©æµæœåŠ¡ï¼Œä»ä»“åº“åˆ†é…å“åº”çš„åº“å­˜å¹¶å‡†å¤‡å‘è´§ã€‚åœ¨äº‹ä»¶æ¨¡å¼ä¸­ï¼Œæ”¯ä»˜æœåŠ¡æ˜¯äº‹ä»¶å‘å¸ƒè€…ï¼ˆpublisherï¼‰ï¼Œåœ¨æ”¯ä»˜å®Œæˆååªéœ€è¦å‘å¸ƒä¸€ä¸ªæ”¯ä»˜æˆåŠŸçš„äº‹ä»¶ï¼ˆeventï¼‰ï¼Œäº‹ä»¶ä¸­å¸¦ä¸Šè®¢å•idã€‚è®¢å•æœåŠ¡å’Œç‰©æµæœåŠ¡æ˜¯äº‹ä»¶è®¢é˜…è€…ï¼ˆConsumerï¼‰ï¼Œè®¢é˜…æ”¯ä»˜æˆåŠŸçš„äº‹ä»¶ï¼Œç›‘å¬åˆ°äº‹ä»¶åå®Œæˆè‡ªå·±ä¸šåŠ¡å³å¯ã€‚

ä¸ºäº†è§£é™¤äº‹ä»¶å‘å¸ƒè€…ä¸è®¢é˜…è€…ä¹‹é—´çš„è€¦åˆï¼Œä¸¤è€…å¹¶ä¸æ˜¯ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªä¸­é—´äººï¼ˆBrokerï¼‰ã€‚å‘å¸ƒè€…å‘å¸ƒäº‹ä»¶åˆ°Brokerï¼Œä¸å…³å¿ƒè°æ¥è®¢é˜…äº‹ä»¶ã€‚è®¢é˜…è€…ä»Brokerè®¢é˜…äº‹ä»¶ï¼Œä¸å…³å¿ƒè°å‘æ¥çš„æ¶ˆæ¯ã€‚

![](https://cdn.xn2001.com/img/2021/20210904144714.png)

Broker æ˜¯ä¸€ä¸ªåƒæ•°æ®æ€»çº¿ä¸€æ ·çš„ä¸œè¥¿ï¼Œæ‰€æœ‰çš„æœåŠ¡è¦æ¥æ”¶æ•°æ®å’Œå‘é€æ•°æ®éƒ½å‘åˆ°è¿™ä¸ªæ€»çº¿ä¸Šï¼Œè¿™ä¸ªæ€»çº¿å°±åƒåè®®ä¸€æ ·ï¼Œè®©æœåŠ¡é—´çš„é€šè®¯å˜å¾—æ ‡å‡†å’Œå¯æ§ã€‚

![](https://cdn.xn2001.com/img/2021/20210904145001.png)

**å¼‚æ­¥è°ƒç”¨å¥½å¤„**ï¼š

- ååé‡æå‡ï¼šæ— éœ€ç­‰å¾…è®¢é˜…è€…å¤„ç†å®Œæˆï¼Œå“åº”æ›´å¿«é€Ÿ

- æ•…éšœéš”ç¦»ï¼šæœåŠ¡æ²¡æœ‰ç›´æ¥è°ƒç”¨ï¼Œä¸å­˜åœ¨çº§è”å¤±è´¥é—®é¢˜
- è°ƒç”¨é—´æ²¡æœ‰é˜»å¡ï¼Œä¸ä¼šé€ æˆæ— æ•ˆçš„èµ„æºå ç”¨
- è€¦åˆåº¦æä½ï¼Œæ¯ä¸ªæœåŠ¡éƒ½å¯ä»¥çµæ´»æ’æ‹”ï¼Œå¯æ›¿æ¢
- æµé‡å‰Šå³°ï¼šä¸ç®¡å‘å¸ƒäº‹ä»¶çš„æµé‡æ³¢åŠ¨å¤šå¤§ï¼Œéƒ½ç”± Broker æ¥æ”¶ï¼Œè®¢é˜…è€…å¯ä»¥æŒ‰ç…§è‡ªå·±çš„é€Ÿåº¦å»å¤„ç†äº‹ä»¶

**å¼‚æ­¥è°ƒç”¨ç¼ºç‚¹**ï¼š

- æ¶æ„å¤æ‚äº†ï¼Œä¸šåŠ¡æ²¡æœ‰æ˜æ˜¾çš„æµç¨‹çº¿ï¼Œä¸å¥½ç®¡ç†
- éœ€è¦ä¾èµ–äº Broker çš„å¯é ã€å®‰å…¨ã€æ€§èƒ½

## MQæ¶ˆæ¯é˜Ÿåˆ—

MQï¼Œä¸­æ–‡æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessageQueueï¼‰ï¼Œå­—é¢æ¥çœ‹å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„ä¸­çš„ Broker

æ¯”è¾ƒå¸¸è§çš„ MQ å®ç°ï¼š

- ActiveMQ
- RabbitMQ
- RocketMQ
- Kafka

å‡ ç§å¸¸è§MQçš„å¯¹æ¯”ï¼š

|            | **RabbitMQ**            | **ActiveMQ**                      | **RocketMQ** | **Kafka**      |
| ---------- | ----------------------- | --------------------------------- | ------------ | -------------- |
| å…¬å¸/ç¤¾åŒº  | Rabbit                  | Apache                            | é˜¿é‡Œ         | Apache         |
| å¼€å‘è¯­è¨€   | Erlang                  | Java                              | Java         | Scala&amp;Java |
| åè®®æ”¯æŒ   | AMQPã€XMPPã€SMTPã€STOMP | OpenWireã€STOMPã€RESTã€XMPPã€AMQP | è‡ªå®šä¹‰åè®®   | è‡ªå®šä¹‰åè®®     |
| å¯ç”¨æ€§     | é«˜                      | ä¸€èˆ¬                              | é«˜           | é«˜             |
| å•æœºååé‡ | ä¸€èˆ¬                    | å·®                                | é«˜           | éå¸¸é«˜         |
| æ¶ˆæ¯å»¶è¿Ÿ   | å¾®ç§’çº§                  | æ¯«ç§’çº§                            | æ¯«ç§’çº§       | æ¯«ç§’ä»¥å†…       |
| æ¶ˆæ¯å¯é æ€§ | é«˜                      | ä¸€èˆ¬                              | é«˜           | ä¸€èˆ¬           |

ä»¥ RabbitMQ ä¸ºä¾‹ï¼Œæˆ‘ä»¬åœ¨ Centos7 è™šæ‹Ÿæœºä¸­ä½¿ç”¨ Docker æ¥å®‰è£…

åœ¨çº¿æ‹‰å–é•œåƒ

``` sh
docker pull rabbitmq:3-management
```

æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥è¿è¡ŒMQå®¹å™¨

```sh
docker run \
 -e RABBITMQ_DEFAULT_USER=admin \
 -e RABBITMQ_DEFAULT_PASS=123456 \
 --name mq \
 --hostname mq1 \
 -p 15672:15672 \
 -p 5672:5672 \
 -d \
 rabbitmq:3-management
```

å¯åŠ¨æˆåŠŸåè®¿é—®åœ°å€ï¼šhttp://192.168.211.128:15672

**RabbitMQ ä¸­çš„ä¸€äº›è§’è‰²**

- publisherï¼šç”Ÿäº§è€…
- consumerï¼šæ¶ˆè´¹è€…
- exchangeï¼šäº¤æ¢æœºï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±
- queueï¼šé˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯
- virtualHostï¼šè™šæ‹Ÿä¸»æœºï¼Œ**éš”ç¦»ä¸åŒç§Ÿæˆ·**çš„ exchangeã€queueã€æ¶ˆæ¯çš„éš”ç¦»

**MQ çš„åŸºæœ¬ç»“æ„**

![](https://cdn.xn2001.com/img/2021/20210904172912.png)

## å…¥é—¨æ¡ˆä¾‹

RabbitMQ å®˜æ–¹æä¾›äº† 5 ä¸ªä¸åŒçš„ Demo ç¤ºä¾‹ï¼Œå¯¹åº”äº†ä¸åŒçš„æ¶ˆæ¯æ¨¡å‹ã€‚

![](https://cdn.xn2001.com/img/2021/20210904173739.png)

Hello World æ¨¡å‹

 ![](https://cdn.xn2001.com/img/2021/20210904200637.png)

å®˜æ–¹çš„ HelloWorld æ˜¯åŸºäºæœ€åŸºç¡€çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹æ¥å®ç°çš„ï¼ŒåªåŒ…æ‹¬ä¸‰ä¸ªè§’è‰²ï¼š

- publisherï¼šæ¶ˆæ¯å‘å¸ƒè€…ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—queue
- queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè´Ÿè´£æ¥å—å¹¶ç¼“å­˜æ¶ˆæ¯
- consumerï¼šè®¢é˜…é˜Ÿåˆ—ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯

### publisherå®ç°

- å»ºç«‹è¿æ¥
- åˆ›å»º channel
- å£°æ˜é˜Ÿåˆ—
- å‘é€æ¶ˆæ¯
- å…³é—­è¿æ¥å’Œ channel

```java
public class PublisherTest {
    @Test
    public void testSendMessage() throws IOException, TimeoutException {
        // 1.å»ºç«‹è¿æ¥
        ConnectionFactory factory = new ConnectionFactory();
        // 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç 
        factory.setHost("192.168.211.128");
        factory.setPort(5672);
        factory.setVirtualHost("/");
        factory.setUsername("admin");
        factory.setPassword("123456");
        // 1.2.å»ºç«‹è¿æ¥
        Connection connection = factory.newConnection();
        // 2.åˆ›å»ºé€šé“Channel
        Channel channel = connection.createChannel();
        // 3.åˆ›å»ºé˜Ÿåˆ—
        String queueName = "simple.queue";
        channel.queueDeclare(queueName, false, false, false, null);
        // 4.å‘é€æ¶ˆæ¯
        String message = "Hello RabbitMQï¼";
        channel.basicPublish("", queueName, null, message.getBytes());
        System.out.println("å‘é€æ¶ˆæ¯æˆåŠŸï¼š[" + message + "]");
        // 5.å…³é—­é€šé“å’Œè¿æ¥
        channel.close();
        connection.close();
    }
}
```

### consumerå®ç°

- å»ºç«‹è¿æ¥
- åˆ›å»º channel
- å£°æ˜é˜Ÿåˆ—
- è®¢é˜…æ¶ˆæ¯

```java
public class ConsumerTest {
    public static void main(String[] args) throws IOException, TimeoutException {
        // 1.å»ºç«‹è¿æ¥
        ConnectionFactory factory = new ConnectionFactory();
        // 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç 
        factory.setHost("192.168.211.128");
        factory.setPort(5672);
        factory.setVirtualHost("/");
        factory.setUsername("admin");
        factory.setPassword("123456");
        // 1.2.å»ºç«‹è¿æ¥
        Connection connection = factory.newConnection();
        // 2.åˆ›å»ºé€šé“Channel
        Channel channel = connection.createChannel();
        // 3.åˆ›å»ºé˜Ÿåˆ—
        String queueName = "simple.queue";
        channel.queueDeclare(queueName, false, false, false, null);
        // 4.è®¢é˜…æ¶ˆæ¯
        channel.basicConsume(queueName, true, new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope,
                                       AMQP.BasicProperties properties, byte[] body) {
                // 5.å¤„ç†æ¶ˆæ¯
                String message = new String(body);
                System.out.println("æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š[" + message + "]");
            }
        });
        System.out.println("ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ä¸­");
    }
}
```

## SpringAMQP

SpringAMQP æ˜¯åŸºäº RabbitMQ å°è£…çš„ä¸€å¥—æ¨¡æ¿ï¼Œå¹¶ä¸”è¿˜åˆ©ç”¨ SpringBoot å¯¹å…¶å®ç°äº†è‡ªåŠ¨è£…é…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚

SpringAMQP çš„å®˜æ–¹åœ°å€ï¼šhttps://spring.io/projects/spring-amqp

![](https://cdn.xn2001.com/img/2021/20210904202046.png)

![](https://cdn.xn2001.com/img/2021/20210904202056.png)

SpringAMQP æä¾›äº†ä¸‰ä¸ªåŠŸèƒ½ï¼š

- è‡ªåŠ¨å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºåŠå…¶ç»‘å®šå…³ç³»
- åŸºäºæ³¨è§£çš„ç›‘å¬å™¨æ¨¡å¼ï¼Œå¼‚æ­¥æ¥æ”¶æ¶ˆæ¯
- å°è£…äº† RabbitTemplate å·¥å…·ï¼Œç”¨äºå‘é€æ¶ˆæ¯ 

```xml
<!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

###  BasicQueue

é¦–å…ˆé…ç½® MQåœ°å€ï¼Œåœ¨ publisherã€consumer æœåŠ¡ä¸­çš„ application.yml ä¸­æ·»åŠ é…ç½®

```yml
spring:
  rabbitmq:
    host: 192.168.150.101 # ä¸»æœºå
    port: 5672 # ç«¯å£
    virtual-host: / # è™šæ‹Ÿä¸»æœº
    username: admin # ç”¨æˆ·å
    password: 123456 # å¯†ç 
```

åœ¨ consumer æœåŠ¡ä¸­æ·»åŠ ç›‘å¬é˜Ÿåˆ—

```java
@Component
public class RabbitMQListener {
    @RabbitListener(queues = "simple.queue")
    public void listenSimpleQueueMessage(String msg) throws InterruptedException {
        System.out.println("æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€" + msg + "ã€‘");
    }
}
```

åœ¨ publisher æœåŠ¡ä¸­æ·»åŠ å‘é€æ¶ˆæ¯çš„æµ‹è¯•ç±»

```java
@RunWith(SpringRunner.class)
@SpringBootTest
public class SpringAmqpTest {
    @Autowired
    private RabbitTemplate rabbitTemplate;
    @Test
    public void testSimpleQueue() {
        // é˜Ÿåˆ—åç§°
        String queueName = "simple.queue";
        // æ¶ˆæ¯
        String message = "ä½ å¥½å•Šï¼Œä¹å¿ƒæ¹–ï¼";
        // å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(queueName, message);
    }
}
```

### WorkQueue

Work queuesï¼Œä¹Ÿè¢«ç§°ä¸ºï¼ˆTask queuesï¼‰ï¼Œä»»åŠ¡æ¨¡å‹ã€‚ç®€å•æ¥è¯´å°±æ˜¯**è®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯**ã€‚

![](https://cdn.xn2001.com/img/2021/20210904211238.png)

å½“æ¶ˆæ¯å¤„ç†æ¯”è¾ƒè€—æ—¶çš„æ—¶å€™ï¼Œå¯èƒ½ç”Ÿäº§æ¶ˆæ¯çš„é€Ÿåº¦ä¼šè¿œè¿œå¤§äºæ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿåº¦ã€‚é•¿æ­¤ä»¥å¾€ï¼Œæ¶ˆæ¯å°±ä¼šå †ç§¯è¶Šæ¥è¶Šå¤šï¼Œæ— æ³•åŠæ—¶å¤„ç†ã€‚

æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨ work æ¨¡å‹ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±åŒå¤„ç†æ¶ˆæ¯å¤„ç†ï¼Œé€Ÿåº¦å°±èƒ½å¤§å¤§æé«˜äº†ã€‚

æˆ‘ä»¬å¾ªç¯å‘é€ï¼Œæ¨¡æ‹Ÿå¤§é‡æ¶ˆæ¯å †ç§¯ç°è±¡ï¼Œåœ¨ publisher æœåŠ¡ä¸­çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼š

```java
/**
 * workQueue
 * å‘é˜Ÿåˆ—ä¸­ä¸åœå‘é€æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿæ¶ˆæ¯å †ç§¯ã€‚
 */
@Test
public void testWorkQueue() throws InterruptedException {
    // é˜Ÿåˆ—åç§°
    String queueName = "simple.queue";
    // æ¶ˆæ¯
    String message = "hello, message_";
    for (int i = 0; i < 50; i++) {
        // å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(queueName, message + i);
        Thread.sleep(20);
    }
}
```

**æ¶ˆæ¯æ¥æ”¶**

è¦æ¨¡æ‹Ÿå¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæˆ‘ä»¬åœ¨ consumer æœåŠ¡çš„ RabbitMQListener ä¸­æ·»åŠ 2ä¸ªæ–°çš„æ–¹æ³•ï¼š

```java
@RabbitListener(queues = "simple.queue")
public void listenWorkQueue1(String msg) throws InterruptedException {
    System.out.println("æ¶ˆè´¹è€…1æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
    Thread.sleep(20);
}

@RabbitListener(queues = "simple.queue")
public void listenWorkQueue2(String msg) throws InterruptedException {
    System.err.println("æ¶ˆè´¹è€…2........æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
    Thread.sleep(200);
}
```

å¯åŠ¨ ConsumerApplication åï¼Œåœ¨æ‰§è¡Œ publisher æœåŠ¡ä¸­åˆšåˆšç¼–å†™çš„å‘é€æµ‹è¯•æ–¹æ³• testWorkQueue

å¯ä»¥çœ‹åˆ°æ¶ˆè´¹è€…1å¾ˆå¿«å®Œæˆäº†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…2å´åœ¨ç¼“æ…¢çš„å¤„ç†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚

ä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯æ˜¯**å¹³å‡åˆ†é…ç»™æ¯ä¸ªæ¶ˆè´¹è€…**ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚è¿™æ˜¯å› ä¸º RabbitMQ é»˜è®¤æœ‰ä¸€ä¸ªæ¶ˆæ¯é¢„å–æœºåˆ¶ï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯èƒ½è€…å¤šåŠ³å˜›ï¼Œæ‰€ä»¥å»é™åˆ¶æ¯æ¬¡åªèƒ½å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

åœ¨ spring ä¸­æœ‰ä¸€ä¸ªç®€å•çš„é…ç½®ï¼Œè®¾ç½® prefetch å±æ€§ï¼Œæˆ‘ä»¬ä¿®æ”¹ consumer æœåŠ¡çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ é…ç½®

```yml
spring:
  rabbitmq:
    listener:
      simple:
        prefetch: 1 # æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯
```

Work æ¨¡å‹çš„ä½¿ç”¨ï¼š

- å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒä¸€æ¡æ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†
- é€šè¿‡è®¾ç½® prefetch æ¥æ§åˆ¶æ¶ˆè´¹è€…é¢„å–çš„æ¶ˆæ¯æ•°é‡

### å‘å¸ƒ/è®¢é˜…

![](https://cdn.xn2001.com/img/2021/20210904213455.png)



å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è®¢é˜…æ¨¡å‹ä¸­ï¼Œå¤šäº†ä¸€ä¸ª exchange è§’è‰²ï¼Œè€Œä¸”è¿‡ç¨‹ç•¥æœ‰å˜åŒ–

- Publisherï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯è¦å‘é€æ¶ˆæ¯çš„ç¨‹åºï¼Œä½†æ˜¯ä¸å†å‘é€åˆ°é˜Ÿåˆ—ä¸­ï¼Œ**è€Œæ˜¯å‘ç»™ exchangeï¼ˆäº¤æ¢æœºï¼‰**
- Consumerï¼šæ¶ˆè´¹è€…ï¼Œä¸ä»¥å‰ä¸€æ ·ï¼Œè®¢é˜…é˜Ÿåˆ—ï¼Œæ²¡æœ‰å˜åŒ–
- Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿä¸ä»¥å‰ä¸€æ ·ï¼Œæ¥æ”¶æ¶ˆæ¯ã€ç¼“å­˜æ¶ˆæ¯
- Exchangeï¼šäº¤æ¢æœºï¼Œä¸€æ–¹é¢ï¼Œæ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼›å¦ä¸€æ–¹é¢ï¼ŒçŸ¥é“å¦‚ä½•å¤„ç†æ¶ˆæ¯ï¼Œä¾‹å¦‚é€’äº¤ç»™æŸä¸ªç‰¹åˆ«é˜Ÿåˆ—ã€é€’äº¤ç»™æ‰€æœ‰é˜Ÿåˆ—ã€æˆ–æ˜¯å°†æ¶ˆæ¯ä¸¢å¼ƒã€‚åˆ°åº•å¦‚ä½•æ“ä½œï¼Œå–å†³äº Exchange çš„ç±»å‹ã€‚Exchange æœ‰ä»¥ä¸‹3ç§ç±»å‹ï¼š
  - Fanoutï¼šå¹¿æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šåˆ°äº¤æ¢æœºçš„é˜Ÿåˆ—
  - Directï¼šå®šå‘ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆæŒ‡å®š routing key çš„é˜Ÿåˆ—
  - Topicï¼šé€šé…ç¬¦ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆ routing patternï¼ˆè·¯ç”±æ¨¡å¼ï¼‰ çš„é˜Ÿåˆ—

**Exchangeï¼ˆäº¤æ¢æœºï¼‰åªè´Ÿè´£è½¬å‘æ¶ˆæ¯ï¼Œä¸å…·å¤‡å­˜å‚¨æ¶ˆæ¯çš„èƒ½åŠ›**ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰ä»»ä½•é˜Ÿåˆ—ä¸ Exchange ç»‘å®šï¼Œæˆ–è€…æ²¡æœ‰ç¬¦åˆè·¯ç”±è§„åˆ™çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šä¸¢å¤±ï¼

### Fanout

Fanoutï¼Œè‹±æ–‡ç¿»è¯‘æ˜¯æ‰‡å‡ºï¼Œåœ¨ MQ ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ç§°ä¸ºå¹¿æ’­ã€‚

![](https://cdn.xn2001.com/img/2021/20210912160350.png)

åœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å‘é€æµç¨‹æ˜¯è¿™æ ·çš„ï¼š

- å¯ä»¥æœ‰å¤šä¸ªé˜Ÿåˆ—
- æ¯ä¸ªé˜Ÿåˆ—éƒ½è¦ç»‘å®šåˆ° Exchangeï¼ˆäº¤æ¢æœºï¼‰
- ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œåªèƒ½å‘é€åˆ°äº¤æ¢æœºï¼Œäº¤æ¢æœºæ¥å†³å®šè¦å‘ç»™å“ªä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…æ— æ³•å†³å®š
- äº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€ç»™ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ—
- è®¢é˜…é˜Ÿåˆ—çš„æ¶ˆè´¹è€…éƒ½èƒ½æ‹¿åˆ°æ¶ˆæ¯

æ¥ä¸‹é‡Œæˆ‘ä»¬ç”¨ SpringAMQP æ¥ç®€å•å®ç° FanoutExchange

1. åœ¨ consumer æœåŠ¡ä¸­ï¼Œåˆ©ç”¨ä»£ç å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºï¼Œå¹¶å°†ä¸¤è€…ç»‘å®š
2. åœ¨ consumer æœåŠ¡ä¸­ï¼Œç¼–å†™ä¸¤ä¸ªæ¶ˆè´¹è€…æ–¹æ³•ï¼Œåˆ†åˆ«ç›‘å¬ fanout.queue1 å’Œ fanout.queue2

3. åœ¨ publisher ä¸­ç¼–å†™æµ‹è¯•æ–¹æ³•ï¼Œå‘ fanoutå‘é€æ¶ˆæ¯

**å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº**

Spring æä¾›äº†ä¸€ä¸ªæ¥å£ Exchangeï¼Œæ¥è¡¨ç¤ºæ‰€æœ‰ä¸åŒç±»å‹çš„äº¤æ¢æœºã€‚

![](https://cdn.xn2001.com/img/2021/20210904213809.png)

åœ¨ consumer ä¸­åˆ›å»ºä¸€ä¸ªç±»ï¼Œå£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºã€**ç»‘å®šå¯¹è±¡ Binding**

```java
@Configuration
public class FanoutConfig {

    /**
     * å£°æ˜äº¤æ¢æœº
     * @return Fanoutç±»å‹äº¤æ¢æœº
     */
    @Bean
    public FanoutExchange fanoutExchange(){
        return new FanoutExchange("xn2001.fanout");
    }

    /**
     * å£°æ˜é˜Ÿåˆ—
     * @return Queue
     */
    @Bean
    public Queue fanoutQueue1(){
        return new Queue("fanout.queue1");
    }
    @Bean
    public Queue fanoutQueue2(){
        return new Queue("fanout.queue2");
    }

    /**
     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº
     */
    @Bean
    public Binding bindingQueue1(FanoutExchange fanoutExchange,Queue fanoutQueue1){
        return BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);
    }
    @Bean
    public Binding bindingQueue2(FanoutExchange fanoutExchange,Queue fanoutQueue2){
        return BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);
    }

}
```

![](https://cdn.xn2001.com/img/2021/20210912181932.png)

é€šè¿‡è¿™æ · `@Bean` çš„æ–¹å¼æ¥ç”³æ˜ç¡®å®æ¯”è¾ƒéº»çƒ¦ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥é€šè¿‡ `@RabbitListener` æ³¨è§£æ¥å®Œæˆçš„ï¼Œä»£ç å¦‚ä¸‹ï¼š

åœ¨ consumer æœåŠ¡çš„ SpringRabbitListener ä¸­æ·»åŠ ä¸‰ä¸ªæ–¹æ³•ï¼Œä½œä¸ºæ¶ˆè´¹è€…

```java
@RabbitListener(queues = "fanout.queue1")
public void listenFanoutQueue1(String msg) throws InterruptedException {
    System.out.println("æ¥æ”¶åˆ°fanout.queue1çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}

@RabbitListener(queues = "fanout.queue2")
public void listenFanoutQueue2(String msg) throws InterruptedException {
    System.err.println("æ¥æ”¶åˆ°fanout.queue2çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}

@RabbitListener(bindings = @QueueBinding(
    value = @Queue(value = "fanout.queue3"),
    exchange = @Exchange(value = "xn2001.fanout",type = "fanout")
))
public void listenFanoutQueue3(String msg) {
    System.out.println("æ¥æ”¶åˆ°fanout.queue3çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}
```

åœ¨ publisher æœåŠ¡çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•

```java
/**
 * fanout
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */
@Test
public void testFanoutExchange() {
    // äº¤æ¢æœºåç§°
    String exchangeName = "xn2001.fanout";
    // æ¶ˆæ¯
    String message = "hello, everybody!";
    rabbitTemplate.convertAndSend(exchangeName, "", message);
}
```

è¿è¡Œè¯¥æ–¹æ³•ï¼Œå¯ä»¥å‘ç° fanout.queue1ã€fanout.queue2 éƒ½æ”¶åˆ°äº†äº¤æ¢æœºçš„æ¶ˆæ¯ã€‚

![](https://cdn.xn2001.com/img/2021/20210912182458.png)

æ€»ç»“ä¸€ä¸‹ï¼š

äº¤æ¢æœºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

- æ¥æ”¶ publisher å‘é€çš„æ¶ˆæ¯
- å°†æ¶ˆæ¯æŒ‰ç…§è§„åˆ™è·¯ç”±åˆ°ä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—
- ä¸èƒ½ç¼“å­˜æ¶ˆæ¯ï¼Œè·¯ç”±å¤±è´¥ï¼Œæ¶ˆæ¯ä¸¢å¤±
- FanoutExchange ä¼šå°†æ‰€æœ‰æ¶ˆæ¯è·¯ç”±åˆ°æ¯ä¸ªç»‘å®šçš„é˜Ÿåˆ—

### Direct

åœ¨ Fanout æ¨¡å¼ä¸­ï¼Œä¸€æ¡æ¶ˆæ¯ï¼Œä¼šè¢«æ‰€æœ‰è®¢é˜…çš„é˜Ÿåˆ—éƒ½æ¶ˆè´¹ã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸åŒçš„æ¶ˆæ¯è¢«ä¸åŒçš„é˜Ÿåˆ—æ¶ˆè´¹ã€‚è¿™æ—¶å°±è¦ç”¨åˆ° DirectExchange

![](https://cdn.xn2001.com/img/2021/20210912182822.png)

 åœ¨ Direct æ¨¡å‹ä¸‹ï¼š

- é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ª`RoutingKey`ï¼ˆè·¯ç”±keyï¼‰
- æ¶ˆæ¯çš„å‘é€æ–¹å‘ Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„ `RoutingKey`ã€‚
- Exchange ä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯ä¸€ä¸ªç»‘å®šçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯çš„`Routing Key`è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰é˜Ÿåˆ—çš„`Routingkey` ä¸æ¶ˆæ¯çš„ `Routing key`å®Œå…¨ä¸€è‡´ï¼Œæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯

åœ¨ consumer çš„ SpringRabbitListener ä¸­æ·»åŠ ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼ŒåŒæ—¶åŸºäºæ³¨è§£æ¥å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº

```java
@RabbitListener(bindings = @QueueBinding(
    value = @Queue(value = "direct.queue1"),
    exchange = @Exchange(value = "xn2001.direct"),
    key = {"a","b"}
))
public void listenDirectQueue1(String msg){
    System.out.println("æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}

@RabbitListener(bindings = @QueueBinding(
    value = @Queue(value = "direct.queue2"),
    exchange = @Exchange(value = "xn2001.direct"),
    key = {"a","c"}
))
public void listenDirectQueue2(String msg){
    System.out.println("æ¥æ”¶åˆ°direct.queue2çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}
```

åœ¨ publisher æœåŠ¡çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•

```java
/**
 * direct
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */
@Test
public void testDirectExchangeToA() {
    // äº¤æ¢æœºåç§°
    String exchangeName = "xn2001.direct";
    // æ¶ˆæ¯
    String message = "hello, i am direct to a!";
    rabbitTemplate.convertAndSend(exchangeName, "a", message);
}

/**
 * direct
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */
@Test
public void testDirectExchangeToB() {
    // äº¤æ¢æœºåç§°
    String exchangeName = "xn2001.direct";
    // æ¶ˆæ¯
    String message = "hello, i am direct to b!";
    rabbitTemplate.convertAndSend(exchangeName, "b", message);
}
```

### Topic

`Topic ` ä¸ `Direct`ç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ®`RoutingKey`æŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ã€‚åªä¸è¿‡`Topic `ç±»å‹å¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®š`Routing key` çš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ï¼

é€šé…ç¬¦è§„åˆ™ï¼š

`#`ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯ 

`*`ï¼šåªèƒ½åŒ¹é…ä¸€ä¸ªè¯

ä¾‹å¦‚ï¼š

`item.#`ï¼šèƒ½å¤ŸåŒ¹é…`item.spu.insert` æˆ–è€… `item.spu`

`item.*`ï¼šåªèƒ½åŒ¹é…`item.spu`

 ![](https://cdn.xn2001.com/img/2021/20210912194016.png)

- Queue1ï¼šç»‘å®šçš„æ˜¯ `china.#` ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ `china.` å¼€å¤´çš„ `routing key` éƒ½ä¼šè¢«åŒ¹é…åˆ°ã€‚åŒ…æ‹¬ china.news å’Œ china.weather
- Queue2ï¼šç»‘å®šçš„æ˜¯ `#.news` ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ `.news ` ç»“å°¾çš„  `routing key` éƒ½ä¼šè¢«åŒ¹é…ã€‚åŒ…æ‹¬ china.news å’Œ japan.news 

```java
@RabbitListener(bindings = @QueueBinding(
    value = @Queue(value = "topic.queue1"),
    exchange = @Exchange(value = "xn2001.topic",type = ExchangeTypes.TOPIC),
    key = {"china.#"}
))
public void listenTopicQueue1(String msg){
    System.out.println("æ¥æ”¶åˆ°topic.queue1çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}

@RabbitListener(bindings = @QueueBinding(
    value = @Queue(value = "topic.queue2"),
    exchange = @Exchange(value = "xn2001.topic",type = ExchangeTypes.TOPIC),
    key = {"china.*"}
))
public void listenTopicQueue2(String msg){
    System.out.println("æ¥æ”¶åˆ°topic.queue2çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}
```

```java
/**
 * topic
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */
@Test
public void testTopicExchange() {
    // äº¤æ¢æœºåç§°
    String exchangeName = "xn2001.topic";
    // æ¶ˆæ¯
    String message1 = "hello, i am topic form china.news";
    String message2 = "hello, i am topic form china.news.2";
    rabbitTemplate.convertAndSend(exchangeName, "china.news", message1);
    rabbitTemplate.convertAndSend(exchangeName, "china.news.2", message2);
}
```



![](https://cdn.xn2001.com/img/2021/20210912200012.png)

### æ¶ˆæ¯è½¬æ¢å™¨

Spring ä¼šæŠŠä½ å‘é€çš„æ¶ˆæ¯åºåˆ—åŒ–ä¸ºå­—èŠ‚å‘é€ç»™ MQï¼Œæ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿˜ä¼šæŠŠå­—èŠ‚ååºåˆ—åŒ–ä¸º Java å¯¹è±¡ã€‚

**é»˜è®¤æƒ…å†µä¸‹ Spring é‡‡ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯ JDK åºåˆ—åŒ–ã€‚**

æˆ‘ä»¬å¯ä»¥å»è¯•ä¸€ä¸‹æ•ˆæœ

```java
@RabbitListener(queuesToDeclare = @Queue(value = "object.queue"))
public void listenObjectQueue(Map<String,Object> msg) throws InterruptedException {
    System.err.println("objectæ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
    Thread.sleep(200);
}
```

```java
@Test
public void testSendMap()  {
    // å‡†å¤‡æ¶ˆæ¯
    Map<String,Object> msg = new HashMap<>();
    msg.put("name", "Jack");
    msg.put("age", 21);
    // å‘é€æ¶ˆæ¯
    rabbitTemplate.convertAndSend("object.queue", msg);
}
```

![](https://cdn.xn2001.com/img/2021/20210912204117.png)

ä¼—æ‰€å‘¨çŸ¥ï¼ŒJDKåºåˆ—åŒ–å­˜åœ¨ä¸‹åˆ—é—®é¢˜ï¼š

- æ•°æ®ä½“ç§¯è¿‡å¤§
- æœ‰å®‰å…¨æ¼æ´
- å¯è¯»æ€§å·®

æˆ‘ä»¬æ¨èå¯ä»¥ä½¿ç”¨ JSON æ¥åºåˆ—åŒ–

åœ¨ publisher å’Œ consumer ä¸¤ä¸ªæœåŠ¡ä¸­éƒ½å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>com.fasterxml.jackson.dataformat</groupId>
    <artifactId>jackson-dataformat-xml</artifactId>
    <version>2.9.10</version>
</dependency>
```

é…ç½®æ¶ˆæ¯è½¬æ¢å™¨ã€‚

åœ¨å„è‡ªçš„å¯åŠ¨ç±»ä¸­æ·»åŠ ä¸€ä¸ª Bean å³å¯

```java
@Bean
public MessageConverter jsonMessageConverter(){
    return new Jackson2JsonMessageConverter();
}
```

![](https://cdn.xn2001.com/img/2021/20210912204512.png)



# ELasticsearchæœç´¢å¼•æ“

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/09-elasticsearch-hotel-demo
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/09-elasticsearch-hotel-demo

ELasticsearch æ˜¯ä¸€æ¬¾éå¸¸å¼ºå¤§çš„å¼€æºæœç´¢å¼•æ“ï¼Œå…·å¤‡éå¸¸å¤šå¼ºå¤§åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»æµ·é‡æ•°æ®ä¸­å¿«é€Ÿæ‰¾åˆ°éœ€è¦çš„å†…å®¹ï¼Œå¯ä»¥ç”¨æ¥å®ç°æœç´¢ã€æ—¥å¿—ç»Ÿè®¡ã€åˆ†æã€ç³»ç»Ÿç›‘æ§ç­‰åŠŸèƒ½ã€‚

![](https://cdn.xn2001.com/img/2021/20210918202359.png)

## å€’æ’ç´¢å¼•

**é¦–å…ˆï¼Œå€’æ’ç´¢å¼•çš„æ¦‚å¿µæ˜¯åŸºäº MySQL è¿™æ ·çš„æ­£å‘ç´¢å¼•è€Œè¨€çš„ã€‚**

é‚£ä¹ˆæˆ‘ä»¬å…ˆè®²ä½•ä¸ºæ­£å‘ç´¢å¼•ã€‚ä¾‹å¦‚ç»™ä¸‹è¡¨ï¼ˆtb_goodsï¼‰ä¸­çš„ id åˆ›å»ºç´¢å¼•

![](https://cdn.xn2001.com/img/2021/20210918202527.png)

å¦‚æœæ˜¯æ ¹æ® id æŸ¥è¯¢ï¼Œé‚£ä¹ˆç›´æ¥èµ°ç´¢å¼•ï¼ŒæŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ã€‚

ä½†å¦‚æœæ˜¯åŸºäº title åšæ¨¡ç³ŠæŸ¥è¯¢ï¼Œåªèƒ½æ˜¯é€è¡Œæ‰«ææ•°æ®ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·æœç´¢æ•°æ®ï¼Œæ¡ä»¶æ˜¯ title ç¬¦åˆ `"%æ‰‹æœº%"`
2. é€è¡Œè·å–æ•°æ®ï¼Œæ¯”å¦‚ id ä¸º 1 çš„æ•°æ®
3. åˆ¤æ–­æ•°æ®ä¸­çš„ title æ˜¯å¦ç¬¦åˆç”¨æˆ·æœç´¢æ¡ä»¶
4. å¦‚æœç¬¦åˆåˆ™æ”¾å…¥ç»“æœé›†ï¼Œä¸ç¬¦åˆåˆ™ä¸¢å¼ƒã€‚ç„¶åå›åˆ°æ­¥éª¤1

é€è¡Œæ‰«æï¼Œä¹Ÿå°±æ˜¯å…¨è¡¨æ‰«æï¼Œéšç€æ•°æ®é‡å¢åŠ ï¼Œå…¶æŸ¥è¯¢æ•ˆç‡ä¹Ÿä¼šè¶Šæ¥è¶Šä½ã€‚å½“æ•°æ®é‡è¾¾åˆ°æ•°ç™¾ä¸‡æ—¶ï¼Œå°±æ˜¯ã€‚ã€‚ã€‚

è€Œå€’æ’ç´¢å¼•ä¸­æœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼š

- æ–‡æ¡£ï¼ˆ`Document`ï¼‰ï¼šç”¨æ¥æœç´¢çš„æ•°æ®ï¼Œå…¶ä¸­çš„æ¯ä¸€æ¡æ•°æ®å°±æ˜¯ä¸€ä¸ªæ–‡æ¡£ã€‚ä¾‹å¦‚ä¸€ä¸ªç½‘é¡µã€ä¸€ä¸ªå•†å“ä¿¡æ¯
- è¯æ¡ï¼ˆ`Term`ï¼‰ï¼šå¯¹æ–‡æ¡£æ•°æ®æˆ–ç”¨æˆ·æœç´¢æ•°æ®ï¼Œåˆ©ç”¨æŸç§ç®—æ³•åˆ†è¯ï¼Œå¾—åˆ°çš„å…·å¤‡å«ä¹‰çš„è¯è¯­å°±æ˜¯è¯æ¡ã€‚ä¾‹å¦‚ï¼šæˆ‘æ˜¯ä¸­å›½äººï¼Œå°±å¯ä»¥åˆ†ä¸ºï¼šæˆ‘ã€æ˜¯ã€ä¸­å›½äººã€ä¸­å›½ã€å›½äººè¿™æ ·çš„å‡ ä¸ªè¯æ¡

**åˆ›å»ºå€’æ’ç´¢å¼•**æ˜¯å¯¹æ­£å‘ç´¢å¼•çš„ä¸€ç§ç‰¹æ®Šå¤„ç†ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

- å°†æ¯ä¸€ä¸ªæ–‡æ¡£çš„æ•°æ®åˆ©ç”¨ç®—æ³•åˆ†è¯ï¼Œå¾—åˆ°ä¸€ä¸ªä¸ªè¯æ¡
- åˆ›å»ºè¡¨ï¼Œæ¯è¡Œæ•°æ®åŒ…æ‹¬è¯æ¡ã€è¯æ¡æ‰€åœ¨æ–‡æ¡£ idã€ä½ç½®ç­‰ä¿¡æ¯
- å› ä¸ºè¯æ¡å”¯ä¸€æ€§ï¼Œå¯ä»¥ç»™è¯æ¡åˆ›å»ºç´¢å¼•ï¼Œä¾‹å¦‚ hash è¡¨ç»“æ„ç´¢å¼•

å¦‚å›¾ï¼š

![](https://cdn.xn2001.com/img/2021/20210918203514.png)



**å€’æ’ç´¢å¼•çš„æœç´¢æµç¨‹**å¦‚ä¸‹ï¼ˆä»¥æœç´¢"åä¸ºæ‰‹æœº"ä¸ºä¾‹ï¼‰

1. ç”¨æˆ·è¾“å…¥æ¡ä»¶`"åä¸ºæ‰‹æœº"`è¿›è¡Œæœç´¢
2. å¯¹ç”¨æˆ·è¾“å…¥å†…å®¹**åˆ†è¯**ï¼Œå¾—åˆ°è¯æ¡ï¼š`åä¸º`ã€`æ‰‹æœº`
3. æ‹¿ç€è¯æ¡åœ¨å€’æ’ç´¢å¼•ä¸­æŸ¥æ‰¾ï¼Œå¯ä»¥å¾—åˆ°åŒ…å«è¯æ¡çš„æ–‡æ¡£ id æœ‰ 1ã€2ã€3
4. æ‹¿ç€æ–‡æ¡£ id åˆ°æ­£å‘ç´¢å¼•ä¸­æŸ¥æ‰¾å…·ä½“æ–‡æ¡£

![](https://cdn.xn2001.com/img/2021/20210918203815.png)

**è™½ç„¶è¦å…ˆæŸ¥è¯¢å€’æ’ç´¢å¼•ï¼Œå†æŸ¥è¯¢æ­£å‘ç´¢å¼•ï¼Œä½†æ˜¯è¯æ¡å’Œæ–‡æ¡£id éƒ½å»ºç«‹äº†ç´¢å¼•ï¼ŒæŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ï¼æ— éœ€å…¨è¡¨æ‰«æã€‚**

ä¸ºä»€ä¹ˆä¸€ä¸ªå«åšæ­£å‘ç´¢å¼•ï¼Œä¸€ä¸ªå«åšå€’æ’ç´¢å¼•å‘¢ï¼Ÿ

**æ­£å‘ç´¢å¼•**æ˜¯æœ€ä¼ ç»Ÿçš„ï¼Œæ ¹æ® id ç´¢å¼•çš„æ–¹å¼ã€‚ä½†æ ¹æ®è¯æ¡æŸ¥è¯¢æ—¶ï¼Œå¿…é¡»å…ˆé€æ¡è·å–æ¯ä¸ªæ–‡æ¡£ï¼Œç„¶ååˆ¤æ–­æ–‡æ¡£ä¸­æ˜¯å¦åŒ…å«æ‰€éœ€è¦çš„è¯æ¡ï¼Œæ˜¯**æ ¹æ®æ–‡æ¡£æ‰¾è¯æ¡çš„è¿‡ç¨‹**

**å€’æ’ç´¢å¼•**åˆ™ç›¸åï¼Œæ˜¯å…ˆæ‰¾åˆ°ç”¨æˆ·è¦æœç´¢çš„è¯æ¡ï¼Œæ ¹æ®å¾—åˆ°çš„æ–‡æ¡£ id è·å–è¯¥æ–‡æ¡£ã€‚æ˜¯**æ ¹æ®è¯æ¡æ‰¾æ–‡æ¡£çš„è¿‡ç¨‹**

## æ–‡æ¡£å’Œå­—æ®µ

elasticsearch æ˜¯é¢å‘**æ–‡æ¡£ï¼ˆDocumentï¼‰**å­˜å‚¨çš„ï¼Œå¯ä»¥æ˜¯æ•°æ®åº“ä¸­çš„ä¸€æ¡å•†å“æ•°æ®ï¼Œä¸€ä¸ªè®¢å•ä¿¡æ¯ã€‚æ–‡æ¡£æ•°æ®ä¼šè¢«åºåˆ—åŒ–ä¸º json æ ¼å¼åå­˜å‚¨åœ¨ elasticsearch

![](https://cdn.xn2001.com/img/2021/20210918212707.png)

è€Œ JSON æ–‡æ¡£ä¸­å¾€å¾€åŒ…å«å¾ˆå¤šçš„**å­—æ®µï¼ˆFieldï¼‰**ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„åˆ—ã€‚

## ç´¢å¼•å’Œæ˜ å°„

**ç´¢å¼•ï¼ˆIndexï¼‰**ï¼Œå°±æ˜¯ç›¸åŒç±»å‹çš„æ–‡æ¡£çš„é›†åˆã€‚

ä¾‹å¦‚ï¼š

- æ‰€æœ‰ç”¨æˆ·æ–‡æ¡£ï¼Œå°±å¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºç”¨æˆ·çš„ç´¢å¼•ï¼›
- æ‰€æœ‰å•†å“çš„æ–‡æ¡£ï¼Œå¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºå•†å“çš„ç´¢å¼•ï¼›
- æ‰€æœ‰è®¢å•çš„æ–‡æ¡£ï¼Œå¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºè®¢å•çš„ç´¢å¼•ï¼›

![](https://cdn.xn2001.com/img/2021/20210918213357.png)



å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç´¢å¼•å½“åšæ˜¯æ•°æ®åº“ä¸­çš„è¡¨ã€‚

æ•°æ®åº“çš„è¡¨ä¼šæœ‰çº¦æŸä¿¡æ¯ï¼Œç”¨æ¥å®šä¹‰è¡¨çš„ç»“æ„ã€å­—æ®µçš„åç§°ã€ç±»å‹ç­‰ä¿¡æ¯ã€‚å› æ­¤ï¼Œç´¢å¼•åº“ä¸­å°±æœ‰**æ˜ å°„ï¼ˆmappingï¼‰**ï¼Œæ˜¯ç´¢å¼•ä¸­æ–‡æ¡£çš„å­—æ®µçº¦æŸä¿¡æ¯ï¼Œç±»ä¼¼è¡¨çš„ç»“æ„çº¦æŸã€‚

**mysql ä¸ elasticsearch**

| **MySQL** | **Elasticsearch** | **è¯´æ˜**                                                     |
| --------- | ----------------- | ------------------------------------------------------------ |
| Table     | Index             | ç´¢å¼•(index)ï¼Œå°±æ˜¯æ–‡æ¡£çš„é›†åˆï¼Œç±»ä¼¼æ•°æ®åº“çš„è¡¨(table)           |
| Row       | Document          | æ–‡æ¡£ï¼ˆDocumentï¼‰ï¼Œå°±æ˜¯ä¸€æ¡æ¡çš„æ•°æ®ï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„è¡Œï¼ˆRowï¼‰ï¼Œæ–‡æ¡£éƒ½æ˜¯JSONæ ¼å¼ |
| Column    | Field             | å­—æ®µï¼ˆFieldï¼‰ï¼Œå°±æ˜¯JSONæ–‡æ¡£ä¸­çš„å­—æ®µï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„åˆ—ï¼ˆColumnï¼‰ |
| Schema    | Mapping           | Mappingï¼ˆæ˜ å°„ï¼‰æ˜¯ç´¢å¼•ä¸­æ–‡æ¡£çš„çº¦æŸï¼Œä¾‹å¦‚å­—æ®µç±»å‹çº¦æŸã€‚ç±»ä¼¼æ•°æ®åº“çš„è¡¨ç»“æ„ï¼ˆSchemaï¼‰ |
| SQL       | DSL               | DSLæ˜¯elasticsearchæä¾›çš„JSONé£æ ¼çš„è¯·æ±‚è¯­å¥ï¼Œç”¨æ¥æ“ä½œelasticsearchï¼Œå®ç°CRUD |

- Mysqlï¼šæ“…é•¿äº‹åŠ¡ç±»å‹æ“ä½œï¼Œå¯ä»¥ç¡®ä¿æ•°æ®çš„å®‰å…¨å’Œä¸€è‡´æ€§

- Elasticsearchï¼šæ“…é•¿æµ·é‡æ•°æ®çš„æœç´¢ã€åˆ†æã€è®¡ç®—

å› æ­¤åœ¨ä¼ä¸šä¸­ï¼Œå¾€å¾€æ˜¯ä¸¤è€…ç»“åˆä½¿ç”¨ï¼š

- å¯¹å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜çš„å†™æ“ä½œï¼Œä½¿ç”¨ MySQL å®ç°
- å¯¹æŸ¥è¯¢æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„æœç´¢éœ€æ±‚ï¼Œä½¿ç”¨ ELasticsearch å®ç°
- ä¸¤è€…å†åŸºäºæŸç§æ–¹å¼ï¼Œå®ç°æ•°æ®çš„åŒæ­¥ï¼Œä¿è¯ä¸€è‡´æ€§

![](https://cdn.xn2001.com/img/2021/20210918213631.png)



## å®‰è£…Elasticsearch

å› ä¸ºæˆ‘ä»¬è¿˜éœ€è¦éƒ¨ç½² kibana å®¹å™¨ï¼Œéœ€è¦è®© es å’Œ kibana å®¹å™¨äº’è”ã€‚è¿™é‡Œå…ˆåˆ›å»ºä¸€ä¸ªç½‘ç»œï¼š

```sh
docker network create es-net 
```

å®‰è£…

```sh
docker run -d \
--name es \
-e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
-e "discovery.type=single-node" \
-v es-data:/usr/share/elasticsearch/data \
-v es-plugins:/usr/share/elasticsearch/plugins \
--privileged \
--network es-net \
-p 9200:9200 \
-p 9300:9300 \
elasticsearch:7.12.1
```

å‘½ä»¤è§£é‡Šï¼š

- `-e "cluster.name=es-docker-cluster"`ï¼šè®¾ç½®é›†ç¾¤åç§°
- `-e "http.host=0.0.0.0"`ï¼šç›‘å¬çš„åœ°å€ï¼Œå¯ä»¥å¤–ç½‘è®¿é—®
- `-e "ES_JAVA_OPTS=-Xms512m -Xmx512m"`ï¼šå†…å­˜å¤§å°
- `-e "discovery.type=single-node"`ï¼šéé›†ç¾¤æ¨¡å¼
- `-v es-data:/usr/share/elasticsearch/data`ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ•°æ®ç›®å½•
- `-v es-logs:/usr/share/elasticsearch/logs`ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ—¥å¿—ç›®å½•
- `-v es-plugins:/usr/share/elasticsearch/plugins`ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ’ä»¶ç›®å½•
- `--privileged`ï¼šæˆäºˆé€»è¾‘å·è®¿é—®æƒ
- `--network es-net` ï¼šåŠ å…¥ä¸€ä¸ªåä¸º es-net çš„ç½‘ç»œä¸­
- `-p 9200:9200`ï¼šç«¯å£æ˜ å°„é…ç½®

è®¿é—®åœ°å€ï¼šhttp://192.168.211.128:9200 å³å¯çœ‹åˆ° elasticsearch çš„å“åº”ç»“æœ

![](https://cdn.xn2001.com/img/2021/20210918214620.png)

## å®‰è£…kibana

kibana å¯ä»¥ç»™æˆ‘ä»¬æä¾›ä¸€ä¸ª elasticsearch çš„å¯è§†åŒ–ç•Œé¢ï¼Œä¾¿äºæˆ‘ä»¬å­¦ä¹ å‘½ä»¤ã€‚

```sh
docker run -d \
--name kibana \
-e ELASTICSEARCH_HOSTS=http://es:9200 \
--network=es-net \
-p 5601:5601  \
kibana:7.12.1
```

- `--network es-net` ï¼šåŠ å…¥ä¸€ä¸ªåä¸º es-net çš„ç½‘ç»œä¸­ï¼Œä¸ elasticsearch åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­
- `-e ELASTICSEARCH_HOSTS=http://es:9200"`ï¼šè®¾ç½® elasticsearch çš„åœ°å€ï¼Œå› ä¸º kibana å·²ç»ä¸ elasticsearch åœ¨ä¸€ä¸ªç½‘ç»œï¼Œå› æ­¤å¯ä»¥ç”¨å®¹å™¨åç›´æ¥è®¿é—® elasticsearch
- `-p 5601:5601`ï¼šç«¯å£æ˜ å°„é…ç½®

è®¿é—®åœ°å€ï¼šhttp://192.168.211.128:5601ï¼Œå³å¯çœ‹åˆ°ç»“æœ

![](https://cdn.xn2001.com/img/2021/20210918214722.png)

æ§åˆ¶é¢æ¿ï¼šhttp://192.168.211.128:5601/app/dev_tools#/console

## å®‰è£…IKåˆ†è¯å™¨

ç”±äºå›½å†…è®¿é—® GitHub è¾ƒæ…¢ï¼Œæˆ‘ä»¬é€‰æ‹©ç¦»çº¿æ¨¡å¼å®‰è£…ã€‚

å®‰è£…æ’ä»¶éœ€è¦çŸ¥é“ elasticsearch çš„ plugins ç›®å½•ä½ç½®ï¼Œè€Œæˆ‘ä»¬ç”¨äº†æ•°æ®å·æŒ‚è½½ï¼Œå› æ­¤éœ€è¦æŸ¥çœ‹ elasticsearch çš„æ•°æ®å·ç›®å½•ï¼Œé€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹

```sh
docker volume inspect es-plugins
```

æ˜¾ç¤ºç»“æœï¼š

```json
[
    {
        "CreatedAt": "2022-05-06T10:06:34+08:00",
        "Driver": "local",
        "Labels": null,
        "Mountpoint": "/var/lib/docker/volumes/es-plugins/_data",
        "Name": "es-plugins",
        "Options": null,
        "Scope": "local"
    }
]
```

è¯´æ˜ plugins ç›®å½•è¢«æŒ‚è½½åˆ°äº† `/var/lib/docker/volumes/es-plugins/_data ` è¿™ä¸ªç›®å½•ä¸­

![](https://cdn.xn2001.com/img/2021/20210918215615.png)

é‡å¯å®¹å™¨

```shell
# 4ã€é‡å¯å®¹å™¨
docker restart es

# æŸ¥çœ‹esæ—¥å¿—
docker logs -f es
```

IKåˆ†è¯å™¨åŒ…å«ä¸¤ç§æ¨¡å¼ï¼š

* `ik_smart`ï¼šæ™ºèƒ½åˆ‡åˆ†ï¼Œç²—ç²’åº¦
* `ik_max_word`ï¼šæœ€ç»†åˆ‡åˆ†ï¼Œç»†ç²’åº¦

æˆ‘ä»¬åœ¨ä¸Šé¢çš„ Kibana æ§åˆ¶å°æµ‹è¯•

```json
GET /_analyze
{
  "analyzer": "ik_max_word",
  "text": "é’Ÿè€å¸ˆä½ å¥½èœå•Š"
}
```

## æ‰©å±•è¯è¯å…¸

åœ¨ä¸Šé¢çš„IKåˆ†è¯å™¨æˆ‘ä»¬å¯ä»¥éšç€çƒ­ç‚¹è¯æ¥æ‰©å±•ï¼Œå¯ä»¥è‡ªå·±æ·»åŠ ï¼Œæ¯”å¦‚ â€é’Ÿè€å¸ˆåº”è¯¥æ˜¯ä¸€ä¸ªçƒ­ç‚¹è¯â€œï¼Œå¦å¤–ä½ ä¹Ÿå¯ä»¥é…ç½®ä¸€äº›åœç”¨æ‰çš„æ•æ„Ÿè¯ï¼Œè®©å…¶ä¸è¿›è¡Œåˆ†è¯ã€‚

æ‰“å¼€IKåˆ†è¯å™¨ config ç›®å½•æ˜¯ `IKAnalyzer.cfg.xml`ï¼Œæ·»åŠ ä¸€ä¸ªæ–‡ä»¶åï¼Œæˆ‘ä»¬ä»¥ `ext.dic` æ–‡ä»¶åä¸ºä¾‹ã€‚

![](https://cdn.xn2001.com/img/2021/20210918221159.png)

æˆ‘ä»¬å»åˆ›å»º `ext.dic` ï¼Œåœ¨å…¶ä¸­æ·»åŠ çƒ­ç‚¹è¯å°±å¥½äº†ï¼Œä¸€ä¸ªè¯ä¸€è¡Œã€‚

![](https://cdn.xn2001.com/img/2021/20210918220910.png)

é‡å¯ elasticsearch

```sh
docker restart es
```

é‡æ–°æµ‹è¯•

```json
GET /_analyze
{
  "analyzer": "ik_max_word",
  "text": "é’Ÿè€å¸ˆä½ å¥½èœå•Š"
}
```

![](https://cdn.xn2001.com/img/2021/20210918221424.png)

## ç´¢å¼•åº“æ“ä½œ

### Mappingå±æ€§æ˜ å°„

ç´¢å¼•åº“å°±ç±»ä¼¼æ•°æ®åº“è¡¨ï¼Œ**mapping æ˜ å°„å°±ç±»ä¼¼è¡¨çš„ç»“æ„**

æˆ‘ä»¬è¦å‘ es ä¸­å­˜å‚¨æ•°æ®ï¼Œå¿…é¡»å…ˆåˆ›å»ºâ€œåº“â€å’Œâ€œè¡¨â€

mapping æ˜¯å¯¹ç´¢å¼•åº“ä¸­æ–‡æ¡£çš„çº¦æŸï¼Œå¸¸è§çš„ mapping å±æ€§åŒ…æ‹¬ï¼š

- typeï¼šå­—æ®µæ•°æ®ç±»å‹ï¼Œå¸¸è§çš„ç®€å•ç±»å‹æœ‰ï¼š
  - å­—ç¬¦ä¸²ï¼štextï¼ˆå¯åˆ†è¯çš„æ–‡æœ¬ï¼‰ã€keywordï¼ˆç²¾ç¡®å€¼ï¼Œä¾‹å¦‚ï¼šå“ç‰Œã€å›½å®¶ã€ipåœ°å€ï¼‰
  - æ•°å€¼ï¼šlongã€integerã€shortã€byteã€doubleã€floatã€
  - å¸ƒå°”ï¼šboolean
  - æ—¥æœŸï¼šdate
  - å¯¹è±¡ï¼šobject
- **indexï¼šæ˜¯å¦åˆ›å»ºç´¢å¼•ï¼Œé»˜è®¤ä¸º true**
- analyzerï¼šä½¿ç”¨å“ªç§åˆ†è¯å™¨
- propertiesï¼šè¯¥å­—æ®µçš„å­å­—æ®µ

æˆ‘ä»¬ä»¥éœ€è¦å­˜å‚¨ä¸‹é¢çš„ JSON ä¸ºä¾‹æ¥è®²è§£

```json
{
    "age": 21,
    "weight": 52.1,
    "isMarried": false,
    "info": "é’Ÿè€å¸ˆçœŸèœ",
    "email": "jialna@qq.com",
    "score": [99.1, 99.5, 98.9],
    "name": {
        "firstName": "æ¹–",
        "lastName": "å¿ƒ"
    }
}
```

é¦–å…ˆå¯¹åº”çš„æ¯ä¸ªå­—æ®µæ˜ å°„ï¼ˆmappingï¼‰æƒ…å†µå¦‚ä¸‹ï¼š

- ageï¼šç±»å‹ä¸º integerï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨
- weightï¼šç±»å‹ä¸º floatï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨
- isMarriedï¼šç±»å‹ä¸ºbooleanï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨
- infoï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œéœ€è¦åˆ†è¯ï¼Œå› æ­¤æ˜¯ textï¼›å‚ä¸æœç´¢ï¼Œindexä¸ºtrueï¼›åˆ†è¯å™¨å¯ä»¥ç”¨ ik_smart
- emailï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä½†æ˜¯ä¸éœ€è¦åˆ†è¯ï¼Œå› æ­¤æ˜¯ keywordï¼›ä¸å‚ä¸æœç´¢ï¼Œindex ä¸º falseï¼›æ— éœ€åˆ†è¯å™¨
- scoreï¼šè™½ç„¶æ˜¯æ•°ç»„ï¼Œ**ä½†æ˜¯æˆ‘ä»¬åªçœ‹å…ƒç´ çš„ç±»å‹**ï¼Œç±»å‹ä¸º floatï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨
- nameï¼šç±»å‹ä¸º objectï¼Œéœ€è¦å®šä¹‰å¤šä¸ªå­å±æ€§
  - name.firstNameï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä¸éœ€è¦åˆ†è¯ï¼Œkeywordï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨
  - name.lastNameï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä¸éœ€è¦åˆ†è¯ï¼Œkeywordï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨

### åˆ›å»ºç´¢å¼•åº“å’Œæ˜ å°„

ä¸Šé¢æˆ‘ä»¬äº†è§£äº† Mapping å±æ€§æ˜ å°„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å»çœ‹çœ‹å¦‚ä½•åˆ›å»ºç´¢å¼•åº“åŠæ˜ å°„ã€‚

```json
PUT /ç´¢å¼•åº“åç§°
{
  "mappings": {
    "properties": {
      "å­—æ®µå":{
        "type": "text",
        "analyzer": "ik_smart"
      },
      "å­—æ®µå2":{
        "type": "keyword",
        "index": "false"
      },
      "å­—æ®µå3":{
        "properties": {
          "å­å­—æ®µ": {
            "type": "keyword"
          }
        }
      }
      // ...ç•¥
    }
  }
}
```

```json
PUT /xn2001
{
  "mappings": {
    "properties": {
      "info":{
        "type": "text",
        "analyzer": "ik_smart"
      },
      "email":{
        "type": "keyword",
        "index": "false"
      },
      "name":{
        "properties": {
          "firstName": {
            "type": "keyword"
          },
          "lastName": {
            "type": "keyword"
          }
        }
      }
    }
  }
}
```

![](https://cdn.xn2001.com/img/2021/20210918224647.png)

æˆ‘ä»¬ç”¨çœŸå®çš„æ•°æ®åº“è¡¨æ¥åˆ›å»ºä¸€ä¸ªç´¢å¼•åº“

![](https://cdn.xn2001.com/img/2021/20210919164626.png)

- å­—æ®µåã€å­—æ®µæ•°æ®ç±»å‹ï¼Œå¯ä»¥å‚è€ƒæ•°æ®è¡¨ç»“æ„çš„åç§°å’Œç±»å‹
- æ˜¯å¦å‚ä¸æœç´¢è¦åˆ†æä¸šåŠ¡æ¥åˆ¤æ–­ï¼Œä¾‹å¦‚å›¾ç‰‡åœ°å€ï¼Œå°±æ— éœ€å‚ä¸æœç´¢
- æ˜¯å¦åˆ†è¯å‘¢è¦çœ‹å†…å®¹ï¼Œå†…å®¹å¦‚æœæ˜¯ä¸€ä¸ªæ•´ä½“å°±æ— éœ€åˆ†è¯
- åˆ†è¯å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ç»Ÿä¸€ä½¿ç”¨ `ik_max_word`

```json
PUT /hotel
{
  "mappings": {
    "properties": {
      "id": {
        "type": "keyword"
      },
      "name":{
        "type": "text",
        "analyzer": "ik_max_word",
        "copy_to": "all"
      },
      "address":{
        "type": "keyword",
        "index": false
      },
      "price":{
        "type": "integer"
      },
      "score":{
        "type": "integer"
      },
      "brand":{
        "type": "keyword",
        "copy_to": "all"
      },
      "city":{
        "type": "keyword",
        "copy_to": "all"
      },
      "starName":{
        "type": "keyword"
      },
      "business":{
        "type": "keyword"
      },
      "location":{
        "type": "geo_point"
      },
      "pic":{
        "type": "keyword",
        "index": false
      },
      "all":{
        "type": "text",
        "analyzer": "ik_max_word"
      }
    }
  }
}
```

ç‰¹æ®Šå­—æ®µè¯´æ˜ï¼š

- locationï¼šåœ°ç†åæ ‡ï¼Œé‡Œé¢åŒ…å«ç²¾åº¦ã€çº¬åº¦
- allï¼šä¸€ä¸ªç»„åˆå­—æ®µï¼Œå…¶ç›®çš„æ˜¯å°†å¤šå­—æ®µçš„å€¼åˆ©ç”¨ `copy_to` åˆå¹¶ï¼Œæä¾›ç»™ç”¨æˆ·æœç´¢ï¼Œè¿™æ ·ä¸€æ¥å°±åªéœ€è¦æœç´¢ä¸€ä¸ªå­—æ®µå°±å¯ä»¥å¾—åˆ°ç»“æœï¼Œæ€§èƒ½æ›´å¥½ã€‚

> ESä¸­æ”¯æŒä¸¤ç§åœ°ç†åæ ‡æ•°æ®ç±»å‹ï¼š
>
> - geo_pointï¼šç”±çº¬åº¦ï¼ˆlatitudeï¼‰å’Œç»åº¦ï¼ˆlongitudeï¼‰ç¡®å®šçš„ä¸€ä¸ªç‚¹ã€‚ä¾‹å¦‚ï¼š"32.8752345, 120.2981576"
> - geo_shapeï¼šæœ‰å¤šä¸ª geo_point ç»„æˆçš„å¤æ‚å‡ ä½•å›¾å½¢ã€‚ä¾‹å¦‚ä¸€æ¡ç›´çº¿ï¼Œ"LINESTRING (-77.03653 38.897676, -77.009051 38.889939)"

### ä¿®æ”¹ç´¢å¼•åº“

å€’æ’ç´¢å¼•ç»“æ„è™½ç„¶ä¸å¤æ‚ï¼Œä½†æ˜¯ä¸€æ—¦æ•°æ®ç»“æ„æ”¹å˜ï¼ˆæ¯”å¦‚æ”¹å˜äº†åˆ†è¯å™¨ï¼‰ï¼Œå°±éœ€è¦é‡æ–°åˆ›å»ºå€’æ’ç´¢å¼•ï¼Œè¿™ç®€ç›´æ˜¯ç¾éš¾ã€‚å› æ­¤ç´¢å¼•åº“**ä¸€æ—¦åˆ›å»ºï¼Œæ— æ³•ä¿®æ”¹ mapping**

è™½ç„¶æ— æ³•ä¿®æ”¹ mapping ä¸­å·²æœ‰çš„å­—æ®µï¼Œä½†æ˜¯å´å…è®¸æ·»åŠ æ–°çš„å­—æ®µåˆ° mapping ä¸­ï¼Œä¸ä¼šå¯¹å€’æ’ç´¢å¼•äº§ç”Ÿå½±å“ã€‚

```json
PUT /ç´¢å¼•åº“å/_mapping
{
  "properties": {
    "æ–°å­—æ®µå":{
      "type": "integer"
    }
  }
}
```

### åˆ é™¤ç´¢å¼•åº“

```json
DELETE /ç´¢å¼•åº“å
```

### æŸ¥è¯¢ç´¢å¼•åº“

```json
GET /æ•°æ®åº“å
```

## DSLæ–‡æ¡£æ“ä½œ

### æ–°å¢æ–‡æ¡£

```json
POST /ç´¢å¼•åº“å/_doc/æ–‡æ¡£id
{
    "å­—æ®µ1": "å€¼1",
    "å­—æ®µ2": "å€¼2",
    "å­—æ®µ3": {
        "å­å±æ€§1": "å€¼3",
        "å­å±æ€§2": "å€¼4"
    }
    // ...
}
```

```json
POST /xn2001/_doc/1
{
    "info": "æˆ‘ä¸ä¼šJava",
    "email": "jialna@qq.com",
    "name": {
        "firstName": "é’Ÿ",
        "lastName": "å¼Ÿå¼Ÿ"
    }
}
```

### ä¿®æ”¹æ–‡æ¡£

ä¿®æ”¹æ–‡æ¡£æœ‰ä¸¤ç§æ–¹å¼ï¼š

- å…¨é‡ä¿®æ”¹ï¼šç›´æ¥è¦†ç›–åŸæ¥çš„æ–‡æ¡£
- å¢é‡ä¿®æ”¹ï¼šä¿®æ”¹æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ

**å…¨é‡ä¿®æ”¹**æ˜¯è¦†ç›–åŸæ¥çš„æ–‡æ¡£ï¼Œå…¶æœ¬è´¨æ˜¯ï¼š

- æ ¹æ®æŒ‡å®šçš„ id åˆ é™¤æ–‡æ¡£
- æ–°å¢ä¸€ä¸ªç›¸åŒ id çš„æ–‡æ¡£

**æ³¨æ„**ï¼šå¦‚æœæ ¹æ® id åˆ é™¤æ—¶ï¼Œid ä¸å­˜åœ¨ï¼Œç¬¬äºŒæ­¥çš„æ–°å¢ä¹Ÿä¼šæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å˜æˆäº†æ–°å¢æ“ä½œ

```json
PUT /{ç´¢å¼•åº“å}/_doc/id
{
    "å­—æ®µ1": "å€¼1",
    "å­—æ®µ2": "å€¼2",
    // ... ç•¥
}
```

```json
PUT /xn2001/_doc/1
{
    "info": "æˆ‘ä¹Ÿä¸ä¼šæ•²ä»£ç ",
    "email": "3300123589@qq.com",
    "name": {
        "firstName": "å¼Ÿå¼Ÿ",
        "lastName": "é’Ÿ"
    }
}
```

**å¢é‡ä¿®æ”¹**æ˜¯åªä¿®æ”¹æŒ‡å®š id åŒ¹é…çš„æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ

```json
POST /{ç´¢å¼•åº“å}/_update/æ–‡æ¡£id
{
    "doc": {
         "å­—æ®µå": "æ–°çš„å€¼",
    }
}
```

```json
POST /heima/_update/1
{
  "doc": {
    "email": "update@qq.com"
  }
}
```

### æŸ¥è¯¢æ–‡æ¡£

```json
GET /{ç´¢å¼•åº“åç§°}/_doc/{id}
```

### åˆ é™¤æ–‡æ¡£

```json
DELETE /{ç´¢å¼•åº“å}/_doc/{id}
```

## RestClientæ–‡æ¡£æ“ä½œ

ES å®˜æ–¹æä¾›äº†å„ç§ä¸åŒè¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œç”¨æ¥æ“ä½œ ESã€‚è¿™äº›å®¢æˆ·ç«¯çš„æœ¬è´¨å°±æ˜¯ç»„è£… DSL è¯­å¥ï¼Œé€šè¿‡ http è¯·æ±‚å‘é€ç»™ ESã€‚å®˜æ–¹æ–‡æ¡£åœ°å€ï¼šhttps://www.elastic.co/guide/en/elasticsearch/client/index.html

å…¶ä¸­çš„Java Rest ClientåˆåŒ…æ‹¬ä¸¤ç§ï¼š

- Java Low Level Rest Client
- Java High Level Rest Client

![](https://cdn.xn2001.com/img/2021/20210919234405.png)

æˆ‘ä»¬ä¸‹é¢å­¦ä¹ çš„æ˜¯ **Java HighLevel Rest Client å®¢æˆ·ç«¯ API**

### åˆå§‹åŒ–RestClient

åœ¨ elasticsearch æä¾›çš„ API ä¸­ï¼Œelasticsearch ä¸€åˆ‡äº¤äº’éƒ½å°è£…åœ¨ä¸€ä¸ªåä¸º RestHighLevelClient çš„ç±»ä¸­ï¼Œå¿…é¡»å…ˆå®Œæˆè¿™ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–ï¼Œå»ºç«‹ä¸ elasticsearch çš„è¿æ¥ã€‚

```xml
<dependency>
    <groupId>org.elasticsearch.client</groupId>
    <artifactId>elasticsearch-rest-high-level-client</artifactId>
</dependency>
```

SpringBoot é»˜è®¤çš„ ES ç‰ˆæœ¬æ˜¯ 7.6.2ï¼Œæˆ‘ä»¬éœ€è¦è¦†ç›–é»˜è®¤çš„ESç‰ˆæœ¬

```xml
<properties>
    <java.version>1.8</java.version>
    <elasticsearch.version>7.12.1</elasticsearch.version>
</properties>
```

åˆå§‹åŒ– RestHighLevelClientï¼Œåˆå§‹åŒ–çš„ä»£ç å¦‚ä¸‹ï¼š

```java
RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(
        HttpHost.create("http://192.168.211.128:9200")
));
```

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±» HotelIndexTestï¼Œç„¶åå°†åˆå§‹åŒ–çš„ä»£ç ç¼–å†™åœ¨ `@BeforeEach` æ–¹æ³•

```java
/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/9/19 17:18
 */
public class HotelIndexTest {

    private RestHighLevelClient restHighLevelClient;

    @Test
    void testInit(){
        System.out.println(this.restHighLevelClient);
    }

    @BeforeEach
    void init(){
        this.restHighLevelClient = new RestHighLevelClient(RestClient.builder(
                HttpHost.create("http://192.168.211.128:9200")
        ));
    }

    @AfterEach
    void down() throws IOException {
        this.restHighLevelClient.close();
    }
}
```

### åˆ›å»ºç´¢å¼•åº“

```java
@Test
void createHotelIndex() throws IOException {
    //æŒ‡å®šç´¢å¼•åº“å
    CreateIndexRequest hotel = new CreateIndexRequest("hotel");
    //å†™å…¥JSONæ•°æ®ï¼Œè¿™é‡Œæ˜¯Mappingæ˜ å°„
    hotel.source(HotelConstants.MAPPING_TEMPLATE, XContentType.JSON);
    //åˆ›å»ºç´¢å¼•åº“
    restHighLevelClient.indices().create(hotel, RequestOptions.DEFAULT);
}
```

```java
public class HotelConstants {
    public static String MAPPING_TEMPLATE = "{\n" +
            "  \"mappings\": {\n" +
            "    \"properties\": {\n" +
            "      \"id\": {\n" +
            "        \"type\": \"keyword\"\n" +
            "      },\n" +
            "      \"name\":{\n" +
            "        \"type\": \"text\",\n" +
            "        \"analyzer\": \"ik_max_word\",\n" +
            "        \"copy_to\": \"all\"\n" +
            "      },\n" +
            "      \"address\":{\n" +
            "        \"type\": \"keyword\",\n" +
            "        \"index\": false\n" +
            "      },\n" +
            "      \"price\":{\n" +
            "        \"type\": \"integer\"\n" +
            "      },\n" +
            "      \"score\":{\n" +
            "        \"type\": \"integer\"\n" +
            "      },\n" +
            "      \"brand\":{\n" +
            "        \"type\": \"keyword\",\n" +
            "        \"copy_to\": \"all\"\n" +
            "      },\n" +
            "      \"city\":{\n" +
            "        \"type\": \"keyword\",\n" +
            "        \"copy_to\": \"all\"\n" +
            "      },\n" +
            "      \"starName\":{\n" +
            "        \"type\": \"keyword\"\n" +
            "      },\n" +
            "      \"business\":{\n" +
            "        \"type\": \"keyword\"\n" +
            "      },\n" +
            "      \"location\":{\n" +
            "        \"type\": \"geo_point\"\n" +
            "      },\n" +
            "      \"pic\":{\n" +
            "        \"type\": \"keyword\",\n" +
            "        \"index\": false\n" +
            "      },\n" +
            "      \"all\":{\n" +
            "        \"type\": \"text\",\n" +
            "        \"analyzer\": \"ik_max_word\"\n" +
            "      }\n" +
            "    }\n" +
            "  }\n" +
            "}";
}
```

### åˆ é™¤ç´¢å¼•åº“

```java
@Test
void deleteHotelIndex() throws IOException {
    DeleteIndexRequest hotel = new DeleteIndexRequest("hotel");
    restHighLevelClient.indices().delete(hotel,RequestOptions.DEFAULT);
}
```

### åˆ¤æ–­ç´¢å¼•åº“

```java
@Test
void existHotelIndex() throws IOException {
    GetIndexRequest hotel = new GetIndexRequest("hotel");
    boolean exists = restHighLevelClient.indices().exists(hotel, RequestOptions.DEFAULT);
    System.out.println(exists);
}
```

### æ–°å¢æ–‡æ¡£

```java
/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/9/19 17:18
 */
@SpringBootTest
public class HotelDocumentTest {

    private RestHighLevelClient restHighLevelClient;

    @Autowired
    private IHotelService hotelService;

    @Test
    void testInit(){
        System.out.println(this.restHighLevelClient);
    }

    @Test
    void createHotelIndex() throws IOException {
        Hotel hotel = hotelService.getById(61083L);
        HotelDoc hotelDoc = new HotelDoc(hotel);
        // 1.å‡†å¤‡Requestå¯¹è±¡
        IndexRequest hotelIndex = new IndexRequest("hotel").id(hotelDoc.getId().toString());
        // 2.å‡†å¤‡Jsonæ–‡æ¡£
        hotelIndex.source(JSON.toJSONString(hotelDoc), XContentType.JSON);
        // 3.å‘é€è¯·æ±‚
        restHighLevelClient.index(hotelIndex, RequestOptions.DEFAULT);
    }

    @BeforeEach
    void init(){
        this.restHighLevelClient = new RestHighLevelClient(RestClient.builder(
                HttpHost.create("http://192.168.211.128:9200")
        ));
    }

    @AfterEach
    void down() throws IOException {
        this.restHighLevelClient.close();
    }
}
```

### æŸ¥è¯¢æ–‡æ¡£

```java
@Test
void testGetDocumentById() throws IOException {
    // 1.å‡†å¤‡Request
    GetRequest hotel = new GetRequest("hotel", "61083");
    // 2.å‘é€è¯·æ±‚ï¼Œå¾—åˆ°å“åº”
    GetResponse hotelResponse = restHighLevelClient.get(hotel, RequestOptions.DEFAULT);
    // 3.è§£æå“åº”ç»“æœ
    String hotelDocSourceAsString = hotelResponse.getSourceAsString();
    // 4.jsonè½¬å®ä½“ç±»
    HotelDoc hotelDoc = JSON.parseObject(hotelDocSourceAsString, HotelDoc.class);
    System.out.println(hotelDoc);
}
```

### åˆ é™¤æ–‡æ¡£

```java
@Test
void testDeleteDocumentById() throws IOException {
    DeleteRequest hotel = new DeleteRequest("hotel", "61083");
    restHighLevelClient.delete(hotel,RequestOptions.DEFAULT);
}
```

### ä¿®æ”¹æ–‡æ¡£

å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œä¿®æ”¹æ–‡æ¡£æœ‰ä¸¤ç§æ–¹å¼ï¼š

- å…¨é‡ä¿®æ”¹ï¼šç›´æ¥è¦†ç›–åŸæ¥çš„æ–‡æ¡£
- å¢é‡ä¿®æ”¹ï¼šä¿®æ”¹æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ

åœ¨ RestClient çš„ API ä¸­ï¼Œå…¨é‡ä¿®æ”¹ä¸æ–°å¢çš„ API å®Œå…¨ä¸€è‡´ï¼Œåˆ¤æ–­ä¾æ®æ˜¯ ID

- å¦‚æœæ–°å¢æ—¶ï¼ŒIDå·²ç»å­˜åœ¨ï¼Œåˆ™ä¿®æ”¹
- å¦‚æœæ–°å¢æ—¶ï¼ŒIDä¸å­˜åœ¨ï¼Œåˆ™æ–°å¢

æ‰€ä»¥å…¨é‡ä¿®æ”¹å†™æ³•ä¸æ–°å¢æ–‡æ¡£ä¸€æ ·ï¼Œä¸‹é¢æˆ‘ä»¬ä¸»è¦æ˜¯ä»‹ç»å¢é‡ä¿®æ”¹ã€‚

```java
@Test
void testUpdateDocument() throws IOException {
    // 1.å‡†å¤‡Request
    UpdateRequest request = new UpdateRequest("hotel", "61083");
    // 2.å‡†å¤‡è¯·æ±‚å‚æ•°
    request.doc(
        "price", "952",
        "starName", "å››é’»"
    );
    // 3.å‘é€è¯·æ±‚
    restHighLevelClient.update(request, RequestOptions.DEFAULT);
}
```

### æ‰¹é‡å¯¼å…¥æ–‡æ¡£

æ¡ˆä¾‹éœ€æ±‚ï¼šåˆ©ç”¨ `BulkRequest` æ‰¹é‡å°†æ•°æ®åº“æ•°æ®å¯¼å…¥åˆ°ç´¢å¼•åº“ä¸­ã€‚

- åˆ©ç”¨ mybatis-plus æŸ¥è¯¢é…’åº—æ•°æ®

- å°†æŸ¥è¯¢åˆ°çš„é…’åº—æ•°æ®ï¼ˆHotelï¼‰è½¬æ¢ä¸ºæ–‡æ¡£ç±»å‹æ•°æ®ï¼ˆHotelDocï¼‰

- åˆ©ç”¨ JavaRestClient ä¸­çš„ BulkRequest æ‰¹å¤„ç†ï¼Œå®ç°æ‰¹é‡æ–°å¢æ–‡æ¡£

æ‰¹é‡å¤„ç† BulkRequestï¼Œå…¶æœ¬è´¨å°±æ˜¯å°†å¤šä¸ªæ™®é€šçš„ CRUD è¯·æ±‚ç»„åˆåœ¨ä¸€èµ·å‘é€ã€‚

å› æ­¤Bulkä¸­æ·»åŠ äº†å¤šä¸ªIndexRequestï¼Œå°±æ˜¯æ‰¹é‡æ–°å¢åŠŸèƒ½äº†ã€‚ç¤ºä¾‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210919234350.png)

åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºè‡ªå·±éœ€è¦çš„ä»£ç ï¼Œå¦‚ä¸‹

```java
@Test
void testBulk() throws IOException {
    BulkRequest bulkRequest = new BulkRequest();
    List<Hotel> hotelList = hotelService.list();
    hotelList.forEach(item -> {
        HotelDoc hotelDoc = new HotelDoc(item);
        bulkRequest.add(new IndexRequest("hotel")
                .id(hotelDoc.getId().toString())
                .source(JSON.toJSONString(hotelDoc), XContentType.JSON));
    });
    restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);
}
```

---

æ€»ä¹‹ï¼Œåœ¨ Java ä»£ç ä¸­ï¼Œclient é’ˆå¯¹æ“ä½œç´¢å¼•åº“è¿˜æ˜¯æ–‡æ¡£ï¼ŒåŸºæœ¬éƒ½æ˜¯ä¸€æ ·çš„ä»£ç 

restHighLevelClient.indices().xxxï¼Œä»£è¡¨æ“ä½œç´¢å¼•åº“

restHighLevelClient.xxxï¼Œä»£è¡¨æ“ä½œæ–‡æ¡£

è€Œå…¶ä¸­æ‰€éœ€è¦çš„å‚æ•°ï¼Œæˆ‘ä»¬ç›´æ¥é€šè¿‡ **ctrl+p** è¿™æ ·çš„å¿«æ·é”®å»æŸ¥çœ‹å°±å¯ä»¥ï¼Œä¸éœ€è¦å•ç‹¬è®°ä½ã€‚

## DSLæ–‡æ¡£æŸ¥è¯¢

Elasticsearch æä¾›äº†åŸºäº JSON çš„ DSL([Domain Specific Language](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html))æ¥å®šä¹‰æŸ¥è¯¢ã€‚å¸¸è§çš„æŸ¥è¯¢ç±»å‹åŒ…æ‹¬ï¼š

**æŸ¥è¯¢æ‰€æœ‰**ï¼šæŸ¥è¯¢å‡ºæ‰€æœ‰æ•°æ®ï¼Œä¸€èˆ¬æµ‹è¯•ç”¨ã€‚ä¾‹å¦‚ï¼šmatch_all

**å…¨æ–‡æ£€ç´¢ï¼ˆfull textï¼‰æŸ¥è¯¢**ï¼šåˆ©ç”¨åˆ†è¯å™¨å¯¹ç”¨æˆ·è¾“å…¥å†…å®¹åˆ†è¯ï¼Œç„¶åå»å€’æ’ç´¢å¼•åº“ä¸­åŒ¹é…ã€‚ä¾‹å¦‚ï¼š

- match_query
- multi_match_query

**ç²¾ç¡®æŸ¥è¯¢**ï¼šæ ¹æ®ç²¾ç¡®è¯æ¡å€¼æŸ¥æ‰¾æ•°æ®ï¼Œä¸€èˆ¬æ˜¯æŸ¥æ‰¾ keywordã€æ•°å€¼ã€æ—¥æœŸã€boolean ç­‰ç±»å‹å­—æ®µã€‚ä¾‹å¦‚ï¼š

- ids
- range
- term

**åœ°ç†ï¼ˆgeoï¼‰æŸ¥è¯¢**ï¼šæ ¹æ®ç»çº¬åº¦æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š

- geo_distance
- geo_bounding_box

**å¤åˆï¼ˆcompoundï¼‰æŸ¥è¯¢**ï¼šå¤åˆæŸ¥è¯¢å¯ä»¥å°†ä¸Šè¿°å„ç§æŸ¥è¯¢æ¡ä»¶ç»„åˆèµ·æ¥ï¼Œåˆå¹¶æŸ¥è¯¢æ¡ä»¶ã€‚ä¾‹å¦‚ï¼š

- bool
- function_score

---

```json
// æŸ¥è¯¢æ‰€æœ‰
GET /indexName/_search
{
  "query": {
    "match_all": {
    }
  }
}
```

### å…¨æ–‡æ£€ç´¢

ä½¿ç”¨åœºæ™¯ï¼šå…¨æ–‡æ£€ç´¢æŸ¥è¯¢çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

- å¯¹ç”¨æˆ·æœç´¢çš„å†…å®¹åšåˆ†è¯ï¼Œå¾—åˆ°è¯æ¡
- æ ¹æ®è¯æ¡å»å€’æ’ç´¢å¼•åº“ä¸­åŒ¹é…ï¼Œå¾—åˆ°æ–‡æ¡£id
- æ ¹æ®æ–‡æ¡£idæ‰¾åˆ°æ–‡æ¡£ï¼Œè¿”å›ç»™ç”¨æˆ·

æ¯”è¾ƒå¸¸ç”¨çš„åœºæ™¯åŒ…æ‹¬ï¼š

- å•†åŸçš„è¾“å…¥æ¡†æœç´¢
- ç™¾åº¦è¾“å…¥æ¡†æœç´¢

ä¾‹å¦‚äº¬ä¸œï¼š

![](C:\Users\54656\Desktop\SpringCloud\å®ç”¨ç¯‡\day01-SpringCloud01\èµ„æ–™\å¾®æœåŠ¡æŠ€æœ¯æ ˆ.assets\image-20210721165326938.png)

å› ä¸ºæ˜¯æ‹¿ç€è¯æ¡å»åŒ¹é…ï¼Œå› æ­¤å‚ä¸æœç´¢çš„å­—æ®µä¹Ÿå¿…é¡»æ˜¯å¯åˆ†è¯çš„textç±»å‹çš„å­—æ®µã€‚

å¸¸è§çš„å…¨æ–‡æ£€ç´¢æŸ¥è¯¢åŒ…æ‹¬ï¼š

- match æŸ¥è¯¢ï¼šå•å­—æ®µæŸ¥è¯¢
- multi_match æŸ¥è¯¢ï¼šå¤šå­—æ®µæŸ¥è¯¢ï¼Œä»»æ„ä¸€ä¸ªå­—æ®µç¬¦åˆæ¡ä»¶å°±ç®—ç¬¦åˆæŸ¥è¯¢æ¡ä»¶

match æŸ¥è¯¢è¯­æ³•å¦‚ä¸‹ï¼š

```json
GET /indexName/_search
{
  "query": {
    "match": {
      "FIELD": "TEXT"
    }
  }
}
```

mulit_match æŸ¥è¯¢è¯­æ³•å¦‚ä¸‹ï¼š

```json
GET /indexName/_search
{
  "query": {
    "multi_match": {
      "query": "TEXT",
      "fields": ["FIELD1", " FIELD12"]
    }
  }
}
```

å› ä¸ºæˆ‘ä»¬å°† brandã€nameã€business å€¼éƒ½åˆ©ç”¨ **copy_to** å¤åˆ¶åˆ°äº† **all** å­—æ®µä¸­ï¼Œä½ æ ¹æ®ä¸‰ä¸ªå­—æ®µæœç´¢ï¼Œå’Œæ ¹æ® allå­—æ®µæœç´¢æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚

```json
GET /hotel/_search
{
  "query": {
    "match": {
      "all": "7å¤©é…’åº—"
    }
  }
}
```

```json
GET /hotel/_search
{
  "query": {
    "multi_match": {
      "query": "7å¤©é…’åº—",
      "fields": ["brand","name"]
    }
  }
}
```

**æœç´¢å­—æ®µè¶Šå¤šï¼Œå¯¹æŸ¥è¯¢æ€§èƒ½å½±å“è¶Šå¤§ï¼Œå› æ­¤å»ºè®®é‡‡ç”¨ copy_to å°†å¤šä¸ªå­—æ®µåˆå¹¶ä¸ºä¸€ä¸ªï¼Œç„¶åä½¿ç”¨å•å­—æ®µæŸ¥è¯¢çš„æ–¹å¼ã€‚**

### ç²¾å‡†æŸ¥è¯¢

ç²¾ç¡®æŸ¥è¯¢ä¸€èˆ¬æ˜¯æŸ¥æ‰¾ keywordã€æ•°å€¼ã€æ—¥æœŸã€boolean ç­‰ç±»å‹å­—æ®µã€‚æ‰€ä»¥**ä¸ä¼š**å¯¹æœç´¢æ¡ä»¶åˆ†è¯ã€‚

- termï¼šæ ¹æ®è¯æ¡ç²¾ç¡®å€¼æŸ¥è¯¢
- rangeï¼šæ ¹æ®å€¼çš„èŒƒå›´æŸ¥è¯¢

#### termæŸ¥è¯¢

å› ä¸ºç²¾ç¡®æŸ¥è¯¢çš„å­—æ®µæœæ˜¯ä¸åˆ†è¯çš„å­—æ®µï¼Œå› æ­¤æŸ¥è¯¢çš„æ¡ä»¶ä¹Ÿå¿…é¡»æ˜¯**ä¸åˆ†è¯**çš„è¯æ¡ã€‚æŸ¥è¯¢æ—¶ï¼Œç”¨æˆ·è¾“å…¥çš„å†…å®¹è·Ÿè‡ªåŠ¨å€¼å®Œå…¨åŒ¹é…æ—¶æ‰è®¤ä¸ºç¬¦åˆæ¡ä»¶ã€‚å¦‚æœç”¨æˆ·è¾“å…¥çš„å†…å®¹è¿‡å¤šï¼Œåè€Œæœç´¢ä¸åˆ°æ•°æ®ã€‚

è¯­æ³•è¯´æ˜ï¼š

```json
// termæŸ¥è¯¢
GET /indexName/_search
{
  "query": {
    "term": {
      "FIELD": {
        "value": "VALUE"
      }
    }
  }
}
```

ç¤ºä¾‹ï¼š

```json
GET /hotel/_search
{
  "query": {
    "term": {
      "brand": {
        "value": "7å¤©é…’åº—"
      }
    }
  }
}
```

#### rangeæŸ¥è¯¢

èŒƒå›´æŸ¥è¯¢ï¼Œä¸€èˆ¬åº”ç”¨åœ¨å¯¹æ•°å€¼ç±»å‹åšèŒƒå›´è¿‡æ»¤çš„æ—¶å€™ã€‚æ¯”å¦‚åšä»·æ ¼èŒƒå›´è¿‡æ»¤ã€‚

åŸºæœ¬è¯­æ³•ï¼š

```json
// rangeæŸ¥è¯¢
GET /indexName/_search
{
  "query": {
    "range": {
      "FIELD": {
        "gte": 10, // è¿™é‡Œçš„gteä»£è¡¨å¤§äºç­‰äºï¼Œgtåˆ™ä»£è¡¨å¤§äº
        "lte": 20 // lteä»£è¡¨å°äºç­‰äºï¼Œltåˆ™ä»£è¡¨å°äº
      }
    }
  }
}
```

ç¤ºä¾‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210921182858.png)

ç²¾ç¡®æŸ¥è¯¢å¸¸è§çš„æœ‰å“ªäº›ï¼Ÿ

- term æŸ¥è¯¢ï¼šæ ¹æ®è¯æ¡ç²¾ç¡®åŒ¹é…ï¼Œä¸€èˆ¬æœç´¢ keyword ç±»å‹ã€æ•°å€¼ç±»å‹ã€å¸ƒå°”ç±»å‹ã€æ—¥æœŸç±»å‹å­—æ®µ
- range æŸ¥è¯¢ï¼šæ ¹æ®æ•°å€¼èŒƒå›´æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯æ•°å€¼ã€æ—¥æœŸçš„èŒƒå›´

### åœ°ç†åæ ‡æŸ¥è¯¢

åœ°ç†åæ ‡æŸ¥è¯¢ï¼Œå…¶å®å°±æ˜¯æ ¹æ®ç»çº¬åº¦æŸ¥è¯¢ï¼Œå®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html

å¸¸è§çš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š

- æºç¨‹ï¼šæœç´¢æˆ‘é™„è¿‘çš„é…’åº—
- æ»´æ»´ï¼šæœç´¢æˆ‘é™„è¿‘çš„å‡ºç§Ÿè½¦
- å¾®ä¿¡ï¼šæœç´¢æˆ‘é™„è¿‘çš„äºº

é™„è¿‘çš„é…’åº—ï¼š

![](https://cdn.xn2001.com/img/2021/20210921183030.png) 

é™„è¿‘çš„è½¦ï¼š

![](https://cdn.xn2001.com/img/2021/20210921183033.png) 

> çŸ©å½¢èŒƒå›´æŸ¥è¯¢

çŸ©å½¢èŒƒå›´æŸ¥è¯¢ï¼Œä¹Ÿå°±æ˜¯ `geo_bounding_box` æŸ¥è¯¢ï¼ŒæŸ¥è¯¢åæ ‡è½åœ¨æŸä¸ªçŸ©å½¢èŒƒå›´çš„æ‰€æœ‰æ–‡æ¡£

![](https://cdn.xn2001.com/img/2021/20210921183124.gif)

æŸ¥è¯¢æ—¶ï¼Œéœ€è¦æŒ‡å®šçŸ©å½¢çš„**å·¦ä¸Š**ã€**å³ä¸‹**ä¸¤ä¸ªç‚¹çš„åæ ‡ï¼Œç„¶åç”»å‡ºä¸€ä¸ªçŸ©å½¢ï¼Œè½åœ¨è¯¥çŸ©å½¢å†…çš„éƒ½æ˜¯ç¬¦åˆæ¡ä»¶çš„ç‚¹ã€‚

```json
// geo_bounding_boxæŸ¥è¯¢
GET /indexName/_search
{
  "query": {
    "geo_bounding_box": {
      "FIELD": {
        "top_left": { // å·¦ä¸Šç‚¹
          "lat": 31.1,
          "lon": 121.5
        },
        "bottom_right": { // å³ä¸‹ç‚¹
          "lat": 30.9,
          "lon": 121.7
        }
      }
    }
  }
}
```

> é™„è¿‘æŸ¥è¯¢

é™„è¿‘æŸ¥è¯¢ï¼Œä¹Ÿå«åšè·ç¦»æŸ¥è¯¢ï¼ˆgeo_distanceï¼‰ï¼šæŸ¥è¯¢åˆ°æŒ‡å®šä¸­å¿ƒç‚¹å°äºæŸä¸ªè·ç¦»å€¼çš„æ‰€æœ‰æ–‡æ¡£

åœ¨åœ°å›¾ä¸Šæ‰¾ä¸€ä¸ªç‚¹ä½œä¸ºåœ†å¿ƒï¼Œä»¥æŒ‡å®šè·ç¦»ä¸ºåŠå¾„ï¼Œç”»ä¸€ä¸ªåœ†ï¼Œè½åœ¨åœ†å†…çš„åæ ‡éƒ½ç®—ç¬¦åˆæ¡ä»¶ï¼š

![](https://cdn.xn2001.com/img/2021/20210921183215.gif)

```json
// geo_distance æŸ¥è¯¢
GET /indexName/_search
{
  "query": {
    "geo_distance": {
      "distance": "15km", // åŠå¾„
      "FIELD": "31.21,121.5" // åœ†å¿ƒ
    }
  }
}
```

æˆ‘ä»¬å…ˆæœç´¢é™†å®¶å˜´é™„è¿‘15kmçš„é…’åº—

![](https://cdn.xn2001.com/img/2021/20210921183228.png)

å‘ç°å…±æœ‰47å®¶é…’åº—ï¼Œç„¶åæŠŠåŠå¾„ç¼©çŸ­åˆ°3å…¬é‡Œ

![](https://cdn.xn2001.com/img/2021/20210921183240.png)

å¯ä»¥å‘ç°ï¼Œæœç´¢åˆ°çš„é…’åº—æ•°é‡å‡å°‘åˆ°äº†5å®¶ã€‚

```json
GET /hotel/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "_geo_distance" : {
          "location": "31.034661,121.612282", //åœ†å¿ƒ
          "order" : "asc", //æ’åº
          "unit" : "km" //å•ä½
      }
    }
  ]
}
```

ç»“æœä¸ºï¼š

```json
"hits" : [
    {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "2056298828",
        "_score" : null,
        "_source" : {
            ...
        },
        "sort" : [
            4.8541199685347785 //è¿™é‡Œçš„ç»“æœä¸ºç¦»åœ†å¿ƒçš„è·ç¦»
        ]
    },
```

æ³¨æ„ï¼šè¾“å‡ºç»“æœä¸­çš„ **sort** ä¸ºè·ç¦»ï¼Œæ¯”è¾ƒå¸¸ç”¨ã€‚

æ’åºå®Œæˆåï¼Œé¡µé¢è¿˜è¦è·å–æˆ‘é™„è¿‘æ¯ä¸ªé…’åº—çš„å…·ä½“**è·ç¦»**å€¼ï¼Œè¿™ä¸ªå€¼åœ¨å“åº”ç»“æœä¸­æ˜¯ç‹¬ç«‹çš„ï¼š

![](https://cdn.xn2001.com/img/2021/20211019011334.png)

### å¤åˆæŸ¥è¯¢

å¤åˆï¼ˆcompoundï¼‰æŸ¥è¯¢ï¼šå¤åˆæŸ¥è¯¢å¯ä»¥å°†å…¶å®ƒç®€å•æŸ¥è¯¢ç»„åˆèµ·æ¥ï¼Œå®ç°æ›´å¤æ‚çš„æœç´¢é€»è¾‘ã€‚

- fuction scoreï¼šç®—åˆ†å‡½æ•°æŸ¥è¯¢ï¼Œå¯ä»¥æ§åˆ¶æ–‡æ¡£ç›¸å…³æ€§ç®—åˆ†ï¼Œæ§åˆ¶æ–‡æ¡£æ’å
- bool queryï¼šå¸ƒå°”æŸ¥è¯¢ï¼Œåˆ©ç”¨é€»è¾‘å…³ç³»ç»„åˆå¤šä¸ªå…¶å®ƒçš„æŸ¥è¯¢ï¼Œå®ç°å¤æ‚æœç´¢

### ç›¸å…³æ€§ç®—åˆ†

> è¿™éƒ¨åˆ†å†…å®¹ä½œä¸ºäº†è§£å³å¯ã€‚

å½“æˆ‘ä»¬åˆ©ç”¨ match æŸ¥è¯¢æ—¶ï¼Œæ–‡æ¡£ç»“æœä¼šæ ¹æ®ä¸æœç´¢è¯æ¡çš„å…³è”åº¦æ‰“åˆ†ï¼ˆ_scoreï¼‰ï¼Œè¿”å›ç»“æœæ—¶æŒ‰ç…§åˆ†å€¼é™åºæ’åˆ—ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœç´¢ "è™¹æ¡¥å¦‚å®¶"ï¼Œç»“æœå¦‚ä¸‹ï¼š

```json
[
  {
    "_score" : 17.850193,
    "_source" : {
      "name" : "è™¹æ¡¥å¦‚å®¶é…’åº—çœŸä¸é”™",
    }
  },
  {
    "_score" : 12.259849,
    "_source" : {
      "name" : "å¤–æ»©å¦‚å®¶é…’åº—çœŸä¸é”™",
    }
  },
  {
    "_score" : 11.91091,
    "_source" : {
      "name" : "è¿ªå£«å°¼å¦‚å®¶é…’åº—çœŸä¸é”™",
    }
  }
]
```

elasticsearch æ—©æœŸä½¿ç”¨çš„æ‰“åˆ†ç®—æ³•æ˜¯ **TF-IDF ç®—æ³•**ï¼Œå…¬å¼å¦‚ä¸‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210921205752.png)

åœ¨åæ¥çš„5.1ç‰ˆæœ¬å‡çº§ä¸­ï¼Œelasticsearch å°†ç®—æ³•æ”¹è¿›ä¸º **BM25 ç®—æ³•**ï¼Œå…¬å¼å¦‚ä¸‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210921205757.png)

TF-IDF ç®—æ³•æœ‰ä¸€å„ç¼ºé™·ï¼Œå°±æ˜¯è¯æ¡é¢‘ç‡è¶Šé«˜ï¼Œæ–‡æ¡£å¾—åˆ†ä¹Ÿä¼šè¶Šé«˜ï¼Œå•ä¸ªè¯æ¡å¯¹æ–‡æ¡£å½±å“è¾ƒå¤§ã€‚è€Œ BM25 åˆ™ä¼šè®©å•ä¸ªè¯æ¡çš„ç®—åˆ†æœ‰ä¸€ä¸ªä¸Šé™ï¼Œæ›²çº¿æ›´åŠ å¹³æ»‘ï¼š

![](https://cdn.xn2001.com/img/2021/20210921205831.png)

### ç®—åˆ†å‡½æ•°æŸ¥è¯¢

æ ¹æ®ç›¸å…³åº¦æ‰“åˆ†æ˜¯æ¯”è¾ƒåˆç†çš„éœ€æ±‚ï¼Œä½†æœ‰æ—¶å€™ä¹Ÿä¸èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚

ä»¥ç™¾åº¦ä¸ºä¾‹ï¼Œä½ æœç´¢çš„ç»“æœä¸­ï¼Œå¹¶ä¸æ˜¯ç›¸å…³åº¦è¶Šé«˜æ’åè¶Šé å‰ï¼Œè€Œæ˜¯è°ç»™çš„é’±å¤šæ’åå°±è¶Šé å‰ã€‚

**è¦æƒ³è®¤ä¸ºæ§åˆ¶ç›¸å…³æ€§ç®—åˆ†ï¼Œå°±éœ€è¦åˆ©ç”¨ elasticsearch ä¸­çš„ function score æŸ¥è¯¢äº†ã€‚**

![](https://cdn.xn2001.com/img/2021/20210921210256.png)

function score æŸ¥è¯¢ä¸­åŒ…å«å››éƒ¨åˆ†å†…å®¹ï¼š

- **åŸå§‹æŸ¥è¯¢**æ¡ä»¶ï¼šquery éƒ¨åˆ†ï¼ŒåŸºäºè¿™ä¸ªæ¡ä»¶æœç´¢æ–‡æ¡£ï¼Œå¹¶ä¸”åŸºäºBM25ç®—æ³•ç»™æ–‡æ¡£æ‰“åˆ†ï¼Œ**åŸå§‹ç®—åˆ†**ï¼ˆquery score)
- **è¿‡æ»¤æ¡ä»¶**ï¼šfilter éƒ¨åˆ†ï¼Œç¬¦åˆè¯¥æ¡ä»¶çš„æ–‡æ¡£æ‰ä¼š**é‡æ–°ç®—åˆ†**
- **ç®—åˆ†å‡½æ•°**ï¼šç¬¦åˆ filter æ¡ä»¶çš„æ–‡æ¡£è¦æ ¹æ®è¿™ä¸ªå‡½æ•°åšè¿ç®—ï¼Œå¾—åˆ°çš„**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰ï¼Œæœ‰å››ç§å‡½æ•°
  - weightï¼šå‡½æ•°ç»“æœæ˜¯å¸¸é‡
  - field_value_factorï¼šä»¥æ–‡æ¡£ä¸­çš„æŸä¸ªå­—æ®µå€¼ä½œä¸ºå‡½æ•°ç»“æœ
  - random_scoreï¼šä»¥éšæœºæ•°ä½œä¸ºå‡½æ•°ç»“æœ
  - script_scoreï¼šè‡ªå®šä¹‰ç®—åˆ†å‡½æ•°ç®—æ³•
- **è¿ç®—æ¨¡å¼**ï¼šç®—åˆ†å‡½æ•°çš„ç»“æœã€åŸå§‹æŸ¥è¯¢çš„ç›¸å…³æ€§ç®—åˆ†ï¼Œä¸¤è€…ä¹‹é—´çš„è¿ç®—æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼š
  - multiplyï¼šç›¸ä¹˜
  - replaceï¼šç”¨ function score æ›¿æ¢ query score
  - sumã€avgã€maxã€min

function score çš„è¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1. æ ¹æ®**åŸå§‹æ¡ä»¶**æŸ¥è¯¢æœç´¢æ–‡æ¡£ï¼Œå¹¶ä¸”è®¡ç®—ç›¸å…³æ€§ç®—åˆ†ï¼Œç§°ä¸º**åŸå§‹ç®—åˆ†**ï¼ˆquery scoreï¼‰
2. æ ¹æ®**è¿‡æ»¤æ¡ä»¶**ï¼Œè¿‡æ»¤æ–‡æ¡£
3. ç¬¦åˆ**è¿‡æ»¤æ¡ä»¶**çš„æ–‡æ¡£ï¼ŒåŸºäº**ç®—åˆ†å‡½æ•°**è¿ç®—ï¼Œå¾—åˆ°**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰
4. å°†**åŸå§‹ç®—åˆ†**ï¼ˆquery scoreï¼‰å’Œ**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰åŸºäº**è¿ç®—æ¨¡å¼**åšè¿ç®—ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœï¼Œä½œä¸ºç›¸å…³æ€§ç®—åˆ†ã€‚

å› æ­¤ï¼Œå…¶ä¸­çš„å…³é”®ç‚¹æ˜¯

- è¿‡æ»¤æ¡ä»¶ï¼šå†³å®šå“ªäº›æ–‡æ¡£çš„ç®—åˆ†è¢«ä¿®æ”¹
- ç®—åˆ†å‡½æ•°ï¼šå†³å®šå‡½æ•°ç®—åˆ†çš„ç®—æ³•
- è¿ç®—æ¨¡å¼ï¼šå†³å®šæœ€ç»ˆç®—åˆ†ç»“æœ

ä¾‹å¦‚ï¼šæˆ‘ä»¬ç»™â€œå¦‚å®¶â€è¿™ä¸ªå“ç‰Œçš„é…’åº—æ’åé å‰ä¸€äº›

```json
GET /hotel/_search
{
  "query": {
    "function_score": {
      "query": {  .... }, // åŸå§‹æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯ä»»æ„æ¡ä»¶
      "functions": [ // ç®—åˆ†å‡½æ•°
        {
          "filter": { // æ»¡è¶³çš„æ¡ä»¶ï¼Œå“ç‰Œå¿…é¡»æ˜¯å¦‚å®¶
            "term": {
              "brand": "å¦‚å®¶"
            }
          },
          "weight": 10 // ç®—åˆ†æƒé‡ä¸º10
        }
      ],
      "boost_mode": "sum" // åŠ æƒæ¨¡å¼ï¼Œæ±‚å’Œ
    }
  }
}
```

æµ‹è¯•ï¼Œåœ¨æœªæ·»åŠ ç®—åˆ†å‡½æ•°æ—¶ï¼Œå¦‚å®¶å¾—åˆ†å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20210921231508.png)

æ·»åŠ äº†ç®—åˆ†å‡½æ•°åï¼Œå¦‚å®¶å¾—åˆ†å°±æå‡äº†

![](https://cdn.xn2001.com/img/2021/20210921231513.png)

### å¸ƒå°”æŸ¥è¯¢

å¸ƒå°”æŸ¥è¯¢æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæŸ¥è¯¢å­å¥çš„ç»„åˆï¼Œæ¯ä¸€ä¸ªå­å¥å°±æ˜¯ä¸€ä¸ª**å­æŸ¥è¯¢**ã€‚å­æŸ¥è¯¢çš„ç»„åˆæ–¹å¼æœ‰

- mustï¼šå¿…é¡»åŒ¹é…æ¯ä¸ªå­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œä¸â€
- shouldï¼šé€‰æ‹©æ€§åŒ¹é…å­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œæˆ–â€
- must_notï¼šå¿…é¡»ä¸åŒ¹é…ï¼Œ**ä¸å‚ä¸ç®—åˆ†**ï¼Œç±»ä¼¼â€œéâ€
- filterï¼šå¿…é¡»åŒ¹é…ï¼Œ**ä¸å‚ä¸ç®—åˆ†**

æ¯”å¦‚åœ¨æœç´¢é…’åº—æ—¶ï¼Œé™¤äº†å…³é”®å­—æœç´¢å¤–ï¼Œæˆ‘ä»¬è¿˜å¯èƒ½æ ¹æ®å“ç‰Œã€ä»·æ ¼ã€åŸå¸‚ç­‰å­—æ®µåšè¿‡æ»¤

**æ¯ä¸€ä¸ªä¸åŒçš„å­—æ®µï¼Œå…¶æŸ¥è¯¢çš„æ¡ä»¶ã€æ–¹å¼éƒ½ä¸ä¸€æ ·ï¼Œå¿…é¡»æ˜¯å¤šä¸ªä¸åŒçš„æŸ¥è¯¢ï¼Œè€Œè¦ç»„åˆè¿™äº›æŸ¥è¯¢ï¼Œå°±å¿…é¡»ç”¨ boolæŸ¥è¯¢äº†ã€‚**

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœç´¢æ—¶ï¼Œå‚ä¸**æ‰“åˆ†çš„å­—æ®µè¶Šå¤šï¼ŒæŸ¥è¯¢çš„æ€§èƒ½ä¹Ÿè¶Šå·®**ã€‚å› æ­¤è¿™ç§å¤šæ¡ä»¶æŸ¥è¯¢æ—¶ï¼Œå»ºè®®è¿™æ ·åšï¼š

- æœç´¢æ¡†çš„å…³é”®å­—æœç´¢ï¼Œæ˜¯å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œä½¿ç”¨ must æŸ¥è¯¢ï¼Œå‚ä¸ç®—åˆ†
- å…¶å®ƒè¿‡æ»¤æ¡ä»¶ï¼Œé‡‡ç”¨ filter æŸ¥è¯¢ï¼Œä¸å‚ä¸ç®—åˆ†

```json
GET /hotel/_search
{
  "query": {
    "bool": {
      "must": [
        {"term": {"city": "ä¸Šæµ·" }}
      ],
      "should": [
        {"term": {"brand": "çš‡å† å‡æ—¥" }},
        {"term": {"brand": "åç¾è¾¾" }}
      ],
      "must_not": [
        { "range": { "price": { "lte": 500 } }}
      ],
      "filter": [
        { "range": {"score": { "gte": 45 } }}
      ]
    }
  }
}
```

éœ€æ±‚ï¼šæœç´¢åå­—åŒ…å«â€œå¦‚å®¶â€ï¼Œä»·æ ¼ä¸é«˜äº 400ï¼Œåœ¨åæ ‡ 31.21,121.5 å‘¨å›´ 10km èŒƒå›´å†…çš„é…’åº—ã€‚

- åç§°æœç´¢ï¼Œå±äºå…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œåº”è¯¥å‚ä¸ç®—åˆ†ï¼Œæ”¾åˆ° must ä¸­
- ä»·æ ¼ä¸é«˜äº 400ï¼Œç”¨ range æŸ¥è¯¢ï¼Œå±äºè¿‡æ»¤æ¡ä»¶ï¼Œä¸å‚ä¸ç®—åˆ†ï¼Œæ”¾åˆ° must_not ä¸­
- å‘¨å›´ 10km èŒƒå›´å†…ï¼Œç”¨ geo_distance æŸ¥è¯¢ï¼Œå±äºè¿‡æ»¤æ¡ä»¶ï¼Œä¸å‚ä¸ç®—åˆ†ï¼Œæ”¾åˆ° filter ä¸­

![](https://cdn.xn2001.com/img/2021/20210921233252.png)

bool æŸ¥è¯¢çš„å‡ ç§é€»è¾‘å…³ç³»

- mustï¼šå¿…é¡»åŒ¹é…çš„æ¡ä»¶ï¼Œå¯ä»¥ç†è§£ä¸ºâ€œä¸â€
- shouldï¼šé€‰æ‹©æ€§åŒ¹é…çš„æ¡ä»¶ï¼Œå¯ä»¥ç†è§£ä¸ºâ€œæˆ–â€
- must_notï¼šå¿…é¡»ä¸åŒ¹é…çš„æ¡ä»¶ï¼Œä¸å‚ä¸æ‰“åˆ†
- filterï¼šå¿…é¡»åŒ¹é…çš„æ¡ä»¶ï¼Œä¸å‚ä¸æ‰“åˆ†

## æœç´¢ç»“æœå¤„ç†

### æ’åº

elasticsearch é»˜è®¤æ˜¯æ ¹æ®ç›¸å…³åº¦ç®—åˆ†ï¼ˆ_scoreï¼‰æ¥æ’åºï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒè‡ªå®šä¹‰æ–¹å¼å¯¹æœç´¢[ç»“æœæ’åº](https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html)ã€‚å¯ä»¥æ’åºå­—æ®µç±»å‹æœ‰ï¼škeyword ç±»å‹ã€æ•°å€¼ç±»å‹ã€åœ°ç†åæ ‡ç±»å‹ã€æ—¥æœŸç±»å‹ç­‰

keywordã€æ•°å€¼ã€æ—¥æœŸç±»å‹æ’åºçš„è¯­æ³•åŸºæœ¬ä¸€è‡´ã€‚

```json
GET /indexName/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "FIELD": "desc"  // æ’åºå­—æ®µã€æ’åºæ–¹å¼ASCã€DESC
    }
  ]
}
```

æ’åºæ¡ä»¶æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å†™å¤šä¸ªæ’åºæ¡ä»¶ã€‚æŒ‰ç…§å£°æ˜çš„é¡ºåºï¼Œå½“ç¬¬ä¸€ä¸ªæ¡ä»¶ç›¸ç­‰æ—¶ï¼Œå†æŒ‰ç…§ç¬¬äºŒä¸ªæ¡ä»¶æ’åºã€‚

éœ€æ±‚æè¿°ï¼šé…’åº—æ•°æ®æŒ‰ç…§ç”¨æˆ·è¯„ä»·ï¼ˆscore)é™åºæ’åºï¼Œè¯„ä»·ç›¸åŒçš„æŒ‰ç…§ä»·æ ¼(price)å‡åºæ’åº

![](https://cdn.xn2001.com/img/2021/20210921233829.png)

åœ°ç†åæ ‡æ’åºç•¥æœ‰ä¸åŒ

```json
GET /indexName/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "_geo_distance" : {
          "FIELD" : "çº¬åº¦ï¼Œç»åº¦", // æ–‡æ¡£ä¸­geo_pointç±»å‹çš„å­—æ®µåã€ç›®æ ‡åæ ‡ç‚¹
          "order" : "asc", // æ’åºæ–¹å¼
          "unit" : "km" // æ’åºçš„è·ç¦»å•ä½
      }
    }
  ]
}
```

```json
GET /hotel/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "_geo_distance" : {
          "location": "31.034661,121.612282", 
          "order" : "asc", 
          "unit" : "km" 
      }
    }
  ]
}
```

> è·å–ä½ çš„ä½ç½®çš„ç»çº¬åº¦çš„æ–¹å¼ï¼šhttps://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat

å‡è®¾æˆ‘çš„ä½ç½®æ˜¯ï¼š31.034661ï¼Œ121.612282ï¼Œå¯»æ‰¾æˆ‘å‘¨å›´è·ç¦»æœ€è¿‘çš„é…’åº—ã€‚

![](https://cdn.xn2001.com/img/2021/20210921233931.png)

### åˆ†é¡µ

elasticsearch é»˜è®¤æƒ…å†µä¸‹åªè¿”å› top10 çš„æ•°æ®ã€‚è€Œå¦‚æœè¦æŸ¥è¯¢æ›´å¤šæ•°æ®å°±éœ€è¦ä¿®æ”¹åˆ†é¡µå‚æ•°äº†ã€‚

elasticsearch é€šè¿‡ä¿®æ”¹ fromã€size å‚æ•°æ¥æ§åˆ¶è¦è¿”å›çš„åˆ†é¡µç»“æœï¼š

- fromï¼šä»ç¬¬å‡ ä¸ªæ–‡æ¡£å¼€å§‹
- sizeï¼šæ€»å…±æŸ¥è¯¢å‡ ä¸ªæ–‡æ¡£

ç±»ä¼¼äºmysqlä¸­çš„`limit ?, ?`

```json
GET /hotel/_search
{
  "query": {
    "match_all": {}
  },
  "from": 0, // åˆ†é¡µå¼€å§‹çš„ä½ç½®ï¼Œé»˜è®¤ä¸º0
  "size": 10, // æœŸæœ›è·å–çš„æ–‡æ¡£æ€»æ•°
  "sort": [
    {"price": "asc"}
  ]
}
```

> æ·±åº¦åˆ†é¡µé—®é¢˜

ç°åœ¨ï¼Œæˆ‘è¦æŸ¥è¯¢990~1000çš„æ•°æ®ï¼ŒæŸ¥è¯¢é€»è¾‘è¦è¿™ä¹ˆå†™

```json
GET /hotel/_search
{
  "query": {
    "match_all": {}
  },
  "from": 990, // åˆ†é¡µå¼€å§‹çš„ä½ç½®ï¼Œé»˜è®¤ä¸º0
  "size": 10, // æœŸæœ›è·å–çš„æ–‡æ¡£æ€»æ•°
  "sort": [
    {"price": "asc"}
  ]
}
```

è¿™é‡Œæ˜¯æŸ¥è¯¢990å¼€å§‹çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ ç¬¬990~ç¬¬1000æ¡ æ•°æ®ã€‚

æ³¨æ„ï¼šelasticsearch å†…éƒ¨åˆ†é¡µæ—¶ï¼Œå¿…é¡»å…ˆæŸ¥è¯¢ 0~1000æ¡ï¼Œç„¶åæˆªå–å…¶ä¸­çš„ 990 ~ 1000 çš„è¿™10æ¡

![](https://cdn.xn2001.com/img/2021/20210921234503.png)

æŸ¥è¯¢TOP1000ï¼Œå¦‚æœ es æ˜¯å•ç‚¹æ¨¡å¼ï¼Œè¿™å¹¶æ— å¤ªå¤§å½±å“ã€‚

ä½†æ˜¯ elasticsearch å°†æ¥ä¸€å®šæ˜¯é›†ç¾¤ï¼Œä¾‹å¦‚æˆ‘é›†ç¾¤æœ‰5ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘è¦æŸ¥è¯¢ TOP1000 çš„æ•°æ®ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªèŠ‚ç‚¹æŸ¥è¯¢200æ¡å°±å¯ä»¥äº†ã€‚èŠ‚ç‚¹Açš„ TOP200ï¼Œåœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æ’åˆ°10000åä»¥å¤–äº†ã€‚

**å› æ­¤è¦æƒ³è·å–æ•´ä¸ªé›†ç¾¤çš„ TOP1000ï¼Œå¿…é¡»å…ˆæŸ¥è¯¢å‡ºæ¯ä¸ªèŠ‚ç‚¹çš„ TOP1000ï¼Œæ±‡æ€»ç»“æœåï¼Œé‡æ–°æ’åï¼Œé‡æ–°æˆªå–  TOP1000ã€‚**

![](https://cdn.xn2001.com/img/2021/20210921234555.png)

**å½“æŸ¥è¯¢åˆ†é¡µæ·±åº¦è¾ƒå¤§æ—¶ï¼Œæ±‡æ€»æ•°æ®è¿‡å¤šï¼Œå¯¹å†…å­˜å’ŒCPUä¼šäº§ç”Ÿéå¸¸å¤§çš„å‹åŠ›ï¼Œå› æ­¤ elasticsearch ä¼šç¦æ­¢from+ size è¶…è¿‡10000çš„è¯·æ±‚ã€‚**

é’ˆå¯¹æ·±åº¦åˆ†é¡µï¼ŒESæä¾›äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œ[å®˜æ–¹æ–‡æ¡£](https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html)ï¼š

- search afterï¼šåˆ†é¡µæ—¶éœ€è¦æ’åºï¼ŒåŸç†æ˜¯ä»ä¸Šä¸€æ¬¡çš„æ’åºå€¼å¼€å§‹ï¼ŒæŸ¥è¯¢ä¸‹ä¸€é¡µæ•°æ®ã€‚å®˜æ–¹æ¨èä½¿ç”¨çš„æ–¹å¼ã€‚
- scrollï¼šåŸç†å°†æ’åºåçš„æ–‡æ¡£idå½¢æˆå¿«ç…§ï¼Œä¿å­˜åœ¨å†…å­˜ã€‚å®˜æ–¹å·²ç»ä¸æ¨èä½¿ç”¨ã€‚

---

åˆ†é¡µæŸ¥è¯¢çš„å¸¸è§å®ç°æ–¹æ¡ˆä»¥åŠä¼˜ç¼ºç‚¹

- `from + size`
  - ä¼˜ç‚¹ï¼šæ”¯æŒéšæœºç¿»é¡µ
  - ç¼ºç‚¹ï¼šæ·±åº¦åˆ†é¡µé—®é¢˜ï¼Œé»˜è®¤æŸ¥è¯¢ä¸Šé™ï¼ˆfrom + sizeï¼‰æ˜¯10000
  - åœºæ™¯ï¼šç™¾åº¦ã€äº¬ä¸œã€è°·æ­Œã€æ·˜å®è¿™æ ·çš„éšæœºç¿»é¡µæœç´¢
- `after search`
  - ä¼˜ç‚¹ï¼šæ²¡æœ‰æŸ¥è¯¢ä¸Šé™ï¼ˆå•æ¬¡æŸ¥è¯¢çš„sizeä¸è¶…è¿‡10000ï¼‰
  - ç¼ºç‚¹ï¼šåªèƒ½å‘åé€é¡µæŸ¥è¯¢ï¼Œä¸æ”¯æŒéšæœºç¿»é¡µ
  - åœºæ™¯ï¼šæ²¡æœ‰éšæœºç¿»é¡µéœ€æ±‚çš„æœç´¢ï¼Œä¾‹å¦‚æ‰‹æœºå‘ä¸‹æ»šåŠ¨ç¿»é¡µ

- `scroll`
  - ä¼˜ç‚¹ï¼šæ²¡æœ‰æŸ¥è¯¢ä¸Šé™ï¼ˆå•æ¬¡æŸ¥è¯¢çš„sizeä¸è¶…è¿‡10000ï¼‰
  - ç¼ºç‚¹ï¼šä¼šæœ‰é¢å¤–å†…å­˜æ¶ˆè€—ï¼Œå¹¶ä¸”æœç´¢ç»“æœæ˜¯éå®æ—¶çš„
  - åœºæ™¯ï¼šæµ·é‡æ•°æ®çš„è·å–å’Œè¿ç§»ã€‚ä»ES7.1å¼€å§‹ä¸æ¨èï¼Œå»ºè®®ç”¨ after searchæ–¹æ¡ˆã€‚

### é«˜äº®

æˆ‘ä»¬åœ¨ç™¾åº¦ï¼Œäº¬ä¸œæœç´¢æ—¶ï¼Œå…³é”®å­—ä¼šå˜æˆçº¢è‰²ï¼Œæ¯”è¾ƒé†’ç›®ï¼Œè¿™å«é«˜äº®æ˜¾ç¤ºï¼š

![](https://cdn.xn2001.com/img/2021/20210921234711.png)

é«˜äº®æ˜¾ç¤ºçš„å®ç°åˆ†ä¸ºä¸¤æ­¥ï¼š

- 1ï¼‰ç»™æ–‡æ¡£ä¸­çš„æ‰€æœ‰å…³é”®å­—éƒ½æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ï¼Œä¾‹å¦‚`<em>`æ ‡ç­¾
- 2ï¼‰é¡µé¢ç»™`<em>`æ ‡ç­¾ç¼–å†™CSSæ ·å¼

```json
GET /hotel/_search
{
  "query": {
    "match": {
      "FIELD": "TEXT" // æŸ¥è¯¢æ¡ä»¶ï¼Œé«˜äº®ä¸€å®šè¦ä½¿ç”¨å…¨æ–‡æ£€ç´¢æŸ¥è¯¢
    }
  },
  "highlight": {
    "fields": { // æŒ‡å®šè¦é«˜äº®çš„å­—æ®µ
      "FIELD": {
        "pre_tags": "<em>",  // ç”¨æ¥æ ‡è®°é«˜äº®å­—æ®µçš„å‰ç½®æ ‡ç­¾
        "post_tags": "</em>" // ç”¨æ¥æ ‡è®°é«˜äº®å­—æ®µçš„åç½®æ ‡ç­¾
      }
    }
  }
}
```

**æ³¨æ„**ï¼š

- é«˜äº®æ˜¯å¯¹å…³é”®å­—é«˜äº®ï¼Œå› æ­¤**æœç´¢æ¡ä»¶å¿…é¡»å¸¦æœ‰å…³é”®å­—**ï¼Œè€Œä¸èƒ½æ˜¯èŒƒå›´è¿™æ ·çš„æŸ¥è¯¢ã€‚
- é»˜è®¤æƒ…å†µä¸‹ï¼Œ**é«˜äº®çš„å­—æ®µï¼Œå¿…é¡»ä¸æœç´¢æŒ‡å®šçš„å­—æ®µä¸€è‡´**ï¼Œå¦åˆ™æ— æ³•é«˜äº®
- å¦‚æœè¦å¯¹éæœç´¢å­—æ®µé«˜äº®ï¼Œåˆ™éœ€è¦æ·»åŠ ä¸€ä¸ªå±æ€§ï¼š`required_field_match=false`

![](https://cdn.xn2001.com/img/2021/20210921234739.png)

> DSL æ€»ä½“ç»“æ„å¦‚ä¸‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210921235330.png)

## RestClientæ–‡æ¡£æŸ¥è¯¢

### å‘èµ·æŸ¥è¯¢è¯·æ±‚

![](https://cdn.xn2001.com/img/2021/20211016170057.png)

```java
/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/10/16 17:05
 */
@SpringBootTest
public class HotelSearchTest {

    private RestHighLevelClient restHighLevelClient;

    @Autowired
    private IHotelService hotelService;

    @Test
    public void match_All() throws IOException {
        SearchRequest request = new SearchRequest("hotel");
        request.source()
                .query(QueryBuilders.matchAllQuery());
        SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
    }

    @BeforeEach
    void init() {
        this.restHighLevelClient = new RestHighLevelClient(RestClient.builder(
                HttpHost.create("http://192.168.211.128:9200")
        ));
    }

    @AfterEach
    void down() throws IOException {
        this.restHighLevelClient.close();
    }
}
```

- ç¬¬ä¸€æ­¥ï¼Œåˆ›å»º`SearchRequest`å¯¹è±¡ï¼ŒæŒ‡å®šç´¢å¼•åº“å
- ç¬¬äºŒæ­¥ï¼Œåˆ©ç”¨`request.source()`æ„å»º DSLï¼ŒDSL ä¸­å¯ä»¥åŒ…å«æŸ¥è¯¢ã€åˆ†é¡µã€æ’åºã€é«˜äº®ç­‰
  - `query()`ï¼šä»£è¡¨æŸ¥è¯¢æ¡ä»¶ï¼Œåˆ©ç”¨ `QueryBuilders.matchAllQuery()` æ„å»ºä¸€ä¸ª match_all æŸ¥è¯¢çš„ DSL
- ç¬¬ä¸‰æ­¥ï¼Œåˆ©ç”¨ `client.search()` å‘é€è¯·æ±‚ï¼Œå¾—åˆ°å“åº”

å…³é”®çš„ API æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ `request.source()`ï¼Œå…¶ä¸­åŒ…å«äº†æŸ¥è¯¢ã€æ’åºã€åˆ†é¡µã€é«˜äº®ç­‰æ‰€æœ‰åŠŸèƒ½

![](https://cdn.xn2001.com/img/2021/20211016170203.png)

å¦ä¸€ä¸ªæ˜¯ `QueryBuilders`ï¼Œå…¶ä¸­åŒ…å« matchã€termã€function_scoreã€bool ç­‰å„ç§æŸ¥è¯¢

![](https://cdn.xn2001.com/img/2021/20211016170234.png)

### è§£ææŸ¥è¯¢å“åº”

![](https://cdn.xn2001.com/img/2021/20211016174631.png)

Elasticsearch è¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼Œç»“æ„åŒ…å«

- `hits`ï¼šå‘½ä¸­çš„ç»“æœ
  - `total`ï¼šæ€»æ¡æ•°ï¼Œå…¶ä¸­çš„valueæ˜¯å…·ä½“çš„æ€»æ¡æ•°å€¼
  - `max_score`ï¼šæ‰€æœ‰ç»“æœä¸­å¾—åˆ†æœ€é«˜çš„æ–‡æ¡£çš„ç›¸å…³æ€§ç®—åˆ†
  - `hits`ï¼šæœç´¢ç»“æœçš„æ–‡æ¡£æ•°ç»„ï¼Œå…¶ä¸­çš„æ¯ä¸ªæ–‡æ¡£éƒ½æ˜¯ä¸€ä¸ª json å¯¹è±¡
    - `_source`ï¼šæ–‡æ¡£ä¸­çš„åŸå§‹æ•°æ®ï¼Œä¹Ÿæ˜¯ json å¯¹è±¡

å› æ­¤ï¼Œæˆ‘ä»¬è§£æå“åº”ç»“æœï¼Œå°±æ˜¯é€å±‚è§£æ JSON å­—ç¬¦ä¸²ï¼Œæµç¨‹å¦‚ä¸‹

- `SearchHits`ï¼šé€šè¿‡ `response.getHits()` è·å–ï¼Œå°±æ˜¯ json ä¸­çš„æœ€å¤–å±‚çš„ hitsï¼Œä»£è¡¨å‘½ä¸­çš„ç»“æœ
  - `SearchHits.getTotalHits().value`ï¼šè·å–æ€»æ¡æ•°ä¿¡æ¯
  - `SearchHits.getHits()`ï¼šè·å– SearchHit æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æ–‡æ¡£æ•°ç»„
    - `SearchHit.getSourceAsString()`ï¼šè·å–æ–‡æ¡£ç»“æœä¸­çš„ `_source`ï¼Œä¹Ÿå°±æ˜¯åŸå§‹çš„ json æ–‡æ¡£æ•°æ®

```java
/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/10/16 17:05
 */
@SpringBootTest
public class HotelSearchTest {

    private RestHighLevelClient restHighLevelClient;

    @Autowired
    private IHotelService hotelService;

    @Test
    public void match_All() throws IOException {
        SearchRequest request = new SearchRequest("hotel");
        request.source()
                .query(QueryBuilders.matchAllQuery());
        SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
        SearchHits searchHits = response.getHits();
        System.out.println("hits.getTotalHits().æ¡æ•° = " + searchHits.getTotalHits().value);
        SearchHit[] hits = searchHits.getHits();
        for (SearchHit hit : hits) {
            String sourceAsString = hit.getSourceAsString();
            HotelDoc hotelDoc = JSON.parseObject(sourceAsString, HotelDoc.class);
            System.out.println(hotelDoc);
        }
    }

    @BeforeEach
    void init() {
        this.restHighLevelClient = new RestHighLevelClient(RestClient.builder(
                HttpHost.create("http://192.168.211.128:9200")
        ));
    }

    @AfterEach
    void down() throws IOException {
        this.restHighLevelClient.close();
    }
}
```

### matchæŸ¥è¯¢

![](https://cdn.xn2001.com/img/2021/20211016182859.png)

```java
@Test
public void matchQuery() throws IOException {
    SearchRequest request = new SearchRequest("hotel");
    request.source()
            .query(QueryBuilders.matchQuery("all","å¦‚å®¶"));
    SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
    SearchHits searchHits = response.getHits();
    System.out.println("hits.getTotalHits().æ¡æ•° = " + searchHits.getTotalHits().value);
    SearchHit[] hits = searchHits.getHits();
    for (SearchHit hit : hits) {
        String sourceAsString = hit.getSourceAsString();
        HotelDoc hotelDoc = JSON.parseObject(sourceAsString, HotelDoc.class);
        System.out.println(hotelDoc);
    }
}

@Test
public void multiMatchQuery() throws IOException {
    SearchRequest request = new SearchRequest("hotel");
    request.source()
            .query(QueryBuilders.multiMatchQuery("å¦‚å®¶","name","brand"));
    SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
    SearchHits searchHits = response.getHits();
    System.out.println("hits.getTotalHits().æ¡æ•° = " + searchHits.getTotalHits().value);
    SearchHit[] hits = searchHits.getHits();
    for (SearchHit hit : hits) {
        String sourceAsString = hit.getSourceAsString();
        HotelDoc hotelDoc = JSON.parseObject(sourceAsString, HotelDoc.class);
        System.out.println(hotelDoc);
    }
}
```

### ç²¾ç¡®æŸ¥è¯¢

 ç²¾ç¡®æŸ¥è¯¢ä¸»è¦æ˜¯ä¸¤è€…

- termï¼šè¯æ¡ç²¾ç¡®åŒ¹é…
- rangeï¼šèŒƒå›´æŸ¥è¯¢

![](https://cdn.xn2001.com/img/2021/20211016192658.png) 

### å¸ƒå°”æŸ¥è¯¢

å¸ƒå°”æŸ¥è¯¢æ˜¯ç”¨ mustã€must_notã€filterç­‰æ–¹å¼ç»„åˆå…¶å®ƒæŸ¥è¯¢ï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20211016192745.png)

```java
@Test
void testBool() throws IOException {
    // 1.å‡†å¤‡Request
    SearchRequest request = new SearchRequest("hotel");
    // 2.å‡†å¤‡DSL
    request.source()
            .query(
                    QueryBuilders.boolQuery()
                            .must(QueryBuilders.termQuery("city", "ä¸Šæµ·"))
                            .filter(QueryBuilders.rangeQuery("price").lte(300))
            );
    // 3.å‘é€è¯·æ±‚
    SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
    // 4.è§£æå“åº”
    SearchHits searchHits = response.getHits();
    System.out.println("hits.getTotalHits().æ¡æ•° = " + searchHits.getTotalHits().value);
    SearchHit[] hits = searchHits.getHits();
    for (SearchHit hit : hits) {
        String sourceAsString = hit.getSourceAsString();
        HotelDoc hotelDoc = JSON.parseObject(sourceAsString, HotelDoc.class);
        System.out.println(hotelDoc);
    }
}
```

### æ’åºã€åˆ†é¡µ

æœç´¢ç»“æœçš„æ’åºå’Œåˆ†é¡µæ˜¯ä¸ query åŒçº§çš„å‚æ•°ï¼Œå› æ­¤åŒæ ·æ˜¯ä½¿ç”¨ `request.source()` æ¥è®¾ç½®ã€‚

å¯¹åº”çš„APIå¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20211016202447.png)

```java
@Test
void testPageAndSort() throws IOException {
    // é¡µç ï¼Œæ¯é¡µå¤§å°
    int page = 1, size = 5;

    // 1.å‡†å¤‡Request
    SearchRequest request = new SearchRequest("hotel");
    // 2.å‡†å¤‡DSL
    // 2.1.query
    request.source().query(QueryBuilders.matchAllQuery());
    // 2.2.æ’åº sort
    request.source().sort("price", SortOrder.ASC);
    // 2.3.åˆ†é¡µ fromã€size
    request.source().from((page - 1) * size).size(5);
    // 3.å‘é€è¯·æ±‚
    SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
    // 4.è§£æå“åº”
    SearchHits searchHits = response.getHits();
    System.out.println("hits.getTotalHits().æ¡æ•° = " + searchHits.getTotalHits().value);
    SearchHit[] hits = searchHits.getHits();
    for (SearchHit hit : hits) {
        String sourceAsString = hit.getSourceAsString();
        HotelDoc hotelDoc = JSON.parseObject(sourceAsString, HotelDoc.class);
        System.out.println(hotelDoc);
    }
}
```

### é«˜äº®

- æŸ¥è¯¢çš„ DSLï¼šå…¶ä¸­é™¤äº†æŸ¥è¯¢æ¡ä»¶ï¼Œè¿˜éœ€è¦æ·»åŠ é«˜äº®æ¡ä»¶ï¼ŒåŒæ ·æ˜¯ä¸ query åŒçº§ã€‚
- ç»“æœè§£æï¼šç»“æœé™¤äº†è¦è§£æ `_source` æ–‡æ¡£æ•°æ®ï¼Œè¿˜è¦è§£æé«˜äº®ç»“æœ

**é«˜äº®è¯·æ±‚çš„æ„å»º API**

![](https://cdn.xn2001.com/img/2021/20211016202707.png)

ä¸Šè¿°ä»£ç çœç•¥äº†æŸ¥è¯¢æ¡ä»¶éƒ¨åˆ†ï¼Œä½†æ˜¯é«˜äº®æŸ¥è¯¢å¿…é¡»ä½¿ç”¨å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œå¹¶ä¸”è¦æœ‰æœç´¢å…³é”®å­—ï¼Œå°†æ¥æ‰å¯ä»¥å¯¹å…³é”®å­—é«˜äº®.

```java
@Test
void testHighlight() throws IOException {
    // 1.å‡†å¤‡Request
    SearchRequest request = new SearchRequest("hotel");
    // 2.å‡†å¤‡DSL
    // 2.1.query
    request.source().query(QueryBuilders.matchQuery("all", "å¦‚å®¶"));
    // 2.2.é«˜äº®
    request.source().highlighter(new HighlightBuilder().field("name").requireFieldMatch(false));
    // 3.å‘é€è¯·æ±‚
    SearchResponse response = client.search(request, RequestOptions.DEFAULT);
    // 4.è§£æå“åº”
    handleResponse(response); //ä»£ç åœ¨ä¸‹æ–‡
}
```

**é«˜äº®ç»“æœè§£æ**

é«˜äº®çš„ç»“æœä¸æŸ¥è¯¢çš„æ–‡æ¡£ç»“æœé»˜è®¤æ˜¯åˆ†ç¦»çš„ï¼Œå¹¶ä¸åœ¨ä¸€èµ·ã€‚

å› æ­¤è§£æé«˜äº®çš„ä»£ç éœ€è¦é¢å¤–å¤„ç†ï¼š

![](https://cdn.xn2001.com/img/2021/20211016202853.png)

- ç¬¬ä¸€æ­¥ï¼šä»ç»“æœä¸­è·å– sourceã€‚`hit.getSourceAsString()`ï¼Œè¿™éƒ¨åˆ†æ˜¯éé«˜äº®ç»“æœï¼Œjson å­—ç¬¦ä¸²ï¼Œéœ€è¦ååºåˆ—ä¸º HotelDoc å¯¹è±¡
- ç¬¬äºŒæ­¥ï¼šè·å–é«˜äº®ç»“æœã€‚`hit.getHighlightFields()`ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ª Mapï¼Œkey æ˜¯é«˜äº®å­—æ®µåç§°ï¼Œå€¼æ˜¯HighlightField å¯¹è±¡ï¼Œä»£è¡¨é«˜äº®å€¼
- ç¬¬ä¸‰æ­¥ï¼šä» map ä¸­æ ¹æ®é«˜äº®å­—æ®µåç§°ï¼Œè·å–é«˜äº®å­—æ®µå€¼å¯¹è±¡ HighlightField
- ç¬¬å››æ­¥ï¼šä» HighlightField ä¸­è·å– Fragmentsï¼Œå¹¶ä¸”è½¬ä¸ºå­—ç¬¦ä¸²ã€‚**è¿™éƒ¨åˆ†æ˜¯çœŸæ­£çš„é«˜äº®å­—ç¬¦ä¸²**
- ç¬¬äº”æ­¥ï¼šç”¨é«˜äº®çš„ç»“æœæ›¿æ¢ HotelDoc ä¸­çš„éé«˜äº®ç»“æœ

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
private void handleResponse(SearchResponse response) {
    // 4.è§£æå“åº”
    SearchHits searchHits = response.getHits();
    // 4.1.è·å–æ€»æ¡æ•°
    long total = searchHits.getTotalHits().value;
    System.out.println("å…±æœç´¢åˆ°" + total + "æ¡æ•°æ®");
    // 4.2.æ–‡æ¡£æ•°ç»„
    SearchHit[] hits = searchHits.getHits();
    // 4.3.éå†
    for (SearchHit hit : hits) {
        // è·å–æ–‡æ¡£source
        String json = hit.getSourceAsString();
        // ååºåˆ—åŒ–
        HotelDoc hotelDoc = JSON.parseObject(json, HotelDoc.class);
        // è·å–é«˜äº®ç»“æœ
        Map<String, HighlightField> highlightFields = hit.getHighlightFields();
        if (!CollectionUtils.isEmpty(highlightFields)) {
            // æ ¹æ®å­—æ®µåè·å–é«˜äº®ç»“æœ
            HighlightField highlightField = highlightFields.get("name");
            if (highlightField != null) {
                // è·å–é«˜äº®å€¼
                String name = highlightField.getFragments()[0].string();
                // è¦†ç›–éé«˜äº®ç»“æœ
                hotelDoc.setName(name);
            }
        }
        System.out.println("hotelDoc = " + hotelDoc);
    }
}
```

### åœ°ç†åæ ‡æŸ¥è¯¢

![](https://cdn.xn2001.com/img/2021/20211019000540.png)

### ç›¸å…³æ€§å¾—åˆ†

function_score æŸ¥è¯¢ç»“æ„å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20211019011433.png)



å¯¹åº”çš„ JavaAPI å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20211019011439.png)

## DSLæ•°æ®èšåˆ

**[èšåˆï¼ˆ](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html)[aggregations](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html)[ï¼‰](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html)**å¯ä»¥è®©æˆ‘ä»¬æå…¶æ–¹ä¾¿çš„å®ç°å¯¹æ•°æ®çš„ç»Ÿè®¡ã€åˆ†æã€è¿ç®—ã€‚

- ä»€ä¹ˆå“ç‰Œçš„æ‰‹æœºæœ€å—æ¬¢è¿ï¼Ÿ
- è¿™äº›æ‰‹æœºçš„å¹³å‡ä»·æ ¼ã€æœ€é«˜ä»·æ ¼ã€æœ€ä½ä»·æ ¼ï¼Ÿ
- è¿™äº›æ‰‹æœºæ¯æœˆçš„é”€å”®æƒ…å†µå¦‚ä½•ï¼Ÿ

åœ¨ Elasticsearch å®ç°è¿™äº›ç»Ÿè®¡åŠŸèƒ½æ¯”æ•°æ®åº“çš„ sql è¦æ–¹ä¾¿çš„å¤šï¼Œè€Œä¸”æŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ï¼Œå¯ä»¥å®ç°è¿‘å®æ—¶æœç´¢æ•ˆæœã€‚

èšåˆå¸¸è§çš„æœ‰ä¸‰ç±»

- **æ¡¶ï¼ˆBucketï¼‰**èšåˆï¼šç”¨æ¥å¯¹æ–‡æ¡£åšåˆ†ç»„
  - TermAggregationï¼šæŒ‰ç…§æ–‡æ¡£å­—æ®µå€¼åˆ†ç»„ï¼Œä¾‹å¦‚æŒ‰ç…§å“ç‰Œå€¼åˆ†ç»„ã€æŒ‰ç…§å›½å®¶åˆ†ç»„
  - Date Histogramï¼šæŒ‰ç…§æ—¥æœŸé˜¶æ¢¯åˆ†ç»„ï¼Œä¾‹å¦‚ä¸€å‘¨ä¸ºä¸€ç»„ï¼Œæˆ–è€…ä¸€æœˆä¸ºä¸€ç»„

- **åº¦é‡ï¼ˆMetricï¼‰**èšåˆï¼šç”¨ä»¥è®¡ç®—ä¸€äº›å€¼ï¼Œæ¯”å¦‚ï¼šæœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ç­‰
  - Avgï¼šæ±‚å¹³å‡å€¼
  - Maxï¼šæ±‚æœ€å¤§å€¼
  - Minï¼šæ±‚æœ€å°å€¼
  - Statsï¼šåŒæ—¶æ±‚ maxã€minã€avgã€sum ç­‰
- **ç®¡é“ï¼ˆpipelineï¼‰**èšåˆï¼šå…¶å®ƒèšåˆçš„ç»“æœä¸ºåŸºç¡€åšèšåˆ

> **æ³¨æ„**ï¼šå‚åŠ èšåˆçš„å­—æ®µå¿…é¡»æ˜¯keywordã€æ—¥æœŸã€æ•°å€¼ã€å¸ƒå°”ç±»å‹

### Bucketèšåˆè¯­æ³•

ä¾‹å¦‚ï¼šæˆ‘ä»¬è¦ç»Ÿè®¡æ‰€æœ‰æ•°æ®ä¸­çš„é…’åº—å“ç‰Œæœ‰å‡ ç§ï¼Œå…¶å®å°±æ˜¯æŒ‰ç…§å“ç‰Œå¯¹æ•°æ®åˆ†ç»„ã€‚æ­¤æ—¶å¯ä»¥æ ¹æ®é…’åº—å“ç‰Œçš„åç§°åšèšåˆï¼Œä¹Ÿå°±æ˜¯ Bucket èšåˆã€‚

```json
GET /hotel/_search
{
  "size": 0,  // è®¾ç½®sizeä¸º0ï¼Œç»“æœä¸­ä¸åŒ…å«æ–‡æ¡£ï¼ŒåªåŒ…å«èšåˆç»“æœ
  "aggs": { // å®šä¹‰èšåˆ
    "brandAgg": { //ç»™èšåˆèµ·ä¸ªåå­—
      "terms": { // èšåˆçš„ç±»å‹ï¼ŒæŒ‰ç…§å“ç‰Œå€¼èšåˆï¼Œæ‰€ä»¥é€‰æ‹©term
        "field": "brand", // å‚ä¸èšåˆçš„å­—æ®µ
        "size": 20 // å¸Œæœ›è·å–çš„èšåˆç»“æœæ•°é‡
      }
    }
  }
}
```

![](https://cdn.xn2001.com/img/2021/20211022184007.png)

é»˜è®¤æƒ…å†µä¸‹ï¼ŒBucket èšåˆä¼šç»Ÿè®¡ Bucket å†…çš„æ–‡æ¡£æ•°é‡ï¼Œè®°ä¸º `_count`ï¼Œå¹¶ä¸”æŒ‰ç…§ `_count` é™åºæ’åºã€‚

æˆ‘ä»¬å¯ä»¥æŒ‡å®š order å±æ€§ï¼Œè‡ªå®šä¹‰èšåˆçš„æ’åºæ–¹å¼

```json
GET /hotel/_search
{
  "size": 0, 
  "aggs": {
    "brandAgg": {
      "terms": {
        "field": "brand",
        "order": {
          "_count": "asc" // æŒ‰ç…§_countå‡åºæ’åˆ—
        },
        "size": 20
      }
    }
  }
}
```

é»˜è®¤æƒ…å†µä¸‹ï¼ŒBucket èšåˆæ˜¯å¯¹ç´¢å¼•åº“çš„æ‰€æœ‰æ–‡æ¡£åšèšåˆï¼Œä½†çœŸå®åœºæ™¯ä¸‹ï¼Œç”¨æˆ·ä¼šè¾“å…¥æœç´¢æ¡ä»¶ï¼Œå› æ­¤èšåˆå¿…é¡»æ˜¯å¯¹æœç´¢ç»“æœèšåˆã€‚é‚£ä¹ˆèšåˆå¿…é¡»æ·»åŠ é™å®šæ¡ä»¶ã€‚

æˆ‘ä»¬å¯ä»¥é™å®šè¦èšåˆçš„æ–‡æ¡£èŒƒå›´ï¼Œåªè¦æ·»åŠ  query æ¡ä»¶å³å¯ï¼›

```json
GET /hotel/_search
{
  "query": {
    "range": {
      "price": {
        "lte": 200 // åªå¯¹200å…ƒä»¥ä¸‹çš„æ–‡æ¡£èšåˆ
      }
    }
  }, 
  "size": 0, 
  "aggs": {
    "brandAgg": {
      "terms": {
        "field": "brand",
        "size": 20
      }
    }
  }
}
```

è¿™æ¬¡ï¼Œèšåˆå¾—åˆ°çš„å“ç‰Œæ˜æ˜¾å˜å°‘äº†

![](https://cdn.xn2001.com/img/2021/20211022184549.png)

### Metricèšåˆè¯­æ³•

ä¸Šé¢ï¼Œæˆ‘ä»¬å¯¹é…’åº—æŒ‰ç…§å“ç‰Œåˆ†ç»„ï¼Œå½¢æˆäº†ä¸€ä¸ªä¸ªæ¡¶ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦å¯¹æ¡¶å†…çš„é…’åº—åšè¿ç®—ï¼Œè·å–æ¯ä¸ªå“ç‰Œçš„ç”¨æˆ·è¯„åˆ†çš„ minã€maxã€avg ç­‰å€¼ã€‚

è¿™å°±è¦ç”¨åˆ° Metric èšåˆäº†ï¼Œä¾‹å¦‚ stats èšåˆï¼šå°±å¯ä»¥è·å– minã€maxã€avg ç­‰ç»“æœ

```json
GET /hotel/_search
{
  "size": 0, 
  "aggs": {
    "brandAgg": { 
      "terms": { 
        "field": "brand", 
        "size": 20
      },
      "aggs": { // æ˜¯brandsèšåˆçš„å­èšåˆï¼Œä¹Ÿå°±æ˜¯åˆ†ç»„åå¯¹æ¯ç»„åˆ†åˆ«è®¡ç®—
        "score_stats": { // èšåˆåç§°
          "stats": { // èšåˆç±»å‹ï¼Œè¿™é‡Œstatså¯ä»¥è®¡ç®—minã€maxã€avgç­‰
            "field": "score" // èšåˆå­—æ®µï¼Œè¿™é‡Œæ˜¯score
          }
        }
      }
    }
  }
}
```

è¿™æ¬¡çš„ score_stats èšåˆæ˜¯åœ¨ brandAgg çš„èšåˆå†…éƒ¨åµŒå¥—çš„å­èšåˆã€‚å› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªæ¡¶åˆ†åˆ«è®¡ç®—ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç»™èšåˆç»“æœåšä¸ªæ’åºï¼Œä¾‹å¦‚æŒ‰ç…§æ¯ä¸ªæ¡¶çš„é…’åº—å¹³å‡åˆ†åšæ’åº

![](https://cdn.xn2001.com/img/2021/20211022184847.png)

## RestAPIæ•°æ®èšåˆ

èšåˆæ¡ä»¶ä¸ query æ¡ä»¶åŒçº§åˆ«ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ `request.source()` æ¥æŒ‡å®šèšåˆæ¡ä»¶

![](https://cdn.xn2001.com/img/2021/20211022190429.png)

èšåˆçš„ç»“æœä¹Ÿä¸æŸ¥è¯¢ç»“æœä¸åŒï¼ŒAPI ä¹Ÿæ¯”è¾ƒç‰¹æ®Šã€‚ä¸è¿‡åŒæ ·æ˜¯ JSON é€å±‚è§£æ

![](https://cdn.xn2001.com/img/2021/20211022190457.png)

```java
@Test
public void testAggregation() throws IOException {
    SearchRequest request = new SearchRequest("hotel");
    request.source().aggregation(AggregationBuilders.terms("brandAgg").field("brand").size(20));
    SearchResponse response = client.search(request, RequestOptions.DEFAULT);
    Terms brandAgg = response.getAggregations().get("brandAgg");
    List<? extends Terms.Bucket> buckets = brandAgg.getBuckets();
    for (Terms.Bucket bucket : buckets) {
        String key = bucket.getKeyAsString();
        System.out.println("key = " + key);
    }
}
```

## è‡ªåŠ¨è¡¥å…¨

å½“ç”¨æˆ·åœ¨æœç´¢æ¡†è¾“å…¥å­—ç¬¦æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æç¤ºå‡ºä¸è¯¥å­—ç¬¦æœ‰å…³çš„æœç´¢é¡¹ï¼Œæç¤ºå®Œæ•´è¯æ¡çš„åŠŸèƒ½ï¼Œå°±æ˜¯è‡ªåŠ¨è¡¥å…¨äº†ã€‚

### æ‹¼éŸ³åˆ†è¯å™¨

å¦‚æœæˆ‘ä»¬éœ€è¦æ ¹æ®æ‹¼éŸ³å­—æ¯æ¥æ¨æ–­ï¼Œå› æ­¤è¦ç”¨åˆ°æ‹¼éŸ³åˆ†è¯åŠŸèƒ½ã€‚

è¦å®ç°æ ¹æ®å­—æ¯åšè¡¥å…¨ï¼Œå°±å¿…é¡»å¯¹æ–‡æ¡£æŒ‰ç…§æ‹¼éŸ³åˆ†è¯ã€‚æ’ä»¶åœ°å€ï¼šhttps://github.com/medcl/elasticsearch-analysis-pinyin

![](https://cdn.xn2001.com/img/2021/20211023015636.png)

ä½¿ç”¨ `docker volume inspect es-plugins` æŸ¥çœ‹æ’ä»¶ç›®å½•ï¼Œå°†ä¸‹è½½çš„æ–‡ä»¶è§£å‹ä¸Šä¼ ï¼Œé‡å¯ Elasticsearch

æµ‹è¯•ç”¨æ³•å¦‚ä¸‹ï¼š

```json
POST /_analyze
{
  "text": "å¦‚å®¶é…’åº—è¿˜ä¸é”™",
  "analyzer": "pinyin"
}
```

ç»“æœï¼š

![](https://cdn.xn2001.com/img/2021/20211023021713.png) 



### è‡ªå®šä¹‰åˆ†è¯å™¨

é»˜è®¤çš„æ‹¼éŸ³åˆ†è¯å™¨ä¼šå°†æ¯ä¸ªæ±‰å­—å•ç‹¬åˆ†ä¸ºæ‹¼éŸ³ï¼Œè€Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯æ¯ä¸ªè¯æ¡å½¢æˆä¸€ç»„æ‹¼éŸ³ï¼Œéœ€è¦å¯¹æ‹¼éŸ³åˆ†è¯å™¨åšä¸ªæ€§åŒ–å®šåˆ¶ï¼Œå½¢æˆè‡ªå®šä¹‰åˆ†è¯å™¨ã€‚

elasticsearch ä¸­åˆ†è¯å™¨ï¼ˆanalyzerï¼‰çš„ç»„æˆåŒ…å«ä¸‰éƒ¨åˆ†ï¼š

- character filtersï¼šåœ¨ tokenizer ä¹‹å‰å¯¹æ–‡æœ¬è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚åˆ é™¤å­—ç¬¦ã€æ›¿æ¢å­—ç¬¦
- tokenizerï¼šå°†æ–‡æœ¬æŒ‰ç…§ä¸€å®šçš„è§„åˆ™åˆ‡å‰²æˆè¯æ¡ï¼ˆtermï¼‰ã€‚ä¾‹å¦‚ keywordï¼Œå°±æ˜¯ä¸åˆ†è¯ï¼›è¿˜æœ‰ ik_smart
- tokenizer filterï¼šå°† tokenizer è¾“å‡ºçš„è¯æ¡åšè¿›ä¸€æ­¥å¤„ç†ã€‚ä¾‹å¦‚å¤§å°å†™è½¬æ¢ã€åŒä¹‰è¯å¤„ç†ã€æ‹¼éŸ³å¤„ç†ç­‰

æ–‡æ¡£åˆ†è¯æ—¶ä¼šä¾æ¬¡ç”±è¿™ä¸‰éƒ¨åˆ†æ¥å¤„ç†æ–‡æ¡£ï¼š

   ![](https://cdn.xn2001.com/img/2021/20211023021451.png)

å£°æ˜è‡ªå®šä¹‰åˆ†è¯å™¨çš„è¯­æ³•å¦‚ä¸‹ï¼š

```json
PUT /test
{
  "settings": {
    "analysis": {
      "analyzer": { // è‡ªå®šä¹‰åˆ†è¯å™¨
        "my_analyzer": {  // åˆ†è¯å™¨åç§°
          "tokenizer": "ik_max_word",
          "filter": "py"
        }
      },
      "filter": { // è‡ªå®šä¹‰tokenizer filter
        "py": { // è¿‡æ»¤å™¨åç§°
          "type": "pinyin", // è¿‡æ»¤å™¨ç±»å‹ï¼Œè¿™é‡Œæ˜¯pinyin
		  "keep_full_pinyin": false,
          "keep_joined_full_pinyin": true,
          "keep_original": true,
          "limit_first_letter_length": 16,
          "remove_duplicated_term": true,
          "none_chinese_pinyin_tokenize": false
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "name": {
        "type": "text",
        "analyzer": "my_analyzer",
        "search_analyzer": "ik_smart"
      }
    }
  }
}
```

æµ‹è¯•

![](https://cdn.xn2001.com/img/2021/20211023021532.png)

æ³¨æ„**ï¼šä¸ºäº†é¿å…æœç´¢åˆ°åŒéŸ³å­—ï¼Œæœç´¢æ—¶ä¸è¦ä½¿ç”¨æ‹¼éŸ³åˆ†è¯å™¨**

![](https://cdn.xn2001.com/img/2021/20211023022355.png)

### è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢

elasticsearch æä¾›äº† [Completion Suggester](https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html) æŸ¥è¯¢æ¥å®ç°è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚è¿™ä¸ªæŸ¥è¯¢ä¼šåŒ¹é…ä»¥ç”¨æˆ·è¾“å…¥å†…å®¹å¼€å¤´çš„è¯æ¡å¹¶è¿”å›ï¼›ä¸ºäº†æé«˜è¡¥å…¨æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå¯¹äºæ–‡æ¡£ä¸­å­—æ®µçš„ç±»å‹æœ‰ä¸€äº›çº¦æŸ

- å‚ä¸è¡¥å…¨æŸ¥è¯¢çš„å­—æ®µå¿…é¡»æ˜¯ completion ç±»å‹ã€‚

- å­—æ®µçš„å†…å®¹ä¸€èˆ¬æ˜¯ç”¨æ¥è¡¥å…¨çš„å¤šä¸ªè¯æ¡å½¢æˆçš„æ•°ç»„ã€‚

```json
// åˆ›å»ºç´¢å¼•åº“
PUT test
{
  "mappings": {
    "properties": {
      "title":{
        "type": "completion"
      }
    }
  }
}
```

ç„¶åæ’å…¥ä¸‹é¢çš„æ•°æ®

```json
// ç¤ºä¾‹æ•°æ®
POST test/_doc
{
  "title": ["Sony", "WH-1000XM3"]
}
POST test/_doc
{
  "title": ["SK-II", "PITERA"]
}
POST test/_doc
{
  "title": ["Nintendo", "switch"]
}
```

æŸ¥è¯¢çš„ DSL è¯­å¥å¦‚ä¸‹

```json
// è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢
GET /test/_search
{
  "suggest": {
    "title_suggest": {
      "text": "s", // å…³é”®å­—
      "completion": {
        "field": "title", // è¡¥å…¨æŸ¥è¯¢çš„å­—æ®µ
        "skip_duplicates": true, // è·³è¿‡é‡å¤çš„
        "size": 10 // è·å–å‰10æ¡ç»“æœ
      }
    }
  }
}
```

ä¾‹å¦‚ä¸€ä¸ªé…’åº—çš„ç´¢å¼•åº“å®Œæ•´æ¡ˆä¾‹

```json
// é…’åº—æ•°æ®ç´¢å¼•åº“
PUT /hotel
{
  "settings": {
    "analysis": {
      "analyzer": {
        "text_anlyzer": {
          "tokenizer": "ik_max_word",
          "filter": "py"
        },
        "completion_analyzer": {
          "tokenizer": "keyword",
          "filter": "py"
        }
      },
      "filter": {
        "py": {
          "type": "pinyin",
          "keep_full_pinyin": false,
          "keep_joined_full_pinyin": true,
          "keep_original": true,
          "limit_first_letter_length": 16,
          "remove_duplicated_term": true,
          "none_chinese_pinyin_tokenize": false
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id":{
        "type": "keyword"
      },
      "name":{
        "type": "text",
        "analyzer": "text_anlyzer",
        "search_analyzer": "ik_smart",
        "copy_to": "all"
      },
      "address":{
        "type": "keyword",
        "index": false
      },
      "price":{
        "type": "integer"
      },
      "score":{
        "type": "integer"
      },
      "brand":{
        "type": "keyword",
        "copy_to": "all"
      },
      "city":{
        "type": "keyword"
      },
      "starName":{
        "type": "keyword"
      },
      "business":{
        "type": "keyword",
        "copy_to": "all"
      },
      "location":{
        "type": "geo_point"
      },
      "pic":{
        "type": "keyword",
        "index": false
      },
      "all":{
        "type": "text",
        "analyzer": "text_anlyzer",
        "search_analyzer": "ik_smart"
      },
      "suggestion":{
          "type": "completion",
          "analyzer": "completion_analyzer"
      }
    }
  }
}
```

### JavaAPI

![](https://cdn.xn2001.com/img/2021/20211025113007.png)



è§£æå“åº”çš„ä»£ç å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20211025113011.png)

## æ•°æ®åŒæ­¥

elasticsearch ä¸­çš„æ•°æ®æ¥è‡ªäº mysq læ•°æ®åº“ï¼Œå› æ­¤ mysql æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œelasticsearch ä¹Ÿå¿…é¡»è·Ÿç€æ”¹å˜ï¼Œè¿™ä¸ªå°±æ˜¯ elasticsearch ä¸ mysql ä¹‹é—´çš„**æ•°æ®åŒæ­¥**



![](https://cdn.xn2001.com/img/2021/20211025163219.png)

å¸¸è§çš„æ•°æ®åŒæ­¥æ–¹æ¡ˆæœ‰ä¸‰ç§

- åŒæ­¥è°ƒç”¨
- å¼‚æ­¥é€šçŸ¥
- ç›‘å¬ binlog

### åŒæ­¥è°ƒç”¨

æ–¹æ¡ˆä¸€ï¼šåŒæ­¥è°ƒç”¨

![](https://cdn.xn2001.com/img/2021/20211025163313.png)

- hotel-demoå¯¹å¤–æä¾›æ¥å£ï¼Œç”¨æ¥ä¿®æ”¹ elasticsearch ä¸­çš„æ•°æ®
- é…’åº—ç®¡ç†æœåŠ¡åœ¨å®Œæˆæ•°æ®åº“æ“ä½œåï¼Œç›´æ¥è°ƒç”¨ hotel-demo æä¾›çš„æ¥å£

### å¼‚æ­¥é€šçŸ¥

æ–¹æ¡ˆäºŒï¼šå¼‚æ­¥é€šçŸ¥

![](https://cdn.xn2001.com/img/2021/20211025163346.png)

- hotel-admin å¯¹ mysql æ•°æ®åº“æ•°æ®å®Œæˆå¢ã€åˆ ã€æ”¹åï¼Œå‘é€ MQ æ¶ˆæ¯
- hotel-demoç›‘å¬ MQï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯åå®Œæˆ elasticsearch æ•°æ®ä¿®æ”¹

### ç›‘å¬binlog

æ–¹æ¡ˆä¸‰ï¼šç›‘å¬binlog

![](https://cdn.xn2001.com/img/2021/20211025163428.png)

- mysql å¼€å¯ binlog åŠŸèƒ½
- mysql å®Œæˆå¢ã€åˆ ã€æ”¹æ“ä½œéƒ½ä¼šè®°å½•åœ¨ binlog ä¸­
- hotel-demo åŸºäºcanal ç›‘å¬ binlog å˜åŒ–ï¼Œå®æ—¶æ›´æ–° elasticsearch ä¸­çš„å†…å®¹

### ä¼˜ç¼ºç‚¹

æ–¹å¼ä¸€ï¼šåŒæ­¥è°ƒç”¨

- ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç²—æš´
- ç¼ºç‚¹ï¼šä¸šåŠ¡è€¦åˆåº¦é«˜

æ–¹å¼äºŒï¼šå¼‚æ­¥é€šçŸ¥

- ä¼˜ç‚¹ï¼šä½è€¦åˆï¼Œå®ç°éš¾åº¦ä¸€èˆ¬
- ç¼ºç‚¹ï¼šä¾èµ– mq çš„å¯é æ€§

æ–¹å¼ä¸‰ï¼šç›‘å¬binlog

- ä¼˜ç‚¹ï¼šå®Œå…¨è§£é™¤æœåŠ¡é—´è€¦åˆ
- ç¼ºç‚¹ï¼šå¼€å¯ binlog å¢åŠ æ•°æ®åº“è´Ÿæ‹…ã€å®ç°å¤æ‚åº¦é«˜

### å®ç°æ–¹å¼

æˆ‘ä»¬ä»¥**å¼‚æ­¥é€šçŸ¥**ä¸ºä¾‹ï¼Œä½¿ç”¨ MQ æ¶ˆæ¯ä¸­é—´ä»¶

MQç»“æ„å¦‚å›¾ï¼š

![](https://cdn.xn2001.com/img/2021/20211025163734.png)

**å¼•å…¥ä¾èµ–**ï¼Œåœ¨ hotel-adminã€hotel-demo ä¸­å¼•å…¥ rabbitmq çš„ä¾èµ–ï¼š

```xml
<!--amqp-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

**å£°æ˜é˜Ÿåˆ—äº¤æ¢æœº**

```java
public class MQConstants {
    /**
     * äº¤æ¢æœº
     */
    public final static String HOTEL_EXCHANGE = "hotel.topic";
    /**
     * ç›‘å¬æ–°å¢å’Œä¿®æ”¹çš„é˜Ÿåˆ—
     */
    public final static String HOTEL_INSERT_QUEUE = "hotel.insert.queue";
    /**
     * ç›‘å¬åˆ é™¤çš„é˜Ÿåˆ—
     */
    public final static String HOTEL_DELETE_QUEUE = "hotel.delete.queue";
    /**
     * æ–°å¢æˆ–ä¿®æ”¹çš„RoutingKey
     */
    public final static String HOTEL_INSERT_KEY = "hotel.insert";
    /**
     * åˆ é™¤çš„RoutingKey
     */
    public final static String HOTEL_DELETE_KEY = "hotel.delete";
}
```

æ¶ˆæ¯æ¥æ”¶æ–¹


```java
@Configuration
public class MqConfig {
    @Bean
    public TopicExchange topicExchange() {
        return new TopicExchange(MqConstants.HOTEL_EXCHANGE, true, false);
    }

    @Bean
    public Queue insertQueue() {
        return new Queue(MqConstants.HOTEL_INSERT_QUEUE, true);
    }

    @Bean
    public Queue deleteQueue() {
        return new Queue(MqConstants.HOTEL_DELETE_QUEUE, true);
    }

    @Bean
    public Binding insertQueueBinding() {
        return BindingBuilder.bind(insertQueue()).to(topicExchange()).with(MqConstants.HOTEL_INSERT_KEY);
    }

    @Bean
    public Binding deleteQueueBinding() {
        return BindingBuilder.bind(deleteQueue()).to(topicExchange()).with(MqConstants.HOTEL_DELETE_KEY);
    }
}
```

æ¶ˆæ¯å‘é€æ–¹

```java
rabbitTemplate.convertAndSend(MQConstants.HOTEL_EXCHANGE, MQConstants.HOTEL_INSERT_KEY, hotel.getId());

rabbitTemplate.convertAndSend(MQConstants.HOTEL_EXCHANGE, MQConstants.HOTEL_DELETE_KEY, id);
```

 æ¶ˆæ¯æ¥æ”¶æ–¹

```java
@Override
public void insertById(Long id) {
    try {
        // æ ¹æ®idæŸ¥è¯¢é…’åº—æ•°æ®
        Hotel hotel = getById(id);
        // è½¬æ¢ä¸ºæ–‡æ¡£ç±»å‹
        HotelDoc hotelDoc = new HotelDoc(hotel);

        IndexRequest request = new IndexRequest("hotel").id(hotel.getId().toString());
        request.source(JSON.toJSONString(hotelDoc), XContentType.JSON);
        client.index(request, RequestOptions.DEFAULT);
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}

@Override
public void deleteById(Long id) {
    try {
        DeleteRequest request = new DeleteRequest("hotel", id.toString());
        client.delete(request, RequestOptions.DEFAULT);
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}
```

```java
@Component
public class HotelListener {

    @Autowired
    private HotelService hotelService;

    /**
     * ç›‘å¬é…’åº—æ–°å¢æˆ–ä¿®æ”¹çš„ä¸šåŠ¡
     *
     * @param id é…’åº—id
     */
    @RabbitListener(queues = MqConstants.HOTEL_INSERT_QUEUE)
    public void listenHotelInsertOrUpdate(Long id) {
        hotelService.insertById(id);
    }

    /**
     * ç›‘å¬é…’åº—åˆ é™¤çš„ä¸šåŠ¡
     *
     * @param id é…’åº—id
     */
    @RabbitListener(queues = MqConstants.HOTEL_DELETE_QUEUE)
    public void listenHotelDelete(Long id) {
        hotelService.deleteById(id);
    }
}
```

# Elasticsearché›†ç¾¤

å•æœºçš„ Elasticsearch åšæ•°æ®å­˜å‚¨ï¼Œå¿…ç„¶é¢ä¸´ä¸¤ä¸ªé—®é¢˜ï¼šæµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜ã€å•ç‚¹æ•…éšœé—®é¢˜ã€‚

è§£å†³æ–¹æ¡ˆï¼š

- æµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜ï¼šå°†ç´¢å¼•åº“ä»é€»è¾‘ä¸Šæ‹†åˆ†ä¸ºNä¸ªåˆ†ç‰‡ï¼ˆshardï¼‰ï¼Œå­˜å‚¨åˆ°å¤šä¸ªèŠ‚ç‚¹
- å•ç‚¹æ•…éšœé—®é¢˜ï¼šå°†åˆ†ç‰‡æ•°æ®åœ¨ä¸åŒèŠ‚ç‚¹å¤‡ä»½ï¼ˆreplica ï¼‰

**ESé›†ç¾¤ç›¸å…³æ¦‚å¿µ**ï¼š

* é›†ç¾¤ï¼ˆclusterï¼‰ï¼šä¸€ç»„æ‹¥æœ‰å…±åŒçš„ cluster name çš„ èŠ‚ç‚¹ã€‚

* èŠ‚ç‚¹ï¼ˆnode)  ï¼šé›†ç¾¤ä¸­çš„ä¸€ä¸ª Elasticearch å®ä¾‹

* åˆ†ç‰‡ï¼ˆshardï¼‰ï¼šç´¢å¼•å¯ä»¥è¢«æ‹†åˆ†ä¸ºä¸åŒçš„éƒ¨åˆ†è¿›è¡Œå­˜å‚¨ï¼Œç§°ä¸ºåˆ†ç‰‡ã€‚**åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªç´¢å¼•çš„ä¸åŒåˆ†ç‰‡å¯ä»¥æ‹†åˆ†åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸­ï¼Œè§£å†³æ•°æ®é‡å¤ªå¤§ï¼Œå•ç‚¹å­˜å‚¨é‡æœ‰é™çš„é—®é¢˜ã€‚**

![](https://cdn.xn2001.com/img/2022/202205071006783.png)

> æ­¤å¤„ï¼Œæˆ‘ä»¬æŠŠæ•°æ®åˆ†æˆ3ç‰‡ï¼šshard0ã€shard1ã€shard2
>
> ä¸»åˆ†ç‰‡ï¼ˆPrimary shardï¼‰ï¼šç›¸å¯¹äºå‰¯æœ¬åˆ†ç‰‡çš„å®šä¹‰ã€‚
>
> å‰¯æœ¬åˆ†ç‰‡ï¼ˆReplica shardï¼‰æ¯ä¸ªä¸»åˆ†ç‰‡å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå‰¯æœ¬ï¼Œæ•°æ®å’Œä¸»åˆ†ç‰‡ä¸€æ ·ã€‚

æ•°æ®å¤‡ä»½å¯ä»¥ä¿è¯é«˜å¯ç”¨ï¼Œä½†æ˜¯æ¯ä¸ªåˆ†ç‰‡å¤‡ä»½ä¸€ä»½åœ¨èŠ‚ç‚¹ä¸Šï¼Œæ‰€éœ€è¦çš„èŠ‚ç‚¹æ•°é‡å°±ä¼šç¿»å€ï¼Œæˆæœ¬å¤ªé«˜ã€‚ä¸ºäº†åœ¨é«˜å¯ç”¨å’Œæˆæœ¬é—´å¯»æ±‚å¹³è¡¡

- é¦–å…ˆå¯¹æ•°æ®åˆ†ç‰‡ï¼Œå­˜å‚¨åˆ°ä¸åŒèŠ‚ç‚¹
- ç„¶åå¯¹æ¯ä¸ªåˆ†ç‰‡è¿›è¡Œå¤‡ä»½ï¼Œæ”¾åˆ°å¯¹æ–¹èŠ‚ç‚¹ï¼Œ**å®Œæˆäº’ç›¸å¤‡ä»½**

è¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘æ‰€éœ€è¦çš„æœåŠ¡èŠ‚ç‚¹æ•°é‡ï¼Œå¦‚å›¾ï¼Œæˆ‘ä»¬ä»¥3åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡å¤‡ä»½ä¸€ä»½ä¸ºä¾‹ï¼š

![](https://cdn.xn2001.com/img/2022/202205071006790.png)

ç°åœ¨ï¼Œæ¯ä¸ªåˆ†ç‰‡éƒ½æœ‰1ä¸ªå¤‡ä»½ï¼Œå­˜å‚¨åœ¨3ä¸ªèŠ‚ç‚¹ï¼š

- node0ï¼šä¿å­˜äº†åˆ†ç‰‡0å’Œ1
- node1ï¼šä¿å­˜äº†åˆ†ç‰‡0å’Œ2
- node2ï¼šä¿å­˜äº†åˆ†ç‰‡1å’Œ2

## éƒ¨ç½²é›†ç¾¤

### æ­å»ºElasticsearch 

æˆ‘ä»¬ä¼šåœ¨å•æœºä¸Šåˆ©ç”¨ Docker å®¹å™¨è¿è¡Œå¤šä¸ª Elasticsearch å®ä¾‹æ¥æ¨¡æ‹Ÿé›†ç¾¤ã€‚

å¯ä»¥ç›´æ¥ä½¿ç”¨ docker-compose æ¥å®Œæˆï¼Œè¿™è¦æ±‚ä½ çš„Linuxè™šæ‹Ÿæœºè‡³å°‘æœ‰**4G**ä»¥ä¸Šçš„å†…å­˜ç©ºé—´ã€‚

docker-compose.yml

```yml
version: '2.2'
services:
  es01:
    image: elasticsearch:7.12.1
    container_name: es01
    environment:
      - node.name=es01
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es02,es03
      - cluster.initial_master_nodes=es01,es02,es03
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - data01:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
    networks:
      - elastic
  es02:
    image: elasticsearch:7.12.1
    container_name: es02
    environment:
      - node.name=es02
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es01,es03
      - cluster.initial_master_nodes=es01,es02,es03
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - data02:/usr/share/elasticsearch/data
    ports:
      - 9201:9200
    networks:
      - elastic
  es03:
    image: elasticsearch:7.12.1
    container_name: es03
    environment:
      - node.name=es03
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es01,es02
      - cluster.initial_master_nodes=es01,es02,es03
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - data03:/usr/share/elasticsearch/data
    networks:
      - elastic
    ports:
      - 9202:9200
volumes:
  data01:
    driver: local
  data02:
    driver: local
  data03:
    driver: local
networks:
  elastic:
    driver: bridge
```

ä¿®æ”¹ Linux ç³»ç»Ÿæƒé™ï¼Œä¿®æ”¹ `/etc/sysctl.conf` æ–‡ä»¶

```sh
vi /etc/sysctl.conf
```

æ·»åŠ ä¸‹é¢çš„å†…å®¹

```sh
vm.max_map_count=262144
```

è®©é…ç½®ç”Ÿæ•ˆï¼š

```sh
sysctl -p
```

é€šè¿‡docker-composeå¯åŠ¨é›†ç¾¤

```sh
docker-compose up -d
```

### é›†ç¾¤çŠ¶æ€ç›‘æ§

kibana å¯ä»¥ç›‘æ§ Elasticsearch é›†ç¾¤ï¼Œä½†æ˜¯æ›´æ¨èä½¿ç”¨ [cerebro](https://github.com/lmenezes/cerebro)

ä¸‹è½½è§£å‹æ‰“å¼€ /bin/cerebro.bat

è®¿é—® http://localhost:9000 å³å¯è¿›å…¥ç®¡ç†ç•Œé¢

![](https://cdn.xn2001.com/img/2022/202205071018030.png)

è¾“å…¥ä»»æ„èŠ‚ç‚¹çš„åœ°å€å’Œç«¯å£ï¼Œç‚¹å‡» connect 

![](https://cdn.xn2001.com/img/2022/202205071018761.png)

ç»¿è‰²çš„çº¿æ¡ä»£è¡¨é›†ç¾¤å¤„äºç»¿è‰²ï¼ˆå¥åº·çŠ¶æ€ï¼‰

### åˆ›å»ºç´¢å¼•åº“

æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ cerebro åˆ›å»ºç´¢å¼•åº“ï¼Œå½“ç„¶ä½ éœ€è¦ä½¿ç”¨ kibana ä¹Ÿå¯ä»¥ã€‚

![](https://cdn.xn2001.com/img/2022/202205071020771.png)

å¡«å†™ç´¢å¼•åº“ä¿¡æ¯

![](https://cdn.xn2001.com/img/2022/202205071023380.png)

å›åˆ°é¦–é¡µï¼Œå³å¯æŸ¥çœ‹ç´¢å¼•åº“åˆ†ç‰‡æ•ˆæœ

![](https://cdn.xn2001.com/img/2022/202205071024397.png)

## é›†ç¾¤èŒè´£åˆ’åˆ†

Elasticsearch ä¸­é›†ç¾¤èŠ‚ç‚¹æœ‰ä¸åŒçš„èŒè´£åˆ’åˆ†

![](https://cdn.xn2001.com/img/2022/202205071029258.png)

**é»˜è®¤æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä¸­çš„ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½åŒæ—¶å…¼èŒä¸Šè¿°å››ç§è§’è‰²ã€‚**

çœŸå®çš„é›†ç¾¤ä¸€å®šè¦å°†é›†ç¾¤èŒè´£åˆ†ç¦»

- master èŠ‚ç‚¹ï¼šå¯¹ CPU è¦æ±‚é«˜ï¼Œä½†æ˜¯å†…å­˜è¦æ±‚ä½
- data èŠ‚ç‚¹ï¼šå¯¹ CPU å’Œå†…å­˜è¦æ±‚éƒ½é«˜
- coordinating èŠ‚ç‚¹ï¼šå¯¹ç½‘ç»œå¸¦å®½ã€CPU è¦æ±‚é«˜

èŒè´£åˆ†ç¦»å¯ä»¥è®©æˆ‘ä»¬æ ¹æ®ä¸åŒèŠ‚ç‚¹çš„éœ€æ±‚åˆ†é…ä¸åŒçš„ç¡¬ä»¶å»éƒ¨ç½²ã€‚è€Œä¸”é¿å…ä¸šåŠ¡ä¹‹é—´çš„äº’ç›¸å¹²æ‰°ã€‚

![](https://cdn.xn2001.com/img/2022/202205071029263.png)



## é›†ç¾¤è„‘è£‚é—®é¢˜

è„‘è£‚æ˜¯å› ä¸ºé›†ç¾¤ä¸­çš„èŠ‚ç‚¹å¤±è”å¯¼è‡´çš„ã€‚

ä¾‹å¦‚ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œä¸»èŠ‚ç‚¹ node1 ä¸å…¶å®ƒèŠ‚ç‚¹å¤±è”ã€‚

![](https://cdn.xn2001.com/img/2022/202205071029267.png)

æ­¤æ—¶ï¼Œnode2 å’Œ node3 è®¤ä¸º node1 å®•æœºï¼Œå°±ä¼šé‡æ–°é€‰ä¸»ã€‚

![](https://cdn.xn2001.com/img/2022/202205071344676.png)

å½“ node3 å½“é€‰åï¼Œé›†ç¾¤ç»§ç»­å¯¹å¤–æä¾›æœåŠ¡ï¼Œnode2 å’Œ node3 è‡ªæˆé›†ç¾¤ï¼Œnode1 è‡ªæˆé›†ç¾¤ï¼Œä¸¤ä¸ªé›†ç¾¤æ•°æ®ä¸åŒæ­¥ï¼Œå‡ºç°æ•°æ®å·®å¼‚ã€‚

å½“ç½‘ç»œæ¢å¤åï¼Œå› ä¸ºé›†ç¾¤ä¸­æœ‰ä¸¤ä¸ª master èŠ‚ç‚¹ï¼Œé›†ç¾¤çŠ¶æ€çš„ä¸ä¸€è‡´ï¼Œå‡ºç°è„‘è£‚çš„æƒ…å†µã€‚

![](https://cdn.xn2001.com/img/2022/202205071344829.png)



è§£å†³è„‘è£‚çš„æ–¹æ¡ˆæ˜¯ï¼Œè¦æ±‚é€‰ç¥¨è¶…è¿‡ **(eligibleèŠ‚ç‚¹æ•°é‡+1)/2** æ‰èƒ½å½“é€‰ä¸º masterï¼Œå› æ­¤ eligible èŠ‚ç‚¹æ•°é‡æœ€å¥½æ˜¯å¥‡æ•°ã€‚å¯¹åº”é…ç½®é¡¹æ˜¯`discovery.zen.minimum_master_nodes`ï¼Œåœ¨ç‰ˆæœ¬ 7.0 ä»¥åï¼Œå·²ç»æˆä¸ºé»˜è®¤é…ç½®ï¼Œå› æ­¤ä¸€èˆ¬ä¸ä¼šå‘ç”Ÿè„‘è£‚é—®é¢˜ã€‚

ä¾‹å¦‚ï¼š3ä¸ªèŠ‚ç‚¹å½¢æˆçš„é›†ç¾¤ï¼Œé€‰ç¥¨å¿…é¡»è¶…è¿‡ (3+1)/2 ï¼Œä¹Ÿå°±æ˜¯ 2 ç¥¨ã€‚node3 å¾—åˆ° node2 å’Œ node3 çš„é€‰ç¥¨ï¼Œå½“é€‰ä¸º masterã€‚node1 åªæœ‰è‡ªå·± 1 ç¥¨ï¼Œæ²¡æœ‰å½“é€‰ã€‚é›†ç¾¤ä¸­ä¾ç„¶åªæœ‰1ä¸ªä¸»èŠ‚ç‚¹ï¼Œæ²¡æœ‰å‡ºç°è„‘è£‚ã€‚

## é›†ç¾¤åˆ†å¸ƒå¼å­˜å‚¨

å½“æ–°å¢æ–‡æ¡£æ—¶ï¼Œåº”è¯¥ä¿å­˜åˆ°ä¸åŒåˆ†ç‰‡ï¼Œä¿è¯æ•°æ®å‡è¡¡ï¼Œé‚£ä¹ˆ coordinating node å¦‚ä½•ç¡®å®šæ•°æ®è¯¥å­˜å‚¨åˆ°å“ªä¸ªåˆ†ç‰‡å‘¢ï¼Ÿ

Elasticsearch ä¼šé€šè¿‡ hash ç®—æ³•æ¥è®¡ç®—æ–‡æ¡£åº”è¯¥å­˜å‚¨åˆ°å“ªä¸ªåˆ†ç‰‡

![](https://cdn.xn2001.com/img/2022/202205071412275.png)

- _routing é»˜è®¤æ˜¯æ–‡æ¡£çš„ id
- ç®—æ³•ä¸åˆ†ç‰‡æ•°é‡æœ‰å…³ï¼Œå› æ­¤ç´¢å¼•åº“ä¸€æ—¦åˆ›å»ºï¼Œåˆ†ç‰‡æ•°é‡ä¸èƒ½ä¿®æ”¹ï¼

æ–°å¢æ–‡æ¡£çš„æµç¨‹å¦‚ä¸‹å›¾ï¼Œ

1. æ–°å¢ä¸€ä¸ª id=1 çš„æ–‡æ¡£
2. å¯¹ id åš hash è¿ç®—ï¼Œå‡å¦‚å¾—åˆ°çš„æ˜¯ 2ï¼Œåˆ™åº”è¯¥å­˜å‚¨åˆ° shard-2
3. shard-2 çš„ä¸»åˆ†ç‰‡åœ¨ node3 èŠ‚ç‚¹ï¼Œå°†æ•°æ®è·¯ç”±åˆ° node3ï¼Œnode3 ä¿å­˜æ–‡æ¡£
4. åŒæ­¥ç»™ shard-2 çš„å‰¯æœ¬åˆ†ç‰‡2(R-2)ï¼Œåœ¨ node2 èŠ‚ç‚¹
5. è¿”å›ç»“æœç»™ coordinating-node èŠ‚ç‚¹(node1)

![](https://cdn.xn2001.com/img/2022/202205071412283.png)

## é›†ç¾¤åˆ†å¸ƒå¼æŸ¥è¯¢

Elasticsearch æŸ¥è¯¢åˆ†æˆä¸¤ä¸ªé˜¶æ®µ

- scatter phaseï¼šåˆ†æ•£é˜¶æ®µï¼Œcoordinating node ä¼šæŠŠè¯·æ±‚åˆ†å‘åˆ°æ¯ä¸€ä¸ªåˆ†ç‰‡ã€‚

- gather phaseï¼šèšé›†é˜¶æ®µï¼Œcoordinating node æ±‡æ€» data node çš„æœç´¢ç»“æœï¼Œå¹¶å¤„ç†ä¸ºæœ€ç»ˆç»“æœé›†è¿”å›ç»™ç”¨æˆ·ã€‚

![](https://cdn.xn2001.com/img/2022/202205071422105.png)



## é›†ç¾¤æ•…éšœè½¬ç§»

é›†ç¾¤çš„ master èŠ‚ç‚¹ä¼šç›‘æ§é›†ç¾¤ä¸­çš„èŠ‚ç‚¹çŠ¶æ€ï¼Œå¦‚æœå‘ç°æœ‰èŠ‚ç‚¹å®•æœºï¼Œä¼šç«‹å³å°†å®•æœºèŠ‚ç‚¹çš„åˆ†ç‰‡æ•°æ®è¿ç§»åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ï¼Œè¿™ä¸ªå«åšæ•…éšœè½¬ç§»ã€‚

ä¾‹å¦‚ä¸€ä¸ªé›†ç¾¤ç»“æ„å¦‚å›¾ï¼Œä¸‰ä¸ªéƒ½æ˜¯å¥åº·çš„ã€‚

![](https://cdn.xn2001.com/img/2022/202205071516134.png)

ç°åœ¨ï¼Œnode1 æ˜¯ä¸»èŠ‚ç‚¹ï¼Œå…¶å®ƒä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ä»èŠ‚ç‚¹ã€‚çªç„¶ï¼Œnode1 å‘ç”Ÿäº†æ•…éšœ

![](https://cdn.xn2001.com/img/2022/202205071516139.png)



å®•æœºåçš„ç¬¬ä¸€ä»¶äº‹ï¼Œéœ€è¦é‡æ–°é€‰ä¸»ï¼Œä¾‹å¦‚é€‰ä¸­äº† node2

![](https://cdn.xn2001.com/img/2022/202205071516685.png)



node2 æˆä¸ºä¸»èŠ‚ç‚¹åï¼Œä¼šæ£€æµ‹é›†ç¾¤ç›‘æ§çŠ¶æ€ï¼Œå°† node1 ä¸Šçš„æ•°æ®è¿ç§»åˆ° node2ã€node3ï¼Œç¡®ä¿æ•°æ®ä¾æ—§æ­£å¸¸è®¿é—®ã€‚

![](https://cdn.xn2001.com/img/2022/202205071516805.png)

# JMeterå‹åŠ›æµ‹è¯•

## å®‰è£…å¯åŠ¨

JMeter ä¾èµ–äºJDKï¼Œæ‰€ä»¥å¿…é¡»ç¡®ä¿å½“å‰è®¡ç®—æœºä¸Šå·²ç»å®‰è£…äº† JDKï¼Œå¹¶ä¸”é…ç½®äº†ç¯å¢ƒå˜é‡ã€‚

Apache Jmeterå®˜ç½‘ä¸‹è½½ï¼Œåœ°å€ï¼šhttp://jmeter.apache.org/download_jmeter.cgi

![](https://cdn.xn2001.com/img/2022/202205081544073.png)

è§£å‹ç¼©å³å¯ä½¿ç”¨ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2022/202205081545678.png)

å…¶ä¸­çš„ bin ç›®å½•å°±æ˜¯æ‰§è¡Œçš„è„šæœ¬ï¼Œå…¶ä¸­åŒ…å«å¯åŠ¨è„šæœ¬

![](https://cdn.xn2001.com/img/2022/202205081545976.png)

åŒå‡»å³å¯è¿è¡Œï¼Œä½†æ˜¯æœ‰ä¸¤ç‚¹æ³¨æ„

- å¯åŠ¨æ—¶é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œè¦è€å¿ƒç­‰å¾…ã€‚
- å¯åŠ¨åç»ˆç«¯ï¼ˆé»‘çª—å£ï¼‰ä¸èƒ½å…³é—­ï¼Œå¦åˆ™ JMeter ä¹Ÿè·Ÿç€å…³é—­ã€‚

![](https://cdn.xn2001.com/img/2022/202205081545691.png)

## ä¿®æ”¹ä¸­æ–‡

é»˜è®¤ JMeter çš„è¯­è¨€æ˜¯è‹±æ–‡ï¼Œéœ€è¦è®¾ç½®

![](https://cdn.xn2001.com/img/2022/202205081547848.png)

![](https://cdn.xn2001.com/img/2022/202205081547110.png)

ä¸Šé¢çš„é…ç½®åªèƒ½ä¿è¯æœ¬æ¬¡è¿è¡Œæ˜¯ä¸­æ–‡ï¼Œå¦‚æœè¦æ°¸ä¹…ä¸­æ–‡ï¼Œéœ€è¦ä¿®æ”¹ JMeter çš„é…ç½®æ–‡ä»¶ã€‚

æ‰“å¼€ JMeter æ–‡ä»¶å¤¹ï¼Œåœ¨ bin ç›®å½•ä¸­æ‰¾åˆ° **jmeter.properties**ï¼Œæ·»åŠ ä¸‹é¢é…ç½®ï¼š

```properties
language=zh_CN
```

![](https://cdn.xn2001.com/img/2022/202205081546219.png)

## åŸºæœ¬ä½¿ç”¨

åœ¨æµ‹è¯•è®¡åˆ’ä¸Šç‚¹é¼ æ ‡å³é”®ï¼Œé€‰æ‹©ã€Œæ·»åŠ  > çº¿ç¨‹ï¼ˆç”¨æˆ·ï¼‰ > çº¿ç¨‹ç»„ã€

![](https://cdn.xn2001.com/img/2022/202205081548692.png)

åœ¨æ–°å¢çš„çº¿ç¨‹ç»„ä¸­ï¼Œå¡«å†™çº¿ç¨‹ä¿¡æ¯

![](https://cdn.xn2001.com/img/2022/202205081549330.png)

åœ¨çº¿ç¨‹ç»„è¿™é‡Œç‚¹é¼ æ ‡å³é”®ï¼Œæ·»åŠ  http è¯·æ±‚

![](https://cdn.xn2001.com/img/2022/202205081551101.png)

ç¼–å†™å–æ ·å™¨å†…å®¹

![](https://cdn.xn2001.com/img/2022/202205081551053.png)

æ·»åŠ ç›‘å¬æŠ¥å‘Š

![](https://cdn.xn2001.com/img/2022/202205081551627.png)

æ±‡æ€»æŠ¥å‘Šç»“æœ

![](https://cdn.xn2001.com/img/2022/202205081548975.png)

æ·»åŠ ç›‘å¬ç»“æœæ ‘

![](https://cdn.xn2001.com/img/2022/202205231440680.png)

å¯Ÿçœ‹ç»“æœæ ‘

![](https://cdn.xn2001.com/img/2022/202205081548982.png)

# Sentineæµé‡ç»„ä»¶

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/10-sentinel-demo
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/10-sentinel-demo

## é›ªå´©é—®é¢˜

> å¾®æœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨ï¼Œå› ä¸ºè°ƒç”¨é“¾ä¸­çš„ä¸€ä¸ªæœåŠ¡æ•…éšœï¼Œå¼•èµ·æ•´ä¸ªé“¾è·¯éƒ½æ— æ³•è®¿é—®çš„æƒ…å†µã€‚

å¾®æœåŠ¡ä¸­ï¼ŒæœåŠ¡é—´è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚ï¼Œä¸€ä¸ªå¾®æœåŠ¡å¾€å¾€ä¾èµ–äºå¤šä¸ªå…¶å®ƒå¾®æœåŠ¡ã€‚

 ![](https://cdn.xn2001.com/img/2022/202205071911137.png)

å¦‚å›¾ï¼Œå¦‚æœæœåŠ¡æä¾›è€…I å‘ç”Ÿäº†æ•…éšœï¼Œå½“å‰çš„åº”ç”¨çš„éƒ¨åˆ†ä¸šåŠ¡å› ä¸ºä¾èµ–äºæœåŠ¡Iï¼Œå› æ­¤ä¹Ÿä¼šè¢«é˜»å¡ã€‚æ­¤æ—¶ï¼Œå…¶å®ƒä¸ä¾èµ–äºæœåŠ¡I çš„ä¸šåŠ¡ä¼¼ä¹ä¸å—å½±å“ã€‚

 ![](https://cdn.xn2001.com/img/2022/202205071911461.png)

ä½†æ˜¯ï¼Œä¾èµ–æœåŠ¡I çš„ä¸šåŠ¡è¯·æ±‚è¢«é˜»å¡ï¼Œåˆ™ tomcat çš„è¿™ä¸ªçº¿ç¨‹ä¸ä¼šé‡Šæ”¾ï¼Œäºæ˜¯è¶Šæ¥è¶Šå¤šçš„ç”¨æˆ·è¯·æ±‚åˆ°æ¥ï¼Œè¶Šæ¥è¶Šå¤šçš„çº¿ç¨‹ä¼šé˜»å¡ã€‚

 ![](https://cdn.xn2001.com/img/2022/202205071911464.png)

æœåŠ¡å™¨æ”¯æŒçš„çº¿ç¨‹å’Œå¹¶å‘æ•°æœ‰é™ï¼Œè¯·æ±‚ä¸€ç›´é˜»å¡ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨èµ„æºè€—å°½ï¼Œ**ä»è€Œå¯¼è‡´æ‰€æœ‰å…¶å®ƒæœåŠ¡éƒ½ä¸å¯ç”¨**ã€‚

ç»¼ä¸Šï¼Œä¾èµ–äºå½“å‰æœåŠ¡çš„å…¶å®ƒæœåŠ¡éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæœ€ç»ˆä¹Ÿéƒ½ä¼šå˜çš„ä¸å¯ç”¨ï¼Œå½¢æˆçº§è”å¤±è´¥ï¼Œè¿™å°±æ˜¯é›ªå´©é—®é¢˜ã€‚

![](https://cdn.xn2001.com/img/2022/202205071911480.png)

è§£å†³é›ªå´©é—®é¢˜çš„å¸¸è§æ–¹å¼æœ‰å››ç§

1. è¶…æ—¶å¤„ç†
2. çº¿ç¨‹éš”ç¦»
3. é™çº§ç†”æ–­
4. é™æµ

> **é™æµ**æ˜¯å¯¹æœåŠ¡çš„ä¿æŠ¤ï¼Œé¿å…å› ç¬é—´é«˜å¹¶å‘æµé‡è€Œå¯¼è‡´æœåŠ¡æ•…éšœï¼Œè¿›è€Œé¿å…é›ªå´©ã€‚æ˜¯ä¸€ç§**é¢„é˜²**æªæ–½ã€‚
>
> **è¶…æ—¶å¤„ç†ã€çº¿ç¨‹éš”ç¦»ã€é™çº§ç†”æ–­**æ˜¯åœ¨éƒ¨åˆ†æœåŠ¡æ•…éšœæ—¶ï¼Œå°†æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´ï¼Œé¿å…é›ªå´©ã€‚æ˜¯ä¸€ç§**è¡¥æ•‘**æªæ–½ã€‚

1.è¶…æ—¶å¤„ç†ï¼šè®¾å®šè¶…æ—¶æ—¶é—´ï¼Œè¯·æ±‚è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å“åº”å°±è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¸ä¼šæ— ä¼‘æ­¢ç­‰å¾…ã€‚

![](https://cdn.xn2001.com/img/2022/202205071936072.png)

2.çº¿ç¨‹éš”ç¦»

![](https://cdn.xn2001.com/img/2022/202205071953573.png)

æ˜¯ä¸€ç§èˆ±å£æ¨¡å¼ï¼Œå¦‚ä¸Šå›¾ï¼Œèˆ¹èˆ±éƒ½ä¼šè¢«éš”æ¿åˆ†ç¦»ä¸ºå¤šä¸ªç‹¬ç«‹ç©ºé—´ï¼Œå½“èˆ¹ä½“ç ´æŸæ—¶ï¼Œåªä¼šå¯¼è‡´éƒ¨åˆ†ç©ºé—´è¿›å…¥ï¼Œå°†æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œé¿å…æ•´ä¸ªèˆ¹ä½“éƒ½è¢«æ·¹æ²¡ã€‚äºæ­¤ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥é™å®šæ¯ä¸ªä¸šåŠ¡èƒ½ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé¿å…è€—å°½æ•´ä¸ª tomcat çš„èµ„æºï¼Œå› æ­¤ä¹Ÿå«çº¿ç¨‹éš”ç¦»ã€‚

![](https://cdn.xn2001.com/img/2022/202205071935351.png)

3.é™çº§ç†”æ–­

æ˜¯ä¸€ç§æ–­è·¯å™¨æ¨¡å¼ï¼šç”±**æ–­è·¯å™¨**ç»Ÿè®¡ä¸šåŠ¡æ‰§è¡Œçš„å¼‚å¸¸æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š**ç†”æ–­**è¯¥ä¸šåŠ¡ï¼Œæ‹¦æˆªè®¿é—®è¯¥ä¸šåŠ¡çš„ä¸€åˆ‡è¯·æ±‚ã€‚

æ–­è·¯å™¨ä¼šç»Ÿè®¡è®¿é—®æŸä¸ªæœåŠ¡çš„è¯·æ±‚æ•°é‡ï¼Œå¼‚å¸¸æ¯”ä¾‹ã€‚

![](https://cdn.xn2001.com/img/2022/202205071956512.png)

å½“å‘ç°è®¿é—®æœåŠ¡ D çš„è¯·æ±‚å¼‚å¸¸æ¯”ä¾‹è¿‡é«˜æ—¶ï¼Œè®¤ä¸ºæœåŠ¡ D æœ‰å¯¼è‡´é›ªå´©çš„é£é™©ï¼Œä¼šæ‹¦æˆªè®¿é—®æœåŠ¡ D çš„ä¸€åˆ‡è¯·æ±‚ï¼Œå½¢æˆç†”æ–­ã€‚

![](https://cdn.xn2001.com/img/2022/202205071956665.png)

4.é™æµ

**æµé‡æ§åˆ¶**ï¼šé™åˆ¶ä¸šåŠ¡è®¿é—®çš„ QPSï¼Œé¿å…æœåŠ¡å› æµé‡çš„çªå¢è€Œæ•…éšœã€‚

![](https://cdn.xn2001.com/img/2022/202205071935370.png)

åœ¨ SpringCloud å½“ä¸­æ”¯æŒå¤šç§æœåŠ¡ä¿æŠ¤æŠ€æœ¯

- [Netfix Hystrix](https://github.com/Netflix/Hystrix)
- [Sentinel](https://github.com/alibaba/Sentinel)
- [Resilience4J](https://github.com/resilience4j/resilience4j)

æ—©æœŸæ¯”è¾ƒæµè¡Œçš„æ˜¯ Hystrix æ¡†æ¶ï¼Œä½†ç›®å‰å›½å†…å®ç”¨æœ€å¹¿æ³›çš„è¿˜æ˜¯é˜¿é‡Œå·´å·´çš„ Sentinel æ¡†æ¶ï¼Œè¿™é‡Œæˆ‘ä»¬åšä¸‹å¯¹æ¯”ï¼š

|                | **Sentinel**                                   | **Hystrix**                   |
| -------------- | ---------------------------------------------- | ----------------------------- |
| éš”ç¦»ç­–ç•¥       | ä¿¡å·é‡éš”ç¦»                                     | çº¿ç¨‹æ± éš”ç¦»/ä¿¡å·é‡éš”ç¦»         |
| ç†”æ–­é™çº§ç­–ç•¥   | åŸºäºæ…¢è°ƒç”¨æ¯”ä¾‹æˆ–å¼‚å¸¸æ¯”ä¾‹                       | åŸºäºå¤±è´¥æ¯”ç‡                  |
| å®æ—¶æŒ‡æ ‡å®ç°   | æ»‘åŠ¨çª—å£                                       | æ»‘åŠ¨çª—å£ï¼ˆåŸºäº RxJavaï¼‰       |
| è§„åˆ™é…ç½®       | æ”¯æŒå¤šç§æ•°æ®æº                                 | æ”¯æŒå¤šç§æ•°æ®æº                |
| æ‰©å±•æ€§         | å¤šä¸ªæ‰©å±•ç‚¹                                     | æ’ä»¶çš„å½¢å¼                    |
| åŸºäºæ³¨è§£çš„æ”¯æŒ | æ”¯æŒ                                           | æ”¯æŒ                          |
| é™æµ           | åŸºäº QPSï¼Œæ”¯æŒåŸºäºè°ƒç”¨å…³ç³»çš„é™æµ               | æœ‰é™çš„æ”¯æŒ                    |
| æµé‡æ•´å½¢       | æ”¯æŒæ…¢å¯åŠ¨ã€åŒ€é€Ÿæ’é˜Ÿæ¨¡å¼                       | ä¸æ”¯æŒ                        |
| ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ | æ”¯æŒ                                           | ä¸æ”¯æŒ                        |
| æ§åˆ¶å°         | å¼€ç®±å³ç”¨ï¼Œå¯é…ç½®è§„åˆ™ã€æŸ¥çœ‹ç§’çº§ç›‘æ§ã€æœºå™¨å‘ç°ç­‰ | ä¸å®Œå–„                        |
| å¸¸è§æ¡†æ¶çš„é€‚é… | Servletã€Spring Cloudã€Dubboã€gRPC  ç­‰         | Servletã€Spring Cloud Netflix |

## åˆè¯†Sentinel

Sentinelæ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾å¾®æœåŠ¡æµé‡æ§åˆ¶ç»„ä»¶ã€‚å®˜ç½‘åœ°å€ï¼šhttps://sentinelguard.io/zh-cn/index.html

Sentinel å…·æœ‰ä»¥ä¸‹ç‰¹å¾

- **ä¸°å¯Œçš„åº”ç”¨åœºæ™¯**ï¼šSentinel æ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿‘ 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯ï¼Œä¾‹å¦‚ç§’æ€ï¼ˆå³çªå‘æµé‡æ§åˆ¶åœ¨ç³»ç»Ÿå®¹é‡å¯ä»¥æ‰¿å—çš„èŒƒå›´ï¼‰ã€æ¶ˆæ¯å‰Šå³°å¡«è°·ã€é›†ç¾¤æµé‡æ§åˆ¶ã€å®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ç­‰ã€‚
- **å®Œå¤‡çš„å®æ—¶ç›‘æ§**ï¼šSentinel åŒæ—¶æä¾›å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚æ‚¨å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°æœºå™¨ç§’çº§æ•°æ®ï¼Œç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µã€‚
- **å¹¿æ³›çš„å¼€æºç”Ÿæ€**ï¼šSentinel æä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶/åº“çš„æ•´åˆæ¨¡å—ï¼Œä¾‹å¦‚ä¸ Spring Cloudã€Dubboã€gRPC çš„æ•´åˆã€‚æ‚¨åªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å¹¶è¿›è¡Œç®€å•çš„é…ç½®å³å¯å¿«é€Ÿåœ°æ¥å…¥ Sentinelã€‚
- **å®Œå–„çš„** **SPI** **æ‰©å±•ç‚¹**ï¼šSentinel æä¾›ç®€å•æ˜“ç”¨ã€å®Œå–„çš„ SPI æ‰©å±•æ¥å£ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°æ‰©å±•æ¥å£æ¥å¿«é€Ÿåœ°å®šåˆ¶é€»è¾‘ã€‚ä¾‹å¦‚å®šåˆ¶è§„åˆ™ç®¡ç†ã€é€‚é…åŠ¨æ€æ•°æ®æºç­‰ã€‚

## æ•´åˆSentinel

ä¸‹è½½å jar åŒ…åï¼Œè¿è¡Œä»£ç ï¼š`java -jar sentinel-dashboard-1.8.1.jar`

å¦‚æœè¦ä¿®æ”¹ Sentinel çš„é»˜è®¤ç«¯å£ã€è´¦æˆ·ã€å¯†ç ï¼Œå¯ä»¥é€šè¿‡ä¸‹åˆ—é…ç½®ï¼š

| **é…ç½®é¡¹**                       | **é»˜è®¤å€¼** | **è¯´æ˜**   |
| -------------------------------- | ---------- | ---------- |
| server.port                      | 8080       | æœåŠ¡ç«¯å£   |
| sentinel.dashboard.auth.username | sentinel   | é»˜è®¤ç”¨æˆ·å |
| sentinel.dashboard.auth.password | sentinel   | é»˜è®¤å¯†ç    |

ä¾‹å¦‚ï¼Œä¿®æ”¹ç«¯å£ï¼š

```sh
java -Dserver.port=8090 -jar sentinel-dashboard-1.8.1.jar
```

è®¿é—® http://localhost:8080 é¡µé¢ï¼Œå°±å¯ä»¥çœ‹åˆ° Sentinel çš„æ§åˆ¶å°äº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205072010468.png)

è´¦å·å’Œå¯†ç é»˜è®¤éƒ½æ˜¯ï¼šsentinel

![](https://cdn.xn2001.com/img/2022/202205072018383.png)

æ­¤æ—¶ç©ºç™½ä¸€ç‰‡ï¼Œè¿˜éœ€è¦æˆ‘ä»¬æ¥æ•´åˆè¿› SpringCloud

å‡†å¤‡å¥½æˆ‘ä»¬çš„é¡¹ç›®ï¼Œåœ¨èµ„æ–™ä¸­ï¼Œç»“æ„å¦‚ä¸‹ï¼š

> è¿™é‡Œè€å¸ˆè®²çš„ç–å¿½äº†ï¼Œæ²¡æœ‰èµ° gateway ç½‘å…³ï¼Œä½†ä¸å½±å“ã€‚
>
> æä¾›çš„èµ„æ–™ä¸­çš„ gateway ç½‘å…³å¸¦äº†æƒé™é…ç½®å¯¼è‡´è¿™é‡Œæˆ‘ä»¬è®¿é—®ä¸äº†ç½‘å…³ï¼ˆä¹‹å‰ä¸Šè¯¾ç•™ä¸‹çš„ï¼‰ï¼Œéœ€è¦åˆ é™¤æ‰å…¶ä¸­çš„ AuthorizeFilter.jar

![](https://cdn.xn2001.com/img/2022/202205072033318.png)

æˆ‘ä»¬åœ¨ order-service ä¸­æ•´åˆ Sentinelï¼Œå¹¶è¿æ¥ Sentinel çš„æ§åˆ¶å°ï¼Œæ­¥éª¤å¦‚ä¸‹

1ï¼‰å¼•å…¥ Sentinel ä¾èµ–

```xml
<!--sentinel-->
<dependency>
    <groupId>com.alibaba.cloud</groupId> 
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

2ï¼‰é…ç½®æ§åˆ¶å°

ä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢å†…å®¹ï¼š

```yaml
server:
  port: 8088
spring:
  cloud: 
    sentinel:
      transport:
        dashboard: localhost:8080
```

3ï¼‰è®¿é—® order-service çš„ä»»æ„ç«¯ç‚¹

æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® http://localhost:10010/order/101ï¼Œå¤šè®¿é—®å‡ æ¬¡ï¼Œå¤šç‚¹å‡ æ¬¡åˆ·æ–°ï¼Œè¿™æ ·æ‰èƒ½è§¦å‘ Sentinel çš„ç›‘æ§ã€‚

ç„¶åå†è®¿é—® Sentinel çš„æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ•ˆæœã€‚

![](https://cdn.xn2001.com/img/2022/202205081430741.png)

## æµé‡æ§åˆ¶

é›ªå´©é—®é¢˜è™½æœ‰å››ç§æ–¹æ¡ˆï¼Œä½†æ˜¯**é™æµæ˜¯é¿å…æœåŠ¡å› çªå‘çš„æµé‡è€Œå‘ç”Ÿæ•…éšœï¼Œæ˜¯å¯¹å¾®æœåŠ¡é›ªå´©é—®é¢˜çš„é¢„é˜²ã€‚**å­¦è¿‡æ¯›ä¸­ç‰¹çš„éƒ½çŸ¥é“ï¼Œã€Šé¢„åˆ¤é£é™©æ‰€åœ¨æ˜¯é˜²èŒƒé£é™©çš„å‰æã€‹ï¼Œæˆ‘ä»¬å…ˆå­¦ä¹ æµé‡æ§åˆ¶ã€‚

### ç°‡ç‚¹é“¾è·¯

å½“è¯·æ±‚è¿›å…¥å¾®æœåŠ¡æ—¶ï¼Œé¦–å…ˆä¼šè®¿é—® DispatcherServletï¼Œç„¶åè¿›å…¥ Controllerã€Serviceã€Mapperï¼Œè¿™æ ·çš„ä¸€ä¸ªè°ƒç”¨é“¾å°±å«åš **ç°‡ç‚¹é“¾è·¯**ã€‚

**ç°‡ç‚¹é“¾è·¯ä¸­è¢«ç›‘æ§çš„æ¯ä¸€ä¸ªæ¥å£å°±æ˜¯ä¸€ä¸ªèµ„æº**ã€‚é»˜è®¤æƒ…å†µä¸‹ Sentinel ä¼šç›‘æ§ SpringMVC çš„æ¯ä¸€ä¸ªç«¯ç‚¹ï¼ˆEndpointï¼Œä¹Ÿå°±æ˜¯ Controller ä¸­çš„æ–¹æ³•ï¼‰ï¼Œå› æ­¤ SpringMVC çš„æ¯ä¸€ä¸ªç«¯ç‚¹ï¼ˆEndpointï¼‰å°±æ˜¯è°ƒç”¨é“¾è·¯ä¸­çš„ä¸€ä¸ªèµ„æºã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆšæ‰è®¿é—®çš„ order-service ä¸­çš„ OrderController ä¸­çš„ç«¯ç‚¹ï¼š/order/{orderId}

![](https://cdn.xn2001.com/img/2022/202205081445779.png)



æµæ§ã€ç†”æ–­ç­‰éƒ½æ˜¯é’ˆå¯¹ç°‡ç‚¹é“¾è·¯ä¸­çš„èµ„æºæ¥è®¾ç½®çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç‚¹å‡»å¯¹åº”èµ„æºåé¢çš„æŒ‰é’®æ¥è®¾ç½®è§„åˆ™ï¼š

- æµæ§ï¼šæµé‡æ§åˆ¶
- é™çº§ï¼šé™çº§ç†”æ–­
- çƒ­ç‚¹ï¼šçƒ­ç‚¹å‚æ•°é™æµï¼Œæ˜¯é™æµçš„ä¸€ç§
- æˆæƒï¼šè¯·æ±‚çš„æƒé™æ§åˆ¶

ç‚¹å‡»èµ„æº /order/{orderId} åé¢çš„æµæ§æŒ‰é’®ï¼Œå°±å¯ä»¥å¼¹å‡ºè¡¨å•ã€‚

![](https://cdn.xn2001.com/img/2022/202205081509045.png)

è¡¨å•ä¸­å¯ä»¥å¡«å†™é™æµè§„åˆ™ï¼Œå¦‚ä¸‹

![](https://cdn.xn2001.com/img/2022/202205081509055.png)

å…¶å«ä¹‰æ˜¯é™åˆ¶ /order/{orderId} è¿™ä¸ªèµ„æºçš„å•æœº QPS ä¸º 1ï¼Œå³æ¯ç§’åªå…è®¸ 1 æ¬¡è¯·æ±‚ï¼Œè¶…å‡ºçš„è¯·æ±‚ä¼šè¢«æ‹¦æˆªå¹¶æŠ¥é”™ã€‚

> éœ€æ±‚ï¼šç»™ /order/{orderId} è¿™ä¸ªèµ„æºè®¾ç½®æµæ§è§„åˆ™ï¼ŒQPS ä¸èƒ½è¶…è¿‡ 5ï¼Œç„¶åæµ‹è¯•ã€‚

1ï¼‰é¦–å…ˆåœ¨ sentinel æ§åˆ¶å°æ·»åŠ é™æµè§„åˆ™

![](https://cdn.xn2001.com/img/2022/202205081513259.png)

2ï¼‰åˆ©ç”¨ jmeter æµ‹è¯•ï¼Œä¸‹é¢æœ‰è®²åˆ° JMeter åŸºç¡€ä½¿ç”¨ã€‚

![](https://cdn.xn2001.com/img/2022/202205081514678.png)

20 ä¸ªç”¨æˆ·ï¼Œ2 ç§’å†…è¿è¡Œå®Œï¼Œè¿™æ ·çš„è¯ QPS å°±æ˜¯ 10ï¼Œè¶…è¿‡äº†æˆ‘ä»¬åœ¨ sentinel è®¾ç½®çš„ 5

å³é”®è¿è¡Œï¼š

![](https://cdn.xn2001.com/img/2022/202205081512845.png)



> æ³¨æ„ï¼Œä¸è¦ç‚¹å‡»èœå•ä¸­çš„æ‰§è¡ŒæŒ‰é’®æ¥è¿è¡Œã€‚

ç»“æœï¼š

![](https://cdn.xn2001.com/img/2022/202205081512850.png)

å¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸçš„è¯·æ±‚æ¯æ¬¡åªæœ‰ 5 ä¸ªã€‚

![](https://cdn.xn2001.com/img/2022/202205081525292.png)

### æµæ§æ¨¡å¼

åœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œç‚¹å‡»é«˜çº§é€‰é¡¹ï¼Œå¯ä»¥é€‰æ‹©ä¸‰ç§**æµæ§æ¨¡å¼**

#### ç›´æ¥æ¨¡å¼

- ç›´æ¥ï¼šç»Ÿè®¡å½“å‰èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶å¯¹å½“å‰èµ„æºç›´æ¥é™æµï¼Œä¹Ÿæ˜¯é»˜è®¤çš„æ¨¡å¼
  - ç›´æ¥å¯¹å½“å‰èµ„æºé™æµ

- å…³è”ï¼šç»Ÿè®¡ä¸å½“å‰èµ„æºç›¸å…³çš„å¦ä¸€ä¸ªèµ„æºï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹å½“å‰èµ„æºé™æµ
  - ç›¸å½“äºé«˜ä¼˜å…ˆçº§èµ„æºè§¦å‘é˜ˆå€¼ï¼Œå¯¹ä½ä¼˜å…ˆçº§èµ„æºé™æµã€‚

- é“¾è·¯ï¼šç»Ÿè®¡ä»æŒ‡å®šé“¾è·¯è®¿é—®åˆ°æœ¬èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹æŒ‡å®šé“¾è·¯é™æµ
  - æ˜¯é’ˆå¯¹è¯·æ±‚æ¥æºçš„é™æµ


![](https://cdn.xn2001.com/img/2022/202205081553073.png)



ä¸Šé¢æˆ‘ä»¬æµ‹è¯•çš„å°±æ˜¯ç›´æ¥æ¨¡å¼ï¼Œé»˜è®¤å°±æ˜¯ç›´æ¥æ¨¡å¼ã€‚

#### å…³è”æ¨¡å¼

ç»Ÿè®¡ä¸å½“å‰èµ„æºç›¸å…³çš„å¦ä¸€ä¸ªèµ„æºï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹å½“å‰èµ„æºé™æµã€‚

**ä½¿ç”¨åœºæ™¯**ï¼šæ¯”å¦‚ç”¨æˆ·æ”¯ä»˜æ—¶éœ€è¦ä¿®æ”¹è®¢å•çŠ¶æ€ï¼ŒåŒæ—¶ç”¨æˆ·è¦æŸ¥è¯¢è®¢å•ã€‚æŸ¥è¯¢å’Œä¿®æ”¹æ“ä½œä¼šäº‰æŠ¢æ•°æ®åº“é”ï¼Œäº§ç”Ÿç«äº‰ã€‚ä¸šåŠ¡éœ€æ±‚æ˜¯ä¼˜å…ˆæ”¯ä»˜å’Œæ›´æ–°è®¢å•çš„ä¸šåŠ¡ï¼Œå› æ­¤å½“ä¿®æ”¹è®¢å•ä¸šåŠ¡è§¦å‘é˜ˆå€¼æ—¶ï¼Œéœ€è¦å¯¹æŸ¥è¯¢è®¢å•ä¸šåŠ¡é™æµã€‚

![](https://cdn.xn2001.com/img/2022/202205081602290.png)

ä¾‹å¦‚ï¼šé…ç½®è§„åˆ™ï¼Œ**å½“ /write èµ„æºè®¿é—®é‡è§¦å‘é˜ˆå€¼æ—¶ï¼Œå°±ä¼šå¯¹ /read èµ„æºé™æµï¼Œé¿å…å½±å“ /write èµ„æºã€‚**

![](https://cdn.xn2001.com/img/2022/202205081602252.png)

æˆ‘ä»¬å»ç¨‹åºä¸­æ¨¡æ‹Ÿï¼š

- åœ¨ OrderController æ–°å»ºä¸¤ä¸ªç«¯ç‚¹ï¼š/order/query å’Œ /order/updateï¼Œæ— éœ€å®ç°ä¸šåŠ¡

- é…ç½®æµæ§è§„åˆ™ï¼Œå½“ /order/ update èµ„æºè¢«è®¿é—®çš„ QPS è¶…è¿‡ 5 æ—¶ï¼Œå¯¹ /order/query è¯·æ±‚é™æµ

1ï¼‰å®šä¹‰ /order/query ç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿè®¢å•æŸ¥è¯¢

```java
@GetMapping("/query")
public String queryOrder() {
    return "æŸ¥è¯¢è®¢å•æˆåŠŸ";
}
```

2ï¼‰å®šä¹‰ /order/update ç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿè®¢å•æ›´æ–°

```java
@GetMapping("/update")
public String updateOrder() {
    return "æ›´æ–°è®¢å•æˆåŠŸ";
}
```

é‡å¯æœåŠ¡ï¼ŒæŸ¥çœ‹ Sentinel æ§åˆ¶å°çš„ç°‡ç‚¹é“¾è·¯ã€‚

![](https://cdn.xn2001.com/img/2022/202205081618267.png)



3ï¼‰é…ç½®æµæ§è§„åˆ™

æƒ³è¦å¯¹å“ªä¸ªç«¯ç‚¹é™æµï¼Œå°±ç‚¹å‡»å“ªä¸ªç«¯ç‚¹åé¢çš„æŒ‰é’®ã€‚æˆ‘ä»¬æ˜¯å¯¹è®¢å•æŸ¥è¯¢ /order/query é™æµ

![](https://cdn.xn2001.com/img/2022/202205081619163.png)åœ¨è¡¨å•ä¸­å¡«å†™æµæ§è§„åˆ™

![](https://cdn.xn2001.com/img/2022/202205081602274.png)

4ï¼‰åœ¨ JMeter æµ‹è¯•

![](https://cdn.xn2001.com/img/2022/202205081619453.png)

å¯ä»¥çœ‹åˆ° 1000 ä¸ªç”¨æˆ·ï¼Œ100 ç§’ï¼Œå› æ­¤ QPS ä¸º10ï¼Œè¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„é˜ˆå€¼ï¼š5

æŸ¥çœ‹ http è¯·æ±‚

![](https://cdn.xn2001.com/img/2022/202205081602280.png)

è¯·æ±‚çš„ç›®æ ‡æ˜¯ /order/updateï¼Œä½†é™æµçš„ç›®æ ‡æ˜¯ /order/queryï¼Œè¿™å°±æ˜¯å…³è”æ¨¡å¼ï¼›æˆ‘ä»¬åœ¨æµè§ˆå™¨è®¿é—® /order/queryï¼Œå¯ä»¥å‘ç°ç¡®å®è¢«é™æµäº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205081620364.png)

#### é“¾è·¯æ¨¡å¼

åªé’ˆå¯¹ä»æŒ‡å®šé“¾è·¯è®¿é—®åˆ°æœ¬èµ„æºçš„è¯·æ±‚åšç»Ÿè®¡ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡é˜ˆå€¼ã€‚

ä¾‹å¦‚æœ‰ä¸¤æ¡è¯·æ±‚é“¾è·¯

- /test1 --> /common

- /test2 --> /common

å¦‚æœåªå¸Œæœ›ç»Ÿè®¡ä» /test2 è¿›å…¥åˆ° /common çš„è¯·æ±‚ï¼Œåˆ™å¯ä»¥è¿™æ ·é…ç½®

![](https://cdn.xn2001.com/img/2022/202205081632892.png)

**å®æˆ˜æ¡ˆä¾‹**

æœ‰æŸ¥è¯¢è®¢å•å’Œåˆ›å»ºè®¢å•ä¸šåŠ¡ï¼Œä¸¤è€…éƒ½éœ€è¦æŸ¥è¯¢å•†å“ã€‚é’ˆå¯¹ä»æŸ¥è¯¢è®¢å•è¿›å…¥åˆ°æŸ¥è¯¢å•†å“çš„è¯·æ±‚ç»Ÿè®¡ï¼Œå¹¶è®¾ç½®é™æµã€‚

1. åœ¨ OrderService ä¸­æ·»åŠ ä¸€ä¸ª queryGoods æ–¹æ³•ï¼Œä¸ç”¨å®ç°ä¸šåŠ¡

2. åœ¨ OrderController ä¸­ï¼Œæ”¹é€  /order/query ç«¯ç‚¹ï¼Œè°ƒç”¨ OrderService ä¸­çš„ queryGoods æ–¹æ³•

3. åœ¨ OrderController ä¸­æ·»åŠ ä¸€ä¸ª /order/save ç«¯ç‚¹ï¼Œè°ƒç”¨ OrderService çš„ queryGoods æ–¹æ³•

4. ç»™ queryGoods è®¾ç½®é™æµè§„åˆ™ï¼Œä» /order/query è¿›å…¥ queryGoods çš„æ–¹æ³•é™åˆ¶ QPS å¿…é¡»å°äº 2

1ï¼‰æ·»åŠ æŸ¥è¯¢å•†å“æ–¹æ³•

åœ¨order-serviceæœåŠ¡ä¸­ï¼Œç»™ OrderService ç±»æ·»åŠ ä¸€ä¸ª queryGoods æ–¹æ³•

```java
public void queryGoods(){
    System.err.println("æŸ¥è¯¢å•†å“");
}
```

2ï¼‰æŸ¥è¯¢è®¢å•æ—¶ï¼ŒæŸ¥è¯¢å•†å“

åœ¨ order-service çš„ OrderController ä¸­ï¼Œä¿®æ”¹ /order/query ç«¯ç‚¹çš„ä¸šåŠ¡é€»è¾‘

```java
@GetMapping("/query")
public String queryOrder() {
    // æŸ¥è¯¢å•†å“
    orderService.queryGoods();
    // æŸ¥è¯¢è®¢å•
    System.out.println("æŸ¥è¯¢è®¢å•");
    return "æŸ¥è¯¢è®¢å•æˆåŠŸ";
}  
```

3ï¼‰æ–°å¢è®¢å•ï¼ŒæŸ¥è¯¢å•†å“

åœ¨ order-service çš„ OrderController ä¸­ï¼Œä¿®æ”¹ /order/save ç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿæ–°å¢è®¢å•ï¼š

```java
@GetMapping("/save")
public String saveOrder() {
    // æŸ¥è¯¢å•†å“
    orderService.queryGoods();
    // æŸ¥è¯¢è®¢å•
    System.out.println("æ–°å¢è®¢å•");
    return "æ–°å¢è®¢å•æˆåŠŸ";
}
```

4ï¼‰ç»™æŸ¥è¯¢å•†å“æ·»åŠ èµ„æºæ ‡è®°

é»˜è®¤æƒ…å†µä¸‹ï¼ŒOrderService ä¸­çš„æ–¹æ³•æ˜¯ä¸è¢« Sentinel ç›‘æ§çš„ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±é€šè¿‡æ³¨è§£æ¥æ ‡è®°è¦ç›‘æ§çš„æ–¹æ³•ã€‚

ç»™ OrderService çš„ queryGoods æ–¹æ³•æ·»åŠ  `@SentinelResource` æ³¨è§£ã€‚

```java
@SentinelResource("goods")
public void queryGoods(){
    System.err.println("æŸ¥è¯¢å•†å“");
}
```

é“¾è·¯æ¨¡å¼ä¸­ï¼Œæ˜¯å¯¹ä¸åŒæ¥æºçš„ä¸¤ä¸ªé“¾è·¯åšç›‘æ§ã€‚ä½†æ˜¯ Sentinel é»˜è®¤ä¼šç»™è¿›å…¥ SpringMVC çš„æ‰€æœ‰è¯·æ±‚è®¾ç½®åŒä¸€ä¸ª root èµ„æºï¼Œä¼šå¯¼è‡´é“¾è·¯æ¨¡å¼å¤±æ•ˆã€‚æˆ‘ä»¬éœ€è¦å…³é—­è¿™ç§å¯¹ SpringMVC çš„èµ„æºèšåˆï¼Œä¿®æ”¹ order-service æœåŠ¡çš„ application.yml æ–‡ä»¶

```yaml
spring:
  cloud:
    sentinel:
      web-context-unify: false # å…³é—­contextæ•´åˆ
```

é‡å¯æœåŠ¡ï¼Œè®¿é—® /order/query å’Œ /order/saveï¼Œå¯ä»¥æŸ¥çœ‹åˆ° Sentinel çš„ç°‡ç‚¹é“¾è·¯è§„åˆ™ä¸­ï¼Œå‡ºç°äº†æ–°çš„èµ„æº

![](https://cdn.xn2001.com/img/2022/202205081633195.png)



5ï¼‰æ·»åŠ æµæ§è§„åˆ™

ç‚¹å‡» goods èµ„æºåé¢çš„æµæ§æŒ‰é’®ï¼Œåœ¨å¼¹å‡ºçš„è¡¨å•ä¸­å¡«å†™ä¸‹é¢ä¿¡æ¯

![](https://cdn.xn2001.com/img/2022/202205081633212.png)



åªç»Ÿè®¡ä» /order/query è¿›å…¥ /goods çš„èµ„æºï¼ŒQPS é˜ˆå€¼ä¸º 2ï¼Œè¶…å‡ºåˆ™è¢«é™æµã€‚

6ï¼‰Jmeteræµ‹è¯•

![](https://cdn.xn2001.com/img/2022/202205081633203.png)

å¯ä»¥çœ‹åˆ°è¿™é‡Œ200ä¸ªç”¨æˆ·ï¼Œ50ç§’å†…å‘å®Œï¼ŒQPSä¸º4ï¼Œè¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„é˜ˆå€¼2

ä¸€ä¸ª http è¯·æ±‚æ˜¯è®¿é—® /order/save

![](https://cdn.xn2001.com/img/2022/202205081858739.png)

è¿è¡Œçš„ç»“æœæ˜¯ /order/save å®Œå…¨ä¸å—å½±å“ã€‚

![](https://cdn.xn2001.com/img/2022/202205081858880.png)

è®¿é—® /order/query

![](https://cdn.xn2001.com/img/2022/202205081633221.png)

è¿è¡Œç»“æœæ˜¯ /order/queryï¼Œæ¯æ¬¡åªæœ‰2ä¸ªé€šè¿‡ã€‚

![](https://cdn.xn2001.com/img/2022/202205081633245.png)

## æµæ§æ•ˆæœ

### å¿«é€Ÿå¤±è´¥

ç»†å¿ƒçš„å°ä¼™ä¼´ä¼šå‘ç°åœ¨æµæ§çš„é«˜çº§é€‰é¡¹ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªæµæ§æ•ˆæœé€‰é¡¹ï¼Œå‰é¢æˆ‘ä»¬çš„æµ‹è¯•éƒ½æ˜¯åŸºæœ¬å¿«é€Ÿå¤±è´¥çš„ã€‚

![](https://cdn.xn2001.com/img/2022/202205081907653.png)

æµæ§æ•ˆæœæ˜¯æŒ‡è¯·æ±‚è¾¾åˆ°æµæ§é˜ˆå€¼æ—¶åº”è¯¥é‡‡å–çš„æªæ–½ï¼ŒåŒ…æ‹¬ä¸‰ç§

- å¿«é€Ÿå¤±è´¥ï¼šè¾¾åˆ°é˜ˆå€¼åï¼Œæ–°çš„è¯·æ±‚ä¼šè¢«ç«‹å³æ‹’ç»å¹¶æŠ›å‡º FlowException å¼‚å¸¸ï¼Œæ˜¯é»˜è®¤çš„å¤„ç†æ–¹å¼ã€‚

- Warm Upï¼šé¢„çƒ­æ¨¡å¼ï¼Œå¯¹è¶…å‡ºé˜ˆå€¼çš„è¯·æ±‚åŒæ ·æ˜¯æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ä½†è¿™ç§æ¨¡å¼é˜ˆå€¼ä¼šåŠ¨æ€å˜åŒ–ï¼Œä»ä¸€ä¸ªè¾ƒå°å€¼é€æ¸å¢åŠ åˆ°æœ€å¤§é˜ˆå€¼ã€‚

- æ’é˜Ÿç­‰å¾…ï¼šè®©æ‰€æœ‰çš„è¯·æ±‚æŒ‰ç…§å…ˆåæ¬¡åºæ’é˜Ÿæ‰§è¡Œï¼Œä¸¤ä¸ªè¯·æ±‚çš„é—´éš”ä¸èƒ½å°äºæŒ‡å®šæ—¶é•¿ã€‚

### Warm up

é˜ˆå€¼ä¸€èˆ¬æ˜¯ä¸€ä¸ªå¾®æœåŠ¡èƒ½æ‰¿æ‹…çš„æœ€å¤§ QPSï¼Œä½†æ˜¯ä¸€ä¸ªæœåŠ¡åˆšåˆšå¯åŠ¨æ—¶ï¼Œä¸€åˆ‡èµ„æºå°šæœªåˆå§‹åŒ–ï¼ˆ**å†·å¯åŠ¨**ï¼‰ï¼Œå¦‚æœç›´æ¥å°† QPS è·‘åˆ°æœ€å¤§å€¼ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡ç¬é—´å®•æœºã€‚

Warm Up ä¹Ÿå«**é¢„çƒ­æ¨¡å¼**ï¼Œæ˜¯åº”å¯¹æœåŠ¡å†·å¯åŠ¨çš„ä¸€ç§æ–¹æ¡ˆã€‚è¯·æ±‚é˜ˆå€¼åˆå§‹å€¼æ˜¯ `maxThreshold / coldFactor`ï¼ŒæŒç»­æŒ‡å®šæ—¶é•¿åï¼Œé€æ¸æé«˜åˆ° maxThreshold å€¼ã€‚è€Œ coldFactor çš„é»˜è®¤å€¼æ˜¯ 3.

ä¾‹å¦‚ï¼Œæˆ‘è®¾ç½® QPS çš„ maxThreshold ä¸º 10ï¼Œé¢„çƒ­æ—¶é—´ä¸º 5 ç§’ï¼Œé‚£ä¹ˆåˆå§‹é˜ˆå€¼å°±æ˜¯ 10 / 3 = 3ï¼Œç„¶ååœ¨ 5 ç§’åé€æ¸å¢é•¿åˆ° 10

![](https://cdn.xn2001.com/img/2022/202205081907114.png)



**æ¡ˆä¾‹**ï¼šç»™ /order/{orderId} è¿™ä¸ªèµ„æºè®¾ç½®é™æµï¼Œæœ€å¤§ QPS ä¸º 10ï¼Œåˆ©ç”¨ Warm Up æ•ˆæœï¼Œé¢„çƒ­æ—¶é•¿ä¸º 5 ç§’ã€‚

1ï¼‰é…ç½®æµæ§è§„åˆ™

![](https://cdn.xn2001.com/img/2022/202205090008173.png)

2ï¼‰JMeter æµ‹è¯•

![](https://cdn.xn2001.com/img/2022/202205090008283.png)

åˆšåˆšå¯åŠ¨æ—¶ï¼Œå¤§éƒ¨åˆ†è¯·æ±‚å¤±è´¥ï¼ŒæˆåŠŸçš„åªæœ‰ 3 ä¸ªï¼Œè¯´æ˜ QPS è¢«é™å®šåœ¨ 3 

![](https://cdn.xn2001.com/img/2022/202205090009927.png)

éšç€æ—¶é—´æ¨ç§»ï¼ŒæˆåŠŸæ¯”ä¾‹è¶Šæ¥è¶Šé«˜

![](https://cdn.xn2001.com/img/2022/202205090009448.png)



åˆ° Sentinel æ§åˆ¶å°æŸ¥çœ‹å®æ—¶ç›‘æ§

![](https://cdn.xn2001.com/img/2022/202205081907395.png)

ä¸€æ®µæ—¶é—´å

![](https://cdn.xn2001.com/img/2022/202205081907398.png)

ç”¨å®˜æ–¹çš„è¯è®²ï¼Œè¯¥æ–¹å¼ä¸»è¦ç”¨äºç³»ç»Ÿé•¿æœŸå¤„äºä½æ°´ä½çš„æƒ…å†µä¸‹ï¼Œå½“æµé‡çªç„¶å¢åŠ æ—¶ï¼Œç›´æ¥æŠŠç³»ç»Ÿæ‹‰å‡åˆ°é«˜æ°´ä½å¯èƒ½ç¬é—´æŠŠç³»ç»Ÿå‹å®ã€‚é€šè¿‡"å†·å¯åŠ¨"ï¼Œè®©é€šè¿‡çš„æµé‡ç¼“æ…¢å¢åŠ ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…é€æ¸å¢åŠ åˆ°é˜ˆå€¼ä¸Šé™ï¼Œç»™å†·ç³»ç»Ÿä¸€ä¸ªé¢„çƒ­çš„æ—¶é—´ï¼Œé¿å…å†·ç³»ç»Ÿè¢«å‹å®çš„æƒ…å†µã€‚

### æ’é˜Ÿç­‰å¾…

å½“è¯·æ±‚è¶…è¿‡ QPS é˜ˆå€¼æ—¶ï¼Œã€Œå¿«é€Ÿå¤±è´¥ã€å’Œ ã€ŒWarm Upã€ä¼šæ‹’ç»æ–°çš„è¯·æ±‚å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚

è€Œæ’é˜Ÿç­‰å¾…åˆ™æ˜¯è®©æ‰€æœ‰è¯·æ±‚è¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰ç…§é˜ˆå€¼å…è®¸çš„æ—¶é—´é—´éš”ä¾æ¬¡æ‰§è¡Œã€‚åæ¥çš„è¯·æ±‚å¿…é¡»ç­‰å¾…å‰é¢æ‰§è¡Œå®Œæˆï¼Œå¦‚æœè¯·æ±‚é¢„æœŸçš„ç­‰å¾…æ—¶é—´è¶…å‡ºæœ€å¤§æ—¶é•¿ï¼Œåˆ™ä¼šè¢«æ‹’ç»ã€‚è¿™ç§æ–¹å¼ä¸¥æ ¼æ§åˆ¶äº†è¯·æ±‚é€šè¿‡çš„é—´éš”æ—¶é—´ï¼Œä¹Ÿå³æ˜¯è®©è¯·æ±‚ä»¥å‡åŒ€çš„é€Ÿåº¦é€šè¿‡ï¼Œå¯¹åº”çš„æ˜¯æ¼æ¡¶ç®—æ³•ã€‚

ä¾‹å¦‚ï¼šQPS = 5ï¼Œæ„å‘³ç€æ¯ 200ms å¤„ç†ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼›timeout = 2000ï¼Œæ„å‘³ç€**é¢„æœŸç­‰å¾…æ—¶é•¿**è¶…è¿‡ 2000ms çš„è¯·æ±‚ä¼šè¢«æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚

æ¯”å¦‚ç°åœ¨ä¸€ä¸‹å­æ¥äº† 12  ä¸ªè¯·æ±‚ï¼Œå› ä¸ºæ¯ 200ms æ‰§è¡Œä¸€ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆé¢„æœŸç­‰å¾…æ—¶é•¿å°±æ˜¯ï¼š

- ç¬¬6ä¸ªè¯·æ±‚çš„**é¢„æœŸç­‰å¾…æ—¶é•¿** =  200 * (6 - 1) = 1000ms
- ç¬¬12ä¸ªè¯·æ±‚çš„é¢„æœŸç­‰å¾…æ—¶é•¿ = 200 * (12-1) = 2200ms

åˆæ¯”å¦‚ä¸‹å›¾ï¼š

![](https://cdn.xn2001.com/img/2022/202205090037622.png)

ç°åœ¨ï¼Œç¬¬ 1 ç§’åŒæ—¶æ¥æ”¶åˆ° 10 ä¸ªè¯·æ±‚ï¼Œä½†ç¬¬ 2 ç§’åªæœ‰ 1 ä¸ªè¯·æ±‚ï¼Œæ­¤æ—¶ QPS çš„æ›²çº¿è¿™æ ·çš„

![](https://cdn.xn2001.com/img/2022/202205081907396.png)

å¦‚æœä½¿ç”¨æ’é˜Ÿç­‰å¾…çš„æµæ§æ•ˆæœï¼Œæ‰€æœ‰è¿›å…¥çš„è¯·æ±‚éƒ½è¦æ’é˜Ÿï¼Œä»¥å›ºå®šçš„ 200ms çš„é—´éš”æ‰§è¡Œï¼ŒQPS ä¼šå˜çš„å¾ˆå¹³æ»‘

![](https://cdn.xn2001.com/img/2022/202205090016702.png)

è¿™ç§æ–¹å¼ä¸»è¦ç”¨äºå¤„ç†é—´éš”æ€§çªå‘çš„æµé‡ï¼Œä¾‹å¦‚æ¶ˆæ¯é˜Ÿåˆ—ã€‚æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼Œåœ¨æŸä¸€ç§’æœ‰å¤§é‡çš„è¯·æ±‚åˆ°æ¥ï¼Œè€Œæ¥ä¸‹æ¥çš„å‡ ç§’åˆ™å¤„äºç©ºé—²çŠ¶æ€ï¼Œæˆ‘ä»¬å¸Œæœ›ç³»ç»Ÿèƒ½å¤Ÿåœ¨æ¥ä¸‹æ¥çš„ç©ºé—²æœŸé—´é€æ¸å¤„ç†è¿™äº›è¯·æ±‚ï¼Œè€Œä¸æ˜¯åœ¨ç¬¬ä¸€ç§’ç›´æ¥æ‹’ç»å¤šä½™çš„è¯·æ±‚ã€‚

**æ¡ˆä¾‹**ï¼šç»™ /order/{orderId} è¿™ä¸ªèµ„æºè®¾ç½®é™æµï¼Œæœ€å¤§ QPS ä¸º 10ï¼Œåˆ©ç”¨æ’é˜Ÿç­‰å¾…çš„æµæ§æ•ˆæœï¼Œè¶…æ—¶æ—¶é•¿è®¾ç½®ä¸º 5s

1ï¼‰æ·»åŠ æµæ§è§„åˆ™

![](https://cdn.xn2001.com/img/2022/202205090011577.png)

2ï¼‰JMeter æµ‹è¯•

![](https://cdn.xn2001.com/img/2022/202205081907171.png)

QPS ä¸º 15ï¼Œå·²ç»è¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„ 10ï¼Œå¦‚æœæ˜¯ä¹‹å‰çš„ã€Œå¿«é€Ÿå¤±è´¥ã€ ã€ã€ŒWarm Upã€æ¨¡å¼ï¼Œè¶…å‡ºçš„è¯·æ±‚åº”è¯¥ä¼šç›´æ¥æŠ¥é”™ã€‚

ä½†æ˜¯æˆ‘ä»¬çœ‹çœ‹ã€Œæ’é˜Ÿç­‰å¾…ã€çš„è¿è¡Œç»“æœ

![](https://cdn.xn2001.com/img/2022/202205081907254.png)

å†å» Sentinel æŸ¥çœ‹å®æ—¶ç›‘æ§çš„ QPS æ›²çº¿

![](https://cdn.xn2001.com/img/2022/202205081907426.png)

QPS éå¸¸å¹³æ»‘ï¼Œä¸€è‡´ä¿æŒåœ¨ 10ï¼Œä½†æ˜¯è¶…å‡ºçš„è¯·æ±‚æ²¡æœ‰è¢«æ‹’ç»ï¼Œè€Œæ˜¯æ”¾å…¥é˜Ÿåˆ—ã€‚å› æ­¤**å“åº”æ—¶é—´**ï¼ˆç­‰å¾…æ—¶é—´ï¼‰ä¼šè¶Šæ¥è¶Šé•¿ã€‚

å½“é˜Ÿåˆ—æ»¡äº†ä»¥åï¼Œæ‰ä¼šæœ‰éƒ¨åˆ†è¯·æ±‚å¤±è´¥

![](https://cdn.xn2001.com/img/2022/202205081907443.png)

## çƒ­ç‚¹å‚æ•°é™æµ

ä¹‹å‰çš„é™æµæ˜¯ç»Ÿè®¡è®¿é—®æŸä¸ªèµ„æºçš„æ‰€æœ‰è¯·æ±‚ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡ QPS é˜ˆå€¼ã€‚è€Œã€Œçƒ­ç‚¹å‚æ•°é™æµã€æ˜¯**åˆ†åˆ«ç»Ÿè®¡å‚æ•°å€¼ç›¸åŒçš„è¯·æ±‚**ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡ QPS é˜ˆå€¼ã€‚

### å…¨å±€å‚æ•°é™æµ

ä¾‹å¦‚ï¼Œä¸€ä¸ªæ ¹æ® id æŸ¥è¯¢å•†å“çš„æ¥å£

![](https://cdn.xn2001.com/img/2022/202205090045292.png)

è®¿é—® /goods/{id} çš„è¯·æ±‚ä¸­ï¼Œid å‚æ•°å€¼ä¼šæœ‰å˜åŒ–ï¼Œã€Œçƒ­ç‚¹å‚æ•°é™æµã€ä¼šæ ¹æ®å‚æ•°å€¼åˆ†åˆ«ç»Ÿè®¡ QPSï¼Œç»Ÿè®¡ç»“æœï¼š

![](https://cdn.xn2001.com/img/2022/202205090046762.png)

å½“ id=1 çš„è¯·æ±‚è§¦å‘é˜ˆå€¼è¢«é™æµæ—¶ï¼Œidå€¼ä¸ä¸º1çš„è¯·æ±‚åˆ™ä¸å—å½±å“ã€‚

é…ç½®ç¤ºä¾‹ï¼šå¯¹ hot è¿™ä¸ªèµ„æºçš„ 0 å·å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰åšç»Ÿè®¡ï¼Œæ¯ 1s **ç›¸åŒå‚æ•°å€¼**çš„è¯·æ±‚æ•°ä¸èƒ½è¶…è¿‡ 5

![](https://cdn.xn2001.com/img/2022/202205090042929.png)

### çƒ­ç‚¹å‚æ•°é™æµ

å‡è®¾ä¸Šé¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªå•†å“æŸ¥è¯¢æ¥å£ï¼Œé‚£ä¹ˆåˆšæ‰çš„é…ç½®ä¸­ï¼Œå¯¹è¿™ä¸ªæ¥å£çš„æ‰€æœ‰å•†å“ä¸€è§†åŒä»ï¼ŒQPS éƒ½é™å®šä¸º 5

è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯èƒ½éƒ¨åˆ†å•†å“æ˜¯çƒ­ç‚¹å•†å“ï¼Œä¾‹å¦‚ç§’æ€å•†å“ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™éƒ¨åˆ†å•†å“çš„ QPS é™åˆ¶ä¸å…¶å®ƒå•†å“ä¸ä¸€æ ·ï¼Œé«˜ä¸€äº›ã€‚é‚£å°±éœ€è¦é…ç½®ã€Œçƒ­ç‚¹å‚æ•°é™æµã€çš„é«˜çº§é€‰é¡¹äº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205090050071.png)

ç»“åˆä¸Šä¸€ä¸ªé…ç½®ï¼Œè¿™é‡Œçš„å«ä¹‰æ˜¯å¯¹ 0 å·çš„ long ç±»å‹å‚æ•°é™æµï¼Œæ¯ 1 ä¸ªç›¸åŒå‚æ•°çš„ QPS ä¸èƒ½è¶…è¿‡ 5ï¼Œæœ‰å¦‚ä¸‹ä¸¤ä¸ªä¾‹å¤–

- å¦‚æœå‚æ•°å€¼æ˜¯ 100ï¼Œåˆ™æ¯ 1s å…è®¸çš„ QPS ä¸º 10
- å¦‚æœå‚æ•°å€¼æ˜¯ 101ï¼Œåˆ™æ¯ 1s å…è®¸çš„ QPS ä¸º 15

**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™ /order/{orderId} è¿™ä¸ªèµ„æºæ·»åŠ ã€Œçƒ­ç‚¹å‚æ•°é™æµã€ï¼Œè§„åˆ™å¦‚ä¸‹

- é»˜è®¤çš„çƒ­ç‚¹å‚æ•°è§„åˆ™æ˜¯æ¯ 1s è¯·æ±‚é‡ä¸è¶…è¿‡ 2
- ç»™ 102 è¿™ä¸ªå‚æ•°è®¾ç½®ä¾‹å¤–ï¼šæ¯ 1s è¯·æ±‚é‡ä¸è¶…è¿‡ 4
- ç»™ 103 è¿™ä¸ªå‚æ•°è®¾ç½®ä¾‹å¤–ï¼šæ¯ 1s è¯·æ±‚é‡ä¸è¶…è¿‡ 10

**æ³¨æ„äº‹é¡¹**ï¼šçƒ­ç‚¹å‚æ•°é™æµå¯¹é»˜è®¤çš„ SpringMVC èµ„æºæ— æ•ˆï¼Œéœ€è¦åˆ©ç”¨ `@SentinelResource` æ³¨è§£æ ‡è®°èµ„æºã€‚

1ï¼‰æ ‡è®°èµ„æº

ç»™ order-service ä¸­çš„ OrderController ä¸­çš„ /order/{orderId} èµ„æºæ·»åŠ æ³¨è§£

![](https://cdn.xn2001.com/img/2022/202205090042942.png)

2ï¼‰çƒ­ç‚¹å‚æ•°é™æµè§„åˆ™

è®¿é—®è¯¥æ¥å£ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ ‡è®°çš„ hot èµ„æºå‡ºç°äº†

![](https://cdn.xn2001.com/img/2022/202205090136368.png)

ç‚¹å‡»å·¦ä¾§èœå•ä¸­**çƒ­ç‚¹è§„åˆ™**èœå•

![](https://cdn.xn2001.com/img/2022/202205090137049.png)

ç‚¹å‡»æ–°å¢ï¼Œå¡«å†™è¡¨å•

![](https://cdn.xn2001.com/img/2022/202205090137574.png)

3ï¼‰JMeter æµ‹è¯•

è¿™é‡Œå‘èµ·è¯·æ±‚çš„ QPS ä¸º 5ï¼ŒåŒ…å« 3 ä¸ª http è¯·æ±‚

![](https://cdn.xn2001.com/img/2022/202205090138955.png)

æ™®é€šå‚æ•°ï¼ŒQPS é˜ˆå€¼ä¸º 2

![](https://cdn.xn2001.com/img/2022/202205090042964.png)

![](https://cdn.xn2001.com/img/2022/202205090042203.png)



ä¾‹å¤–é¡¹ï¼ŒQPS é˜ˆå€¼ä¸º 4

![](https://cdn.xn2001.com/img/2022/202205090140941.png)

![](https://cdn.xn2001.com/img/2022/202205090042238.png)



**ä¾‹å¤–é¡¹ï¼ŒQPS é˜ˆå€¼ä¸º 10**

![](https://cdn.xn2001.com/img/2022/202205090042244.png)

![](https://cdn.xn2001.com/img/2022/202205090140933.png)

## éš”ç¦»å’Œé™çº§

é™æµåªæ˜¯ä¸€ç§é¢„é˜²æªæ–½ï¼Œè™½ç„¶é™æµå¯ä»¥å°½é‡é¿å…å› é«˜å¹¶å‘è€Œå¼•èµ·çš„æœåŠ¡æ•…éšœï¼Œä½†æœåŠ¡è¿˜ä¼šå› ä¸ºå…¶å®ƒåŸå› è€Œæ•…éšœã€‚

è€Œè¦å°†è¿™äº›æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´ï¼Œé¿å…é›ªå´©ï¼Œå°±è¦é **çº¿ç¨‹éš”ç¦»**ï¼ˆèˆ±å£æ¨¡å¼ï¼‰å’Œ**ç†”æ–­é™çº§**æ‰‹æ®µäº†ã€‚

**çº¿ç¨‹éš”ç¦»**ï¼šè°ƒç”¨è€…åœ¨è°ƒç”¨æœåŠ¡æä¾›è€…æ—¶ï¼Œç»™æ¯ä¸ªè°ƒç”¨çš„è¯·æ±‚åˆ†é…ç‹¬ç«‹çº¿ç¨‹æ± ï¼Œå‡ºç°æ•…éšœæ—¶ï¼Œæœ€å¤šæ¶ˆè€—è¿™ä¸ªçº¿ç¨‹æ± å†…èµ„æºï¼Œé¿å…æŠŠè°ƒç”¨è€…çš„æ‰€æœ‰èµ„æºè€—å°½ã€‚

![](https://cdn.xn2001.com/img/2022/202205091001949.png)

**ç†”æ–­é™çº§**ï¼šæ˜¯åœ¨è°ƒç”¨æ–¹è¿™è¾¹åŠ å…¥æ–­è·¯å™¨ï¼Œç»Ÿè®¡å¯¹æœåŠ¡æä¾›è€…çš„è°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨çš„å¤±è´¥æ¯”ä¾‹è¿‡é«˜ï¼Œåˆ™ç†”æ–­è¯¥ä¸šåŠ¡ï¼Œä¸å…è®¸è®¿é—®è¯¥æœåŠ¡çš„æä¾›è€…äº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205091203825.png)

å¯ä»¥çœ‹åˆ°ï¼Œä¸ç®¡æ˜¯çº¿ç¨‹éš”ç¦»è¿˜æ˜¯ç†”æ–­é™çº§ï¼Œéƒ½æ˜¯å¯¹**å®¢æˆ·ç«¯**ï¼ˆè°ƒç”¨æ–¹ï¼‰çš„ä¿æŠ¤ã€‚éœ€è¦åœ¨**è°ƒç”¨æ–¹**å‘èµ·è¿œç¨‹è°ƒç”¨æ—¶åšçº¿ç¨‹éš”ç¦»ã€æˆ–è€…æœåŠ¡ç†”æ–­ã€‚

è€Œæˆ‘ä»¬çš„å¾®æœåŠ¡è¿œç¨‹è°ƒç”¨éƒ½æ˜¯åŸºäº Feign æ¥å®Œæˆçš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°† Feign ä¸ Sentinel æ•´åˆï¼Œåœ¨ Feign é‡Œé¢å®ç°çº¿ç¨‹éš”ç¦»å’ŒæœåŠ¡ç†”æ–­ã€‚

## Feignæ•´åˆSentinel

SpringCloudä¸­ï¼Œå¾®æœåŠ¡è°ƒç”¨éƒ½æ˜¯é€šè¿‡Feignæ¥å®ç°çš„ï¼Œå› æ­¤åšå®¢æˆ·ç«¯ä¿æŠ¤å¿…é¡»æ•´åˆ Feign å’Œ Sentinel

ä¿®æ”¹é…ç½®ï¼Œå¼€å¯ Sentinel åŠŸèƒ½ï¼Œä¿®æ”¹ OrderService çš„ application.yml æ–‡ä»¶ï¼Œå¼€å¯ Feign çš„ Sentinel åŠŸèƒ½

```yaml
feign:
  sentinel:
    enabled: true # å¼€å¯feignå¯¹sentinelçš„æ”¯æŒ
```

æœåŠ¡é™çº§ï¼šè®¿é—®å¤±è´¥åï¼ŒæœåŠ¡

**ç¼–å†™å¤±è´¥é™çº§é€»è¾‘ä»£ç **ï¼Œä¸šåŠ¡å¤±è´¥åï¼Œä¸èƒ½ç›´æ¥æŠ¥é”™ï¼Œè€Œåº”è¯¥è¿”å›ç”¨æˆ·ä¸€ä¸ªå‹å¥½æç¤ºæˆ–è€…é»˜è®¤ç»“æœï¼Œè¿™ä¸ªå°±æ˜¯å¤±è´¥é™çº§é€»è¾‘ã€‚

ç»™ FeignClient ç¼–å†™å¤±è´¥åçš„é™çº§é€»è¾‘

â‘ æ–¹å¼ä¸€ï¼šFallbackClassï¼Œä½†æ— æ³•å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†ã€‚

â‘¡æ–¹å¼äºŒï¼šFallbackFactoryï¼Œå¯ä»¥å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†ï¼Œæˆ‘ä»¬é€‰æ‹©è¿™ç§

è¿™é‡Œæˆ‘ä»¬æ¼”ç¤ºæ–¹å¼äºŒçš„å¤±è´¥é™çº§å¤„ç†ã€‚

**æ­¥éª¤ä¸€**ï¼šåœ¨ feing-api é¡¹ç›®ä¸­å®šä¹‰ç±»ï¼Œå®ç° FallbackFactory

![](https://cdn.xn2001.com/img/2022/202205091209104.png)

```java
package com.xn2001.feign.clients.fallback;

import com.xn2001.feign.clients.UserClient;
import com.xn2001.feign.pojo.User;
import feign.hystrix.FallbackFactory;
import lombok.extern.slf4j.Slf4j;

/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2022/5/9 14:24
 */

@Slf4j
public class UserClientFallbackFactory implements FallbackFactory<UserClient> {
    @Override
    public UserClient create(Throwable throwable) {
       return userClient -> {
           log.error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥",throwable);
           return new User();
       };
    }
}
```

**æ­¥éª¤äºŒ**ï¼šåœ¨ feing-api é¡¹ç›®ä¸­çš„ DefaultFeignConfiguration ç±»ä¸­å°† UserClientFallbackFactory æ³¨å†Œä¸ºä¸€ä¸ªBean

```java
@Bean
public UserClientFallbackFactory userClientFallbackFactory(){
    return new UserClientFallbackFactory();
}
```

**æ­¥éª¤ä¸‰**ï¼šåœ¨ feing-api é¡¹ç›®ä¸­çš„ UserClient æ¥å£ä¸­ä½¿ç”¨ UserClientFallbackFactory

```java
@FeignClient(value = "userservice", fallbackFactory = UserClientFallbackFactory.class)
public interface UserClient {
    @GetMapping("/user/{id}")
    User findById(@PathVariable("id") Long id);
}
```

é‡å¯åï¼Œè®¿é—®ä¸€æ¬¡è®¢å•æŸ¥è¯¢ä¸šåŠ¡ï¼Œç„¶åæŸ¥çœ‹ Sentinel æ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°æ–°çš„ç°‡ç‚¹é“¾è·¯

![](https://cdn.xn2001.com/img/2022/202205091210616.png)

## çº¿ç¨‹éš”ç¦»

çº¿ç¨‹éš”ç¦»ï¼ˆèˆ±å£æ¨¡å¼ï¼‰æœ‰ä¸¤ç§æ–¹å¼å®ç°

- çº¿ç¨‹æ± éš”ç¦»ï¼šç»™æ¯ä¸ªæœåŠ¡è°ƒç”¨ä¸šåŠ¡åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œåˆ©ç”¨çº¿ç¨‹æ± æœ¬èº«å®ç°éš”ç¦»æ•ˆæœã€‚

- ä¿¡å·é‡éš”ç¦»ï¼ˆSentinelé»˜è®¤é‡‡ç”¨ï¼‰ï¼šä¸åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œæ˜¯è®¡æ•°å™¨æ¨¡å¼ï¼Œè®°å½•ä¸šåŠ¡ä½¿ç”¨çš„çº¿ç¨‹æ•°é‡ï¼Œè¾¾åˆ°ä¿¡å·é‡ä¸Šé™æ—¶ï¼Œç¦æ­¢æ–°çš„è¯·æ±‚ã€‚

ä¸¤è€…çš„ä¼˜ç¼ºç‚¹

- çº¿ç¨‹æ± éš”ç¦»ï¼šåŸºäºçº¿ç¨‹æ± æ¨¡å¼ï¼Œæœ‰é¢å¤–å¼€é”€ï¼Œä½†éš”ç¦»æ§åˆ¶æ›´å¼º
- ä¿¡å·é‡éš”ç¦»ï¼šåŸºäºè®¡æ•°å™¨æ¨¡å¼ï¼Œç®€å•ï¼Œå¼€é”€å°

![](https://cdn.xn2001.com/img/2022/202205091501180.png)

![](https://cdn.xn2001.com/img/2022/202205091502961.png)

**Sentinel ä½¿ç”¨çš„æ˜¯ä¿¡å·é‡éš”ç¦»**ï¼Œè€Œ Hystrix åˆ™ä¸¤ç§çº¿ç¨‹éš”ç¦»éƒ½å¯ä»¥ï¼Œ18 å¹´Hystrixå·²ç»åœæ­¢æ›´æ–°ã€‚

å¦‚ä½•ä½¿ç”¨å‘¢ï¼Œåœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä¸¤ç§é˜ˆå€¼ç±»å‹

![](https://cdn.xn2001.com/img/2022/202205091500754.png)

- QPSï¼šå°±æ˜¯æ¯ç§’çš„è¯·æ±‚æ•°ï¼Œä¹‹å‰å·²ç»æ¼”ç¤ºè¿‡ã€‚

- çº¿ç¨‹æ•°ï¼šæ˜¯è¯¥èµ„æºèƒ½ä½¿ç”¨çš„ Tomcat çº¿ç¨‹æ•°çš„æœ€å¤§å€¼ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡é™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œå®ç°**çº¿ç¨‹éš”ç¦»**ï¼ˆèˆ±å£æ¨¡å¼ï¼‰ã€‚

**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™ order-service æœåŠ¡ä¸­çš„ UserClient çš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®æµæ§è§„åˆ™ï¼Œçº¿ç¨‹æ•°ä¸èƒ½è¶…è¿‡ 2ï¼Œç„¶ååˆ©ç”¨ JMeter æµ‹è¯•ã€‚

1ï¼‰é…ç½®éš”ç¦»è§„åˆ™ï¼Œé€‰æ‹© feign æ¥å£åé¢çš„æµæ§æŒ‰é’®

![](https://cdn.xn2001.com/img/2022/202205091507487.png)

![](https://cdn.xn2001.com/img/2022/202205091508076.png)

2ï¼‰JMeter æµ‹è¯•

![](https://cdn.xn2001.com/img/2022/202205091500777.png)

ä¸€æ¬¡å‘ç”Ÿ 10 ä¸ªè¯·æ±‚ï¼Œæœ‰è¾ƒå¤§æ¦‚ç‡å¹¶å‘çº¿ç¨‹æ•°è¶…è¿‡ 2ï¼Œè€Œè¶…å‡ºçš„è¯·æ±‚ä¼šèµ°ä¹‹å‰å®šä¹‰çš„å¤±è´¥é™çº§é€»è¾‘ã€‚

æŸ¥çœ‹è¿è¡Œç»“æœ

![](https://cdn.xn2001.com/img/2022/202205091500739.png)

å‘ç°è™½ç„¶ç»“æœéƒ½æ˜¯é€šè¿‡äº†ï¼Œä¸è¿‡éƒ¨åˆ†è¯·æ±‚å¾—åˆ°çš„å“åº”æ˜¯ã€Œé™çº§ã€è¿”å›çš„ null ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„é™çº§æ–¹æ³•ã€‚

## ç†”æ–­é™çº§

ç†”æ–­é™çº§æ˜¯è§£å†³é›ªå´©é—®é¢˜çš„é‡è¦æ‰‹æ®µã€‚å…¶æ€è·¯æ˜¯ç”±**æ–­è·¯å™¨**ç»Ÿè®¡æœåŠ¡è°ƒç”¨çš„å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è¯·æ±‚æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š**ç†”æ–­**è¯¥æœåŠ¡ã€‚å³æ‹¦æˆªè®¿é—®è¯¥æœåŠ¡çš„ä¸€åˆ‡è¯·æ±‚ï¼›è€Œå½“æœåŠ¡æ¢å¤æ—¶ï¼Œæ–­è·¯å™¨ä¼šæ”¾è¡Œè®¿é—®è¯¥æœåŠ¡çš„è¯·æ±‚ã€‚

æ–­è·¯å™¨æ§åˆ¶ç†”æ–­å’Œæ”¾è¡Œæ˜¯é€šè¿‡çŠ¶æ€æœºæ¥å®Œæˆçš„ï¼Œå¦‚ä¸‹å›¾å°±æ˜¯ä¸€ä¸ªæ–­è·¯å™¨çš„çŠ¶æ€æœº

![](https://cdn.xn2001.com/img/2022/202205091510676.png)

çŠ¶æ€æœºåŒ…æ‹¬ä¸‰ä¸ªçŠ¶æ€

- closedï¼šå…³é—­çŠ¶æ€ï¼Œæ–­è·¯å™¨æ”¾è¡Œæ‰€æœ‰è¯·æ±‚ï¼Œå¹¶å¼€å§‹ç»Ÿè®¡å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è¯·æ±‚æ¯”ä¾‹ã€‚ä¼šå»åˆ¤æ–­æ˜¯å¦è¾¾åˆ°ç†”æ–­æ¡ä»¶ï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬å«åšã€Œç†”æ–­ç­–ç•¥ã€ï¼Œè¾¾åˆ°è¯¥æ¡ä»¶åˆ™åˆ‡æ¢åˆ° open çŠ¶æ€ï¼Œæ‰“å¼€æ–­è·¯å™¨ã€‚
- openï¼šæ‰“å¼€çŠ¶æ€ï¼ŒæœåŠ¡è°ƒç”¨è¢«**ç†”æ–­**ï¼Œè®¿é—®è¢«ç†”æ–­æœåŠ¡çš„è¯·æ±‚ä¼šè¢«æ‹’ç»ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œç›´æ¥èµ°é™çº§é€»è¾‘ã€‚Open çŠ¶æ€ 5 ç§’åä¼šè¿›å…¥ half-open çŠ¶æ€ã€‚
- half-openï¼šåŠå¼€çŠ¶æ€ï¼Œä¼šä¸€æ®µæ—¶é—´æ”¾è¡Œä¸€æ¬¡è¯·æ±‚ï¼Œæ ¹æ®æ‰§è¡Œç»“æœæ¥åˆ¤æ–­æ¥ä¸‹æ¥çš„æ“ä½œã€‚è¯·æ±‚æˆåŠŸï¼šåˆ™åˆ‡æ¢åˆ° closed çŠ¶æ€ï¼›è¯·æ±‚å¤±è´¥ï¼šåˆ™åˆ‡æ¢åˆ° open çŠ¶æ€ã€‚

æ–­è·¯å™¨ç†”æ–­ç­–ç•¥æœ‰ä¸‰ç§ï¼šæ…¢è°ƒç”¨ã€å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°

#### æ…¢è°ƒç”¨

ä¸šåŠ¡çš„å“åº”æ—¶é•¿ï¼ˆRTï¼‰å¤§äºæŒ‡å®šæ—¶é•¿çš„è¯·æ±‚è®¤å®šä¸ºæ…¢è°ƒç”¨è¯·æ±‚ã€‚åœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œå¦‚æœè¯·æ±‚æ•°é‡è¶…è¿‡è®¾å®šçš„æœ€å°æ•°é‡ï¼Œæ…¢è°ƒç”¨æ¯”ä¾‹å¤§äºè®¾å®šçš„é˜ˆå€¼ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

ä¾‹å¦‚ä¸‹å›¾ï¼Œè®¾ç½® RT è¶…è¿‡ 500ms çš„è°ƒç”¨æ˜¯æ…¢è°ƒç”¨ï¼Œç»Ÿè®¡æœ€è¿‘ 10000ms å†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡ 10 æ¬¡ï¼Œå¹¶ä¸”æ…¢è°ƒç”¨æ¯”ä¾‹ä¸ä½äº 0.5ï¼Œåˆ™è§¦å‘ç†”æ–­ï¼Œç†”æ–­æ—¶é•¿ä¸º 5sï¼Œç„¶åè¿›å…¥ half-open çŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚åšæµ‹è¯•ã€‚

![](https://cdn.xn2001.com/img/2022/202205091520916.png)

**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™ UserClient çš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œæ…¢è°ƒç”¨çš„ RT é˜ˆå€¼ä¸º 50msï¼Œç»Ÿè®¡æ—¶é—´ä¸º 1s ï¼Œæœ€å°è¯·æ±‚æ•°é‡ä¸º 5ï¼Œå¤±è´¥é˜ˆå€¼æ¯”ä¾‹ä¸º 0.4ï¼Œç†”æ–­æ—¶é•¿ä¸º 5sï¼›

1ï¼‰è®¾ç½®æ…¢è°ƒç”¨

ä¿®æ”¹ user-service ä¸­çš„ /user/{id} è¿™ä¸ªæ¥å£çš„ä¸šåŠ¡ã€‚é€šè¿‡ä¼‘çœ æ¨¡æ‹Ÿä¸€ä¸ªå»¶è¿Ÿæ—¶é—´ã€‚

![](https://cdn.xn2001.com/img/2022/202205091538605.png)

æ­¤æ—¶ï¼ŒorderId = 101 çš„è®¢å•ï¼Œå…³è”çš„æ˜¯ id ä¸º 1 çš„ç”¨æˆ·ï¼Œè°ƒç”¨æ—¶é•¿ä¸º 60ms

![](https://cdn.xn2001.com/img/2022/202205091520928.png)

orderId = 102 çš„è®¢å•ï¼Œå…³è”çš„æ˜¯ id ä¸º 2 çš„ç”¨æˆ·ï¼Œè°ƒç”¨æ—¶é•¿ä¸ºéå¸¸çŸ­

![](https://cdn.xn2001.com/img/2022/202205091520932.png)

2ï¼‰è®¾ç½®ç†”æ–­è§„åˆ™

ä¸‹é¢ï¼Œç»™ feign æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œè¶…è¿‡ 50ms çš„è¯·æ±‚éƒ½ä¼šè¢«è®¤ä¸ºæ˜¯æ…¢è¯·æ±‚ã€‚

![](https://cdn.xn2001.com/img/2022/202205091624147.png)

![](https://cdn.xn2001.com/img/2022/202205091624535.png)

3ï¼‰æµ‹è¯•

åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8088/order/101ï¼Œå¿«é€Ÿåˆ·æ–°5æ¬¡ï¼Œå¯ä»¥å‘ç°ï¼Œè§¦å‘äº†ç†”æ–­ï¼Œè¯·æ±‚æ—¶é•¿ç¼©çŸ­è‡³ 5msï¼Œå¿«é€Ÿå¤±è´¥äº†ï¼Œå¹¶ä¸”èµ°é™çº§é€»è¾‘ï¼Œè¿”å›çš„ null

![](https://cdn.xn2001.com/img/2022/202205091624280.png)

æ­¤æ—¶åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8088/order/102ï¼Œä¹Ÿè¢«ç†”æ–­äº†

![](https://cdn.xn2001.com/img/2022/202205091625297.png)

#### å¼‚å¸¸

**å¼‚å¸¸æ¯”ä¾‹æˆ–å¼‚å¸¸æ•°**ï¼šç»Ÿè®¡æŒ‡å®šæ—¶é—´å†…çš„è°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨æ¬¡æ•°è¶…è¿‡æŒ‡å®šè¯·æ±‚æ•°ï¼Œå¹¶ä¸”å‡ºç°å¼‚å¸¸çš„æ¯”ä¾‹è¾¾åˆ°è®¾å®šçš„æ¯”ä¾‹é˜ˆå€¼ï¼ˆæˆ–è¶…è¿‡æŒ‡å®šå¼‚å¸¸æ•°ï¼‰ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

ä¾‹å¦‚ï¼Œå¼‚å¸¸æ¯”ä¾‹è®¾ç½®å¦‚ä¸‹ï¼Œç»Ÿè®¡æœ€è¿‘ 1000ms å†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡ 10 æ¬¡ï¼Œå¹¶ä¸”å¼‚å¸¸æ¯”ä¾‹ä¸ä½äº 0.4ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

![](https://cdn.xn2001.com/img/2022/202205091520106.png)

å¼‚å¸¸æ•°è®¾ç½®å¦‚ä¸‹ï¼Œç»Ÿè®¡æœ€è¿‘ 1000ms å†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡ 10 æ¬¡ï¼Œå¹¶ä¸”å¼‚å¸¸æ¯”ä¾‹ä¸ä½äº 2 æ¬¡ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

![](https://cdn.xn2001.com/img/2022/202205091520416.png)

**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™ UserClient çš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œç»Ÿè®¡æ—¶é—´ä¸º 1sï¼Œæœ€å°è¯·æ±‚æ•°é‡ä¸º 5ï¼Œå¤±è´¥é˜ˆå€¼æ¯”ä¾‹ä¸º 0.4ï¼Œç†”æ–­æ—¶é•¿ä¸º 5s

1ï¼‰è®¾ç½®å¼‚å¸¸è¯·æ±‚

é¦–å…ˆï¼Œä¿®æ”¹ user-service ä¸­çš„ /user/{id} è¿™ä¸ªæ¥å£çš„ä¸šåŠ¡ã€‚æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œä»¥è§¦å‘å¼‚å¸¸æ¯”ä¾‹çš„ç†”æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œid ä¸º 2æ—¶ï¼Œå°±ä¼šè§¦å‘å¼‚å¸¸ã€‚

![](https://cdn.xn2001.com/img/2022/202205091520469.png)

2ï¼‰è®¾ç½®ç†”æ–­è§„åˆ™

åœ¨ 5 æ¬¡è¯·æ±‚ä¸­ï¼Œåªè¦å¼‚å¸¸æ¯”ä¾‹è¶…è¿‡ 0.4ï¼Œä¹Ÿå°±æ˜¯æœ‰ 2 æ¬¡ä»¥ä¸Šçš„å¼‚å¸¸ï¼Œå°±ä¼šè§¦å‘ç†”æ–­ã€‚

![](https://cdn.xn2001.com/img/2022/202205091818818.png)

![](https://cdn.xn2001.com/img/2022/202205091520694.png)

3ï¼‰æµ‹è¯•

åœ¨æµè§ˆå™¨å¿«é€Ÿè®¿é—®ï¼šhttp://localhost:8088/order/102ï¼Œå¿«é€Ÿåˆ·æ–° 5 æ¬¡ï¼Œè§¦å‘ç†”æ–­é™çº§ã€‚

![](https://cdn.xn2001.com/img/2022/202205091821790.png)

æ­¤æ—¶ï¼Œæˆ‘ä»¬å»è®¿é—®æœ¬åº”è¯¥æ­£å¸¸çš„ 103ï¼Œå‘ç°ä¹Ÿè¢«é™çº§äº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205091520623.png)

## æˆæƒè§„åˆ™

æˆæƒè§„åˆ™å¯ä»¥å¯¹è¯·æ±‚æ–¹æ¥æºåšåˆ¤æ–­å’Œæ§åˆ¶ã€‚æˆæƒè§„åˆ™å¯ä»¥å¯¹è°ƒç”¨æ–¹çš„æ¥æºåšæ§åˆ¶ï¼Œæœ‰ç™½åå•å’Œé»‘åå•ä¸¤ç§æ–¹å¼ã€‚

æ¯”å¦‚æˆ‘ä»¬å¸Œæœ›æ§åˆ¶å¯¹èµ„æº `test` çš„è®¿é—®è®¾ç½®ç™½åå•ï¼Œåªæœ‰æ¥æºä¸º `appA` å’Œ `appB` çš„è¯·æ±‚æ‰å¯é€šè¿‡ã€‚

- ç™½åå•ï¼šæ¥æºï¼ˆoriginï¼‰åœ¨ç™½åå•å†…çš„è°ƒç”¨è€…å…è®¸è®¿é—®

- é»‘åå•ï¼šæ¥æºï¼ˆoriginï¼‰åœ¨é»‘åå•å†…çš„è°ƒç”¨è€…ä¸å…è®¸è®¿é—®

ç‚¹å‡»å·¦ä¾§èœå•çš„æˆæƒï¼Œå¯ä»¥çœ‹åˆ°æˆæƒè§„åˆ™

![](https://cdn.xn2001.com/img/2022/202205100008770.png)

- èµ„æºåï¼šå°±æ˜¯å—ä¿æŠ¤çš„èµ„æºï¼Œä¾‹å¦‚ /order/{orderId}

- æµæ§åº”ç”¨ï¼šæ˜¯æ¥æºè€…çš„åå•
  - å¦‚æœæ˜¯å‹¾é€‰ç™½åå•ï¼Œåˆ™åå•ä¸­çš„æ¥æºè¢«è®¸å¯è®¿é—®ã€‚
  - å¦‚æœæ˜¯å‹¾é€‰é»‘åå•ï¼Œåˆ™åå•ä¸­çš„æ¥æºè¢«ç¦æ­¢è®¿é—®ã€‚

æ¯”å¦‚æˆ‘ä»¬å…è®¸è¯·æ±‚ä» gateway åˆ° order-serviceï¼Œä¸å…è®¸æµè§ˆå™¨è®¿é—® order-serviceï¼Œé‚£ä¹ˆç™½åå•ä¸­å°±è¦å¡«å†™**ç½‘å…³çš„æ¥æºåç§°ï¼ˆoriginï¼‰**ã€‚

![](https://cdn.xn2001.com/img/2022/202205100008679.png)

Sentinel æ˜¯é€šè¿‡ RequestOriginParser è¿™ä¸ªæ¥å£çš„ parseOrigin() æ–¹æ³•æ¥è·å–è¯·æ±‚çš„æ¥æºçš„ã€‚

```java
public interface RequestOriginParser {
    /**
     * ä»è¯·æ±‚requestå¯¹è±¡ä¸­è·å–originï¼Œè·å–æ–¹å¼è‡ªå®šä¹‰
     */
    String parseOrigin(HttpServletRequest request);
}
```

è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯ä» request å¯¹è±¡ä¸­ï¼Œè·å–è¯·æ±‚è€…çš„ origin å€¼å¹¶è¿”å›ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSentinel ä¸ç®¡è¯·æ±‚è€…ä»å“ªé‡Œæ¥ï¼Œè¿”å›å€¼æ°¸è¿œæ˜¯ defaultï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€åˆ‡è¯·æ±‚çš„æ¥æºéƒ½è¢«è®¤ä¸ºæ˜¯ä¸€æ ·çš„å€¼ default

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰è¿™ä¸ªæ¥å£çš„å®ç°ï¼Œè®©**ä¸åŒçš„è¯·æ±‚ï¼Œè¿”å›ä¸åŒçš„ origin**

ä¾‹å¦‚ order-service æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª RequestOriginParser çš„å®ç°ç±»

```java
@Component
public class HeaderOriginParser implements RequestOriginParser {
    @Override
    public String parseOrigin(HttpServletRequest request) {
        // 1.è·å–è¯·æ±‚å¤´
        String origin = request.getHeader("origin");
        // 2.éç©ºåˆ¤æ–­
        if (StringUtils.isEmpty(origin)) {
            origin = "blank";
        }
        return origin;
    }
}
```

æˆ‘ä»¬å¿…é¡»è®©**æ‰€æœ‰ä» Gateway è·¯ç”±åˆ°å¾®æœåŠ¡çš„è¯·æ±‚éƒ½å¸¦ä¸Š origin å¤´**ã€‚è¿™ä¸ªéœ€è¦åˆ©ç”¨ä¹‹å‰å­¦ä¹ çš„ä¸€ä¸ª GatewayFilter æ¥å®ç°ï¼Œä½¿ç”¨ AddRequestHeaderGatewayFilterï¼Œä¿®æ”¹ Gateway æœåŠ¡ä¸­çš„ application.yml

```yaml
spring:
  cloud:
    gateway:
      default-filters:
        - AddRequestHeader=origin,gateway #originå‰é¢ä¸èƒ½å¸¦ç©ºæ ¼
```

è¿™æ ·ï¼Œä» Gateway è·¯ç”±çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå¸¦ä¸Š origin å¤´ï¼Œå€¼ä¸º gatewayã€‚è€Œä»å…¶å®ƒåœ°æ–¹åˆ°è¾¾å¾®æœåŠ¡çš„è¯·æ±‚ä¸€èˆ¬æ²¡æœ‰è¿™ä¸ªå¤´ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæˆæƒè§„åˆ™ï¼Œæ”¾è¡Œ origin å€¼ä¸º gateway çš„è¯·æ±‚ã€‚

![](https://cdn.xn2001.com/img/2022/202205100104446.png)

![](https://cdn.xn2001.com/img/2022/202205100104442.png)

ç°åœ¨ï¼Œæˆ‘ä»¬ç›´æ¥è·³è¿‡ç½‘å…³ï¼Œè®¿é—® order-service æœåŠ¡

![](https://cdn.xn2001.com/img/2022/202205100104100.png)

é€šè¿‡ç½‘å…³è®¿é—®

![](https://cdn.xn2001.com/img/2022/202205100104271.png)

## è‡ªå®šä¹‰å¼‚å¸¸ç»“æœ

é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘ç”Ÿé™æµã€é™çº§ã€æˆæƒæ‹¦æˆªæ—¶ï¼Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸åˆ°è°ƒç”¨æ–¹ã€‚å¼‚å¸¸ç»“æœéƒ½æ˜¯ flow limmitingï¼ˆé™æµï¼‰ã€‚è¿™æ ·ä¸å¤Ÿå‹å¥½ï¼Œæ— æ³•å¾—çŸ¥æ˜¯é™æµè¿˜æ˜¯é™çº§è¿˜æ˜¯æˆæƒæ‹¦æˆªã€‚

è€Œå¦‚æœè¦è‡ªå®šä¹‰å¼‚å¸¸æ—¶çš„è¿”å›ç»“æœï¼Œéœ€è¦å®ç° BlockExceptionHandler æ¥å£

```java
public interface BlockExceptionHandler {
    /**
     * å¤„ç†è¯·æ±‚è¢«é™æµã€é™çº§ã€æˆæƒæ‹¦æˆªæ—¶æŠ›å‡ºçš„å¼‚å¸¸ï¼šBlockException
     */
    void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception;
}
```

è¿™ä¸ªæ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼š

- HttpServletRequest requestï¼šrequest å¯¹è±¡
- HttpServletResponse responseï¼šresponse å¯¹è±¡
- BlockException eï¼šè¢« Sentinel æ‹¦æˆªæ—¶æŠ›å‡ºçš„å¼‚å¸¸

è¿™é‡Œçš„ BlockException åŒ…å«å¤šä¸ªä¸åŒçš„å­ç±»

| **å¼‚å¸¸**             | **è¯´æ˜**           |
| -------------------- | ------------------ |
| FlowException        | é™æµå¼‚å¸¸           |
| ParamFlowException   | çƒ­ç‚¹å‚æ•°é™æµçš„å¼‚å¸¸ |
| DegradeException     | é™çº§å¼‚å¸¸           |
| AuthorityException   | æˆæƒè§„åˆ™å¼‚å¸¸       |
| SystemBlockException | ç³»ç»Ÿè§„åˆ™å¼‚å¸¸       |

è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ï¼Œä¸‹é¢æˆ‘ä»¬å°±åœ¨ order-service å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ç±»

```java
@Component
public class SentinelExceptionHandler implements BlockExceptionHandler {
    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception {
        String msg = "æœªçŸ¥å¼‚å¸¸";
        int status = 429;

        if (e instanceof FlowException) {
            msg = "è¯·æ±‚è¢«é™æµäº†";
        } else if (e instanceof ParamFlowException) {
            msg = "è¯·æ±‚è¢«çƒ­ç‚¹å‚æ•°é™æµ";
        } else if (e instanceof DegradeException) {
            msg = "è¯·æ±‚è¢«é™çº§äº†";
        } else if (e instanceof AuthorityException) {
            msg = "æ²¡æœ‰æƒé™è®¿é—®";
            status = 401;
        }

        response.setContentType("application/json;charset=utf-8");
        response.setStatus(status);
        response.getWriter().println("{\"msg\": " + msg + ", \"status\": " + status + "}");
    }
}
```

é‡å¯æµ‹è¯•ï¼Œåœ¨ä¸åŒåœºæ™¯ä¸‹ï¼Œä¼šè¿”å›ä¸åŒçš„å¼‚å¸¸æ¶ˆæ¯ã€‚

é™æµï¼š

![](https://cdn.xn2001.com/img/2022/202205100112438.png)

æˆæƒæ‹¦æˆªæ—¶ï¼š

![](https://cdn.xn2001.com/img/2022/202205100122438.png)

## è§„åˆ™æŒä¹…åŒ–

ç°åœ¨ï¼ŒSentinel çš„æ‰€æœ‰è§„åˆ™éƒ½æ˜¯å†…å­˜å­˜å‚¨ï¼Œé‡å¯åæ‰€æœ‰è§„åˆ™éƒ½ä¼šä¸¢å¤±ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿è¿™äº›è§„åˆ™çš„æŒä¹…åŒ–ï¼Œé¿å…ä¸¢å¤±ã€‚

è§„åˆ™æ˜¯å¦èƒ½æŒä¹…åŒ–ï¼Œå–å†³äºè§„åˆ™ç®¡ç†æ¨¡å¼ï¼ŒSentinel æ”¯æŒä¸‰ç§è§„åˆ™ç®¡ç†æ¨¡å¼

- åŸå§‹æ¨¡å¼ï¼šSentinel çš„é»˜è®¤æ¨¡å¼ï¼Œå°†è§„åˆ™ä¿å­˜åœ¨å†…å­˜ï¼Œé‡å¯æœåŠ¡ä¼šä¸¢å¤±ã€‚
- pull æ¨¡å¼
- push æ¨¡å¼

### pullæ¨¡å¼

pull æ¨¡å¼ï¼šæ§åˆ¶å°å°†é…ç½®çš„è§„åˆ™æ¨é€åˆ° Sentinel å®¢æˆ·ç«¯ï¼Œè€Œå®¢æˆ·ç«¯ä¼šå°†é…ç½®è§„åˆ™ä¿å­˜åœ¨æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­ã€‚ä»¥åä¼šå®šæ—¶å»æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­æŸ¥è¯¢ï¼Œæ›´æ–°æœ¬åœ°è§„åˆ™ã€‚

![](https://cdn.xn2001.com/img/2022/202205100126168.png)

### pushæ¨¡å¼

push æ¨¡å¼ï¼šæ§åˆ¶å°å°†é…ç½®è§„åˆ™æ¨é€åˆ°è¿œç¨‹é…ç½®ä¸­å¿ƒï¼Œä¾‹å¦‚ Nacosï¼ŒSentinel å®¢æˆ·ç«¯ç›‘å¬ Nacosï¼Œè·å–é…ç½®å˜æ›´çš„æ¨é€æ¶ˆæ¯ï¼Œå®Œæˆæœ¬åœ°é…ç½®æ›´æ–°ã€‚è¿™ç§æ¨¡å¼æ˜¯æ¯”è¾ƒå¥½çš„ä¸€ç§ã€‚

![](https://cdn.xn2001.com/img/2022/202205100128564.png)

æˆ‘ä»¬ç®€å•äº†è§£ä¸€ä¸‹è¿™ç§æ–¹å¼ï¼Œé¦–å…ˆä¿®æ”¹ OrderServiceï¼Œè®©å…¶ç›‘å¬ Nacos ä¸­çš„ Sentinel è§„åˆ™é…ç½®ã€‚

åœ¨ order-service ä¸­å¼•å…¥Sentinel ç›‘å¬ Nacos çš„ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```

é…ç½® Nacos åœ°å€ï¼Œåœ¨ order-service ä¸­çš„ application.yml æ–‡ä»¶é…ç½® Nacos åœ°å€åŠç›‘å¬çš„é…ç½®ä¿¡æ¯

```yaml
spring:
  cloud:
    sentinel:
      datasource:
        flow:
          nacos:
            server-addr: localhost:8848 # nacosåœ°å€
            dataId: orderservice-flow-rules
            groupId: SENTINEL_GROUP
            rule-type: flow # è¿˜å¯ä»¥æ˜¯ï¼šdegradeã€authorityã€param-flow
```

ç„¶åéœ€è¦ä¿®æ”¹ sentinel-dashboard æºç ï¼ŒSentinelDashboard é»˜è®¤ä¸æ”¯æŒ Nacos çš„æŒä¹…åŒ–ï¼Œéœ€è¦ä¿®æ”¹æºç ã€‚

> ç›¸å½“äºå¼€æºå¼€ä¸€åŠï¼Œä¸»è¦ç»™é˜¿é‡Œäº‘ç”¨æˆ·å•†ä¸šä½¿ç”¨ã€‚
>
> ä»¥ä¸‹ä»¥ä¾›äº†è§£ï¼Œæœªå®æµ‹ã€‚

è§£å‹ Sentinel æºç åŒ…

![](https://cdn.xn2001.com/img/2022/202205101404663.png)

ç„¶åå¹¶ç”¨ IDEA æ‰“å¼€è¿™ä¸ªé¡¹ç›®ï¼Œç»“æ„å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2022/202205101404666.png)

åœ¨ sentinel-dashboard æºç çš„pomæ–‡ä»¶ä¸­ï¼Œnacos çš„ä¾èµ–é»˜è®¤çš„ scope æ˜¯ testï¼Œåªèƒ½åœ¨æµ‹è¯•æ—¶ä½¿ç”¨ï¼Œè¿™é‡Œè¦å»é™¤

![](https://cdn.xn2001.com/img/2022/202205101405160.png)

å°† sentinel-datasource-nacos ä¾èµ–çš„ scope å»æ‰ï¼Œæ”¹æˆä¸‹é¢è¿™æ ·ã€‚

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```

åœ¨ sentinel-dashboard çš„ test åŒ…ä¸‹ï¼Œå·²ç»ç¼–å†™äº†å¯¹ nacos çš„æ”¯æŒï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ‹·è´åˆ° main ä¸­ã€‚

![](https://cdn.xn2001.com/img/2022/202205101405035.png)

ç„¶åï¼Œè¿˜éœ€è¦ä¿®æ”¹æµ‹è¯•ä»£ç ä¸­çš„ NacosConfig ç±» 

![](https://cdn.xn2001.com/img/2022/202205101406914.png)

ä¿®æ”¹å…¶ä¸­çš„ Nacos åœ°å€ï¼Œè®©å…¶è¯»å– application.properties ä¸­çš„é…ç½®

![](https://cdn.xn2001.com/img/2022/202205101404688.png)

åœ¨ sentinel-dashboard çš„ application.properties ä¸­æ·»åŠ  Nacos åœ°å€é…ç½®

```properties
nacos.addr=localhost:8848
```

å¦å¤–ï¼Œè¿˜éœ€è¦ä¿®æ”¹ `com.alibaba.csp.sentinel.dashboard.controller.v2` åŒ…ä¸‹çš„ FlowControllerV2

![](https://cdn.xn2001.com/img/2022/202205101404531.png)

è®©æˆ‘ä»¬æ·»åŠ çš„ Nacos æ•°æ®æºç”Ÿæ•ˆ

![](https://cdn.xn2001.com/img/2022/202205101407560.png)

æ¥ä¸‹æ¥ï¼Œè¿˜è¦ä¿®æ”¹å‰ç«¯é¡µé¢ï¼Œæ·»åŠ ä¸€ä¸ªæ”¯æŒ nacos çš„èœå•ã€‚

ä¿®æ”¹ `src/main/webapp/resources/app/scripts/directives/sidebar/` ç›®å½•ä¸‹çš„ sidebar.html æ–‡ä»¶

![](https://cdn.xn2001.com/img/2022/202205101404891.png)

å°†å…¶ä¸­çš„è¿™éƒ¨åˆ†æ³¨é‡Šæ‰“å¼€

![](https://cdn.xn2001.com/img/2022/202205101408124.png)

ä¿®æ”¹å…¶ä¸­çš„æ–‡æœ¬

![](https://cdn.xn2001.com/img/2022/202205101408073.png)

è¿è¡Œ IDEA ä¸­çš„ maven æ’ä»¶ï¼Œç¼–è¯‘å’Œæ‰“åŒ…ä¿®æ”¹å¥½çš„ sentinel-dashboard

![](https://cdn.xn2001.com/img/2022/202205101408008.png)

å¯åŠ¨æ–¹å¼è·Ÿå®˜æ–¹ä¸€æ ·

```sh
java -jar sentinel-dashboard.jar
```

å¦‚æœè¦ä¿®æ”¹ Nacos åœ°å€ï¼Œå¯ä»¥æ·»åŠ å‚æ•°

```sh
java -jar -Dnacos.addr=localhost:8848 sentinel-dashboard.jar
```

# Seataåˆ†å¸ƒå¼äº‹åŠ¡

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/11-seata-demo
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/11-seata-demo

## åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜

> æ­¤å¤„å¯ç»“åˆ MySQL äº‹åŠ¡ä¸€èµ·å­¦ä¹ ï¼Œå¯ç›´æ¥æŸ¥çœ‹è¯¥ç¬”è®°
>
> <a class="post_link" href="https://www.xn2001.com/archives/677.html"><i data-feather="file-text"></i>MySQLå…¥é—¨åˆ°ç²¾é€šï¼Ÿ</a>

åœ¨ä¼ ç»Ÿæ•°æ®åº“äº‹åŠ¡ä¸­ï¼Œå¿…é¡»è¦æ»¡è¶³å››ä¸ªåŸåˆ™ï¼Œæˆ‘ä»¬æŠŠä»–ç§°ä¸º ACID

![](https://cdn.xn2001.com/img/2022/202205231445816.png)

**åˆ†å¸ƒå¼äº‹åŠ¡**ï¼Œå°±æ˜¯æŒ‡ä¸æ˜¯åœ¨å•ä¸ªæœåŠ¡æˆ–å•ä¸ªæ•°æ®åº“æ¶æ„ä¸‹ï¼Œäº§ç”Ÿçš„äº‹åŠ¡ï¼Œä¾‹å¦‚

- è·¨æ•°æ®æºçš„åˆ†å¸ƒå¼äº‹åŠ¡
- è·¨æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡
- ç»¼åˆæƒ…å†µ

åœ¨æ•°æ®åº“æ°´å¹³æ‹†åˆ†ã€æœåŠ¡å‚ç›´æ‹†åˆ†ä¹‹åï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œé€šå¸¸è¦è·¨å¤šä¸ªæ•°æ®åº“ã€æœåŠ¡æ‰èƒ½å®Œæˆã€‚ä¾‹å¦‚ç”µå•†è¡Œä¸šä¸­æ¯”è¾ƒå¸¸è§çš„ä¸‹å•ä»˜æ¬¾æ¡ˆä¾‹ï¼ŒåŒ…æ‹¬ä¸‹é¢å‡ ä¸ªè¡Œä¸ºï¼š

1. åˆ›å»ºæ–°è®¢å•
2. æ‰£å‡å•†å“åº“å­˜
3. ä»ç”¨æˆ·è´¦æˆ·ä½™é¢æ‰£é™¤é‡‘é¢

å®Œæˆä¸Šé¢çš„æ“ä½œéœ€è¦è®¿é—®ä¸‰ä¸ªä¸åŒçš„å¾®æœåŠ¡å’Œä¸‰ä¸ªä¸åŒçš„æ•°æ®åº“ã€‚

![](https://cdn.xn2001.com/img/2022/202205231447738.png)

è®¢å•çš„åˆ›å»ºã€åº“å­˜çš„æ‰£å‡ã€è´¦æˆ·æ‰£æ¬¾åœ¨æ¯ä¸€ä¸ªæœåŠ¡å’Œæ•°æ®åº“å†…æ˜¯ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œå¯ä»¥ä¿è¯ ACID åŸåˆ™ã€‚

ä½†æ˜¯å½“æˆ‘ä»¬æŠŠä¸‰ä»¶äº‹æƒ…çœ‹åšä¸€ä¸ª"ä¸šåŠ¡"ï¼Œè¦æ»¡è¶³ä¿è¯â€œä¸šåŠ¡â€çš„åŸå­æ€§ï¼Œè¦ä¹ˆæ‰€æœ‰æ“ä½œå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å…è®¸å‡ºç°éƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥çš„ç°è±¡ï¼Œè¿™å°±æ˜¯**åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹çš„äº‹åŠ¡**ã€‚æ­¤æ—¶ ACID éš¾ä»¥æ»¡è¶³ï¼Œè¿™æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡è¦è§£å†³çš„é—®é¢˜ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªé¡¹ç›®æ¼”ç¤ºï¼Œå¦‚ä¸‹å›¾æœ‰ä¸€ä¸ªå¾®æœåŠ¡é¡¹ç›®

![](https://cdn.xn2001.com/img/2022/202205231502038.png)

å…¶ä¸­ï¼šseata-demo æ˜¯çˆ¶å·¥ç¨‹ï¼Œè´Ÿè´£ç®¡ç†é¡¹ç›®ä¾èµ–

- account-serviceï¼šè´¦æˆ·æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ã€‚æä¾›æ‰£å‡ä½™é¢çš„æ¥å£
- storage-serviceï¼šåº“å­˜æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†å•†å“åº“å­˜ã€‚æä¾›æ‰£å‡åº“å­˜çš„æ¥å£
- order-serviceï¼šè®¢å•æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†è®¢å•ã€‚åˆ›å»ºè®¢å•æ—¶ï¼Œéœ€è¦è°ƒç”¨ account-service å’Œ storage-service

æˆ‘ä»¬å»åˆ›å»ºè®¢å•ï¼Œå‘é€ POST è¯·æ±‚

```
curl --location --request POST 'http://localhost:8082/order?userId=user202103032042012&amp;commodityCode=100202003032041&amp;count=20&amp;money=200'
```

æµ‹è¯•å‘ç°ï¼Œå½“åº“å­˜ä¸è¶³æ—¶ï¼Œæ­¤æ—¶è´¦æˆ·ä½™é¢å·²ç»æ‰£å‡ï¼Œå¹¶ä¸ä¼šå›æ»šï¼Œå‡ºç°äº†åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ã€‚

![](https://cdn.xn2001.com/img/2022/202205231505539.png)

## è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡

### CAPå®šç†

1998å¹´ï¼ŒåŠ å·å¤§å­¦çš„è®¡ç®—æœºç§‘å­¦å®¶ Eric Brewer æå‡ºï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæœ‰ä¸‰ä¸ªæŒ‡æ ‡ã€‚

> - Consistencyï¼ˆä¸€è‡´æ€§ï¼‰
> - Availabilityï¼ˆå¯ç”¨æ€§ï¼‰
> - Partition tolerance ï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰

å®ƒä»¬çš„ç¬¬ä¸€ä¸ªå­—æ¯åˆ†åˆ«æ˜¯ Cã€Aã€Pã€‚

Eric Brewer è¯´ï¼Œè¿™ä¸‰ä¸ªæŒ‡æ ‡ä¸å¯èƒ½åŒæ—¶åšåˆ°ã€‚è¿™ä¸ªç»“è®ºå°±å«åš CAP å®šç†ã€‚

![](https://cdn.xn2001.com/img/2022/202205231506789.png)

#### Consistencyä¸€è‡´æ€§

Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šç”¨æˆ·è®¿é—®åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä»»æ„èŠ‚ç‚¹ï¼Œå¾—åˆ°çš„æ•°æ®å¿…é¡»ä¸€è‡´ã€‚

æ¯”å¦‚ç°åœ¨åŒ…å«ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå…¶ä¸­çš„åˆå§‹æ•°æ®æ˜¯ä¸€è‡´çš„

![](https://cdn.xn2001.com/img/2022/202205231506787.png)

å½“æˆ‘ä»¬ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®æ—¶ï¼Œä¸¤è€…çš„æ•°æ®äº§ç”Ÿäº†å·®å¼‚

![](https://cdn.xn2001.com/img/2022/202205231506790.png)

è¦æƒ³ä¿ä½ä¸€è‡´æ€§ï¼Œå°±å¿…é¡»å®ç° node01 åˆ° node02 çš„æ•°æ®åŒæ­¥

![](https://cdn.xn2001.com/img/2022/202205231506801.png)



#### Availabilityå¯ç”¨æ€§

Availability ï¼ˆå¯ç”¨æ€§ï¼‰ï¼šç”¨æˆ·è®¿é—®é›†ç¾¤ä¸­çš„ä»»æ„å¥åº·èŠ‚ç‚¹ï¼Œå¿…é¡»èƒ½å¾—åˆ°å“åº”ï¼Œè€Œä¸æ˜¯è¶…æ—¶æˆ–æ‹’ç»ã€‚

å¦‚å›¾ï¼Œæœ‰ä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œè®¿é—®ä»»ä½•ä¸€ä¸ªéƒ½å¯ä»¥åŠæ—¶å¾—åˆ°å“åº”

![](https://cdn.xn2001.com/img/2022/202205231506803.png)

å½“æœ‰éƒ¨åˆ†èŠ‚ç‚¹å› ä¸ºç½‘ç»œæ•…éšœæˆ–å…¶å®ƒåŸå› æ— æ³•è®¿é—®æ—¶ï¼Œä»£è¡¨èŠ‚ç‚¹ä¸å¯ç”¨

![](https://cdn.xn2001.com/img/2022/202205231506810.png)

#### Partition Toleranceåˆ†åŒºå®¹é”™

Partitionï¼ˆåˆ†åŒºï¼‰ï¼šå› ä¸ºç½‘ç»œæ•…éšœæˆ–å…¶å®ƒåŸå› å¯¼è‡´åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„éƒ¨åˆ†èŠ‚ç‚¹ä¸å…¶å®ƒèŠ‚ç‚¹å¤±å»è¿æ¥ï¼Œå½¢æˆç‹¬ç«‹åˆ†åŒºã€‚

Toleranceï¼ˆå®¹é”™ï¼‰ï¼šåœ¨é›†ç¾¤å‡ºç°åˆ†åŒºæ—¶ï¼Œæ•´ä¸ªç³»ç»Ÿä¹Ÿè¦æŒç»­å¯¹å¤–æä¾›æœåŠ¡ã€‚

![](https://cdn.xn2001.com/img/2022/202205231506703.png)

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç³»ç»Ÿé—´çš„ç½‘ç»œä¸èƒ½ 100% ä¿è¯å¥åº·ï¼Œä¸€å®šä¼šæœ‰æ•…éšœçš„æ—¶å€™ï¼Œè€ŒæœåŠ¡æœ‰å¿…é¡»å¯¹å¤–ä¿è¯æœåŠ¡ã€‚**å› æ­¤ Partition Tolerance ä¸å¯é¿å…ã€‚**å½“èŠ‚ç‚¹æ¥æ”¶åˆ°æ–°çš„æ•°æ®å˜æ›´æ—¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜äº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205231506722.png)

å¦‚æœæ­¤æ—¶è¦ä¿è¯**ä¸€è‡´æ€§**ï¼Œå°±å¿…é¡»ç­‰å¾…ç½‘ç»œæ¢å¤ï¼Œå®Œæˆæ•°æ®åŒæ­¥åï¼Œæ•´ä¸ªé›†ç¾¤æ‰å¯¹å¤–æä¾›æœåŠ¡ï¼ŒæœåŠ¡å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å¯ç”¨ã€‚

å¦‚æœæ­¤æ—¶è¦ä¿è¯**å¯ç”¨æ€§**ï¼Œå°±ä¸èƒ½ç­‰å¾…ç½‘ç»œæ¢å¤ï¼Œé‚£ node01ã€node02 ä¸ node03 ä¹‹é—´å°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ P ä¸€å®šä¼šå‡ºç°çš„æƒ…å†µä¸‹ï¼ŒA å’Œ C ä¹‹é—´åªèƒ½å®ç°ä¸€ä¸ªã€‚

### BASEç†è®º

BASE ç†è®ºæ˜¯å¯¹ CAP çš„ä¸€ç§è§£å†³æ€è·¯ï¼ŒåŒ…å«ä¸‰ä¸ªæ€æƒ³ï¼š

- **Basically Available** **ï¼ˆåŸºæœ¬å¯ç”¨ï¼‰**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œå³ä¿è¯æ ¸å¿ƒå¯ç”¨ã€‚
- **Soft Stateï¼ˆè½¯çŠ¶æ€ï¼‰**ï¼šåœ¨ä¸€å®šæ—¶é—´å†…ï¼Œå…è®¸å‡ºç°ä¸­é—´çŠ¶æ€ï¼Œæ¯”å¦‚ä¸´æ—¶çš„ä¸ä¸€è‡´çŠ¶æ€ã€‚
- **Eventually Consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰**ï¼šè™½ç„¶æ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯åœ¨è½¯çŠ¶æ€ç»“æŸåï¼Œæœ€ç»ˆè¾¾åˆ°æ•°æ®ä¸€è‡´ã€‚

åˆ†å¸ƒå¼äº‹åŠ¡æœ€å¤§çš„é—®é¢˜æ˜¯å„ä¸ªå­äº‹åŠ¡çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå› æ­¤å¯ä»¥å€Ÿé‰´ CAPå®šç† å’Œ BASEç†è®ºï¼Œæœ‰ä¸¤ç§è§£å†³æ€è·¯

- AP æ¨¡å¼ï¼šå„å­äº‹åŠ¡åˆ†åˆ«æ‰§è¡Œå’Œæäº¤ï¼Œå…è®¸å‡ºç°ç»“æœä¸ä¸€è‡´ï¼Œç„¶åé‡‡ç”¨å¼¥è¡¥æªæ–½æ¢å¤æ•°æ®å³å¯ï¼Œå®ç°æœ€ç»ˆä¸€è‡´ã€‚

- CP æ¨¡å¼ï¼šå„ä¸ªå­äº‹åŠ¡æ‰§è¡Œåäº’ç›¸ç­‰å¾…ï¼ŒåŒæ—¶æäº¤ï¼ŒåŒæ—¶å›æ»šï¼Œè¾¾æˆå¼ºä¸€è‡´ã€‚ä½†äº‹åŠ¡ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¤„äºå¼±å¯ç”¨çŠ¶æ€ã€‚

> å‰é¢æˆ‘ä»¬æ‰€å­¦çš„ Elasticsearch é›†ç¾¤å°±æ˜¯ CP æ¨¡å¼ï¼Œä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚

è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå„ä¸ªå­ç³»ç»Ÿä¹‹é—´å¿…é¡»èƒ½æ„ŸçŸ¥å½¼æ­¤çš„äº‹åŠ¡çŠ¶æ€ï¼Œæ‰èƒ½ä¿è¯çŠ¶æ€ä¸€è‡´ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªäº‹åŠ¡åè°ƒè€…æ¥åè°ƒæ¯ä¸€ä¸ªäº‹åŠ¡çš„å‚ä¸è€…ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä¸€ä¸ªäº‹åŠ¡åè°ƒè€…ã€‚ï¼ˆTCï¼‰

å¦å¤–ï¼Œè¿™é‡Œçš„å­ç³»ç»Ÿäº‹åŠ¡ï¼Œç§°ä¸º**åˆ†æ”¯äº‹åŠ¡**ï¼›æœ‰å…³è”çš„å„ä¸ªåˆ†æ”¯äº‹åŠ¡åœ¨ä¸€èµ·ç§°ä¸º**å…¨å±€äº‹åŠ¡**ã€‚

![](https://cdn.xn2001.com/img/2022/202205231506031.png)

## éƒ¨ç½²Seata

Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚

å®˜ç½‘åœ°å€ï¼šhttp://seata.io/ï¼Œå…¶ä¸­çš„æ–‡æ¡£ã€æ’­å®¢ä¸­æä¾›äº†å¤§é‡çš„ä½¿ç”¨è¯´æ˜ã€æºç åˆ†æã€‚

![](https://cdn.xn2001.com/img/2022/202205231707983.png)

### Seataçš„æ¶æ„

Seata äº‹åŠ¡ç®¡ç†ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„è§’è‰²

- **TC (Transaction Coordinator) -** **äº‹åŠ¡åè°ƒè€…**ï¼šç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œåè°ƒå…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚

- **TM (Transaction Manager) -** **äº‹åŠ¡ç®¡ç†å™¨**ï¼šå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ã€å¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚

- **RM (Resource Manager) -** **èµ„æºç®¡ç†å™¨**ï¼šç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸ TC äº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚

![](https://cdn.xn2001.com/img/2022/202205231704030.png)

Seata åŸºäºä¸Šè¿°æ¶æ„æä¾›äº†å››ç§ä¸åŒçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ

- XA æ¨¡å¼ï¼šå¼ºä¸€è‡´æ€§åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œç‰ºç‰²äº†ä¸€å®šçš„å¯ç”¨æ€§ï¼Œæ— ä¸šåŠ¡ä¾µå…¥
- TCC æ¨¡å¼ï¼šæœ€ç»ˆä¸€è‡´çš„åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œæœ‰ä¸šåŠ¡ä¾µå…¥
- AT æ¨¡å¼ï¼šæœ€ç»ˆä¸€è‡´çš„åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œæ— ä¸šåŠ¡ä¾µå…¥ï¼Œä¹Ÿæ˜¯ Seata çš„é»˜è®¤æ¨¡å¼
- SAGA æ¨¡å¼ï¼šé•¿äº‹åŠ¡æ¨¡å¼ï¼Œæœ‰ä¸šåŠ¡ä¾µå…¥

æ— è®ºå“ªç§æ–¹æ¡ˆï¼Œéƒ½ç¦»ä¸å¼€ TCï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡çš„åè°ƒè€…ã€‚

![](https://cdn.xn2001.com/img/2022/202205232202909.png)

### éƒ¨ç½²TCæœåŠ¡

ä¸‹è½½ seata-server åŒ…ï¼Œhttps://seata.io/zh-cn/blog/download.html

åœ¨éä¸­æ–‡ç›®å½•è§£å‹ç¼©ï¼Œå…¶ç›®å½•ç»“æ„å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2022/202205241709346.png)

ä¿®æ”¹ conf ç›®å½•ä¸‹çš„ registry.conf æ–‡ä»¶

![](https://cdn.xn2001.com/img/2022/202205241709343.png)

```properties
registry {
  # tcæœåŠ¡çš„æ³¨å†Œä¸­å¿ƒç±»ï¼Œè¿™é‡Œé€‰æ‹©nacosï¼Œä¹Ÿå¯ä»¥æ˜¯eurekaã€zookeeperç­‰
  type = "nacos"

  nacos {
    # seata tc æœåŠ¡æ³¨å†Œåˆ° nacosçš„æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
    application = "seata-tc-server"
    serverAddr = "127.0.0.1:8848"
    group = "DEFAULT_GROUP"
    namespace = ""
    cluster = "SH"
    username = "nacos"
    password = "nacos"
  }
}

config {
  # è¯»å–tcæœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä»nacosé…ç½®ä¸­å¿ƒè¯»å–ï¼Œè¿™æ ·å¦‚æœtcæ˜¯é›†ç¾¤ï¼Œå¯ä»¥å…±äº«é…ç½®
  type = "nacos"
  # é…ç½®nacosåœ°å€ç­‰ä¿¡æ¯
  nacos {
    serverAddr = "127.0.0.1:8848"
    namespace = ""
    group = "DEFAULT_GROUP"
    username = "nacos"
    password = "nacos"
    dataId = "seataServer.properties"
  }
}
```

ä¸ºäº†è®© TC æœåŠ¡çš„é›†ç¾¤å¯ä»¥å…±äº«é…ç½®ï¼Œæˆ‘ä»¬é€‰æ‹©äº† Nacos ä½œä¸ºç»Ÿä¸€é…ç½®ä¸­å¿ƒã€‚å› æ­¤æœåŠ¡ç«¯é…ç½®æ–‡ä»¶ `seataServer.properties` æ–‡ä»¶éœ€è¦åœ¨Nacos ä¸­é…å¥½ã€‚åœ¨ Nacos åå°æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼šhttp://localhost:8848/nacos/

![](https://cdn.xn2001.com/img/2022/202205241709375.png)



é…ç½®å†…å®¹å¦‚ä¸‹

> æ³¨æ„ï¼šä¸€å®šè¦æŠŠæ³¨é‡Šåˆ æ‰ï¼è¦ä¿®æ”¹ä½ çš„æ•°æ®åº“ä¿¡æ¯ã€‚

```properties
# æ•°æ®å­˜å‚¨æ–¹å¼ï¼Œdbä»£è¡¨æ•°æ®åº“
store.mode=db
store.db.datasource=druid
store.db.dbType=mysql
# è¿™æ˜¯MySQL8çš„é©±åŠ¨ï¼ŒMySQL5ä½¿ç”¨çš„æ˜¯com.mysql.jdbc.Driver
store.db.driverClassName=com.mysql.cj.jdbc.Driver
# æ•°æ®åº“åœ°å€ã€ç”¨æˆ·åã€å¯†ç éƒ½éœ€è¦ä¿®æ”¹æˆä½ è‡ªå·±çš„æ•°æ®åº“ä¿¡æ¯ã€‚
store.db.url=jdbc:mysql://127.0.0.1:3306/seata?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=GMT%2B8
store.db.user=root
store.db.password=123456
store.db.minConn=5
store.db.maxConn=30
store.db.globalTable=global_table
store.db.branchTable=branch_table
store.db.queryLimit=100
store.db.lockTable=lock_table
store.db.maxWait=5000
# äº‹åŠ¡ã€æ—¥å¿—ç­‰é…ç½®
server.recovery.committingRetryPeriod=1000
server.recovery.asynCommittingRetryPeriod=1000
server.recovery.rollbackingRetryPeriod=1000
server.recovery.timeoutRetryPeriod=1000
server.maxCommitRetryTimeout=-1
server.maxRollbackRetryTimeout=-1
server.rollbackRetryTimeoutUnlockEnable=false
server.undo.logSaveDays=7
server.undo.logDeletePeriod=86400000
# å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¼ è¾“æ–¹å¼
transport.serialization=seata
transport.compressor=none
# å…³é—­metricsåŠŸèƒ½ï¼Œæé«˜æ€§èƒ½
metrics.enabled=false
metrics.registryType=compact
metrics.exporterList=prometheus
metrics.exporterPrometheusPort=9898
```

TC æœåŠ¡åœ¨ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œéœ€è¦è®°å½•äº‹åŠ¡ç›¸å…³æ•°æ®åˆ°æ•°æ®åº“ä¸­ï¼Œä½ éœ€è¦æå‰åˆ›å»ºå¥½è¿™äº›è¡¨ã€‚æ–°å»ºä¸€ä¸ªåä¸º seata çš„æ•°æ®åº“ï¼Œè¿è¡Œ SQL

è¿™äº›è¡¨ä¸»è¦è®°å½•å…¨å±€äº‹åŠ¡ã€åˆ†æ”¯äº‹åŠ¡ã€å…¨å±€é”ä¿¡æ¯ã€‚

```mysql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for branch_table
-- ----------------------------
DROP TABLE IF EXISTS `branch_table`;
CREATE TABLE `branch_table`  (
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `resource_group_id` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `resource_id` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `branch_type` varchar(8) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `status` tinyint(4) NULL DEFAULT NULL,
  `client_id` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `application_data` varchar(2000) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime(6) NULL DEFAULT NULL,
  `gmt_modified` datetime(6) NULL DEFAULT NULL,
  PRIMARY KEY (`branch_id`) USING BTREE,
  INDEX `idx_xid`(`xid`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- Records of branch_table
-- ----------------------------

-- ----------------------------
-- Table structure for global_table
-- ----------------------------
DROP TABLE IF EXISTS `global_table`;
CREATE TABLE `global_table`  (
  `xid` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `status` tinyint(4) NOT NULL,
  `application_id` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_service_group` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_name` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `timeout` int(11) NULL DEFAULT NULL,
  `begin_time` bigint(20) NULL DEFAULT NULL,
  `application_data` varchar(2000) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime NULL DEFAULT NULL,
  `gmt_modified` datetime NULL DEFAULT NULL,
  PRIMARY KEY (`xid`) USING BTREE,
  INDEX `idx_gmt_modified_status`(`gmt_modified`, `status`) USING BTREE,
  INDEX `idx_transaction_id`(`transaction_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- Records of global_table
-- ----------------------------


-- ----------------------------
-- Records of lock_table
-- ----------------------------

SET FOREIGN_KEY_CHECKS = 1;

```

è¿›å…¥ bin ç›®å½•ï¼Œè¿è¡Œå…¶ä¸­çš„ seata-server.bat å³å¯ã€‚

![](https://cdn.xn2001.com/img/2022/202205241709380.png)

å¯åŠ¨æˆåŠŸåï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® Nacos åœ°å€ï¼šhttp://localhost:8848ï¼Œç„¶åè¿›å…¥æœåŠ¡åˆ—è¡¨é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ° seata-tc-server çš„ä¿¡æ¯ã€‚

![](https://cdn.xn2001.com/img/2022/202205241709137.png)

### Seataå¾®æœåŠ¡é›†æˆ

> å¾ˆå¤šäººè¯´è¿™é‡Œå¾ˆéš¾ï¼Œå¯åŠ¨è€æ˜¯å¤±è´¥ï¼Œæ³¨æ„æ£€æŸ¥å¥½ä¸Šä¸€æ­¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œæ¯”å¦‚é›†ç¾¤æ˜¯å¦æ˜¯ SHï¼Œåˆ†åŒºæ˜¯å¦æ˜¯ DEFAULT_GROUPï¼Œå®ä¾‹åæ˜¯å¦æ˜¯ seata-tc-server

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¾®æœåŠ¡ä¸­å¼•å…¥ Seata ä¾èµ–

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
    <exclusions>
        <!--ç‰ˆæœ¬è¾ƒä½ï¼Œ1.3.0ï¼Œå› æ­¤æ’é™¤-->
        <exclusion>
            <artifactId>seata-spring-boot-starter</artifactId>
            <groupId>io.seata</groupId>
        </exclusion>
    </exclusions>
</dependency>
<!--seata starter é‡‡ç”¨1.4.2ç‰ˆæœ¬-->
<dependency>
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>${seata.version}</version>
</dependency>
```

éœ€è¦ä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œæ·»åŠ ä¸€äº›é…ç½®ï¼Œä¾‹å¦‚åœ¨ order-service æœåŠ¡ä¸­çš„ application.ymlï¼Œé…ç½® TC æœåŠ¡ä¿¡æ¯ï¼Œé€šè¿‡æ³¨å†Œä¸­å¿ƒ Nacosï¼Œç»“åˆæœåŠ¡åç§°è·å– TC åœ°å€

```yaml
seata:
  registry: # TCæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„é…ç½®ï¼Œå¾®æœåŠ¡æ ¹æ®è¿™äº›ä¿¡æ¯å»æ³¨å†Œä¸­å¿ƒè·å–tcæœåŠ¡åœ°å€
    type: nacos # æ³¨å†Œä¸­å¿ƒç±»å‹ nacos
    nacos:
      server-addr: 127.0.0.1:8848 # nacosåœ°å€
      namespace: "" # namespaceï¼Œé»˜è®¤ä¸ºç©º
      group: DEFAULT_GROUP # åˆ†ç»„ï¼Œé»˜è®¤æ˜¯DEFAULT_GROUP
      application: seata-tc-server # seataæœåŠ¡åç§°
      username: nacos
      password: nacos
  tx-service-group: seata-demo # äº‹åŠ¡ç»„åç§°
  service:
    vgroup-mapping: # äº‹åŠ¡ç»„ä¸clusterçš„æ˜ å°„å…³ç³»
      seata-demo: SH
```

å¾®æœåŠ¡å¦‚ä½•æ ¹æ®è¿™äº›é…ç½®å¯»æ‰¾ TC åœ°å€çš„ï¼Œæˆ‘ä»¬çŸ¥é“æ³¨å†Œåˆ° Nacos ä¸­çš„å¾®æœåŠ¡ï¼Œç¡®å®šä¸€ä¸ªå…·ä½“å®ä¾‹éœ€è¦å››ä¸ªä¿¡æ¯ï¼Œ`namespace+group+application+cluster`

- namespaceï¼šå‘½åç©ºé—´ï¼Œä¸ºç©ºå°±æ˜¯é»˜è®¤çš„ public
- groupï¼šåˆ†ç»„
- applicationï¼šæœåŠ¡å
- clusterï¼šé›†ç¾¤å

ä»¥ä¸Šå››ä¸ªä¿¡æ¯ï¼Œåœ¨åˆšæ‰çš„ yml æ–‡ä»¶ä¸­éƒ½èƒ½æ‰¾åˆ°ã€‚

![](https://cdn.xn2001.com/img/2022/202205241726339.png)

ç»“åˆèµ·æ¥ï¼ŒTC æœåŠ¡çš„ä¿¡æ¯å°±æ˜¯ï¼š`public@DEFAULT_GROUP@seata-tc-server@SH`ï¼Œè¿™æ ·å°±èƒ½ç¡®å®š TC æœåŠ¡é›†ç¾¤äº†ã€‚ç„¶åå°±å¯ä»¥å» Nacosæ‹‰å–å¯¹åº”çš„å®ä¾‹ä¿¡æ¯ã€‚

å¯åŠ¨å¾®æœåŠ¡åï¼ŒSeata æ§åˆ¶å°ä¼šæ˜¾ç¤ºè¿æ¥ä¸Šçš„æœåŠ¡ã€‚

![](https://cdn.xn2001.com/img/2022/202205242305852.png)

### TCæœåŠ¡å¼‚åœ°å®¹ç¾

1.æ¨¡æ‹Ÿå¼‚åœ°å®¹ç¾çš„ TC é›†ç¾¤

è®¡åˆ’å¯åŠ¨ä¸¤å° Seata çš„ TC æœåŠ¡èŠ‚ç‚¹

| èŠ‚ç‚¹åç§° | ipåœ°å€    | ç«¯å£å· | é›†ç¾¤åç§° |
| -------- | --------- | ------ | -------- |
| seata    | 127.0.0.1 | 8091   | SH       |
| seata2   | 127.0.0.1 | 8092   | HZ       |

ä¹‹å‰æˆ‘ä»¬å·²ç»å¯åŠ¨äº†ä¸€å° seata æœåŠ¡ï¼Œç«¯å£æ˜¯ 8091ï¼Œé›†ç¾¤åä¸º SHã€‚

ç°åœ¨ï¼Œå°† seata ç›®å½•å¤åˆ¶ä¸€ä»½ï¼Œèµ·åä¸º seata2

ä¿®æ”¹ seata2/conf/registry.conf å†…å®¹å¦‚ä¸‹

```nginx
registry {
  # tcæœåŠ¡çš„æ³¨å†Œä¸­å¿ƒç±»ï¼Œè¿™é‡Œé€‰æ‹©nacosï¼Œä¹Ÿå¯ä»¥æ˜¯eurekaã€zookeeperç­‰
  type = "nacos"

  nacos {
    # seata tc æœåŠ¡æ³¨å†Œåˆ° nacosçš„æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
    application = "seata-tc-server"
    serverAddr = "127.0.0.1:8848"
    group = "DEFAULT_GROUP"
    namespace = ""
    cluster = "HZ"
    username = "nacos"
    password = "nacos"
  }
}

config {
  # è¯»å–tcæœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä»nacosé…ç½®ä¸­å¿ƒè¯»å–ï¼Œè¿™æ ·å¦‚æœtcæ˜¯é›†ç¾¤ï¼Œå¯ä»¥å…±äº«é…ç½®
  type = "nacos"
  # é…ç½®nacosåœ°å€ç­‰ä¿¡æ¯
  nacos {
    serverAddr = "127.0.0.1:8848"
    namespace = ""
    group = "SEATA_GROUP"
    username = "nacos"
    password = "nacos"
    dataId = "seataServer.properties"
  }
}
```

è¿›å…¥ seata2/bin ç›®å½•ï¼Œç„¶åè¿è¡Œå‘½ä»¤

```powershell
seata-server.bat -p 8092
```

æ‰“å¼€ nacos æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æœåŠ¡åˆ—è¡¨

![](https://cdn.xn2001.com/img/2022/202205241709152.png)

![](https://cdn.xn2001.com/img/2022/202205241709154.png)

2.å°†äº‹åŠ¡ç»„æ˜ å°„é…ç½®åˆ° nacos

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°† tx-service-group ä¸ cluster çš„æ˜ å°„å…³ç³»éƒ½é…ç½®åˆ° Nacos é…ç½®ä¸­å¿ƒã€‚

æ–°å»ºä¸€ä¸ªé…ç½®

![](https://cdn.xn2001.com/img/2022/202205241709167.png)

é…ç½®çš„å†…å®¹å¦‚ä¸‹

```properties
# äº‹åŠ¡ç»„æ˜ å°„å…³ç³»
service.vgroupMapping.seata-demo=SH
service.enableDegrade=false
service.disableGlobalTransaction=false
# ä¸TCæœåŠ¡çš„é€šä¿¡é…ç½®
transport.type=TCP
transport.server=NIO
transport.heartbeat=true
transport.enableClientBatchSendRequest=false
transport.threadFactory.bossThreadPrefix=NettyBoss
transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker
transport.threadFactory.serverExecutorThreadPrefix=NettyServerBizHandler
transport.threadFactory.shareBossWorker=false
transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector
transport.threadFactory.clientSelectorThreadSize=1
transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread
transport.threadFactory.bossThreadSize=1
transport.threadFactory.workerThreadSize=default
transport.shutdown.wait=3
# RMé…ç½®
client.rm.asyncCommitBufferLimit=10000
client.rm.lock.retryInterval=10
client.rm.lock.retryTimes=30
client.rm.lock.retryPolicyBranchRollbackOnConflict=true
client.rm.reportRetryCount=5
client.rm.tableMetaCheckEnable=false
client.rm.tableMetaCheckerInterval=60000
client.rm.sqlParserType=druid
client.rm.reportSuccessEnable=false
client.rm.sagaBranchRegisterEnable=false
# TMé…ç½®
client.tm.commitRetryCount=5
client.tm.rollbackRetryCount=5
client.tm.defaultGlobalTransactionTimeout=60000
client.tm.degradeCheck=false
client.tm.degradeCheckAllowTimes=10
client.tm.degradeCheckPeriod=2000

# undoæ—¥å¿—é…ç½®
client.undo.dataValidation=true
client.undo.logSerialization=jackson
client.undo.onlyCareUpdateColumns=true
client.undo.logTable=undo_log
client.undo.compress.enable=true
client.undo.compress.type=zip
client.undo.compress.threshold=64k
client.log.exceptionRate=100
```

3.å¾®æœåŠ¡è¯»å–nacosé…ç½®

æ¥ä¸‹æ¥ï¼Œéœ€è¦ä¿®æ”¹æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„ application.yml æ–‡ä»¶ï¼Œè®©å¾®æœåŠ¡è¯»å– Nacos ä¸­çš„ client.properties æ–‡ä»¶

```yaml
seata:
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      username: nacos
      password: nacos
      group: SEATA_GROUP
      data-id: client.properties
```

é‡å¯å¾®æœåŠ¡ï¼Œç°åœ¨å¾®æœåŠ¡åˆ°åº•æ˜¯è¿æ¥ TC çš„ SH é›†ç¾¤ï¼Œè¿˜æ˜¯ TC çš„ HZ é›†ç¾¤ï¼Œéƒ½ç»Ÿä¸€ç”± Nacos çš„ client.properties æ¥å†³å®šäº†ã€‚

å¤§ä½“å…ˆäº†è§£è¿™ä¹ˆå¤šï¼Œå…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£å­¦ä¹ ï¼šhttps://seata.io/zh-cn/docs/overview/what-is-seata.html

## XAæ¨¡å¼

XA è§„èŒƒ æ˜¯ X/Open ç»„ç»‡å®šä¹‰çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ï¼ˆDTPï¼ŒDistributed Transaction Processingï¼‰æ ‡å‡†ï¼ŒXA è§„èŒƒæè¿°äº†å…¨å±€çš„ TM ä¸å±€éƒ¨çš„ RM ä¹‹é—´çš„æ¥å£ï¼Œå‡ ä¹æ‰€æœ‰ä¸»æµçš„æ•°æ®åº“éƒ½å¯¹ XA è§„èŒƒæä¾›äº†æ”¯æŒã€‚

XA æ˜¯è§„èŒƒï¼Œç›®å‰ä¸»æµæ•°æ®åº“éƒ½å®ç°äº†è¿™ç§è§„èŒƒï¼Œå®ç°çš„åŸç†éƒ½æ˜¯**åŸºäºä¸¤é˜¶æ®µæäº¤**ã€‚

æ­£å¸¸æƒ…å†µï¼š

![](https://cdn.xn2001.com/img/2022/202205242231750.png)

å¼‚å¸¸æƒ…å†µï¼š

![](https://cdn.xn2001.com/img/2022/202205242231755.png)

ä¸€é˜¶æ®µï¼š

1.äº‹åŠ¡åè°ƒè€…é€šçŸ¥æ¯ä¸ªäº‹ç‰©å‚ä¸è€…æ‰§è¡Œæœ¬åœ°äº‹åŠ¡

2.æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå®ŒæˆåæŠ¥å‘Šäº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ç»™äº‹åŠ¡åè°ƒè€…ï¼Œæ­¤æ—¶äº‹åŠ¡ä¸æäº¤ï¼Œç»§ç»­æŒæœ‰æ•°æ®åº“é”

äºŒé˜¶æ®µï¼š

- äº‹åŠ¡åè°ƒè€…åŸºäºä¸€é˜¶æ®µçš„æŠ¥å‘Šæ¥åˆ¤æ–­ä¸‹ä¸€æ­¥æ“ä½œ
  - å¦‚æœä¸€é˜¶æ®µéƒ½æˆåŠŸï¼Œåˆ™é€šçŸ¥æ‰€æœ‰äº‹åŠ¡å‚ä¸è€…ï¼Œæäº¤äº‹åŠ¡
  - å¦‚æœä¸€é˜¶æ®µä»»æ„ä¸€ä¸ªå‚ä¸è€…å¤±è´¥ï¼Œåˆ™é€šçŸ¥æ‰€æœ‰äº‹åŠ¡å‚ä¸è€…å›æ»šäº‹åŠ¡

Seata å¯¹åŸå§‹çš„ XA æ¨¡å¼åšäº†ç®€å•çš„å°è£…å’Œæ”¹é€ ï¼Œä»¥é€‚åº”è‡ªå·±çš„äº‹åŠ¡æ¨¡å‹ï¼ŒåŸºæœ¬æ¶æ„å¦‚ä¸‹å›¾

![](https://cdn.xn2001.com/img/2022/202205242231760.png)

RM ä¸€é˜¶æ®µçš„å·¥ä½œï¼š

â‘  æ³¨å†Œåˆ†æ”¯äº‹åŠ¡åˆ°TC

â‘¡ æ‰§è¡Œåˆ†æ”¯ä¸šåŠ¡ SQL ä½†ä¸æäº¤

â‘¢ æŠ¥å‘Šæ‰§è¡ŒçŠ¶æ€åˆ° TC

TC äºŒé˜¶æ®µçš„å·¥ä½œï¼š

- TC æ£€æµ‹å„åˆ†æ”¯äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€

  a.å¦‚æœéƒ½æˆåŠŸï¼Œé€šçŸ¥æ‰€æœ‰ RM æäº¤äº‹åŠ¡

  b.å¦‚æœæœ‰å¤±è´¥ï¼Œé€šçŸ¥æ‰€æœ‰ RM å›æ»šäº‹åŠ¡

RM äºŒé˜¶æ®µçš„å·¥ä½œï¼š

- æ¥æ”¶ TC æŒ‡ä»¤ï¼Œæäº¤æˆ–å›æ»šäº‹åŠ¡

### ä¼˜ç¼ºç‚¹

XA æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- äº‹åŠ¡çš„å¼ºä¸€è‡´æ€§ï¼Œæ»¡è¶³ ACID åŸåˆ™ã€‚
- å¸¸ç”¨æ•°æ®åº“éƒ½æ”¯æŒï¼Œå®ç°ç®€å•ï¼Œå¹¶ä¸”æ²¡æœ‰ä»£ç ä¾µå…¥ã€‚

XA æ¨¡å¼çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- å› ä¸ºä¸€é˜¶æ®µéœ€è¦é”å®šæ•°æ®åº“èµ„æºï¼Œç­‰å¾…äºŒé˜¶æ®µç»“æŸæ‰é‡Šæ”¾ï¼Œæ€§èƒ½è¾ƒå·®ã€‚
- ä¾èµ–å…³ç³»å‹æ•°æ®åº“å®ç°äº‹åŠ¡ã€‚

### å®ç°XAæ¨¡å¼

Seata çš„ starter å·²ç»å®Œæˆäº† XA æ¨¡å¼çš„è‡ªåŠ¨è£…é…ï¼Œå®ç°éå¸¸ç®€å•ï¼Œæ­¥éª¤å¦‚ä¸‹

1ï¼‰ä¿®æ”¹æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„ application.yml æ–‡ä»¶ï¼ˆæ¯ä¸ªå‚ä¸äº‹åŠ¡çš„å¾®æœåŠ¡ï¼‰ï¼Œå¼€å¯XAæ¨¡å¼ï¼š

```yaml
seata:
  data-source-proxy-mode: XA
```

2ï¼‰ç»™å‘èµ·å…¨å±€äº‹åŠ¡çš„å…¥å£æ–¹æ³•æ·»åŠ  `@GlobalTransactional` æ³¨è§£

æœ¬ä¾‹ä¸­æ˜¯ OrderServiceImpl ä¸­çš„ create æ–¹æ³•.

![](https://cdn.xn2001.com/img/2022/202205242231783.png)

3ï¼‰é‡å¯æœåŠ¡å¹¶æµ‹è¯•

é‡å¯ order-serviceï¼Œå†æ¬¡æµ‹è¯•ï¼Œå‘ç°æ— è®ºæ€æ ·å¼‚å¸¸æƒ…å†µï¼Œä¸‰ä¸ªå¾®æœåŠ¡éƒ½èƒ½æˆåŠŸå›æ»šã€‚

## ATæ¨¡å¼

AT æ¨¡å¼åŒæ ·æ˜¯åˆ†é˜¶æ®µæäº¤çš„äº‹åŠ¡æ¨¡å‹ï¼Œä¸è¿‡ç¼ºå¼¥è¡¥äº†XAæ¨¡å‹ä¸­èµ„æºé”å®šå‘¨æœŸè¿‡é•¿çš„ç¼ºé™·ã€‚

åŸºæœ¬æµç¨‹å›¾ï¼š

![](https://cdn.xn2001.com/img/2022/202205242258121.png)

é˜¶æ®µä¸€ RM çš„å·¥ä½œï¼š

- æ³¨å†Œåˆ†æ”¯äº‹åŠ¡
- **è®°å½• undo-logï¼ˆæ•°æ®å¿«ç…§ï¼‰**
- **æ‰§è¡Œä¸šåŠ¡ SQL å¹¶æäº¤äº‹åŠ¡**
- æŠ¥å‘Šäº‹åŠ¡çŠ¶æ€

é˜¶æ®µäºŒæäº¤æ—¶ RM çš„å·¥ä½œï¼š

- åˆ é™¤ undo-log å³å¯

é˜¶æ®µäºŒå›æ»šæ—¶ RM çš„å·¥ä½œï¼š

- æ ¹æ® undo-log æ¢å¤æ•°æ®åˆ°æ›´æ–°å‰

### æµç¨‹æ¢³ç†

æˆ‘ä»¬ç”¨ä¸€ä¸ªçœŸå®çš„ä¸šåŠ¡æ¥æ¢³ç†ä¸‹ AT æ¨¡å¼çš„åŸç†ã€‚

æ¯”å¦‚ï¼Œç°åœ¨æœ‰ä¸€ä¸ªæ•°æ®åº“è¡¨ï¼Œè®°å½•ç”¨æˆ·ä½™é¢

| **id** | **money** |
| ------ | --------- |
| 1      | 100       |

å…¶ä¸­ä¸€ä¸ªåˆ†æ”¯ä¸šåŠ¡è¦æ‰§è¡Œçš„ SQL ä¸º

```sql
update tb_account set money = money - 10 where id = 1
```

ATæ¨¡å¼ä¸‹ï¼Œå½“å‰åˆ†æ”¯äº‹åŠ¡æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

ä¸€é˜¶æ®µï¼š

1ï¼‰TM å‘èµ·å¹¶æ³¨å†Œå…¨å±€äº‹åŠ¡åˆ° TC

2ï¼‰TM è°ƒç”¨åˆ†æ”¯äº‹åŠ¡

3ï¼‰åˆ†æ”¯äº‹åŠ¡å‡†å¤‡æ‰§è¡Œä¸šåŠ¡ SQL

4ï¼‰RM æ‹¦æˆªä¸šåŠ¡ SQLï¼Œæ ¹æ® where æ¡ä»¶æŸ¥è¯¢åŸå§‹æ•°æ®ï¼Œå½¢æˆå¿«ç…§ã€‚

```json
{
    "id": 1, "money": 100
}
```

5ï¼‰RM æ‰§è¡Œä¸šåŠ¡ SQLï¼Œæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“é”ã€‚æ­¤æ—¶ `money = 90`

6ï¼‰RM æŠ¥å‘Šæœ¬åœ°äº‹åŠ¡çŠ¶æ€ç»™ TC

äºŒé˜¶æ®µï¼š

1ï¼‰TM é€šçŸ¥ TC äº‹åŠ¡ç»“æŸ

2ï¼‰TC æ£€æŸ¥åˆ†æ”¯äº‹åŠ¡çŠ¶æ€ã€‚å¦‚æœéƒ½æˆåŠŸï¼Œåˆ™ç«‹å³åˆ é™¤å¿«ç…§ï¼›å¦‚æœæœ‰åˆ†æ”¯äº‹åŠ¡å¤±è´¥ï¼Œéœ€è¦å›æ»šã€‚è¯»å–å¿«ç…§æ•°æ®`{"id": 1, "money": 100}`ï¼Œå°†å¿«ç…§æ¢å¤åˆ°æ•°æ®åº“ã€‚æ­¤æ—¶æ•°æ®åº“å†æ¬¡æ¢å¤ä¸º 100ã€‚

![](https://cdn.xn2001.com/img/2022/202205242258118.png)

### ATä¸XAçš„åŒºåˆ«

ç®€è¿° AT æ¨¡å¼ä¸ XA æ¨¡å¼æœ€å¤§çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- XA æ¨¡å¼ä¸€é˜¶æ®µä¸æäº¤äº‹åŠ¡ï¼Œé”å®šèµ„æºï¼›AT æ¨¡å¼ä¸€é˜¶æ®µç›´æ¥æäº¤ï¼Œä¸é”å®šèµ„æºã€‚
- XA æ¨¡å¼ä¾èµ–æ•°æ®åº“æœºåˆ¶å®ç°å›æ»šï¼›AT æ¨¡å¼åˆ©ç”¨æ•°æ®å¿«ç…§å®ç°æ•°æ®å›æ»šã€‚
- XA æ¨¡å¼å¼ºä¸€è‡´ï¼›AT æ¨¡å¼æœ€ç»ˆä¸€è‡´ã€‚

### è„å†™é—®é¢˜

> æ³¨æ„ï¼šæ­¤å¤„è„å†™æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„é—®é¢˜

åœ¨**å¤šçº¿ç¨‹å¹¶å‘**è®¿é—® AT æ¨¡å¼çš„åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œæœ‰å¯èƒ½å‡ºç°è„å†™é—®é¢˜ã€‚å¦‚å›¾ï¼Œå½“äº‹åŠ¡ 1 å› ä¸ºæŸäº›åŸå› è¦æ¢å¤å¿«ç…§æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹çš„äº‹åŠ¡ 2 ç™½æ›´æ–°äº†ä¸€æ¬¡æ•°æ®ï¼Œå‡ºç°äº†è„å†™é—®é¢˜ã€‚

![](https://cdn.xn2001.com/img/2022/202205242258122.png)

è§£å†³æ€è·¯å°±æ˜¯å¼•å…¥äº†å…¨å±€é”çš„æ¦‚å¿µã€‚åœ¨æäº¤äº‹åŠ¡ä¹‹å‰ï¼Œå…ˆå»æ‹¿å…¨å±€é”ï¼Œé¿å…åŒä¸€æ—¶åˆ»æœ‰å¦å¤–ä¸€ä¸ªäº‹åŠ¡åœ¨æ“ä½œå½“å‰æ•°æ®ï¼Œæ‹¿ä¸åˆ°å…¨å±€é”è¶…è¿‡ä¸€å®šæ—¶é—´åˆ™å›æ»šã€‚å¦‚å›¾ï¼Œè¿™æ ·ä¸€æ¥äº‹åŠ¡ 2 å°±æ›´æ–°å¤±è´¥äº†ï¼Œæ­¤æ—¶äº‹åŠ¡ 1 æ¢å¤æ•°æ®ä¸ä¼šç»™å¦ä¸€ä¸ªçº¿ç¨‹äº‹åŠ¡ 2 é€ æˆæ”¹äº†åˆæ²¡æ”¹çš„ç¦»è°±ç°è±¡ã€‚

![](https://cdn.xn2001.com/img/2022/202205242258136.png)

### ä¼˜ç¼ºç‚¹

AT æ¨¡å¼çš„ä¼˜ç‚¹ï¼š

- ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½æ¯”è¾ƒå¥½
- åˆ©ç”¨å…¨å±€é”å®ç°è¯»å†™éš”ç¦»
- æ²¡æœ‰ä»£ç ä¾µå…¥ï¼Œæ¡†æ¶è‡ªåŠ¨å®Œæˆå›æ»šå’Œæäº¤

AT æ¨¡å¼çš„ç¼ºç‚¹ï¼š

- ä¸¤é˜¶æ®µä¹‹é—´å±äºè½¯çŠ¶æ€ï¼Œå±äºæœ€ç»ˆä¸€è‡´
- æ¡†æ¶çš„å¿«ç…§åŠŸèƒ½ä¼šå½±å“æ€§èƒ½ï¼Œä½†æ¯”XAæ¨¡å¼è¦å¥½å¾ˆå¤š

### å®ç°ATæ¨¡å¼

AT æ¨¡å¼ä¸­çš„å¿«ç…§ç”Ÿæˆã€å›æ»šç­‰åŠ¨ä½œéƒ½æ˜¯ç”±æ¡†æ¶è‡ªåŠ¨å®Œæˆï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥ï¼Œå› æ­¤å®ç°éå¸¸ç®€å•ã€‚

åªä¸è¿‡ï¼ŒATæ¨¡å¼éœ€è¦ä¸€ä¸ªè¡¨æ¥è®°å½•å…¨å±€é”ã€å¦ä¸€å¼ è¡¨æ¥è®°å½•æ•°æ®å¿«ç…§ undo_log

1ï¼‰å¯¼å…¥æ•°æ®åº“è¡¨ï¼Œè®°å½•å…¨å±€é”

lock_table è¡¨å¯¼å…¥åˆ° TC æœåŠ¡å…³è”çš„æ•°æ®åº“ï¼Œæˆ‘è¿™é‡Œçš„ TC æœåŠ¡æ•°æ®åº“æ˜¯ seata

```sql
-- ----------------------------
-- Table structure for lock_table
-- ----------------------------
DROP TABLE IF EXISTS `lock_table`;
CREATE TABLE `lock_table`  (
  `row_key` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `xid` varchar(96) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `branch_id` bigint(20) NOT NULL,
  `resource_id` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `table_name` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `pk` varchar(36) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime NULL DEFAULT NULL,
  `gmt_modified` datetime NULL DEFAULT NULL,
  PRIMARY KEY (`row_key`) USING BTREE,
  INDEX `idx_branch_id`(`branch_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;
```

undo_log è¡¨å¯¼å…¥åˆ°å¾®æœåŠ¡å…³è”çš„æ•°æ®åº“ï¼Œæˆ‘è¿™é‡Œçš„å¾®æœåŠ¡æ•°æ®åº“æ˜¯ seata_demo

```sql
-- ----------------------------
-- Table structure for undo_log
-- ----------------------------
DROP TABLE IF EXISTS `undo_log`;
CREATE TABLE `undo_log`  (
  `branch_id` bigint(20) NOT NULL COMMENT 'branch transaction id',
  `xid` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT 'global transaction id',
  `context` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT 'undo_log context,such as serialization',
  `rollback_info` longblob NOT NULL COMMENT 'rollback info',
  `log_status` int(11) NOT NULL COMMENT '0:normal status,1:defense status',
  `log_created` datetime(6) NOT NULL COMMENT 'create datetime',
  `log_modified` datetime(6) NOT NULL COMMENT 'modify datetime',
  UNIQUE INDEX `ux_undo_log`(`xid`, `branch_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = 'AT transaction mode undo table' ROW_FORMAT = Compact;
```

2ï¼‰ä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œå°†äº‹åŠ¡æ¨¡å¼ä¿®æ”¹ä¸º AT æ¨¡å¼å³å¯ã€‚

```yaml
seata:
  data-source-proxy-mode: AT # é»˜è®¤å°±æ˜¯AT
```

3ï¼‰é‡å¯æœåŠ¡å¹¶æµ‹è¯•ã€‚

## TCCæ¨¡å¼

TCC æ¨¡å¼ä¸ AT æ¨¡å¼éå¸¸ç›¸ä¼¼ï¼Œæ¯é˜¶æ®µéƒ½æ˜¯ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸åŒçš„æ˜¯ TCC æ¨¡å¼é€šè¿‡äººå·¥ç¼–ç æ¥å®ç°æ•°æ®æ¢å¤ã€‚éœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š

- Tryï¼šèµ„æºçš„æ£€æµ‹å’Œé¢„ç•™ï¼› 

- Confirmï¼šå®Œæˆèµ„æºæ“ä½œä¸šåŠ¡ï¼›è¦æ±‚ Try æˆåŠŸ Confirm ä¸€å®šè¦èƒ½æˆåŠŸã€‚

- Cancelï¼šé¢„ç•™èµ„æºé‡Šæ”¾ï¼Œå¯ä»¥ç†è§£ä¸º try çš„åå‘æ“ä½œã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ªæ‰£å‡ç”¨æˆ·ä½™é¢çš„ä¸šåŠ¡ã€‚å‡è®¾è´¦æˆ· A åŸæ¥ä½™é¢æ˜¯ 100ï¼Œéœ€è¦ä½™é¢æ‰£å‡ 30 å…ƒã€‚

**é˜¶æ®µä¸€ï¼ˆ Try ï¼‰**ï¼šæ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³åˆ™å†»ç»“é‡‘é¢å¢åŠ  30 å…ƒï¼Œå¯ç”¨ä½™é¢æ‰£é™¤ 30

åˆå§‹ä½™é¢

![](https://cdn.xn2001.com/img/2022/202205261907452.png)

ä½™é¢å……è¶³ï¼Œå¯ä»¥å†»ç»“

![](https://cdn.xn2001.com/img/2022/202205261907455.png)

æ­¤æ—¶ï¼Œæ€»é‡‘é¢ = å†»ç»“é‡‘é¢ + å¯ç”¨é‡‘é¢ï¼Œæ•°é‡ä¾ç„¶æ˜¯ 100 ä¸å˜ã€‚äº‹åŠ¡ç›´æ¥æäº¤æ— éœ€ç­‰å¾…å…¶å®ƒäº‹åŠ¡ã€‚

**é˜¶æ®µäºŒï¼ˆConfirm)**ï¼šå‡å¦‚è¦æäº¤ï¼ˆConfirmï¼‰ï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡ 30

ç¡®è®¤å¯ä»¥æäº¤ï¼Œä¸è¿‡ä¹‹å‰å¯ç”¨é‡‘é¢å·²ç»æ‰£å‡è¿‡äº†ï¼Œè¿™é‡Œåªè¦æ¸…é™¤å†»ç»“é‡‘é¢å°±å¥½äº†

![](https://cdn.xn2001.com/img/2022/202205261907456.png)

æ­¤æ—¶ï¼Œæ€»é‡‘é¢ = å†»ç»“é‡‘é¢ + å¯ç”¨é‡‘é¢ = 0 + 70  = 70å…ƒ

**é˜¶æ®µäºŒ(Canncel)**ï¼šå¦‚æœè¦å›æ»šï¼ˆCancelï¼‰ï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡ 30ï¼Œå¯ç”¨ä½™é¢å¢åŠ  30

éœ€è¦å›æ»šï¼Œé‚£ä¹ˆå°±è¦é‡Šæ”¾å†»ç»“é‡‘é¢ï¼Œæ¢å¤å¯ç”¨é‡‘é¢

![](https://cdn.xn2001.com/img/2022/202205261907454.png)

Seata ä¸­çš„ TCC æ¨¡å‹ä¾ç„¶å»¶ç»­ä¹‹å‰çš„äº‹åŠ¡æ¶æ„ï¼Œå¦‚å›¾ï¼š

![](https://cdn.xn2001.com/img/2022/202205261907469.png)

### ä¼˜ç¼ºç‚¹

TCC æ¨¡å¼çš„æ¯ä¸ªé˜¶æ®µæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ

- Tryï¼šèµ„æºæ£€æŸ¥å’Œé¢„ç•™
- Confirmï¼šä¸šåŠ¡æ‰§è¡Œå’Œæäº¤
- Cancelï¼šé¢„ç•™èµ„æºçš„é‡Šæ”¾

TCC çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½å¥½
- ç›¸æ¯” AT æ¨¡å‹ï¼Œæ— éœ€ç”Ÿæˆå¿«ç…§ï¼Œæ— éœ€ä½¿ç”¨å…¨å±€é”ï¼Œæ€§èƒ½æœ€å¼º
- ä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼Œè€Œæ˜¯ä¾èµ–è¡¥å¿æ“ä½œï¼Œå¯ä»¥ç”¨äºéäº‹åŠ¡å‹æ•°æ®åº“

TCC çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- æœ‰ä»£ç ä¾µå…¥ï¼Œéœ€è¦äººä¸ºç¼–å†™ tryã€Confirm å’Œ Cancel æ¥å£ï¼Œå¤ªéº»çƒ¦
- è½¯çŠ¶æ€ï¼Œäº‹åŠ¡æ˜¯æœ€ç»ˆä¸€è‡´
- éœ€è¦è€ƒè™‘ Confirm å’Œ Cancel çš„å¤±è´¥æƒ…å†µï¼Œåšå¥½å¹‚ç­‰å¤„ç†

### ç©ºå›æ»š

å½“æŸåˆ†æ”¯äº‹åŠ¡çš„ try é˜¶æ®µ**é˜»å¡**æ—¶ï¼Œå¯èƒ½å¯¼è‡´å…¨å±€äº‹åŠ¡è¶…æ—¶è€Œè§¦å‘äºŒé˜¶æ®µçš„ cancel æ“ä½œã€‚åœ¨æœªæ‰§è¡Œ try æ“ä½œæ—¶å…ˆæ‰§è¡Œäº† cancel æ“ä½œï¼Œè¿™æ—¶cancel ä¸èƒ½åšå›æ»šï¼Œå°±æ˜¯**ç©ºå›æ»š**ã€‚æ‰§è¡Œ cancel æ“ä½œæ—¶ï¼Œåº”å½“åˆ¤æ–­ try æ˜¯å¦å·²ç»æ‰§è¡Œï¼Œå¦‚æœå°šæœªæ‰§è¡Œï¼Œåˆ™åº”è¯¥ç©ºå›æ»šã€‚

![](https://cdn.xn2001.com/img/2022/202205261921656.png)

### ä¸šåŠ¡æ‚¬æŒ‚

ç©ºå›æ»šåå‡ºç°çš„ä¸€ä¸ªæ–°é—®é¢˜ï¼šå¯¹äºå·²ç»ç©ºå›æ»šçš„ä¸šåŠ¡ï¼Œä¹‹å‰è¢«é˜»å¡çš„ try æ“ä½œæ¢å¤ï¼Œç»§ç»­æ‰§è¡Œ tryï¼Œå¯æ­¤æ—¶æ•´ä¸ªä¸šåŠ¡éƒ½å·²ç»ç»“æŸäº†ï¼Œéš¾é“æˆ‘ä»¬å¯ä»¥è®©ä»–å†å»èµ° confirm æˆ– cancel å—ï¼Œæ˜¾ç„¶ä¸è¡Œã€‚å› æ­¤äº‹åŠ¡ä¸€ç›´å¤„äºä¸­é—´çŠ¶æ€ï¼Œè¿™å°±æ˜¯**ä¸šåŠ¡æ‚¬æŒ‚**ï¼Œæˆ‘ä»¬åº”å½“å»é¿å…è¿™ç§æƒ…å†µã€‚æ‰€ä»¥æ‰§è¡Œ try æ“ä½œæ—¶ï¼Œåº”å½“åˆ¤æ–­ cancel æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡äº†ï¼Œå¦‚æœå·²ç»æ‰§è¡Œï¼Œ**åº”å½“é˜»æ­¢ç©ºå›æ»šåçš„ try æ“ä½œï¼Œé¿å…æ‚¬æŒ‚ã€‚**

### å®ç°TCCæ¨¡å¼

#### è®¾è®¡æ•°æ®è¡¨

å®ç° TCC æ¨¡å¼æˆ‘ä»¬éƒ½çŸ¥é“è¦å»è®°å½•å†»ç»“çŠ¶æ€ï¼Œæ‰€ä»¥è¿™å°±éœ€è¦ä¸€ä¸ªæ•°æ®è¡¨ã€‚

xidï¼šæ˜¯å…¨å±€äº‹åŠ¡ id

freeze_moneyï¼šç”¨æ¥è®°å½•ç”¨æˆ·å†»ç»“é‡‘é¢

stateï¼šç”¨æ¥è®°å½•äº‹åŠ¡çŠ¶æ€

```sql
CREATE TABLE `account_freeze_tbl` (
  `xid` varchar(128) NOT NULL,
  `user_id` varchar(255) DEFAULT NULL COMMENT 'ç”¨æˆ·id',
  `freeze_money` int(11) unsigned DEFAULT '0' COMMENT 'å†»ç»“é‡‘é¢',
  `state` int(1) DEFAULT NULL COMMENT 'äº‹åŠ¡çŠ¶æ€ï¼Œ0:tryï¼Œ1:confirmï¼Œ2:cancel',
  PRIMARY KEY (`xid`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;
```

- Try ä¸šåŠ¡
  - è®°å½•å†»ç»“é‡‘é¢å’Œäº‹åŠ¡çŠ¶æ€åˆ° account_freeze è¡¨
  - æ‰£å‡ account è¡¨å¯ç”¨é‡‘é¢
- Confirm ä¸šåŠ¡
  - æ ¹æ® xid åˆ é™¤ account_freeze è¡¨çš„å†»ç»“è®°å½•
- Cancel ä¸šåŠ¡
  - ä¿®æ”¹ account_freeze è¡¨ï¼Œå†»ç»“é‡‘é¢ä¸º 0ï¼Œstate ä¸º 2
  - ä¿®æ”¹ account è¡¨ï¼Œæ¢å¤å¯ç”¨é‡‘é¢
- å¦‚ä½•åˆ¤æ–­æ˜¯å¦ç©ºå›æ»š
  - cancel ä¸šåŠ¡ä¸­ï¼Œæ ¹æ® xid æŸ¥è¯¢ account_freezeï¼Œå¦‚æœä¸º null åˆ™è¯´æ˜ try è¿˜æ²¡åšï¼Œéœ€è¦ç©ºå›æ»š
- å¦‚ä½•é¿å…ä¸šåŠ¡æ‚¬æŒ‚
  - try ä¸šåŠ¡ä¸­ï¼Œæ ¹æ® xid æŸ¥è¯¢ account_freezeï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™è¯æ˜ Cancel å·²ç»æ‰§è¡Œï¼Œæ‹’ç»æ‰§è¡Œ try ä¸šåŠ¡

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ ¹æ®å®é™…ä¸šåŠ¡ä¿®æ”¹ account-serviceï¼Œåˆ©ç”¨ TCC å®ç°ä½™é¢æ‰£å‡åŠŸèƒ½ã€‚

#### å£°æ˜TCCæ¥å£

> Seata å…¨å±€äº‹åŠ¡çš„ id å¯ä»¥é€šè¿‡ `RootContext.getXID();` è·å–ï¼Œ
>
> ä¹Ÿå¯ä»¥é€šè¿‡ BusinessActionContext å‚æ•°çš„ getXid() æ–¹æ³•è·å–ã€‚

TCC çš„ Tryã€Confirmã€Cancel æ–¹æ³•éƒ½éœ€è¦åœ¨æ¥å£ä¸­åŸºäºæ³¨è§£æ¥å£°æ˜ï¼Œé¦–å…ˆæ˜¯æ¥å£ä¸Šè¦ç”¨ `@LocalTCC`ï¼Œtry é€»è¾‘æ–¹æ³•ç”¨æ³¨è§£`@TwoPhaseBusinessAction(name="try æ–¹æ³•å", commitMethod="confirm æ–¹æ³•å", rollbackMethod="cancel æ–¹æ³•å") `æ³¨æ˜ ï¼Œåœ¨è¯¥æ–¹æ³•å‚æ•°ä¸ŠåŠ å…¥ `@BusinessActionContextParameter(paramName="try æ–¹æ³•çš„å‚æ•°")`ï¼Œå¯ä»¥ä½¿å¾—è¯¥å‚æ•°ä¼ å…¥ `BusinessActionContext` ç±»ï¼Œä¾¿äº confirm å’Œ cancel è¯»å–ã€‚

![](https://cdn.xn2001.com/img/2022/202205281606688.png)

æˆ‘ä»¬åœ¨ account-service é¡¹ç›®ä¸­çš„ service åŒ…ä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå£°æ˜ TCC ä¸‰ä¸ªæ¥å£ã€‚

```java
@LocalTCC
public interface AccountTCCService {

    @TwoPhaseBusinessAction(name = "deduct", commitMethod = "confirm", rollbackMethod = "cancel")
    void deduct(@BusinessActionContextParameter(paramName = "userId") String userId,
                @BusinessActionContextParameter(paramName = "money")int money);

    boolean confirm(BusinessActionContext ctx);

    boolean cancel(BusinessActionContext ctx);
}
```

#### ç¼–å†™å®ç°ç±»

åœ¨ account-service æœåŠ¡ä¸­çš„ service.impl åŒ…ä¸‹æ–°å»ºä¸€ä¸ªç±»ï¼Œå®ç° TCC ä¸šåŠ¡

```java
@Service
@Slf4j
public class AccountTCCServiceImpl implements AccountTCCService {
    @Autowired
    private AccountMapper accountMapper;
    @Autowired
    private AccountFreezeMapper freezeMapper;

    @Override
    @Transactional
    public void deduct(String userId, int money) {
        // 0.è·å–äº‹åŠ¡id
        String xid = RootContext.getXID();
        // å¤„ç†ä¸šåŠ¡æ‚¬æŒ‚
        if (freezeMapper.selectById(xid) != null) {
            return;
        }
        // 1.æ‰£å‡å¯ç”¨ä½™é¢
        accountMapper.deduct(userId, money);
        // 2.è®°å½•å†»ç»“é‡‘é¢ï¼Œäº‹åŠ¡çŠ¶æ€
        AccountFreeze freeze = new AccountFreeze();
        freeze.setUserId(userId);
        freeze.setFreezeMoney(money);
        freeze.setState(AccountFreeze.State.TRY);
        freeze.setXid(xid);
        freezeMapper.insert(freeze);
    }

    @Override
    public boolean confirm(BusinessActionContext ctx) {
        // 1.è·å–äº‹åŠ¡id
        String xid = ctx.getXid();
        // 2.æ ¹æ®idåˆ é™¤å†»ç»“è®°å½•
        int count = freezeMapper.deleteById(xid);
        return count == 1;
    }

    @Override
    public boolean cancel(BusinessActionContext ctx) {
        // 0.æŸ¥è¯¢å†»ç»“è®°å½•
        String xid = ctx.getXid();
        AccountFreeze freeze = freezeMapper.selectById(xid);
        // å¤„ç†ç©ºå›æ»š
        if (freeze == null) {
            //ç©ºå›æ»š
            freeze = new AccountFreeze();
            String userId = ctx.getActionContext("userId").toString();
            freeze.setUserId(userId);
            freeze.setFreezeMoney(0);
            freeze.setState(AccountFreeze.State.CANCEL);
            freeze.setXid(xid);
            freezeMapper.insert(freeze);
            return true;
        }
        // å¹‚ç­‰åˆ¤æ–­
        if(freeze.getState() == AccountFreeze.State.CANCEL){
            // å·²ç»å¤„ç†è¿‡äº†cancelï¼Œæ— éœ€é‡å¤
            return true;
        }
        // 1.æ¢å¤å¯ç”¨ä½™é¢
        accountMapper.refund(freeze.getUserId(), freeze.getFreezeMoney());
        // 2.å°†å†»ç»“é‡‘é¢æ¸…é›¶ï¼ŒçŠ¶æ€æ”¹ä¸ºCANCEL
        freeze.setFreezeMoney(0);
        freeze.setState(AccountFreeze.State.CANCEL);
        int count = freezeMapper.updateById(freeze);
        return count == 1;
    }
}
```

## SAGAæ¨¡å¼

Saga æ¨¡å¼æ˜¯ Seata å³å°†å¼€æºçš„é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œå°†ç”±èš‚èšé‡‘æœä¸»è¦è´¡çŒ®ã€‚Seata å®˜ç½‘å¯¹äº Saga çš„æŒ‡å—ï¼šhttps://seata.io/zh-cn/docs/user/saga.html

åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¾æ¬¡æ‰§è¡Œå„å‚ä¸è€…çš„æ­£å‘æ“ä½œï¼Œå¦‚æœæ‰€æœ‰æ­£å‘æ“ä½œå‡æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡æäº¤ã€‚å¦‚æœä»»æ„ä¸€ä¸ªæ­£å‘æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¼šå»é€€å›å»æ‰§è¡Œå‰é¢å„å‚ä¸è€…çš„é€†å‘å›æ»šæ“ä½œï¼Œå›æ»šå·²æäº¤çš„å‚ä¸è€…ï¼Œä½¿åˆ†å¸ƒå¼äº‹åŠ¡å›åˆ°åˆå§‹çŠ¶æ€ã€‚

![](https://cdn.xn2001.com/img/2022/202205281708899.png)

Saga æ¨¡å¼ä¹Ÿåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ

- ä¸€é˜¶æ®µï¼šç›´æ¥æäº¤æœ¬åœ°äº‹åŠ¡
- äºŒé˜¶æ®µï¼šæˆåŠŸåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼›å¤±è´¥åˆ™é€šè¿‡ç¼–å†™è¡¥å¿ä¸šåŠ¡æ¥å›æ»š

### ä¼˜ç¼ºç‚¹

ä¼˜ç‚¹ï¼š

- äº‹åŠ¡å‚ä¸è€…å¯ä»¥åŸºäºäº‹ä»¶é©±åŠ¨å®ç°å¼‚æ­¥è°ƒç”¨ï¼Œååé«˜
- ä¸€é˜¶æ®µç›´æ¥æäº¤äº‹åŠ¡ï¼Œæ— é”ï¼Œæ€§èƒ½å¥½
- ä¸ç”¨ç¼–å†™ TCC ä¸­çš„ä¸‰ä¸ªé˜¶æ®µï¼Œå®ç°ç®€å•

ç¼ºç‚¹ï¼š

- è½¯çŠ¶æ€æŒç»­æ—¶é—´ä¸ç¡®å®šï¼Œæ—¶æ•ˆæ€§å·®
- æ²¡æœ‰é”ï¼Œæ²¡æœ‰äº‹åŠ¡éš”ç¦»ï¼Œä¼šæœ‰è„å†™

# Redisåˆ†å¸ƒå¼ç¼“å­˜

> é™ˆå¹´æ—§äº‹ Redisï¼šhttps://www.xn2001.com/archives/598.html

å•æœºçš„ Redis å­˜åœ¨ä»¥ä¸‹å››å¤§é—®é¢˜ï¼Œæˆ‘ä»¬å°†å­¦ç€å»è§£å†³ã€‚

![](https://cdn.xn2001.com/img/2022/202206142215082.png)

## RedisæŒä¹…åŒ–

- RDB æŒä¹…åŒ–
- AOF æŒä¹…åŒ–

### RDBæŒä¹…åŒ–

RDB å…¨ç§° Redis Database Backup fileï¼ˆRedisæ•°æ®å¤‡ä»½æ–‡ä»¶ï¼‰ï¼Œä¹Ÿè¢«å«åš Redis æ•°æ®å¿«ç…§ã€‚ç®€å•æ¥è¯´å°±æ˜¯æŠŠå†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è®°å½•åˆ°ç£ç›˜ä¸­ã€‚å½“ Redis å®ä¾‹æ•…éšœé‡å¯åï¼Œä»ç£ç›˜è¯»å–å¿«ç…§æ–‡ä»¶ï¼Œæ¢å¤æ•°æ®ã€‚å¿«ç…§æ–‡ä»¶ç§°ä¸º RDB æ–‡ä»¶ï¼Œ**é»˜è®¤æ˜¯ä¿å­˜åœ¨å½“å‰è¿è¡Œç›®å½•ã€‚**

RDB æŒä¹…åŒ–åœ¨å››ç§æƒ…å†µä¸‹ä¼šæ‰§è¡Œ

- æ‰§è¡Œ save å‘½ä»¤
- æ‰§è¡Œ bgsave å‘½ä»¤
- Redis åœæœºæ—¶
- è§¦å‘ RDB æ¡ä»¶æ—¶

**save å‘½ä»¤**

æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œä¸€æ¬¡ RDB

![](https://cdn.xn2001.com/img/2022/202206142216902.png)

save å‘½ä»¤ä¼šå¯¼è‡´ä¸»è¿›ç¨‹æ‰§è¡Œ RDBï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­å…¶å®ƒæ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«é˜»å¡ã€‚åªæœ‰åœ¨æ•°æ®è¿ç§»æ—¶å¯èƒ½ç”¨åˆ°ã€‚

**bgsave å‘½ä»¤**

ä¸‹é¢çš„å‘½ä»¤å¯ä»¥å¼‚æ­¥æ‰§è¡Œ RDB

![](https://cdn.xn2001.com/img/2022/202206142216906.png)

è¿™ä¸ªå‘½ä»¤æ‰§è¡Œåä¼šå¼€å¯ç‹¬ç«‹è¿›ç¨‹å®Œæˆ RDBï¼Œä¸»è¿›ç¨‹å¯ä»¥æŒç»­å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œä¸å—å½±å“ã€‚

**åœæœºæ—¶**

Redis åœæœºæ—¶ä¼šæ‰§è¡Œä¸€æ¬¡ save å‘½ä»¤ï¼Œå®ç° RDB æŒä¹…åŒ–ã€‚

**è‡ªåŠ¨è§¦å‘ RDB æ¡ä»¶**

Redis å†…éƒ¨æœ‰è§¦å‘ RDB çš„æœºåˆ¶ï¼Œå¯ä»¥åœ¨ redis.conf æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```properties
# 900ç§’å†…ï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyè¢«ä¿®æ”¹ï¼Œåˆ™æ‰§è¡Œbgsave
# save "" åˆ™è¡¨ç¤ºç¦ç”¨RDB
save 900 1  
save 300 10  
save 60 10000 
```

RDB çš„å…¶å®ƒé…ç½®ä¹Ÿå¯ä»¥åœ¨ redis.conf æ–‡ä»¶ä¸­è®¾ç½®

```properties
# æ˜¯å¦å‹ç¼© ,å»ºè®®ä¸å¼€å¯ï¼Œå‹ç¼©ä¹Ÿä¼šæ¶ˆè€—cpuï¼Œç£ç›˜çš„è¯ä¸å€¼é’±
rdbcompression yes
# RDBæ–‡ä»¶åç§°
dbfilename dump.rdb  
# æ–‡ä»¶ä¿å­˜çš„è·¯å¾„ç›®å½•
dir ./ 
```

bgsave å¼€å§‹æ—¶ä¼š fork ä¸»è¿›ç¨‹å¾—åˆ°å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å…±äº«ä¸»è¿›ç¨‹çš„å†…å­˜æ•°æ®ã€‚å®Œæˆ fork åè¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥ RDB æ–‡ä»¶ã€‚

fork é‡‡ç”¨çš„æ˜¯ copy-on-write æŠ€æœ¯ï¼šå½“ä¸»è¿›ç¨‹æ‰§è¡Œè¯»æ“ä½œæ—¶ï¼Œè®¿é—®å…±äº«å†…å­˜ï¼›å½“ä¸»è¿›ç¨‹æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œåˆ™ä¼šæ‹·è´ä¸€ä»½æ•°æ®ï¼Œæ‰§è¡Œå†™æ“ä½œã€‚

![](https://cdn.xn2001.com/img/2022/202206142216920.png)

RDB æ–¹å¼ bgsave çš„åŸºæœ¬æµç¨‹ï¼Ÿ

- forkä¸»è¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå…±äº«å†…å­˜ç©ºé—´
- å­è¿›ç¨‹è¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥æ–° çš„RDB æ–‡ä»¶
- ç”¨æ–° RDB æ–‡ä»¶æ›¿æ¢æ—§çš„ RDB æ–‡ä»¶

RDB ä¼šåœ¨ä»€ä¹ˆæ—¶å€™è‡ªåŠ¨æ‰§è¡Œï¼Ÿsave 60 1000ä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Ÿ

- é»˜è®¤æ˜¯æœåŠ¡åœæ­¢æ—¶
- ä»£è¡¨ 60s å†…è‡³å°‘æ‰§è¡Œ 1000 æ¬¡ä¿®æ”¹åˆ™è§¦å‘ RDB

RDB çš„ç¼ºç‚¹ï¼Ÿ

- RDB æ‰§è¡Œé—´éš”æ—¶é—´é•¿ï¼Œä¸¤æ¬¡ RDB ä¹‹é—´å†™å…¥æ•°æ®æœ‰ä¸¢å¤±çš„é£é™©
- fork å­è¿›ç¨‹ã€å‹ç¼©ã€å†™å‡º RDB æ–‡ä»¶éƒ½æ¯”è¾ƒè€—æ—¶

### AOFæŒä¹…åŒ–

AOF å…¨ç§°ä¸º Append Only Fileï¼ˆè¿½åŠ æ–‡ä»¶ï¼‰ï¼ŒRedis å¤„ç†çš„æ¯ä¸€ä¸ªå†™å‘½ä»¤éƒ½ä¼šè®°å½•åœ¨ AOF æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åšæ˜¯å‘½ä»¤æ—¥å¿—æ–‡ä»¶ã€‚

![](https://cdn.xn2001.com/img/2022/202206142216922.png)

AOF é»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦ä¿®æ”¹ redis.conf é…ç½®æ–‡ä»¶æ¥å¼€å¯ AOF

```properties
# æ˜¯å¦å¼€å¯AOFåŠŸèƒ½ï¼Œé»˜è®¤æ˜¯no
appendonly yes
# AOFæ–‡ä»¶çš„åç§°
appendfilename "appendonly.aof"
```

AOF çš„å‘½ä»¤è®°å½•çš„é¢‘ç‡ä¹Ÿå¯ä»¥é€šè¿‡ redis.conf æ–‡ä»¶æ¥é…

```properties
# è¡¨ç¤ºæ¯æ‰§è¡Œä¸€æ¬¡å†™å‘½ä»¤ï¼Œç«‹å³è®°å½•åˆ°AOFæ–‡ä»¶
appendfsync always 
# å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç„¶åè¡¨ç¤ºæ¯éš”1ç§’å°†ç¼“å†²åŒºæ•°æ®å†™åˆ°AOFæ–‡ä»¶ï¼Œæ˜¯é»˜è®¤æ–¹æ¡ˆ
appendfsync everysec 
# å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç£ç›˜
appendfsync no
```

ä¸‰ç§ç­–ç•¥å¯¹æ¯”

![](https://cdn.xn2001.com/img/2022/202206142216924.png)

**AOFæ–‡ä»¶é‡å†™**

å› ä¸ºæ˜¯è®°å½•å‘½ä»¤ï¼ŒAOF æ–‡ä»¶ä¼šæ¯” RDB æ–‡ä»¶å¤§çš„å¤šã€‚è€Œä¸” AOF ä¼šè®°å½•å¯¹åŒä¸€ä¸ª key çš„å¤šæ¬¡å†™æ“ä½œï¼Œä½†åªæœ‰æœ€åä¸€æ¬¡å†™æ“ä½œæ‰æœ‰æ„ä¹‰ã€‚é€šè¿‡æ‰§è¡Œ bgrewriteaof å‘½ä»¤ï¼Œå¯ä»¥è®© AOF æ–‡ä»¶æ‰§è¡Œé‡å†™åŠŸèƒ½ï¼Œç”¨æœ€å°‘çš„å‘½ä»¤è¾¾åˆ°ç›¸åŒæ•ˆæœã€‚

![](https://cdn.xn2001.com/img/2022/202206142216934.png)

å¦‚å›¾ï¼ŒAOF åŸæœ¬æœ‰ä¸‰ä¸ªå‘½ä»¤ï¼Œä½†æ˜¯è¿™ä¸‰ä¸ªéƒ½æ˜¯å¯¹ num çš„æ“ä½œï¼Œç¬¬äºŒæ¬¡ä¼šè¦†ç›–ç¬¬ä¸€æ¬¡çš„å€¼ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªå‘½ä»¤è®°å½•ä¸‹æ¥æ²¡æœ‰æ„ä¹‰ã€‚

æ‰€ä»¥é‡å†™å‘½ä»¤åï¼ŒAOFæ–‡ä»¶å†…å®¹å°±æ˜¯ï¼š`mset name jack num 666`

Redis ä¹Ÿä¼šåœ¨è§¦å‘é˜ˆå€¼æ—¶è‡ªåŠ¨å»é‡å†™ AOF æ–‡ä»¶ã€‚é˜ˆå€¼ä¹Ÿå¯ä»¥åœ¨ redis.conf ä¸­é…ç½®

```properties
# AOFæ–‡ä»¶æ¯”ä¸Šæ¬¡æ–‡ä»¶ å¢é•¿è¶…è¿‡å¤šå°‘ç™¾åˆ†æ¯”åˆ™è§¦å‘é‡å†™
auto-aof-rewrite-percentage 100
# AOFæ–‡ä»¶ä½“ç§¯æœ€å°å¤šå¤§ä»¥ä¸Šæ‰è§¦å‘é‡å†™ 
auto-aof-rewrite-min-size 64mb 
```

RDB å’Œ AOF å„æœ‰è‡ªå·±çš„ä¼˜ç¼ºç‚¹ï¼Œå¦‚æœå¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜ï¼Œåœ¨å®é™…å¼€å‘ä¸­å¾€å¾€ä¼šç»“åˆä¸¤è€…æ¥ä½¿ç”¨ã€‚

![](https://cdn.xn2001.com/img/2022/202206142216414.png)

Redis æ”¯æŒåŒæ—¶å¼€å¯ RDB å’Œ AOFï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å½“ Redis é‡å¯çš„æ—¶å€™ä¼šä¼˜å…ˆè½½å…¥ AOF æ–‡ä»¶æ¥æ¢å¤åŸå§‹çš„æ•°æ®ï¼Œå› ä¸ºåœ¨é€šå¸¸æƒ…å†µä¸‹ AOF æ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦æ¯” RDB æ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†å®Œæ•´ã€‚

## Redisä¸»ä»å¤åˆ¶

å•èŠ‚ç‚¹ Redis çš„å¹¶å‘èƒ½åŠ›æ˜¯æœ‰ä¸Šé™çš„ï¼Œè¦è¿›ä¸€æ­¥æé«˜ Redis çš„å¹¶å‘èƒ½åŠ›ï¼Œå°±éœ€è¦æ­å»ºä¸»ä»é›†ç¾¤ï¼Œå®ç°è¯»å†™åˆ†ç¦»ã€‚

![](https://cdn.xn2001.com/img/2022/202206142243954.png)

### æ­å»ºä¸»ä»

> è·³è¿‡éƒ¨ç½²ä¸‰ä¸ª Redisï¼Œå¾ˆç®€å•ã€‚

å…±åŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸¤ä¸ªä»èŠ‚ç‚¹ã€‚

è¿™é‡Œæˆ‘ä»¬åœ¨åŒä¸€å°è™šæ‹Ÿæœºä¸­å¼€å¯ 3 ä¸ª Redis å®ä¾‹ï¼Œæ¨¡æ‹Ÿä¸»ä»é›†ç¾¤ï¼Œä¿¡æ¯å¦‚ä¸‹ï¼š

|       IP        | PORT |  è§’è‰²  |
| :-------------: | :--: | :----: |
| 192.168.150.101 | 7001 | master |
| 192.168.150.101 | 7002 | slave  |
| 192.168.150.101 | 7003 | slave  |

ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬æ‰“å¼€ 3 ä¸ª ssh çª—å£ï¼Œåˆ†åˆ«å¯åŠ¨ Redis å®ä¾‹ï¼Œå¯åŠ¨å‘½ä»¤ï¼š

```sh
# ç¬¬1ä¸ª
redis-server 7001/redis.conf
# ç¬¬2ä¸ª
redis-server 7002/redis.conf
# ç¬¬3ä¸ª
redis-server 7003/redis.conf
```

![](https://cdn.xn2001.com/img/2022/202206150213482.png)

å¦‚æœè¦ä¸€é”®åœæ­¢ï¼Œå¯ä»¥è¿è¡Œä¸‹é¢å‘½ä»¤ï¼š

```sh
printf '%s\n' 7001 7002 7003 | xargs -I{} -t redis-cli -p {} shutdown
```

**å¼€å¯ä¸»ä»å…³ç³»**

ç°åœ¨ä¸‰ä¸ªå®ä¾‹è¿˜æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œè¦é…ç½®ä¸»ä»å¯ä»¥ä½¿ç”¨ `replicaof` æˆ–è€… `slaveof`ï¼ˆ5.0ä»¥å‰ï¼‰å‘½ä»¤ã€‚

æœ‰ä¸´æ—¶å’Œæ°¸ä¹…ä¸¤ç§æ¨¡å¼ï¼š

1.ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰

åœ¨ redis.conf ä¸­æ·»åŠ ä¸€è¡Œé…ç½®ï¼š```slaveof <masterip> <masterport>```

2.ä½¿ç”¨ redis-cli å®¢æˆ·ç«¯è¿æ¥åˆ°redisæœåŠ¡ï¼Œæ‰§è¡Œslaveofå‘½ä»¤ï¼ˆé‡å¯åå¤±æ•ˆï¼‰

`slaveof <masterip> <masterport>`

>  åœ¨ 5.0 ä»¥åæ–°å¢å‘½ä»¤ replicaofï¼Œä¸ salveof æ•ˆæœä¸€è‡´ã€‚

è¿™é‡Œæˆ‘ä»¬ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œä½¿ç”¨æ–¹å¼äºŒã€‚é€šè¿‡ redis-cli å‘½ä»¤è¿æ¥ 7002ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤

```sh
# è¿æ¥ 7002
redis-cli -p 7002
# æ‰§è¡Œslaveof
slaveof 192.168.150.101 7001
```

é€šè¿‡ redis-cli å‘½ä»¤è¿æ¥ 7003ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤

```sh
# è¿æ¥ 7003
redis-cli -p 7003
# æ‰§è¡Œslaveof
slaveof 192.168.150.101 7001
```

ç„¶åè¿æ¥ 7001 èŠ‚ç‚¹ï¼ŒæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š

```sh
# è¿æ¥ 7001
redis-cli -p 7001
# æŸ¥çœ‹çŠ¶æ€
info replication
```

![](https://cdn.xn2001.com/img/2022/202206150213485.png)

æ‰§è¡Œä¸‹åˆ—æ“ä½œä»¥æµ‹è¯•

- åˆ©ç”¨ redis-cli è¿æ¥7001ï¼Œæ‰§è¡Œ```set num 123```

- åˆ©ç”¨ redis-cli è¿æ¥7002ï¼Œæ‰§è¡Œ```get num```ï¼Œå†æ‰§è¡Œ```set num 666```

- åˆ©ç”¨ redis-cli è¿æ¥7003ï¼Œæ‰§è¡Œ```get num```ï¼Œå†æ‰§è¡Œ```set num 888```

å¯ä»¥å‘ç°ï¼Œåªæœ‰åœ¨ 7001 è¿™ä¸ª master èŠ‚ç‚¹ä¸Šå¯ä»¥æ‰§è¡Œå†™æ“ä½œï¼Œ7002 å’Œ 7003 è¿™ä¸¤ä¸ª slave èŠ‚ç‚¹åªèƒ½æ‰§è¡Œè¯»æ“ä½œã€‚

### åŒæ­¥åŸç†

#### å…¨é‡åŒæ­¥

ä¸»ä»ç¬¬ä¸€æ¬¡å»ºç«‹è¿æ¥æ—¶ï¼Œä¼šæ‰§è¡Œ**å…¨é‡åŒæ­¥**ï¼Œå°† master èŠ‚ç‚¹çš„æ‰€æœ‰æ•°æ®éƒ½æ‹·è´ç»™ slave èŠ‚ç‚¹ï¼Œæµç¨‹å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2022/202206150222378.png)

æœ‰å‡ ä¸ªæ¦‚å¿µéœ€è¦çŸ¥é“ï¼š

- **Replication Id**ï¼šç®€ç§° replidï¼Œæ˜¯æ•°æ®é›†çš„æ ‡è®°ï¼Œid ä¸€è‡´åˆ™è¯´æ˜æ˜¯åŒä¸€æ•°æ®é›†ã€‚æ¯ä¸€ä¸ª master éƒ½æœ‰å”¯ä¸€çš„replidï¼Œslave åˆ™ä¼šç»§æ‰¿ master èŠ‚ç‚¹çš„ replidï¼›
- **offset**ï¼šåç§»é‡ï¼Œéšç€è®°å½•åœ¨ repl_baklog ä¸­çš„æ•°æ®å¢å¤šè€Œé€æ¸å¢å¤§ã€‚slave å®ŒæˆåŒæ­¥æ—¶ä¹Ÿä¼šè®°å½•å½“å‰åŒæ­¥çš„offsetï¼Œå³ slave çš„ offset æ°¸è¿œå°äºç­‰äº master çš„ offsetï¼›å½“ slave çš„ offset å°äº master çš„ offsetï¼Œè¯´æ˜ slave æ•°æ®è½åäº masterï¼Œéœ€è¦æ›´æ–°ã€‚

å› æ­¤ slave åšæ•°æ®åŒæ­¥ï¼Œå¿…é¡»å‘ master å£°æ˜è‡ªå·±çš„ replid å’Œ offsetï¼Œmaster æ‰å¯ä»¥åˆ¤æ–­åˆ°åº•éœ€è¦åŒæ­¥å“ªäº›æ•°æ®ã€‚è€Œ slave åŸæœ¬ä¹Ÿæ˜¯ä¸€ä¸ª masterï¼Œæœ‰è‡ªå·±çš„ replid å’Œ offsetï¼Œå½“ç¬¬ä¸€æ¬¡å˜æˆ slaveï¼Œä¸ master å»ºç«‹è¿æ¥æ—¶ï¼Œå‘é€çš„ replid å’Œ offset æ˜¯è‡ªå·±çš„ replid å’Œ offsetã€‚master åˆ¤æ–­å‘ç° slave å‘é€æ¥çš„ replid ä¸è‡ªå·±çš„ä¸ä¸€è‡´ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„ slaveï¼Œå°±çŸ¥é“è¦åšå…¨é‡åŒæ­¥äº†ã€‚master ä¼šå°†è‡ªå·±çš„ replid å’Œ offset éƒ½å‘é€ç»™è¿™ä¸ª slaveï¼Œslave ä¿å­˜è¿™äº›ä¿¡æ¯ã€‚ä»¥å slave çš„replid å°±ä¸ master ä¸€è‡´äº†ã€‚å› æ­¤ï¼Œ**masteråˆ¤æ–­ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥çš„ä¾æ®ï¼Œå°±æ˜¯çœ‹ replid æ˜¯å¦ä¸€è‡´**ã€‚

![](https://cdn.xn2001.com/img/2022/202206150222382.png)

å®Œæ•´æµç¨‹æè¿°ï¼š

- slave èŠ‚ç‚¹è¯·æ±‚å¢é‡åŒæ­¥
- master èŠ‚ç‚¹åˆ¤æ–­ replidï¼Œå‘ç°ä¸ä¸€è‡´ï¼Œæ‹’ç»å¢é‡åŒæ­¥ï¼Œé€‰æ‹©å…¨é‡åŒæ­¥
- master å°†å®Œæ•´å†…å­˜æ•°æ®ç”Ÿæˆ RDBï¼Œå‘é€ RDB åˆ° slave
- slave æ¸…ç©ºæœ¬åœ°æ•°æ®ï¼ŒåŠ è½½ master çš„ RDB
- master å°† RDB æœŸé—´çš„å‘½ä»¤è®°å½•åœ¨ repl_baklogï¼Œå¹¶æŒç»­å°† log ä¸­çš„å‘½ä»¤å‘é€ç»™ slave
- slave æ‰§è¡Œæ¥æ”¶åˆ°çš„å‘½ä»¤ï¼Œä¿æŒä¸ master ä¹‹é—´çš„åŒæ­¥

#### å¢é‡åŒæ­¥

å…¨é‡åŒæ­¥éœ€è¦å…ˆåš RDBï¼Œç„¶åå°† RDB æ–‡ä»¶é€šè¿‡ç½‘ç»œä¼ è¾“ç»™ slaveï¼Œæˆæœ¬å¤ªé«˜ã€‚å› æ­¤é™¤äº†ç¬¬ä¸€æ¬¡åšå…¨é‡åŒæ­¥ï¼Œå…¶å®ƒå¤§å¤šæ•°æ—¶å€™ slave ä¸ master éƒ½æ˜¯åš**å¢é‡åŒæ­¥**ã€‚

ä»€ä¹ˆæ˜¯å¢é‡åŒæ­¥ï¼Ÿå°±æ˜¯åªæ›´æ–° slave ä¸ master å­˜åœ¨å·®å¼‚çš„éƒ¨åˆ†æ•°æ®ã€‚

![](https://cdn.xn2001.com/img/2022/202206150222386.png)

**repl_backlog åŸç†**

master æ€ä¹ˆçŸ¥é“ slave ä¸è‡ªå·±çš„æ•°æ®å·®å¼‚åœ¨å“ªé‡Œï¼Ÿ

è¿™å°±è¦è¯´åˆ°å…¨é‡åŒæ­¥æ—¶çš„ repl_baklog æ–‡ä»¶äº†ã€‚

è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„ï¼Œåªä¸è¿‡æ•°ç»„æ˜¯ç¯å½¢ï¼Œä¹Ÿå°±æ˜¯è¯´**è§’æ ‡åˆ°è¾¾æ•°ç»„æœ«å°¾åï¼Œä¼šå†æ¬¡ä» 0 å¼€å§‹è¯»å†™**ï¼Œè¿™æ ·æ•°ç»„å¤´éƒ¨çš„æ•°æ®å°±ä¼šè¢«è¦†ç›–ã€‚repl_baklog ä¸­ä¼šè®°å½• Redis å¤„ç†è¿‡çš„å‘½ä»¤æ—¥å¿—åŠ offsetï¼ŒåŒ…æ‹¬ master å½“å‰çš„ offset å’Œ slave å·²ç»æ‹·è´åˆ°çš„ offset

![](https://cdn.xn2001.com/img/2022/202206150222384.png) 

slave ä¸ master çš„ offset ä¹‹é—´çš„å·®å¼‚ï¼Œå°±æ˜¯ salve éœ€è¦å¢é‡æ‹·è´çš„æ•°æ®äº†ã€‚

éšç€ä¸æ–­æœ‰æ•°æ®å†™å…¥ï¼Œmaster çš„ offset é€æ¸å˜å¤§ï¼Œslave ä¹Ÿä¸æ–­çš„æ‹·è´ï¼Œè¿½èµ¶ master çš„ offsetï¼Œç›´åˆ°æ•°ç»„è¢«å¡«æ»¡ï¼š

![](https://cdn.xn2001.com/img/2022/202206150222403.png) 

![](https://cdn.xn2001.com/img/2022/202206150222407.png) 

æ­¤æ—¶ï¼Œå¦‚æœæœ‰æ–°çš„æ•°æ®å†™å…¥ï¼Œå°±ä¼šè¦†ç›–æ•°ç»„ä¸­çš„æ—§æ•°æ®ã€‚ä¸è¿‡ï¼Œæ—§çš„æ•°æ®åªè¦æ˜¯ç»¿è‰²çš„ï¼Œè¯´æ˜æ˜¯å·²ç»è¢«åŒæ­¥åˆ°slave çš„æ•°æ®ï¼Œå³ä¾¿è¢«è¦†ç›–äº†ä¹Ÿæ²¡ä»€ä¹ˆå½±å“ã€‚å› ä¸ºæœªåŒæ­¥çš„ä»…ä»…æ˜¯çº¢è‰²éƒ¨åˆ†ã€‚ä½†æ˜¯ï¼Œå¦‚æœ slave å‡ºç°ç½‘ç»œé˜»å¡ï¼Œå¯¼è‡´ master çš„ offset è¿œè¿œè¶…è¿‡äº† slave çš„ offsetï¼Œå¦‚ä¸‹å›¾

![](https://cdn.xn2001.com/img/2022/202206150222063.png) 

å¦‚æœ master ç»§ç»­å†™å…¥æ–°æ•°æ®ï¼Œå…¶ offset å°±ä¼šè¦†ç›–æ—§çš„æ•°æ®ï¼Œç›´åˆ°å°† slave ç°åœ¨çš„ offset ä¹Ÿè¦†ç›–äº†

![](https://cdn.xn2001.com/img/2022/202206150222082.png) 

æ£•è‰²æ¡†ä¸­çš„çº¢è‰²éƒ¨åˆ†ï¼Œå°±æ˜¯å°šæœªåŒæ­¥ï¼Œä½†æ˜¯å´å·²ç»è¢«è¦†ç›–çš„æ•°æ®ã€‚æ­¤æ—¶å¦‚æœ slave æ¢å¤ï¼Œéœ€è¦åŒæ­¥ï¼Œå´å‘ç°è‡ªå·±çš„ offset éƒ½æ²¡æœ‰äº†ï¼Œ**æ— æ³•å®Œæˆå¢é‡åŒæ­¥äº†ï¼Œåªèƒ½åšå…¨é‡åŒæ­¥ã€‚**

![](https://cdn.xn2001.com/img/2022/202206150222104.png)

### ä¸»ä»åŒæ­¥ä¼˜åŒ–

ä¸»ä»åŒæ­¥å¯ä»¥ä¿è¯ä¸»ä»æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéå¸¸é‡è¦ã€‚å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥ä¼˜åŒ– Redis ä¸»ä»é›†ç¾¤

- åœ¨ master ä¸­é…ç½® `repl-diskless-sync yes` å¯ç”¨æ— ç£ç›˜å¤åˆ¶ï¼Œé¿å…å…¨é‡åŒæ­¥æ—¶çš„ç£ç›˜ IO
- Redis å•èŠ‚ç‚¹ä¸Šçš„å†…å­˜å ç”¨ä¸è¦å¤ªå¤§ï¼Œå‡å°‘ RDB å¯¼è‡´çš„è¿‡å¤šç£ç›˜IO
- é€‚å½“æé«˜ repl_baklog çš„å¤§å°ï¼Œå‘ç° slave å®•æœºæ—¶å°½å¿«å®ç°æ•…éšœæ¢å¤ï¼Œå°½å¯èƒ½é¿å…å…¨é‡åŒæ­¥
- é™åˆ¶ä¸€ä¸ª master ä¸Šçš„ slave èŠ‚ç‚¹æ•°é‡ï¼Œå¦‚æœå®åœ¨æ˜¯å¤ªå¤š slaveï¼Œåˆ™å¯ä»¥é‡‡ç”¨**ä¸»-ä»-ä»**é“¾å¼ç»“æ„ï¼Œå‡å°‘ master å‹åŠ›

![](https://cdn.xn2001.com/img/2022/202206150222112.png)

ç®€è¿°å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥åŒºåˆ«ï¼Ÿ

- å…¨é‡åŒæ­¥ï¼šmaster å°†å®Œæ•´å†…å­˜æ•°æ®ç”Ÿæˆ RDBï¼Œå‘é€ RDB åˆ° slaveã€‚åç»­å‘½ä»¤åˆ™è®°å½•åœ¨ repl_baklogï¼Œé€ä¸ªå‘é€ç»™slave
- å¢é‡åŒæ­¥ï¼šslave æäº¤è‡ªå·±çš„ offset åˆ° masterï¼Œmaster è·å– repl_baklog ä¸­ä» offset ä¹‹åçš„å‘½ä»¤ç»™slave

ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå…¨é‡åŒæ­¥ï¼Ÿ

- slave èŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥ master èŠ‚ç‚¹æ—¶
- slave èŠ‚ç‚¹æ–­å¼€æ—¶é—´å¤ªä¹…ï¼Œrepl_baklog ä¸­çš„ offset å·²ç»è¢«è¦†ç›–æ—¶

ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå¢é‡åŒæ­¥ï¼Ÿ

- slave èŠ‚ç‚¹æ–­å¼€åˆæ¢å¤ï¼Œå¹¶ä¸”åœ¨ repl_baklog ä¸­èƒ½æ‰¾åˆ° offset æ—¶

## Rediså“¨å…µ



## Redisåˆ†ç‰‡é›†ç¾¤</textarea>

                          <!--æ–‡ç« çš„é¡µè„šéƒ¨ä»¶ï¼šæ‰“èµå’Œå…¶ä»–ä¿¡æ¯çš„è¾“å‡º-->
             <div class="show-foot"><div class="notebook" data-toggle="tooltip" data-original-title="2022 å¹´ 07 æœˆ 03 æ—¥ 01 : 05  AM">
                     <i class="fontello fontello-clock-o"></i>
                     <span>æœ€åä¿®æ”¹ï¼š2022 å¹´ 07 æœˆ 03 æ—¥</span>
                 </div><div class="copyright" data-toggle="tooltip" data-html="true" data-original-title="è½¬è½½è¯·ä¿ç•™æœ¬æ–‡è½¬è½½åœ°å€ï¼Œè‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰"><span>Â© å…è®¸è§„èŒƒè½¬è½½</span>
                 </div>
             </div>
                         <!--æ‰“èµæ¨¡å—-->
             <div class="support-author">
                 <button id="support_author"  data-toggle="modal" data-target="#myModal" class="box-shadow-wrap-lg btn_post_footer btn btn-pay btn-yellow btn-rounded"><svg fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icon" aria-hidden="true"><path d="M10.084 7.606c3.375-1.65 7.65-1.154 10.493 1.487 3.497 3.25 3.497 8.519 0 11.77-3.498 3.25-9.167 3.25-12.665 0-.897-.834-2.488-2.96-2.488-5.085" stroke="currentColor" stroke-width="1.4" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M17.392 14.78s1.532-1.318-.053-2.79c-1.585-1.473-3.17-.404-3.719.403-.549.807.495 2.082.93 2.69.434.61 1.364 2.182-.054 3.202-1.417 1.012-3.002.658-4.153-.708-1.15-1.367-.602-3.365 0-3.924M17.338 11.982l1.159-1.076M9.87 18.922l.937-.871" stroke="currentColor" stroke-width="1.4" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M.8 1.205s7.15 4.673 8.773 6.182c1.623 1.508 3.231 4.008 1.616 5.509-2.195 2.04-4.054.595-6.737-.75-.884-.447-3.15-1.777-3.15-1.777M10.136.9l1.047 3.188" stroke="currentColor" stroke-width="1.4" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></svg><span>æ‰“èµ</span></button> <div id="myModal" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
                 <div class="modal-dialog modal-sm" role="document">
                     <div class="modal-content box-shadow-wrap-lg">
                         <div class="modal-header box-shadow-bottom-normal">
                             <button type="button" class="close" data-dismiss="modal"><i style="vertical-align: bottom;" data-feather="x-circle"></i></button>
                             <h4 class="modal-title">èµèµä½œè€…</h4>
                         </div>
                         <div class="modal-body">
                             <div class="solid-tab tab-container post_tab">
                                <ul class="nav no-padder b-b scroll-hide" role="tablist"> <li class="nav-item active" role="presentation"><a class="nav-link active" style="" data-toggle="tab"  role="tab" data-target="#alipay_author"><i class="iconfont icon-alipay" aria-hidden="true"></i>æ”¯ä»˜å®</a></li><li class="nav-item " role="presentation"><a class="nav-link " style="" data-toggle="tab"  role="tab" data-target="#wechatpay_author"><i class="iconfont icon-wechatpay" aria-hidden="true"></i>å¾®ä¿¡</a></li>        </ul>
                                <div class="tab-content no-border"><div role="tabpanel" id="alipay_author" class="tab-pane fade active in">
                            <img noGallery class="pay-img tab-pane" id="alipay_author" role="tabpanel" src="https://www.xn2001.com/usr/themes/handsome/assets/img/loading.svg" data-original="https://cdn.xn2001.com/blog/zfb.jpg" />
                            </div><div role="tabpanel" id="wechatpay_author" class="tab-pane fade  ">
                            <img noGallery  class="pay-img tab-pane" id="wechatpay_author" role="tabpanel" src="https://www.xn2001.com/usr/themes/handsome/assets/img/loading.svg" data-original="https://cdn.xn2001.com/blog/vx.jpg" />
                            </div>    </div><!--tab-content-->
                             </div> <!--tab-container--></div> <!--modal-body-->
                         </div><!--modal-content-->
                     </div><!--modal-dialog-->
                 </div><!--modal-->
        <button id="star_post" data-cid="663" class="box-shadow-wrap-lg btn_post_footer like_button btn btn-pay btn-rounded">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shake-little unlike_svg feather feather-thumbs-up"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                 <div class="circle-rounded"></div>
                 <svg class="liked_svg" style="transform: scale(2.2);" xmlns="http://www.w3.org/2000/svg" viewBox="30 30 60 60" width="60" height="60" preserveAspectRatio="xMidYMid meet">
                    <g clip-path="url(#__lottie_element_1061)">
                        <g style="display: block;" transform="matrix(1,-0.0000012433954452717444,0.0000012433954452717444,1,47.87498474121094,47.057003021240234)" opacity="1">
                            <g class="like_rotate">
                                <g opacity="1" transform="matrix(1,0,0,1,14.376999855041504,11.416000366210938)">
                                    <path stroke-linecap="butt" stroke-linejoin="miter" fill-opacity="0" stroke-miterlimit="10" stroke="rgb(255,255,255)" stroke-opacity="1" stroke-width="2" d=" M-7.936999797821045,9.531000137329102 C-7.936999797821045,9.531000137329102 3.378000020980835,9.531000137329102 3.378000020980835,9.531000137329102 C3.815999984741211,9.531000137329102 4.209000110626221,9.258999824523926 4.360000133514404,8.847000122070312 C4.360000133514404,8.847000122070312 7.501999855041504,0.36000001430511475 7.501999855041504,0.36000001430511475 C8.020000457763672,-1.0360000133514404 6.986000061035156,-2.5199999809265137 5.497000217437744,-2.5199999809265137 C5.497000217437744,-2.5199999809265137 -0.5669999718666077,-2.5199999809265137 -0.5669999718666077,-2.5199999809265137 C-0.6399999856948853,-2.5199999809265137 -0.6859999895095825,-2.5969998836517334 -0.6499999761581421,-2.6600000858306885 C-0.36800000071525574,-3.1679999828338623 0.6269999742507935,-4.922999858856201 0.8870000243186951,-5.764999866485596 C1.309000015258789,-7.13100004196167 0.847000002861023,-8.715999603271484 -1.4539999961853027,-9.519000053405762 C-1.4759999513626099,-9.526000022888184 -1.4989999532699585,-9.527000427246094 -1.5180000066757202,-9.519000053405762 C-1.5299999713897705,-9.513999938964844 -1.5410000085830688,-9.505999565124512 -1.5490000247955322,-9.494000434875488 C-1.7309999465942383,-9.234999656677246 -2.6489999294281006,-7.934000015258789 -3.6419999599456787,-6.52400016784668 C-4.795000076293945,-4.888000011444092 -6.050000190734863,-3.1059999465942383 -6.380000114440918,-2.638000011444092 C-6.434000015258789,-2.562000036239624 -6.519000053405762,-2.5199999809265137 -6.611000061035156,-2.5199999809265137 C-6.611000061035156,-2.5199999809265137 -7.938000202178955,-2.5199999809265137 -7.938000202178955,-2.5199999809265137 C-7.982999801635742,-2.5199999809265137 -8.020000457763672,-2.4839999675750732 -8.020000457763672,-2.437999963760376 C-8.020000457763672,-2.437999963760376 -8.020000457763672,9.447999954223633 -8.020000457763672,9.447999954223633 C-8.020000457763672,9.494000434875488 -7.982999801635742,9.531000137329102 -7.936999797821045,9.531000137329102z"></path>
                                    <path fill="rgb(255,255,255)" fill-opacity="1" d=" M-7.936999797821045,9.531000137329102 C-7.936999797821045,9.531000137329102 3.378000020980835,9.531000137329102 3.378000020980835,9.531000137329102 C3.815999984741211,9.531000137329102 4.209000110626221,9.258999824523926 4.360000133514404,8.847000122070312 C4.360000133514404,8.847000122070312 7.501999855041504,0.36000001430511475 7.501999855041504,0.36000001430511475 C8.020000457763672,-1.0360000133514404 6.986000061035156,-2.5199999809265137 5.497000217437744,-2.5199999809265137 C5.497000217437744,-2.5199999809265137 -0.5669999718666077,-2.5199999809265137 -0.5669999718666077,-2.5199999809265137 C-0.6399999856948853,-2.5199999809265137 -0.6859999895095825,-2.5969998836517334 -0.6499999761581421,-2.6600000858306885 C-0.36800000071525574,-3.1679999828338623 0.6269999742507935,-4.922999858856201 0.8870000243186951,-5.764999866485596 C1.309000015258789,-7.13100004196167 0.847000002861023,-8.715999603271484 -1.4539999961853027,-9.519000053405762 C-1.4759999513626099,-9.526000022888184 -1.4989999532699585,-9.527000427246094 -1.5180000066757202,-9.519000053405762 C-1.5299999713897705,-9.513999938964844 -1.5410000085830688,-9.505999565124512 -1.5490000247955322,-9.494000434875488 C-1.7309999465942383,-9.234999656677246 -2.6489999294281006,-7.934000015258789 -3.6419999599456787,-6.52400016784668 C-4.795000076293945,-4.888000011444092 -6.050000190734863,-3.1059999465942383 -6.380000114440918,-2.638000011444092 C-6.434000015258789,-2.562000036239624 -6.519000053405762,-2.5199999809265137 -6.611000061035156,-2.5199999809265137 C-6.611000061035156,-2.5199999809265137 -7.938000202178955,-2.5199999809265137 -7.938000202178955,-2.5199999809265137 C-7.982999801635742,-2.5199999809265137 -8.020000457763672,-2.4839999675750732 -8.020000457763672,-2.437999963760376 C-8.020000457763672,-2.437999963760376 -8.020000457763672,9.447999954223633 -8.020000457763672,9.447999954223633 C-8.020000457763672,9.494000434875488 -7.982999801635742,9.531000137329102 -7.936999797821045,9.531000137329102z"></path>
                                </g>
                                <g opacity="1" transform="matrix(1,0,0,1,2.694000005722046,14.967000007629395)">
                                    <path fill="rgb(255,255,255)" fill-opacity="1" d=" M0.5019999742507935,7.0269999504089355 C0.5019999742507935,7.0269999504089355 -0.5019999742507935,7.0269999504089355 -0.5019999742507935,7.0269999504089355 C-0.7789999842643738,7.0269999504089355 -1.003999948501587,6.802000045776367 -1.003999948501587,6.525000095367432 C-1.003999948501587,6.525000095367432 -1.003999948501587,-6.525000095367432 -1.003999948501587,-6.525000095367432 C-1.003999948501587,-6.802000045776367 -0.7789999842643738,-7.0269999504089355 -0.5019999742507935,-7.0269999504089355 C-0.5019999742507935,-7.0269999504089355 0.5019999742507935,-7.0269999504089355 0.5019999742507935,-7.0269999504089355 C0.7789999842643738,-7.0269999504089355 1.003999948501587,-6.802000045776367 1.003999948501587,-6.525000095367432 C1.003999948501587,-6.525000095367432 1.003999948501587,6.525000095367432 1.003999948501587,6.525000095367432 C1.003999948501587,6.802000045776367 0.7789999842643738,7.0269999504089355 0.5019999742507935,7.0269999504089355z"></path>
                                </g>
                            </g>
                        </g>
                    </g>
                 </svg>
                 <span>èµ&nbsp;<span id="like_label" class="like_label">124</span></span>
                 </button><div class="mt20 text-center article__reward-info">
                        <span class="mr10">å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰ç”¨ï¼Œè¯·éšæ„èµèµ</span>
                       </div>
                     </div><!--support-author-->             <!--/æ–‡ç« çš„é¡µè„šéƒ¨ä»¶ï¼šæ‰“èµå’Œå…¶ä»–ä¿¡æ¯çš„è¾“å‡º-->
         </div>
        </article>
       </div>
       <!--ä¸Šä¸€ç¯‡&ä¸‹ä¸€ç¯‡-->
       <nav class="m-t-lg m-b-lg">
        <ul class="pager">
        <li class="next"> <a class="box-shadow-wrap-normal" href="https://www.xn2001.com/archives/659.html" title="ElementUIè¡¨æ ¼é¡¹åˆå¹¶" data-toggle="tooltip"> 
ä¸‹ä¸€ç¯‡ </a></li>   <li class="previous"> <a class="box-shadow-wrap-normal" href="https://www.xn2001.com/archives/664.html" title="Java-Socketå®ç°ç®€å•èŠå¤©å®¤" data-toggle="tooltip"> ä¸Šä¸€ç¯‡ </a></li>
        </ul>
       </nav>
       <!--è¯„è®º-->
        
    
    
    <div id="comments">
    
                    <!--è¯„è®ºåˆ—è¡¨-->
            <div id="post-comment-list" class="skt-loading"><h4 class="comments-title m-t-lg m-b">52 æ¡è¯„è®º</h4><nav class="loading-nav text-center m-t-lg m-b-lg hide">
<p class="infinite-scroll-request"><i class="animate-spin fontello fontello-refresh"></i>Loading...</p>
</nav><ol class="comment-list">
        <!--è‡ªå®šä¹‰è¯„è®ºä»£ç ç»“æ„-->

        <li id="comment-656" class="comment-body comment-parent comment-odd">
            <div id="div-comment-656" class="comment-body">
    
                <a class="pull-left thumb-sm comment-avatar" rel="nofollow">
                    <img nogallery src="https://cravatar.cn/avatar//d41d8cd98f00b204e9800998ecf8427e?s=65&r=G&d=" class="img-40px photo img-square normal-shadow">                    
                </a>
                <div class="m-b m-l-xxl">
                    <div class="comment-meta">
            <span class="comment-author vcard">
              <b class="fn">éŸ©å¼ç‚¸é¸¡</b>
                                <a data-coid="656" class="post-comment-star text-muted star_talk"><i class="glyphicon glyphicon-heart-empty"></i>&nbsp;<span class="star_count"></span></a>
                              </span>
                        <div class="comment-metadata">
                            <time class="format_time text-muted text-xs block m-t-xs" pubdate="pubdate" datetime="2022-09-05T21:11:19+08:00">September 5th, 2022 at 09:11 pm</time>                        </div>
                    </div>
                    <!--å›å¤å†…å®¹-->
                    <div class="comment-content m-t-sm">
                        <span class="comment-author-at"><b></b></span><div class="comment-content-true">
                            <p>å¯ä»¥åˆ†äº«ä¸‹è½½å—OÏ‰O</p>                        </div>
                    </div>
                    <!--å›å¤æŒ‰é’®-->
                    <div class="comment-reply m-t-sm">
                        <a href="https://www.xn2001.com/archives/663.html/comment-page-1?replyTo=656#respond-post-663" rel="nofollow" onclick="return TypechoComment.reply('comment-656', 656);">å›å¤</a>                    </div>
                </div>
    
            </div>
            <!-- å•æ¡è¯„è®ºè€…ä¿¡æ¯åŠå†…å®¹ -->
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­ç»“æŸ -->
        </li><!--åŒ¹é…`è‡ªå®šä¹‰è¯„è®ºçš„ä»£ç ç»“æ„`ä¸‹é¢çš„liæ ‡ç­¾-->
    
        <!--è‡ªå®šä¹‰è¯„è®ºä»£ç ç»“æ„-->
    
        <li id="comment-655" class="comment-body comment-parent comment-even">
            <div id="div-comment-655" class="comment-body">
    
                <a class="pull-left thumb-sm comment-avatar" rel="nofollow">
                    <img nogallery src="https://q2.qlogo.cn/g?b=qq&nk=2367254022&s=100" class="img-40px photo img-square normal-shadow">                    
                </a>
                <div class="m-b m-l-xxl">
                    <div class="comment-meta">
            <span class="comment-author vcard">
              <b class="fn">asdads</b>
                                <a data-coid="655" class="post-comment-star text-muted star_talk"><i class="glyphicon glyphicon-heart-empty"></i>&nbsp;<span class="star_count"></span></a>
                              </span>
                        <div class="comment-metadata">
                            <time class="format_time text-muted text-xs block m-t-xs" pubdate="pubdate" datetime="2022-09-01T17:26:01+08:00">September 1st, 2022 at 05:26 pm</time>                        </div>
                    </div>
                    <!--å›å¤å†…å®¹-->
                    <div class="comment-content m-t-sm">
                        <span class="comment-author-at"><b></b></span><div class="comment-content-true">
                            <p>dockerç¯‡å‘¢</p>                        </div>
                    </div>
                    <!--å›å¤æŒ‰é’®-->
                    <div class="comment-reply m-t-sm">
                        <a href="https://www.xn2001.com/archives/663.html/comment-page-1?replyTo=655#respond-post-663" rel="nofollow" onclick="return TypechoComment.reply('comment-655', 655);">å›å¤</a>                    </div>
                </div>
    
            </div>
            <!-- å•æ¡è¯„è®ºè€…ä¿¡æ¯åŠå†…å®¹ -->
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­ç»“æŸ -->
        </li><!--åŒ¹é…`è‡ªå®šä¹‰è¯„è®ºçš„ä»£ç ç»“æ„`ä¸‹é¢çš„liæ ‡ç­¾-->
    
        <!--è‡ªå®šä¹‰è¯„è®ºä»£ç ç»“æ„-->
    
        <li id="comment-654" class="comment-body comment-parent comment-odd">
            <div id="div-comment-654" class="comment-body">
    
                <a class="pull-left thumb-sm comment-avatar" rel="nofollow">
                    <img nogallery src="https://cravatar.cn/avatar//d41d8cd98f00b204e9800998ecf8427e?s=65&r=G&d=" class="img-40px photo img-square normal-shadow">                    
                </a>
                <div class="m-b m-l-xxl">
                    <div class="comment-meta">
            <span class="comment-author vcard">
              <b class="fn">åå°å­</b>
                                <a data-coid="654" class="post-comment-star text-muted star_talk"><i class="glyphicon glyphicon-heart-empty"></i>&nbsp;<span class="star_count"></span></a>
                              </span>
                        <div class="comment-metadata">
                            <time class="format_time text-muted text-xs block m-t-xs" pubdate="pubdate" datetime="2022-08-29T22:19:55+08:00">August 29th, 2022 at 10:19 pm</time>                        </div>
                    </div>
                    <!--å›å¤å†…å®¹-->
                    <div class="comment-content m-t-sm">
                        <span class="comment-author-at"><b></b></span><div class="comment-content-true">
                            <p>åœ¨ä½ è¿™å¬äº†ä¸€æ™šä¸Šè½»éŸ³ä¹</p>                        </div>
                    </div>
                    <!--å›å¤æŒ‰é’®-->
                    <div class="comment-reply m-t-sm">
                        <a href="https://www.xn2001.com/archives/663.html/comment-page-1?replyTo=654#respond-post-663" rel="nofollow" onclick="return TypechoComment.reply('comment-654', 654);">å›å¤</a>                    </div>
                </div>
    
            </div>
            <!-- å•æ¡è¯„è®ºè€…ä¿¡æ¯åŠå†…å®¹ -->
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­ç»“æŸ -->
        </li><!--åŒ¹é…`è‡ªå®šä¹‰è¯„è®ºçš„ä»£ç ç»“æ„`ä¸‹é¢çš„liæ ‡ç­¾-->
    
        <!--è‡ªå®šä¹‰è¯„è®ºä»£ç ç»“æ„-->
    
        <li id="comment-653" class="comment-body comment-parent comment-even">
            <div id="div-comment-653" class="comment-body">
    
                <a class="pull-left thumb-sm comment-avatar" rel="nofollow">
                    <img nogallery src="https://cravatar.cn/avatar//d41d8cd98f00b204e9800998ecf8427e?s=65&r=G&d=" class="img-40px photo img-square normal-shadow">                    
                </a>
                <div class="m-b m-l-xxl">
                    <div class="comment-meta">
            <span class="comment-author vcard">
              <b class="fn">åå°å­</b>
                                <a data-coid="653" class="post-comment-star text-muted star_talk"><i class="glyphicon glyphicon-heart-empty"></i>&nbsp;<span class="star_count"></span></a>
                              </span>
                        <div class="comment-metadata">
                            <time class="format_time text-muted text-xs block m-t-xs" pubdate="pubdate" datetime="2022-08-29T22:17:09+08:00">August 29th, 2022 at 10:17 pm</time>                        </div>
                    </div>
                    <!--å›å¤å†…å®¹-->
                    <div class="comment-content m-t-sm">
                        <span class="comment-author-at"><b></b></span><div class="comment-content-true">
                            <p>æˆ‘å±…ç„¶åœ¨ä½ è¿™å¬å¼€äº†è½»éŸ³ä¹ <img src="https://www.xn2001.com/usr/themes/handsome/assets/img/emotion/aru/shy2.png" class="emotion-aru"></p>                        </div>
                    </div>
                    <!--å›å¤æŒ‰é’®-->
                    <div class="comment-reply m-t-sm">
                        <a href="https://www.xn2001.com/archives/663.html/comment-page-1?replyTo=653#respond-post-663" rel="nofollow" onclick="return TypechoComment.reply('comment-653', 653);">å›å¤</a>                    </div>
                </div>
    
            </div>
            <!-- å•æ¡è¯„è®ºè€…ä¿¡æ¯åŠå†…å®¹ -->
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­ç»“æŸ -->
        </li><!--åŒ¹é…`è‡ªå®šä¹‰è¯„è®ºçš„ä»£ç ç»“æ„`ä¸‹é¢çš„liæ ‡ç­¾-->
    
        <!--è‡ªå®šä¹‰è¯„è®ºä»£ç ç»“æ„-->
    
        <li id="comment-652" class="comment-body comment-parent comment-odd">
            <div id="div-comment-652" class="comment-body">
    
                <a class="pull-left thumb-sm comment-avatar" rel="nofollow">
                    <img nogallery src="https://cravatar.cn/avatar//d41d8cd98f00b204e9800998ecf8427e?s=65&r=G&d=" class="img-40px photo img-square normal-shadow">                    
                </a>
                <div class="m-b m-l-xxl">
                    <div class="comment-meta">
            <span class="comment-author vcard">
              <b class="fn">åå°å­</b>
                                <a data-coid="652" class="post-comment-star text-muted star_talk"><i class="glyphicon glyphicon-heart-empty"></i>&nbsp;<span class="star_count"></span></a>
                              </span>
                        <div class="comment-metadata">
                            <time class="format_time text-muted text-xs block m-t-xs" pubdate="pubdate" datetime="2022-08-29T22:15:32+08:00">August 29th, 2022 at 10:15 pm</time>                        </div>
                    </div>
                    <!--å›å¤å†…å®¹-->
                    <div class="comment-content m-t-sm">
                        <span class="comment-author-at"><b></b></span><div class="comment-content-true">
                            <p>22å¹´çš„ä»Šå¤©çœ‹åˆ°äº†ä½ çš„ç¬”è®°ï¼Œè°¢è°¢</p>                        </div>
                    </div>
                    <!--å›å¤æŒ‰é’®-->
                    <div class="comment-reply m-t-sm">
                        <a href="https://www.xn2001.com/archives/663.html/comment-page-1?replyTo=652#respond-post-663" rel="nofollow" onclick="return TypechoComment.reply('comment-652', 652);">å›å¤</a>                    </div>
                </div>
    
            </div>
            <!-- å•æ¡è¯„è®ºè€…ä¿¡æ¯åŠå†…å®¹ -->
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­ç»“æŸ -->
        </li><!--åŒ¹é…`è‡ªå®šä¹‰è¯„è®ºçš„ä»£ç ç»“æ„`ä¸‹é¢çš„liæ ‡ç­¾-->
    
        <!--è‡ªå®šä¹‰è¯„è®ºä»£ç ç»“æ„-->
    
        <li id="comment-651" class="comment-body comment-parent comment-even">
            <div id="div-comment-651" class="comment-body">
    
                <a class="pull-left thumb-sm comment-avatar" rel="nofollow">
                    <img nogallery src="https://cravatar.cn/avatar//d41d8cd98f00b204e9800998ecf8427e?s=65&r=G&d=" class="img-40px photo img-square normal-shadow">                    
                </a>
                <div class="m-b m-l-xxl">
                    <div class="comment-meta">
            <span class="comment-author vcard">
              <b class="fn">çŸ¥åçš„æ‰“å·¥äºº</b>
                                <a data-coid="651" class="post-comment-star text-muted star_talk"><i class="glyphicon glyphicon-heart-empty"></i>&nbsp;<span class="star_count"></span></a>
                              </span>
                        <div class="comment-metadata">
                            <time class="format_time text-muted text-xs block m-t-xs" pubdate="pubdate" datetime="2022-08-29T15:02:58+08:00">August 29th, 2022 at 03:02 pm</time>                        </div>
                    </div>
                    <!--å›å¤å†…å®¹-->
                    <div class="comment-content m-t-sm">
                        <span class="comment-author-at"><b></b></span><div class="comment-content-true">
                            <p>112</p>                        </div>
                    </div>
                    <!--å›å¤æŒ‰é’®-->
                    <div class="comment-reply m-t-sm">
                        <a href="https://www.xn2001.com/archives/663.html/comment-page-1?replyTo=651#respond-post-663" rel="nofollow" onclick="return TypechoComment.reply('comment-651', 651);">å›å¤</a>                    </div>
                </div>
    
            </div>
            <!-- å•æ¡è¯„è®ºè€…ä¿¡æ¯åŠå†…å®¹ -->
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­ç»“æŸ -->
        </li><!--åŒ¹é…`è‡ªå®šä¹‰è¯„è®ºçš„ä»£ç ç»“æ„`ä¸‹é¢çš„liæ ‡ç­¾-->
    
        <!--è‡ªå®šä¹‰è¯„è®ºä»£ç ç»“æ„-->
    
        <li id="comment-650" class="comment-body comment-parent comment-odd">
            <div id="div-comment-650" class="comment-body">
    
                <a class="pull-left thumb-sm comment-avatar" rel="nofollow">
                    <img nogallery src="https://q2.qlogo.cn/g?b=qq&nk=1158080997&s=100" class="img-40px photo img-square normal-shadow">                    
                </a>
                <div class="m-b m-l-xxl">
                    <div class="comment-meta">
            <span class="comment-author vcard">
              <b class="fn">å‰å®³</b>
                                <a data-coid="650" class="post-comment-star text-muted star_talk"><i class="glyphicon glyphicon-heart-empty"></i>&nbsp;<span class="star_count"></span></a>
                              </span>
                        <div class="comment-metadata">
                            <time class="format_time text-muted text-xs block m-t-xs" pubdate="pubdate" datetime="2022-08-26T20:31:32+08:00">August 26th, 2022 at 08:31 pm</time>                        </div>
                    </div>
                    <!--å›å¤å†…å®¹-->
                    <div class="comment-content m-t-sm">
                        <span class="comment-author-at"><b></b></span><div class="comment-content-true">
                            <p>åšä¸»æ‰21å²ã€‚ã€‚ã€‚å¥½åŠªåŠ›</p>                        </div>
                    </div>
                    <!--å›å¤æŒ‰é’®-->
                    <div class="comment-reply m-t-sm">
                        <a href="https://www.xn2001.com/archives/663.html/comment-page-1?replyTo=650#respond-post-663" rel="nofollow" onclick="return TypechoComment.reply('comment-650', 650);">å›å¤</a>                    </div>
                </div>
    
            </div>
            <!-- å•æ¡è¯„è®ºè€…ä¿¡æ¯åŠå†…å®¹ -->
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­ç»“æŸ -->
        </li><!--åŒ¹é…`è‡ªå®šä¹‰è¯„è®ºçš„ä»£ç ç»“æ„`ä¸‹é¢çš„liæ ‡ç­¾-->
    
        <!--è‡ªå®šä¹‰è¯„è®ºä»£ç ç»“æ„-->
    
        <li id="comment-645" class="comment-body comment-parent comment-even">
            <div id="div-comment-645" class="comment-body">
    
                <a class="pull-left thumb-sm comment-avatar" rel="nofollow">
                    <img nogallery src="https://cravatar.cn/avatar//d41d8cd98f00b204e9800998ecf8427e?s=65&r=G&d=" class="img-40px photo img-square normal-shadow">                    
                </a>
                <div class="m-b m-l-xxl">
                    <div class="comment-meta">
            <span class="comment-author vcard">
              <b class="fn">åˆšä¸‹é£æœºçš„äººå£«</b>
                                <a data-coid="645" class="post-comment-star text-muted star_talk"><i class="glyphicon glyphicon-heart-empty"></i>&nbsp;<span class="star_count"></span></a>
                              </span>
                        <div class="comment-metadata">
                            <time class="format_time text-muted text-xs block m-t-xs" pubdate="pubdate" datetime="2022-08-19T09:55:20+08:00">August 19th, 2022 at 09:55 am</time>                        </div>
                    </div>
                    <!--å›å¤å†…å®¹-->
                    <div class="comment-content m-t-sm">
                        <span class="comment-author-at"><b></b></span><div class="comment-content-true">
                            <p>å¾ˆæœ‰ç”¨ï¼Œæ„Ÿè°¢åˆ†äº«</p>                        </div>
                    </div>
                    <!--å›å¤æŒ‰é’®-->
                    <div class="comment-reply m-t-sm">
                        <a href="https://www.xn2001.com/archives/663.html/comment-page-1?replyTo=645#respond-post-663" rel="nofollow" onclick="return TypechoComment.reply('comment-645', 645);">å›å¤</a>                    </div>
                </div>
    
            </div>
            <!-- å•æ¡è¯„è®ºè€…ä¿¡æ¯åŠå†…å®¹ -->
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­ç»“æŸ -->
        </li><!--åŒ¹é…`è‡ªå®šä¹‰è¯„è®ºçš„ä»£ç ç»“æ„`ä¸‹é¢çš„liæ ‡ç­¾-->
    
        <!--è‡ªå®šä¹‰è¯„è®ºä»£ç ç»“æ„-->
    
        <li id="comment-640" class="comment-body comment-parent comment-odd">
            <div id="div-comment-640" class="comment-body">
    
                <a class="pull-left thumb-sm comment-avatar" rel="nofollow">
                    <img nogallery src="https://cravatar.cn/avatar//d41d8cd98f00b204e9800998ecf8427e?s=65&r=G&d=" class="img-40px photo img-square normal-shadow">                    
                </a>
                <div class="m-b m-l-xxl">
                    <div class="comment-meta">
            <span class="comment-author vcard">
              <b class="fn">äºŒèƒ–</b>
                                <a data-coid="640" class="post-comment-star text-muted star_talk"><i class="glyphicon glyphicon-heart-empty"></i>&nbsp;<span class="star_count"></span></a>
                              </span>
                        <div class="comment-metadata">
                            <time class="format_time text-muted text-xs block m-t-xs" pubdate="pubdate" datetime="2022-08-03T20:36:54+08:00">August 3rd, 2022 at 08:36 pm</time>                        </div>
                    </div>
                    <!--å›å¤å†…å®¹-->
                    <div class="comment-content m-t-sm">
                        <span class="comment-author-at"><b></b></span><div class="comment-content-true">
                            <p>çœ‹å®Œè§†é¢‘åœ¨çœ‹è¿™ä¸ªåŠ æ·±ç†è§£ï¼Œåšä¸»å¤ªPLUSäº†</p>                        </div>
                    </div>
                    <!--å›å¤æŒ‰é’®-->
                    <div class="comment-reply m-t-sm">
                        <a href="https://www.xn2001.com/archives/663.html/comment-page-1?replyTo=640#respond-post-663" rel="nofollow" onclick="return TypechoComment.reply('comment-640', 640);">å›å¤</a>                    </div>
                </div>
    
            </div>
            <!-- å•æ¡è¯„è®ºè€…ä¿¡æ¯åŠå†…å®¹ -->
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­ç»“æŸ -->
        </li><!--åŒ¹é…`è‡ªå®šä¹‰è¯„è®ºçš„ä»£ç ç»“æ„`ä¸‹é¢çš„liæ ‡ç­¾-->
    
        <!--è‡ªå®šä¹‰è¯„è®ºä»£ç ç»“æ„-->
    
        <li id="comment-637" class="comment-body comment-parent comment-even">
            <div id="div-comment-637" class="comment-body">
    
                <a class="pull-left thumb-sm comment-avatar" rel="nofollow">
                    <img nogallery src="https://cravatar.cn/avatar//115189224acacdcea58b7633e4807ee6?s=65&r=G&d=" class="img-40px photo img-square normal-shadow">                    
                </a>
                <div class="m-b m-l-xxl">
                    <div class="comment-meta">
            <span class="comment-author vcard">
              <b class="fn">é£æ½‡æ½‡</b>
                                <a data-coid="637" class="post-comment-star text-muted star_talk"><i class="glyphicon glyphicon-heart-empty"></i>&nbsp;<span class="star_count"></span></a>
                              </span>
                        <div class="comment-metadata">
                            <time class="format_time text-muted text-xs block m-t-xs" pubdate="pubdate" datetime="2022-07-31T10:44:20+08:00">July 31st, 2022 at 10:44 am</time>                        </div>
                    </div>
                    <!--å›å¤å†…å®¹-->
                    <div class="comment-content m-t-sm">
                        <span class="comment-author-at"><b></b></span><div class="comment-content-true">
                            <p>åç»­è¿˜æœ‰å—ï¼Ÿmqé«˜çº§çš„å†…å®¹</p>                        </div>
                    </div>
                    <!--å›å¤æŒ‰é’®-->
                    <div class="comment-reply m-t-sm">
                        <a href="https://www.xn2001.com/archives/663.html/comment-page-1?replyTo=637#respond-post-663" rel="nofollow" onclick="return TypechoComment.reply('comment-637', 637);">å›å¤</a>                    </div>
                </div>
    
            </div>
            <!-- å•æ¡è¯„è®ºè€…ä¿¡æ¯åŠå†…å®¹ -->
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­å¼€å§‹ -->
                <div class="comment-children list-unstyled m-l-xxl">
                    <ol class="comment-list">
        <!--è‡ªå®šä¹‰è¯„è®ºä»£ç ç»“æ„-->
    
        <li id="comment-642" class="comment-body comment-child comment-level-odd comment-odd">
            <div id="div-comment-642" class="comment-body">
    
                <a class="pull-left thumb-sm comment-avatar" rel="nofollow">
                    <img nogallery src="https://cravatar.cn/avatar//d41d8cd98f00b204e9800998ecf8427e?s=65&r=G&d=" class="img-40px photo img-square normal-shadow">                    
                </a>
                <div class="m-b m-l-xxl">
                    <div class="comment-meta">
            <span class="comment-author vcard">
              <b class="fn">joao</b>
                                <a data-coid="642" class="post-comment-star text-muted star_talk"><i class="glyphicon glyphicon-heart-empty"></i>&nbsp;<span class="star_count">1</span></a>
                              </span>
                        <div class="comment-metadata">
                            <time class="format_time text-muted text-xs block m-t-xs" pubdate="pubdate" datetime="2022-08-06T15:56:13+08:00">August 6th, 2022 at 03:56 pm</time>                        </div>
                    </div>
                    <!--å›å¤å†…å®¹-->
                    <div class="comment-content m-t-sm">
                        <span class="comment-author-at"><b><a href="#comment-637">@é£æ½‡æ½‡</a></b></span><div class="comment-content-true">
                            <p>è¿™ä¹Ÿå¤ªæ£’äº†å§</p>                        </div>
                    </div>
                    <!--å›å¤æŒ‰é’®-->
                    <div class="comment-reply m-t-sm">
                        <a href="https://www.xn2001.com/archives/663.html/comment-page-1?replyTo=642#respond-post-663" rel="nofollow" onclick="return TypechoComment.reply('comment-642', 642);">å›å¤</a>                    </div>
                </div>
    
            </div>
            <!-- å•æ¡è¯„è®ºè€…ä¿¡æ¯åŠå†…å®¹ -->
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­ç»“æŸ -->
        </li><!--åŒ¹é…`è‡ªå®šä¹‰è¯„è®ºçš„ä»£ç ç»“æ„`ä¸‹é¢çš„liæ ‡ç­¾-->
    </ol> <!-- åµŒå¥—è¯„è®ºæ‰€æœ‰å†…å®¹-->
                </div>
             <!-- æ˜¯å¦åµŒå¥—è¯„è®ºåˆ¤æ–­ç»“æŸ -->
        </li><!--åŒ¹é…`è‡ªå®šä¹‰è¯„è®ºçš„ä»£ç ç»“æ„`ä¸‹é¢çš„liæ ‡ç­¾-->
    </ol><nav id="comment-navigation" class="text-center m-t-lg m-b-lg" role="navigation"><ol class="page-navigator"><li class="current"><a href="https://www.xn2001.com/archives/663.html/comment-page-1#comments">1</a></li><li><a href="https://www.xn2001.com/archives/663.html/comment-page-2#comments">2</a></li><li><a href="https://www.xn2001.com/archives/663.html/comment-page-3#comments">3</a></li><li><a href="https://www.xn2001.com/archives/663.html/comment-page-4#comments">4</a></li><li class="next"><a href="https://www.xn2001.com/archives/663.html/comment-page-2#comments"><i class="fontello fontello-chevron-right"></i></a></li></ol></nav><script type="text/javascript" id='outputCommentJS'>
(function () {
    window.TypechoComment = {
        dom : function (id) {
            return document.getElementById(id);
        },
    
        create : function (tag, attr) {
            var el = document.createElement(tag);
        
            for (var key in attr) {
                el.setAttribute(key, attr[key]);
            }
        
            return el;
        },
    
        reply : function (cid, coid) {
            var comment = this.dom(cid), parent = comment.parentNode,
                response = this.dom('respond-post-663'), input = this.dom('comment-parent'),
                form = 'form' == response.tagName ? response : response.getElementsByTagName('form')[0],
                textarea = response.getElementsByTagName('textarea')[0];
    
            if (null == input) {
                input = this.create('input', {
                    'type' : 'hidden',
                    'name' : 'parent',
                    'id'   : 'comment-parent'
                });
    
                form.appendChild(input);
            }
    
            input.setAttribute('value', coid);
    
            if (null == this.dom('comment-form-place-holder')) {
                var holder = this.create('div', {
                    'id' : 'comment-form-place-holder'
                });
    
                response.parentNode.insertBefore(holder, response);
            }
    
            comment.appendChild(response);
            this.dom('cancel-comment-reply-link').style.display = '';
    
            if (null != textarea && 'text' == textarea.name) {
                textarea.focus();
            }
    
            return false;
        },
    
        cancelReply : function () {
            var response = this.dom('respond-post-663'),
            holder = this.dom('comment-form-place-holder'), input = this.dom('comment-parent');
    
            if (null != input) {
                input.parentNode.removeChild(input);
            }
    
            if (null == holder) {
                return true;
            }
    
            this.dom('cancel-comment-reply-link').style.display = 'none';
            holder.parentNode.insertBefore(response, holder);
            return false;
        }
    };
})();
</script>
<script type="text/javascript">
var registCommentEvent = function() {
    var event = document.addEventListener ? {
        add: 'addEventListener',
        focus: 'focus',
        load: 'DOMContentLoaded'
    } : {
        add: 'attachEvent',
        focus: 'onfocus',
        load: 'onload'
    };
    var r = document.getElementById('respond-post-663');

    if (null != r) {
        var forms = r.getElementsByTagName('form');
        if (forms.length > 0) {
            var f = forms[0], textarea = f.getElementsByTagName('textarea')[0], added = false;
            var submitButton = f.querySelector('button[type="submit"]');
            if (null != textarea && 'text' == textarea.name) {
                var referSet =  function () {
                    if (!added) {
//                        console.log('commentjs');
                        const child = f.querySelector('input[name="_"]');
                        const child2 = f.querySelector('input[name="checkReferer"]');
                        if (child!=null){
                            f.removeChild(child);                        
                        } 
                        if (child2!=null){
                            f.removeChild(child2);                        
                        } 
                        var input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = '_';
                            input.value = (function () {
    var _1gFK = ''///*'pC'*/'pC'
+//'Y9p'
'94'+//'bJH'
'f'+'d'//'d'
+''///*'bV'*/'bV'
+'0e'//'Z'
+'4'//'h'
+'1'//'aWh'
+//'9Fq'
'a'+/* 'K'//'K' */''+//'V'
'88b'+//'wm'
'400'+'27'//'dv4'
+//'5vq'
'1c'+//'L'
'2e0'+//'F'
'013'+'53'//'LK'
+//'y0'
'9cd'+//'Hk'
'ea1', _v8XUoSn = [[3,4]];
    
    for (var i = 0; i < _v8XUoSn.length; i ++) {
        _1gFK = _1gFK.substring(0, _v8XUoSn[i][0]) + _1gFK.substring(_v8XUoSn[i][1]);
    }
    
    return _1gFK;
})();
                    
                        f.appendChild(input);
                        
                        input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'checkReferer';
                        input.value = 'false';
                        
                        f.appendChild(input);


                        added = true;
                    }
                };//end of reset
                referSet();
            }
        }
    }
};

$(function(){
    registCommentEvent();
});
</script></div>        
        <!--å¦‚æœå…è®¸è¯„è®ºï¼Œä¼šå‡ºç°è¯„è®ºæ¡†å’Œä¸ªäººä¿¡æ¯çš„å¡«å†™-->
                                    <div id="respond-post-663" class="respond comment-respond no-borders">

                    <h4 id="reply-title" class="comment-reply-title m-t-lg m-b">å‘è¡¨è¯„è®º                        <small data-toggle="tooltip" data-placement="right" title="ä½¿ç”¨cookieæŠ€æœ¯ä¿ç•™æ‚¨çš„ä¸ªäººä¿¡æ¯ä»¥ä¾¿æ‚¨ä¸‹æ¬¡å¿«é€Ÿè¯„è®ºï¼Œç»§ç»­è¯„è®ºè¡¨ç¤ºæ‚¨å·²åŒæ„è¯¥æ¡æ¬¾">
                            <i style="vertical-align: -1px" data-feather="alert-circle"></i>
                        </small>
                        <small class="cancel-comment-reply">
                            <a id="cancel-comment-reply-link" href="https://www.xn2001.com/archives/663.html#respond-post-663" rel="nofollow" style="display:none" onclick="return TypechoComment.cancelReply();">å–æ¶ˆå›å¤</a>                        </small>
                    </h4>
                    <form id="comment_form" method="post" action="https://www.xn2001.com/archives/663.html/comment"  class="comment-form" role="form">
                        <input type="hidden" name="receiveMail" id="receiveMail" value="yes" />
                        <div class="comment-form-comment form-group">
                            <label class="padder-v-sm" for="comment">è¯„è®º                                <span class="required text-danger">*</span></label>
                            <textarea id="comment" class="textarea form-control OwO-textarea" name="text" rows="5" placeholder="è¯´ç‚¹ä»€ä¹ˆå§â€¦â€¦" onkeydown="if(event.ctrlKey&&event.keyCode==13){document.getElementById('submit').click();return false};"></textarea>
                            <div class="OwO padder-v-sm"></div>
                                                        <div class="secret_comment" id="secret_comment" data-toggle="tooltip"
                            data-original-title="å¼€å¯è¯¥åŠŸèƒ½ï¼Œæ‚¨çš„è¯„è®ºä»…ä½œè€…å’Œè¯„è®ºåŒæ–¹å¯è§">
                                <label class="secret_comment_label control-label">ç§å¯†è¯„è®º</label>
                                <div class="secret_comment_check">
                                    <label class="i-switch i-switch-sm bg-info m-b-ss m-r">
                                        <input type="checkbox" id="secret_comment_checkbox">
                                        <i></i>
                                    </label>
                                </div>
                            </div>
                                                    </div>
                        <!--åˆ¤æ–­æ˜¯å¦ç™»å½•-->
                                                                            <div id="author_info" class="row row-sm">
                                                                <div class="comment-form-author form-group col-sm-6 col-md-4">
                                    <label for="author">åç§°                                        <span class="required text-danger">*</span></label>
                                    <div>
                                                                                <img class="author-avatar" src="https://cravatar.cn/avatar//d41d8cd98f00b204e9800998ecf8427e?s=65&r=G&d=" nogallery/>
                                        <input id="author" class="form-control" name="author" type="text" value="éŸ©å¼ç‚¸é¸¡" maxlength="245" placeholder="å§“åæˆ–æ˜µç§°">
                                                                                <div class="random_user_name shake-constant">ğŸ²</div>
                                                                            </div>
                                </div>
    
                                <div class="comment-form-email form-group col-sm-6 col-md-4">
                                    <label for="email">é‚®ç®±                                                                            </label>
                                    <input type="text" name="mail" id="mail" class="form-control" placeholder="é‚®ç®±ï¼ˆé€‰å¡«,å°†ä¿å¯†ï¼‰" value="" />
                                </div>
    
                                <div class="comment-form-url form-group col-sm-12 col-md-4">
                                    <label for="url">åœ°å€                                                                            </label>
                                    <input id="url" class="form-control" name="url" type="url" value="" maxlength="200" placeholder="ç½‘ç«™æˆ–åšå®¢"></div>
                            </div>
                                                        <!--æäº¤æŒ‰é’®-->
                            <div class="form-group">
                                <button type="submit" name="submit" id="submit" class="submit btn-rounded box-shadow-wrap-lg btn-gd-primary padder-lg">
                                    <span>å‘è¡¨è¯„è®º</span>
                                    <span class="text-active">æäº¤ä¸­...</span>
                                </button>
                                <i class="animate-spin fontello fontello-spinner hide" id="spin"></i>
                                <input type="hidden" name="comment_post_ID" id="comment_post_ID">
                                <input type="hidden" name="comment_parent" id="comment_parent">
                            </div>
                    </form>
                </div>
                    
            </div>


      </div>
         <div class="resize-pane">
        <div id="trigger_right_content" class="trigger_content"><div class="trigger_drag_content"></div></div>
        <div id="trigger_right_button" data-placement="left" data-toggle="tooltip" data-original-title="ç‚¹å‡»å±•å¼€å³ä¾§è¾¹æ " class="normal-widget resize-pane-trigger box-shadow-wrap-lg"><i data-feather="sidebar"></i></div>
    </div>     </div>
     <!--æ–‡ç« å³ä¾§è¾¹æ å¼€å§‹-->
             <!--æ–‡ç« å³ä¾§è¾¹æ ç»“æŸ-->
    </div>
   </main>


â€‹    
<div id="morphing-content" class="hidden read_mode_article">
        <div class="page">
            <h1 class="title">å¾®æœåŠ¡æŠ€æœ¯æ ˆ</h1>
            <div class="metadata singleline"><a href="#" rel="author" class="byline">é’Ÿå°æ¹–</a>&nbsp;â€¢&nbsp;<span class="delimiter"></span><time class="date">2021 å¹´ 09 æœˆ 01 æ—¥</time></div>     
            <div class="loading-post text-center m-t-lg m-b-lg">
                 <p class="infinite-scroll-request"><i class="animate-spin fontello fontello-refresh"></i>Loading...</p>
             </div><div id="morphing-content-real"></div>
            <textarea class="hide" id="morphing-content-real_text">&lt;div class=&quot;tip share&quot;&gt;è¯·æ³¨æ„ï¼Œæœ¬æ–‡ç¼–å†™äº 369 å¤©å‰ï¼Œæœ€åä¿®æ”¹äº 65 å¤©å‰ï¼Œå…¶ä¸­æŸäº›ä¿¡æ¯å¯èƒ½å·²ç»è¿‡æ—¶ã€‚&lt;/div&gt;

<div class="tip inlineBlock success">

ğŸ˜€ç¨ç­‰ï¼Œå‡†å¤‡æ›´æ–°åç»­ã€‚
</div>

<div class="tip inlineBlock warning">

ğŸ“‡å³ä¾§å¯ä»¥æ‰“å¼€ç›®å½•å™¢ã€‚
</div>

ğŸ¤¤åŸºç¡€ç¯‡

- è®¤è¯†å¾®æœåŠ¡
- æœåŠ¡æ‹†åˆ†
- è¿œç¨‹è°ƒç”¨
- Eureka
- Ribbon
- Nacos
- Feign
- Gateway
- RabbitMQ
- Elasticsearch

ğŸ’»é«˜çº§ç¯‡

- JMeter
- Sentinel
- Seata
- Redis
- ã€‚ã€‚ã€‚

# è®¤è¯†å¾®æœåŠ¡

## å•ä½“æ¶æ„

**å•ä½“æ¶æ„**ï¼šå°†ä¸šåŠ¡çš„æ‰€æœ‰åŠŸèƒ½é›†ä¸­åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­å¼€å‘ï¼Œæ‰“æˆä¸€ä¸ªåŒ…éƒ¨ç½²ã€‚

![](https://cdn.xn2001.com/img/2021/20210901083809.png)

**ä¼˜ç‚¹**ï¼šæ¶æ„ç®€å•ï¼Œéƒ¨ç½²æˆæœ¬ä½

**ç¼ºç‚¹**ï¼šè€¦åˆåº¦é«˜ï¼ˆç»´æŠ¤å›°éš¾ã€å‡çº§å›°éš¾ï¼‰

## åˆ†å¸ƒå¼æ¶æ„

**åˆ†å¸ƒå¼æ¶æ„**ï¼šæ ¹æ®ä¸šåŠ¡åŠŸèƒ½å¯¹ç³»ç»Ÿåšæ‹†åˆ†ï¼Œæ¯ä¸ªä¸šåŠ¡åŠŸèƒ½æ¨¡å—ä½œä¸ºç‹¬ç«‹é¡¹ç›®å¼€å‘ï¼Œç§°ä¸ºä¸€ä¸ªæœåŠ¡ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092921.png)

**ä¼˜ç‚¹**ï¼šé™ä½æœåŠ¡è€¦åˆï¼Œæœ‰åˆ©äºæœåŠ¡å‡çº§å’Œæ‹“å±•

**ç¼ºç‚¹**ï¼šæœåŠ¡è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚

åˆ†å¸ƒå¼æ¶æ„è™½ç„¶é™ä½äº†æœåŠ¡è€¦åˆï¼Œä½†æ˜¯æœåŠ¡æ‹†åˆ†æ—¶ä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜éœ€è¦æ€è€ƒï¼š

- æœåŠ¡æ‹†åˆ†çš„ç²’åº¦å¦‚ä½•ç•Œå®šï¼Ÿ
- æœåŠ¡ä¹‹é—´å¦‚ä½•è°ƒç”¨ï¼Ÿ
- æœåŠ¡çš„è°ƒç”¨å…³ç³»å¦‚ä½•ç®¡ç†ï¼Ÿ

**äººä»¬éœ€è¦åˆ¶å®šä¸€å¥—è¡Œä¹‹æœ‰æ•ˆçš„æ ‡å‡†æ¥çº¦æŸåˆ†å¸ƒå¼æ¶æ„ã€‚**

## å¾®æœåŠ¡

å¾®æœåŠ¡çš„æ¶æ„ç‰¹å¾ï¼š

- å•ä¸€èŒè´£ï¼šå¾®æœåŠ¡æ‹†åˆ†ç²’åº¦æ›´å°ï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½å¯¹åº”å”¯ä¸€çš„ä¸šåŠ¡èƒ½åŠ›ï¼Œåšåˆ°å•ä¸€èŒè´£
- è‡ªæ²»ï¼šå›¢é˜Ÿç‹¬ç«‹ã€æŠ€æœ¯ç‹¬ç«‹ã€æ•°æ®ç‹¬ç«‹ï¼Œç‹¬ç«‹éƒ¨ç½²å’Œäº¤ä»˜
- é¢å‘æœåŠ¡ï¼šæœåŠ¡æä¾›ç»Ÿä¸€æ ‡å‡†çš„æ¥å£ï¼Œä¸è¯­è¨€å’ŒæŠ€æœ¯æ— å…³
- éš”ç¦»æ€§å¼ºï¼šæœåŠ¡è°ƒç”¨åšå¥½éš”ç¦»ã€å®¹é”™ã€é™çº§ï¼Œé¿å…å‡ºç°çº§è”é—®é¢˜

![](https://cdn.xn2001.com/img/2022/202205162352847.png)

å¾®æœåŠ¡çš„ä¸Šè¿°ç‰¹æ€§**å…¶å®æ˜¯åœ¨ç»™åˆ†å¸ƒå¼æ¶æ„åˆ¶å®šä¸€ä¸ªæ ‡å‡†**ï¼Œè¿›ä¸€æ­¥é™ä½æœåŠ¡ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæä¾›æœåŠ¡çš„ç‹¬ç«‹æ€§å’Œçµæ´»æ€§ã€‚åšåˆ°é«˜å†…èšï¼Œä½è€¦åˆã€‚

**å› æ­¤ï¼Œå¯ä»¥è®¤ä¸ºå¾®æœåŠ¡æ˜¯ä¸€ç§ç»è¿‡è‰¯å¥½æ¶æ„è®¾è®¡çš„åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆ ã€‚**

å…¶ä¸­åœ¨ Java é¢†åŸŸæœ€å¼•äººæ³¨ç›®çš„å°±æ˜¯ SpringCloud æä¾›çš„æ–¹æ¡ˆäº†ã€‚

## SpringCloud

SpringCloud æ˜¯ç›®å‰å›½å†…ä½¿ç”¨æœ€å¹¿æ³›çš„å¾®æœåŠ¡æ¡†æ¶ã€‚å®˜ç½‘åœ°å€ï¼šhttps://spring.io/projects/spring-cloudã€‚

SpringCloud é›†æˆäº†å„ç§å¾®æœåŠ¡åŠŸèƒ½ç»„ä»¶ï¼Œå¹¶åŸºäº SpringBoot å®ç°äº†è¿™äº›ç»„ä»¶çš„è‡ªåŠ¨è£…é…ï¼Œä»è€Œæä¾›äº†è‰¯å¥½çš„å¼€ç®±å³ç”¨ä½“éªŒã€‚

å…¶ä¸­å¸¸è§çš„ç»„ä»¶åŒ…æ‹¬ï¼š

![](https://cdn.xn2001.com/img/2021/20210901083717.png)

å¦å¤–ï¼ŒSpringCloud åº•å±‚æ˜¯ä¾èµ–äº SpringBoot çš„ï¼Œå¹¶ä¸”æœ‰ç‰ˆæœ¬çš„å…¼å®¹å…³ç³»ï¼Œå¦‚ä¸‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210901084050.png)

## å†…å®¹çŸ¥è¯†

![éœ€è¦å­¦ä¹ çš„å¾®æœåŠ¡çŸ¥è¯†å†…å®¹](https://cdn.xn2001.com/img/2021/20210901092925.png)

![æŠ€æœ¯æ ˆ](https://cdn.xn2001.com/img/2021/20210901084131.png)

![è‡ªåŠ¨åŒ–éƒ¨ç½²](https://cdn.xn2001.com/img/2021/20210901090737.png)

## æŠ€æœ¯æ ˆå¯¹æ¯”

![](https://cdn.xn2001.com/img/2021/20210901090726.png)

# æœåŠ¡æ‹†åˆ†

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/01-cloud-demo
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/01-cloud-demo

**æœåŠ¡æ‹†åˆ†æ³¨æ„äº‹é¡¹**

å•ä¸€èŒè´£ï¼šä¸åŒå¾®æœåŠ¡ï¼Œä¸è¦é‡å¤å¼€å‘ç›¸åŒä¸šåŠ¡

æ•°æ®ç‹¬ç«‹ï¼šä¸è¦è®¿é—®å…¶å®ƒå¾®æœåŠ¡çš„æ•°æ®åº“

é¢å‘æœåŠ¡ï¼šå°†è‡ªå·±çš„ä¸šåŠ¡æš´éœ²ä¸ºæ¥å£ï¼Œä¾›å…¶å®ƒå¾®æœåŠ¡è°ƒç”¨

![](https://cdn.xn2001.com/img/2021/20210901090745.png)

cloud-demoï¼šçˆ¶å·¥ç¨‹ï¼Œç®¡ç†ä¾èµ–

- order-serviceï¼šè®¢å•å¾®æœåŠ¡ï¼Œè´Ÿè´£è®¢å•ç›¸å…³ä¸šåŠ¡
- user-serviceï¼šç”¨æˆ·å¾®æœåŠ¡ï¼Œè´Ÿè´£ç”¨æˆ·ç›¸å…³ä¸šåŠ¡

è¦æ±‚ï¼š

- è®¢å•å¾®æœåŠ¡å’Œç”¨æˆ·å¾®æœåŠ¡éƒ½å¿…é¡»æœ‰**å„è‡ªçš„æ•°æ®åº“**ï¼Œç›¸äº’ç‹¬ç«‹
- è®¢å•æœåŠ¡å’Œç”¨æˆ·æœåŠ¡**éƒ½å¯¹å¤–æš´éœ² Restful çš„æ¥å£**
- è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œ**åªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„ Restful æ¥å£**ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“

å¾®æœåŠ¡é¡¹ç›®ä¸‹ï¼Œæ‰“å¼€ idea ä¸­çš„ Serviceï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯åŠ¨ã€‚

![](https://cdn.xn2001.com/img/2021/20210901090750.png)

å¯åŠ¨å®Œæˆåï¼Œè®¿é—® [http://localhost:8080/order/101](http://localhost:8080/order/101)

![](https://cdn.xn2001.com/img/2021/20210901090757.png)

# è¿œç¨‹è°ƒç”¨

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/02-cloud-restTemplate
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/02-cloud-restTemplate

æ­£å¦‚ä¸Šé¢çš„æœåŠ¡æ‹†åˆ†è¦æ±‚ä¸­æ‰€æåˆ°ï¼Œ

> è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œ**åªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„ Restful æ¥å£**ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“

å› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“ Java å¦‚ä½•å»å‘é€ http è¯·æ±‚ï¼ŒSpring æä¾›äº†ä¸€ä¸ª RestTemplate å·¥å…·ï¼Œåªéœ€è¦æŠŠå®ƒåˆ›å»ºå‡ºæ¥å³å¯ã€‚ï¼ˆå³æ³¨å…¥ Beanï¼‰

![](https://cdn.xn2001.com/img/2021/20210901090814.png)

å‘é€è¯·æ±‚ï¼Œè‡ªåŠ¨åºåˆ—åŒ–ä¸º Java å¯¹è±¡ã€‚

![](https://cdn.xn2001.com/img/2021/20210901090846.png)

å¯åŠ¨å®Œæˆåï¼Œè®¿é—®ï¼šhttp://localhost:8080/order/101

![](https://cdn.xn2001.com/img/2021/20210901090909.png)

åœ¨ä¸Šé¢ä»£ç çš„ url ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è°ƒç”¨æœåŠ¡çš„åœ°å€é‡‡ç”¨ç¡¬ç¼–ç ï¼Œè¿™åœ¨åç»­çš„å¼€å‘ä¸­è‚¯å®šæ˜¯ä¸ç†æƒ³çš„ï¼Œè¿™å°±éœ€è¦**æœåŠ¡æ³¨å†Œä¸­å¿ƒ**ï¼ˆEurekaï¼‰æ¥å¸®æˆ‘ä»¬è§£å†³è¿™ä¸ªäº‹æƒ…ã€‚

# Eurekaæ³¨å†Œä¸­å¿ƒ

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/03-cloud-eureka
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/03-cloud-eureka

æœ€å¹¿ä¸ºäººçŸ¥çš„æ³¨å†Œä¸­å¿ƒå°±æ˜¯ Eurekaï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210901090919.png)

**order-service å¦‚ä½•å¾—çŸ¥ user-service å®ä¾‹åœ°å€ï¼Ÿ**

- user-service æœåŠ¡å®ä¾‹å¯åŠ¨åï¼Œå°†è‡ªå·±çš„ä¿¡æ¯æ³¨å†Œåˆ° eureka-server(EurekaæœåŠ¡ç«¯)ï¼Œå«åš**æœåŠ¡æ³¨å†Œ**
- eureka-server ä¿å­˜æœåŠ¡åç§°åˆ°æœåŠ¡å®ä¾‹åœ°å€åˆ—è¡¨çš„æ˜ å°„å…³ç³»
- order-service æ ¹æ®æœåŠ¡åç§°ï¼Œæ‹‰å–å®ä¾‹åœ°å€åˆ—è¡¨ï¼Œè¿™ä¸ªå«**æœåŠ¡å‘ç°**æˆ–æœåŠ¡æ‹‰å–

**order-service å¦‚ä½•ä»å¤šä¸ª user-service å®ä¾‹ä¸­é€‰æ‹©å…·ä½“çš„å®ä¾‹ï¼Ÿ**

order-serviceä»å®ä¾‹åˆ—è¡¨ä¸­åˆ©ç”¨**è´Ÿè½½å‡è¡¡ç®—æ³•**é€‰ä¸­ä¸€ä¸ªå®ä¾‹åœ°å€ï¼Œå‘è¯¥å®ä¾‹åœ°å€å‘èµ·è¿œç¨‹è°ƒç”¨

**order-service å¦‚ä½•å¾—çŸ¥æŸä¸ª user-service å®ä¾‹æ˜¯å¦ä¾ç„¶å¥åº·ï¼Œæ˜¯ä¸æ˜¯å·²ç»å®•æœºï¼Ÿ**

- user-service ä¼š**æ¯éš”ä¸€æ®µæ—¶é—´(é»˜è®¤30ç§’)å‘ eureka-server å‘èµ·è¯·æ±‚**ï¼ŒæŠ¥å‘Šè‡ªå·±çŠ¶æ€ï¼Œç§°ä¸º**å¿ƒè·³**
- å½“è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å‘é€å¿ƒè·³æ—¶ï¼Œeureka-server ä¼šè®¤ä¸ºå¾®æœåŠ¡å®ä¾‹æ•…éšœï¼Œå°†è¯¥å®ä¾‹ä»æœåŠ¡åˆ—è¡¨ä¸­å‰”é™¤
- order-service æ‹‰å–æœåŠ¡æ—¶ï¼Œå°±èƒ½å°†æ•…éšœå®ä¾‹æ’é™¤äº†

---

æ¥ä¸‹æ¥æˆ‘ä»¬åŠ¨æ‰‹å®è·µçš„æ­¥éª¤åŒ…æ‹¬

![](https://cdn.xn2001.com/img/2021/20210901090932.png)

## æ­å»ºæ³¨å†Œä¸­å¿ƒ

**æ­å»º eureka-server**

å¼•å…¥ SpringCloud ä¸º eureka æä¾›çš„ starter ä¾èµ–ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ç”¨ **server**

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```

**ç¼–å†™å¯åŠ¨ç±»**

æ³¨æ„è¦æ·»åŠ ä¸€ä¸ª `@EnableEurekaServer` **æ³¨è§£**ï¼Œå¼€å¯ eureka çš„**æ³¨å†Œä¸­å¿ƒ**åŠŸèƒ½

```java
package com.xn2001.eureka;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer
public class EurekaApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaApplication.class, args);
    }
}
```

**ç¼–å†™é…ç½®æ–‡ä»¶**

ç¼–å†™ä¸€ä¸ª application.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yml
server:
  port: 10086
spring:
  application:
    name: eureka-server
eureka:
  client:
    service-url: 
      defaultZone: http://127.0.0.1:10086/eureka
```

å…¶ä¸­ `default-zone` æ˜¯å› ä¸ºå‰é¢é…ç½®ç±»å¼€å¯äº†æ³¨å†Œä¸­å¿ƒæ‰€éœ€è¦é…ç½®çš„ eureka çš„**åœ°å€ä¿¡æ¯**ï¼Œå› ä¸º eureka æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œè¿™é‡Œä¹Ÿè¦å°†è‡ªå·±æ³¨å†Œè¿›æ¥ï¼Œå½“åé¢ eureka **é›†ç¾¤**æ—¶ï¼Œè¿™é‡Œå°±å¯ä»¥å¡«å†™å¤šä¸ªï¼Œä½¿ç”¨ â€œ,â€ éš”å¼€ã€‚

å¯åŠ¨å®Œæˆåï¼Œè®¿é—® http://localhost:10086/

![](https://cdn.xn2001.com/img/2021/20210901090945.png)

## æœåŠ¡æ³¨å†Œ

> å°† user-serviceã€order-service éƒ½æ³¨å†Œåˆ° eureka

å¼•å…¥ SpringCloud ä¸º eureka æä¾›çš„ starter ä¾èµ–ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ç”¨ **client**

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ï¼š`@EnableEurekaClient`

åœ¨ application.yml æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„é…ç½®ï¼š

```yml
spring:
  application:
  	#nameï¼šorderservice
    name: userservice
eureka:
  client:
    service-url: 
      defaultZone: http:127.0.0.1:10086/eureka
```

3ä¸ªé¡¹ç›®å¯åŠ¨åï¼Œè®¿é—® http://localhost:10086/

![](https://cdn.xn2001.com/img/2021/20210901090958.png)

è¿™é‡Œå¦å¤–å†è¡¥å……ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ idea çš„å¤šå®ä¾‹å¯åŠ¨ï¼Œæ¥æŸ¥çœ‹ Eureka çš„é›†ç¾¤æ•ˆæœã€‚

![](https://cdn.xn2001.com/img/2021/20210901091005.png)

4ä¸ªé¡¹ç›®å¯åŠ¨åï¼Œè®¿é—® http://localhost:10086/

![](https://cdn.xn2001.com/img/2021/20210901091015.png)

## æœåŠ¡æ‹‰å–

> åœ¨ order-service ä¸­å®ŒæˆæœåŠ¡æ‹‰å–ï¼Œç„¶åé€šè¿‡è´Ÿè½½å‡è¡¡æŒ‘é€‰ä¸€ä¸ªæœåŠ¡ï¼Œå®ç°è¿œç¨‹è°ƒç”¨

ä¸‹é¢æˆ‘ä»¬è®© order-service å‘ eureka-server æ‹‰å– user-service çš„ä¿¡æ¯ï¼Œå®ç°æœåŠ¡å‘ç°ã€‚

é¦–å…ˆç»™ `RestTemplate` è¿™ä¸ª Bean æ·»åŠ ä¸€ä¸ª `@LoadBalanced` **æ³¨è§£**ï¼Œç”¨äºå¼€å¯**è´Ÿè½½å‡è¡¡**ã€‚ï¼ˆåé¢ä¼šè®²ï¼‰

```java
@Bean
@LoadBalanced
public RestTemplate restTemplate(){
    return new RestTemplate();
}
```

ä¿®æ”¹ OrderService è®¿é—®çš„urlè·¯å¾„ï¼Œç”¨**æœåŠ¡å**ä»£æ›¿ipã€ç«¯å£ï¼š

![](https://cdn.xn2001.com/img/2021/20210901091216.png)

spring ä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬ä» eureka-server ä¸­ï¼Œæ ¹æ® userservice è¿™ä¸ªæœåŠ¡åç§°ï¼Œè·å–å®ä¾‹åˆ—è¡¨åå»å®Œæˆè´Ÿè½½å‡è¡¡ã€‚

# Ribbonè´Ÿè½½å‡è¡¡

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/04-cloud-ribbon
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/04-cloud-ribbon

æˆ‘ä»¬æ·»åŠ äº† `@LoadBalanced` æ³¨è§£ï¼Œå³å¯å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸç†å‘¢ï¼Ÿ

**SpringCloud åº•å±‚æä¾›äº†ä¸€ä¸ªåä¸º Ribbon çš„ç»„ä»¶ï¼Œæ¥å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚**

![](https://cdn.xn2001.com/img/2021/20210901091242.png)

## æºç è·Ÿè¸ª

ä¸ºä»€ä¹ˆæˆ‘ä»¬åªè¾“å…¥äº† service åç§°å°±å¯ä»¥è®¿é—®äº†å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸éœ€è¦è·å–ipå’Œç«¯å£ï¼Œè¿™æ˜¾ç„¶æœ‰äººå¸®æˆ‘ä»¬æ ¹æ® service åç§°ï¼Œè·å–åˆ°äº†æœåŠ¡å®ä¾‹çš„ipå’Œç«¯å£ã€‚å®ƒå°±æ˜¯`LoadBalancerInterceptor`ï¼Œè¿™ä¸ªç±»ä¼šåœ¨å¯¹ RestTemplate çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œç„¶åä» Eureka æ ¹æ®æœåŠ¡ id è·å–æœåŠ¡åˆ—è¡¨ï¼Œéšååˆ©ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•å¾—åˆ°çœŸå®çš„æœåŠ¡åœ°å€ä¿¡æ¯ï¼Œæ›¿æ¢æœåŠ¡ idã€‚

æˆ‘ä»¬è¿›è¡Œæºç è·Ÿè¸ªï¼š

![](https://cdn.xn2001.com/img/2021/20210901091323.png)

è¿™é‡Œçš„ `intercept()` æ–¹æ³•ï¼Œæ‹¦æˆªäº†ç”¨æˆ·çš„ HttpRequest è¯·æ±‚ï¼Œç„¶ååšäº†å‡ ä»¶äº‹ï¼š

- `request.getURI()`ï¼šè·å–è¯·æ±‚uriï¼Œå³ http://user-service/user/8
- `originalUri.getHost()`ï¼šè·å–uriè·¯å¾„çš„ä¸»æœºåï¼Œå…¶å®å°±æ˜¯æœåŠ¡id `user-service`
- `this.loadBalancer.execute()`ï¼šå¤„ç†æœåŠ¡idï¼Œå’Œç”¨æˆ·è¯·æ±‚

è¿™é‡Œçš„ `this.loadBalancer` æ˜¯ `LoadBalancerClient` ç±»å‹

ç»§ç»­è·Ÿå…¥ `execute()` æ–¹æ³•ï¼š

![](https://cdn.xn2001.com/img/2021/20210901091330.png)

- `getLoadBalancer(serviceId)`ï¼šæ ¹æ®æœåŠ¡idè·å– `ILoadBalancer`ï¼Œè€Œ `ILoadBalancer` ä¼šæ‹¿ç€æœåŠ¡ id å» eureka ä¸­è·å–æœåŠ¡åˆ—è¡¨ã€‚
- `getServer(loadBalancer)`ï¼šåˆ©ç”¨å†…ç½®çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä»æœåŠ¡åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªã€‚åœ¨å›¾ä¸­**å¯ä»¥çœ‹åˆ°è·å–äº†8082ç«¯å£çš„æœåŠ¡**

å¯ä»¥çœ‹åˆ°è·å–æœåŠ¡æ—¶ï¼Œé€šè¿‡ä¸€ä¸ª `getServer()` æ–¹æ³•æ¥åšè´Ÿè½½å‡è¡¡:

 ![](https://cdn.xn2001.com/img/2021/20210901091345.png)

æˆ‘ä»¬ç»§ç»­è·Ÿå…¥ï¼š

![](https://cdn.xn2001.com/img/2021/20210901091355.png)

ç»§ç»­è·Ÿè¸ªæºç  `chooseServer()` æ–¹æ³•ï¼Œå‘ç°è¿™ä¹ˆä¸€æ®µä»£ç ï¼š

 ![](https://cdn.xn2001.com/img/2021/20210901091414.png)

æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª `rule` æ˜¯è°ï¼š

 ![](https://cdn.xn2001.com/img/2021/20210901091432.png)

è¿™é‡Œçš„ rule é»˜è®¤å€¼æ˜¯ä¸€ä¸ª `RoundRobinRule` ï¼Œçœ‹ç±»çš„ä»‹ç»ï¼š

![](https://cdn.xn2001.com/img/2021/20210901091442.png)

è´Ÿè½½å‡è¡¡é»˜è®¤ä½¿ç”¨äº†è½®è®­ç®—æ³•ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ã€‚

## æµç¨‹æ€»ç»“

SpringCloud Ribbon åº•å±‚é‡‡ç”¨äº†ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ‹¦æˆªäº† RestTemplate å‘å‡ºçš„è¯·æ±‚ï¼Œå¯¹åœ°å€åšäº†ä¿®æ”¹ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

- æ‹¦æˆªæˆ‘ä»¬çš„ `RestTemplate` è¯·æ±‚ http://userservice/user/1
- `RibbonLoadBalancerClient` ä¼šä»è¯·æ±‚urlä¸­è·å–æœåŠ¡åç§°ï¼Œä¹Ÿå°±æ˜¯ user-service
- `DynamicServerListLoadBalancer` æ ¹æ® user-service åˆ° eureka æ‹‰å–æœåŠ¡åˆ—è¡¨
- eureka è¿”å›åˆ—è¡¨ï¼Œlocalhost:8081ã€localhost:8082
- `IRule` åˆ©ç”¨å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œä¾‹å¦‚ localhost:8081
- `RibbonLoadBalancerClient` ä¿®æ”¹è¯·æ±‚åœ°å€ï¼Œç”¨ localhost:8081 æ›¿ä»£ userserviceï¼Œå¾—åˆ° http://localhost:8081/user/1ï¼Œå‘èµ·çœŸå®è¯·æ±‚

![](https://cdn.xn2001.com/img/2021/20210901091755.png)

## è´Ÿè½½å‡è¡¡ç­–ç•¥

è´Ÿè½½å‡è¡¡çš„è§„åˆ™éƒ½å®šä¹‰åœ¨ IRule æ¥å£ä¸­ï¼Œè€Œ IRule æœ‰å¾ˆå¤šä¸åŒçš„å®ç°ç±»ï¼š

![](https://cdn.xn2001.com/img/2021/20210901091811.png)

ä¸åŒè§„åˆ™çš„å«ä¹‰å¦‚ä¸‹ï¼š

| **å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ç±»**    | **è§„åˆ™æè¿°**                                                 |
| ------------------------- | ------------------------------------------------------------ |
| RoundRobinRule            | ç®€å•è½®è¯¢æœåŠ¡åˆ—è¡¨æ¥é€‰æ‹©æœåŠ¡å™¨ã€‚å®ƒæ˜¯Ribboné»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚ |
| AvailabilityFilteringRule | å¯¹ä»¥ä¸‹ä¸¤ç§æœåŠ¡å™¨è¿›è¡Œå¿½ç•¥ï¼šï¼ˆ1ï¼‰åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™å°æœåŠ¡å™¨å¦‚æœ3æ¬¡è¿æ¥å¤±è´¥ï¼Œè¿™å°æœåŠ¡å™¨å°±ä¼šè¢«è®¾ç½®ä¸ºâ€œçŸ­è·¯â€çŠ¶æ€ã€‚çŸ­è·¯çŠ¶æ€å°†æŒç»­30ç§’ï¼Œå¦‚æœå†æ¬¡è¿æ¥å¤±è´¥ï¼ŒçŸ­è·¯çš„æŒç»­æ—¶é—´å°±ä¼šå‡ ä½•çº§åœ°å¢åŠ ã€‚ ï¼ˆ2ï¼‰å¹¶å‘æ•°è¿‡é«˜çš„æœåŠ¡å™¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å™¨çš„å¹¶å‘è¿æ¥æ•°è¿‡é«˜ï¼Œé…ç½®äº†AvailabilityFilteringRule è§„åˆ™çš„å®¢æˆ·ç«¯ä¹Ÿä¼šå°†å…¶å¿½ç•¥ã€‚å¹¶å‘è¿æ¥æ•°çš„ä¸Šé™ï¼Œå¯ä»¥ç”±å®¢æˆ·ç«¯è®¾ç½®ã€‚ |
| WeightedResponseTimeRule  | ä¸ºæ¯ä¸€ä¸ªæœåŠ¡å™¨èµ‹äºˆä¸€ä¸ªæƒé‡å€¼ã€‚æœåŠ¡å™¨å“åº”æ—¶é—´è¶Šé•¿ï¼Œè¿™ä¸ªæœåŠ¡å™¨çš„æƒé‡å°±è¶Šå°ã€‚è¿™ä¸ªè§„åˆ™ä¼šéšæœºé€‰æ‹©æœåŠ¡å™¨ï¼Œè¿™ä¸ªæƒé‡å€¼ä¼šå½±å“æœåŠ¡å™¨çš„é€‰æ‹©ã€‚ |
| **ZoneAvoidanceRule**     | ä»¥åŒºåŸŸå¯ç”¨çš„æœåŠ¡å™¨ä¸ºåŸºç¡€è¿›è¡ŒæœåŠ¡å™¨çš„é€‰æ‹©ã€‚ä½¿ç”¨Zoneå¯¹æœåŠ¡å™¨è¿›è¡Œåˆ†ç±»ï¼Œè¿™ä¸ªZoneå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæœºæˆ¿ã€ä¸€ä¸ªæœºæ¶ç­‰ã€‚è€Œåå†å¯¹Zoneå†…çš„å¤šä¸ªæœåŠ¡åšè½®è¯¢ã€‚ |
| BestAvailableRule         | å¿½ç•¥é‚£äº›çŸ­è·¯çš„æœåŠ¡å™¨ï¼Œå¹¶é€‰æ‹©å¹¶å‘æ•°è¾ƒä½çš„æœåŠ¡å™¨ã€‚             |
| RandomRule                | éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å™¨ã€‚                                   |
| RetryRule                 | é‡è¯•æœºåˆ¶çš„é€‰æ‹©é€»è¾‘                                           |

é»˜è®¤çš„å®ç°å°±æ˜¯ `ZoneAvoidanceRule`ï¼Œ**æ˜¯ä¸€ç§è½®è¯¢æ–¹æ¡ˆ**ã€‚

## è‡ªå®šä¹‰ç­–ç•¥

é€šè¿‡å®šä¹‰ IRule å®ç°å¯ä»¥ä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

1 ä»£ç æ–¹å¼åœ¨ order-service ä¸­çš„ OrderApplication ç±»ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªæ–°çš„ IRuleï¼š

![](https://cdn.xn2001.com/img/2021/20210901091832.png)

2 é…ç½®æ–‡ä»¶æ–¹å¼ï¼šåœ¨ order-service çš„ application.yml æ–‡ä»¶ä¸­ï¼Œæ·»åŠ æ–°çš„é…ç½®ä¹Ÿå¯ä»¥ä¿®æ”¹è§„åˆ™ï¼š

```yml
userservice: # ç»™éœ€è¦è°ƒç”¨çš„å¾®æœåŠ¡é…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼ŒorderserviceæœåŠ¡å»è°ƒç”¨userserviceæœåŠ¡
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule # è´Ÿè½½å‡è¡¡è§„åˆ™ 
```

**æ³¨æ„**ï¼šä¸€èˆ¬ç”¨é»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä¸åšä¿®æ”¹ã€‚

## é¥¥é¥¿åŠ è½½

å½“æˆ‘ä»¬å¯åŠ¨ orderserviceï¼Œç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼Œæ—¶é—´æ¶ˆè€—ä¼šå¤§å¾ˆå¤šï¼Œè¿™æ˜¯å› ä¸º Ribbon æ‡’åŠ è½½çš„æœºåˆ¶ã€‚

![](https://cdn.xn2001.com/img/2021/20210901091850.png)

Ribbon é»˜è®¤æ˜¯é‡‡ç”¨æ‡’åŠ è½½ï¼Œå³ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰ä¼šå»åˆ›å»º LoadBalanceClientï¼Œæ‹‰å–é›†ç¾¤åœ°å€ï¼Œæ‰€ä»¥è¯·æ±‚æ—¶é—´ä¼šå¾ˆé•¿ã€‚

è€Œé¥¥é¥¿åŠ è½½åˆ™ä¼šåœ¨é¡¹ç›®å¯åŠ¨æ—¶åˆ›å»º LoadBalanceClientï¼Œé™ä½ç¬¬ä¸€æ¬¡è®¿é—®çš„è€—æ—¶ï¼Œé€šè¿‡ä¸‹é¢é…ç½®å¼€å¯é¥¥é¥¿åŠ è½½ï¼š

```yml
ribbon:
  eager-load:
    enabled: true
    clients: userservice # é¡¹ç›®å¯åŠ¨æ—¶ç›´æ¥å»æ‹‰å–userserviceçš„é›†ç¾¤ï¼Œå¤šä¸ªç”¨","éš”å¼€
    # - userservice
    # - orderservice å¤šä¸ªçš„æƒ…å†µï¼Œyamlæ–‡ä»¶çš„æ•°ç»„æ¨¡å¼	
```

# Nacosæ³¨å†Œä¸­å¿ƒ

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos

SpringCloudAlibaba æ¨å‡ºäº†ä¸€ä¸ªåä¸º Nacos çš„æ³¨å†Œä¸­å¿ƒï¼Œåœ¨å›½å¤–ä¹Ÿæœ‰å¤§é‡çš„ä½¿ç”¨ã€‚

![](https://cdn.xn2001.com/img/2021/20210901091857.png)

è§£å‹å¯åŠ¨ Nacosï¼Œè¯¦ç»†è¯·çœ‹ [Nacoså®‰è£…æŒ‡å—](https://www.xn2001.com/archives/661.html)

```
startup.cmd -m standalone
```

è®¿é—®ï¼šhttp://localhost:8848/nacos/

![](https://cdn.xn2001.com/img/2021/20210901091904.png)

## æœåŠ¡æ³¨å†Œ

è¿™é‡Œä¸Šæ¥å°±ç›´æ¥æœåŠ¡æ³¨å†Œï¼Œå¾ˆå¤šä¸œè¥¿å¯èƒ½æœ‰ç–‘æƒ‘ï¼Œå…¶å® Nacos æœ¬èº«å°±æ˜¯ä¸€ä¸ª SprintBoot é¡¹ç›®ï¼Œè¿™ç‚¹ä½ ä»å¯åŠ¨çš„æ§åˆ¶å°æ‰“å°å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ‰€ä»¥å°±ä¸å†éœ€è¦å»é¢å¤–æ­å»ºä¸€ä¸ªåƒ Eureka çš„æ³¨å†Œä¸­å¿ƒã€‚

**å¼•å…¥ä¾èµ–**

åœ¨ cloud-demo çˆ¶å·¥ç¨‹ä¸­å¼•å…¥ SpringCloudAlibaba çš„ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-dependencies</artifactId>
    <version>2.2.6.RELEASE</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
```

ç„¶ååœ¨ user-service å’Œ order-service ä¸­çš„pomæ–‡ä»¶ä¸­å¼•å…¥ nacos-discovery ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

**é…ç½®nacosåœ°å€**

åœ¨ user-service å’Œ order-service çš„ application.yml ä¸­æ·»åŠ  nacos åœ°å€ï¼š

```yaml
spring:
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
```

é¡¹ç›®é‡æ–°å¯åŠ¨åï¼Œå¯ä»¥çœ‹åˆ°ä¸‰ä¸ªæœåŠ¡éƒ½è¢«æ³¨å†Œè¿›äº† Nacos

![](https://cdn.xn2001.com/img/2021/20210901091918.png)

æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8080/order/101ï¼Œæ­£å¸¸è®¿é—®ï¼ŒåŒæ—¶è´Ÿè½½å‡è¡¡ä¹Ÿæ­£å¸¸ã€‚

## åˆ†çº§å­˜å‚¨æ¨¡å‹

ä¸€ä¸ª**æœåŠ¡**å¯ä»¥æœ‰å¤šä¸ª**å®ä¾‹**ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„ user-serviceï¼Œå¯ä»¥æœ‰:

- 127.0.0.1:8081
- 127.0.0.1:8082
- 127.0.0.1:8083

å‡å¦‚è¿™äº›å®ä¾‹åˆ†å¸ƒäºå…¨å›½å„åœ°çš„ä¸åŒæœºæˆ¿ï¼Œä¾‹å¦‚ï¼š

- 127.0.0.1:8081ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿
- 127.0.0.1:8082ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿
- 127.0.0.1:8083ï¼Œåœ¨æ­å·æœºæˆ¿

Nacoså°±å°†åŒä¸€æœºæˆ¿å†…çš„å®ä¾‹ï¼Œåˆ’åˆ†ä¸ºä¸€ä¸ª**é›†ç¾¤**ã€‚

![](https://cdn.xn2001.com/img/2021/20210901091928.png)

å¾®æœåŠ¡äº’ç›¸è®¿é—®æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½è®¿é—®åŒé›†ç¾¤å®ä¾‹ï¼Œå› ä¸ºæœ¬åœ°è®¿é—®é€Ÿåº¦æ›´å¿«ã€‚**å½“æœ¬é›†ç¾¤å†…ä¸å¯ç”¨æ—¶ï¼Œæ‰è®¿é—®å…¶å®ƒé›†ç¾¤ã€‚**ä¾‹å¦‚ï¼šæ­å·æœºæˆ¿å†…çš„ order-service åº”è¯¥ä¼˜å…ˆè®¿é—®åŒæœºæˆ¿çš„ user-serviceã€‚

![](https://cdn.xn2001.com/img/2021/20210901091937.png)

## é…ç½®é›†ç¾¤

æ¥ä¸‹æ¥æˆ‘ä»¬ç»™ user-service **é…ç½®é›†ç¾¤**

ä¿®æ”¹ user-service çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ é›†ç¾¤é…ç½®ï¼š

```yml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ # é›†ç¾¤åç§° HZæ­å·
```

é‡å¯ä¸¤ä¸ª user-service å®ä¾‹åï¼Œæˆ‘ä»¬å†å»å¯åŠ¨ä¸€ä¸ªä¸Šæµ·é›†ç¾¤çš„å®ä¾‹ã€‚

```
-Dserver.port=8083 -Dspring.cloud.nacos.discovery.cluster-name=SH
```

![](https://cdn.xn2001.com/img/2021/20210901091947.png)

æŸ¥çœ‹ nacos æ§åˆ¶å°

![](https://cdn.xn2001.com/img/2021/20210901091957.png)

## NacosRule

Ribbonçš„é»˜è®¤å®ç° `ZoneAvoidanceRule` å¹¶ä¸èƒ½å®ç°æ ¹æ®åŒé›†ç¾¤ä¼˜å…ˆæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬æŠŠè§„åˆ™æ”¹æˆ **NacosRule** å³å¯ã€‚æˆ‘ä»¬æ˜¯ç”¨ orderservice è°ƒç”¨ userserviceï¼Œæ‰€ä»¥åœ¨ orderservice é…ç½®è§„åˆ™ã€‚

```java
@Bean
public IRule iRule(){
    //é»˜è®¤ä¸ºè½®è¯¢è§„åˆ™ï¼Œè¿™é‡Œè‡ªå®šä¹‰ä¸ºéšæœºè§„åˆ™
    return new NacosRule();
}
```

å¦å¤–ï¼Œä½ åŒæ ·å¯ä»¥ä½¿ç”¨é…ç½®çš„å½¢å¼æ¥å®Œæˆï¼Œå…·ä½“å‚è€ƒä¸Šé¢çš„ Ribbon æ ç›®ã€‚

```yml
userservice:
  ribbon:
    NFLoadBalancerRuleClassName: com.alibaba.cloud.nacos.ribbon.NacosRule #è´Ÿè½½å‡è¡¡è§„åˆ™ 
```

ç„¶åï¼Œå†å¯¹ orderservice é…ç½®é›†ç¾¤ã€‚

```yml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ # é›†ç¾¤åç§°
```

ç°åœ¨æˆ‘å¯åŠ¨äº†å››ä¸ªæœåŠ¡ï¼Œåˆ†åˆ«æ˜¯ï¼š

- orderservice - HZ
- userservice - HZ
- userservice1 - HZ
- userservice2 - SH

è®¿é—®åœ°å€ï¼šhttp://localhost:8080/order/101

åœ¨è®¿é—®ä¸­æˆ‘ä»¬å‘ç°ï¼Œåªæœ‰åŒåœ¨ä¸€ä¸ª HZ é›†ç¾¤ä¸‹çš„ userserviceã€userservice1 ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ˜¯éšæœºçš„ã€‚

æˆ‘ä»¬è¯•ç€æŠŠ userserviceã€userservice2 åœæ‰ã€‚ä¾æ—§å¯ä»¥è®¿é—®ã€‚

åœ¨ userservice3 æ§åˆ¶å°å¯ä»¥çœ‹åˆ°å‘å‡ºäº†ä¸€ä¸²çš„è­¦å‘Šï¼Œå› ä¸º orderservice æœ¬èº«æ˜¯åœ¨ HZ é›†ç¾¤çš„ï¼Œè¿™æ³¢ HZ é›†ç¾¤æ²¡æœ‰äº† userserviceï¼Œå°±ä¼šå»åˆ«çš„é›†ç¾¤æ‰¾ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092012.png)

## æƒé‡é…ç½®

å®é™…éƒ¨ç½²ä¸­ä¼šå‡ºç°è¿™æ ·çš„åœºæ™¯ï¼š

æœåŠ¡å™¨è®¾å¤‡æ€§èƒ½æœ‰å·®å¼‚ï¼Œéƒ¨åˆ†å®ä¾‹æ‰€åœ¨æœºå™¨æ€§èƒ½è¾ƒå¥½ï¼Œå¦ä¸€äº›è¾ƒå·®ï¼Œæˆ‘ä»¬å¸Œæœ›æ€§èƒ½å¥½çš„æœºå™¨æ‰¿æ‹…æ›´å¤šçš„ç”¨æˆ·è¯·æ±‚ã€‚ä½†é»˜è®¤æƒ…å†µä¸‹ NacosRule æ˜¯åŒé›†ç¾¤å†…éšæœºæŒ‘é€‰ï¼Œä¸ä¼šè€ƒè™‘æœºå™¨çš„æ€§èƒ½é—®é¢˜ã€‚

å› æ­¤ï¼ŒNacos æä¾›äº†**æƒé‡é…ç½®æ¥æ§åˆ¶è®¿é—®é¢‘ç‡**ï¼Œ0~1 ä¹‹é—´ï¼Œæƒé‡è¶Šå¤§åˆ™è®¿é—®é¢‘ç‡è¶Šé«˜ï¼Œæƒé‡ä¿®æ”¹ä¸º 0ï¼Œåˆ™è¯¥å®ä¾‹æ°¸è¿œä¸ä¼šè¢«è®¿é—®ã€‚

åœ¨ Nacos æ§åˆ¶å°ï¼Œæ‰¾åˆ° user-service çš„å®ä¾‹åˆ—è¡¨ï¼Œç‚¹å‡»ç¼–è¾‘ï¼Œå³å¯ä¿®æ”¹æƒé‡ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092020.png)

åœ¨å¼¹å‡ºçš„ç¼–è¾‘çª—å£ï¼Œä¿®æ”¹æƒé‡

![](https://cdn.xn2001.com/img/2021/20210901092026.png)

å¦å¤–ï¼Œåœ¨æœåŠ¡å‡çº§çš„æ—¶å€™ï¼Œæœ‰ä¸€ç§è¾ƒå¥½çš„æ–¹æ¡ˆï¼šæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è°ƒæ•´æƒé‡æ¥è¿›è¡Œå¹³æ»‘å‡çº§ï¼Œä¾‹å¦‚ï¼šå…ˆæŠŠ userservice æƒé‡è°ƒèŠ‚ä¸º 0ï¼Œè®©ç”¨æˆ·å…ˆæµå‘ userservice2ã€userservice3ï¼Œå‡çº§ userserviceåï¼Œå†æŠŠæƒé‡ä» 0 è°ƒåˆ° 0.1ï¼Œè®©ä¸€éƒ¨åˆ†ç”¨æˆ·å…ˆä½“éªŒï¼Œç”¨æˆ·ä½“éªŒç¨³å®šåå°±å¯ä»¥å¾€ä¸Šè°ƒæƒé‡å•¦ã€‚

## ç¯å¢ƒéš”ç¦»

Nacos æä¾›äº† namespace æ¥å®ç°ç¯å¢ƒéš”ç¦»åŠŸèƒ½ã€‚

- Nacos ä¸­å¯ä»¥æœ‰å¤šä¸ª namespace
- namespace ä¸‹å¯ä»¥æœ‰ groupã€service ç­‰
- ä¸åŒ namespace ä¹‹é—´**ç›¸äº’éš”ç¦»**ï¼Œä¾‹å¦‚ä¸åŒ namespace çš„æœåŠ¡äº’ç›¸ä¸å¯è§

![](https://cdn.xn2001.com/img/2021/20210901092032.png)

### åˆ›å»ºnamespace

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ serviceã€dataã€group éƒ½åœ¨åŒä¸€ä¸ª namespaceï¼Œåä¸º public(ä¿ç•™ç©ºé—´)ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092038.png)

æˆ‘ä»¬å¯ä»¥ç‚¹å‡»é¡µé¢æ–°å¢æŒ‰é’®ï¼Œæ·»åŠ ä¸€ä¸ª namespaceï¼š

![](https://cdn.xn2001.com/img/2021/20210901092050.png)



ç„¶åï¼Œå¡«å†™è¡¨å•ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092059.png)

å°±èƒ½åœ¨é¡µé¢çœ‹åˆ°ä¸€ä¸ªæ–°çš„ namespaceï¼š

![](https://cdn.xn2001.com/img/2021/20210901092114.png)

### é…ç½®namespace

ç»™å¾®æœåŠ¡é…ç½® namespace åªèƒ½é€šè¿‡ä¿®æ”¹é…ç½®æ¥å®ç°ã€‚

ä¾‹å¦‚ï¼Œä¿®æ”¹ order-service çš„ application.yml æ–‡ä»¶ï¼š

```yaml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ
        namespace: 492a7d5d-237b-46a1-a99a-fa8e98e4b0f9 # å‘½åç©ºé—´ID
```

é‡å¯ order-service åï¼Œè®¿é—®æ§åˆ¶å°ã€‚

**public**

![](https://cdn.xn2001.com/img/2021/20210901092143.png)

**dev**

![](https://cdn.xn2001.com/img/2021/20210901092130.png)

æ­¤æ—¶è®¿é—® order-serviceï¼Œå› ä¸º namespace ä¸åŒï¼Œä¼šå¯¼è‡´æ‰¾ä¸åˆ° userserviceï¼Œæ§åˆ¶å°ä¼šæŠ¥é”™ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092138.png)

## ä¸´æ—¶å®ä¾‹

Nacos çš„æœåŠ¡å®ä¾‹åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š

- **ä¸´æ—¶å®ä¾‹**ï¼šå¦‚æœå®ä¾‹å®•æœºè¶…è¿‡ä¸€å®šæ—¶é—´ï¼Œä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œ**é»˜è®¤çš„ç±»å‹**ã€‚
- éä¸´æ—¶å®ä¾‹ï¼šå¦‚æœå®ä¾‹å®•æœºï¼Œä¸ä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œä¹Ÿå¯ä»¥å«æ°¸ä¹…å®ä¾‹ã€‚

é…ç½®ä¸€ä¸ªæœåŠ¡å®ä¾‹ä¸ºæ°¸ä¹…å®ä¾‹ï¼š

```yaml
spring:
  cloud:
    nacos:
      discovery:
        ephemeral: false # è®¾ç½®ä¸ºéä¸´æ—¶å®ä¾‹
```

å¦å¤–ï¼ŒNacos é›†ç¾¤**é»˜è®¤é‡‡ç”¨APæ–¹å¼(å¯ç”¨æ€§)**ï¼Œå½“é›†ç¾¤ä¸­å­˜åœ¨éä¸´æ—¶å®ä¾‹æ—¶ï¼Œ**é‡‡ç”¨CPæ¨¡å¼(ä¸€è‡´æ€§)**ï¼›è€Œ Eureka é‡‡ç”¨APæ–¹å¼ï¼Œä¸å¯åˆ‡æ¢ã€‚ï¼ˆè¿™é‡Œè¯´çš„æ˜¯ CAP åŸç†ï¼Œåé¢ä¼šå†™åˆ°ï¼‰

# Nacosé…ç½®ä¸­å¿ƒ

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos

Nacosé™¤äº†å¯ä»¥åšæ³¨å†Œä¸­å¿ƒï¼ŒåŒæ ·å¯ä»¥åšé…ç½®ç®¡ç†æ¥ä½¿ç”¨ã€‚

å½“å¾®æœåŠ¡éƒ¨ç½²çš„å®ä¾‹è¶Šæ¥è¶Šå¤šï¼Œè¾¾åˆ°æ•°åã€æ•°ç™¾æ—¶ï¼Œé€ä¸ªä¿®æ”¹å¾®æœåŠ¡é…ç½®å°±ä¼šè®©äººæŠ“ç‹‚ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å‡ºé”™ã€‚**æˆ‘ä»¬éœ€è¦ä¸€ç§ç»Ÿä¸€é…ç½®ç®¡ç†æ–¹æ¡ˆï¼Œå¯ä»¥é›†ä¸­ç®¡ç†æ‰€æœ‰å®ä¾‹çš„é…ç½®ã€‚**

![](https://cdn.xn2001.com/img/2021/20210901092150.png)



Nacos ä¸€æ–¹é¢å¯ä»¥å°†é…ç½®é›†ä¸­ç®¡ç†ï¼Œå¦ä¸€æ–¹å¯ä»¥åœ¨é…ç½®å˜æ›´æ—¶ï¼ŒåŠæ—¶é€šçŸ¥å¾®æœåŠ¡ï¼Œ**å®ç°é…ç½®çš„çƒ­æ›´æ–°ã€‚**

## åˆ›å»ºé…ç½®

åœ¨ Nacos æ§åˆ¶é¢æ¿ä¸­æ·»åŠ é…ç½®æ–‡ä»¶

![](https://cdn.xn2001.com/img/2021/20210901092159.png)

ç„¶ååœ¨å¼¹å‡ºçš„è¡¨å•ä¸­ï¼Œå¡«å†™é…ç½®ä¿¡æ¯ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092206.png)

**æ³¨æ„**ï¼šé¡¹ç›®çš„æ ¸å¿ƒé…ç½®ï¼Œéœ€è¦çƒ­æ›´æ–°çš„é…ç½®æ‰æœ‰æ”¾åˆ° nacos ç®¡ç†çš„å¿…è¦ã€‚åŸºæœ¬ä¸ä¼šå˜æ›´çš„ä¸€äº›é…ç½®(ä¾‹å¦‚æ•°æ®åº“è¿æ¥)è¿˜æ˜¯ä¿å­˜åœ¨å¾®æœåŠ¡æœ¬åœ°æ¯”è¾ƒå¥½ã€‚

## æ‹‰å–é…ç½®

é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£ Nacos è¯»å–é…ç½®æ–‡ä»¶çš„ç¯èŠ‚æ˜¯åœ¨å“ªä¸€æ­¥ï¼Œåœ¨æ²¡åŠ å…¥ Nacos é…ç½®ä¹‹å‰ï¼Œè·å–é…ç½®æ˜¯è¿™æ ·ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092215.png)

åŠ å…¥ Nacos é…ç½®ï¼Œå®ƒçš„è¯»å–æ˜¯åœ¨ application.yml ä¹‹å‰çš„ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092223.png)

è¿™æ—¶å€™å¦‚æœæŠŠ nacos åœ°å€æ”¾åœ¨ application.yml ä¸­ï¼Œæ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ï¼Œ**Nacos å°±æ— æ³•æ ¹æ®åœ°å€å»è·å–é…ç½®äº†ã€‚**

å› æ­¤ï¼Œnacos åœ°å€å¿…é¡»æ”¾åœ¨ä¼˜å…ˆçº§æœ€é«˜çš„ bootstrap.yml æ–‡ä»¶ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092228.png)

**å¼•å…¥ nacos-config ä¾èµ–**

é¦–å…ˆï¼Œåœ¨ user-service æœåŠ¡ä¸­ï¼Œå¼•å…¥ nacos-config çš„å®¢æˆ·ç«¯ä¾èµ–ï¼š

```xml
<!--nacosé…ç½®ç®¡ç†ä¾èµ–-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

**æ·»åŠ  bootstrap.yml**

ç„¶åï¼Œåœ¨ user-service ä¸­æ·»åŠ ä¸€ä¸ª bootstrap.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
spring:
  application:
    name: userservice # æœåŠ¡åç§°
  profiles:
    active: dev #å¼€å‘ç¯å¢ƒï¼Œè¿™é‡Œæ˜¯dev 
  cloud:
    nacos:
      server-addr: localhost:8848 # Nacosåœ°å€
      config:
        file-extension: yaml # æ–‡ä»¶åç¼€å
```

æ ¹æ® spring.cloud.nacos.server-addr è·å– nacosåœ°å€ï¼Œå†æ ¹æ®`${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}`ä½œä¸ºæ–‡ä»¶idï¼Œæ¥è¯»å–é…ç½®ã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¾‹ä¸­ï¼Œå°±æ˜¯å»è¯»å– `userservice-dev.yaml`

![](https://cdn.xn2001.com/img/2021/20210901092237.png)

ä½¿ç”¨ä»£ç æ¥éªŒè¯æ˜¯å¦æ‹‰å–æˆåŠŸ

åœ¨ user-service ä¸­çš„ UserController ä¸­æ·»åŠ ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å– pattern.dateformat é…ç½®å¹¶ä½¿ç”¨ï¼š

```java
@Value("${pattern.dateformat}")
private String dateformat;

@GetMapping("now")
public String now(){
    //æ ¼å¼åŒ–æ—¶é—´
    return LocalDateTime.now().format(DateTimeFormatter.ofPattern(dateformat));
}
```

![](https://cdn.xn2001.com/img/2021/20210901092243.png)

å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ï¼šhttp://localhost:8081/user/now

![](https://cdn.xn2001.com/img/2021/20210901092251.png)

## é…ç½®çƒ­æ›´æ–°

æˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„ï¼Œæ˜¯ä¿®æ”¹ nacos ä¸­çš„é…ç½®åï¼Œå¾®æœåŠ¡ä¸­æ— éœ€é‡å¯å³å¯è®©é…ç½®ç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯**é…ç½®çƒ­æ›´æ–°**ã€‚

æœ‰ä¸¤ç§æ–¹å¼ï¼š1. ç”¨ `@value` è¯»å–é…ç½®æ—¶ï¼Œæ­é… `@RefreshScope`ï¼›2. ç›´æ¥ç”¨ `@ConfigurationProperties` è¯»å–é…ç½®

### @RefreshScope

æ–¹å¼ä¸€ï¼šåœ¨ `@Value` æ³¨å…¥çš„å˜é‡æ‰€åœ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ `@RefreshScope`

![](https://cdn.xn2001.com/img/2021/20210901092258.png)

### @ConfigurationProperties

æ–¹å¼äºŒï¼šä½¿ç”¨ `@ConfigurationProperties` æ³¨è§£è¯»å–é…ç½®æ–‡ä»¶ï¼Œå°±ä¸éœ€è¦åŠ  `@RefreshScope` æ³¨è§£ã€‚

åœ¨ user-service æœåŠ¡ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª PatternProperties ç±»ï¼Œè¯»å– `patterrn.dateformat` å±æ€§

```java
@Data
@Component
@ConfigurationProperties(prefix = "pattern")
public class PatternProperties {
    public String dateformat;
}
```

```java
@Autowired
private PatternProperties patternProperties;

@GetMapping("now2")
public String now2(){
    //æ ¼å¼åŒ–æ—¶é—´
    return LocalDateTime.now().format(DateTimeFormatter.ofPattern(patternProperties.dateformat));
}
```

## é…ç½®å…±äº«

å…¶å®åœ¨æœåŠ¡å¯åŠ¨æ—¶ï¼Œnacos ä¼šè¯»å–å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

- `[spring.application.name]-[spring.profiles.active].yaml`ï¼Œä¾‹å¦‚ï¼šuserservice-dev.yaml

- `[spring.application.name].yaml`ï¼Œä¾‹å¦‚ï¼šuserservice.yaml

è¿™é‡Œçš„ `[spring.application.name].yaml` ä¸åŒ…å«ç¯å¢ƒï¼Œ**å› æ­¤å¯ä»¥è¢«å¤šä¸ªç¯å¢ƒå…±äº«**ã€‚

**æ·»åŠ ä¸€ä¸ªç¯å¢ƒå…±äº«é…ç½®**

æˆ‘ä»¬åœ¨ nacos ä¸­æ·»åŠ ä¸€ä¸ª userservice.yaml æ–‡ä»¶ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092323.png)



**åœ¨ user-service ä¸­è¯»å–å…±äº«é…ç½®**

åœ¨ user-service æœåŠ¡ä¸­ï¼Œä¿®æ”¹ PatternProperties ç±»ï¼Œè¯»å–æ–°æ·»åŠ çš„å±æ€§ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092314.png)

åœ¨ user-service æœåŠ¡ä¸­ï¼Œä¿®æ”¹ UserControllerï¼Œæ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092331.png)



**è¿è¡Œä¸¤ä¸ª UserApplicationï¼Œä½¿ç”¨ä¸åŒçš„profile**

ä¿®æ”¹ UserApplication2 è¿™ä¸ªå¯åŠ¨é¡¹ï¼Œæ”¹å˜å…¶profileå€¼ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092345.png)

![](https://cdn.xn2001.com/img/2021/20210901092338.png)

è¿™æ ·ï¼ŒUserApplication(8081) ä½¿ç”¨çš„ profile æ˜¯ devï¼ŒUserApplication2(8082) ä½¿ç”¨çš„ profile æ˜¯test

å¯åŠ¨ UserApplication å’Œ UserApplication2

è®¿é—®åœ°å€ï¼šhttp://localhost:8081/user/propï¼Œç»“æœï¼š

![](https://cdn.xn2001.com/img/2021/20210901092400.png)

è®¿é—®åœ°å€ï¼šhttp://localhost:8082/user/propï¼Œç»“æœï¼š

![](https://cdn.xn2001.com/img/2021/20210901092419.png)

å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸ç®¡æ˜¯ devï¼Œè¿˜æ˜¯ test ç¯å¢ƒï¼Œéƒ½è¯»å–åˆ°äº† envSharedValue è¿™ä¸ªå±æ€§çš„å€¼ã€‚

ä¸Šé¢çš„éƒ½æ˜¯åŒä¸€ä¸ªå¾®æœåŠ¡ä¸‹ï¼Œ**é‚£ä¹ˆä¸åŒå¾®æœåŠ¡ä¹‹é—´å¯ä»¥ç¯å¢ƒå…±äº«å—ï¼Ÿ**

é€šè¿‡ä¸‹é¢çš„ä¸¤ç§æ–¹å¼æ¥æŒ‡å®šï¼š

- extension-configs
- shared-configs 

```yml
spring: 
  cloud:
    nacos:
      config:
        file-extension: yaml # æ–‡ä»¶åç¼€å
        extends-configs: # å¤šå¾®æœåŠ¡é—´å…±äº«çš„é…ç½®åˆ—è¡¨
          - dataId: common.yaml # è¦å…±äº«çš„é…ç½®æ–‡ä»¶id
```

```yml
spring: 
  cloud:
    nacos:
      config:
        file-extension: yaml # æ–‡ä»¶åç¼€å
        shared-configs: # å¤šå¾®æœåŠ¡é—´å…±äº«çš„é…ç½®åˆ—è¡¨
          - dataId: common.yaml # è¦å…±äº«çš„é…ç½®æ–‡ä»¶id
```

## é…ç½®ä¼˜å…ˆçº§

å½“ nacosã€æœåŠ¡æœ¬åœ°åŒæ—¶**å‡ºç°ç›¸åŒå±æ€§æ—¶**ï¼Œä¼˜å…ˆçº§æœ‰é«˜ä½ä¹‹åˆ†ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092501.png)

æ›´ç»†è‡´çš„é…ç½®

![](https://cdn.xn2001.com/img/2021/20210901092520.png)

# Nacosé›†ç¾¤

## æ¶æ„ä»‹ç»

![](https://cdn.xn2001.com/img/2021/202108181959897.png)

å…¶ä¸­åŒ…å« 3 ä¸ªNacos èŠ‚ç‚¹ï¼Œç„¶åä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ Nginx ä»£ç† 3 ä¸ª Nacosï¼Œæˆ‘ä»¬è®¡åˆ’çš„ Nacos é›†ç¾¤å¦‚ä¸‹å›¾ï¼ŒMySQL çš„ä¸»ä»å¤åˆ¶åç»­å†æ·»åŠ ã€‚

![](https://cdn.xn2001.com/img/2021/202108182000220.png)

ä¸‰ä¸ª Nacos èŠ‚ç‚¹çš„åœ°å€

| èŠ‚ç‚¹   | ip            | port |
| ------ | ------------- | ---- |
| nacos1 | 192.168.150.1 | 8845 |
| nacos2 | 192.168.150.1 | 8846 |
| nacos3 | 192.168.150.1 | 8847 |

## åˆå§‹åŒ–æ•°æ®åº“

Nacos é»˜è®¤æ•°æ®å­˜å‚¨åœ¨å†…åµŒæ•°æ®åº“ Derby ä¸­ï¼Œä¸å±äºç”Ÿäº§å¯ç”¨çš„æ•°æ®åº“ã€‚å®˜æ–¹æ¨èçš„æœ€ä½³å®è·µæ˜¯ä½¿ç”¨å¸¦æœ‰ä¸»ä»çš„é«˜å¯ç”¨æ•°æ®åº“é›†ç¾¤ï¼Œä¸»ä»æ¨¡å¼çš„é«˜å¯ç”¨æ•°æ®åº“ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥å•ç‚¹çš„æ•°æ®åº“ä¸ºä¾‹ã€‚

é¦–å…ˆæ–°å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œå‘½åä¸º nacosï¼Œè€Œåå¯¼å…¥ä¸‹é¢çš„ SQL

```sql
CREATE TABLE `config_info` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(255) DEFAULT NULL,
  `content` longtext NOT NULL COMMENT 'content',
  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  `src_user` text COMMENT 'source user',
  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
  `app_name` varchar(128) DEFAULT NULL,
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'ç§Ÿæˆ·å­—æ®µ',
  `c_desc` varchar(256) DEFAULT NULL,
  `c_use` varchar(64) DEFAULT NULL,
  `effect` varchar(64) DEFAULT NULL,
  `type` varchar(64) DEFAULT NULL,
  `c_schema` text,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info';

/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = config_info_aggr   */
/******************************************/
CREATE TABLE `config_info_aggr` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(255) NOT NULL COMMENT 'group_id',
  `datum_id` varchar(255) NOT NULL COMMENT 'datum_id',
  `content` longtext NOT NULL COMMENT 'å†…å®¹',
  `gmt_modified` datetime NOT NULL COMMENT 'ä¿®æ”¹æ—¶é—´',
  `app_name` varchar(128) DEFAULT NULL,
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'ç§Ÿæˆ·å­—æ®µ',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='å¢åŠ ç§Ÿæˆ·å­—æ®µ';


/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = config_info_beta   */
/******************************************/
CREATE TABLE `config_info_beta` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(128) NOT NULL COMMENT 'group_id',
  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
  `content` longtext NOT NULL COMMENT 'content',
  `beta_ips` varchar(1024) DEFAULT NULL COMMENT 'betaIps',
  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  `src_user` text COMMENT 'source user',
  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'ç§Ÿæˆ·å­—æ®µ',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_beta';

/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = config_info_tag   */
/******************************************/
CREATE TABLE `config_info_tag` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(128) NOT NULL COMMENT 'group_id',
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',
  `tag_id` varchar(128) NOT NULL COMMENT 'tag_id',
  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
  `content` longtext NOT NULL COMMENT 'content',
  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  `src_user` text COMMENT 'source user',
  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_tag';

/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = config_tags_relation   */
/******************************************/
CREATE TABLE `config_tags_relation` (
  `id` bigint(20) NOT NULL COMMENT 'id',
  `tag_name` varchar(128) NOT NULL COMMENT 'tag_name',
  `tag_type` varchar(64) DEFAULT NULL COMMENT 'tag_type',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(128) NOT NULL COMMENT 'group_id',
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',
  `nid` bigint(20) NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`nid`),
  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_tag_relation';

/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = group_capacity   */
/******************************************/
CREATE TABLE `group_capacity` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `group_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Group IDï¼Œç©ºå­—ç¬¦è¡¨ç¤ºæ•´ä¸ªé›†ç¾¤',
  `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'ä½¿ç”¨é‡',
  `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°ï¼Œï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'æœ€å¤§å˜æ›´å†å²æ•°é‡',
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_group_id` (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='é›†ç¾¤ã€å„Groupå®¹é‡ä¿¡æ¯è¡¨';

/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = his_config_info   */
/******************************************/
CREATE TABLE `his_config_info` (
  `id` bigint(64) unsigned NOT NULL,
  `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `data_id` varchar(255) NOT NULL,
  `group_id` varchar(128) NOT NULL,
  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
  `content` longtext NOT NULL,
  `md5` varchar(32) DEFAULT NULL,
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `src_user` text,
  `src_ip` varchar(50) DEFAULT NULL,
  `op_type` char(10) DEFAULT NULL,
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'ç§Ÿæˆ·å­—æ®µ',
  PRIMARY KEY (`nid`),
  KEY `idx_gmt_create` (`gmt_create`),
  KEY `idx_gmt_modified` (`gmt_modified`),
  KEY `idx_did` (`data_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='å¤šç§Ÿæˆ·æ”¹é€ ';


/******************************************/
/*   æ•°æ®åº“å…¨å = nacos_config   */
/*   è¡¨åç§° = tenant_capacity   */
/******************************************/
CREATE TABLE `tenant_capacity` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `tenant_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Tenant ID',
  `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'ä½¿ç”¨é‡',
  `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°',
  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼',
  `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT 'æœ€å¤§å˜æ›´å†å²æ•°é‡',
  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='ç§Ÿæˆ·å®¹é‡ä¿¡æ¯è¡¨';


CREATE TABLE `tenant_info` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `kp` varchar(128) NOT NULL COMMENT 'kp',
  `tenant_id` varchar(128) default '' COMMENT 'tenant_id',
  `tenant_name` varchar(128) default '' COMMENT 'tenant_name',
  `tenant_desc` varchar(256) DEFAULT NULL COMMENT 'tenant_desc',
  `create_source` varchar(32) DEFAULT NULL COMMENT 'create_source',
  `gmt_create` bigint(20) NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` bigint(20) NOT NULL COMMENT 'ä¿®æ”¹æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='tenant_info';

CREATE TABLE `users` (
	`username` varchar(50) NOT NULL PRIMARY KEY,
	`password` varchar(500) NOT NULL,
	`enabled` boolean NOT NULL
);

CREATE TABLE `roles` (
	`username` varchar(50) NOT NULL,
	`role` varchar(50) NOT NULL,
	UNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE
);

CREATE TABLE `permissions` (
    `role` varchar(50) NOT NULL,
    `resource` varchar(255) NOT NULL,
    `action` varchar(8) NOT NULL,
    UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE
);

INSERT INTO users (username, password, enabled) VALUES ('nacos', '$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu', TRUE);

INSERT INTO roles (username, role) VALUES ('nacos', 'ROLE_ADMIN');
```

## é…ç½®Nacos

è¿›å…¥ nacos çš„ conf ç›®å½•ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ cluster.conf.exampleï¼Œé‡å‘½åä¸º cluster.conf

![](https://cdn.xn2001.com/img/2021/202108182004564.png)

æ·»åŠ å†…å®¹

```
127.0.0.1:8845
127.0.0.1.8846
127.0.0.1.8847
```

ç„¶åä¿®æ”¹ application.properties æ–‡ä»¶ï¼Œæ·»åŠ æ•°æ®åº“é…ç½®

```properties
spring.datasource.platform=mysql
db.num=1
db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC
db.user.0=root
db.password.0=123456
```

å°† nacos æ–‡ä»¶å¤¹å¤åˆ¶ä¸‰ä»½ï¼Œåˆ†åˆ«å‘½åä¸ºï¼šnacos1ã€nacos2ã€nacos3

![](https://cdn.xn2001.com/img/2021/202108182004103.png) 

ç„¶ååˆ†åˆ«ä¿®æ”¹ä¸‰ä¸ªæ–‡ä»¶å¤¹ä¸­çš„ application.propertiesï¼Œ

nacos1

```properties
server.port=8845
```

nacos2

```properties
server.port=8846
```

nacos3

```properties
server.port=8847
```

ç„¶ååˆ†åˆ«å¯åŠ¨ä¸‰ä¸ª nacos

```
startup.cmd
```

## Nginxåå‘ä»£ç†

ä¿®æ”¹ nginx æ–‡ä»¶å¤¹ä¸‹çš„ conf/nginx.conf æ–‡ä»¶ï¼Œé…ç½®å¦‚ä¸‹

```nginx
upstream nacos-cluster {
    server 127.0.0.1:8845;
	server 127.0.0.1:8846;
	server 127.0.0.1:8847;
}

server {
    listen       80;
    server_name  localhost;

    location /nacos {
        proxy_pass http://nacos-cluster;
    }
}
```

å¯åŠ¨ nginxï¼Œåœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost/nacos

åœ¨ä»£ç ä¸­çš„ application.yml æ–‡ä»¶é…ç½®æ”¹ä¸ºå¦‚ä¸‹ï¼š

```yaml
spring:
  cloud:
    nacos:
      server-addr: localhost:80 # Nacosåœ°å€
```

å®é™…éƒ¨ç½²æ—¶ï¼Œéœ€è¦ç»™åšåå‘ä»£ç†çš„ Nginx æœåŠ¡å™¨è®¾ç½®ä¸€ä¸ªåŸŸåï¼Œè¿™æ ·åç»­å¦‚æœæœ‰æœåŠ¡å™¨è¿ç§» Nacos çš„å®¢æˆ·ç«¯ä¹Ÿæ— éœ€æ›´æ”¹é…ç½®ã€‚Nacos çš„å„ä¸ªèŠ‚ç‚¹åº”è¯¥éƒ¨ç½²åˆ°å¤šä¸ªä¸åŒæœåŠ¡å™¨ï¼Œåšå¥½å®¹ç¾å’Œéš”ç¦»å·¥ä½œã€‚

# Feignè¿œç¨‹è°ƒç”¨

> ä»£ç å‚è€ƒ
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/06-cloud-feign
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/06-cloud-feign

æˆ‘ä»¬ä»¥å‰åˆ©ç”¨ RestTemplate å‘èµ·è¿œç¨‹è°ƒç”¨çš„ä»£ç ï¼š

![](https://cdn.xn2001.com/img/2021/20210901092616.png)

- ä»£ç å¯è¯»æ€§å·®ï¼Œç¼–ç¨‹ä½“éªŒä¸ç»Ÿä¸€
- å‚æ•°å¤æ‚URLéš¾ä»¥ç»´æŠ¤

Feign æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ http å®¢æˆ·ç«¯ï¼Œå®˜æ–¹åœ°å€ï¼šhttps://github.com/OpenFeign/feign

å…¶ä½œç”¨å°±æ˜¯å¸®åŠ©æˆ‘ä»¬**ä¼˜é›…çš„å®ç° http è¯·æ±‚çš„å‘é€**ï¼Œè§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092639.png)

## Feignä½¿ç”¨

**å¼•å…¥ä¾èµ–**

æˆ‘ä»¬åœ¨ order-service å¼•å…¥ feign ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

**æ·»åŠ æ³¨è§£**

åœ¨ order-service å¯åŠ¨ç±»æ·»åŠ æ³¨è§£å¼€å¯ Feign

![](https://cdn.xn2001.com/img/2021/20210901092704.png)

**è¯·æ±‚æ¥å£**

åœ¨ order-service ä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå†…å®¹å¦‚ä¸‹

```java
package com.xn2001.order.client;

import com.xn2001.order.pojo.User;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

@FeignClient("userservice")
public interface UserClient {
    @GetMapping("/user/{id}")
    User findById(@PathVariable("id") Long id);
}
```

`@FeignClient("userservice")`ï¼šå…¶ä¸­å‚æ•°å¡«å†™çš„æ˜¯å¾®æœåŠ¡å

`@GetMapping("/user/{id}")`ï¼šå…¶ä¸­å‚æ•°å¡«å†™çš„æ˜¯è¯·æ±‚è·¯å¾„

è¿™ä¸ªå®¢æˆ·ç«¯ä¸»è¦æ˜¯åŸºäº SpringMVC çš„æ³¨è§£ `@GetMapping` æ¥å£°æ˜è¿œç¨‹è°ƒç”¨çš„ä¿¡æ¯

Feign å¯ä»¥å¸®åŠ©æˆ‘ä»¬å‘é€ http è¯·æ±‚ï¼Œæ— éœ€è‡ªå·±ä½¿ç”¨ RestTemplate æ¥å‘é€äº†ã€‚

**æµ‹è¯•**

```java
@Autowired
private UserClient userClient;

public Order queryOrderAndUserById(Long orderId) {
    // 1.æŸ¥è¯¢è®¢å•
    Order order = orderMapper.findById(orderId);
    // TODO: 2021/8/20 ä½¿ç”¨feignè¿œç¨‹è°ƒç”¨
    User user = userClient.findById(order.getUserId());
    // 3. å°†ç”¨æˆ·ä¿¡æ¯å°è£…è¿›è®¢å•
    order.setUser(user);
    // 4.è¿”å›
    return order;
}
```

## è‡ªå®šä¹‰é…ç½®

Feign å¯ä»¥æ”¯æŒå¾ˆå¤šçš„è‡ªå®šä¹‰é…ç½®ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| ç±»å‹                   | ä½œç”¨             | è¯´æ˜                                                   |
| ---------------------- | ---------------- | ------------------------------------------------------ |
| **feign.Logger.Level** | ä¿®æ”¹æ—¥å¿—çº§åˆ«     | åŒ…å«å››ç§ä¸åŒçš„çº§åˆ«ï¼šNONEã€BASICã€HEADERSã€FULL         |
| feign.codec.Decoder    | å“åº”ç»“æœçš„è§£æå™¨ | httpè¿œç¨‹è°ƒç”¨çš„ç»“æœåšè§£æï¼Œä¾‹å¦‚è§£æjsonå­—ç¬¦ä¸²ä¸ºjavaå¯¹è±¡ |
| feign.codec.Encoder    | è¯·æ±‚å‚æ•°ç¼–ç      | å°†è¯·æ±‚å‚æ•°ç¼–ç ï¼Œä¾¿äºé€šè¿‡httpè¯·æ±‚å‘é€                   |
| feign.Contract         | æ”¯æŒçš„æ³¨è§£æ ¼å¼   | é»˜è®¤æ˜¯SpringMVCçš„æ³¨è§£                                  |
| feign.Retryer          | å¤±è´¥é‡è¯•æœºåˆ¶     | è¯·æ±‚å¤±è´¥çš„é‡è¯•æœºåˆ¶ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ï¼Œä¸è¿‡ä¼šä½¿ç”¨Ribbonçš„é‡è¯• |

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé»˜è®¤å€¼å°±èƒ½æ»¡è¶³æˆ‘ä»¬ä½¿ç”¨ï¼Œå¦‚æœè¦è‡ªå®šä¹‰æ—¶ï¼Œåªéœ€è¦åˆ›å»ºè‡ªå®šä¹‰çš„ @Bean è¦†ç›–é»˜è®¤ Bean å³å¯ã€‚ä¸‹é¢ä»¥æ—¥å¿—ä¸ºä¾‹æ¥æ¼”ç¤ºå¦‚ä½•è‡ªå®šä¹‰é…ç½®ã€‚

åŸºäºé…ç½®æ–‡ä»¶ä¿®æ”¹ feign çš„æ—¥å¿—çº§åˆ«å¯ä»¥é’ˆå¯¹å•ä¸ªæœåŠ¡ï¼š

```yaml
feign:  
  client:
    config: 
      userservice: # é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®
        loggerLevel: FULL #  æ—¥å¿—çº§åˆ« 
```

**ä¹Ÿå¯ä»¥é’ˆå¯¹æ‰€æœ‰æœåŠ¡**ï¼š

```yaml
feign:  
  client:
    config: 
      default: # è¿™é‡Œç”¨defaultå°±æ˜¯å…¨å±€é…ç½®ï¼Œå¦‚æœæ˜¯å†™æœåŠ¡åç§°ï¼Œåˆ™æ˜¯é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®
        loggerLevel: FULL #  æ—¥å¿—çº§åˆ« 
```

è€Œæ—¥å¿—çš„çº§åˆ«åˆ†ä¸ºå››ç§ï¼š

- NONEï¼šä¸è®°å½•ä»»ä½•æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ˜¯é»˜è®¤å€¼ã€‚
- BASICï¼šä»…è®°å½•è¯·æ±‚çš„æ–¹æ³•ï¼ŒURLä»¥åŠå“åº”çŠ¶æ€ç å’Œæ‰§è¡Œæ—¶é—´
- HEADERSï¼šåœ¨BASICçš„åŸºç¡€ä¸Šï¼Œé¢å¤–è®°å½•äº†è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯
- FULLï¼šè®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”çš„æ˜ç»†ï¼ŒåŒ…æ‹¬å¤´ä¿¡æ¯ã€è¯·æ±‚ä½“ã€å…ƒæ•°æ®

ä¹Ÿå¯ä»¥åŸºäº **Java ä»£ç **æ¥ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Œå…ˆå£°æ˜ä¸€ä¸ªç±»ï¼Œç„¶åå£°æ˜ä¸€ä¸ª Logger.Level çš„å¯¹è±¡

```java
public class DefaultFeignConfiguration  {
    @Bean
    public Logger.Level feignLogLevel(){
        return Logger.Level.BASIC; // æ—¥å¿—çº§åˆ«ä¸ºBASIC
    }
}
```

å¦‚æœè¦**å…¨å±€ç”Ÿæ•ˆ**ï¼Œå°†å…¶æ”¾åˆ°å¯åŠ¨ç±»çš„ `@EnableFeignClients` è¿™ä¸ªæ³¨è§£ä¸­ï¼š

```java
@EnableFeignClients(defaultConfiguration = DefaultFeignConfiguration .class) 
```

å¦‚æœæ˜¯**å±€éƒ¨ç”Ÿæ•ˆ**ï¼Œåˆ™æŠŠå®ƒæ”¾åˆ°å¯¹åº”çš„ `@FeignClient` è¿™ä¸ªæ³¨è§£ä¸­ï¼š

```java
@FeignClient(value = "userservice", configuration = DefaultFeignConfiguration .class) 
```

## æ€§èƒ½ä¼˜åŒ–

Feign åº•å±‚å‘èµ· http è¯·æ±‚ï¼Œä¾èµ–äºå…¶å®ƒçš„æ¡†æ¶ã€‚å…¶åº•å±‚å®¢æˆ·ç«¯å®ç°æœ‰ï¼š

- **URLConnection**ï¼šé»˜è®¤å®ç°ï¼Œä¸æ”¯æŒè¿æ¥æ± 
- **Apache HttpClient** ï¼šæ”¯æŒè¿æ¥æ± 
- **OKHttp**ï¼šæ”¯æŒè¿æ¥æ± 

å› æ­¤æé«˜ Feign æ€§èƒ½çš„ä¸»è¦æ‰‹æ®µå°±æ˜¯ä½¿ç”¨**è¿æ¥æ± **ä»£æ›¿é»˜è®¤çš„ URLConnection

å¦å¤–ï¼Œæ—¥å¿—çº§åˆ«åº”è¯¥å°½é‡ç”¨ basic/noneï¼Œå¯ä»¥æœ‰æ•ˆæé«˜æ€§èƒ½ã€‚

**è¿™é‡Œæˆ‘ä»¬ç”¨ Apache çš„HttpClientæ¥æ¼”ç¤ºè¿æ¥æ± ã€‚**

åœ¨ order-service çš„ pom æ–‡ä»¶ä¸­å¼•å…¥ HttpClient ä¾èµ–

```xml
<!--httpClientçš„ä¾èµ– -->
<dependency>
    <groupId>io.github.openfeign</groupId>
    <artifactId>feign-httpclient</artifactId>
</dependency>
```

**é…ç½®è¿æ¥æ± **

åœ¨ order-service çš„ application.yml ä¸­æ·»åŠ é…ç½®

```yaml
feign:
  client:
    config:
      default: # defaultå…¨å±€çš„é…ç½®
        loggerLevel: BASIC # æ—¥å¿—çº§åˆ«ï¼ŒBASICå°±æ˜¯åŸºæœ¬çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯
  httpclient:
    enabled: true # å¼€å¯feignå¯¹HttpClientçš„æ”¯æŒ
    max-connections: 200 # æœ€å¤§çš„è¿æ¥æ•°
    max-connections-per-route: 50 # æ¯ä¸ªè·¯å¾„çš„æœ€å¤§è¿æ¥æ•°
```

åœ¨ FeignClientFactoryBean ä¸­çš„ loadBalance æ–¹æ³•ä¸­æ‰“æ–­ç‚¹

![](https://cdn.xn2001.com/img/2021/20210901092729.png)

Debug æ–¹å¼å¯åŠ¨ order-service  æœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ clientï¼Œåº•å±‚å°±æ˜¯ HttpClient

![](https://cdn.xn2001.com/img/2021/20210901092737.png)

## æœ€ä½³å®è·µ

### ç»§æ‰¿æ–¹å¼

ä¸€æ ·çš„ä»£ç å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥å…±äº«ï¼š

1ï¼‰å®šä¹‰ä¸€ä¸ª API æ¥å£ï¼Œåˆ©ç”¨å®šä¹‰æ–¹æ³•ï¼Œå¹¶åŸºäº SpringMVC æ³¨è§£åšå£°æ˜

2ï¼‰Feign å®¢æˆ·ç«¯ã€Controller éƒ½é›†æˆè¯¥æ¥å£

![](https://cdn.xn2001.com/img/2021/20210901092803.png)

ä¼˜ç‚¹

- ç®€å•
- å®ç°äº†ä»£ç å…±äº«

ç¼ºç‚¹

- æœåŠ¡æä¾›æ–¹ã€æœåŠ¡æ¶ˆè´¹æ–¹ç´§è€¦åˆ
- å‚æ•°åˆ—è¡¨ä¸­çš„æ³¨è§£æ˜ å°„å¹¶ä¸ä¼šç»§æ‰¿ï¼Œå› æ­¤ Controller ä¸­å¿…é¡»å†æ¬¡å£°æ˜æ–¹æ³•ã€å‚æ•°åˆ—è¡¨ã€æ³¨è§£

### æŠ½å–æ–¹å¼

å°† FeignClient æŠ½å–ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œå¹¶ä¸”æŠŠæ¥å£æœ‰å…³çš„ pojoã€é»˜è®¤çš„ Feign é…ç½®éƒ½æ”¾åˆ°è¿™ä¸ªæ¨¡å—ä¸­ï¼Œæä¾›ç»™æ‰€æœ‰æ¶ˆè´¹è€…ä½¿ç”¨ã€‚

ä¾‹å¦‚ï¼šå°† UserClientã€Userã€Feign çš„é»˜è®¤é…ç½®éƒ½æŠ½å–åˆ°ä¸€ä¸ª feign-api åŒ…ä¸­ï¼Œæ‰€æœ‰å¾®æœåŠ¡å¼•ç”¨è¯¥ä¾èµ–åŒ…ï¼Œå³å¯ç›´æ¥ä½¿ç”¨ã€‚

![](https://cdn.xn2001.com/img/2021/20210901092811.png)

æ¥ä¸‹æ¥æˆ‘ä»¬å°±ç”¨è¯¥æ–¹æ³•åœ¨ä»£ç ä¸­å®ç°

**é¦–å…ˆåˆ›å»ºä¸€ä¸ª moduleï¼Œå‘½åä¸º feign-api**

![](https://cdn.xn2001.com/img/2021/20210901092835.png)

åœ¨ feign-api ä¸­ç„¶åå¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

order-serviceä¸­ çš„ UserClientã€User éƒ½å¤åˆ¶åˆ° feign-api é¡¹ç›®ä¸­

![](https://cdn.xn2001.com/img/2021/20210901092848.png)

æ¥ä¸‹æ¥åœ¨ order-service ä¸­ä½¿ç”¨ feign-api

ç”±äºæˆ‘ä»¬å·²ç»å°† UserClientã€User æ”¾åœ¨ fegin-api ä¸­å…±äº«äº† ï¼Œæ‰€ä»¥å¯ä»¥åˆ é™¤ order-service ä¸­çš„ UserClientã€Userï¼Œç„¶ååœ¨ order-service  ä¸­å¼•å…¥ feign-api 

```xml
<dependency>
    <groupId>com.xn2001.feign</groupId>
    <artifactId>feign-api</artifactId>
    <version>1.0</version>
</dependency>
```

**ä¿®æ”¹æ³¨è§£**

å½“å®šä¹‰çš„ FeignClient ä¸åœ¨ SpringBootApplication çš„æ‰«æåŒ…èŒƒå›´ä¸‹æ—¶ï¼Œè¿™äº› FeignClient å°±ä¸èƒ½ä½¿ç”¨ã€‚

ä¿®æ”¹ order-service å¯åŠ¨ç±»ä¸Šçš„ `@EnableFeignClients` æ³¨è§£

```java
@EnableFeignClients(basePackages = "com.xn2001.feign.clients")
```

# Gatewayç½‘å…³

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/07-cloud-gateway
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/07-cloud-gateway

Spring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰å“åº”å¼ç¼–ç¨‹å’Œäº‹ä»¶æµæŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚

Gateway ç½‘å…³æ˜¯æˆ‘ä»¬æœåŠ¡çš„å®ˆé—¨ç¥ï¼Œ**æ‰€æœ‰å¾®æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚**

ç½‘å…³çš„**æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§**ï¼š

- è¯·æ±‚è·¯ç”±
- æƒé™æ§åˆ¶
- é™æµ

![](https://cdn.xn2001.com/img/2021/20210901092857.png)



**æƒé™æ§åˆ¶**ï¼šç½‘å…³ä½œä¸ºå¾®æœåŠ¡å…¥å£ï¼Œéœ€è¦æ ¡éªŒç”¨æˆ·æ˜¯æ˜¯å¦æœ‰è¯·æ±‚èµ„æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œæ‹¦æˆªã€‚

**è·¯ç”±å’Œè´Ÿè½½å‡è¡¡**ï¼šä¸€åˆ‡è¯·æ±‚éƒ½å¿…é¡»å…ˆç»è¿‡ gatewayï¼Œä½†ç½‘å…³ä¸å¤„ç†ä¸šåŠ¡ï¼Œè€Œæ˜¯æ ¹æ®æŸç§è§„åˆ™ï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°æŸä¸ªå¾®æœåŠ¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšè·¯ç”±ã€‚å½“ç„¶è·¯ç”±çš„ç›®æ ‡æœåŠ¡æœ‰å¤šä¸ªæ—¶ï¼Œè¿˜éœ€è¦åšè´Ÿè½½å‡è¡¡ã€‚

**é™æµ**ï¼šå½“è¯·æ±‚æµé‡è¿‡é«˜æ—¶ï¼Œåœ¨ç½‘å…³ä¸­æŒ‰ç…§ä¸‹æµçš„å¾®æœåŠ¡èƒ½å¤Ÿæ¥å—çš„é€Ÿåº¦æ¥æ”¾è¡Œè¯·æ±‚ï¼Œé¿å…æœåŠ¡å‹åŠ›è¿‡å¤§ã€‚

åœ¨ SpringCloud ä¸­ç½‘å…³çš„å®ç°åŒ…æ‹¬ä¸¤ç§ï¼š

- gateway
- zuul

Zuul æ˜¯åŸºäº Servlet å®ç°ï¼Œå±äºé˜»å¡å¼ç¼–ç¨‹ã€‚è€Œ Spring Cloud Gateway åˆ™æ˜¯åŸºäº Spring5 ä¸­æä¾›çš„WebFluxï¼Œå±äºå“åº”å¼ç¼–ç¨‹çš„å®ç°ï¼Œå…·å¤‡æ›´å¥½çš„æ€§èƒ½ã€‚

## å…¥é—¨ä½¿ç”¨

1. åˆ›å»º SpringBoot å·¥ç¨‹ gatewayï¼Œå¼•å…¥ç½‘å…³ä¾èµ–
2. ç¼–å†™å¯åŠ¨ç±»
3. ç¼–å†™åŸºç¡€é…ç½®å’Œè·¯ç”±è§„åˆ™
4. å¯åŠ¨ç½‘å…³æœåŠ¡è¿›è¡Œæµ‹è¯•

```xml
<!--ç½‘å…³-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
<!--nacosæœåŠ¡å‘ç°ä¾èµ–-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

åˆ›å»º application.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
server:
  port: 10010 # ç½‘å…³ç«¯å£
spring:
  application:
    name: gateway # æœåŠ¡åç§°
  cloud:
    nacos:
      server-addr: localhost:8848 # nacosåœ°å€
    gateway:
      routes: # ç½‘å…³è·¯ç”±é…ç½®
        - id: user-service # è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯
          # uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€
          uri: lb://userservice # è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°
          predicates: # è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶
            - Path=/user/** # è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚
```

æˆ‘ä»¬å°†ç¬¦åˆ`Path` è§„åˆ™çš„ä¸€åˆ‡è¯·æ±‚ï¼Œéƒ½ä»£ç†åˆ° `uri`å‚æ•°æŒ‡å®šçš„åœ°å€ã€‚

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°† `/user/**` å¼€å¤´çš„è¯·æ±‚ï¼Œä»£ç†åˆ° `lb://userservice`ï¼Œå…¶ä¸­ lb æ˜¯è´Ÿè½½å‡è¡¡(LoadBalance)ï¼Œæ ¹æ®æœåŠ¡åæ‹‰å–æœåŠ¡åˆ—è¡¨ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚

é‡å¯ç½‘å…³ï¼Œè®¿é—® [http://localhost:10010/user/1](http://localhost:10010/user/1 ) æ—¶ï¼Œç¬¦åˆ `/user/**` è§„åˆ™ï¼Œè¯·æ±‚è½¬å‘åˆ° uriï¼š[http://userservice/user/1](http://userservice/user/1)

![](https://cdn.xn2001.com/img/2021/202108220125749.png)

å¤šä¸ª predicates çš„è¯ï¼Œè¦åŒæ—¶æ»¡è¶³è§„åˆ™ï¼Œä¸‹æ–‡æœ‰ä¾‹å­ã€‚

## æµç¨‹å›¾

![](https://cdn.xn2001.com/img/2021/202108220127419.png)

è·¯ç”±é…ç½®åŒ…æ‹¬ï¼š

1. è·¯ç”±idï¼šè·¯ç”±çš„å”¯ä¸€æ ‡ç¤º
2. è·¯ç”±ç›®æ ‡ï¼ˆuriï¼‰ï¼šè·¯ç”±çš„ç›®æ ‡åœ°å€ï¼Œhttpä»£è¡¨å›ºå®šåœ°å€ï¼Œlbä»£è¡¨æ ¹æ®æœåŠ¡åè´Ÿè½½å‡è¡¡
3. è·¯ç”±æ–­è¨€ï¼ˆpredicatesï¼‰ï¼šåˆ¤æ–­è·¯ç”±çš„è§„åˆ™
4. è·¯ç”±è¿‡æ»¤å™¨ï¼ˆfiltersï¼‰ï¼šå¯¹è¯·æ±‚æˆ–å“åº”åšå¤„ç†

## æ–­è¨€å·¥å‚

æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å†™çš„æ–­è¨€è§„åˆ™åªæ˜¯å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä¼šè¢« Predicate Factory è¯»å–å¹¶å¤„ç†ï¼Œè½¬å˜ä¸ºè·¯ç”±åˆ¤æ–­çš„æ¡ä»¶ã€‚

ä¾‹å¦‚ `Path=/user/**` æ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œè¿™ä¸ªè§„åˆ™æ˜¯ç”±

`org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory` ç±»æ¥å¤„ç†çš„ï¼Œåƒè¿™æ ·çš„æ–­è¨€å·¥å‚åœ¨ Spring Cloud Gateway è¿˜æœ‰åå‡ ä¸ª

| åç§°       | è¯´æ˜                           | ç¤ºä¾‹                                                         |
| ---------- | ------------------------------ | ------------------------------------------------------------ |
| After      | æ˜¯æŸä¸ªæ—¶é—´ç‚¹åçš„è¯·æ±‚           | -  After=2037-01-20T17:42:47.789-07:00[America/Denver]       |
| Before     | æ˜¯æŸä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚         | -  Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]       |
| Between    | æ˜¯æŸä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚       | -  Between=2037-01-20T17:42:47.789-07:00[America/Denver],  2037-01-21T17:42:47.789-07:00[America/Denver] |
| Cookie     | è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›cookie         | - Cookie=chocolate, ch.p                                     |
| Header     | è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›header         | - Header=X-Request-Id, \d+                                   |
| Host       | è¯·æ±‚å¿…é¡»æ˜¯è®¿é—®æŸä¸ªhostï¼ˆåŸŸåï¼‰ | -  Host=`**.somehost.org`, `**.anotherhost.org`              |
| Method     | è¯·æ±‚æ–¹å¼å¿…é¡»æ˜¯æŒ‡å®šæ–¹å¼         | - Method=GET,POST                                            |
| Path       | è¯·æ±‚è·¯å¾„å¿…é¡»ç¬¦åˆæŒ‡å®šè§„åˆ™       | - Path=/red/{segment},/blue/**                               |
| Query      | è¯·æ±‚å‚æ•°å¿…é¡»åŒ…å«æŒ‡å®šå‚æ•°       | - Query=name, Jackæˆ–è€…-  Query=name                          |
| RemoteAddr | è¯·æ±‚è€…çš„ipå¿…é¡»æ˜¯æŒ‡å®šèŒƒå›´       | - RemoteAddr=192.168.1.1/24                                  |
| Weight     | æƒé‡å¤„ç†                       |                                                              |

> å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories

ä¸€èˆ¬çš„ï¼Œæˆ‘ä»¬åªéœ€è¦æŒæ¡ Pathï¼ŒåŠ ä¸Šå®˜æ–¹æ–‡æ¡£çš„ä¾‹å­ï¼Œå°±å¯ä»¥åº”å¯¹å„ç§å·¥ä½œåœºæ™¯äº†ã€‚

```yaml
predicates:
  - Path=/order/**
  - After=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]
```

åƒè¿™æ ·çš„è§„åˆ™ï¼Œç°åœ¨æ˜¯ 2021å¹´8æœˆ22æ—¥01:32:42ï¼Œå¾ˆæ˜æ˜¾ After æ¡ä»¶ä¸æ»¡è¶³ï¼Œå¯ä»¥ä¸ä¼šè½¬å‘ï¼Œè·¯ç”±ä¸èµ·ä½œç”¨ã€‚

## è¿‡æ»¤å™¨å·¥å‚

GatewayFilter æ˜¯ç½‘å…³ä¸­æä¾›çš„ä¸€ç§è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡è¿”å›çš„å“åº”åšå¤„ç†ã€‚

![](https://cdn.xn2001.com/img/2021/202108220133487.png)

Springæä¾›äº†31ç§ä¸åŒçš„è·¯ç”±è¿‡æ»¤å™¨å·¥å‚ã€‚

> å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories

| **åç§°**             | **è¯´æ˜**                     |
| -------------------- | ---------------------------- |
| AddRequestHeader     | ç»™å½“å‰è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´     |
| RemoveRequestHeader  | ç§»é™¤è¯·æ±‚ä¸­çš„ä¸€ä¸ªè¯·æ±‚å¤´       |
| AddResponseHeader    | ç»™å“åº”ç»“æœä¸­æ·»åŠ ä¸€ä¸ªå“åº”å¤´   |
| RemoveResponseHeader | ä»å“åº”ç»“æœä¸­ç§»é™¤æœ‰ä¸€ä¸ªå“åº”å¤´ |
| RequestRateLimiter   | é™åˆ¶è¯·æ±‚çš„æµé‡               |

ä¸‹é¢æˆ‘ä»¬ä»¥ AddRequestHeader ä¸ºä¾‹ï¼š

![](https://cdn.xn2001.com/img/2021/202108220139913.png)

**éœ€æ±‚**ï¼šç»™æ‰€æœ‰è¿›å…¥ userservice çš„è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´ï¼š`sign=xn2001.com is eternal`

åªéœ€è¦ä¿®æ”¹ gateway æœåŠ¡çš„ application.ymlæ–‡ä»¶ï¼Œæ·»åŠ è·¯ç”±è¿‡æ»¤å³å¯ã€‚

```yaml
spring:
  cloud:
    gateway:
      routes: # ç½‘å…³è·¯ç”±é…ç½®
        - id: user-service # è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯
          # uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€
          uri: lb://userservice # è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°
          predicates: # è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶
            - Path=/user/** # è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚
          filters:
            - AddRequestHeader=sign, xn2001.com is eternal # æ·»åŠ è¯·æ±‚å¤´
```

å¦‚ä½•éªŒè¯ï¼Œæˆ‘ä»¬ä¿®æ”¹ userservice ä¸­çš„ä¸€ä¸ªæ¥å£

```java
@GetMapping("/{id}")
public User queryById(@PathVariable("id") Long id, @RequestHeader(value = "sign", required = false) String sign) {
    log.warn(sign);
    return userService.queryById(id);
}
```

é‡å¯ä¸¤ä¸ªæœåŠ¡ï¼Œè®¿é—®ï¼š[http://localhost:10010/user/1](http://localhost:10010/user/1)

å¯ä»¥çœ‹åˆ°æ§åˆ¶å°æ‰“å°å‡ºäº†è¿™ä¸ªè¯·æ±‚å¤´

![](https://cdn.xn2001.com/img/2021/202108220145565.png)

å½“ç„¶ï¼ŒGateway ä¹Ÿæ˜¯æœ‰**å…¨å±€è¿‡æ»¤å™¨**çš„ï¼Œå¦‚æœè¦**å¯¹æ‰€æœ‰çš„è·¯ç”±éƒ½ç”Ÿæ•ˆ**ï¼Œåˆ™å¯ä»¥å°†è¿‡æ»¤å™¨å·¥å‚å†™åˆ° default-filters ä¸‹ï¼š

```yaml
spring:
  cloud:
    gateway:
      default-filters:
        - AddRequestHeader=sign, xn2001.com is eternal # æ·»åŠ è¯·æ±‚å¤´
```

## å…¨å±€è¿‡æ»¤å™¨

ä¸Šé¢ä»‹ç»çš„è¿‡æ»¤å™¨å·¥å‚ï¼Œç½‘å…³æä¾›äº† 31 ç§ï¼Œä½†æ¯ä¸€ç§è¿‡æ»¤å™¨çš„ä½œç”¨éƒ½æ˜¯å›ºå®šçš„ã€‚**å¦‚æœæˆ‘ä»¬å¸Œæœ›æ‹¦æˆªè¯·æ±‚ï¼Œåšè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘åˆ™æ²¡åŠæ³•å®ç°**ã€‚

å…¨å±€è¿‡æ»¤å™¨çš„ä½œç”¨ä¹Ÿæ˜¯å¤„ç†ä¸€åˆ‡è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡å“åº”ï¼Œ**ä¸ GatewayFilter çš„ä½œç”¨ä¸€æ ·**ã€‚åŒºåˆ«åœ¨äº GlobalFilter çš„é€»è¾‘å¯ä»¥**å†™ä»£ç æ¥è‡ªå®šä¹‰è§„åˆ™**ï¼›è€Œ GatewayFilter é€šè¿‡é…ç½®å®šä¹‰ï¼Œå¤„ç†é€»è¾‘æ˜¯å›ºå®šçš„ã€‚

**éœ€æ±‚**ï¼šå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ï¼Œæ‹¦æˆªè¯·æ±‚ï¼Œåˆ¤æ–­è¯·æ±‚çš„å‚æ•°æ˜¯å¦æ»¡è¶³ä¸‹é¢æ¡ä»¶

- å‚æ•°ä¸­æ˜¯å¦æœ‰ authorization

- authorization å‚æ•°å€¼æ˜¯å¦ä¸º admin

å¦‚æœåŒæ—¶æ»¡è¶³åˆ™æ”¾è¡Œï¼Œå¦åˆ™æ‹¦æˆªã€‚

```java
@Component
public class AuthorizeFilter implements GlobalFilter, Ordered {

    // æµ‹è¯•ï¼šhttp://localhost:10010/order/101?authorization=admin
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // è·å–ç¬¬ä¸€ä¸ª authorization å‚æ•°
        String authorization = exchange.getRequest().getQueryParams().getFirst("authorization");
        if ("admin".equals(authorization)){
            // æ”¾è¡Œ
            return chain.filter(exchange);
        }
        // è®¾ç½®æ‹¦æˆªçŠ¶æ€ç ä¿¡æ¯
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        // è®¾ç½®æ‹¦æˆª
        return exchange.getResponse().setComplete();
    }

    // è®¾ç½®è¿‡æ»¤å™¨ä¼˜å…ˆçº§ï¼Œå€¼è¶Šä½ä¼˜å…ˆçº§è¶Šé«˜
    // ä¹Ÿå¯ä»¥ä½¿ç”¨ @Order æ³¨è§£
    @Override
    public int getOrder() {
        return 0;
    }
}
```

## è¿‡æ»¤å™¨é¡ºåº

è¯·æ±‚è¿›å…¥ç½‘å…³ä¼šç¢°åˆ°ä¸‰ç±»è¿‡æ»¤å™¨ï¼šDefaultFilterã€å½“å‰è·¯ç”±çš„è¿‡æ»¤å™¨ã€GlobalFilterï¼›

è¯·æ±‚è·¯ç”±åï¼Œä¼šå°†ä¸‰è€…åˆå¹¶åˆ°ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼ˆé›†åˆï¼‰ä¸­ï¼Œæ’åºåä¾æ¬¡æ‰§è¡Œæ¯ä¸ªè¿‡æ»¤å™¨.

![](https://cdn.xn2001.com/img/2021/202108230002747.png)



æ’åºçš„è§„åˆ™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

- æ¯ä¸€ä¸ªè¿‡æ»¤å™¨éƒ½å¿…é¡»æŒ‡å®šä¸€ä¸ª int ç±»å‹çš„ order å€¼ï¼Œ**order å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ‰§è¡Œé¡ºåºè¶Šé å‰**ã€‚
- GlobalFilter é€šè¿‡å®ç° Ordered æ¥å£ï¼Œæˆ–è€…ä½¿ç”¨ @Order æ³¨è§£æ¥æŒ‡å®š order å€¼ï¼Œç”±æˆ‘ä»¬è‡ªå·±æŒ‡å®šã€‚
- è·¯ç”±è¿‡æ»¤å™¨å’Œ defaultFilter çš„ order ç”± Spring æŒ‡å®šï¼Œé»˜è®¤æ˜¯æŒ‰ç…§å£°æ˜é¡ºåºä»1é€’å¢ã€‚
- å½“è¿‡æ»¤å™¨çš„ order å€¼ä¸€æ ·æ—¶ï¼Œ**ä¼šæŒ‰ç…§ defaultFilter > è·¯ç”±è¿‡æ»¤å™¨ > GlobalFilter çš„é¡ºåºæ‰§è¡Œã€‚**

## è·¨åŸŸé—®é¢˜

ä¸äº†è§£è·¨åŸŸé—®é¢˜çš„åŒå­¦å¯ä»¥ç™¾åº¦äº†è§£ä¸€ä¸‹ï¼›åœ¨ Gateway ç½‘å…³ä¸­è§£å†³è·¨åŸŸé—®é¢˜è¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚

```yaml
spring:
  cloud:
    gateway:
      globalcors: # å…¨å±€çš„è·¨åŸŸå¤„ç†
        add-to-simple-url-handler-mapping: true # è§£å†³optionsè¯·æ±‚è¢«æ‹¦æˆªé—®é¢˜
        corsConfigurations:
          '[/**]':
            allowedOrigins: # å…è®¸å“ªäº›ç½‘ç«™çš„è·¨åŸŸè¯·æ±‚ allowedOrigins: â€œ*â€ å…è®¸æ‰€æœ‰ç½‘ç«™
              - "http://localhost:8090"
            allowedMethods: # å…è®¸çš„è·¨åŸŸajaxçš„è¯·æ±‚æ–¹å¼
              - "GET"
              - "POST"
              - "DELETE"
              - "PUT"
              - "OPTIONS"
            allowedHeaders: "*" # å…è®¸åœ¨è¯·æ±‚ä¸­æºå¸¦çš„å¤´ä¿¡æ¯
            allowCredentials: true # æ˜¯å¦å…è®¸æºå¸¦cookie
            maxAge: 360000 # è¿™æ¬¡è·¨åŸŸæ£€æµ‹çš„æœ‰æ•ˆæœŸ
```

# RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/08-rabbitmq-demo
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/08-rabbitmq-demo

## åŒæ­¥å¼‚æ­¥é€šè®¯

**å¾®æœåŠ¡é—´é€šè®¯æœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼**

åŒæ­¥é€šè®¯ï¼šå°±åƒæ‰“ç”µè¯ï¼Œéœ€è¦å®æ—¶å“åº”ã€‚

å¼‚æ­¥é€šè®¯ï¼šå°±åƒå‘é‚®ä»¶ï¼Œä¸éœ€è¦é©¬ä¸Šå›å¤ã€‚

![](https://cdn.xn2001.com/img/2021/20210904133345.png)

ä¸¤ç§æ–¹å¼å„æœ‰ä¼˜åŠ£ï¼Œæ‰“ç”µè¯å¯ä»¥ç«‹å³å¾—åˆ°å“åº”ï¼Œä½†æ˜¯ä½ å´ä¸èƒ½è·Ÿå¤šä¸ªäººåŒæ—¶é€šè¯ã€‚å‘é€é‚®ä»¶å¯ä»¥åŒæ—¶ä¸å¤šä¸ªäººæ”¶å‘é‚®ä»¶ï¼Œä½†æ˜¯å¾€å¾€å“åº”ä¼šæœ‰å»¶è¿Ÿã€‚

æˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„ **Feign è°ƒç”¨**å°±å±äº**åŒæ­¥æ–¹å¼**ï¼Œè™½ç„¶è°ƒç”¨å¯ä»¥å®æ—¶å¾—åˆ°ç»“æœï¼Œä½†å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š

![](https://cdn.xn2001.com/img/2021/20210904133517.png)

**åŒæ­¥è°ƒç”¨çš„ä¼˜ç‚¹**ï¼š

- æ—¶æ•ˆæ€§è¾ƒå¼ºï¼Œå¯ä»¥ç«‹å³å¾—åˆ°ç»“æœ

**åŒæ­¥è°ƒç”¨çš„ç¼ºç‚¹**ï¼š

- è€¦åˆåº¦é«˜
- æ€§èƒ½å’Œååèƒ½åŠ›ä¸‹é™
- æœ‰é¢å¤–çš„èµ„æºæ¶ˆè€—
- æœ‰çº§è”å¤±è´¥é—®é¢˜

å¼‚æ­¥è°ƒç”¨åˆ™å¯ä»¥é¿å…ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬ä»¥è´­ä¹°å•†å“ä¸ºä¾‹ï¼Œç”¨æˆ·æ”¯ä»˜åéœ€è¦è°ƒç”¨è®¢å•æœåŠ¡å®Œæˆè®¢å•çŠ¶æ€ä¿®æ”¹ï¼Œè°ƒç”¨ç‰©æµæœåŠ¡ï¼Œä»ä»“åº“åˆ†é…å“åº”çš„åº“å­˜å¹¶å‡†å¤‡å‘è´§ã€‚åœ¨äº‹ä»¶æ¨¡å¼ä¸­ï¼Œæ”¯ä»˜æœåŠ¡æ˜¯äº‹ä»¶å‘å¸ƒè€…ï¼ˆpublisherï¼‰ï¼Œåœ¨æ”¯ä»˜å®Œæˆååªéœ€è¦å‘å¸ƒä¸€ä¸ªæ”¯ä»˜æˆåŠŸçš„äº‹ä»¶ï¼ˆeventï¼‰ï¼Œäº‹ä»¶ä¸­å¸¦ä¸Šè®¢å•idã€‚è®¢å•æœåŠ¡å’Œç‰©æµæœåŠ¡æ˜¯äº‹ä»¶è®¢é˜…è€…ï¼ˆConsumerï¼‰ï¼Œè®¢é˜…æ”¯ä»˜æˆåŠŸçš„äº‹ä»¶ï¼Œç›‘å¬åˆ°äº‹ä»¶åå®Œæˆè‡ªå·±ä¸šåŠ¡å³å¯ã€‚

ä¸ºäº†è§£é™¤äº‹ä»¶å‘å¸ƒè€…ä¸è®¢é˜…è€…ä¹‹é—´çš„è€¦åˆï¼Œä¸¤è€…å¹¶ä¸æ˜¯ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªä¸­é—´äººï¼ˆBrokerï¼‰ã€‚å‘å¸ƒè€…å‘å¸ƒäº‹ä»¶åˆ°Brokerï¼Œä¸å…³å¿ƒè°æ¥è®¢é˜…äº‹ä»¶ã€‚è®¢é˜…è€…ä»Brokerè®¢é˜…äº‹ä»¶ï¼Œä¸å…³å¿ƒè°å‘æ¥çš„æ¶ˆæ¯ã€‚

![](https://cdn.xn2001.com/img/2021/20210904144714.png)

Broker æ˜¯ä¸€ä¸ªåƒæ•°æ®æ€»çº¿ä¸€æ ·çš„ä¸œè¥¿ï¼Œæ‰€æœ‰çš„æœåŠ¡è¦æ¥æ”¶æ•°æ®å’Œå‘é€æ•°æ®éƒ½å‘åˆ°è¿™ä¸ªæ€»çº¿ä¸Šï¼Œè¿™ä¸ªæ€»çº¿å°±åƒåè®®ä¸€æ ·ï¼Œè®©æœåŠ¡é—´çš„é€šè®¯å˜å¾—æ ‡å‡†å’Œå¯æ§ã€‚

![](https://cdn.xn2001.com/img/2021/20210904145001.png)

**å¼‚æ­¥è°ƒç”¨å¥½å¤„**ï¼š

- ååé‡æå‡ï¼šæ— éœ€ç­‰å¾…è®¢é˜…è€…å¤„ç†å®Œæˆï¼Œå“åº”æ›´å¿«é€Ÿ

- æ•…éšœéš”ç¦»ï¼šæœåŠ¡æ²¡æœ‰ç›´æ¥è°ƒç”¨ï¼Œä¸å­˜åœ¨çº§è”å¤±è´¥é—®é¢˜
- è°ƒç”¨é—´æ²¡æœ‰é˜»å¡ï¼Œä¸ä¼šé€ æˆæ— æ•ˆçš„èµ„æºå ç”¨
- è€¦åˆåº¦æä½ï¼Œæ¯ä¸ªæœåŠ¡éƒ½å¯ä»¥çµæ´»æ’æ‹”ï¼Œå¯æ›¿æ¢
- æµé‡å‰Šå³°ï¼šä¸ç®¡å‘å¸ƒäº‹ä»¶çš„æµé‡æ³¢åŠ¨å¤šå¤§ï¼Œéƒ½ç”± Broker æ¥æ”¶ï¼Œè®¢é˜…è€…å¯ä»¥æŒ‰ç…§è‡ªå·±çš„é€Ÿåº¦å»å¤„ç†äº‹ä»¶

**å¼‚æ­¥è°ƒç”¨ç¼ºç‚¹**ï¼š

- æ¶æ„å¤æ‚äº†ï¼Œä¸šåŠ¡æ²¡æœ‰æ˜æ˜¾çš„æµç¨‹çº¿ï¼Œä¸å¥½ç®¡ç†
- éœ€è¦ä¾èµ–äº Broker çš„å¯é ã€å®‰å…¨ã€æ€§èƒ½

## MQæ¶ˆæ¯é˜Ÿåˆ—

MQï¼Œä¸­æ–‡æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessageQueueï¼‰ï¼Œå­—é¢æ¥çœ‹å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„ä¸­çš„ Broker

æ¯”è¾ƒå¸¸è§çš„ MQ å®ç°ï¼š

- ActiveMQ
- RabbitMQ
- RocketMQ
- Kafka

å‡ ç§å¸¸è§MQçš„å¯¹æ¯”ï¼š

|            | **RabbitMQ**            | **ActiveMQ**                      | **RocketMQ** | **Kafka**      |
| ---------- | ----------------------- | --------------------------------- | ------------ | -------------- |
| å…¬å¸/ç¤¾åŒº  | Rabbit                  | Apache                            | é˜¿é‡Œ         | Apache         |
| å¼€å‘è¯­è¨€   | Erlang                  | Java                              | Java         | Scala&amp;Java |
| åè®®æ”¯æŒ   | AMQPã€XMPPã€SMTPã€STOMP | OpenWireã€STOMPã€RESTã€XMPPã€AMQP | è‡ªå®šä¹‰åè®®   | è‡ªå®šä¹‰åè®®     |
| å¯ç”¨æ€§     | é«˜                      | ä¸€èˆ¬                              | é«˜           | é«˜             |
| å•æœºååé‡ | ä¸€èˆ¬                    | å·®                                | é«˜           | éå¸¸é«˜         |
| æ¶ˆæ¯å»¶è¿Ÿ   | å¾®ç§’çº§                  | æ¯«ç§’çº§                            | æ¯«ç§’çº§       | æ¯«ç§’ä»¥å†…       |
| æ¶ˆæ¯å¯é æ€§ | é«˜                      | ä¸€èˆ¬                              | é«˜           | ä¸€èˆ¬           |

ä»¥ RabbitMQ ä¸ºä¾‹ï¼Œæˆ‘ä»¬åœ¨ Centos7 è™šæ‹Ÿæœºä¸­ä½¿ç”¨ Docker æ¥å®‰è£…

åœ¨çº¿æ‹‰å–é•œåƒ

``` sh
docker pull rabbitmq:3-management
```

æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥è¿è¡ŒMQå®¹å™¨

```sh
docker run \
 -e RABBITMQ_DEFAULT_USER=admin \
 -e RABBITMQ_DEFAULT_PASS=123456 \
 --name mq \
 --hostname mq1 \
 -p 15672:15672 \
 -p 5672:5672 \
 -d \
 rabbitmq:3-management
```

å¯åŠ¨æˆåŠŸåè®¿é—®åœ°å€ï¼šhttp://192.168.211.128:15672

**RabbitMQ ä¸­çš„ä¸€äº›è§’è‰²**

- publisherï¼šç”Ÿäº§è€…
- consumerï¼šæ¶ˆè´¹è€…
- exchangeï¼šäº¤æ¢æœºï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±
- queueï¼šé˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯
- virtualHostï¼šè™šæ‹Ÿä¸»æœºï¼Œ**éš”ç¦»ä¸åŒç§Ÿæˆ·**çš„ exchangeã€queueã€æ¶ˆæ¯çš„éš”ç¦»

**MQ çš„åŸºæœ¬ç»“æ„**

![](https://cdn.xn2001.com/img/2021/20210904172912.png)

## å…¥é—¨æ¡ˆä¾‹

RabbitMQ å®˜æ–¹æä¾›äº† 5 ä¸ªä¸åŒçš„ Demo ç¤ºä¾‹ï¼Œå¯¹åº”äº†ä¸åŒçš„æ¶ˆæ¯æ¨¡å‹ã€‚

![](https://cdn.xn2001.com/img/2021/20210904173739.png)

Hello World æ¨¡å‹

 ![](https://cdn.xn2001.com/img/2021/20210904200637.png)

å®˜æ–¹çš„ HelloWorld æ˜¯åŸºäºæœ€åŸºç¡€çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹æ¥å®ç°çš„ï¼ŒåªåŒ…æ‹¬ä¸‰ä¸ªè§’è‰²ï¼š

- publisherï¼šæ¶ˆæ¯å‘å¸ƒè€…ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—queue
- queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè´Ÿè´£æ¥å—å¹¶ç¼“å­˜æ¶ˆæ¯
- consumerï¼šè®¢é˜…é˜Ÿåˆ—ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯

### publisherå®ç°

- å»ºç«‹è¿æ¥
- åˆ›å»º channel
- å£°æ˜é˜Ÿåˆ—
- å‘é€æ¶ˆæ¯
- å…³é—­è¿æ¥å’Œ channel

```java
public class PublisherTest {
    @Test
    public void testSendMessage() throws IOException, TimeoutException {
        // 1.å»ºç«‹è¿æ¥
        ConnectionFactory factory = new ConnectionFactory();
        // 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç 
        factory.setHost("192.168.211.128");
        factory.setPort(5672);
        factory.setVirtualHost("/");
        factory.setUsername("admin");
        factory.setPassword("123456");
        // 1.2.å»ºç«‹è¿æ¥
        Connection connection = factory.newConnection();
        // 2.åˆ›å»ºé€šé“Channel
        Channel channel = connection.createChannel();
        // 3.åˆ›å»ºé˜Ÿåˆ—
        String queueName = "simple.queue";
        channel.queueDeclare(queueName, false, false, false, null);
        // 4.å‘é€æ¶ˆæ¯
        String message = "Hello RabbitMQï¼";
        channel.basicPublish("", queueName, null, message.getBytes());
        System.out.println("å‘é€æ¶ˆæ¯æˆåŠŸï¼š[" + message + "]");
        // 5.å…³é—­é€šé“å’Œè¿æ¥
        channel.close();
        connection.close();
    }
}
```

### consumerå®ç°

- å»ºç«‹è¿æ¥
- åˆ›å»º channel
- å£°æ˜é˜Ÿåˆ—
- è®¢é˜…æ¶ˆæ¯

```java
public class ConsumerTest {
    public static void main(String[] args) throws IOException, TimeoutException {
        // 1.å»ºç«‹è¿æ¥
        ConnectionFactory factory = new ConnectionFactory();
        // 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç 
        factory.setHost("192.168.211.128");
        factory.setPort(5672);
        factory.setVirtualHost("/");
        factory.setUsername("admin");
        factory.setPassword("123456");
        // 1.2.å»ºç«‹è¿æ¥
        Connection connection = factory.newConnection();
        // 2.åˆ›å»ºé€šé“Channel
        Channel channel = connection.createChannel();
        // 3.åˆ›å»ºé˜Ÿåˆ—
        String queueName = "simple.queue";
        channel.queueDeclare(queueName, false, false, false, null);
        // 4.è®¢é˜…æ¶ˆæ¯
        channel.basicConsume(queueName, true, new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope,
                                       AMQP.BasicProperties properties, byte[] body) {
                // 5.å¤„ç†æ¶ˆæ¯
                String message = new String(body);
                System.out.println("æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š[" + message + "]");
            }
        });
        System.out.println("ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ä¸­");
    }
}
```

## SpringAMQP

SpringAMQP æ˜¯åŸºäº RabbitMQ å°è£…çš„ä¸€å¥—æ¨¡æ¿ï¼Œå¹¶ä¸”è¿˜åˆ©ç”¨ SpringBoot å¯¹å…¶å®ç°äº†è‡ªåŠ¨è£…é…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚

SpringAMQP çš„å®˜æ–¹åœ°å€ï¼šhttps://spring.io/projects/spring-amqp

![](https://cdn.xn2001.com/img/2021/20210904202046.png)

![](https://cdn.xn2001.com/img/2021/20210904202056.png)

SpringAMQP æä¾›äº†ä¸‰ä¸ªåŠŸèƒ½ï¼š

- è‡ªåŠ¨å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºåŠå…¶ç»‘å®šå…³ç³»
- åŸºäºæ³¨è§£çš„ç›‘å¬å™¨æ¨¡å¼ï¼Œå¼‚æ­¥æ¥æ”¶æ¶ˆæ¯
- å°è£…äº† RabbitTemplate å·¥å…·ï¼Œç”¨äºå‘é€æ¶ˆæ¯ 

```xml
<!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

###  BasicQueue

é¦–å…ˆé…ç½® MQåœ°å€ï¼Œåœ¨ publisherã€consumer æœåŠ¡ä¸­çš„ application.yml ä¸­æ·»åŠ é…ç½®

```yml
spring:
  rabbitmq:
    host: 192.168.150.101 # ä¸»æœºå
    port: 5672 # ç«¯å£
    virtual-host: / # è™šæ‹Ÿä¸»æœº
    username: admin # ç”¨æˆ·å
    password: 123456 # å¯†ç 
```

åœ¨ consumer æœåŠ¡ä¸­æ·»åŠ ç›‘å¬é˜Ÿåˆ—

```java
@Component
public class RabbitMQListener {
    @RabbitListener(queues = "simple.queue")
    public void listenSimpleQueueMessage(String msg) throws InterruptedException {
        System.out.println("æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€" + msg + "ã€‘");
    }
}
```

åœ¨ publisher æœåŠ¡ä¸­æ·»åŠ å‘é€æ¶ˆæ¯çš„æµ‹è¯•ç±»

```java
@RunWith(SpringRunner.class)
@SpringBootTest
public class SpringAmqpTest {
    @Autowired
    private RabbitTemplate rabbitTemplate;
    @Test
    public void testSimpleQueue() {
        // é˜Ÿåˆ—åç§°
        String queueName = "simple.queue";
        // æ¶ˆæ¯
        String message = "ä½ å¥½å•Šï¼Œä¹å¿ƒæ¹–ï¼";
        // å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(queueName, message);
    }
}
```

### WorkQueue

Work queuesï¼Œä¹Ÿè¢«ç§°ä¸ºï¼ˆTask queuesï¼‰ï¼Œä»»åŠ¡æ¨¡å‹ã€‚ç®€å•æ¥è¯´å°±æ˜¯**è®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯**ã€‚

![](https://cdn.xn2001.com/img/2021/20210904211238.png)

å½“æ¶ˆæ¯å¤„ç†æ¯”è¾ƒè€—æ—¶çš„æ—¶å€™ï¼Œå¯èƒ½ç”Ÿäº§æ¶ˆæ¯çš„é€Ÿåº¦ä¼šè¿œè¿œå¤§äºæ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿåº¦ã€‚é•¿æ­¤ä»¥å¾€ï¼Œæ¶ˆæ¯å°±ä¼šå †ç§¯è¶Šæ¥è¶Šå¤šï¼Œæ— æ³•åŠæ—¶å¤„ç†ã€‚

æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨ work æ¨¡å‹ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±åŒå¤„ç†æ¶ˆæ¯å¤„ç†ï¼Œé€Ÿåº¦å°±èƒ½å¤§å¤§æé«˜äº†ã€‚

æˆ‘ä»¬å¾ªç¯å‘é€ï¼Œæ¨¡æ‹Ÿå¤§é‡æ¶ˆæ¯å †ç§¯ç°è±¡ï¼Œåœ¨ publisher æœåŠ¡ä¸­çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼š

```java
/**
 * workQueue
 * å‘é˜Ÿåˆ—ä¸­ä¸åœå‘é€æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿæ¶ˆæ¯å †ç§¯ã€‚
 */
@Test
public void testWorkQueue() throws InterruptedException {
    // é˜Ÿåˆ—åç§°
    String queueName = "simple.queue";
    // æ¶ˆæ¯
    String message = "hello, message_";
    for (int i = 0; i < 50; i++) {
        // å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(queueName, message + i);
        Thread.sleep(20);
    }
}
```

**æ¶ˆæ¯æ¥æ”¶**

è¦æ¨¡æ‹Ÿå¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæˆ‘ä»¬åœ¨ consumer æœåŠ¡çš„ RabbitMQListener ä¸­æ·»åŠ 2ä¸ªæ–°çš„æ–¹æ³•ï¼š

```java
@RabbitListener(queues = "simple.queue")
public void listenWorkQueue1(String msg) throws InterruptedException {
    System.out.println("æ¶ˆè´¹è€…1æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
    Thread.sleep(20);
}

@RabbitListener(queues = "simple.queue")
public void listenWorkQueue2(String msg) throws InterruptedException {
    System.err.println("æ¶ˆè´¹è€…2........æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
    Thread.sleep(200);
}
```

å¯åŠ¨ ConsumerApplication åï¼Œåœ¨æ‰§è¡Œ publisher æœåŠ¡ä¸­åˆšåˆšç¼–å†™çš„å‘é€æµ‹è¯•æ–¹æ³• testWorkQueue

å¯ä»¥çœ‹åˆ°æ¶ˆè´¹è€…1å¾ˆå¿«å®Œæˆäº†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…2å´åœ¨ç¼“æ…¢çš„å¤„ç†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚

ä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯æ˜¯**å¹³å‡åˆ†é…ç»™æ¯ä¸ªæ¶ˆè´¹è€…**ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚è¿™æ˜¯å› ä¸º RabbitMQ é»˜è®¤æœ‰ä¸€ä¸ªæ¶ˆæ¯é¢„å–æœºåˆ¶ï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯èƒ½è€…å¤šåŠ³å˜›ï¼Œæ‰€ä»¥å»é™åˆ¶æ¯æ¬¡åªèƒ½å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

åœ¨ spring ä¸­æœ‰ä¸€ä¸ªç®€å•çš„é…ç½®ï¼Œè®¾ç½® prefetch å±æ€§ï¼Œæˆ‘ä»¬ä¿®æ”¹ consumer æœåŠ¡çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ é…ç½®

```yml
spring:
  rabbitmq:
    listener:
      simple:
        prefetch: 1 # æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯
```

Work æ¨¡å‹çš„ä½¿ç”¨ï¼š

- å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒä¸€æ¡æ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†
- é€šè¿‡è®¾ç½® prefetch æ¥æ§åˆ¶æ¶ˆè´¹è€…é¢„å–çš„æ¶ˆæ¯æ•°é‡

### å‘å¸ƒ/è®¢é˜…

![](https://cdn.xn2001.com/img/2021/20210904213455.png)



å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è®¢é˜…æ¨¡å‹ä¸­ï¼Œå¤šäº†ä¸€ä¸ª exchange è§’è‰²ï¼Œè€Œä¸”è¿‡ç¨‹ç•¥æœ‰å˜åŒ–

- Publisherï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯è¦å‘é€æ¶ˆæ¯çš„ç¨‹åºï¼Œä½†æ˜¯ä¸å†å‘é€åˆ°é˜Ÿåˆ—ä¸­ï¼Œ**è€Œæ˜¯å‘ç»™ exchangeï¼ˆäº¤æ¢æœºï¼‰**
- Consumerï¼šæ¶ˆè´¹è€…ï¼Œä¸ä»¥å‰ä¸€æ ·ï¼Œè®¢é˜…é˜Ÿåˆ—ï¼Œæ²¡æœ‰å˜åŒ–
- Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿä¸ä»¥å‰ä¸€æ ·ï¼Œæ¥æ”¶æ¶ˆæ¯ã€ç¼“å­˜æ¶ˆæ¯
- Exchangeï¼šäº¤æ¢æœºï¼Œä¸€æ–¹é¢ï¼Œæ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼›å¦ä¸€æ–¹é¢ï¼ŒçŸ¥é“å¦‚ä½•å¤„ç†æ¶ˆæ¯ï¼Œä¾‹å¦‚é€’äº¤ç»™æŸä¸ªç‰¹åˆ«é˜Ÿåˆ—ã€é€’äº¤ç»™æ‰€æœ‰é˜Ÿåˆ—ã€æˆ–æ˜¯å°†æ¶ˆæ¯ä¸¢å¼ƒã€‚åˆ°åº•å¦‚ä½•æ“ä½œï¼Œå–å†³äº Exchange çš„ç±»å‹ã€‚Exchange æœ‰ä»¥ä¸‹3ç§ç±»å‹ï¼š
  - Fanoutï¼šå¹¿æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šåˆ°äº¤æ¢æœºçš„é˜Ÿåˆ—
  - Directï¼šå®šå‘ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆæŒ‡å®š routing key çš„é˜Ÿåˆ—
  - Topicï¼šé€šé…ç¬¦ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆ routing patternï¼ˆè·¯ç”±æ¨¡å¼ï¼‰ çš„é˜Ÿåˆ—

**Exchangeï¼ˆäº¤æ¢æœºï¼‰åªè´Ÿè´£è½¬å‘æ¶ˆæ¯ï¼Œä¸å…·å¤‡å­˜å‚¨æ¶ˆæ¯çš„èƒ½åŠ›**ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰ä»»ä½•é˜Ÿåˆ—ä¸ Exchange ç»‘å®šï¼Œæˆ–è€…æ²¡æœ‰ç¬¦åˆè·¯ç”±è§„åˆ™çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šä¸¢å¤±ï¼

### Fanout

Fanoutï¼Œè‹±æ–‡ç¿»è¯‘æ˜¯æ‰‡å‡ºï¼Œåœ¨ MQ ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ç§°ä¸ºå¹¿æ’­ã€‚

![](https://cdn.xn2001.com/img/2021/20210912160350.png)

åœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å‘é€æµç¨‹æ˜¯è¿™æ ·çš„ï¼š

- å¯ä»¥æœ‰å¤šä¸ªé˜Ÿåˆ—
- æ¯ä¸ªé˜Ÿåˆ—éƒ½è¦ç»‘å®šåˆ° Exchangeï¼ˆäº¤æ¢æœºï¼‰
- ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œåªèƒ½å‘é€åˆ°äº¤æ¢æœºï¼Œäº¤æ¢æœºæ¥å†³å®šè¦å‘ç»™å“ªä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…æ— æ³•å†³å®š
- äº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€ç»™ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ—
- è®¢é˜…é˜Ÿåˆ—çš„æ¶ˆè´¹è€…éƒ½èƒ½æ‹¿åˆ°æ¶ˆæ¯

æ¥ä¸‹é‡Œæˆ‘ä»¬ç”¨ SpringAMQP æ¥ç®€å•å®ç° FanoutExchange

1. åœ¨ consumer æœåŠ¡ä¸­ï¼Œåˆ©ç”¨ä»£ç å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºï¼Œå¹¶å°†ä¸¤è€…ç»‘å®š
2. åœ¨ consumer æœåŠ¡ä¸­ï¼Œç¼–å†™ä¸¤ä¸ªæ¶ˆè´¹è€…æ–¹æ³•ï¼Œåˆ†åˆ«ç›‘å¬ fanout.queue1 å’Œ fanout.queue2

3. åœ¨ publisher ä¸­ç¼–å†™æµ‹è¯•æ–¹æ³•ï¼Œå‘ fanoutå‘é€æ¶ˆæ¯

**å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº**

Spring æä¾›äº†ä¸€ä¸ªæ¥å£ Exchangeï¼Œæ¥è¡¨ç¤ºæ‰€æœ‰ä¸åŒç±»å‹çš„äº¤æ¢æœºã€‚

![](https://cdn.xn2001.com/img/2021/20210904213809.png)

åœ¨ consumer ä¸­åˆ›å»ºä¸€ä¸ªç±»ï¼Œå£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºã€**ç»‘å®šå¯¹è±¡ Binding**

```java
@Configuration
public class FanoutConfig {

    /**
     * å£°æ˜äº¤æ¢æœº
     * @return Fanoutç±»å‹äº¤æ¢æœº
     */
    @Bean
    public FanoutExchange fanoutExchange(){
        return new FanoutExchange("xn2001.fanout");
    }

    /**
     * å£°æ˜é˜Ÿåˆ—
     * @return Queue
     */
    @Bean
    public Queue fanoutQueue1(){
        return new Queue("fanout.queue1");
    }
    @Bean
    public Queue fanoutQueue2(){
        return new Queue("fanout.queue2");
    }

    /**
     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº
     */
    @Bean
    public Binding bindingQueue1(FanoutExchange fanoutExchange,Queue fanoutQueue1){
        return BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);
    }
    @Bean
    public Binding bindingQueue2(FanoutExchange fanoutExchange,Queue fanoutQueue2){
        return BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);
    }

}
```

![](https://cdn.xn2001.com/img/2021/20210912181932.png)

é€šè¿‡è¿™æ · `@Bean` çš„æ–¹å¼æ¥ç”³æ˜ç¡®å®æ¯”è¾ƒéº»çƒ¦ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥é€šè¿‡ `@RabbitListener` æ³¨è§£æ¥å®Œæˆçš„ï¼Œä»£ç å¦‚ä¸‹ï¼š

åœ¨ consumer æœåŠ¡çš„ SpringRabbitListener ä¸­æ·»åŠ ä¸‰ä¸ªæ–¹æ³•ï¼Œä½œä¸ºæ¶ˆè´¹è€…

```java
@RabbitListener(queues = "fanout.queue1")
public void listenFanoutQueue1(String msg) throws InterruptedException {
    System.out.println("æ¥æ”¶åˆ°fanout.queue1çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}

@RabbitListener(queues = "fanout.queue2")
public void listenFanoutQueue2(String msg) throws InterruptedException {
    System.err.println("æ¥æ”¶åˆ°fanout.queue2çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}

@RabbitListener(bindings = @QueueBinding(
    value = @Queue(value = "fanout.queue3"),
    exchange = @Exchange(value = "xn2001.fanout",type = "fanout")
))
public void listenFanoutQueue3(String msg) {
    System.out.println("æ¥æ”¶åˆ°fanout.queue3çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}
```

åœ¨ publisher æœåŠ¡çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•

```java
/**
 * fanout
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */
@Test
public void testFanoutExchange() {
    // äº¤æ¢æœºåç§°
    String exchangeName = "xn2001.fanout";
    // æ¶ˆæ¯
    String message = "hello, everybody!";
    rabbitTemplate.convertAndSend(exchangeName, "", message);
}
```

è¿è¡Œè¯¥æ–¹æ³•ï¼Œå¯ä»¥å‘ç° fanout.queue1ã€fanout.queue2 éƒ½æ”¶åˆ°äº†äº¤æ¢æœºçš„æ¶ˆæ¯ã€‚

![](https://cdn.xn2001.com/img/2021/20210912182458.png)

æ€»ç»“ä¸€ä¸‹ï¼š

äº¤æ¢æœºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

- æ¥æ”¶ publisher å‘é€çš„æ¶ˆæ¯
- å°†æ¶ˆæ¯æŒ‰ç…§è§„åˆ™è·¯ç”±åˆ°ä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—
- ä¸èƒ½ç¼“å­˜æ¶ˆæ¯ï¼Œè·¯ç”±å¤±è´¥ï¼Œæ¶ˆæ¯ä¸¢å¤±
- FanoutExchange ä¼šå°†æ‰€æœ‰æ¶ˆæ¯è·¯ç”±åˆ°æ¯ä¸ªç»‘å®šçš„é˜Ÿåˆ—

### Direct

åœ¨ Fanout æ¨¡å¼ä¸­ï¼Œä¸€æ¡æ¶ˆæ¯ï¼Œä¼šè¢«æ‰€æœ‰è®¢é˜…çš„é˜Ÿåˆ—éƒ½æ¶ˆè´¹ã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸åŒçš„æ¶ˆæ¯è¢«ä¸åŒçš„é˜Ÿåˆ—æ¶ˆè´¹ã€‚è¿™æ—¶å°±è¦ç”¨åˆ° DirectExchange

![](https://cdn.xn2001.com/img/2021/20210912182822.png)

 åœ¨ Direct æ¨¡å‹ä¸‹ï¼š

- é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ª`RoutingKey`ï¼ˆè·¯ç”±keyï¼‰
- æ¶ˆæ¯çš„å‘é€æ–¹å‘ Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„ `RoutingKey`ã€‚
- Exchange ä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯ä¸€ä¸ªç»‘å®šçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯çš„`Routing Key`è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰é˜Ÿåˆ—çš„`Routingkey` ä¸æ¶ˆæ¯çš„ `Routing key`å®Œå…¨ä¸€è‡´ï¼Œæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯

åœ¨ consumer çš„ SpringRabbitListener ä¸­æ·»åŠ ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼ŒåŒæ—¶åŸºäºæ³¨è§£æ¥å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº

```java
@RabbitListener(bindings = @QueueBinding(
    value = @Queue(value = "direct.queue1"),
    exchange = @Exchange(value = "xn2001.direct"),
    key = {"a","b"}
))
public void listenDirectQueue1(String msg){
    System.out.println("æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}

@RabbitListener(bindings = @QueueBinding(
    value = @Queue(value = "direct.queue2"),
    exchange = @Exchange(value = "xn2001.direct"),
    key = {"a","c"}
))
public void listenDirectQueue2(String msg){
    System.out.println("æ¥æ”¶åˆ°direct.queue2çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}
```

åœ¨ publisher æœåŠ¡çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•

```java
/**
 * direct
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */
@Test
public void testDirectExchangeToA() {
    // äº¤æ¢æœºåç§°
    String exchangeName = "xn2001.direct";
    // æ¶ˆæ¯
    String message = "hello, i am direct to a!";
    rabbitTemplate.convertAndSend(exchangeName, "a", message);
}

/**
 * direct
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */
@Test
public void testDirectExchangeToB() {
    // äº¤æ¢æœºåç§°
    String exchangeName = "xn2001.direct";
    // æ¶ˆæ¯
    String message = "hello, i am direct to b!";
    rabbitTemplate.convertAndSend(exchangeName, "b", message);
}
```

### Topic

`Topic ` ä¸ `Direct`ç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ®`RoutingKey`æŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ã€‚åªä¸è¿‡`Topic `ç±»å‹å¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®š`Routing key` çš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ï¼

é€šé…ç¬¦è§„åˆ™ï¼š

`#`ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯ 

`*`ï¼šåªèƒ½åŒ¹é…ä¸€ä¸ªè¯

ä¾‹å¦‚ï¼š

`item.#`ï¼šèƒ½å¤ŸåŒ¹é…`item.spu.insert` æˆ–è€… `item.spu`

`item.*`ï¼šåªèƒ½åŒ¹é…`item.spu`

 ![](https://cdn.xn2001.com/img/2021/20210912194016.png)

- Queue1ï¼šç»‘å®šçš„æ˜¯ `china.#` ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ `china.` å¼€å¤´çš„ `routing key` éƒ½ä¼šè¢«åŒ¹é…åˆ°ã€‚åŒ…æ‹¬ china.news å’Œ china.weather
- Queue2ï¼šç»‘å®šçš„æ˜¯ `#.news` ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ `.news ` ç»“å°¾çš„  `routing key` éƒ½ä¼šè¢«åŒ¹é…ã€‚åŒ…æ‹¬ china.news å’Œ japan.news 

```java
@RabbitListener(bindings = @QueueBinding(
    value = @Queue(value = "topic.queue1"),
    exchange = @Exchange(value = "xn2001.topic",type = ExchangeTypes.TOPIC),
    key = {"china.#"}
))
public void listenTopicQueue1(String msg){
    System.out.println("æ¥æ”¶åˆ°topic.queue1çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}

@RabbitListener(bindings = @QueueBinding(
    value = @Queue(value = "topic.queue2"),
    exchange = @Exchange(value = "xn2001.topic",type = ExchangeTypes.TOPIC),
    key = {"china.*"}
))
public void listenTopicQueue2(String msg){
    System.out.println("æ¥æ”¶åˆ°topic.queue2çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
}
```

```java
/**
 * topic
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */
@Test
public void testTopicExchange() {
    // äº¤æ¢æœºåç§°
    String exchangeName = "xn2001.topic";
    // æ¶ˆæ¯
    String message1 = "hello, i am topic form china.news";
    String message2 = "hello, i am topic form china.news.2";
    rabbitTemplate.convertAndSend(exchangeName, "china.news", message1);
    rabbitTemplate.convertAndSend(exchangeName, "china.news.2", message2);
}
```



![](https://cdn.xn2001.com/img/2021/20210912200012.png)

### æ¶ˆæ¯è½¬æ¢å™¨

Spring ä¼šæŠŠä½ å‘é€çš„æ¶ˆæ¯åºåˆ—åŒ–ä¸ºå­—èŠ‚å‘é€ç»™ MQï¼Œæ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿˜ä¼šæŠŠå­—èŠ‚ååºåˆ—åŒ–ä¸º Java å¯¹è±¡ã€‚

**é»˜è®¤æƒ…å†µä¸‹ Spring é‡‡ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯ JDK åºåˆ—åŒ–ã€‚**

æˆ‘ä»¬å¯ä»¥å»è¯•ä¸€ä¸‹æ•ˆæœ

```java
@RabbitListener(queuesToDeclare = @Queue(value = "object.queue"))
public void listenObjectQueue(Map<String,Object> msg) throws InterruptedException {
    System.err.println("objectæ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€" + msg + "ã€‘" + LocalTime.now());
    Thread.sleep(200);
}
```

```java
@Test
public void testSendMap()  {
    // å‡†å¤‡æ¶ˆæ¯
    Map<String,Object> msg = new HashMap<>();
    msg.put("name", "Jack");
    msg.put("age", 21);
    // å‘é€æ¶ˆæ¯
    rabbitTemplate.convertAndSend("object.queue", msg);
}
```

![](https://cdn.xn2001.com/img/2021/20210912204117.png)

ä¼—æ‰€å‘¨çŸ¥ï¼ŒJDKåºåˆ—åŒ–å­˜åœ¨ä¸‹åˆ—é—®é¢˜ï¼š

- æ•°æ®ä½“ç§¯è¿‡å¤§
- æœ‰å®‰å…¨æ¼æ´
- å¯è¯»æ€§å·®

æˆ‘ä»¬æ¨èå¯ä»¥ä½¿ç”¨ JSON æ¥åºåˆ—åŒ–

åœ¨ publisher å’Œ consumer ä¸¤ä¸ªæœåŠ¡ä¸­éƒ½å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>com.fasterxml.jackson.dataformat</groupId>
    <artifactId>jackson-dataformat-xml</artifactId>
    <version>2.9.10</version>
</dependency>
```

é…ç½®æ¶ˆæ¯è½¬æ¢å™¨ã€‚

åœ¨å„è‡ªçš„å¯åŠ¨ç±»ä¸­æ·»åŠ ä¸€ä¸ª Bean å³å¯

```java
@Bean
public MessageConverter jsonMessageConverter(){
    return new Jackson2JsonMessageConverter();
}
```

![](https://cdn.xn2001.com/img/2021/20210912204512.png)



# ELasticsearchæœç´¢å¼•æ“

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/09-elasticsearch-hotel-demo
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/09-elasticsearch-hotel-demo

ELasticsearch æ˜¯ä¸€æ¬¾éå¸¸å¼ºå¤§çš„å¼€æºæœç´¢å¼•æ“ï¼Œå…·å¤‡éå¸¸å¤šå¼ºå¤§åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»æµ·é‡æ•°æ®ä¸­å¿«é€Ÿæ‰¾åˆ°éœ€è¦çš„å†…å®¹ï¼Œå¯ä»¥ç”¨æ¥å®ç°æœç´¢ã€æ—¥å¿—ç»Ÿè®¡ã€åˆ†æã€ç³»ç»Ÿç›‘æ§ç­‰åŠŸèƒ½ã€‚

![](https://cdn.xn2001.com/img/2021/20210918202359.png)

## å€’æ’ç´¢å¼•

**é¦–å…ˆï¼Œå€’æ’ç´¢å¼•çš„æ¦‚å¿µæ˜¯åŸºäº MySQL è¿™æ ·çš„æ­£å‘ç´¢å¼•è€Œè¨€çš„ã€‚**

é‚£ä¹ˆæˆ‘ä»¬å…ˆè®²ä½•ä¸ºæ­£å‘ç´¢å¼•ã€‚ä¾‹å¦‚ç»™ä¸‹è¡¨ï¼ˆtb_goodsï¼‰ä¸­çš„ id åˆ›å»ºç´¢å¼•

![](https://cdn.xn2001.com/img/2021/20210918202527.png)

å¦‚æœæ˜¯æ ¹æ® id æŸ¥è¯¢ï¼Œé‚£ä¹ˆç›´æ¥èµ°ç´¢å¼•ï¼ŒæŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ã€‚

ä½†å¦‚æœæ˜¯åŸºäº title åšæ¨¡ç³ŠæŸ¥è¯¢ï¼Œåªèƒ½æ˜¯é€è¡Œæ‰«ææ•°æ®ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·æœç´¢æ•°æ®ï¼Œæ¡ä»¶æ˜¯ title ç¬¦åˆ `"%æ‰‹æœº%"`
2. é€è¡Œè·å–æ•°æ®ï¼Œæ¯”å¦‚ id ä¸º 1 çš„æ•°æ®
3. åˆ¤æ–­æ•°æ®ä¸­çš„ title æ˜¯å¦ç¬¦åˆç”¨æˆ·æœç´¢æ¡ä»¶
4. å¦‚æœç¬¦åˆåˆ™æ”¾å…¥ç»“æœé›†ï¼Œä¸ç¬¦åˆåˆ™ä¸¢å¼ƒã€‚ç„¶åå›åˆ°æ­¥éª¤1

é€è¡Œæ‰«æï¼Œä¹Ÿå°±æ˜¯å…¨è¡¨æ‰«æï¼Œéšç€æ•°æ®é‡å¢åŠ ï¼Œå…¶æŸ¥è¯¢æ•ˆç‡ä¹Ÿä¼šè¶Šæ¥è¶Šä½ã€‚å½“æ•°æ®é‡è¾¾åˆ°æ•°ç™¾ä¸‡æ—¶ï¼Œå°±æ˜¯ã€‚ã€‚ã€‚

è€Œå€’æ’ç´¢å¼•ä¸­æœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼š

- æ–‡æ¡£ï¼ˆ`Document`ï¼‰ï¼šç”¨æ¥æœç´¢çš„æ•°æ®ï¼Œå…¶ä¸­çš„æ¯ä¸€æ¡æ•°æ®å°±æ˜¯ä¸€ä¸ªæ–‡æ¡£ã€‚ä¾‹å¦‚ä¸€ä¸ªç½‘é¡µã€ä¸€ä¸ªå•†å“ä¿¡æ¯
- è¯æ¡ï¼ˆ`Term`ï¼‰ï¼šå¯¹æ–‡æ¡£æ•°æ®æˆ–ç”¨æˆ·æœç´¢æ•°æ®ï¼Œåˆ©ç”¨æŸç§ç®—æ³•åˆ†è¯ï¼Œå¾—åˆ°çš„å…·å¤‡å«ä¹‰çš„è¯è¯­å°±æ˜¯è¯æ¡ã€‚ä¾‹å¦‚ï¼šæˆ‘æ˜¯ä¸­å›½äººï¼Œå°±å¯ä»¥åˆ†ä¸ºï¼šæˆ‘ã€æ˜¯ã€ä¸­å›½äººã€ä¸­å›½ã€å›½äººè¿™æ ·çš„å‡ ä¸ªè¯æ¡

**åˆ›å»ºå€’æ’ç´¢å¼•**æ˜¯å¯¹æ­£å‘ç´¢å¼•çš„ä¸€ç§ç‰¹æ®Šå¤„ç†ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

- å°†æ¯ä¸€ä¸ªæ–‡æ¡£çš„æ•°æ®åˆ©ç”¨ç®—æ³•åˆ†è¯ï¼Œå¾—åˆ°ä¸€ä¸ªä¸ªè¯æ¡
- åˆ›å»ºè¡¨ï¼Œæ¯è¡Œæ•°æ®åŒ…æ‹¬è¯æ¡ã€è¯æ¡æ‰€åœ¨æ–‡æ¡£ idã€ä½ç½®ç­‰ä¿¡æ¯
- å› ä¸ºè¯æ¡å”¯ä¸€æ€§ï¼Œå¯ä»¥ç»™è¯æ¡åˆ›å»ºç´¢å¼•ï¼Œä¾‹å¦‚ hash è¡¨ç»“æ„ç´¢å¼•

å¦‚å›¾ï¼š

![](https://cdn.xn2001.com/img/2021/20210918203514.png)



**å€’æ’ç´¢å¼•çš„æœç´¢æµç¨‹**å¦‚ä¸‹ï¼ˆä»¥æœç´¢"åä¸ºæ‰‹æœº"ä¸ºä¾‹ï¼‰

1. ç”¨æˆ·è¾“å…¥æ¡ä»¶`"åä¸ºæ‰‹æœº"`è¿›è¡Œæœç´¢
2. å¯¹ç”¨æˆ·è¾“å…¥å†…å®¹**åˆ†è¯**ï¼Œå¾—åˆ°è¯æ¡ï¼š`åä¸º`ã€`æ‰‹æœº`
3. æ‹¿ç€è¯æ¡åœ¨å€’æ’ç´¢å¼•ä¸­æŸ¥æ‰¾ï¼Œå¯ä»¥å¾—åˆ°åŒ…å«è¯æ¡çš„æ–‡æ¡£ id æœ‰ 1ã€2ã€3
4. æ‹¿ç€æ–‡æ¡£ id åˆ°æ­£å‘ç´¢å¼•ä¸­æŸ¥æ‰¾å…·ä½“æ–‡æ¡£

![](https://cdn.xn2001.com/img/2021/20210918203815.png)

**è™½ç„¶è¦å…ˆæŸ¥è¯¢å€’æ’ç´¢å¼•ï¼Œå†æŸ¥è¯¢æ­£å‘ç´¢å¼•ï¼Œä½†æ˜¯è¯æ¡å’Œæ–‡æ¡£id éƒ½å»ºç«‹äº†ç´¢å¼•ï¼ŒæŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ï¼æ— éœ€å…¨è¡¨æ‰«æã€‚**

ä¸ºä»€ä¹ˆä¸€ä¸ªå«åšæ­£å‘ç´¢å¼•ï¼Œä¸€ä¸ªå«åšå€’æ’ç´¢å¼•å‘¢ï¼Ÿ

**æ­£å‘ç´¢å¼•**æ˜¯æœ€ä¼ ç»Ÿçš„ï¼Œæ ¹æ® id ç´¢å¼•çš„æ–¹å¼ã€‚ä½†æ ¹æ®è¯æ¡æŸ¥è¯¢æ—¶ï¼Œå¿…é¡»å…ˆé€æ¡è·å–æ¯ä¸ªæ–‡æ¡£ï¼Œç„¶ååˆ¤æ–­æ–‡æ¡£ä¸­æ˜¯å¦åŒ…å«æ‰€éœ€è¦çš„è¯æ¡ï¼Œæ˜¯**æ ¹æ®æ–‡æ¡£æ‰¾è¯æ¡çš„è¿‡ç¨‹**

**å€’æ’ç´¢å¼•**åˆ™ç›¸åï¼Œæ˜¯å…ˆæ‰¾åˆ°ç”¨æˆ·è¦æœç´¢çš„è¯æ¡ï¼Œæ ¹æ®å¾—åˆ°çš„æ–‡æ¡£ id è·å–è¯¥æ–‡æ¡£ã€‚æ˜¯**æ ¹æ®è¯æ¡æ‰¾æ–‡æ¡£çš„è¿‡ç¨‹**

## æ–‡æ¡£å’Œå­—æ®µ

elasticsearch æ˜¯é¢å‘**æ–‡æ¡£ï¼ˆDocumentï¼‰**å­˜å‚¨çš„ï¼Œå¯ä»¥æ˜¯æ•°æ®åº“ä¸­çš„ä¸€æ¡å•†å“æ•°æ®ï¼Œä¸€ä¸ªè®¢å•ä¿¡æ¯ã€‚æ–‡æ¡£æ•°æ®ä¼šè¢«åºåˆ—åŒ–ä¸º json æ ¼å¼åå­˜å‚¨åœ¨ elasticsearch

![](https://cdn.xn2001.com/img/2021/20210918212707.png)

è€Œ JSON æ–‡æ¡£ä¸­å¾€å¾€åŒ…å«å¾ˆå¤šçš„**å­—æ®µï¼ˆFieldï¼‰**ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„åˆ—ã€‚

## ç´¢å¼•å’Œæ˜ å°„

**ç´¢å¼•ï¼ˆIndexï¼‰**ï¼Œå°±æ˜¯ç›¸åŒç±»å‹çš„æ–‡æ¡£çš„é›†åˆã€‚

ä¾‹å¦‚ï¼š

- æ‰€æœ‰ç”¨æˆ·æ–‡æ¡£ï¼Œå°±å¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºç”¨æˆ·çš„ç´¢å¼•ï¼›
- æ‰€æœ‰å•†å“çš„æ–‡æ¡£ï¼Œå¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºå•†å“çš„ç´¢å¼•ï¼›
- æ‰€æœ‰è®¢å•çš„æ–‡æ¡£ï¼Œå¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºè®¢å•çš„ç´¢å¼•ï¼›

![](https://cdn.xn2001.com/img/2021/20210918213357.png)



å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç´¢å¼•å½“åšæ˜¯æ•°æ®åº“ä¸­çš„è¡¨ã€‚

æ•°æ®åº“çš„è¡¨ä¼šæœ‰çº¦æŸä¿¡æ¯ï¼Œç”¨æ¥å®šä¹‰è¡¨çš„ç»“æ„ã€å­—æ®µçš„åç§°ã€ç±»å‹ç­‰ä¿¡æ¯ã€‚å› æ­¤ï¼Œç´¢å¼•åº“ä¸­å°±æœ‰**æ˜ å°„ï¼ˆmappingï¼‰**ï¼Œæ˜¯ç´¢å¼•ä¸­æ–‡æ¡£çš„å­—æ®µçº¦æŸä¿¡æ¯ï¼Œç±»ä¼¼è¡¨çš„ç»“æ„çº¦æŸã€‚

**mysql ä¸ elasticsearch**

| **MySQL** | **Elasticsearch** | **è¯´æ˜**                                                     |
| --------- | ----------------- | ------------------------------------------------------------ |
| Table     | Index             | ç´¢å¼•(index)ï¼Œå°±æ˜¯æ–‡æ¡£çš„é›†åˆï¼Œç±»ä¼¼æ•°æ®åº“çš„è¡¨(table)           |
| Row       | Document          | æ–‡æ¡£ï¼ˆDocumentï¼‰ï¼Œå°±æ˜¯ä¸€æ¡æ¡çš„æ•°æ®ï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„è¡Œï¼ˆRowï¼‰ï¼Œæ–‡æ¡£éƒ½æ˜¯JSONæ ¼å¼ |
| Column    | Field             | å­—æ®µï¼ˆFieldï¼‰ï¼Œå°±æ˜¯JSONæ–‡æ¡£ä¸­çš„å­—æ®µï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„åˆ—ï¼ˆColumnï¼‰ |
| Schema    | Mapping           | Mappingï¼ˆæ˜ å°„ï¼‰æ˜¯ç´¢å¼•ä¸­æ–‡æ¡£çš„çº¦æŸï¼Œä¾‹å¦‚å­—æ®µç±»å‹çº¦æŸã€‚ç±»ä¼¼æ•°æ®åº“çš„è¡¨ç»“æ„ï¼ˆSchemaï¼‰ |
| SQL       | DSL               | DSLæ˜¯elasticsearchæä¾›çš„JSONé£æ ¼çš„è¯·æ±‚è¯­å¥ï¼Œç”¨æ¥æ“ä½œelasticsearchï¼Œå®ç°CRUD |

- Mysqlï¼šæ“…é•¿äº‹åŠ¡ç±»å‹æ“ä½œï¼Œå¯ä»¥ç¡®ä¿æ•°æ®çš„å®‰å…¨å’Œä¸€è‡´æ€§

- Elasticsearchï¼šæ“…é•¿æµ·é‡æ•°æ®çš„æœç´¢ã€åˆ†æã€è®¡ç®—

å› æ­¤åœ¨ä¼ä¸šä¸­ï¼Œå¾€å¾€æ˜¯ä¸¤è€…ç»“åˆä½¿ç”¨ï¼š

- å¯¹å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜çš„å†™æ“ä½œï¼Œä½¿ç”¨ MySQL å®ç°
- å¯¹æŸ¥è¯¢æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„æœç´¢éœ€æ±‚ï¼Œä½¿ç”¨ ELasticsearch å®ç°
- ä¸¤è€…å†åŸºäºæŸç§æ–¹å¼ï¼Œå®ç°æ•°æ®çš„åŒæ­¥ï¼Œä¿è¯ä¸€è‡´æ€§

![](https://cdn.xn2001.com/img/2021/20210918213631.png)



## å®‰è£…Elasticsearch

å› ä¸ºæˆ‘ä»¬è¿˜éœ€è¦éƒ¨ç½² kibana å®¹å™¨ï¼Œéœ€è¦è®© es å’Œ kibana å®¹å™¨äº’è”ã€‚è¿™é‡Œå…ˆåˆ›å»ºä¸€ä¸ªç½‘ç»œï¼š

```sh
docker network create es-net 
```

å®‰è£…

```sh
docker run -d \
--name es \
-e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
-e "discovery.type=single-node" \
-v es-data:/usr/share/elasticsearch/data \
-v es-plugins:/usr/share/elasticsearch/plugins \
--privileged \
--network es-net \
-p 9200:9200 \
-p 9300:9300 \
elasticsearch:7.12.1
```

å‘½ä»¤è§£é‡Šï¼š

- `-e "cluster.name=es-docker-cluster"`ï¼šè®¾ç½®é›†ç¾¤åç§°
- `-e "http.host=0.0.0.0"`ï¼šç›‘å¬çš„åœ°å€ï¼Œå¯ä»¥å¤–ç½‘è®¿é—®
- `-e "ES_JAVA_OPTS=-Xms512m -Xmx512m"`ï¼šå†…å­˜å¤§å°
- `-e "discovery.type=single-node"`ï¼šéé›†ç¾¤æ¨¡å¼
- `-v es-data:/usr/share/elasticsearch/data`ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ•°æ®ç›®å½•
- `-v es-logs:/usr/share/elasticsearch/logs`ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ—¥å¿—ç›®å½•
- `-v es-plugins:/usr/share/elasticsearch/plugins`ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ’ä»¶ç›®å½•
- `--privileged`ï¼šæˆäºˆé€»è¾‘å·è®¿é—®æƒ
- `--network es-net` ï¼šåŠ å…¥ä¸€ä¸ªåä¸º es-net çš„ç½‘ç»œä¸­
- `-p 9200:9200`ï¼šç«¯å£æ˜ å°„é…ç½®

è®¿é—®åœ°å€ï¼šhttp://192.168.211.128:9200 å³å¯çœ‹åˆ° elasticsearch çš„å“åº”ç»“æœ

![](https://cdn.xn2001.com/img/2021/20210918214620.png)

## å®‰è£…kibana

kibana å¯ä»¥ç»™æˆ‘ä»¬æä¾›ä¸€ä¸ª elasticsearch çš„å¯è§†åŒ–ç•Œé¢ï¼Œä¾¿äºæˆ‘ä»¬å­¦ä¹ å‘½ä»¤ã€‚

```sh
docker run -d \
--name kibana \
-e ELASTICSEARCH_HOSTS=http://es:9200 \
--network=es-net \
-p 5601:5601  \
kibana:7.12.1
```

- `--network es-net` ï¼šåŠ å…¥ä¸€ä¸ªåä¸º es-net çš„ç½‘ç»œä¸­ï¼Œä¸ elasticsearch åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­
- `-e ELASTICSEARCH_HOSTS=http://es:9200"`ï¼šè®¾ç½® elasticsearch çš„åœ°å€ï¼Œå› ä¸º kibana å·²ç»ä¸ elasticsearch åœ¨ä¸€ä¸ªç½‘ç»œï¼Œå› æ­¤å¯ä»¥ç”¨å®¹å™¨åç›´æ¥è®¿é—® elasticsearch
- `-p 5601:5601`ï¼šç«¯å£æ˜ å°„é…ç½®

è®¿é—®åœ°å€ï¼šhttp://192.168.211.128:5601ï¼Œå³å¯çœ‹åˆ°ç»“æœ

![](https://cdn.xn2001.com/img/2021/20210918214722.png)

æ§åˆ¶é¢æ¿ï¼šhttp://192.168.211.128:5601/app/dev_tools#/console

## å®‰è£…IKåˆ†è¯å™¨

ç”±äºå›½å†…è®¿é—® GitHub è¾ƒæ…¢ï¼Œæˆ‘ä»¬é€‰æ‹©ç¦»çº¿æ¨¡å¼å®‰è£…ã€‚

å®‰è£…æ’ä»¶éœ€è¦çŸ¥é“ elasticsearch çš„ plugins ç›®å½•ä½ç½®ï¼Œè€Œæˆ‘ä»¬ç”¨äº†æ•°æ®å·æŒ‚è½½ï¼Œå› æ­¤éœ€è¦æŸ¥çœ‹ elasticsearch çš„æ•°æ®å·ç›®å½•ï¼Œé€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹

```sh
docker volume inspect es-plugins
```

æ˜¾ç¤ºç»“æœï¼š

```json
[
    {
        "CreatedAt": "2022-05-06T10:06:34+08:00",
        "Driver": "local",
        "Labels": null,
        "Mountpoint": "/var/lib/docker/volumes/es-plugins/_data",
        "Name": "es-plugins",
        "Options": null,
        "Scope": "local"
    }
]
```

è¯´æ˜ plugins ç›®å½•è¢«æŒ‚è½½åˆ°äº† `/var/lib/docker/volumes/es-plugins/_data ` è¿™ä¸ªç›®å½•ä¸­

![](https://cdn.xn2001.com/img/2021/20210918215615.png)

é‡å¯å®¹å™¨

```shell
# 4ã€é‡å¯å®¹å™¨
docker restart es

# æŸ¥çœ‹esæ—¥å¿—
docker logs -f es
```

IKåˆ†è¯å™¨åŒ…å«ä¸¤ç§æ¨¡å¼ï¼š

* `ik_smart`ï¼šæ™ºèƒ½åˆ‡åˆ†ï¼Œç²—ç²’åº¦
* `ik_max_word`ï¼šæœ€ç»†åˆ‡åˆ†ï¼Œç»†ç²’åº¦

æˆ‘ä»¬åœ¨ä¸Šé¢çš„ Kibana æ§åˆ¶å°æµ‹è¯•

```json
GET /_analyze
{
  "analyzer": "ik_max_word",
  "text": "é’Ÿè€å¸ˆä½ å¥½èœå•Š"
}
```

## æ‰©å±•è¯è¯å…¸

åœ¨ä¸Šé¢çš„IKåˆ†è¯å™¨æˆ‘ä»¬å¯ä»¥éšç€çƒ­ç‚¹è¯æ¥æ‰©å±•ï¼Œå¯ä»¥è‡ªå·±æ·»åŠ ï¼Œæ¯”å¦‚ â€é’Ÿè€å¸ˆåº”è¯¥æ˜¯ä¸€ä¸ªçƒ­ç‚¹è¯â€œï¼Œå¦å¤–ä½ ä¹Ÿå¯ä»¥é…ç½®ä¸€äº›åœç”¨æ‰çš„æ•æ„Ÿè¯ï¼Œè®©å…¶ä¸è¿›è¡Œåˆ†è¯ã€‚

æ‰“å¼€IKåˆ†è¯å™¨ config ç›®å½•æ˜¯ `IKAnalyzer.cfg.xml`ï¼Œæ·»åŠ ä¸€ä¸ªæ–‡ä»¶åï¼Œæˆ‘ä»¬ä»¥ `ext.dic` æ–‡ä»¶åä¸ºä¾‹ã€‚

![](https://cdn.xn2001.com/img/2021/20210918221159.png)

æˆ‘ä»¬å»åˆ›å»º `ext.dic` ï¼Œåœ¨å…¶ä¸­æ·»åŠ çƒ­ç‚¹è¯å°±å¥½äº†ï¼Œä¸€ä¸ªè¯ä¸€è¡Œã€‚

![](https://cdn.xn2001.com/img/2021/20210918220910.png)

é‡å¯ elasticsearch

```sh
docker restart es
```

é‡æ–°æµ‹è¯•

```json
GET /_analyze
{
  "analyzer": "ik_max_word",
  "text": "é’Ÿè€å¸ˆä½ å¥½èœå•Š"
}
```

![](https://cdn.xn2001.com/img/2021/20210918221424.png)

## ç´¢å¼•åº“æ“ä½œ

### Mappingå±æ€§æ˜ å°„

ç´¢å¼•åº“å°±ç±»ä¼¼æ•°æ®åº“è¡¨ï¼Œ**mapping æ˜ å°„å°±ç±»ä¼¼è¡¨çš„ç»“æ„**

æˆ‘ä»¬è¦å‘ es ä¸­å­˜å‚¨æ•°æ®ï¼Œå¿…é¡»å…ˆåˆ›å»ºâ€œåº“â€å’Œâ€œè¡¨â€

mapping æ˜¯å¯¹ç´¢å¼•åº“ä¸­æ–‡æ¡£çš„çº¦æŸï¼Œå¸¸è§çš„ mapping å±æ€§åŒ…æ‹¬ï¼š

- typeï¼šå­—æ®µæ•°æ®ç±»å‹ï¼Œå¸¸è§çš„ç®€å•ç±»å‹æœ‰ï¼š
  - å­—ç¬¦ä¸²ï¼štextï¼ˆå¯åˆ†è¯çš„æ–‡æœ¬ï¼‰ã€keywordï¼ˆç²¾ç¡®å€¼ï¼Œä¾‹å¦‚ï¼šå“ç‰Œã€å›½å®¶ã€ipåœ°å€ï¼‰
  - æ•°å€¼ï¼šlongã€integerã€shortã€byteã€doubleã€floatã€
  - å¸ƒå°”ï¼šboolean
  - æ—¥æœŸï¼šdate
  - å¯¹è±¡ï¼šobject
- **indexï¼šæ˜¯å¦åˆ›å»ºç´¢å¼•ï¼Œé»˜è®¤ä¸º true**
- analyzerï¼šä½¿ç”¨å“ªç§åˆ†è¯å™¨
- propertiesï¼šè¯¥å­—æ®µçš„å­å­—æ®µ

æˆ‘ä»¬ä»¥éœ€è¦å­˜å‚¨ä¸‹é¢çš„ JSON ä¸ºä¾‹æ¥è®²è§£

```json
{
    "age": 21,
    "weight": 52.1,
    "isMarried": false,
    "info": "é’Ÿè€å¸ˆçœŸèœ",
    "email": "jialna@qq.com",
    "score": [99.1, 99.5, 98.9],
    "name": {
        "firstName": "æ¹–",
        "lastName": "å¿ƒ"
    }
}
```

é¦–å…ˆå¯¹åº”çš„æ¯ä¸ªå­—æ®µæ˜ å°„ï¼ˆmappingï¼‰æƒ…å†µå¦‚ä¸‹ï¼š

- ageï¼šç±»å‹ä¸º integerï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨
- weightï¼šç±»å‹ä¸º floatï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨
- isMarriedï¼šç±»å‹ä¸ºbooleanï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨
- infoï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œéœ€è¦åˆ†è¯ï¼Œå› æ­¤æ˜¯ textï¼›å‚ä¸æœç´¢ï¼Œindexä¸ºtrueï¼›åˆ†è¯å™¨å¯ä»¥ç”¨ ik_smart
- emailï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä½†æ˜¯ä¸éœ€è¦åˆ†è¯ï¼Œå› æ­¤æ˜¯ keywordï¼›ä¸å‚ä¸æœç´¢ï¼Œindex ä¸º falseï¼›æ— éœ€åˆ†è¯å™¨
- scoreï¼šè™½ç„¶æ˜¯æ•°ç»„ï¼Œ**ä½†æ˜¯æˆ‘ä»¬åªçœ‹å…ƒç´ çš„ç±»å‹**ï¼Œç±»å‹ä¸º floatï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨
- nameï¼šç±»å‹ä¸º objectï¼Œéœ€è¦å®šä¹‰å¤šä¸ªå­å±æ€§
  - name.firstNameï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä¸éœ€è¦åˆ†è¯ï¼Œkeywordï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨
  - name.lastNameï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä¸éœ€è¦åˆ†è¯ï¼Œkeywordï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨

### åˆ›å»ºç´¢å¼•åº“å’Œæ˜ å°„

ä¸Šé¢æˆ‘ä»¬äº†è§£äº† Mapping å±æ€§æ˜ å°„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å»çœ‹çœ‹å¦‚ä½•åˆ›å»ºç´¢å¼•åº“åŠæ˜ å°„ã€‚

```json
PUT /ç´¢å¼•åº“åç§°
{
  "mappings": {
    "properties": {
      "å­—æ®µå":{
        "type": "text",
        "analyzer": "ik_smart"
      },
      "å­—æ®µå2":{
        "type": "keyword",
        "index": "false"
      },
      "å­—æ®µå3":{
        "properties": {
          "å­å­—æ®µ": {
            "type": "keyword"
          }
        }
      }
      // ...ç•¥
    }
  }
}
```

```json
PUT /xn2001
{
  "mappings": {
    "properties": {
      "info":{
        "type": "text",
        "analyzer": "ik_smart"
      },
      "email":{
        "type": "keyword",
        "index": "false"
      },
      "name":{
        "properties": {
          "firstName": {
            "type": "keyword"
          },
          "lastName": {
            "type": "keyword"
          }
        }
      }
    }
  }
}
```

![](https://cdn.xn2001.com/img/2021/20210918224647.png)

æˆ‘ä»¬ç”¨çœŸå®çš„æ•°æ®åº“è¡¨æ¥åˆ›å»ºä¸€ä¸ªç´¢å¼•åº“

![](https://cdn.xn2001.com/img/2021/20210919164626.png)

- å­—æ®µåã€å­—æ®µæ•°æ®ç±»å‹ï¼Œå¯ä»¥å‚è€ƒæ•°æ®è¡¨ç»“æ„çš„åç§°å’Œç±»å‹
- æ˜¯å¦å‚ä¸æœç´¢è¦åˆ†æä¸šåŠ¡æ¥åˆ¤æ–­ï¼Œä¾‹å¦‚å›¾ç‰‡åœ°å€ï¼Œå°±æ— éœ€å‚ä¸æœç´¢
- æ˜¯å¦åˆ†è¯å‘¢è¦çœ‹å†…å®¹ï¼Œå†…å®¹å¦‚æœæ˜¯ä¸€ä¸ªæ•´ä½“å°±æ— éœ€åˆ†è¯
- åˆ†è¯å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ç»Ÿä¸€ä½¿ç”¨ `ik_max_word`

```json
PUT /hotel
{
  "mappings": {
    "properties": {
      "id": {
        "type": "keyword"
      },
      "name":{
        "type": "text",
        "analyzer": "ik_max_word",
        "copy_to": "all"
      },
      "address":{
        "type": "keyword",
        "index": false
      },
      "price":{
        "type": "integer"
      },
      "score":{
        "type": "integer"
      },
      "brand":{
        "type": "keyword",
        "copy_to": "all"
      },
      "city":{
        "type": "keyword",
        "copy_to": "all"
      },
      "starName":{
        "type": "keyword"
      },
      "business":{
        "type": "keyword"
      },
      "location":{
        "type": "geo_point"
      },
      "pic":{
        "type": "keyword",
        "index": false
      },
      "all":{
        "type": "text",
        "analyzer": "ik_max_word"
      }
    }
  }
}
```

ç‰¹æ®Šå­—æ®µè¯´æ˜ï¼š

- locationï¼šåœ°ç†åæ ‡ï¼Œé‡Œé¢åŒ…å«ç²¾åº¦ã€çº¬åº¦
- allï¼šä¸€ä¸ªç»„åˆå­—æ®µï¼Œå…¶ç›®çš„æ˜¯å°†å¤šå­—æ®µçš„å€¼åˆ©ç”¨ `copy_to` åˆå¹¶ï¼Œæä¾›ç»™ç”¨æˆ·æœç´¢ï¼Œè¿™æ ·ä¸€æ¥å°±åªéœ€è¦æœç´¢ä¸€ä¸ªå­—æ®µå°±å¯ä»¥å¾—åˆ°ç»“æœï¼Œæ€§èƒ½æ›´å¥½ã€‚

> ESä¸­æ”¯æŒä¸¤ç§åœ°ç†åæ ‡æ•°æ®ç±»å‹ï¼š
>
> - geo_pointï¼šç”±çº¬åº¦ï¼ˆlatitudeï¼‰å’Œç»åº¦ï¼ˆlongitudeï¼‰ç¡®å®šçš„ä¸€ä¸ªç‚¹ã€‚ä¾‹å¦‚ï¼š"32.8752345, 120.2981576"
> - geo_shapeï¼šæœ‰å¤šä¸ª geo_point ç»„æˆçš„å¤æ‚å‡ ä½•å›¾å½¢ã€‚ä¾‹å¦‚ä¸€æ¡ç›´çº¿ï¼Œ"LINESTRING (-77.03653 38.897676, -77.009051 38.889939)"

### ä¿®æ”¹ç´¢å¼•åº“

å€’æ’ç´¢å¼•ç»“æ„è™½ç„¶ä¸å¤æ‚ï¼Œä½†æ˜¯ä¸€æ—¦æ•°æ®ç»“æ„æ”¹å˜ï¼ˆæ¯”å¦‚æ”¹å˜äº†åˆ†è¯å™¨ï¼‰ï¼Œå°±éœ€è¦é‡æ–°åˆ›å»ºå€’æ’ç´¢å¼•ï¼Œè¿™ç®€ç›´æ˜¯ç¾éš¾ã€‚å› æ­¤ç´¢å¼•åº“**ä¸€æ—¦åˆ›å»ºï¼Œæ— æ³•ä¿®æ”¹ mapping**

è™½ç„¶æ— æ³•ä¿®æ”¹ mapping ä¸­å·²æœ‰çš„å­—æ®µï¼Œä½†æ˜¯å´å…è®¸æ·»åŠ æ–°çš„å­—æ®µåˆ° mapping ä¸­ï¼Œä¸ä¼šå¯¹å€’æ’ç´¢å¼•äº§ç”Ÿå½±å“ã€‚

```json
PUT /ç´¢å¼•åº“å/_mapping
{
  "properties": {
    "æ–°å­—æ®µå":{
      "type": "integer"
    }
  }
}
```

### åˆ é™¤ç´¢å¼•åº“

```json
DELETE /ç´¢å¼•åº“å
```

### æŸ¥è¯¢ç´¢å¼•åº“

```json
GET /æ•°æ®åº“å
```

## DSLæ–‡æ¡£æ“ä½œ

### æ–°å¢æ–‡æ¡£

```json
POST /ç´¢å¼•åº“å/_doc/æ–‡æ¡£id
{
    "å­—æ®µ1": "å€¼1",
    "å­—æ®µ2": "å€¼2",
    "å­—æ®µ3": {
        "å­å±æ€§1": "å€¼3",
        "å­å±æ€§2": "å€¼4"
    }
    // ...
}
```

```json
POST /xn2001/_doc/1
{
    "info": "æˆ‘ä¸ä¼šJava",
    "email": "jialna@qq.com",
    "name": {
        "firstName": "é’Ÿ",
        "lastName": "å¼Ÿå¼Ÿ"
    }
}
```

### ä¿®æ”¹æ–‡æ¡£

ä¿®æ”¹æ–‡æ¡£æœ‰ä¸¤ç§æ–¹å¼ï¼š

- å…¨é‡ä¿®æ”¹ï¼šç›´æ¥è¦†ç›–åŸæ¥çš„æ–‡æ¡£
- å¢é‡ä¿®æ”¹ï¼šä¿®æ”¹æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ

**å…¨é‡ä¿®æ”¹**æ˜¯è¦†ç›–åŸæ¥çš„æ–‡æ¡£ï¼Œå…¶æœ¬è´¨æ˜¯ï¼š

- æ ¹æ®æŒ‡å®šçš„ id åˆ é™¤æ–‡æ¡£
- æ–°å¢ä¸€ä¸ªç›¸åŒ id çš„æ–‡æ¡£

**æ³¨æ„**ï¼šå¦‚æœæ ¹æ® id åˆ é™¤æ—¶ï¼Œid ä¸å­˜åœ¨ï¼Œç¬¬äºŒæ­¥çš„æ–°å¢ä¹Ÿä¼šæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å˜æˆäº†æ–°å¢æ“ä½œ

```json
PUT /{ç´¢å¼•åº“å}/_doc/id
{
    "å­—æ®µ1": "å€¼1",
    "å­—æ®µ2": "å€¼2",
    // ... ç•¥
}
```

```json
PUT /xn2001/_doc/1
{
    "info": "æˆ‘ä¹Ÿä¸ä¼šæ•²ä»£ç ",
    "email": "3300123589@qq.com",
    "name": {
        "firstName": "å¼Ÿå¼Ÿ",
        "lastName": "é’Ÿ"
    }
}
```

**å¢é‡ä¿®æ”¹**æ˜¯åªä¿®æ”¹æŒ‡å®š id åŒ¹é…çš„æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ

```json
POST /{ç´¢å¼•åº“å}/_update/æ–‡æ¡£id
{
    "doc": {
         "å­—æ®µå": "æ–°çš„å€¼",
    }
}
```

```json
POST /heima/_update/1
{
  "doc": {
    "email": "update@qq.com"
  }
}
```

### æŸ¥è¯¢æ–‡æ¡£

```json
GET /{ç´¢å¼•åº“åç§°}/_doc/{id}
```

### åˆ é™¤æ–‡æ¡£

```json
DELETE /{ç´¢å¼•åº“å}/_doc/{id}
```

## RestClientæ–‡æ¡£æ“ä½œ

ES å®˜æ–¹æä¾›äº†å„ç§ä¸åŒè¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œç”¨æ¥æ“ä½œ ESã€‚è¿™äº›å®¢æˆ·ç«¯çš„æœ¬è´¨å°±æ˜¯ç»„è£… DSL è¯­å¥ï¼Œé€šè¿‡ http è¯·æ±‚å‘é€ç»™ ESã€‚å®˜æ–¹æ–‡æ¡£åœ°å€ï¼šhttps://www.elastic.co/guide/en/elasticsearch/client/index.html

å…¶ä¸­çš„Java Rest ClientåˆåŒ…æ‹¬ä¸¤ç§ï¼š

- Java Low Level Rest Client
- Java High Level Rest Client

![](https://cdn.xn2001.com/img/2021/20210919234405.png)

æˆ‘ä»¬ä¸‹é¢å­¦ä¹ çš„æ˜¯ **Java HighLevel Rest Client å®¢æˆ·ç«¯ API**

### åˆå§‹åŒ–RestClient

åœ¨ elasticsearch æä¾›çš„ API ä¸­ï¼Œelasticsearch ä¸€åˆ‡äº¤äº’éƒ½å°è£…åœ¨ä¸€ä¸ªåä¸º RestHighLevelClient çš„ç±»ä¸­ï¼Œå¿…é¡»å…ˆå®Œæˆè¿™ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–ï¼Œå»ºç«‹ä¸ elasticsearch çš„è¿æ¥ã€‚

```xml
<dependency>
    <groupId>org.elasticsearch.client</groupId>
    <artifactId>elasticsearch-rest-high-level-client</artifactId>
</dependency>
```

SpringBoot é»˜è®¤çš„ ES ç‰ˆæœ¬æ˜¯ 7.6.2ï¼Œæˆ‘ä»¬éœ€è¦è¦†ç›–é»˜è®¤çš„ESç‰ˆæœ¬

```xml
<properties>
    <java.version>1.8</java.version>
    <elasticsearch.version>7.12.1</elasticsearch.version>
</properties>
```

åˆå§‹åŒ– RestHighLevelClientï¼Œåˆå§‹åŒ–çš„ä»£ç å¦‚ä¸‹ï¼š

```java
RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(
        HttpHost.create("http://192.168.211.128:9200")
));
```

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±» HotelIndexTestï¼Œç„¶åå°†åˆå§‹åŒ–çš„ä»£ç ç¼–å†™åœ¨ `@BeforeEach` æ–¹æ³•

```java
/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/9/19 17:18
 */
public class HotelIndexTest {

    private RestHighLevelClient restHighLevelClient;

    @Test
    void testInit(){
        System.out.println(this.restHighLevelClient);
    }

    @BeforeEach
    void init(){
        this.restHighLevelClient = new RestHighLevelClient(RestClient.builder(
                HttpHost.create("http://192.168.211.128:9200")
        ));
    }

    @AfterEach
    void down() throws IOException {
        this.restHighLevelClient.close();
    }
}
```

### åˆ›å»ºç´¢å¼•åº“

```java
@Test
void createHotelIndex() throws IOException {
    //æŒ‡å®šç´¢å¼•åº“å
    CreateIndexRequest hotel = new CreateIndexRequest("hotel");
    //å†™å…¥JSONæ•°æ®ï¼Œè¿™é‡Œæ˜¯Mappingæ˜ å°„
    hotel.source(HotelConstants.MAPPING_TEMPLATE, XContentType.JSON);
    //åˆ›å»ºç´¢å¼•åº“
    restHighLevelClient.indices().create(hotel, RequestOptions.DEFAULT);
}
```

```java
public class HotelConstants {
    public static String MAPPING_TEMPLATE = "{\n" +
            "  \"mappings\": {\n" +
            "    \"properties\": {\n" +
            "      \"id\": {\n" +
            "        \"type\": \"keyword\"\n" +
            "      },\n" +
            "      \"name\":{\n" +
            "        \"type\": \"text\",\n" +
            "        \"analyzer\": \"ik_max_word\",\n" +
            "        \"copy_to\": \"all\"\n" +
            "      },\n" +
            "      \"address\":{\n" +
            "        \"type\": \"keyword\",\n" +
            "        \"index\": false\n" +
            "      },\n" +
            "      \"price\":{\n" +
            "        \"type\": \"integer\"\n" +
            "      },\n" +
            "      \"score\":{\n" +
            "        \"type\": \"integer\"\n" +
            "      },\n" +
            "      \"brand\":{\n" +
            "        \"type\": \"keyword\",\n" +
            "        \"copy_to\": \"all\"\n" +
            "      },\n" +
            "      \"city\":{\n" +
            "        \"type\": \"keyword\",\n" +
            "        \"copy_to\": \"all\"\n" +
            "      },\n" +
            "      \"starName\":{\n" +
            "        \"type\": \"keyword\"\n" +
            "      },\n" +
            "      \"business\":{\n" +
            "        \"type\": \"keyword\"\n" +
            "      },\n" +
            "      \"location\":{\n" +
            "        \"type\": \"geo_point\"\n" +
            "      },\n" +
            "      \"pic\":{\n" +
            "        \"type\": \"keyword\",\n" +
            "        \"index\": false\n" +
            "      },\n" +
            "      \"all\":{\n" +
            "        \"type\": \"text\",\n" +
            "        \"analyzer\": \"ik_max_word\"\n" +
            "      }\n" +
            "    }\n" +
            "  }\n" +
            "}";
}
```

### åˆ é™¤ç´¢å¼•åº“

```java
@Test
void deleteHotelIndex() throws IOException {
    DeleteIndexRequest hotel = new DeleteIndexRequest("hotel");
    restHighLevelClient.indices().delete(hotel,RequestOptions.DEFAULT);
}
```

### åˆ¤æ–­ç´¢å¼•åº“

```java
@Test
void existHotelIndex() throws IOException {
    GetIndexRequest hotel = new GetIndexRequest("hotel");
    boolean exists = restHighLevelClient.indices().exists(hotel, RequestOptions.DEFAULT);
    System.out.println(exists);
}
```

### æ–°å¢æ–‡æ¡£

```java
/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/9/19 17:18
 */
@SpringBootTest
public class HotelDocumentTest {

    private RestHighLevelClient restHighLevelClient;

    @Autowired
    private IHotelService hotelService;

    @Test
    void testInit(){
        System.out.println(this.restHighLevelClient);
    }

    @Test
    void createHotelIndex() throws IOException {
        Hotel hotel = hotelService.getById(61083L);
        HotelDoc hotelDoc = new HotelDoc(hotel);
        // 1.å‡†å¤‡Requestå¯¹è±¡
        IndexRequest hotelIndex = new IndexRequest("hotel").id(hotelDoc.getId().toString());
        // 2.å‡†å¤‡Jsonæ–‡æ¡£
        hotelIndex.source(JSON.toJSONString(hotelDoc), XContentType.JSON);
        // 3.å‘é€è¯·æ±‚
        restHighLevelClient.index(hotelIndex, RequestOptions.DEFAULT);
    }

    @BeforeEach
    void init(){
        this.restHighLevelClient = new RestHighLevelClient(RestClient.builder(
                HttpHost.create("http://192.168.211.128:9200")
        ));
    }

    @AfterEach
    void down() throws IOException {
        this.restHighLevelClient.close();
    }
}
```

### æŸ¥è¯¢æ–‡æ¡£

```java
@Test
void testGetDocumentById() throws IOException {
    // 1.å‡†å¤‡Request
    GetRequest hotel = new GetRequest("hotel", "61083");
    // 2.å‘é€è¯·æ±‚ï¼Œå¾—åˆ°å“åº”
    GetResponse hotelResponse = restHighLevelClient.get(hotel, RequestOptions.DEFAULT);
    // 3.è§£æå“åº”ç»“æœ
    String hotelDocSourceAsString = hotelResponse.getSourceAsString();
    // 4.jsonè½¬å®ä½“ç±»
    HotelDoc hotelDoc = JSON.parseObject(hotelDocSourceAsString, HotelDoc.class);
    System.out.println(hotelDoc);
}
```

### åˆ é™¤æ–‡æ¡£

```java
@Test
void testDeleteDocumentById() throws IOException {
    DeleteRequest hotel = new DeleteRequest("hotel", "61083");
    restHighLevelClient.delete(hotel,RequestOptions.DEFAULT);
}
```

### ä¿®æ”¹æ–‡æ¡£

å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œä¿®æ”¹æ–‡æ¡£æœ‰ä¸¤ç§æ–¹å¼ï¼š

- å…¨é‡ä¿®æ”¹ï¼šç›´æ¥è¦†ç›–åŸæ¥çš„æ–‡æ¡£
- å¢é‡ä¿®æ”¹ï¼šä¿®æ”¹æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ

åœ¨ RestClient çš„ API ä¸­ï¼Œå…¨é‡ä¿®æ”¹ä¸æ–°å¢çš„ API å®Œå…¨ä¸€è‡´ï¼Œåˆ¤æ–­ä¾æ®æ˜¯ ID

- å¦‚æœæ–°å¢æ—¶ï¼ŒIDå·²ç»å­˜åœ¨ï¼Œåˆ™ä¿®æ”¹
- å¦‚æœæ–°å¢æ—¶ï¼ŒIDä¸å­˜åœ¨ï¼Œåˆ™æ–°å¢

æ‰€ä»¥å…¨é‡ä¿®æ”¹å†™æ³•ä¸æ–°å¢æ–‡æ¡£ä¸€æ ·ï¼Œä¸‹é¢æˆ‘ä»¬ä¸»è¦æ˜¯ä»‹ç»å¢é‡ä¿®æ”¹ã€‚

```java
@Test
void testUpdateDocument() throws IOException {
    // 1.å‡†å¤‡Request
    UpdateRequest request = new UpdateRequest("hotel", "61083");
    // 2.å‡†å¤‡è¯·æ±‚å‚æ•°
    request.doc(
        "price", "952",
        "starName", "å››é’»"
    );
    // 3.å‘é€è¯·æ±‚
    restHighLevelClient.update(request, RequestOptions.DEFAULT);
}
```

### æ‰¹é‡å¯¼å…¥æ–‡æ¡£

æ¡ˆä¾‹éœ€æ±‚ï¼šåˆ©ç”¨ `BulkRequest` æ‰¹é‡å°†æ•°æ®åº“æ•°æ®å¯¼å…¥åˆ°ç´¢å¼•åº“ä¸­ã€‚

- åˆ©ç”¨ mybatis-plus æŸ¥è¯¢é…’åº—æ•°æ®

- å°†æŸ¥è¯¢åˆ°çš„é…’åº—æ•°æ®ï¼ˆHotelï¼‰è½¬æ¢ä¸ºæ–‡æ¡£ç±»å‹æ•°æ®ï¼ˆHotelDocï¼‰

- åˆ©ç”¨ JavaRestClient ä¸­çš„ BulkRequest æ‰¹å¤„ç†ï¼Œå®ç°æ‰¹é‡æ–°å¢æ–‡æ¡£

æ‰¹é‡å¤„ç† BulkRequestï¼Œå…¶æœ¬è´¨å°±æ˜¯å°†å¤šä¸ªæ™®é€šçš„ CRUD è¯·æ±‚ç»„åˆåœ¨ä¸€èµ·å‘é€ã€‚

å› æ­¤Bulkä¸­æ·»åŠ äº†å¤šä¸ªIndexRequestï¼Œå°±æ˜¯æ‰¹é‡æ–°å¢åŠŸèƒ½äº†ã€‚ç¤ºä¾‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210919234350.png)

åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºè‡ªå·±éœ€è¦çš„ä»£ç ï¼Œå¦‚ä¸‹

```java
@Test
void testBulk() throws IOException {
    BulkRequest bulkRequest = new BulkRequest();
    List<Hotel> hotelList = hotelService.list();
    hotelList.forEach(item -> {
        HotelDoc hotelDoc = new HotelDoc(item);
        bulkRequest.add(new IndexRequest("hotel")
                .id(hotelDoc.getId().toString())
                .source(JSON.toJSONString(hotelDoc), XContentType.JSON));
    });
    restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);
}
```

---

æ€»ä¹‹ï¼Œåœ¨ Java ä»£ç ä¸­ï¼Œclient é’ˆå¯¹æ“ä½œç´¢å¼•åº“è¿˜æ˜¯æ–‡æ¡£ï¼ŒåŸºæœ¬éƒ½æ˜¯ä¸€æ ·çš„ä»£ç 

restHighLevelClient.indices().xxxï¼Œä»£è¡¨æ“ä½œç´¢å¼•åº“

restHighLevelClient.xxxï¼Œä»£è¡¨æ“ä½œæ–‡æ¡£

è€Œå…¶ä¸­æ‰€éœ€è¦çš„å‚æ•°ï¼Œæˆ‘ä»¬ç›´æ¥é€šè¿‡ **ctrl+p** è¿™æ ·çš„å¿«æ·é”®å»æŸ¥çœ‹å°±å¯ä»¥ï¼Œä¸éœ€è¦å•ç‹¬è®°ä½ã€‚

## DSLæ–‡æ¡£æŸ¥è¯¢

Elasticsearch æä¾›äº†åŸºäº JSON çš„ DSL([Domain Specific Language](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html))æ¥å®šä¹‰æŸ¥è¯¢ã€‚å¸¸è§çš„æŸ¥è¯¢ç±»å‹åŒ…æ‹¬ï¼š

**æŸ¥è¯¢æ‰€æœ‰**ï¼šæŸ¥è¯¢å‡ºæ‰€æœ‰æ•°æ®ï¼Œä¸€èˆ¬æµ‹è¯•ç”¨ã€‚ä¾‹å¦‚ï¼šmatch_all

**å…¨æ–‡æ£€ç´¢ï¼ˆfull textï¼‰æŸ¥è¯¢**ï¼šåˆ©ç”¨åˆ†è¯å™¨å¯¹ç”¨æˆ·è¾“å…¥å†…å®¹åˆ†è¯ï¼Œç„¶åå»å€’æ’ç´¢å¼•åº“ä¸­åŒ¹é…ã€‚ä¾‹å¦‚ï¼š

- match_query
- multi_match_query

**ç²¾ç¡®æŸ¥è¯¢**ï¼šæ ¹æ®ç²¾ç¡®è¯æ¡å€¼æŸ¥æ‰¾æ•°æ®ï¼Œä¸€èˆ¬æ˜¯æŸ¥æ‰¾ keywordã€æ•°å€¼ã€æ—¥æœŸã€boolean ç­‰ç±»å‹å­—æ®µã€‚ä¾‹å¦‚ï¼š

- ids
- range
- term

**åœ°ç†ï¼ˆgeoï¼‰æŸ¥è¯¢**ï¼šæ ¹æ®ç»çº¬åº¦æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š

- geo_distance
- geo_bounding_box

**å¤åˆï¼ˆcompoundï¼‰æŸ¥è¯¢**ï¼šå¤åˆæŸ¥è¯¢å¯ä»¥å°†ä¸Šè¿°å„ç§æŸ¥è¯¢æ¡ä»¶ç»„åˆèµ·æ¥ï¼Œåˆå¹¶æŸ¥è¯¢æ¡ä»¶ã€‚ä¾‹å¦‚ï¼š

- bool
- function_score

---

```json
// æŸ¥è¯¢æ‰€æœ‰
GET /indexName/_search
{
  "query": {
    "match_all": {
    }
  }
}
```

### å…¨æ–‡æ£€ç´¢

ä½¿ç”¨åœºæ™¯ï¼šå…¨æ–‡æ£€ç´¢æŸ¥è¯¢çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

- å¯¹ç”¨æˆ·æœç´¢çš„å†…å®¹åšåˆ†è¯ï¼Œå¾—åˆ°è¯æ¡
- æ ¹æ®è¯æ¡å»å€’æ’ç´¢å¼•åº“ä¸­åŒ¹é…ï¼Œå¾—åˆ°æ–‡æ¡£id
- æ ¹æ®æ–‡æ¡£idæ‰¾åˆ°æ–‡æ¡£ï¼Œè¿”å›ç»™ç”¨æˆ·

æ¯”è¾ƒå¸¸ç”¨çš„åœºæ™¯åŒ…æ‹¬ï¼š

- å•†åŸçš„è¾“å…¥æ¡†æœç´¢
- ç™¾åº¦è¾“å…¥æ¡†æœç´¢

ä¾‹å¦‚äº¬ä¸œï¼š

![](C:\Users\54656\Desktop\SpringCloud\å®ç”¨ç¯‡\day01-SpringCloud01\èµ„æ–™\å¾®æœåŠ¡æŠ€æœ¯æ ˆ.assets\image-20210721165326938.png)

å› ä¸ºæ˜¯æ‹¿ç€è¯æ¡å»åŒ¹é…ï¼Œå› æ­¤å‚ä¸æœç´¢çš„å­—æ®µä¹Ÿå¿…é¡»æ˜¯å¯åˆ†è¯çš„textç±»å‹çš„å­—æ®µã€‚

å¸¸è§çš„å…¨æ–‡æ£€ç´¢æŸ¥è¯¢åŒ…æ‹¬ï¼š

- match æŸ¥è¯¢ï¼šå•å­—æ®µæŸ¥è¯¢
- multi_match æŸ¥è¯¢ï¼šå¤šå­—æ®µæŸ¥è¯¢ï¼Œä»»æ„ä¸€ä¸ªå­—æ®µç¬¦åˆæ¡ä»¶å°±ç®—ç¬¦åˆæŸ¥è¯¢æ¡ä»¶

match æŸ¥è¯¢è¯­æ³•å¦‚ä¸‹ï¼š

```json
GET /indexName/_search
{
  "query": {
    "match": {
      "FIELD": "TEXT"
    }
  }
}
```

mulit_match æŸ¥è¯¢è¯­æ³•å¦‚ä¸‹ï¼š

```json
GET /indexName/_search
{
  "query": {
    "multi_match": {
      "query": "TEXT",
      "fields": ["FIELD1", " FIELD12"]
    }
  }
}
```

å› ä¸ºæˆ‘ä»¬å°† brandã€nameã€business å€¼éƒ½åˆ©ç”¨ **copy_to** å¤åˆ¶åˆ°äº† **all** å­—æ®µä¸­ï¼Œä½ æ ¹æ®ä¸‰ä¸ªå­—æ®µæœç´¢ï¼Œå’Œæ ¹æ® allå­—æ®µæœç´¢æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚

```json
GET /hotel/_search
{
  "query": {
    "match": {
      "all": "7å¤©é…’åº—"
    }
  }
}
```

```json
GET /hotel/_search
{
  "query": {
    "multi_match": {
      "query": "7å¤©é…’åº—",
      "fields": ["brand","name"]
    }
  }
}
```

**æœç´¢å­—æ®µè¶Šå¤šï¼Œå¯¹æŸ¥è¯¢æ€§èƒ½å½±å“è¶Šå¤§ï¼Œå› æ­¤å»ºè®®é‡‡ç”¨ copy_to å°†å¤šä¸ªå­—æ®µåˆå¹¶ä¸ºä¸€ä¸ªï¼Œç„¶åä½¿ç”¨å•å­—æ®µæŸ¥è¯¢çš„æ–¹å¼ã€‚**

### ç²¾å‡†æŸ¥è¯¢

ç²¾ç¡®æŸ¥è¯¢ä¸€èˆ¬æ˜¯æŸ¥æ‰¾ keywordã€æ•°å€¼ã€æ—¥æœŸã€boolean ç­‰ç±»å‹å­—æ®µã€‚æ‰€ä»¥**ä¸ä¼š**å¯¹æœç´¢æ¡ä»¶åˆ†è¯ã€‚

- termï¼šæ ¹æ®è¯æ¡ç²¾ç¡®å€¼æŸ¥è¯¢
- rangeï¼šæ ¹æ®å€¼çš„èŒƒå›´æŸ¥è¯¢

#### termæŸ¥è¯¢

å› ä¸ºç²¾ç¡®æŸ¥è¯¢çš„å­—æ®µæœæ˜¯ä¸åˆ†è¯çš„å­—æ®µï¼Œå› æ­¤æŸ¥è¯¢çš„æ¡ä»¶ä¹Ÿå¿…é¡»æ˜¯**ä¸åˆ†è¯**çš„è¯æ¡ã€‚æŸ¥è¯¢æ—¶ï¼Œç”¨æˆ·è¾“å…¥çš„å†…å®¹è·Ÿè‡ªåŠ¨å€¼å®Œå…¨åŒ¹é…æ—¶æ‰è®¤ä¸ºç¬¦åˆæ¡ä»¶ã€‚å¦‚æœç”¨æˆ·è¾“å…¥çš„å†…å®¹è¿‡å¤šï¼Œåè€Œæœç´¢ä¸åˆ°æ•°æ®ã€‚

è¯­æ³•è¯´æ˜ï¼š

```json
// termæŸ¥è¯¢
GET /indexName/_search
{
  "query": {
    "term": {
      "FIELD": {
        "value": "VALUE"
      }
    }
  }
}
```

ç¤ºä¾‹ï¼š

```json
GET /hotel/_search
{
  "query": {
    "term": {
      "brand": {
        "value": "7å¤©é…’åº—"
      }
    }
  }
}
```

#### rangeæŸ¥è¯¢

èŒƒå›´æŸ¥è¯¢ï¼Œä¸€èˆ¬åº”ç”¨åœ¨å¯¹æ•°å€¼ç±»å‹åšèŒƒå›´è¿‡æ»¤çš„æ—¶å€™ã€‚æ¯”å¦‚åšä»·æ ¼èŒƒå›´è¿‡æ»¤ã€‚

åŸºæœ¬è¯­æ³•ï¼š

```json
// rangeæŸ¥è¯¢
GET /indexName/_search
{
  "query": {
    "range": {
      "FIELD": {
        "gte": 10, // è¿™é‡Œçš„gteä»£è¡¨å¤§äºç­‰äºï¼Œgtåˆ™ä»£è¡¨å¤§äº
        "lte": 20 // lteä»£è¡¨å°äºç­‰äºï¼Œltåˆ™ä»£è¡¨å°äº
      }
    }
  }
}
```

ç¤ºä¾‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210921182858.png)

ç²¾ç¡®æŸ¥è¯¢å¸¸è§çš„æœ‰å“ªäº›ï¼Ÿ

- term æŸ¥è¯¢ï¼šæ ¹æ®è¯æ¡ç²¾ç¡®åŒ¹é…ï¼Œä¸€èˆ¬æœç´¢ keyword ç±»å‹ã€æ•°å€¼ç±»å‹ã€å¸ƒå°”ç±»å‹ã€æ—¥æœŸç±»å‹å­—æ®µ
- range æŸ¥è¯¢ï¼šæ ¹æ®æ•°å€¼èŒƒå›´æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯æ•°å€¼ã€æ—¥æœŸçš„èŒƒå›´

### åœ°ç†åæ ‡æŸ¥è¯¢

åœ°ç†åæ ‡æŸ¥è¯¢ï¼Œå…¶å®å°±æ˜¯æ ¹æ®ç»çº¬åº¦æŸ¥è¯¢ï¼Œå®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html

å¸¸è§çš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š

- æºç¨‹ï¼šæœç´¢æˆ‘é™„è¿‘çš„é…’åº—
- æ»´æ»´ï¼šæœç´¢æˆ‘é™„è¿‘çš„å‡ºç§Ÿè½¦
- å¾®ä¿¡ï¼šæœç´¢æˆ‘é™„è¿‘çš„äºº

é™„è¿‘çš„é…’åº—ï¼š

![](https://cdn.xn2001.com/img/2021/20210921183030.png) 

é™„è¿‘çš„è½¦ï¼š

![](https://cdn.xn2001.com/img/2021/20210921183033.png) 

> çŸ©å½¢èŒƒå›´æŸ¥è¯¢

çŸ©å½¢èŒƒå›´æŸ¥è¯¢ï¼Œä¹Ÿå°±æ˜¯ `geo_bounding_box` æŸ¥è¯¢ï¼ŒæŸ¥è¯¢åæ ‡è½åœ¨æŸä¸ªçŸ©å½¢èŒƒå›´çš„æ‰€æœ‰æ–‡æ¡£

![](https://cdn.xn2001.com/img/2021/20210921183124.gif)

æŸ¥è¯¢æ—¶ï¼Œéœ€è¦æŒ‡å®šçŸ©å½¢çš„**å·¦ä¸Š**ã€**å³ä¸‹**ä¸¤ä¸ªç‚¹çš„åæ ‡ï¼Œç„¶åç”»å‡ºä¸€ä¸ªçŸ©å½¢ï¼Œè½åœ¨è¯¥çŸ©å½¢å†…çš„éƒ½æ˜¯ç¬¦åˆæ¡ä»¶çš„ç‚¹ã€‚

```json
// geo_bounding_boxæŸ¥è¯¢
GET /indexName/_search
{
  "query": {
    "geo_bounding_box": {
      "FIELD": {
        "top_left": { // å·¦ä¸Šç‚¹
          "lat": 31.1,
          "lon": 121.5
        },
        "bottom_right": { // å³ä¸‹ç‚¹
          "lat": 30.9,
          "lon": 121.7
        }
      }
    }
  }
}
```

> é™„è¿‘æŸ¥è¯¢

é™„è¿‘æŸ¥è¯¢ï¼Œä¹Ÿå«åšè·ç¦»æŸ¥è¯¢ï¼ˆgeo_distanceï¼‰ï¼šæŸ¥è¯¢åˆ°æŒ‡å®šä¸­å¿ƒç‚¹å°äºæŸä¸ªè·ç¦»å€¼çš„æ‰€æœ‰æ–‡æ¡£

åœ¨åœ°å›¾ä¸Šæ‰¾ä¸€ä¸ªç‚¹ä½œä¸ºåœ†å¿ƒï¼Œä»¥æŒ‡å®šè·ç¦»ä¸ºåŠå¾„ï¼Œç”»ä¸€ä¸ªåœ†ï¼Œè½åœ¨åœ†å†…çš„åæ ‡éƒ½ç®—ç¬¦åˆæ¡ä»¶ï¼š

![](https://cdn.xn2001.com/img/2021/20210921183215.gif)

```json
// geo_distance æŸ¥è¯¢
GET /indexName/_search
{
  "query": {
    "geo_distance": {
      "distance": "15km", // åŠå¾„
      "FIELD": "31.21,121.5" // åœ†å¿ƒ
    }
  }
}
```

æˆ‘ä»¬å…ˆæœç´¢é™†å®¶å˜´é™„è¿‘15kmçš„é…’åº—

![](https://cdn.xn2001.com/img/2021/20210921183228.png)

å‘ç°å…±æœ‰47å®¶é…’åº—ï¼Œç„¶åæŠŠåŠå¾„ç¼©çŸ­åˆ°3å…¬é‡Œ

![](https://cdn.xn2001.com/img/2021/20210921183240.png)

å¯ä»¥å‘ç°ï¼Œæœç´¢åˆ°çš„é…’åº—æ•°é‡å‡å°‘åˆ°äº†5å®¶ã€‚

```json
GET /hotel/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "_geo_distance" : {
          "location": "31.034661,121.612282", //åœ†å¿ƒ
          "order" : "asc", //æ’åº
          "unit" : "km" //å•ä½
      }
    }
  ]
}
```

ç»“æœä¸ºï¼š

```json
"hits" : [
    {
        "_index" : "hotel",
        "_type" : "_doc",
        "_id" : "2056298828",
        "_score" : null,
        "_source" : {
            ...
        },
        "sort" : [
            4.8541199685347785 //è¿™é‡Œçš„ç»“æœä¸ºç¦»åœ†å¿ƒçš„è·ç¦»
        ]
    },
```

æ³¨æ„ï¼šè¾“å‡ºç»“æœä¸­çš„ **sort** ä¸ºè·ç¦»ï¼Œæ¯”è¾ƒå¸¸ç”¨ã€‚

æ’åºå®Œæˆåï¼Œé¡µé¢è¿˜è¦è·å–æˆ‘é™„è¿‘æ¯ä¸ªé…’åº—çš„å…·ä½“**è·ç¦»**å€¼ï¼Œè¿™ä¸ªå€¼åœ¨å“åº”ç»“æœä¸­æ˜¯ç‹¬ç«‹çš„ï¼š

![](https://cdn.xn2001.com/img/2021/20211019011334.png)

### å¤åˆæŸ¥è¯¢

å¤åˆï¼ˆcompoundï¼‰æŸ¥è¯¢ï¼šå¤åˆæŸ¥è¯¢å¯ä»¥å°†å…¶å®ƒç®€å•æŸ¥è¯¢ç»„åˆèµ·æ¥ï¼Œå®ç°æ›´å¤æ‚çš„æœç´¢é€»è¾‘ã€‚

- fuction scoreï¼šç®—åˆ†å‡½æ•°æŸ¥è¯¢ï¼Œå¯ä»¥æ§åˆ¶æ–‡æ¡£ç›¸å…³æ€§ç®—åˆ†ï¼Œæ§åˆ¶æ–‡æ¡£æ’å
- bool queryï¼šå¸ƒå°”æŸ¥è¯¢ï¼Œåˆ©ç”¨é€»è¾‘å…³ç³»ç»„åˆå¤šä¸ªå…¶å®ƒçš„æŸ¥è¯¢ï¼Œå®ç°å¤æ‚æœç´¢

### ç›¸å…³æ€§ç®—åˆ†

> è¿™éƒ¨åˆ†å†…å®¹ä½œä¸ºäº†è§£å³å¯ã€‚

å½“æˆ‘ä»¬åˆ©ç”¨ match æŸ¥è¯¢æ—¶ï¼Œæ–‡æ¡£ç»“æœä¼šæ ¹æ®ä¸æœç´¢è¯æ¡çš„å…³è”åº¦æ‰“åˆ†ï¼ˆ_scoreï¼‰ï¼Œè¿”å›ç»“æœæ—¶æŒ‰ç…§åˆ†å€¼é™åºæ’åˆ—ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœç´¢ "è™¹æ¡¥å¦‚å®¶"ï¼Œç»“æœå¦‚ä¸‹ï¼š

```json
[
  {
    "_score" : 17.850193,
    "_source" : {
      "name" : "è™¹æ¡¥å¦‚å®¶é…’åº—çœŸä¸é”™",
    }
  },
  {
    "_score" : 12.259849,
    "_source" : {
      "name" : "å¤–æ»©å¦‚å®¶é…’åº—çœŸä¸é”™",
    }
  },
  {
    "_score" : 11.91091,
    "_source" : {
      "name" : "è¿ªå£«å°¼å¦‚å®¶é…’åº—çœŸä¸é”™",
    }
  }
]
```

elasticsearch æ—©æœŸä½¿ç”¨çš„æ‰“åˆ†ç®—æ³•æ˜¯ **TF-IDF ç®—æ³•**ï¼Œå…¬å¼å¦‚ä¸‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210921205752.png)

åœ¨åæ¥çš„5.1ç‰ˆæœ¬å‡çº§ä¸­ï¼Œelasticsearch å°†ç®—æ³•æ”¹è¿›ä¸º **BM25 ç®—æ³•**ï¼Œå…¬å¼å¦‚ä¸‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210921205757.png)

TF-IDF ç®—æ³•æœ‰ä¸€å„ç¼ºé™·ï¼Œå°±æ˜¯è¯æ¡é¢‘ç‡è¶Šé«˜ï¼Œæ–‡æ¡£å¾—åˆ†ä¹Ÿä¼šè¶Šé«˜ï¼Œå•ä¸ªè¯æ¡å¯¹æ–‡æ¡£å½±å“è¾ƒå¤§ã€‚è€Œ BM25 åˆ™ä¼šè®©å•ä¸ªè¯æ¡çš„ç®—åˆ†æœ‰ä¸€ä¸ªä¸Šé™ï¼Œæ›²çº¿æ›´åŠ å¹³æ»‘ï¼š

![](https://cdn.xn2001.com/img/2021/20210921205831.png)

### ç®—åˆ†å‡½æ•°æŸ¥è¯¢

æ ¹æ®ç›¸å…³åº¦æ‰“åˆ†æ˜¯æ¯”è¾ƒåˆç†çš„éœ€æ±‚ï¼Œä½†æœ‰æ—¶å€™ä¹Ÿä¸èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚

ä»¥ç™¾åº¦ä¸ºä¾‹ï¼Œä½ æœç´¢çš„ç»“æœä¸­ï¼Œå¹¶ä¸æ˜¯ç›¸å…³åº¦è¶Šé«˜æ’åè¶Šé å‰ï¼Œè€Œæ˜¯è°ç»™çš„é’±å¤šæ’åå°±è¶Šé å‰ã€‚

**è¦æƒ³è®¤ä¸ºæ§åˆ¶ç›¸å…³æ€§ç®—åˆ†ï¼Œå°±éœ€è¦åˆ©ç”¨ elasticsearch ä¸­çš„ function score æŸ¥è¯¢äº†ã€‚**

![](https://cdn.xn2001.com/img/2021/20210921210256.png)

function score æŸ¥è¯¢ä¸­åŒ…å«å››éƒ¨åˆ†å†…å®¹ï¼š

- **åŸå§‹æŸ¥è¯¢**æ¡ä»¶ï¼šquery éƒ¨åˆ†ï¼ŒåŸºäºè¿™ä¸ªæ¡ä»¶æœç´¢æ–‡æ¡£ï¼Œå¹¶ä¸”åŸºäºBM25ç®—æ³•ç»™æ–‡æ¡£æ‰“åˆ†ï¼Œ**åŸå§‹ç®—åˆ†**ï¼ˆquery score)
- **è¿‡æ»¤æ¡ä»¶**ï¼šfilter éƒ¨åˆ†ï¼Œç¬¦åˆè¯¥æ¡ä»¶çš„æ–‡æ¡£æ‰ä¼š**é‡æ–°ç®—åˆ†**
- **ç®—åˆ†å‡½æ•°**ï¼šç¬¦åˆ filter æ¡ä»¶çš„æ–‡æ¡£è¦æ ¹æ®è¿™ä¸ªå‡½æ•°åšè¿ç®—ï¼Œå¾—åˆ°çš„**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰ï¼Œæœ‰å››ç§å‡½æ•°
  - weightï¼šå‡½æ•°ç»“æœæ˜¯å¸¸é‡
  - field_value_factorï¼šä»¥æ–‡æ¡£ä¸­çš„æŸä¸ªå­—æ®µå€¼ä½œä¸ºå‡½æ•°ç»“æœ
  - random_scoreï¼šä»¥éšæœºæ•°ä½œä¸ºå‡½æ•°ç»“æœ
  - script_scoreï¼šè‡ªå®šä¹‰ç®—åˆ†å‡½æ•°ç®—æ³•
- **è¿ç®—æ¨¡å¼**ï¼šç®—åˆ†å‡½æ•°çš„ç»“æœã€åŸå§‹æŸ¥è¯¢çš„ç›¸å…³æ€§ç®—åˆ†ï¼Œä¸¤è€…ä¹‹é—´çš„è¿ç®—æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼š
  - multiplyï¼šç›¸ä¹˜
  - replaceï¼šç”¨ function score æ›¿æ¢ query score
  - sumã€avgã€maxã€min

function score çš„è¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1. æ ¹æ®**åŸå§‹æ¡ä»¶**æŸ¥è¯¢æœç´¢æ–‡æ¡£ï¼Œå¹¶ä¸”è®¡ç®—ç›¸å…³æ€§ç®—åˆ†ï¼Œç§°ä¸º**åŸå§‹ç®—åˆ†**ï¼ˆquery scoreï¼‰
2. æ ¹æ®**è¿‡æ»¤æ¡ä»¶**ï¼Œè¿‡æ»¤æ–‡æ¡£
3. ç¬¦åˆ**è¿‡æ»¤æ¡ä»¶**çš„æ–‡æ¡£ï¼ŒåŸºäº**ç®—åˆ†å‡½æ•°**è¿ç®—ï¼Œå¾—åˆ°**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰
4. å°†**åŸå§‹ç®—åˆ†**ï¼ˆquery scoreï¼‰å’Œ**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰åŸºäº**è¿ç®—æ¨¡å¼**åšè¿ç®—ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœï¼Œä½œä¸ºç›¸å…³æ€§ç®—åˆ†ã€‚

å› æ­¤ï¼Œå…¶ä¸­çš„å…³é”®ç‚¹æ˜¯

- è¿‡æ»¤æ¡ä»¶ï¼šå†³å®šå“ªäº›æ–‡æ¡£çš„ç®—åˆ†è¢«ä¿®æ”¹
- ç®—åˆ†å‡½æ•°ï¼šå†³å®šå‡½æ•°ç®—åˆ†çš„ç®—æ³•
- è¿ç®—æ¨¡å¼ï¼šå†³å®šæœ€ç»ˆç®—åˆ†ç»“æœ

ä¾‹å¦‚ï¼šæˆ‘ä»¬ç»™â€œå¦‚å®¶â€è¿™ä¸ªå“ç‰Œçš„é…’åº—æ’åé å‰ä¸€äº›

```json
GET /hotel/_search
{
  "query": {
    "function_score": {
      "query": {  .... }, // åŸå§‹æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯ä»»æ„æ¡ä»¶
      "functions": [ // ç®—åˆ†å‡½æ•°
        {
          "filter": { // æ»¡è¶³çš„æ¡ä»¶ï¼Œå“ç‰Œå¿…é¡»æ˜¯å¦‚å®¶
            "term": {
              "brand": "å¦‚å®¶"
            }
          },
          "weight": 10 // ç®—åˆ†æƒé‡ä¸º10
        }
      ],
      "boost_mode": "sum" // åŠ æƒæ¨¡å¼ï¼Œæ±‚å’Œ
    }
  }
}
```

æµ‹è¯•ï¼Œåœ¨æœªæ·»åŠ ç®—åˆ†å‡½æ•°æ—¶ï¼Œå¦‚å®¶å¾—åˆ†å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20210921231508.png)

æ·»åŠ äº†ç®—åˆ†å‡½æ•°åï¼Œå¦‚å®¶å¾—åˆ†å°±æå‡äº†

![](https://cdn.xn2001.com/img/2021/20210921231513.png)

### å¸ƒå°”æŸ¥è¯¢

å¸ƒå°”æŸ¥è¯¢æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæŸ¥è¯¢å­å¥çš„ç»„åˆï¼Œæ¯ä¸€ä¸ªå­å¥å°±æ˜¯ä¸€ä¸ª**å­æŸ¥è¯¢**ã€‚å­æŸ¥è¯¢çš„ç»„åˆæ–¹å¼æœ‰

- mustï¼šå¿…é¡»åŒ¹é…æ¯ä¸ªå­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œä¸â€
- shouldï¼šé€‰æ‹©æ€§åŒ¹é…å­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œæˆ–â€
- must_notï¼šå¿…é¡»ä¸åŒ¹é…ï¼Œ**ä¸å‚ä¸ç®—åˆ†**ï¼Œç±»ä¼¼â€œéâ€
- filterï¼šå¿…é¡»åŒ¹é…ï¼Œ**ä¸å‚ä¸ç®—åˆ†**

æ¯”å¦‚åœ¨æœç´¢é…’åº—æ—¶ï¼Œé™¤äº†å…³é”®å­—æœç´¢å¤–ï¼Œæˆ‘ä»¬è¿˜å¯èƒ½æ ¹æ®å“ç‰Œã€ä»·æ ¼ã€åŸå¸‚ç­‰å­—æ®µåšè¿‡æ»¤

**æ¯ä¸€ä¸ªä¸åŒçš„å­—æ®µï¼Œå…¶æŸ¥è¯¢çš„æ¡ä»¶ã€æ–¹å¼éƒ½ä¸ä¸€æ ·ï¼Œå¿…é¡»æ˜¯å¤šä¸ªä¸åŒçš„æŸ¥è¯¢ï¼Œè€Œè¦ç»„åˆè¿™äº›æŸ¥è¯¢ï¼Œå°±å¿…é¡»ç”¨ boolæŸ¥è¯¢äº†ã€‚**

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœç´¢æ—¶ï¼Œå‚ä¸**æ‰“åˆ†çš„å­—æ®µè¶Šå¤šï¼ŒæŸ¥è¯¢çš„æ€§èƒ½ä¹Ÿè¶Šå·®**ã€‚å› æ­¤è¿™ç§å¤šæ¡ä»¶æŸ¥è¯¢æ—¶ï¼Œå»ºè®®è¿™æ ·åšï¼š

- æœç´¢æ¡†çš„å…³é”®å­—æœç´¢ï¼Œæ˜¯å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œä½¿ç”¨ must æŸ¥è¯¢ï¼Œå‚ä¸ç®—åˆ†
- å…¶å®ƒè¿‡æ»¤æ¡ä»¶ï¼Œé‡‡ç”¨ filter æŸ¥è¯¢ï¼Œä¸å‚ä¸ç®—åˆ†

```json
GET /hotel/_search
{
  "query": {
    "bool": {
      "must": [
        {"term": {"city": "ä¸Šæµ·" }}
      ],
      "should": [
        {"term": {"brand": "çš‡å† å‡æ—¥" }},
        {"term": {"brand": "åç¾è¾¾" }}
      ],
      "must_not": [
        { "range": { "price": { "lte": 500 } }}
      ],
      "filter": [
        { "range": {"score": { "gte": 45 } }}
      ]
    }
  }
}
```

éœ€æ±‚ï¼šæœç´¢åå­—åŒ…å«â€œå¦‚å®¶â€ï¼Œä»·æ ¼ä¸é«˜äº 400ï¼Œåœ¨åæ ‡ 31.21,121.5 å‘¨å›´ 10km èŒƒå›´å†…çš„é…’åº—ã€‚

- åç§°æœç´¢ï¼Œå±äºå…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œåº”è¯¥å‚ä¸ç®—åˆ†ï¼Œæ”¾åˆ° must ä¸­
- ä»·æ ¼ä¸é«˜äº 400ï¼Œç”¨ range æŸ¥è¯¢ï¼Œå±äºè¿‡æ»¤æ¡ä»¶ï¼Œä¸å‚ä¸ç®—åˆ†ï¼Œæ”¾åˆ° must_not ä¸­
- å‘¨å›´ 10km èŒƒå›´å†…ï¼Œç”¨ geo_distance æŸ¥è¯¢ï¼Œå±äºè¿‡æ»¤æ¡ä»¶ï¼Œä¸å‚ä¸ç®—åˆ†ï¼Œæ”¾åˆ° filter ä¸­

![](https://cdn.xn2001.com/img/2021/20210921233252.png)

bool æŸ¥è¯¢çš„å‡ ç§é€»è¾‘å…³ç³»

- mustï¼šå¿…é¡»åŒ¹é…çš„æ¡ä»¶ï¼Œå¯ä»¥ç†è§£ä¸ºâ€œä¸â€
- shouldï¼šé€‰æ‹©æ€§åŒ¹é…çš„æ¡ä»¶ï¼Œå¯ä»¥ç†è§£ä¸ºâ€œæˆ–â€
- must_notï¼šå¿…é¡»ä¸åŒ¹é…çš„æ¡ä»¶ï¼Œä¸å‚ä¸æ‰“åˆ†
- filterï¼šå¿…é¡»åŒ¹é…çš„æ¡ä»¶ï¼Œä¸å‚ä¸æ‰“åˆ†

## æœç´¢ç»“æœå¤„ç†

### æ’åº

elasticsearch é»˜è®¤æ˜¯æ ¹æ®ç›¸å…³åº¦ç®—åˆ†ï¼ˆ_scoreï¼‰æ¥æ’åºï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒè‡ªå®šä¹‰æ–¹å¼å¯¹æœç´¢[ç»“æœæ’åº](https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html)ã€‚å¯ä»¥æ’åºå­—æ®µç±»å‹æœ‰ï¼škeyword ç±»å‹ã€æ•°å€¼ç±»å‹ã€åœ°ç†åæ ‡ç±»å‹ã€æ—¥æœŸç±»å‹ç­‰

keywordã€æ•°å€¼ã€æ—¥æœŸç±»å‹æ’åºçš„è¯­æ³•åŸºæœ¬ä¸€è‡´ã€‚

```json
GET /indexName/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "FIELD": "desc"  // æ’åºå­—æ®µã€æ’åºæ–¹å¼ASCã€DESC
    }
  ]
}
```

æ’åºæ¡ä»¶æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å†™å¤šä¸ªæ’åºæ¡ä»¶ã€‚æŒ‰ç…§å£°æ˜çš„é¡ºåºï¼Œå½“ç¬¬ä¸€ä¸ªæ¡ä»¶ç›¸ç­‰æ—¶ï¼Œå†æŒ‰ç…§ç¬¬äºŒä¸ªæ¡ä»¶æ’åºã€‚

éœ€æ±‚æè¿°ï¼šé…’åº—æ•°æ®æŒ‰ç…§ç”¨æˆ·è¯„ä»·ï¼ˆscore)é™åºæ’åºï¼Œè¯„ä»·ç›¸åŒçš„æŒ‰ç…§ä»·æ ¼(price)å‡åºæ’åº

![](https://cdn.xn2001.com/img/2021/20210921233829.png)

åœ°ç†åæ ‡æ’åºç•¥æœ‰ä¸åŒ

```json
GET /indexName/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "_geo_distance" : {
          "FIELD" : "çº¬åº¦ï¼Œç»åº¦", // æ–‡æ¡£ä¸­geo_pointç±»å‹çš„å­—æ®µåã€ç›®æ ‡åæ ‡ç‚¹
          "order" : "asc", // æ’åºæ–¹å¼
          "unit" : "km" // æ’åºçš„è·ç¦»å•ä½
      }
    }
  ]
}
```

```json
GET /hotel/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "_geo_distance" : {
          "location": "31.034661,121.612282", 
          "order" : "asc", 
          "unit" : "km" 
      }
    }
  ]
}
```

> è·å–ä½ çš„ä½ç½®çš„ç»çº¬åº¦çš„æ–¹å¼ï¼šhttps://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat

å‡è®¾æˆ‘çš„ä½ç½®æ˜¯ï¼š31.034661ï¼Œ121.612282ï¼Œå¯»æ‰¾æˆ‘å‘¨å›´è·ç¦»æœ€è¿‘çš„é…’åº—ã€‚

![](https://cdn.xn2001.com/img/2021/20210921233931.png)

### åˆ†é¡µ

elasticsearch é»˜è®¤æƒ…å†µä¸‹åªè¿”å› top10 çš„æ•°æ®ã€‚è€Œå¦‚æœè¦æŸ¥è¯¢æ›´å¤šæ•°æ®å°±éœ€è¦ä¿®æ”¹åˆ†é¡µå‚æ•°äº†ã€‚

elasticsearch é€šè¿‡ä¿®æ”¹ fromã€size å‚æ•°æ¥æ§åˆ¶è¦è¿”å›çš„åˆ†é¡µç»“æœï¼š

- fromï¼šä»ç¬¬å‡ ä¸ªæ–‡æ¡£å¼€å§‹
- sizeï¼šæ€»å…±æŸ¥è¯¢å‡ ä¸ªæ–‡æ¡£

ç±»ä¼¼äºmysqlä¸­çš„`limit ?, ?`

```json
GET /hotel/_search
{
  "query": {
    "match_all": {}
  },
  "from": 0, // åˆ†é¡µå¼€å§‹çš„ä½ç½®ï¼Œé»˜è®¤ä¸º0
  "size": 10, // æœŸæœ›è·å–çš„æ–‡æ¡£æ€»æ•°
  "sort": [
    {"price": "asc"}
  ]
}
```

> æ·±åº¦åˆ†é¡µé—®é¢˜

ç°åœ¨ï¼Œæˆ‘è¦æŸ¥è¯¢990~1000çš„æ•°æ®ï¼ŒæŸ¥è¯¢é€»è¾‘è¦è¿™ä¹ˆå†™

```json
GET /hotel/_search
{
  "query": {
    "match_all": {}
  },
  "from": 990, // åˆ†é¡µå¼€å§‹çš„ä½ç½®ï¼Œé»˜è®¤ä¸º0
  "size": 10, // æœŸæœ›è·å–çš„æ–‡æ¡£æ€»æ•°
  "sort": [
    {"price": "asc"}
  ]
}
```

è¿™é‡Œæ˜¯æŸ¥è¯¢990å¼€å§‹çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ ç¬¬990~ç¬¬1000æ¡ æ•°æ®ã€‚

æ³¨æ„ï¼šelasticsearch å†…éƒ¨åˆ†é¡µæ—¶ï¼Œå¿…é¡»å…ˆæŸ¥è¯¢ 0~1000æ¡ï¼Œç„¶åæˆªå–å…¶ä¸­çš„ 990 ~ 1000 çš„è¿™10æ¡

![](https://cdn.xn2001.com/img/2021/20210921234503.png)

æŸ¥è¯¢TOP1000ï¼Œå¦‚æœ es æ˜¯å•ç‚¹æ¨¡å¼ï¼Œè¿™å¹¶æ— å¤ªå¤§å½±å“ã€‚

ä½†æ˜¯ elasticsearch å°†æ¥ä¸€å®šæ˜¯é›†ç¾¤ï¼Œä¾‹å¦‚æˆ‘é›†ç¾¤æœ‰5ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘è¦æŸ¥è¯¢ TOP1000 çš„æ•°æ®ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªèŠ‚ç‚¹æŸ¥è¯¢200æ¡å°±å¯ä»¥äº†ã€‚èŠ‚ç‚¹Açš„ TOP200ï¼Œåœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æ’åˆ°10000åä»¥å¤–äº†ã€‚

**å› æ­¤è¦æƒ³è·å–æ•´ä¸ªé›†ç¾¤çš„ TOP1000ï¼Œå¿…é¡»å…ˆæŸ¥è¯¢å‡ºæ¯ä¸ªèŠ‚ç‚¹çš„ TOP1000ï¼Œæ±‡æ€»ç»“æœåï¼Œé‡æ–°æ’åï¼Œé‡æ–°æˆªå–  TOP1000ã€‚**

![](https://cdn.xn2001.com/img/2021/20210921234555.png)

**å½“æŸ¥è¯¢åˆ†é¡µæ·±åº¦è¾ƒå¤§æ—¶ï¼Œæ±‡æ€»æ•°æ®è¿‡å¤šï¼Œå¯¹å†…å­˜å’ŒCPUä¼šäº§ç”Ÿéå¸¸å¤§çš„å‹åŠ›ï¼Œå› æ­¤ elasticsearch ä¼šç¦æ­¢from+ size è¶…è¿‡10000çš„è¯·æ±‚ã€‚**

é’ˆå¯¹æ·±åº¦åˆ†é¡µï¼ŒESæä¾›äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œ[å®˜æ–¹æ–‡æ¡£](https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html)ï¼š

- search afterï¼šåˆ†é¡µæ—¶éœ€è¦æ’åºï¼ŒåŸç†æ˜¯ä»ä¸Šä¸€æ¬¡çš„æ’åºå€¼å¼€å§‹ï¼ŒæŸ¥è¯¢ä¸‹ä¸€é¡µæ•°æ®ã€‚å®˜æ–¹æ¨èä½¿ç”¨çš„æ–¹å¼ã€‚
- scrollï¼šåŸç†å°†æ’åºåçš„æ–‡æ¡£idå½¢æˆå¿«ç…§ï¼Œä¿å­˜åœ¨å†…å­˜ã€‚å®˜æ–¹å·²ç»ä¸æ¨èä½¿ç”¨ã€‚

---

åˆ†é¡µæŸ¥è¯¢çš„å¸¸è§å®ç°æ–¹æ¡ˆä»¥åŠä¼˜ç¼ºç‚¹

- `from + size`
  - ä¼˜ç‚¹ï¼šæ”¯æŒéšæœºç¿»é¡µ
  - ç¼ºç‚¹ï¼šæ·±åº¦åˆ†é¡µé—®é¢˜ï¼Œé»˜è®¤æŸ¥è¯¢ä¸Šé™ï¼ˆfrom + sizeï¼‰æ˜¯10000
  - åœºæ™¯ï¼šç™¾åº¦ã€äº¬ä¸œã€è°·æ­Œã€æ·˜å®è¿™æ ·çš„éšæœºç¿»é¡µæœç´¢
- `after search`
  - ä¼˜ç‚¹ï¼šæ²¡æœ‰æŸ¥è¯¢ä¸Šé™ï¼ˆå•æ¬¡æŸ¥è¯¢çš„sizeä¸è¶…è¿‡10000ï¼‰
  - ç¼ºç‚¹ï¼šåªèƒ½å‘åé€é¡µæŸ¥è¯¢ï¼Œä¸æ”¯æŒéšæœºç¿»é¡µ
  - åœºæ™¯ï¼šæ²¡æœ‰éšæœºç¿»é¡µéœ€æ±‚çš„æœç´¢ï¼Œä¾‹å¦‚æ‰‹æœºå‘ä¸‹æ»šåŠ¨ç¿»é¡µ

- `scroll`
  - ä¼˜ç‚¹ï¼šæ²¡æœ‰æŸ¥è¯¢ä¸Šé™ï¼ˆå•æ¬¡æŸ¥è¯¢çš„sizeä¸è¶…è¿‡10000ï¼‰
  - ç¼ºç‚¹ï¼šä¼šæœ‰é¢å¤–å†…å­˜æ¶ˆè€—ï¼Œå¹¶ä¸”æœç´¢ç»“æœæ˜¯éå®æ—¶çš„
  - åœºæ™¯ï¼šæµ·é‡æ•°æ®çš„è·å–å’Œè¿ç§»ã€‚ä»ES7.1å¼€å§‹ä¸æ¨èï¼Œå»ºè®®ç”¨ after searchæ–¹æ¡ˆã€‚

### é«˜äº®

æˆ‘ä»¬åœ¨ç™¾åº¦ï¼Œäº¬ä¸œæœç´¢æ—¶ï¼Œå…³é”®å­—ä¼šå˜æˆçº¢è‰²ï¼Œæ¯”è¾ƒé†’ç›®ï¼Œè¿™å«é«˜äº®æ˜¾ç¤ºï¼š

![](https://cdn.xn2001.com/img/2021/20210921234711.png)

é«˜äº®æ˜¾ç¤ºçš„å®ç°åˆ†ä¸ºä¸¤æ­¥ï¼š

- 1ï¼‰ç»™æ–‡æ¡£ä¸­çš„æ‰€æœ‰å…³é”®å­—éƒ½æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ï¼Œä¾‹å¦‚`<em>`æ ‡ç­¾
- 2ï¼‰é¡µé¢ç»™`<em>`æ ‡ç­¾ç¼–å†™CSSæ ·å¼

```json
GET /hotel/_search
{
  "query": {
    "match": {
      "FIELD": "TEXT" // æŸ¥è¯¢æ¡ä»¶ï¼Œé«˜äº®ä¸€å®šè¦ä½¿ç”¨å…¨æ–‡æ£€ç´¢æŸ¥è¯¢
    }
  },
  "highlight": {
    "fields": { // æŒ‡å®šè¦é«˜äº®çš„å­—æ®µ
      "FIELD": {
        "pre_tags": "<em>",  // ç”¨æ¥æ ‡è®°é«˜äº®å­—æ®µçš„å‰ç½®æ ‡ç­¾
        "post_tags": "</em>" // ç”¨æ¥æ ‡è®°é«˜äº®å­—æ®µçš„åç½®æ ‡ç­¾
      }
    }
  }
}
```

**æ³¨æ„**ï¼š

- é«˜äº®æ˜¯å¯¹å…³é”®å­—é«˜äº®ï¼Œå› æ­¤**æœç´¢æ¡ä»¶å¿…é¡»å¸¦æœ‰å…³é”®å­—**ï¼Œè€Œä¸èƒ½æ˜¯èŒƒå›´è¿™æ ·çš„æŸ¥è¯¢ã€‚
- é»˜è®¤æƒ…å†µä¸‹ï¼Œ**é«˜äº®çš„å­—æ®µï¼Œå¿…é¡»ä¸æœç´¢æŒ‡å®šçš„å­—æ®µä¸€è‡´**ï¼Œå¦åˆ™æ— æ³•é«˜äº®
- å¦‚æœè¦å¯¹éæœç´¢å­—æ®µé«˜äº®ï¼Œåˆ™éœ€è¦æ·»åŠ ä¸€ä¸ªå±æ€§ï¼š`required_field_match=false`

![](https://cdn.xn2001.com/img/2021/20210921234739.png)

> DSL æ€»ä½“ç»“æ„å¦‚ä¸‹ï¼š

![](https://cdn.xn2001.com/img/2021/20210921235330.png)

## RestClientæ–‡æ¡£æŸ¥è¯¢

### å‘èµ·æŸ¥è¯¢è¯·æ±‚

![](https://cdn.xn2001.com/img/2021/20211016170057.png)

```java
/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/10/16 17:05
 */
@SpringBootTest
public class HotelSearchTest {

    private RestHighLevelClient restHighLevelClient;

    @Autowired
    private IHotelService hotelService;

    @Test
    public void match_All() throws IOException {
        SearchRequest request = new SearchRequest("hotel");
        request.source()
                .query(QueryBuilders.matchAllQuery());
        SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
    }

    @BeforeEach
    void init() {
        this.restHighLevelClient = new RestHighLevelClient(RestClient.builder(
                HttpHost.create("http://192.168.211.128:9200")
        ));
    }

    @AfterEach
    void down() throws IOException {
        this.restHighLevelClient.close();
    }
}
```

- ç¬¬ä¸€æ­¥ï¼Œåˆ›å»º`SearchRequest`å¯¹è±¡ï¼ŒæŒ‡å®šç´¢å¼•åº“å
- ç¬¬äºŒæ­¥ï¼Œåˆ©ç”¨`request.source()`æ„å»º DSLï¼ŒDSL ä¸­å¯ä»¥åŒ…å«æŸ¥è¯¢ã€åˆ†é¡µã€æ’åºã€é«˜äº®ç­‰
  - `query()`ï¼šä»£è¡¨æŸ¥è¯¢æ¡ä»¶ï¼Œåˆ©ç”¨ `QueryBuilders.matchAllQuery()` æ„å»ºä¸€ä¸ª match_all æŸ¥è¯¢çš„ DSL
- ç¬¬ä¸‰æ­¥ï¼Œåˆ©ç”¨ `client.search()` å‘é€è¯·æ±‚ï¼Œå¾—åˆ°å“åº”

å…³é”®çš„ API æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ `request.source()`ï¼Œå…¶ä¸­åŒ…å«äº†æŸ¥è¯¢ã€æ’åºã€åˆ†é¡µã€é«˜äº®ç­‰æ‰€æœ‰åŠŸèƒ½

![](https://cdn.xn2001.com/img/2021/20211016170203.png)

å¦ä¸€ä¸ªæ˜¯ `QueryBuilders`ï¼Œå…¶ä¸­åŒ…å« matchã€termã€function_scoreã€bool ç­‰å„ç§æŸ¥è¯¢

![](https://cdn.xn2001.com/img/2021/20211016170234.png)

### è§£ææŸ¥è¯¢å“åº”

![](https://cdn.xn2001.com/img/2021/20211016174631.png)

Elasticsearch è¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼Œç»“æ„åŒ…å«

- `hits`ï¼šå‘½ä¸­çš„ç»“æœ
  - `total`ï¼šæ€»æ¡æ•°ï¼Œå…¶ä¸­çš„valueæ˜¯å…·ä½“çš„æ€»æ¡æ•°å€¼
  - `max_score`ï¼šæ‰€æœ‰ç»“æœä¸­å¾—åˆ†æœ€é«˜çš„æ–‡æ¡£çš„ç›¸å…³æ€§ç®—åˆ†
  - `hits`ï¼šæœç´¢ç»“æœçš„æ–‡æ¡£æ•°ç»„ï¼Œå…¶ä¸­çš„æ¯ä¸ªæ–‡æ¡£éƒ½æ˜¯ä¸€ä¸ª json å¯¹è±¡
    - `_source`ï¼šæ–‡æ¡£ä¸­çš„åŸå§‹æ•°æ®ï¼Œä¹Ÿæ˜¯ json å¯¹è±¡

å› æ­¤ï¼Œæˆ‘ä»¬è§£æå“åº”ç»“æœï¼Œå°±æ˜¯é€å±‚è§£æ JSON å­—ç¬¦ä¸²ï¼Œæµç¨‹å¦‚ä¸‹

- `SearchHits`ï¼šé€šè¿‡ `response.getHits()` è·å–ï¼Œå°±æ˜¯ json ä¸­çš„æœ€å¤–å±‚çš„ hitsï¼Œä»£è¡¨å‘½ä¸­çš„ç»“æœ
  - `SearchHits.getTotalHits().value`ï¼šè·å–æ€»æ¡æ•°ä¿¡æ¯
  - `SearchHits.getHits()`ï¼šè·å– SearchHit æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æ–‡æ¡£æ•°ç»„
    - `SearchHit.getSourceAsString()`ï¼šè·å–æ–‡æ¡£ç»“æœä¸­çš„ `_source`ï¼Œä¹Ÿå°±æ˜¯åŸå§‹çš„ json æ–‡æ¡£æ•°æ®

```java
/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/10/16 17:05
 */
@SpringBootTest
public class HotelSearchTest {

    private RestHighLevelClient restHighLevelClient;

    @Autowired
    private IHotelService hotelService;

    @Test
    public void match_All() throws IOException {
        SearchRequest request = new SearchRequest("hotel");
        request.source()
                .query(QueryBuilders.matchAllQuery());
        SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
        SearchHits searchHits = response.getHits();
        System.out.println("hits.getTotalHits().æ¡æ•° = " + searchHits.getTotalHits().value);
        SearchHit[] hits = searchHits.getHits();
        for (SearchHit hit : hits) {
            String sourceAsString = hit.getSourceAsString();
            HotelDoc hotelDoc = JSON.parseObject(sourceAsString, HotelDoc.class);
            System.out.println(hotelDoc);
        }
    }

    @BeforeEach
    void init() {
        this.restHighLevelClient = new RestHighLevelClient(RestClient.builder(
                HttpHost.create("http://192.168.211.128:9200")
        ));
    }

    @AfterEach
    void down() throws IOException {
        this.restHighLevelClient.close();
    }
}
```

### matchæŸ¥è¯¢

![](https://cdn.xn2001.com/img/2021/20211016182859.png)

```java
@Test
public void matchQuery() throws IOException {
    SearchRequest request = new SearchRequest("hotel");
    request.source()
            .query(QueryBuilders.matchQuery("all","å¦‚å®¶"));
    SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
    SearchHits searchHits = response.getHits();
    System.out.println("hits.getTotalHits().æ¡æ•° = " + searchHits.getTotalHits().value);
    SearchHit[] hits = searchHits.getHits();
    for (SearchHit hit : hits) {
        String sourceAsString = hit.getSourceAsString();
        HotelDoc hotelDoc = JSON.parseObject(sourceAsString, HotelDoc.class);
        System.out.println(hotelDoc);
    }
}

@Test
public void multiMatchQuery() throws IOException {
    SearchRequest request = new SearchRequest("hotel");
    request.source()
            .query(QueryBuilders.multiMatchQuery("å¦‚å®¶","name","brand"));
    SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
    SearchHits searchHits = response.getHits();
    System.out.println("hits.getTotalHits().æ¡æ•° = " + searchHits.getTotalHits().value);
    SearchHit[] hits = searchHits.getHits();
    for (SearchHit hit : hits) {
        String sourceAsString = hit.getSourceAsString();
        HotelDoc hotelDoc = JSON.parseObject(sourceAsString, HotelDoc.class);
        System.out.println(hotelDoc);
    }
}
```

### ç²¾ç¡®æŸ¥è¯¢

 ç²¾ç¡®æŸ¥è¯¢ä¸»è¦æ˜¯ä¸¤è€…

- termï¼šè¯æ¡ç²¾ç¡®åŒ¹é…
- rangeï¼šèŒƒå›´æŸ¥è¯¢

![](https://cdn.xn2001.com/img/2021/20211016192658.png) 

### å¸ƒå°”æŸ¥è¯¢

å¸ƒå°”æŸ¥è¯¢æ˜¯ç”¨ mustã€must_notã€filterç­‰æ–¹å¼ç»„åˆå…¶å®ƒæŸ¥è¯¢ï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20211016192745.png)

```java
@Test
void testBool() throws IOException {
    // 1.å‡†å¤‡Request
    SearchRequest request = new SearchRequest("hotel");
    // 2.å‡†å¤‡DSL
    request.source()
            .query(
                    QueryBuilders.boolQuery()
                            .must(QueryBuilders.termQuery("city", "ä¸Šæµ·"))
                            .filter(QueryBuilders.rangeQuery("price").lte(300))
            );
    // 3.å‘é€è¯·æ±‚
    SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
    // 4.è§£æå“åº”
    SearchHits searchHits = response.getHits();
    System.out.println("hits.getTotalHits().æ¡æ•° = " + searchHits.getTotalHits().value);
    SearchHit[] hits = searchHits.getHits();
    for (SearchHit hit : hits) {
        String sourceAsString = hit.getSourceAsString();
        HotelDoc hotelDoc = JSON.parseObject(sourceAsString, HotelDoc.class);
        System.out.println(hotelDoc);
    }
}
```

### æ’åºã€åˆ†é¡µ

æœç´¢ç»“æœçš„æ’åºå’Œåˆ†é¡µæ˜¯ä¸ query åŒçº§çš„å‚æ•°ï¼Œå› æ­¤åŒæ ·æ˜¯ä½¿ç”¨ `request.source()` æ¥è®¾ç½®ã€‚

å¯¹åº”çš„APIå¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20211016202447.png)

```java
@Test
void testPageAndSort() throws IOException {
    // é¡µç ï¼Œæ¯é¡µå¤§å°
    int page = 1, size = 5;

    // 1.å‡†å¤‡Request
    SearchRequest request = new SearchRequest("hotel");
    // 2.å‡†å¤‡DSL
    // 2.1.query
    request.source().query(QueryBuilders.matchAllQuery());
    // 2.2.æ’åº sort
    request.source().sort("price", SortOrder.ASC);
    // 2.3.åˆ†é¡µ fromã€size
    request.source().from((page - 1) * size).size(5);
    // 3.å‘é€è¯·æ±‚
    SearchResponse response = restHighLevelClient.search(request, RequestOptions.DEFAULT);
    // 4.è§£æå“åº”
    SearchHits searchHits = response.getHits();
    System.out.println("hits.getTotalHits().æ¡æ•° = " + searchHits.getTotalHits().value);
    SearchHit[] hits = searchHits.getHits();
    for (SearchHit hit : hits) {
        String sourceAsString = hit.getSourceAsString();
        HotelDoc hotelDoc = JSON.parseObject(sourceAsString, HotelDoc.class);
        System.out.println(hotelDoc);
    }
}
```

### é«˜äº®

- æŸ¥è¯¢çš„ DSLï¼šå…¶ä¸­é™¤äº†æŸ¥è¯¢æ¡ä»¶ï¼Œè¿˜éœ€è¦æ·»åŠ é«˜äº®æ¡ä»¶ï¼ŒåŒæ ·æ˜¯ä¸ query åŒçº§ã€‚
- ç»“æœè§£æï¼šç»“æœé™¤äº†è¦è§£æ `_source` æ–‡æ¡£æ•°æ®ï¼Œè¿˜è¦è§£æé«˜äº®ç»“æœ

**é«˜äº®è¯·æ±‚çš„æ„å»º API**

![](https://cdn.xn2001.com/img/2021/20211016202707.png)

ä¸Šè¿°ä»£ç çœç•¥äº†æŸ¥è¯¢æ¡ä»¶éƒ¨åˆ†ï¼Œä½†æ˜¯é«˜äº®æŸ¥è¯¢å¿…é¡»ä½¿ç”¨å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œå¹¶ä¸”è¦æœ‰æœç´¢å…³é”®å­—ï¼Œå°†æ¥æ‰å¯ä»¥å¯¹å…³é”®å­—é«˜äº®.

```java
@Test
void testHighlight() throws IOException {
    // 1.å‡†å¤‡Request
    SearchRequest request = new SearchRequest("hotel");
    // 2.å‡†å¤‡DSL
    // 2.1.query
    request.source().query(QueryBuilders.matchQuery("all", "å¦‚å®¶"));
    // 2.2.é«˜äº®
    request.source().highlighter(new HighlightBuilder().field("name").requireFieldMatch(false));
    // 3.å‘é€è¯·æ±‚
    SearchResponse response = client.search(request, RequestOptions.DEFAULT);
    // 4.è§£æå“åº”
    handleResponse(response); //ä»£ç åœ¨ä¸‹æ–‡
}
```

**é«˜äº®ç»“æœè§£æ**

é«˜äº®çš„ç»“æœä¸æŸ¥è¯¢çš„æ–‡æ¡£ç»“æœé»˜è®¤æ˜¯åˆ†ç¦»çš„ï¼Œå¹¶ä¸åœ¨ä¸€èµ·ã€‚

å› æ­¤è§£æé«˜äº®çš„ä»£ç éœ€è¦é¢å¤–å¤„ç†ï¼š

![](https://cdn.xn2001.com/img/2021/20211016202853.png)

- ç¬¬ä¸€æ­¥ï¼šä»ç»“æœä¸­è·å– sourceã€‚`hit.getSourceAsString()`ï¼Œè¿™éƒ¨åˆ†æ˜¯éé«˜äº®ç»“æœï¼Œjson å­—ç¬¦ä¸²ï¼Œéœ€è¦ååºåˆ—ä¸º HotelDoc å¯¹è±¡
- ç¬¬äºŒæ­¥ï¼šè·å–é«˜äº®ç»“æœã€‚`hit.getHighlightFields()`ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ª Mapï¼Œkey æ˜¯é«˜äº®å­—æ®µåç§°ï¼Œå€¼æ˜¯HighlightField å¯¹è±¡ï¼Œä»£è¡¨é«˜äº®å€¼
- ç¬¬ä¸‰æ­¥ï¼šä» map ä¸­æ ¹æ®é«˜äº®å­—æ®µåç§°ï¼Œè·å–é«˜äº®å­—æ®µå€¼å¯¹è±¡ HighlightField
- ç¬¬å››æ­¥ï¼šä» HighlightField ä¸­è·å– Fragmentsï¼Œå¹¶ä¸”è½¬ä¸ºå­—ç¬¦ä¸²ã€‚**è¿™éƒ¨åˆ†æ˜¯çœŸæ­£çš„é«˜äº®å­—ç¬¦ä¸²**
- ç¬¬äº”æ­¥ï¼šç”¨é«˜äº®çš„ç»“æœæ›¿æ¢ HotelDoc ä¸­çš„éé«˜äº®ç»“æœ

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
private void handleResponse(SearchResponse response) {
    // 4.è§£æå“åº”
    SearchHits searchHits = response.getHits();
    // 4.1.è·å–æ€»æ¡æ•°
    long total = searchHits.getTotalHits().value;
    System.out.println("å…±æœç´¢åˆ°" + total + "æ¡æ•°æ®");
    // 4.2.æ–‡æ¡£æ•°ç»„
    SearchHit[] hits = searchHits.getHits();
    // 4.3.éå†
    for (SearchHit hit : hits) {
        // è·å–æ–‡æ¡£source
        String json = hit.getSourceAsString();
        // ååºåˆ—åŒ–
        HotelDoc hotelDoc = JSON.parseObject(json, HotelDoc.class);
        // è·å–é«˜äº®ç»“æœ
        Map<String, HighlightField> highlightFields = hit.getHighlightFields();
        if (!CollectionUtils.isEmpty(highlightFields)) {
            // æ ¹æ®å­—æ®µåè·å–é«˜äº®ç»“æœ
            HighlightField highlightField = highlightFields.get("name");
            if (highlightField != null) {
                // è·å–é«˜äº®å€¼
                String name = highlightField.getFragments()[0].string();
                // è¦†ç›–éé«˜äº®ç»“æœ
                hotelDoc.setName(name);
            }
        }
        System.out.println("hotelDoc = " + hotelDoc);
    }
}
```

### åœ°ç†åæ ‡æŸ¥è¯¢

![](https://cdn.xn2001.com/img/2021/20211019000540.png)

### ç›¸å…³æ€§å¾—åˆ†

function_score æŸ¥è¯¢ç»“æ„å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20211019011433.png)



å¯¹åº”çš„ JavaAPI å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20211019011439.png)

## DSLæ•°æ®èšåˆ

**[èšåˆï¼ˆ](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html)[aggregations](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html)[ï¼‰](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html)**å¯ä»¥è®©æˆ‘ä»¬æå…¶æ–¹ä¾¿çš„å®ç°å¯¹æ•°æ®çš„ç»Ÿè®¡ã€åˆ†æã€è¿ç®—ã€‚

- ä»€ä¹ˆå“ç‰Œçš„æ‰‹æœºæœ€å—æ¬¢è¿ï¼Ÿ
- è¿™äº›æ‰‹æœºçš„å¹³å‡ä»·æ ¼ã€æœ€é«˜ä»·æ ¼ã€æœ€ä½ä»·æ ¼ï¼Ÿ
- è¿™äº›æ‰‹æœºæ¯æœˆçš„é”€å”®æƒ…å†µå¦‚ä½•ï¼Ÿ

åœ¨ Elasticsearch å®ç°è¿™äº›ç»Ÿè®¡åŠŸèƒ½æ¯”æ•°æ®åº“çš„ sql è¦æ–¹ä¾¿çš„å¤šï¼Œè€Œä¸”æŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ï¼Œå¯ä»¥å®ç°è¿‘å®æ—¶æœç´¢æ•ˆæœã€‚

èšåˆå¸¸è§çš„æœ‰ä¸‰ç±»

- **æ¡¶ï¼ˆBucketï¼‰**èšåˆï¼šç”¨æ¥å¯¹æ–‡æ¡£åšåˆ†ç»„
  - TermAggregationï¼šæŒ‰ç…§æ–‡æ¡£å­—æ®µå€¼åˆ†ç»„ï¼Œä¾‹å¦‚æŒ‰ç…§å“ç‰Œå€¼åˆ†ç»„ã€æŒ‰ç…§å›½å®¶åˆ†ç»„
  - Date Histogramï¼šæŒ‰ç…§æ—¥æœŸé˜¶æ¢¯åˆ†ç»„ï¼Œä¾‹å¦‚ä¸€å‘¨ä¸ºä¸€ç»„ï¼Œæˆ–è€…ä¸€æœˆä¸ºä¸€ç»„

- **åº¦é‡ï¼ˆMetricï¼‰**èšåˆï¼šç”¨ä»¥è®¡ç®—ä¸€äº›å€¼ï¼Œæ¯”å¦‚ï¼šæœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ç­‰
  - Avgï¼šæ±‚å¹³å‡å€¼
  - Maxï¼šæ±‚æœ€å¤§å€¼
  - Minï¼šæ±‚æœ€å°å€¼
  - Statsï¼šåŒæ—¶æ±‚ maxã€minã€avgã€sum ç­‰
- **ç®¡é“ï¼ˆpipelineï¼‰**èšåˆï¼šå…¶å®ƒèšåˆçš„ç»“æœä¸ºåŸºç¡€åšèšåˆ

> **æ³¨æ„**ï¼šå‚åŠ èšåˆçš„å­—æ®µå¿…é¡»æ˜¯keywordã€æ—¥æœŸã€æ•°å€¼ã€å¸ƒå°”ç±»å‹

### Bucketèšåˆè¯­æ³•

ä¾‹å¦‚ï¼šæˆ‘ä»¬è¦ç»Ÿè®¡æ‰€æœ‰æ•°æ®ä¸­çš„é…’åº—å“ç‰Œæœ‰å‡ ç§ï¼Œå…¶å®å°±æ˜¯æŒ‰ç…§å“ç‰Œå¯¹æ•°æ®åˆ†ç»„ã€‚æ­¤æ—¶å¯ä»¥æ ¹æ®é…’åº—å“ç‰Œçš„åç§°åšèšåˆï¼Œä¹Ÿå°±æ˜¯ Bucket èšåˆã€‚

```json
GET /hotel/_search
{
  "size": 0,  // è®¾ç½®sizeä¸º0ï¼Œç»“æœä¸­ä¸åŒ…å«æ–‡æ¡£ï¼ŒåªåŒ…å«èšåˆç»“æœ
  "aggs": { // å®šä¹‰èšåˆ
    "brandAgg": { //ç»™èšåˆèµ·ä¸ªåå­—
      "terms": { // èšåˆçš„ç±»å‹ï¼ŒæŒ‰ç…§å“ç‰Œå€¼èšåˆï¼Œæ‰€ä»¥é€‰æ‹©term
        "field": "brand", // å‚ä¸èšåˆçš„å­—æ®µ
        "size": 20 // å¸Œæœ›è·å–çš„èšåˆç»“æœæ•°é‡
      }
    }
  }
}
```

![](https://cdn.xn2001.com/img/2021/20211022184007.png)

é»˜è®¤æƒ…å†µä¸‹ï¼ŒBucket èšåˆä¼šç»Ÿè®¡ Bucket å†…çš„æ–‡æ¡£æ•°é‡ï¼Œè®°ä¸º `_count`ï¼Œå¹¶ä¸”æŒ‰ç…§ `_count` é™åºæ’åºã€‚

æˆ‘ä»¬å¯ä»¥æŒ‡å®š order å±æ€§ï¼Œè‡ªå®šä¹‰èšåˆçš„æ’åºæ–¹å¼

```json
GET /hotel/_search
{
  "size": 0, 
  "aggs": {
    "brandAgg": {
      "terms": {
        "field": "brand",
        "order": {
          "_count": "asc" // æŒ‰ç…§_countå‡åºæ’åˆ—
        },
        "size": 20
      }
    }
  }
}
```

é»˜è®¤æƒ…å†µä¸‹ï¼ŒBucket èšåˆæ˜¯å¯¹ç´¢å¼•åº“çš„æ‰€æœ‰æ–‡æ¡£åšèšåˆï¼Œä½†çœŸå®åœºæ™¯ä¸‹ï¼Œç”¨æˆ·ä¼šè¾“å…¥æœç´¢æ¡ä»¶ï¼Œå› æ­¤èšåˆå¿…é¡»æ˜¯å¯¹æœç´¢ç»“æœèšåˆã€‚é‚£ä¹ˆèšåˆå¿…é¡»æ·»åŠ é™å®šæ¡ä»¶ã€‚

æˆ‘ä»¬å¯ä»¥é™å®šè¦èšåˆçš„æ–‡æ¡£èŒƒå›´ï¼Œåªè¦æ·»åŠ  query æ¡ä»¶å³å¯ï¼›

```json
GET /hotel/_search
{
  "query": {
    "range": {
      "price": {
        "lte": 200 // åªå¯¹200å…ƒä»¥ä¸‹çš„æ–‡æ¡£èšåˆ
      }
    }
  }, 
  "size": 0, 
  "aggs": {
    "brandAgg": {
      "terms": {
        "field": "brand",
        "size": 20
      }
    }
  }
}
```

è¿™æ¬¡ï¼Œèšåˆå¾—åˆ°çš„å“ç‰Œæ˜æ˜¾å˜å°‘äº†

![](https://cdn.xn2001.com/img/2021/20211022184549.png)

### Metricèšåˆè¯­æ³•

ä¸Šé¢ï¼Œæˆ‘ä»¬å¯¹é…’åº—æŒ‰ç…§å“ç‰Œåˆ†ç»„ï¼Œå½¢æˆäº†ä¸€ä¸ªä¸ªæ¡¶ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦å¯¹æ¡¶å†…çš„é…’åº—åšè¿ç®—ï¼Œè·å–æ¯ä¸ªå“ç‰Œçš„ç”¨æˆ·è¯„åˆ†çš„ minã€maxã€avg ç­‰å€¼ã€‚

è¿™å°±è¦ç”¨åˆ° Metric èšåˆäº†ï¼Œä¾‹å¦‚ stats èšåˆï¼šå°±å¯ä»¥è·å– minã€maxã€avg ç­‰ç»“æœ

```json
GET /hotel/_search
{
  "size": 0, 
  "aggs": {
    "brandAgg": { 
      "terms": { 
        "field": "brand", 
        "size": 20
      },
      "aggs": { // æ˜¯brandsèšåˆçš„å­èšåˆï¼Œä¹Ÿå°±æ˜¯åˆ†ç»„åå¯¹æ¯ç»„åˆ†åˆ«è®¡ç®—
        "score_stats": { // èšåˆåç§°
          "stats": { // èšåˆç±»å‹ï¼Œè¿™é‡Œstatså¯ä»¥è®¡ç®—minã€maxã€avgç­‰
            "field": "score" // èšåˆå­—æ®µï¼Œè¿™é‡Œæ˜¯score
          }
        }
      }
    }
  }
}
```

è¿™æ¬¡çš„ score_stats èšåˆæ˜¯åœ¨ brandAgg çš„èšåˆå†…éƒ¨åµŒå¥—çš„å­èšåˆã€‚å› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªæ¡¶åˆ†åˆ«è®¡ç®—ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç»™èšåˆç»“æœåšä¸ªæ’åºï¼Œä¾‹å¦‚æŒ‰ç…§æ¯ä¸ªæ¡¶çš„é…’åº—å¹³å‡åˆ†åšæ’åº

![](https://cdn.xn2001.com/img/2021/20211022184847.png)

## RestAPIæ•°æ®èšåˆ

èšåˆæ¡ä»¶ä¸ query æ¡ä»¶åŒçº§åˆ«ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ `request.source()` æ¥æŒ‡å®šèšåˆæ¡ä»¶

![](https://cdn.xn2001.com/img/2021/20211022190429.png)

èšåˆçš„ç»“æœä¹Ÿä¸æŸ¥è¯¢ç»“æœä¸åŒï¼ŒAPI ä¹Ÿæ¯”è¾ƒç‰¹æ®Šã€‚ä¸è¿‡åŒæ ·æ˜¯ JSON é€å±‚è§£æ

![](https://cdn.xn2001.com/img/2021/20211022190457.png)

```java
@Test
public void testAggregation() throws IOException {
    SearchRequest request = new SearchRequest("hotel");
    request.source().aggregation(AggregationBuilders.terms("brandAgg").field("brand").size(20));
    SearchResponse response = client.search(request, RequestOptions.DEFAULT);
    Terms brandAgg = response.getAggregations().get("brandAgg");
    List<? extends Terms.Bucket> buckets = brandAgg.getBuckets();
    for (Terms.Bucket bucket : buckets) {
        String key = bucket.getKeyAsString();
        System.out.println("key = " + key);
    }
}
```

## è‡ªåŠ¨è¡¥å…¨

å½“ç”¨æˆ·åœ¨æœç´¢æ¡†è¾“å…¥å­—ç¬¦æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æç¤ºå‡ºä¸è¯¥å­—ç¬¦æœ‰å…³çš„æœç´¢é¡¹ï¼Œæç¤ºå®Œæ•´è¯æ¡çš„åŠŸèƒ½ï¼Œå°±æ˜¯è‡ªåŠ¨è¡¥å…¨äº†ã€‚

### æ‹¼éŸ³åˆ†è¯å™¨

å¦‚æœæˆ‘ä»¬éœ€è¦æ ¹æ®æ‹¼éŸ³å­—æ¯æ¥æ¨æ–­ï¼Œå› æ­¤è¦ç”¨åˆ°æ‹¼éŸ³åˆ†è¯åŠŸèƒ½ã€‚

è¦å®ç°æ ¹æ®å­—æ¯åšè¡¥å…¨ï¼Œå°±å¿…é¡»å¯¹æ–‡æ¡£æŒ‰ç…§æ‹¼éŸ³åˆ†è¯ã€‚æ’ä»¶åœ°å€ï¼šhttps://github.com/medcl/elasticsearch-analysis-pinyin

![](https://cdn.xn2001.com/img/2021/20211023015636.png)

ä½¿ç”¨ `docker volume inspect es-plugins` æŸ¥çœ‹æ’ä»¶ç›®å½•ï¼Œå°†ä¸‹è½½çš„æ–‡ä»¶è§£å‹ä¸Šä¼ ï¼Œé‡å¯ Elasticsearch

æµ‹è¯•ç”¨æ³•å¦‚ä¸‹ï¼š

```json
POST /_analyze
{
  "text": "å¦‚å®¶é…’åº—è¿˜ä¸é”™",
  "analyzer": "pinyin"
}
```

ç»“æœï¼š

![](https://cdn.xn2001.com/img/2021/20211023021713.png) 



### è‡ªå®šä¹‰åˆ†è¯å™¨

é»˜è®¤çš„æ‹¼éŸ³åˆ†è¯å™¨ä¼šå°†æ¯ä¸ªæ±‰å­—å•ç‹¬åˆ†ä¸ºæ‹¼éŸ³ï¼Œè€Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯æ¯ä¸ªè¯æ¡å½¢æˆä¸€ç»„æ‹¼éŸ³ï¼Œéœ€è¦å¯¹æ‹¼éŸ³åˆ†è¯å™¨åšä¸ªæ€§åŒ–å®šåˆ¶ï¼Œå½¢æˆè‡ªå®šä¹‰åˆ†è¯å™¨ã€‚

elasticsearch ä¸­åˆ†è¯å™¨ï¼ˆanalyzerï¼‰çš„ç»„æˆåŒ…å«ä¸‰éƒ¨åˆ†ï¼š

- character filtersï¼šåœ¨ tokenizer ä¹‹å‰å¯¹æ–‡æœ¬è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚åˆ é™¤å­—ç¬¦ã€æ›¿æ¢å­—ç¬¦
- tokenizerï¼šå°†æ–‡æœ¬æŒ‰ç…§ä¸€å®šçš„è§„åˆ™åˆ‡å‰²æˆè¯æ¡ï¼ˆtermï¼‰ã€‚ä¾‹å¦‚ keywordï¼Œå°±æ˜¯ä¸åˆ†è¯ï¼›è¿˜æœ‰ ik_smart
- tokenizer filterï¼šå°† tokenizer è¾“å‡ºçš„è¯æ¡åšè¿›ä¸€æ­¥å¤„ç†ã€‚ä¾‹å¦‚å¤§å°å†™è½¬æ¢ã€åŒä¹‰è¯å¤„ç†ã€æ‹¼éŸ³å¤„ç†ç­‰

æ–‡æ¡£åˆ†è¯æ—¶ä¼šä¾æ¬¡ç”±è¿™ä¸‰éƒ¨åˆ†æ¥å¤„ç†æ–‡æ¡£ï¼š

   ![](https://cdn.xn2001.com/img/2021/20211023021451.png)

å£°æ˜è‡ªå®šä¹‰åˆ†è¯å™¨çš„è¯­æ³•å¦‚ä¸‹ï¼š

```json
PUT /test
{
  "settings": {
    "analysis": {
      "analyzer": { // è‡ªå®šä¹‰åˆ†è¯å™¨
        "my_analyzer": {  // åˆ†è¯å™¨åç§°
          "tokenizer": "ik_max_word",
          "filter": "py"
        }
      },
      "filter": { // è‡ªå®šä¹‰tokenizer filter
        "py": { // è¿‡æ»¤å™¨åç§°
          "type": "pinyin", // è¿‡æ»¤å™¨ç±»å‹ï¼Œè¿™é‡Œæ˜¯pinyin
		  "keep_full_pinyin": false,
          "keep_joined_full_pinyin": true,
          "keep_original": true,
          "limit_first_letter_length": 16,
          "remove_duplicated_term": true,
          "none_chinese_pinyin_tokenize": false
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "name": {
        "type": "text",
        "analyzer": "my_analyzer",
        "search_analyzer": "ik_smart"
      }
    }
  }
}
```

æµ‹è¯•

![](https://cdn.xn2001.com/img/2021/20211023021532.png)

æ³¨æ„**ï¼šä¸ºäº†é¿å…æœç´¢åˆ°åŒéŸ³å­—ï¼Œæœç´¢æ—¶ä¸è¦ä½¿ç”¨æ‹¼éŸ³åˆ†è¯å™¨**

![](https://cdn.xn2001.com/img/2021/20211023022355.png)

### è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢

elasticsearch æä¾›äº† [Completion Suggester](https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html) æŸ¥è¯¢æ¥å®ç°è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚è¿™ä¸ªæŸ¥è¯¢ä¼šåŒ¹é…ä»¥ç”¨æˆ·è¾“å…¥å†…å®¹å¼€å¤´çš„è¯æ¡å¹¶è¿”å›ï¼›ä¸ºäº†æé«˜è¡¥å…¨æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå¯¹äºæ–‡æ¡£ä¸­å­—æ®µçš„ç±»å‹æœ‰ä¸€äº›çº¦æŸ

- å‚ä¸è¡¥å…¨æŸ¥è¯¢çš„å­—æ®µå¿…é¡»æ˜¯ completion ç±»å‹ã€‚

- å­—æ®µçš„å†…å®¹ä¸€èˆ¬æ˜¯ç”¨æ¥è¡¥å…¨çš„å¤šä¸ªè¯æ¡å½¢æˆçš„æ•°ç»„ã€‚

```json
// åˆ›å»ºç´¢å¼•åº“
PUT test
{
  "mappings": {
    "properties": {
      "title":{
        "type": "completion"
      }
    }
  }
}
```

ç„¶åæ’å…¥ä¸‹é¢çš„æ•°æ®

```json
// ç¤ºä¾‹æ•°æ®
POST test/_doc
{
  "title": ["Sony", "WH-1000XM3"]
}
POST test/_doc
{
  "title": ["SK-II", "PITERA"]
}
POST test/_doc
{
  "title": ["Nintendo", "switch"]
}
```

æŸ¥è¯¢çš„ DSL è¯­å¥å¦‚ä¸‹

```json
// è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢
GET /test/_search
{
  "suggest": {
    "title_suggest": {
      "text": "s", // å…³é”®å­—
      "completion": {
        "field": "title", // è¡¥å…¨æŸ¥è¯¢çš„å­—æ®µ
        "skip_duplicates": true, // è·³è¿‡é‡å¤çš„
        "size": 10 // è·å–å‰10æ¡ç»“æœ
      }
    }
  }
}
```

ä¾‹å¦‚ä¸€ä¸ªé…’åº—çš„ç´¢å¼•åº“å®Œæ•´æ¡ˆä¾‹

```json
// é…’åº—æ•°æ®ç´¢å¼•åº“
PUT /hotel
{
  "settings": {
    "analysis": {
      "analyzer": {
        "text_anlyzer": {
          "tokenizer": "ik_max_word",
          "filter": "py"
        },
        "completion_analyzer": {
          "tokenizer": "keyword",
          "filter": "py"
        }
      },
      "filter": {
        "py": {
          "type": "pinyin",
          "keep_full_pinyin": false,
          "keep_joined_full_pinyin": true,
          "keep_original": true,
          "limit_first_letter_length": 16,
          "remove_duplicated_term": true,
          "none_chinese_pinyin_tokenize": false
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id":{
        "type": "keyword"
      },
      "name":{
        "type": "text",
        "analyzer": "text_anlyzer",
        "search_analyzer": "ik_smart",
        "copy_to": "all"
      },
      "address":{
        "type": "keyword",
        "index": false
      },
      "price":{
        "type": "integer"
      },
      "score":{
        "type": "integer"
      },
      "brand":{
        "type": "keyword",
        "copy_to": "all"
      },
      "city":{
        "type": "keyword"
      },
      "starName":{
        "type": "keyword"
      },
      "business":{
        "type": "keyword",
        "copy_to": "all"
      },
      "location":{
        "type": "geo_point"
      },
      "pic":{
        "type": "keyword",
        "index": false
      },
      "all":{
        "type": "text",
        "analyzer": "text_anlyzer",
        "search_analyzer": "ik_smart"
      },
      "suggestion":{
          "type": "completion",
          "analyzer": "completion_analyzer"
      }
    }
  }
}
```

### JavaAPI

![](https://cdn.xn2001.com/img/2021/20211025113007.png)



è§£æå“åº”çš„ä»£ç å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2021/20211025113011.png)

## æ•°æ®åŒæ­¥

elasticsearch ä¸­çš„æ•°æ®æ¥è‡ªäº mysq læ•°æ®åº“ï¼Œå› æ­¤ mysql æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œelasticsearch ä¹Ÿå¿…é¡»è·Ÿç€æ”¹å˜ï¼Œè¿™ä¸ªå°±æ˜¯ elasticsearch ä¸ mysql ä¹‹é—´çš„**æ•°æ®åŒæ­¥**



![](https://cdn.xn2001.com/img/2021/20211025163219.png)

å¸¸è§çš„æ•°æ®åŒæ­¥æ–¹æ¡ˆæœ‰ä¸‰ç§

- åŒæ­¥è°ƒç”¨
- å¼‚æ­¥é€šçŸ¥
- ç›‘å¬ binlog

### åŒæ­¥è°ƒç”¨

æ–¹æ¡ˆä¸€ï¼šåŒæ­¥è°ƒç”¨

![](https://cdn.xn2001.com/img/2021/20211025163313.png)

- hotel-demoå¯¹å¤–æä¾›æ¥å£ï¼Œç”¨æ¥ä¿®æ”¹ elasticsearch ä¸­çš„æ•°æ®
- é…’åº—ç®¡ç†æœåŠ¡åœ¨å®Œæˆæ•°æ®åº“æ“ä½œåï¼Œç›´æ¥è°ƒç”¨ hotel-demo æä¾›çš„æ¥å£

### å¼‚æ­¥é€šçŸ¥

æ–¹æ¡ˆäºŒï¼šå¼‚æ­¥é€šçŸ¥

![](https://cdn.xn2001.com/img/2021/20211025163346.png)

- hotel-admin å¯¹ mysql æ•°æ®åº“æ•°æ®å®Œæˆå¢ã€åˆ ã€æ”¹åï¼Œå‘é€ MQ æ¶ˆæ¯
- hotel-demoç›‘å¬ MQï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯åå®Œæˆ elasticsearch æ•°æ®ä¿®æ”¹

### ç›‘å¬binlog

æ–¹æ¡ˆä¸‰ï¼šç›‘å¬binlog

![](https://cdn.xn2001.com/img/2021/20211025163428.png)

- mysql å¼€å¯ binlog åŠŸèƒ½
- mysql å®Œæˆå¢ã€åˆ ã€æ”¹æ“ä½œéƒ½ä¼šè®°å½•åœ¨ binlog ä¸­
- hotel-demo åŸºäºcanal ç›‘å¬ binlog å˜åŒ–ï¼Œå®æ—¶æ›´æ–° elasticsearch ä¸­çš„å†…å®¹

### ä¼˜ç¼ºç‚¹

æ–¹å¼ä¸€ï¼šåŒæ­¥è°ƒç”¨

- ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç²—æš´
- ç¼ºç‚¹ï¼šä¸šåŠ¡è€¦åˆåº¦é«˜

æ–¹å¼äºŒï¼šå¼‚æ­¥é€šçŸ¥

- ä¼˜ç‚¹ï¼šä½è€¦åˆï¼Œå®ç°éš¾åº¦ä¸€èˆ¬
- ç¼ºç‚¹ï¼šä¾èµ– mq çš„å¯é æ€§

æ–¹å¼ä¸‰ï¼šç›‘å¬binlog

- ä¼˜ç‚¹ï¼šå®Œå…¨è§£é™¤æœåŠ¡é—´è€¦åˆ
- ç¼ºç‚¹ï¼šå¼€å¯ binlog å¢åŠ æ•°æ®åº“è´Ÿæ‹…ã€å®ç°å¤æ‚åº¦é«˜

### å®ç°æ–¹å¼

æˆ‘ä»¬ä»¥**å¼‚æ­¥é€šçŸ¥**ä¸ºä¾‹ï¼Œä½¿ç”¨ MQ æ¶ˆæ¯ä¸­é—´ä»¶

MQç»“æ„å¦‚å›¾ï¼š

![](https://cdn.xn2001.com/img/2021/20211025163734.png)

**å¼•å…¥ä¾èµ–**ï¼Œåœ¨ hotel-adminã€hotel-demo ä¸­å¼•å…¥ rabbitmq çš„ä¾èµ–ï¼š

```xml
<!--amqp-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

**å£°æ˜é˜Ÿåˆ—äº¤æ¢æœº**

```java
public class MQConstants {
    /**
     * äº¤æ¢æœº
     */
    public final static String HOTEL_EXCHANGE = "hotel.topic";
    /**
     * ç›‘å¬æ–°å¢å’Œä¿®æ”¹çš„é˜Ÿåˆ—
     */
    public final static String HOTEL_INSERT_QUEUE = "hotel.insert.queue";
    /**
     * ç›‘å¬åˆ é™¤çš„é˜Ÿåˆ—
     */
    public final static String HOTEL_DELETE_QUEUE = "hotel.delete.queue";
    /**
     * æ–°å¢æˆ–ä¿®æ”¹çš„RoutingKey
     */
    public final static String HOTEL_INSERT_KEY = "hotel.insert";
    /**
     * åˆ é™¤çš„RoutingKey
     */
    public final static String HOTEL_DELETE_KEY = "hotel.delete";
}
```

æ¶ˆæ¯æ¥æ”¶æ–¹


```java
@Configuration
public class MqConfig {
    @Bean
    public TopicExchange topicExchange() {
        return new TopicExchange(MqConstants.HOTEL_EXCHANGE, true, false);
    }

    @Bean
    public Queue insertQueue() {
        return new Queue(MqConstants.HOTEL_INSERT_QUEUE, true);
    }

    @Bean
    public Queue deleteQueue() {
        return new Queue(MqConstants.HOTEL_DELETE_QUEUE, true);
    }

    @Bean
    public Binding insertQueueBinding() {
        return BindingBuilder.bind(insertQueue()).to(topicExchange()).with(MqConstants.HOTEL_INSERT_KEY);
    }

    @Bean
    public Binding deleteQueueBinding() {
        return BindingBuilder.bind(deleteQueue()).to(topicExchange()).with(MqConstants.HOTEL_DELETE_KEY);
    }
}
```

æ¶ˆæ¯å‘é€æ–¹

```java
rabbitTemplate.convertAndSend(MQConstants.HOTEL_EXCHANGE, MQConstants.HOTEL_INSERT_KEY, hotel.getId());

rabbitTemplate.convertAndSend(MQConstants.HOTEL_EXCHANGE, MQConstants.HOTEL_DELETE_KEY, id);
```

 æ¶ˆæ¯æ¥æ”¶æ–¹

```java
@Override
public void insertById(Long id) {
    try {
        // æ ¹æ®idæŸ¥è¯¢é…’åº—æ•°æ®
        Hotel hotel = getById(id);
        // è½¬æ¢ä¸ºæ–‡æ¡£ç±»å‹
        HotelDoc hotelDoc = new HotelDoc(hotel);

        IndexRequest request = new IndexRequest("hotel").id(hotel.getId().toString());
        request.source(JSON.toJSONString(hotelDoc), XContentType.JSON);
        client.index(request, RequestOptions.DEFAULT);
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}

@Override
public void deleteById(Long id) {
    try {
        DeleteRequest request = new DeleteRequest("hotel", id.toString());
        client.delete(request, RequestOptions.DEFAULT);
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}
```

```java
@Component
public class HotelListener {

    @Autowired
    private HotelService hotelService;

    /**
     * ç›‘å¬é…’åº—æ–°å¢æˆ–ä¿®æ”¹çš„ä¸šåŠ¡
     *
     * @param id é…’åº—id
     */
    @RabbitListener(queues = MqConstants.HOTEL_INSERT_QUEUE)
    public void listenHotelInsertOrUpdate(Long id) {
        hotelService.insertById(id);
    }

    /**
     * ç›‘å¬é…’åº—åˆ é™¤çš„ä¸šåŠ¡
     *
     * @param id é…’åº—id
     */
    @RabbitListener(queues = MqConstants.HOTEL_DELETE_QUEUE)
    public void listenHotelDelete(Long id) {
        hotelService.deleteById(id);
    }
}
```

# Elasticsearché›†ç¾¤

å•æœºçš„ Elasticsearch åšæ•°æ®å­˜å‚¨ï¼Œå¿…ç„¶é¢ä¸´ä¸¤ä¸ªé—®é¢˜ï¼šæµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜ã€å•ç‚¹æ•…éšœé—®é¢˜ã€‚

è§£å†³æ–¹æ¡ˆï¼š

- æµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜ï¼šå°†ç´¢å¼•åº“ä»é€»è¾‘ä¸Šæ‹†åˆ†ä¸ºNä¸ªåˆ†ç‰‡ï¼ˆshardï¼‰ï¼Œå­˜å‚¨åˆ°å¤šä¸ªèŠ‚ç‚¹
- å•ç‚¹æ•…éšœé—®é¢˜ï¼šå°†åˆ†ç‰‡æ•°æ®åœ¨ä¸åŒèŠ‚ç‚¹å¤‡ä»½ï¼ˆreplica ï¼‰

**ESé›†ç¾¤ç›¸å…³æ¦‚å¿µ**ï¼š

* é›†ç¾¤ï¼ˆclusterï¼‰ï¼šä¸€ç»„æ‹¥æœ‰å…±åŒçš„ cluster name çš„ èŠ‚ç‚¹ã€‚

* èŠ‚ç‚¹ï¼ˆnode)  ï¼šé›†ç¾¤ä¸­çš„ä¸€ä¸ª Elasticearch å®ä¾‹

* åˆ†ç‰‡ï¼ˆshardï¼‰ï¼šç´¢å¼•å¯ä»¥è¢«æ‹†åˆ†ä¸ºä¸åŒçš„éƒ¨åˆ†è¿›è¡Œå­˜å‚¨ï¼Œç§°ä¸ºåˆ†ç‰‡ã€‚**åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªç´¢å¼•çš„ä¸åŒåˆ†ç‰‡å¯ä»¥æ‹†åˆ†åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸­ï¼Œè§£å†³æ•°æ®é‡å¤ªå¤§ï¼Œå•ç‚¹å­˜å‚¨é‡æœ‰é™çš„é—®é¢˜ã€‚**

![](https://cdn.xn2001.com/img/2022/202205071006783.png)

> æ­¤å¤„ï¼Œæˆ‘ä»¬æŠŠæ•°æ®åˆ†æˆ3ç‰‡ï¼šshard0ã€shard1ã€shard2
>
> ä¸»åˆ†ç‰‡ï¼ˆPrimary shardï¼‰ï¼šç›¸å¯¹äºå‰¯æœ¬åˆ†ç‰‡çš„å®šä¹‰ã€‚
>
> å‰¯æœ¬åˆ†ç‰‡ï¼ˆReplica shardï¼‰æ¯ä¸ªä¸»åˆ†ç‰‡å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå‰¯æœ¬ï¼Œæ•°æ®å’Œä¸»åˆ†ç‰‡ä¸€æ ·ã€‚

æ•°æ®å¤‡ä»½å¯ä»¥ä¿è¯é«˜å¯ç”¨ï¼Œä½†æ˜¯æ¯ä¸ªåˆ†ç‰‡å¤‡ä»½ä¸€ä»½åœ¨èŠ‚ç‚¹ä¸Šï¼Œæ‰€éœ€è¦çš„èŠ‚ç‚¹æ•°é‡å°±ä¼šç¿»å€ï¼Œæˆæœ¬å¤ªé«˜ã€‚ä¸ºäº†åœ¨é«˜å¯ç”¨å’Œæˆæœ¬é—´å¯»æ±‚å¹³è¡¡

- é¦–å…ˆå¯¹æ•°æ®åˆ†ç‰‡ï¼Œå­˜å‚¨åˆ°ä¸åŒèŠ‚ç‚¹
- ç„¶åå¯¹æ¯ä¸ªåˆ†ç‰‡è¿›è¡Œå¤‡ä»½ï¼Œæ”¾åˆ°å¯¹æ–¹èŠ‚ç‚¹ï¼Œ**å®Œæˆäº’ç›¸å¤‡ä»½**

è¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘æ‰€éœ€è¦çš„æœåŠ¡èŠ‚ç‚¹æ•°é‡ï¼Œå¦‚å›¾ï¼Œæˆ‘ä»¬ä»¥3åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡å¤‡ä»½ä¸€ä»½ä¸ºä¾‹ï¼š

![](https://cdn.xn2001.com/img/2022/202205071006790.png)

ç°åœ¨ï¼Œæ¯ä¸ªåˆ†ç‰‡éƒ½æœ‰1ä¸ªå¤‡ä»½ï¼Œå­˜å‚¨åœ¨3ä¸ªèŠ‚ç‚¹ï¼š

- node0ï¼šä¿å­˜äº†åˆ†ç‰‡0å’Œ1
- node1ï¼šä¿å­˜äº†åˆ†ç‰‡0å’Œ2
- node2ï¼šä¿å­˜äº†åˆ†ç‰‡1å’Œ2

## éƒ¨ç½²é›†ç¾¤

### æ­å»ºElasticsearch 

æˆ‘ä»¬ä¼šåœ¨å•æœºä¸Šåˆ©ç”¨ Docker å®¹å™¨è¿è¡Œå¤šä¸ª Elasticsearch å®ä¾‹æ¥æ¨¡æ‹Ÿé›†ç¾¤ã€‚

å¯ä»¥ç›´æ¥ä½¿ç”¨ docker-compose æ¥å®Œæˆï¼Œè¿™è¦æ±‚ä½ çš„Linuxè™šæ‹Ÿæœºè‡³å°‘æœ‰**4G**ä»¥ä¸Šçš„å†…å­˜ç©ºé—´ã€‚

docker-compose.yml

```yml
version: '2.2'
services:
  es01:
    image: elasticsearch:7.12.1
    container_name: es01
    environment:
      - node.name=es01
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es02,es03
      - cluster.initial_master_nodes=es01,es02,es03
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - data01:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
    networks:
      - elastic
  es02:
    image: elasticsearch:7.12.1
    container_name: es02
    environment:
      - node.name=es02
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es01,es03
      - cluster.initial_master_nodes=es01,es02,es03
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - data02:/usr/share/elasticsearch/data
    ports:
      - 9201:9200
    networks:
      - elastic
  es03:
    image: elasticsearch:7.12.1
    container_name: es03
    environment:
      - node.name=es03
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es01,es02
      - cluster.initial_master_nodes=es01,es02,es03
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - data03:/usr/share/elasticsearch/data
    networks:
      - elastic
    ports:
      - 9202:9200
volumes:
  data01:
    driver: local
  data02:
    driver: local
  data03:
    driver: local
networks:
  elastic:
    driver: bridge
```

ä¿®æ”¹ Linux ç³»ç»Ÿæƒé™ï¼Œä¿®æ”¹ `/etc/sysctl.conf` æ–‡ä»¶

```sh
vi /etc/sysctl.conf
```

æ·»åŠ ä¸‹é¢çš„å†…å®¹

```sh
vm.max_map_count=262144
```

è®©é…ç½®ç”Ÿæ•ˆï¼š

```sh
sysctl -p
```

é€šè¿‡docker-composeå¯åŠ¨é›†ç¾¤

```sh
docker-compose up -d
```

### é›†ç¾¤çŠ¶æ€ç›‘æ§

kibana å¯ä»¥ç›‘æ§ Elasticsearch é›†ç¾¤ï¼Œä½†æ˜¯æ›´æ¨èä½¿ç”¨ [cerebro](https://github.com/lmenezes/cerebro)

ä¸‹è½½è§£å‹æ‰“å¼€ /bin/cerebro.bat

è®¿é—® http://localhost:9000 å³å¯è¿›å…¥ç®¡ç†ç•Œé¢

![](https://cdn.xn2001.com/img/2022/202205071018030.png)

è¾“å…¥ä»»æ„èŠ‚ç‚¹çš„åœ°å€å’Œç«¯å£ï¼Œç‚¹å‡» connect 

![](https://cdn.xn2001.com/img/2022/202205071018761.png)

ç»¿è‰²çš„çº¿æ¡ä»£è¡¨é›†ç¾¤å¤„äºç»¿è‰²ï¼ˆå¥åº·çŠ¶æ€ï¼‰

### åˆ›å»ºç´¢å¼•åº“

æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ cerebro åˆ›å»ºç´¢å¼•åº“ï¼Œå½“ç„¶ä½ éœ€è¦ä½¿ç”¨ kibana ä¹Ÿå¯ä»¥ã€‚

![](https://cdn.xn2001.com/img/2022/202205071020771.png)

å¡«å†™ç´¢å¼•åº“ä¿¡æ¯

![](https://cdn.xn2001.com/img/2022/202205071023380.png)

å›åˆ°é¦–é¡µï¼Œå³å¯æŸ¥çœ‹ç´¢å¼•åº“åˆ†ç‰‡æ•ˆæœ

![](https://cdn.xn2001.com/img/2022/202205071024397.png)

## é›†ç¾¤èŒè´£åˆ’åˆ†

Elasticsearch ä¸­é›†ç¾¤èŠ‚ç‚¹æœ‰ä¸åŒçš„èŒè´£åˆ’åˆ†

![](https://cdn.xn2001.com/img/2022/202205071029258.png)

**é»˜è®¤æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä¸­çš„ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½åŒæ—¶å…¼èŒä¸Šè¿°å››ç§è§’è‰²ã€‚**

çœŸå®çš„é›†ç¾¤ä¸€å®šè¦å°†é›†ç¾¤èŒè´£åˆ†ç¦»

- master èŠ‚ç‚¹ï¼šå¯¹ CPU è¦æ±‚é«˜ï¼Œä½†æ˜¯å†…å­˜è¦æ±‚ä½
- data èŠ‚ç‚¹ï¼šå¯¹ CPU å’Œå†…å­˜è¦æ±‚éƒ½é«˜
- coordinating èŠ‚ç‚¹ï¼šå¯¹ç½‘ç»œå¸¦å®½ã€CPU è¦æ±‚é«˜

èŒè´£åˆ†ç¦»å¯ä»¥è®©æˆ‘ä»¬æ ¹æ®ä¸åŒèŠ‚ç‚¹çš„éœ€æ±‚åˆ†é…ä¸åŒçš„ç¡¬ä»¶å»éƒ¨ç½²ã€‚è€Œä¸”é¿å…ä¸šåŠ¡ä¹‹é—´çš„äº’ç›¸å¹²æ‰°ã€‚

![](https://cdn.xn2001.com/img/2022/202205071029263.png)



## é›†ç¾¤è„‘è£‚é—®é¢˜

è„‘è£‚æ˜¯å› ä¸ºé›†ç¾¤ä¸­çš„èŠ‚ç‚¹å¤±è”å¯¼è‡´çš„ã€‚

ä¾‹å¦‚ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œä¸»èŠ‚ç‚¹ node1 ä¸å…¶å®ƒèŠ‚ç‚¹å¤±è”ã€‚

![](https://cdn.xn2001.com/img/2022/202205071029267.png)

æ­¤æ—¶ï¼Œnode2 å’Œ node3 è®¤ä¸º node1 å®•æœºï¼Œå°±ä¼šé‡æ–°é€‰ä¸»ã€‚

![](https://cdn.xn2001.com/img/2022/202205071344676.png)

å½“ node3 å½“é€‰åï¼Œé›†ç¾¤ç»§ç»­å¯¹å¤–æä¾›æœåŠ¡ï¼Œnode2 å’Œ node3 è‡ªæˆé›†ç¾¤ï¼Œnode1 è‡ªæˆé›†ç¾¤ï¼Œä¸¤ä¸ªé›†ç¾¤æ•°æ®ä¸åŒæ­¥ï¼Œå‡ºç°æ•°æ®å·®å¼‚ã€‚

å½“ç½‘ç»œæ¢å¤åï¼Œå› ä¸ºé›†ç¾¤ä¸­æœ‰ä¸¤ä¸ª master èŠ‚ç‚¹ï¼Œé›†ç¾¤çŠ¶æ€çš„ä¸ä¸€è‡´ï¼Œå‡ºç°è„‘è£‚çš„æƒ…å†µã€‚

![](https://cdn.xn2001.com/img/2022/202205071344829.png)



è§£å†³è„‘è£‚çš„æ–¹æ¡ˆæ˜¯ï¼Œè¦æ±‚é€‰ç¥¨è¶…è¿‡ **(eligibleèŠ‚ç‚¹æ•°é‡+1)/2** æ‰èƒ½å½“é€‰ä¸º masterï¼Œå› æ­¤ eligible èŠ‚ç‚¹æ•°é‡æœ€å¥½æ˜¯å¥‡æ•°ã€‚å¯¹åº”é…ç½®é¡¹æ˜¯`discovery.zen.minimum_master_nodes`ï¼Œåœ¨ç‰ˆæœ¬ 7.0 ä»¥åï¼Œå·²ç»æˆä¸ºé»˜è®¤é…ç½®ï¼Œå› æ­¤ä¸€èˆ¬ä¸ä¼šå‘ç”Ÿè„‘è£‚é—®é¢˜ã€‚

ä¾‹å¦‚ï¼š3ä¸ªèŠ‚ç‚¹å½¢æˆçš„é›†ç¾¤ï¼Œé€‰ç¥¨å¿…é¡»è¶…è¿‡ (3+1)/2 ï¼Œä¹Ÿå°±æ˜¯ 2 ç¥¨ã€‚node3 å¾—åˆ° node2 å’Œ node3 çš„é€‰ç¥¨ï¼Œå½“é€‰ä¸º masterã€‚node1 åªæœ‰è‡ªå·± 1 ç¥¨ï¼Œæ²¡æœ‰å½“é€‰ã€‚é›†ç¾¤ä¸­ä¾ç„¶åªæœ‰1ä¸ªä¸»èŠ‚ç‚¹ï¼Œæ²¡æœ‰å‡ºç°è„‘è£‚ã€‚

## é›†ç¾¤åˆ†å¸ƒå¼å­˜å‚¨

å½“æ–°å¢æ–‡æ¡£æ—¶ï¼Œåº”è¯¥ä¿å­˜åˆ°ä¸åŒåˆ†ç‰‡ï¼Œä¿è¯æ•°æ®å‡è¡¡ï¼Œé‚£ä¹ˆ coordinating node å¦‚ä½•ç¡®å®šæ•°æ®è¯¥å­˜å‚¨åˆ°å“ªä¸ªåˆ†ç‰‡å‘¢ï¼Ÿ

Elasticsearch ä¼šé€šè¿‡ hash ç®—æ³•æ¥è®¡ç®—æ–‡æ¡£åº”è¯¥å­˜å‚¨åˆ°å“ªä¸ªåˆ†ç‰‡

![](https://cdn.xn2001.com/img/2022/202205071412275.png)

- _routing é»˜è®¤æ˜¯æ–‡æ¡£çš„ id
- ç®—æ³•ä¸åˆ†ç‰‡æ•°é‡æœ‰å…³ï¼Œå› æ­¤ç´¢å¼•åº“ä¸€æ—¦åˆ›å»ºï¼Œåˆ†ç‰‡æ•°é‡ä¸èƒ½ä¿®æ”¹ï¼

æ–°å¢æ–‡æ¡£çš„æµç¨‹å¦‚ä¸‹å›¾ï¼Œ

1. æ–°å¢ä¸€ä¸ª id=1 çš„æ–‡æ¡£
2. å¯¹ id åš hash è¿ç®—ï¼Œå‡å¦‚å¾—åˆ°çš„æ˜¯ 2ï¼Œåˆ™åº”è¯¥å­˜å‚¨åˆ° shard-2
3. shard-2 çš„ä¸»åˆ†ç‰‡åœ¨ node3 èŠ‚ç‚¹ï¼Œå°†æ•°æ®è·¯ç”±åˆ° node3ï¼Œnode3 ä¿å­˜æ–‡æ¡£
4. åŒæ­¥ç»™ shard-2 çš„å‰¯æœ¬åˆ†ç‰‡2(R-2)ï¼Œåœ¨ node2 èŠ‚ç‚¹
5. è¿”å›ç»“æœç»™ coordinating-node èŠ‚ç‚¹(node1)

![](https://cdn.xn2001.com/img/2022/202205071412283.png)

## é›†ç¾¤åˆ†å¸ƒå¼æŸ¥è¯¢

Elasticsearch æŸ¥è¯¢åˆ†æˆä¸¤ä¸ªé˜¶æ®µ

- scatter phaseï¼šåˆ†æ•£é˜¶æ®µï¼Œcoordinating node ä¼šæŠŠè¯·æ±‚åˆ†å‘åˆ°æ¯ä¸€ä¸ªåˆ†ç‰‡ã€‚

- gather phaseï¼šèšé›†é˜¶æ®µï¼Œcoordinating node æ±‡æ€» data node çš„æœç´¢ç»“æœï¼Œå¹¶å¤„ç†ä¸ºæœ€ç»ˆç»“æœé›†è¿”å›ç»™ç”¨æˆ·ã€‚

![](https://cdn.xn2001.com/img/2022/202205071422105.png)



## é›†ç¾¤æ•…éšœè½¬ç§»

é›†ç¾¤çš„ master èŠ‚ç‚¹ä¼šç›‘æ§é›†ç¾¤ä¸­çš„èŠ‚ç‚¹çŠ¶æ€ï¼Œå¦‚æœå‘ç°æœ‰èŠ‚ç‚¹å®•æœºï¼Œä¼šç«‹å³å°†å®•æœºèŠ‚ç‚¹çš„åˆ†ç‰‡æ•°æ®è¿ç§»åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ï¼Œè¿™ä¸ªå«åšæ•…éšœè½¬ç§»ã€‚

ä¾‹å¦‚ä¸€ä¸ªé›†ç¾¤ç»“æ„å¦‚å›¾ï¼Œä¸‰ä¸ªéƒ½æ˜¯å¥åº·çš„ã€‚

![](https://cdn.xn2001.com/img/2022/202205071516134.png)

ç°åœ¨ï¼Œnode1 æ˜¯ä¸»èŠ‚ç‚¹ï¼Œå…¶å®ƒä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ä»èŠ‚ç‚¹ã€‚çªç„¶ï¼Œnode1 å‘ç”Ÿäº†æ•…éšœ

![](https://cdn.xn2001.com/img/2022/202205071516139.png)



å®•æœºåçš„ç¬¬ä¸€ä»¶äº‹ï¼Œéœ€è¦é‡æ–°é€‰ä¸»ï¼Œä¾‹å¦‚é€‰ä¸­äº† node2

![](https://cdn.xn2001.com/img/2022/202205071516685.png)



node2 æˆä¸ºä¸»èŠ‚ç‚¹åï¼Œä¼šæ£€æµ‹é›†ç¾¤ç›‘æ§çŠ¶æ€ï¼Œå°† node1 ä¸Šçš„æ•°æ®è¿ç§»åˆ° node2ã€node3ï¼Œç¡®ä¿æ•°æ®ä¾æ—§æ­£å¸¸è®¿é—®ã€‚

![](https://cdn.xn2001.com/img/2022/202205071516805.png)

# JMeterå‹åŠ›æµ‹è¯•

## å®‰è£…å¯åŠ¨

JMeter ä¾èµ–äºJDKï¼Œæ‰€ä»¥å¿…é¡»ç¡®ä¿å½“å‰è®¡ç®—æœºä¸Šå·²ç»å®‰è£…äº† JDKï¼Œå¹¶ä¸”é…ç½®äº†ç¯å¢ƒå˜é‡ã€‚

Apache Jmeterå®˜ç½‘ä¸‹è½½ï¼Œåœ°å€ï¼šhttp://jmeter.apache.org/download_jmeter.cgi

![](https://cdn.xn2001.com/img/2022/202205081544073.png)

è§£å‹ç¼©å³å¯ä½¿ç”¨ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2022/202205081545678.png)

å…¶ä¸­çš„ bin ç›®å½•å°±æ˜¯æ‰§è¡Œçš„è„šæœ¬ï¼Œå…¶ä¸­åŒ…å«å¯åŠ¨è„šæœ¬

![](https://cdn.xn2001.com/img/2022/202205081545976.png)

åŒå‡»å³å¯è¿è¡Œï¼Œä½†æ˜¯æœ‰ä¸¤ç‚¹æ³¨æ„

- å¯åŠ¨æ—¶é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œè¦è€å¿ƒç­‰å¾…ã€‚
- å¯åŠ¨åç»ˆç«¯ï¼ˆé»‘çª—å£ï¼‰ä¸èƒ½å…³é—­ï¼Œå¦åˆ™ JMeter ä¹Ÿè·Ÿç€å…³é—­ã€‚

![](https://cdn.xn2001.com/img/2022/202205081545691.png)

## ä¿®æ”¹ä¸­æ–‡

é»˜è®¤ JMeter çš„è¯­è¨€æ˜¯è‹±æ–‡ï¼Œéœ€è¦è®¾ç½®

![](https://cdn.xn2001.com/img/2022/202205081547848.png)

![](https://cdn.xn2001.com/img/2022/202205081547110.png)

ä¸Šé¢çš„é…ç½®åªèƒ½ä¿è¯æœ¬æ¬¡è¿è¡Œæ˜¯ä¸­æ–‡ï¼Œå¦‚æœè¦æ°¸ä¹…ä¸­æ–‡ï¼Œéœ€è¦ä¿®æ”¹ JMeter çš„é…ç½®æ–‡ä»¶ã€‚

æ‰“å¼€ JMeter æ–‡ä»¶å¤¹ï¼Œåœ¨ bin ç›®å½•ä¸­æ‰¾åˆ° **jmeter.properties**ï¼Œæ·»åŠ ä¸‹é¢é…ç½®ï¼š

```properties
language=zh_CN
```

![](https://cdn.xn2001.com/img/2022/202205081546219.png)

## åŸºæœ¬ä½¿ç”¨

åœ¨æµ‹è¯•è®¡åˆ’ä¸Šç‚¹é¼ æ ‡å³é”®ï¼Œé€‰æ‹©ã€Œæ·»åŠ  > çº¿ç¨‹ï¼ˆç”¨æˆ·ï¼‰ > çº¿ç¨‹ç»„ã€

![](https://cdn.xn2001.com/img/2022/202205081548692.png)

åœ¨æ–°å¢çš„çº¿ç¨‹ç»„ä¸­ï¼Œå¡«å†™çº¿ç¨‹ä¿¡æ¯

![](https://cdn.xn2001.com/img/2022/202205081549330.png)

åœ¨çº¿ç¨‹ç»„è¿™é‡Œç‚¹é¼ æ ‡å³é”®ï¼Œæ·»åŠ  http è¯·æ±‚

![](https://cdn.xn2001.com/img/2022/202205081551101.png)

ç¼–å†™å–æ ·å™¨å†…å®¹

![](https://cdn.xn2001.com/img/2022/202205081551053.png)

æ·»åŠ ç›‘å¬æŠ¥å‘Š

![](https://cdn.xn2001.com/img/2022/202205081551627.png)

æ±‡æ€»æŠ¥å‘Šç»“æœ

![](https://cdn.xn2001.com/img/2022/202205081548975.png)

æ·»åŠ ç›‘å¬ç»“æœæ ‘

![](https://cdn.xn2001.com/img/2022/202205231440680.png)

å¯Ÿçœ‹ç»“æœæ ‘

![](https://cdn.xn2001.com/img/2022/202205081548982.png)

# Sentineæµé‡ç»„ä»¶

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/10-sentinel-demo
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/10-sentinel-demo

## é›ªå´©é—®é¢˜

> å¾®æœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨ï¼Œå› ä¸ºè°ƒç”¨é“¾ä¸­çš„ä¸€ä¸ªæœåŠ¡æ•…éšœï¼Œå¼•èµ·æ•´ä¸ªé“¾è·¯éƒ½æ— æ³•è®¿é—®çš„æƒ…å†µã€‚

å¾®æœåŠ¡ä¸­ï¼ŒæœåŠ¡é—´è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚ï¼Œä¸€ä¸ªå¾®æœåŠ¡å¾€å¾€ä¾èµ–äºå¤šä¸ªå…¶å®ƒå¾®æœåŠ¡ã€‚

 ![](https://cdn.xn2001.com/img/2022/202205071911137.png)

å¦‚å›¾ï¼Œå¦‚æœæœåŠ¡æä¾›è€…I å‘ç”Ÿäº†æ•…éšœï¼Œå½“å‰çš„åº”ç”¨çš„éƒ¨åˆ†ä¸šåŠ¡å› ä¸ºä¾èµ–äºæœåŠ¡Iï¼Œå› æ­¤ä¹Ÿä¼šè¢«é˜»å¡ã€‚æ­¤æ—¶ï¼Œå…¶å®ƒä¸ä¾èµ–äºæœåŠ¡I çš„ä¸šåŠ¡ä¼¼ä¹ä¸å—å½±å“ã€‚

 ![](https://cdn.xn2001.com/img/2022/202205071911461.png)

ä½†æ˜¯ï¼Œä¾èµ–æœåŠ¡I çš„ä¸šåŠ¡è¯·æ±‚è¢«é˜»å¡ï¼Œåˆ™ tomcat çš„è¿™ä¸ªçº¿ç¨‹ä¸ä¼šé‡Šæ”¾ï¼Œäºæ˜¯è¶Šæ¥è¶Šå¤šçš„ç”¨æˆ·è¯·æ±‚åˆ°æ¥ï¼Œè¶Šæ¥è¶Šå¤šçš„çº¿ç¨‹ä¼šé˜»å¡ã€‚

 ![](https://cdn.xn2001.com/img/2022/202205071911464.png)

æœåŠ¡å™¨æ”¯æŒçš„çº¿ç¨‹å’Œå¹¶å‘æ•°æœ‰é™ï¼Œè¯·æ±‚ä¸€ç›´é˜»å¡ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨èµ„æºè€—å°½ï¼Œ**ä»è€Œå¯¼è‡´æ‰€æœ‰å…¶å®ƒæœåŠ¡éƒ½ä¸å¯ç”¨**ã€‚

ç»¼ä¸Šï¼Œä¾èµ–äºå½“å‰æœåŠ¡çš„å…¶å®ƒæœåŠ¡éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæœ€ç»ˆä¹Ÿéƒ½ä¼šå˜çš„ä¸å¯ç”¨ï¼Œå½¢æˆçº§è”å¤±è´¥ï¼Œè¿™å°±æ˜¯é›ªå´©é—®é¢˜ã€‚

![](https://cdn.xn2001.com/img/2022/202205071911480.png)

è§£å†³é›ªå´©é—®é¢˜çš„å¸¸è§æ–¹å¼æœ‰å››ç§

1. è¶…æ—¶å¤„ç†
2. çº¿ç¨‹éš”ç¦»
3. é™çº§ç†”æ–­
4. é™æµ

> **é™æµ**æ˜¯å¯¹æœåŠ¡çš„ä¿æŠ¤ï¼Œé¿å…å› ç¬é—´é«˜å¹¶å‘æµé‡è€Œå¯¼è‡´æœåŠ¡æ•…éšœï¼Œè¿›è€Œé¿å…é›ªå´©ã€‚æ˜¯ä¸€ç§**é¢„é˜²**æªæ–½ã€‚
>
> **è¶…æ—¶å¤„ç†ã€çº¿ç¨‹éš”ç¦»ã€é™çº§ç†”æ–­**æ˜¯åœ¨éƒ¨åˆ†æœåŠ¡æ•…éšœæ—¶ï¼Œå°†æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´ï¼Œé¿å…é›ªå´©ã€‚æ˜¯ä¸€ç§**è¡¥æ•‘**æªæ–½ã€‚

1.è¶…æ—¶å¤„ç†ï¼šè®¾å®šè¶…æ—¶æ—¶é—´ï¼Œè¯·æ±‚è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å“åº”å°±è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¸ä¼šæ— ä¼‘æ­¢ç­‰å¾…ã€‚

![](https://cdn.xn2001.com/img/2022/202205071936072.png)

2.çº¿ç¨‹éš”ç¦»

![](https://cdn.xn2001.com/img/2022/202205071953573.png)

æ˜¯ä¸€ç§èˆ±å£æ¨¡å¼ï¼Œå¦‚ä¸Šå›¾ï¼Œèˆ¹èˆ±éƒ½ä¼šè¢«éš”æ¿åˆ†ç¦»ä¸ºå¤šä¸ªç‹¬ç«‹ç©ºé—´ï¼Œå½“èˆ¹ä½“ç ´æŸæ—¶ï¼Œåªä¼šå¯¼è‡´éƒ¨åˆ†ç©ºé—´è¿›å…¥ï¼Œå°†æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œé¿å…æ•´ä¸ªèˆ¹ä½“éƒ½è¢«æ·¹æ²¡ã€‚äºæ­¤ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥é™å®šæ¯ä¸ªä¸šåŠ¡èƒ½ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé¿å…è€—å°½æ•´ä¸ª tomcat çš„èµ„æºï¼Œå› æ­¤ä¹Ÿå«çº¿ç¨‹éš”ç¦»ã€‚

![](https://cdn.xn2001.com/img/2022/202205071935351.png)

3.é™çº§ç†”æ–­

æ˜¯ä¸€ç§æ–­è·¯å™¨æ¨¡å¼ï¼šç”±**æ–­è·¯å™¨**ç»Ÿè®¡ä¸šåŠ¡æ‰§è¡Œçš„å¼‚å¸¸æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š**ç†”æ–­**è¯¥ä¸šåŠ¡ï¼Œæ‹¦æˆªè®¿é—®è¯¥ä¸šåŠ¡çš„ä¸€åˆ‡è¯·æ±‚ã€‚

æ–­è·¯å™¨ä¼šç»Ÿè®¡è®¿é—®æŸä¸ªæœåŠ¡çš„è¯·æ±‚æ•°é‡ï¼Œå¼‚å¸¸æ¯”ä¾‹ã€‚

![](https://cdn.xn2001.com/img/2022/202205071956512.png)

å½“å‘ç°è®¿é—®æœåŠ¡ D çš„è¯·æ±‚å¼‚å¸¸æ¯”ä¾‹è¿‡é«˜æ—¶ï¼Œè®¤ä¸ºæœåŠ¡ D æœ‰å¯¼è‡´é›ªå´©çš„é£é™©ï¼Œä¼šæ‹¦æˆªè®¿é—®æœåŠ¡ D çš„ä¸€åˆ‡è¯·æ±‚ï¼Œå½¢æˆç†”æ–­ã€‚

![](https://cdn.xn2001.com/img/2022/202205071956665.png)

4.é™æµ

**æµé‡æ§åˆ¶**ï¼šé™åˆ¶ä¸šåŠ¡è®¿é—®çš„ QPSï¼Œé¿å…æœåŠ¡å› æµé‡çš„çªå¢è€Œæ•…éšœã€‚

![](https://cdn.xn2001.com/img/2022/202205071935370.png)

åœ¨ SpringCloud å½“ä¸­æ”¯æŒå¤šç§æœåŠ¡ä¿æŠ¤æŠ€æœ¯

- [Netfix Hystrix](https://github.com/Netflix/Hystrix)
- [Sentinel](https://github.com/alibaba/Sentinel)
- [Resilience4J](https://github.com/resilience4j/resilience4j)

æ—©æœŸæ¯”è¾ƒæµè¡Œçš„æ˜¯ Hystrix æ¡†æ¶ï¼Œä½†ç›®å‰å›½å†…å®ç”¨æœ€å¹¿æ³›çš„è¿˜æ˜¯é˜¿é‡Œå·´å·´çš„ Sentinel æ¡†æ¶ï¼Œè¿™é‡Œæˆ‘ä»¬åšä¸‹å¯¹æ¯”ï¼š

|                | **Sentinel**                                   | **Hystrix**                   |
| -------------- | ---------------------------------------------- | ----------------------------- |
| éš”ç¦»ç­–ç•¥       | ä¿¡å·é‡éš”ç¦»                                     | çº¿ç¨‹æ± éš”ç¦»/ä¿¡å·é‡éš”ç¦»         |
| ç†”æ–­é™çº§ç­–ç•¥   | åŸºäºæ…¢è°ƒç”¨æ¯”ä¾‹æˆ–å¼‚å¸¸æ¯”ä¾‹                       | åŸºäºå¤±è´¥æ¯”ç‡                  |
| å®æ—¶æŒ‡æ ‡å®ç°   | æ»‘åŠ¨çª—å£                                       | æ»‘åŠ¨çª—å£ï¼ˆåŸºäº RxJavaï¼‰       |
| è§„åˆ™é…ç½®       | æ”¯æŒå¤šç§æ•°æ®æº                                 | æ”¯æŒå¤šç§æ•°æ®æº                |
| æ‰©å±•æ€§         | å¤šä¸ªæ‰©å±•ç‚¹                                     | æ’ä»¶çš„å½¢å¼                    |
| åŸºäºæ³¨è§£çš„æ”¯æŒ | æ”¯æŒ                                           | æ”¯æŒ                          |
| é™æµ           | åŸºäº QPSï¼Œæ”¯æŒåŸºäºè°ƒç”¨å…³ç³»çš„é™æµ               | æœ‰é™çš„æ”¯æŒ                    |
| æµé‡æ•´å½¢       | æ”¯æŒæ…¢å¯åŠ¨ã€åŒ€é€Ÿæ’é˜Ÿæ¨¡å¼                       | ä¸æ”¯æŒ                        |
| ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ | æ”¯æŒ                                           | ä¸æ”¯æŒ                        |
| æ§åˆ¶å°         | å¼€ç®±å³ç”¨ï¼Œå¯é…ç½®è§„åˆ™ã€æŸ¥çœ‹ç§’çº§ç›‘æ§ã€æœºå™¨å‘ç°ç­‰ | ä¸å®Œå–„                        |
| å¸¸è§æ¡†æ¶çš„é€‚é… | Servletã€Spring Cloudã€Dubboã€gRPC  ç­‰         | Servletã€Spring Cloud Netflix |

## åˆè¯†Sentinel

Sentinelæ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾å¾®æœåŠ¡æµé‡æ§åˆ¶ç»„ä»¶ã€‚å®˜ç½‘åœ°å€ï¼šhttps://sentinelguard.io/zh-cn/index.html

Sentinel å…·æœ‰ä»¥ä¸‹ç‰¹å¾

- **ä¸°å¯Œçš„åº”ç”¨åœºæ™¯**ï¼šSentinel æ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿‘ 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯ï¼Œä¾‹å¦‚ç§’æ€ï¼ˆå³çªå‘æµé‡æ§åˆ¶åœ¨ç³»ç»Ÿå®¹é‡å¯ä»¥æ‰¿å—çš„èŒƒå›´ï¼‰ã€æ¶ˆæ¯å‰Šå³°å¡«è°·ã€é›†ç¾¤æµé‡æ§åˆ¶ã€å®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ç­‰ã€‚
- **å®Œå¤‡çš„å®æ—¶ç›‘æ§**ï¼šSentinel åŒæ—¶æä¾›å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚æ‚¨å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°æœºå™¨ç§’çº§æ•°æ®ï¼Œç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µã€‚
- **å¹¿æ³›çš„å¼€æºç”Ÿæ€**ï¼šSentinel æä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶/åº“çš„æ•´åˆæ¨¡å—ï¼Œä¾‹å¦‚ä¸ Spring Cloudã€Dubboã€gRPC çš„æ•´åˆã€‚æ‚¨åªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å¹¶è¿›è¡Œç®€å•çš„é…ç½®å³å¯å¿«é€Ÿåœ°æ¥å…¥ Sentinelã€‚
- **å®Œå–„çš„** **SPI** **æ‰©å±•ç‚¹**ï¼šSentinel æä¾›ç®€å•æ˜“ç”¨ã€å®Œå–„çš„ SPI æ‰©å±•æ¥å£ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°æ‰©å±•æ¥å£æ¥å¿«é€Ÿåœ°å®šåˆ¶é€»è¾‘ã€‚ä¾‹å¦‚å®šåˆ¶è§„åˆ™ç®¡ç†ã€é€‚é…åŠ¨æ€æ•°æ®æºç­‰ã€‚

## æ•´åˆSentinel

ä¸‹è½½å jar åŒ…åï¼Œè¿è¡Œä»£ç ï¼š`java -jar sentinel-dashboard-1.8.1.jar`

å¦‚æœè¦ä¿®æ”¹ Sentinel çš„é»˜è®¤ç«¯å£ã€è´¦æˆ·ã€å¯†ç ï¼Œå¯ä»¥é€šè¿‡ä¸‹åˆ—é…ç½®ï¼š

| **é…ç½®é¡¹**                       | **é»˜è®¤å€¼** | **è¯´æ˜**   |
| -------------------------------- | ---------- | ---------- |
| server.port                      | 8080       | æœåŠ¡ç«¯å£   |
| sentinel.dashboard.auth.username | sentinel   | é»˜è®¤ç”¨æˆ·å |
| sentinel.dashboard.auth.password | sentinel   | é»˜è®¤å¯†ç    |

ä¾‹å¦‚ï¼Œä¿®æ”¹ç«¯å£ï¼š

```sh
java -Dserver.port=8090 -jar sentinel-dashboard-1.8.1.jar
```

è®¿é—® http://localhost:8080 é¡µé¢ï¼Œå°±å¯ä»¥çœ‹åˆ° Sentinel çš„æ§åˆ¶å°äº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205072010468.png)

è´¦å·å’Œå¯†ç é»˜è®¤éƒ½æ˜¯ï¼šsentinel

![](https://cdn.xn2001.com/img/2022/202205072018383.png)

æ­¤æ—¶ç©ºç™½ä¸€ç‰‡ï¼Œè¿˜éœ€è¦æˆ‘ä»¬æ¥æ•´åˆè¿› SpringCloud

å‡†å¤‡å¥½æˆ‘ä»¬çš„é¡¹ç›®ï¼Œåœ¨èµ„æ–™ä¸­ï¼Œç»“æ„å¦‚ä¸‹ï¼š

> è¿™é‡Œè€å¸ˆè®²çš„ç–å¿½äº†ï¼Œæ²¡æœ‰èµ° gateway ç½‘å…³ï¼Œä½†ä¸å½±å“ã€‚
>
> æä¾›çš„èµ„æ–™ä¸­çš„ gateway ç½‘å…³å¸¦äº†æƒé™é…ç½®å¯¼è‡´è¿™é‡Œæˆ‘ä»¬è®¿é—®ä¸äº†ç½‘å…³ï¼ˆä¹‹å‰ä¸Šè¯¾ç•™ä¸‹çš„ï¼‰ï¼Œéœ€è¦åˆ é™¤æ‰å…¶ä¸­çš„ AuthorizeFilter.jar

![](https://cdn.xn2001.com/img/2022/202205072033318.png)

æˆ‘ä»¬åœ¨ order-service ä¸­æ•´åˆ Sentinelï¼Œå¹¶è¿æ¥ Sentinel çš„æ§åˆ¶å°ï¼Œæ­¥éª¤å¦‚ä¸‹

1ï¼‰å¼•å…¥ Sentinel ä¾èµ–

```xml
<!--sentinel-->
<dependency>
    <groupId>com.alibaba.cloud</groupId> 
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

2ï¼‰é…ç½®æ§åˆ¶å°

ä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢å†…å®¹ï¼š

```yaml
server:
  port: 8088
spring:
  cloud: 
    sentinel:
      transport:
        dashboard: localhost:8080
```

3ï¼‰è®¿é—® order-service çš„ä»»æ„ç«¯ç‚¹

æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® http://localhost:10010/order/101ï¼Œå¤šè®¿é—®å‡ æ¬¡ï¼Œå¤šç‚¹å‡ æ¬¡åˆ·æ–°ï¼Œè¿™æ ·æ‰èƒ½è§¦å‘ Sentinel çš„ç›‘æ§ã€‚

ç„¶åå†è®¿é—® Sentinel çš„æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ•ˆæœã€‚

![](https://cdn.xn2001.com/img/2022/202205081430741.png)

## æµé‡æ§åˆ¶

é›ªå´©é—®é¢˜è™½æœ‰å››ç§æ–¹æ¡ˆï¼Œä½†æ˜¯**é™æµæ˜¯é¿å…æœåŠ¡å› çªå‘çš„æµé‡è€Œå‘ç”Ÿæ•…éšœï¼Œæ˜¯å¯¹å¾®æœåŠ¡é›ªå´©é—®é¢˜çš„é¢„é˜²ã€‚**å­¦è¿‡æ¯›ä¸­ç‰¹çš„éƒ½çŸ¥é“ï¼Œã€Šé¢„åˆ¤é£é™©æ‰€åœ¨æ˜¯é˜²èŒƒé£é™©çš„å‰æã€‹ï¼Œæˆ‘ä»¬å…ˆå­¦ä¹ æµé‡æ§åˆ¶ã€‚

### ç°‡ç‚¹é“¾è·¯

å½“è¯·æ±‚è¿›å…¥å¾®æœåŠ¡æ—¶ï¼Œé¦–å…ˆä¼šè®¿é—® DispatcherServletï¼Œç„¶åè¿›å…¥ Controllerã€Serviceã€Mapperï¼Œè¿™æ ·çš„ä¸€ä¸ªè°ƒç”¨é“¾å°±å«åš **ç°‡ç‚¹é“¾è·¯**ã€‚

**ç°‡ç‚¹é“¾è·¯ä¸­è¢«ç›‘æ§çš„æ¯ä¸€ä¸ªæ¥å£å°±æ˜¯ä¸€ä¸ªèµ„æº**ã€‚é»˜è®¤æƒ…å†µä¸‹ Sentinel ä¼šç›‘æ§ SpringMVC çš„æ¯ä¸€ä¸ªç«¯ç‚¹ï¼ˆEndpointï¼Œä¹Ÿå°±æ˜¯ Controller ä¸­çš„æ–¹æ³•ï¼‰ï¼Œå› æ­¤ SpringMVC çš„æ¯ä¸€ä¸ªç«¯ç‚¹ï¼ˆEndpointï¼‰å°±æ˜¯è°ƒç”¨é“¾è·¯ä¸­çš„ä¸€ä¸ªèµ„æºã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆšæ‰è®¿é—®çš„ order-service ä¸­çš„ OrderController ä¸­çš„ç«¯ç‚¹ï¼š/order/{orderId}

![](https://cdn.xn2001.com/img/2022/202205081445779.png)



æµæ§ã€ç†”æ–­ç­‰éƒ½æ˜¯é’ˆå¯¹ç°‡ç‚¹é“¾è·¯ä¸­çš„èµ„æºæ¥è®¾ç½®çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç‚¹å‡»å¯¹åº”èµ„æºåé¢çš„æŒ‰é’®æ¥è®¾ç½®è§„åˆ™ï¼š

- æµæ§ï¼šæµé‡æ§åˆ¶
- é™çº§ï¼šé™çº§ç†”æ–­
- çƒ­ç‚¹ï¼šçƒ­ç‚¹å‚æ•°é™æµï¼Œæ˜¯é™æµçš„ä¸€ç§
- æˆæƒï¼šè¯·æ±‚çš„æƒé™æ§åˆ¶

ç‚¹å‡»èµ„æº /order/{orderId} åé¢çš„æµæ§æŒ‰é’®ï¼Œå°±å¯ä»¥å¼¹å‡ºè¡¨å•ã€‚

![](https://cdn.xn2001.com/img/2022/202205081509045.png)

è¡¨å•ä¸­å¯ä»¥å¡«å†™é™æµè§„åˆ™ï¼Œå¦‚ä¸‹

![](https://cdn.xn2001.com/img/2022/202205081509055.png)

å…¶å«ä¹‰æ˜¯é™åˆ¶ /order/{orderId} è¿™ä¸ªèµ„æºçš„å•æœº QPS ä¸º 1ï¼Œå³æ¯ç§’åªå…è®¸ 1 æ¬¡è¯·æ±‚ï¼Œè¶…å‡ºçš„è¯·æ±‚ä¼šè¢«æ‹¦æˆªå¹¶æŠ¥é”™ã€‚

> éœ€æ±‚ï¼šç»™ /order/{orderId} è¿™ä¸ªèµ„æºè®¾ç½®æµæ§è§„åˆ™ï¼ŒQPS ä¸èƒ½è¶…è¿‡ 5ï¼Œç„¶åæµ‹è¯•ã€‚

1ï¼‰é¦–å…ˆåœ¨ sentinel æ§åˆ¶å°æ·»åŠ é™æµè§„åˆ™

![](https://cdn.xn2001.com/img/2022/202205081513259.png)

2ï¼‰åˆ©ç”¨ jmeter æµ‹è¯•ï¼Œä¸‹é¢æœ‰è®²åˆ° JMeter åŸºç¡€ä½¿ç”¨ã€‚

![](https://cdn.xn2001.com/img/2022/202205081514678.png)

20 ä¸ªç”¨æˆ·ï¼Œ2 ç§’å†…è¿è¡Œå®Œï¼Œè¿™æ ·çš„è¯ QPS å°±æ˜¯ 10ï¼Œè¶…è¿‡äº†æˆ‘ä»¬åœ¨ sentinel è®¾ç½®çš„ 5

å³é”®è¿è¡Œï¼š

![](https://cdn.xn2001.com/img/2022/202205081512845.png)



> æ³¨æ„ï¼Œä¸è¦ç‚¹å‡»èœå•ä¸­çš„æ‰§è¡ŒæŒ‰é’®æ¥è¿è¡Œã€‚

ç»“æœï¼š

![](https://cdn.xn2001.com/img/2022/202205081512850.png)

å¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸçš„è¯·æ±‚æ¯æ¬¡åªæœ‰ 5 ä¸ªã€‚

![](https://cdn.xn2001.com/img/2022/202205081525292.png)

### æµæ§æ¨¡å¼

åœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œç‚¹å‡»é«˜çº§é€‰é¡¹ï¼Œå¯ä»¥é€‰æ‹©ä¸‰ç§**æµæ§æ¨¡å¼**

#### ç›´æ¥æ¨¡å¼

- ç›´æ¥ï¼šç»Ÿè®¡å½“å‰èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶å¯¹å½“å‰èµ„æºç›´æ¥é™æµï¼Œä¹Ÿæ˜¯é»˜è®¤çš„æ¨¡å¼
  - ç›´æ¥å¯¹å½“å‰èµ„æºé™æµ

- å…³è”ï¼šç»Ÿè®¡ä¸å½“å‰èµ„æºç›¸å…³çš„å¦ä¸€ä¸ªèµ„æºï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹å½“å‰èµ„æºé™æµ
  - ç›¸å½“äºé«˜ä¼˜å…ˆçº§èµ„æºè§¦å‘é˜ˆå€¼ï¼Œå¯¹ä½ä¼˜å…ˆçº§èµ„æºé™æµã€‚

- é“¾è·¯ï¼šç»Ÿè®¡ä»æŒ‡å®šé“¾è·¯è®¿é—®åˆ°æœ¬èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹æŒ‡å®šé“¾è·¯é™æµ
  - æ˜¯é’ˆå¯¹è¯·æ±‚æ¥æºçš„é™æµ


![](https://cdn.xn2001.com/img/2022/202205081553073.png)



ä¸Šé¢æˆ‘ä»¬æµ‹è¯•çš„å°±æ˜¯ç›´æ¥æ¨¡å¼ï¼Œé»˜è®¤å°±æ˜¯ç›´æ¥æ¨¡å¼ã€‚

#### å…³è”æ¨¡å¼

ç»Ÿè®¡ä¸å½“å‰èµ„æºç›¸å…³çš„å¦ä¸€ä¸ªèµ„æºï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹å½“å‰èµ„æºé™æµã€‚

**ä½¿ç”¨åœºæ™¯**ï¼šæ¯”å¦‚ç”¨æˆ·æ”¯ä»˜æ—¶éœ€è¦ä¿®æ”¹è®¢å•çŠ¶æ€ï¼ŒåŒæ—¶ç”¨æˆ·è¦æŸ¥è¯¢è®¢å•ã€‚æŸ¥è¯¢å’Œä¿®æ”¹æ“ä½œä¼šäº‰æŠ¢æ•°æ®åº“é”ï¼Œäº§ç”Ÿç«äº‰ã€‚ä¸šåŠ¡éœ€æ±‚æ˜¯ä¼˜å…ˆæ”¯ä»˜å’Œæ›´æ–°è®¢å•çš„ä¸šåŠ¡ï¼Œå› æ­¤å½“ä¿®æ”¹è®¢å•ä¸šåŠ¡è§¦å‘é˜ˆå€¼æ—¶ï¼Œéœ€è¦å¯¹æŸ¥è¯¢è®¢å•ä¸šåŠ¡é™æµã€‚

![](https://cdn.xn2001.com/img/2022/202205081602290.png)

ä¾‹å¦‚ï¼šé…ç½®è§„åˆ™ï¼Œ**å½“ /write èµ„æºè®¿é—®é‡è§¦å‘é˜ˆå€¼æ—¶ï¼Œå°±ä¼šå¯¹ /read èµ„æºé™æµï¼Œé¿å…å½±å“ /write èµ„æºã€‚**

![](https://cdn.xn2001.com/img/2022/202205081602252.png)

æˆ‘ä»¬å»ç¨‹åºä¸­æ¨¡æ‹Ÿï¼š

- åœ¨ OrderController æ–°å»ºä¸¤ä¸ªç«¯ç‚¹ï¼š/order/query å’Œ /order/updateï¼Œæ— éœ€å®ç°ä¸šåŠ¡

- é…ç½®æµæ§è§„åˆ™ï¼Œå½“ /order/ update èµ„æºè¢«è®¿é—®çš„ QPS è¶…è¿‡ 5 æ—¶ï¼Œå¯¹ /order/query è¯·æ±‚é™æµ

1ï¼‰å®šä¹‰ /order/query ç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿè®¢å•æŸ¥è¯¢

```java
@GetMapping("/query")
public String queryOrder() {
    return "æŸ¥è¯¢è®¢å•æˆåŠŸ";
}
```

2ï¼‰å®šä¹‰ /order/update ç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿè®¢å•æ›´æ–°

```java
@GetMapping("/update")
public String updateOrder() {
    return "æ›´æ–°è®¢å•æˆåŠŸ";
}
```

é‡å¯æœåŠ¡ï¼ŒæŸ¥çœ‹ Sentinel æ§åˆ¶å°çš„ç°‡ç‚¹é“¾è·¯ã€‚

![](https://cdn.xn2001.com/img/2022/202205081618267.png)



3ï¼‰é…ç½®æµæ§è§„åˆ™

æƒ³è¦å¯¹å“ªä¸ªç«¯ç‚¹é™æµï¼Œå°±ç‚¹å‡»å“ªä¸ªç«¯ç‚¹åé¢çš„æŒ‰é’®ã€‚æˆ‘ä»¬æ˜¯å¯¹è®¢å•æŸ¥è¯¢ /order/query é™æµ

![](https://cdn.xn2001.com/img/2022/202205081619163.png)åœ¨è¡¨å•ä¸­å¡«å†™æµæ§è§„åˆ™

![](https://cdn.xn2001.com/img/2022/202205081602274.png)

4ï¼‰åœ¨ JMeter æµ‹è¯•

![](https://cdn.xn2001.com/img/2022/202205081619453.png)

å¯ä»¥çœ‹åˆ° 1000 ä¸ªç”¨æˆ·ï¼Œ100 ç§’ï¼Œå› æ­¤ QPS ä¸º10ï¼Œè¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„é˜ˆå€¼ï¼š5

æŸ¥çœ‹ http è¯·æ±‚

![](https://cdn.xn2001.com/img/2022/202205081602280.png)

è¯·æ±‚çš„ç›®æ ‡æ˜¯ /order/updateï¼Œä½†é™æµçš„ç›®æ ‡æ˜¯ /order/queryï¼Œè¿™å°±æ˜¯å…³è”æ¨¡å¼ï¼›æˆ‘ä»¬åœ¨æµè§ˆå™¨è®¿é—® /order/queryï¼Œå¯ä»¥å‘ç°ç¡®å®è¢«é™æµäº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205081620364.png)

#### é“¾è·¯æ¨¡å¼

åªé’ˆå¯¹ä»æŒ‡å®šé“¾è·¯è®¿é—®åˆ°æœ¬èµ„æºçš„è¯·æ±‚åšç»Ÿè®¡ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡é˜ˆå€¼ã€‚

ä¾‹å¦‚æœ‰ä¸¤æ¡è¯·æ±‚é“¾è·¯

- /test1 --> /common

- /test2 --> /common

å¦‚æœåªå¸Œæœ›ç»Ÿè®¡ä» /test2 è¿›å…¥åˆ° /common çš„è¯·æ±‚ï¼Œåˆ™å¯ä»¥è¿™æ ·é…ç½®

![](https://cdn.xn2001.com/img/2022/202205081632892.png)

**å®æˆ˜æ¡ˆä¾‹**

æœ‰æŸ¥è¯¢è®¢å•å’Œåˆ›å»ºè®¢å•ä¸šåŠ¡ï¼Œä¸¤è€…éƒ½éœ€è¦æŸ¥è¯¢å•†å“ã€‚é’ˆå¯¹ä»æŸ¥è¯¢è®¢å•è¿›å…¥åˆ°æŸ¥è¯¢å•†å“çš„è¯·æ±‚ç»Ÿè®¡ï¼Œå¹¶è®¾ç½®é™æµã€‚

1. åœ¨ OrderService ä¸­æ·»åŠ ä¸€ä¸ª queryGoods æ–¹æ³•ï¼Œä¸ç”¨å®ç°ä¸šåŠ¡

2. åœ¨ OrderController ä¸­ï¼Œæ”¹é€  /order/query ç«¯ç‚¹ï¼Œè°ƒç”¨ OrderService ä¸­çš„ queryGoods æ–¹æ³•

3. åœ¨ OrderController ä¸­æ·»åŠ ä¸€ä¸ª /order/save ç«¯ç‚¹ï¼Œè°ƒç”¨ OrderService çš„ queryGoods æ–¹æ³•

4. ç»™ queryGoods è®¾ç½®é™æµè§„åˆ™ï¼Œä» /order/query è¿›å…¥ queryGoods çš„æ–¹æ³•é™åˆ¶ QPS å¿…é¡»å°äº 2

1ï¼‰æ·»åŠ æŸ¥è¯¢å•†å“æ–¹æ³•

åœ¨order-serviceæœåŠ¡ä¸­ï¼Œç»™ OrderService ç±»æ·»åŠ ä¸€ä¸ª queryGoods æ–¹æ³•

```java
public void queryGoods(){
    System.err.println("æŸ¥è¯¢å•†å“");
}
```

2ï¼‰æŸ¥è¯¢è®¢å•æ—¶ï¼ŒæŸ¥è¯¢å•†å“

åœ¨ order-service çš„ OrderController ä¸­ï¼Œä¿®æ”¹ /order/query ç«¯ç‚¹çš„ä¸šåŠ¡é€»è¾‘

```java
@GetMapping("/query")
public String queryOrder() {
    // æŸ¥è¯¢å•†å“
    orderService.queryGoods();
    // æŸ¥è¯¢è®¢å•
    System.out.println("æŸ¥è¯¢è®¢å•");
    return "æŸ¥è¯¢è®¢å•æˆåŠŸ";
}  
```

3ï¼‰æ–°å¢è®¢å•ï¼ŒæŸ¥è¯¢å•†å“

åœ¨ order-service çš„ OrderController ä¸­ï¼Œä¿®æ”¹ /order/save ç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿæ–°å¢è®¢å•ï¼š

```java
@GetMapping("/save")
public String saveOrder() {
    // æŸ¥è¯¢å•†å“
    orderService.queryGoods();
    // æŸ¥è¯¢è®¢å•
    System.out.println("æ–°å¢è®¢å•");
    return "æ–°å¢è®¢å•æˆåŠŸ";
}
```

4ï¼‰ç»™æŸ¥è¯¢å•†å“æ·»åŠ èµ„æºæ ‡è®°

é»˜è®¤æƒ…å†µä¸‹ï¼ŒOrderService ä¸­çš„æ–¹æ³•æ˜¯ä¸è¢« Sentinel ç›‘æ§çš„ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±é€šè¿‡æ³¨è§£æ¥æ ‡è®°è¦ç›‘æ§çš„æ–¹æ³•ã€‚

ç»™ OrderService çš„ queryGoods æ–¹æ³•æ·»åŠ  `@SentinelResource` æ³¨è§£ã€‚

```java
@SentinelResource("goods")
public void queryGoods(){
    System.err.println("æŸ¥è¯¢å•†å“");
}
```

é“¾è·¯æ¨¡å¼ä¸­ï¼Œæ˜¯å¯¹ä¸åŒæ¥æºçš„ä¸¤ä¸ªé“¾è·¯åšç›‘æ§ã€‚ä½†æ˜¯ Sentinel é»˜è®¤ä¼šç»™è¿›å…¥ SpringMVC çš„æ‰€æœ‰è¯·æ±‚è®¾ç½®åŒä¸€ä¸ª root èµ„æºï¼Œä¼šå¯¼è‡´é“¾è·¯æ¨¡å¼å¤±æ•ˆã€‚æˆ‘ä»¬éœ€è¦å…³é—­è¿™ç§å¯¹ SpringMVC çš„èµ„æºèšåˆï¼Œä¿®æ”¹ order-service æœåŠ¡çš„ application.yml æ–‡ä»¶

```yaml
spring:
  cloud:
    sentinel:
      web-context-unify: false # å…³é—­contextæ•´åˆ
```

é‡å¯æœåŠ¡ï¼Œè®¿é—® /order/query å’Œ /order/saveï¼Œå¯ä»¥æŸ¥çœ‹åˆ° Sentinel çš„ç°‡ç‚¹é“¾è·¯è§„åˆ™ä¸­ï¼Œå‡ºç°äº†æ–°çš„èµ„æº

![](https://cdn.xn2001.com/img/2022/202205081633195.png)



5ï¼‰æ·»åŠ æµæ§è§„åˆ™

ç‚¹å‡» goods èµ„æºåé¢çš„æµæ§æŒ‰é’®ï¼Œåœ¨å¼¹å‡ºçš„è¡¨å•ä¸­å¡«å†™ä¸‹é¢ä¿¡æ¯

![](https://cdn.xn2001.com/img/2022/202205081633212.png)



åªç»Ÿè®¡ä» /order/query è¿›å…¥ /goods çš„èµ„æºï¼ŒQPS é˜ˆå€¼ä¸º 2ï¼Œè¶…å‡ºåˆ™è¢«é™æµã€‚

6ï¼‰Jmeteræµ‹è¯•

![](https://cdn.xn2001.com/img/2022/202205081633203.png)

å¯ä»¥çœ‹åˆ°è¿™é‡Œ200ä¸ªç”¨æˆ·ï¼Œ50ç§’å†…å‘å®Œï¼ŒQPSä¸º4ï¼Œè¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„é˜ˆå€¼2

ä¸€ä¸ª http è¯·æ±‚æ˜¯è®¿é—® /order/save

![](https://cdn.xn2001.com/img/2022/202205081858739.png)

è¿è¡Œçš„ç»“æœæ˜¯ /order/save å®Œå…¨ä¸å—å½±å“ã€‚

![](https://cdn.xn2001.com/img/2022/202205081858880.png)

è®¿é—® /order/query

![](https://cdn.xn2001.com/img/2022/202205081633221.png)

è¿è¡Œç»“æœæ˜¯ /order/queryï¼Œæ¯æ¬¡åªæœ‰2ä¸ªé€šè¿‡ã€‚

![](https://cdn.xn2001.com/img/2022/202205081633245.png)

## æµæ§æ•ˆæœ

### å¿«é€Ÿå¤±è´¥

ç»†å¿ƒçš„å°ä¼™ä¼´ä¼šå‘ç°åœ¨æµæ§çš„é«˜çº§é€‰é¡¹ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªæµæ§æ•ˆæœé€‰é¡¹ï¼Œå‰é¢æˆ‘ä»¬çš„æµ‹è¯•éƒ½æ˜¯åŸºæœ¬å¿«é€Ÿå¤±è´¥çš„ã€‚

![](https://cdn.xn2001.com/img/2022/202205081907653.png)

æµæ§æ•ˆæœæ˜¯æŒ‡è¯·æ±‚è¾¾åˆ°æµæ§é˜ˆå€¼æ—¶åº”è¯¥é‡‡å–çš„æªæ–½ï¼ŒåŒ…æ‹¬ä¸‰ç§

- å¿«é€Ÿå¤±è´¥ï¼šè¾¾åˆ°é˜ˆå€¼åï¼Œæ–°çš„è¯·æ±‚ä¼šè¢«ç«‹å³æ‹’ç»å¹¶æŠ›å‡º FlowException å¼‚å¸¸ï¼Œæ˜¯é»˜è®¤çš„å¤„ç†æ–¹å¼ã€‚

- Warm Upï¼šé¢„çƒ­æ¨¡å¼ï¼Œå¯¹è¶…å‡ºé˜ˆå€¼çš„è¯·æ±‚åŒæ ·æ˜¯æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ä½†è¿™ç§æ¨¡å¼é˜ˆå€¼ä¼šåŠ¨æ€å˜åŒ–ï¼Œä»ä¸€ä¸ªè¾ƒå°å€¼é€æ¸å¢åŠ åˆ°æœ€å¤§é˜ˆå€¼ã€‚

- æ’é˜Ÿç­‰å¾…ï¼šè®©æ‰€æœ‰çš„è¯·æ±‚æŒ‰ç…§å…ˆåæ¬¡åºæ’é˜Ÿæ‰§è¡Œï¼Œä¸¤ä¸ªè¯·æ±‚çš„é—´éš”ä¸èƒ½å°äºæŒ‡å®šæ—¶é•¿ã€‚

### Warm up

é˜ˆå€¼ä¸€èˆ¬æ˜¯ä¸€ä¸ªå¾®æœåŠ¡èƒ½æ‰¿æ‹…çš„æœ€å¤§ QPSï¼Œä½†æ˜¯ä¸€ä¸ªæœåŠ¡åˆšåˆšå¯åŠ¨æ—¶ï¼Œä¸€åˆ‡èµ„æºå°šæœªåˆå§‹åŒ–ï¼ˆ**å†·å¯åŠ¨**ï¼‰ï¼Œå¦‚æœç›´æ¥å°† QPS è·‘åˆ°æœ€å¤§å€¼ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡ç¬é—´å®•æœºã€‚

Warm Up ä¹Ÿå«**é¢„çƒ­æ¨¡å¼**ï¼Œæ˜¯åº”å¯¹æœåŠ¡å†·å¯åŠ¨çš„ä¸€ç§æ–¹æ¡ˆã€‚è¯·æ±‚é˜ˆå€¼åˆå§‹å€¼æ˜¯ `maxThreshold / coldFactor`ï¼ŒæŒç»­æŒ‡å®šæ—¶é•¿åï¼Œé€æ¸æé«˜åˆ° maxThreshold å€¼ã€‚è€Œ coldFactor çš„é»˜è®¤å€¼æ˜¯ 3.

ä¾‹å¦‚ï¼Œæˆ‘è®¾ç½® QPS çš„ maxThreshold ä¸º 10ï¼Œé¢„çƒ­æ—¶é—´ä¸º 5 ç§’ï¼Œé‚£ä¹ˆåˆå§‹é˜ˆå€¼å°±æ˜¯ 10 / 3 = 3ï¼Œç„¶ååœ¨ 5 ç§’åé€æ¸å¢é•¿åˆ° 10

![](https://cdn.xn2001.com/img/2022/202205081907114.png)



**æ¡ˆä¾‹**ï¼šç»™ /order/{orderId} è¿™ä¸ªèµ„æºè®¾ç½®é™æµï¼Œæœ€å¤§ QPS ä¸º 10ï¼Œåˆ©ç”¨ Warm Up æ•ˆæœï¼Œé¢„çƒ­æ—¶é•¿ä¸º 5 ç§’ã€‚

1ï¼‰é…ç½®æµæ§è§„åˆ™

![](https://cdn.xn2001.com/img/2022/202205090008173.png)

2ï¼‰JMeter æµ‹è¯•

![](https://cdn.xn2001.com/img/2022/202205090008283.png)

åˆšåˆšå¯åŠ¨æ—¶ï¼Œå¤§éƒ¨åˆ†è¯·æ±‚å¤±è´¥ï¼ŒæˆåŠŸçš„åªæœ‰ 3 ä¸ªï¼Œè¯´æ˜ QPS è¢«é™å®šåœ¨ 3 

![](https://cdn.xn2001.com/img/2022/202205090009927.png)

éšç€æ—¶é—´æ¨ç§»ï¼ŒæˆåŠŸæ¯”ä¾‹è¶Šæ¥è¶Šé«˜

![](https://cdn.xn2001.com/img/2022/202205090009448.png)



åˆ° Sentinel æ§åˆ¶å°æŸ¥çœ‹å®æ—¶ç›‘æ§

![](https://cdn.xn2001.com/img/2022/202205081907395.png)

ä¸€æ®µæ—¶é—´å

![](https://cdn.xn2001.com/img/2022/202205081907398.png)

ç”¨å®˜æ–¹çš„è¯è®²ï¼Œè¯¥æ–¹å¼ä¸»è¦ç”¨äºç³»ç»Ÿé•¿æœŸå¤„äºä½æ°´ä½çš„æƒ…å†µä¸‹ï¼Œå½“æµé‡çªç„¶å¢åŠ æ—¶ï¼Œç›´æ¥æŠŠç³»ç»Ÿæ‹‰å‡åˆ°é«˜æ°´ä½å¯èƒ½ç¬é—´æŠŠç³»ç»Ÿå‹å®ã€‚é€šè¿‡"å†·å¯åŠ¨"ï¼Œè®©é€šè¿‡çš„æµé‡ç¼“æ…¢å¢åŠ ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…é€æ¸å¢åŠ åˆ°é˜ˆå€¼ä¸Šé™ï¼Œç»™å†·ç³»ç»Ÿä¸€ä¸ªé¢„çƒ­çš„æ—¶é—´ï¼Œé¿å…å†·ç³»ç»Ÿè¢«å‹å®çš„æƒ…å†µã€‚

### æ’é˜Ÿç­‰å¾…

å½“è¯·æ±‚è¶…è¿‡ QPS é˜ˆå€¼æ—¶ï¼Œã€Œå¿«é€Ÿå¤±è´¥ã€å’Œ ã€ŒWarm Upã€ä¼šæ‹’ç»æ–°çš„è¯·æ±‚å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚

è€Œæ’é˜Ÿç­‰å¾…åˆ™æ˜¯è®©æ‰€æœ‰è¯·æ±‚è¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰ç…§é˜ˆå€¼å…è®¸çš„æ—¶é—´é—´éš”ä¾æ¬¡æ‰§è¡Œã€‚åæ¥çš„è¯·æ±‚å¿…é¡»ç­‰å¾…å‰é¢æ‰§è¡Œå®Œæˆï¼Œå¦‚æœè¯·æ±‚é¢„æœŸçš„ç­‰å¾…æ—¶é—´è¶…å‡ºæœ€å¤§æ—¶é•¿ï¼Œåˆ™ä¼šè¢«æ‹’ç»ã€‚è¿™ç§æ–¹å¼ä¸¥æ ¼æ§åˆ¶äº†è¯·æ±‚é€šè¿‡çš„é—´éš”æ—¶é—´ï¼Œä¹Ÿå³æ˜¯è®©è¯·æ±‚ä»¥å‡åŒ€çš„é€Ÿåº¦é€šè¿‡ï¼Œå¯¹åº”çš„æ˜¯æ¼æ¡¶ç®—æ³•ã€‚

ä¾‹å¦‚ï¼šQPS = 5ï¼Œæ„å‘³ç€æ¯ 200ms å¤„ç†ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼›timeout = 2000ï¼Œæ„å‘³ç€**é¢„æœŸç­‰å¾…æ—¶é•¿**è¶…è¿‡ 2000ms çš„è¯·æ±‚ä¼šè¢«æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚

æ¯”å¦‚ç°åœ¨ä¸€ä¸‹å­æ¥äº† 12  ä¸ªè¯·æ±‚ï¼Œå› ä¸ºæ¯ 200ms æ‰§è¡Œä¸€ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆé¢„æœŸç­‰å¾…æ—¶é•¿å°±æ˜¯ï¼š

- ç¬¬6ä¸ªè¯·æ±‚çš„**é¢„æœŸç­‰å¾…æ—¶é•¿** =  200 * (6 - 1) = 1000ms
- ç¬¬12ä¸ªè¯·æ±‚çš„é¢„æœŸç­‰å¾…æ—¶é•¿ = 200 * (12-1) = 2200ms

åˆæ¯”å¦‚ä¸‹å›¾ï¼š

![](https://cdn.xn2001.com/img/2022/202205090037622.png)

ç°åœ¨ï¼Œç¬¬ 1 ç§’åŒæ—¶æ¥æ”¶åˆ° 10 ä¸ªè¯·æ±‚ï¼Œä½†ç¬¬ 2 ç§’åªæœ‰ 1 ä¸ªè¯·æ±‚ï¼Œæ­¤æ—¶ QPS çš„æ›²çº¿è¿™æ ·çš„

![](https://cdn.xn2001.com/img/2022/202205081907396.png)

å¦‚æœä½¿ç”¨æ’é˜Ÿç­‰å¾…çš„æµæ§æ•ˆæœï¼Œæ‰€æœ‰è¿›å…¥çš„è¯·æ±‚éƒ½è¦æ’é˜Ÿï¼Œä»¥å›ºå®šçš„ 200ms çš„é—´éš”æ‰§è¡Œï¼ŒQPS ä¼šå˜çš„å¾ˆå¹³æ»‘

![](https://cdn.xn2001.com/img/2022/202205090016702.png)

è¿™ç§æ–¹å¼ä¸»è¦ç”¨äºå¤„ç†é—´éš”æ€§çªå‘çš„æµé‡ï¼Œä¾‹å¦‚æ¶ˆæ¯é˜Ÿåˆ—ã€‚æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼Œåœ¨æŸä¸€ç§’æœ‰å¤§é‡çš„è¯·æ±‚åˆ°æ¥ï¼Œè€Œæ¥ä¸‹æ¥çš„å‡ ç§’åˆ™å¤„äºç©ºé—²çŠ¶æ€ï¼Œæˆ‘ä»¬å¸Œæœ›ç³»ç»Ÿèƒ½å¤Ÿåœ¨æ¥ä¸‹æ¥çš„ç©ºé—²æœŸé—´é€æ¸å¤„ç†è¿™äº›è¯·æ±‚ï¼Œè€Œä¸æ˜¯åœ¨ç¬¬ä¸€ç§’ç›´æ¥æ‹’ç»å¤šä½™çš„è¯·æ±‚ã€‚

**æ¡ˆä¾‹**ï¼šç»™ /order/{orderId} è¿™ä¸ªèµ„æºè®¾ç½®é™æµï¼Œæœ€å¤§ QPS ä¸º 10ï¼Œåˆ©ç”¨æ’é˜Ÿç­‰å¾…çš„æµæ§æ•ˆæœï¼Œè¶…æ—¶æ—¶é•¿è®¾ç½®ä¸º 5s

1ï¼‰æ·»åŠ æµæ§è§„åˆ™

![](https://cdn.xn2001.com/img/2022/202205090011577.png)

2ï¼‰JMeter æµ‹è¯•

![](https://cdn.xn2001.com/img/2022/202205081907171.png)

QPS ä¸º 15ï¼Œå·²ç»è¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„ 10ï¼Œå¦‚æœæ˜¯ä¹‹å‰çš„ã€Œå¿«é€Ÿå¤±è´¥ã€ ã€ã€ŒWarm Upã€æ¨¡å¼ï¼Œè¶…å‡ºçš„è¯·æ±‚åº”è¯¥ä¼šç›´æ¥æŠ¥é”™ã€‚

ä½†æ˜¯æˆ‘ä»¬çœ‹çœ‹ã€Œæ’é˜Ÿç­‰å¾…ã€çš„è¿è¡Œç»“æœ

![](https://cdn.xn2001.com/img/2022/202205081907254.png)

å†å» Sentinel æŸ¥çœ‹å®æ—¶ç›‘æ§çš„ QPS æ›²çº¿

![](https://cdn.xn2001.com/img/2022/202205081907426.png)

QPS éå¸¸å¹³æ»‘ï¼Œä¸€è‡´ä¿æŒåœ¨ 10ï¼Œä½†æ˜¯è¶…å‡ºçš„è¯·æ±‚æ²¡æœ‰è¢«æ‹’ç»ï¼Œè€Œæ˜¯æ”¾å…¥é˜Ÿåˆ—ã€‚å› æ­¤**å“åº”æ—¶é—´**ï¼ˆç­‰å¾…æ—¶é—´ï¼‰ä¼šè¶Šæ¥è¶Šé•¿ã€‚

å½“é˜Ÿåˆ—æ»¡äº†ä»¥åï¼Œæ‰ä¼šæœ‰éƒ¨åˆ†è¯·æ±‚å¤±è´¥

![](https://cdn.xn2001.com/img/2022/202205081907443.png)

## çƒ­ç‚¹å‚æ•°é™æµ

ä¹‹å‰çš„é™æµæ˜¯ç»Ÿè®¡è®¿é—®æŸä¸ªèµ„æºçš„æ‰€æœ‰è¯·æ±‚ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡ QPS é˜ˆå€¼ã€‚è€Œã€Œçƒ­ç‚¹å‚æ•°é™æµã€æ˜¯**åˆ†åˆ«ç»Ÿè®¡å‚æ•°å€¼ç›¸åŒçš„è¯·æ±‚**ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡ QPS é˜ˆå€¼ã€‚

### å…¨å±€å‚æ•°é™æµ

ä¾‹å¦‚ï¼Œä¸€ä¸ªæ ¹æ® id æŸ¥è¯¢å•†å“çš„æ¥å£

![](https://cdn.xn2001.com/img/2022/202205090045292.png)

è®¿é—® /goods/{id} çš„è¯·æ±‚ä¸­ï¼Œid å‚æ•°å€¼ä¼šæœ‰å˜åŒ–ï¼Œã€Œçƒ­ç‚¹å‚æ•°é™æµã€ä¼šæ ¹æ®å‚æ•°å€¼åˆ†åˆ«ç»Ÿè®¡ QPSï¼Œç»Ÿè®¡ç»“æœï¼š

![](https://cdn.xn2001.com/img/2022/202205090046762.png)

å½“ id=1 çš„è¯·æ±‚è§¦å‘é˜ˆå€¼è¢«é™æµæ—¶ï¼Œidå€¼ä¸ä¸º1çš„è¯·æ±‚åˆ™ä¸å—å½±å“ã€‚

é…ç½®ç¤ºä¾‹ï¼šå¯¹ hot è¿™ä¸ªèµ„æºçš„ 0 å·å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰åšç»Ÿè®¡ï¼Œæ¯ 1s **ç›¸åŒå‚æ•°å€¼**çš„è¯·æ±‚æ•°ä¸èƒ½è¶…è¿‡ 5

![](https://cdn.xn2001.com/img/2022/202205090042929.png)

### çƒ­ç‚¹å‚æ•°é™æµ

å‡è®¾ä¸Šé¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªå•†å“æŸ¥è¯¢æ¥å£ï¼Œé‚£ä¹ˆåˆšæ‰çš„é…ç½®ä¸­ï¼Œå¯¹è¿™ä¸ªæ¥å£çš„æ‰€æœ‰å•†å“ä¸€è§†åŒä»ï¼ŒQPS éƒ½é™å®šä¸º 5

è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯èƒ½éƒ¨åˆ†å•†å“æ˜¯çƒ­ç‚¹å•†å“ï¼Œä¾‹å¦‚ç§’æ€å•†å“ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™éƒ¨åˆ†å•†å“çš„ QPS é™åˆ¶ä¸å…¶å®ƒå•†å“ä¸ä¸€æ ·ï¼Œé«˜ä¸€äº›ã€‚é‚£å°±éœ€è¦é…ç½®ã€Œçƒ­ç‚¹å‚æ•°é™æµã€çš„é«˜çº§é€‰é¡¹äº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205090050071.png)

ç»“åˆä¸Šä¸€ä¸ªé…ç½®ï¼Œè¿™é‡Œçš„å«ä¹‰æ˜¯å¯¹ 0 å·çš„ long ç±»å‹å‚æ•°é™æµï¼Œæ¯ 1 ä¸ªç›¸åŒå‚æ•°çš„ QPS ä¸èƒ½è¶…è¿‡ 5ï¼Œæœ‰å¦‚ä¸‹ä¸¤ä¸ªä¾‹å¤–

- å¦‚æœå‚æ•°å€¼æ˜¯ 100ï¼Œåˆ™æ¯ 1s å…è®¸çš„ QPS ä¸º 10
- å¦‚æœå‚æ•°å€¼æ˜¯ 101ï¼Œåˆ™æ¯ 1s å…è®¸çš„ QPS ä¸º 15

**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™ /order/{orderId} è¿™ä¸ªèµ„æºæ·»åŠ ã€Œçƒ­ç‚¹å‚æ•°é™æµã€ï¼Œè§„åˆ™å¦‚ä¸‹

- é»˜è®¤çš„çƒ­ç‚¹å‚æ•°è§„åˆ™æ˜¯æ¯ 1s è¯·æ±‚é‡ä¸è¶…è¿‡ 2
- ç»™ 102 è¿™ä¸ªå‚æ•°è®¾ç½®ä¾‹å¤–ï¼šæ¯ 1s è¯·æ±‚é‡ä¸è¶…è¿‡ 4
- ç»™ 103 è¿™ä¸ªå‚æ•°è®¾ç½®ä¾‹å¤–ï¼šæ¯ 1s è¯·æ±‚é‡ä¸è¶…è¿‡ 10

**æ³¨æ„äº‹é¡¹**ï¼šçƒ­ç‚¹å‚æ•°é™æµå¯¹é»˜è®¤çš„ SpringMVC èµ„æºæ— æ•ˆï¼Œéœ€è¦åˆ©ç”¨ `@SentinelResource` æ³¨è§£æ ‡è®°èµ„æºã€‚

1ï¼‰æ ‡è®°èµ„æº

ç»™ order-service ä¸­çš„ OrderController ä¸­çš„ /order/{orderId} èµ„æºæ·»åŠ æ³¨è§£

![](https://cdn.xn2001.com/img/2022/202205090042942.png)

2ï¼‰çƒ­ç‚¹å‚æ•°é™æµè§„åˆ™

è®¿é—®è¯¥æ¥å£ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ ‡è®°çš„ hot èµ„æºå‡ºç°äº†

![](https://cdn.xn2001.com/img/2022/202205090136368.png)

ç‚¹å‡»å·¦ä¾§èœå•ä¸­**çƒ­ç‚¹è§„åˆ™**èœå•

![](https://cdn.xn2001.com/img/2022/202205090137049.png)

ç‚¹å‡»æ–°å¢ï¼Œå¡«å†™è¡¨å•

![](https://cdn.xn2001.com/img/2022/202205090137574.png)

3ï¼‰JMeter æµ‹è¯•

è¿™é‡Œå‘èµ·è¯·æ±‚çš„ QPS ä¸º 5ï¼ŒåŒ…å« 3 ä¸ª http è¯·æ±‚

![](https://cdn.xn2001.com/img/2022/202205090138955.png)

æ™®é€šå‚æ•°ï¼ŒQPS é˜ˆå€¼ä¸º 2

![](https://cdn.xn2001.com/img/2022/202205090042964.png)

![](https://cdn.xn2001.com/img/2022/202205090042203.png)



ä¾‹å¤–é¡¹ï¼ŒQPS é˜ˆå€¼ä¸º 4

![](https://cdn.xn2001.com/img/2022/202205090140941.png)

![](https://cdn.xn2001.com/img/2022/202205090042238.png)



**ä¾‹å¤–é¡¹ï¼ŒQPS é˜ˆå€¼ä¸º 10**

![](https://cdn.xn2001.com/img/2022/202205090042244.png)

![](https://cdn.xn2001.com/img/2022/202205090140933.png)

## éš”ç¦»å’Œé™çº§

é™æµåªæ˜¯ä¸€ç§é¢„é˜²æªæ–½ï¼Œè™½ç„¶é™æµå¯ä»¥å°½é‡é¿å…å› é«˜å¹¶å‘è€Œå¼•èµ·çš„æœåŠ¡æ•…éšœï¼Œä½†æœåŠ¡è¿˜ä¼šå› ä¸ºå…¶å®ƒåŸå› è€Œæ•…éšœã€‚

è€Œè¦å°†è¿™äº›æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´ï¼Œé¿å…é›ªå´©ï¼Œå°±è¦é **çº¿ç¨‹éš”ç¦»**ï¼ˆèˆ±å£æ¨¡å¼ï¼‰å’Œ**ç†”æ–­é™çº§**æ‰‹æ®µäº†ã€‚

**çº¿ç¨‹éš”ç¦»**ï¼šè°ƒç”¨è€…åœ¨è°ƒç”¨æœåŠ¡æä¾›è€…æ—¶ï¼Œç»™æ¯ä¸ªè°ƒç”¨çš„è¯·æ±‚åˆ†é…ç‹¬ç«‹çº¿ç¨‹æ± ï¼Œå‡ºç°æ•…éšœæ—¶ï¼Œæœ€å¤šæ¶ˆè€—è¿™ä¸ªçº¿ç¨‹æ± å†…èµ„æºï¼Œé¿å…æŠŠè°ƒç”¨è€…çš„æ‰€æœ‰èµ„æºè€—å°½ã€‚

![](https://cdn.xn2001.com/img/2022/202205091001949.png)

**ç†”æ–­é™çº§**ï¼šæ˜¯åœ¨è°ƒç”¨æ–¹è¿™è¾¹åŠ å…¥æ–­è·¯å™¨ï¼Œç»Ÿè®¡å¯¹æœåŠ¡æä¾›è€…çš„è°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨çš„å¤±è´¥æ¯”ä¾‹è¿‡é«˜ï¼Œåˆ™ç†”æ–­è¯¥ä¸šåŠ¡ï¼Œä¸å…è®¸è®¿é—®è¯¥æœåŠ¡çš„æä¾›è€…äº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205091203825.png)

å¯ä»¥çœ‹åˆ°ï¼Œä¸ç®¡æ˜¯çº¿ç¨‹éš”ç¦»è¿˜æ˜¯ç†”æ–­é™çº§ï¼Œéƒ½æ˜¯å¯¹**å®¢æˆ·ç«¯**ï¼ˆè°ƒç”¨æ–¹ï¼‰çš„ä¿æŠ¤ã€‚éœ€è¦åœ¨**è°ƒç”¨æ–¹**å‘èµ·è¿œç¨‹è°ƒç”¨æ—¶åšçº¿ç¨‹éš”ç¦»ã€æˆ–è€…æœåŠ¡ç†”æ–­ã€‚

è€Œæˆ‘ä»¬çš„å¾®æœåŠ¡è¿œç¨‹è°ƒç”¨éƒ½æ˜¯åŸºäº Feign æ¥å®Œæˆçš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°† Feign ä¸ Sentinel æ•´åˆï¼Œåœ¨ Feign é‡Œé¢å®ç°çº¿ç¨‹éš”ç¦»å’ŒæœåŠ¡ç†”æ–­ã€‚

## Feignæ•´åˆSentinel

SpringCloudä¸­ï¼Œå¾®æœåŠ¡è°ƒç”¨éƒ½æ˜¯é€šè¿‡Feignæ¥å®ç°çš„ï¼Œå› æ­¤åšå®¢æˆ·ç«¯ä¿æŠ¤å¿…é¡»æ•´åˆ Feign å’Œ Sentinel

ä¿®æ”¹é…ç½®ï¼Œå¼€å¯ Sentinel åŠŸèƒ½ï¼Œä¿®æ”¹ OrderService çš„ application.yml æ–‡ä»¶ï¼Œå¼€å¯ Feign çš„ Sentinel åŠŸèƒ½

```yaml
feign:
  sentinel:
    enabled: true # å¼€å¯feignå¯¹sentinelçš„æ”¯æŒ
```

æœåŠ¡é™çº§ï¼šè®¿é—®å¤±è´¥åï¼ŒæœåŠ¡

**ç¼–å†™å¤±è´¥é™çº§é€»è¾‘ä»£ç **ï¼Œä¸šåŠ¡å¤±è´¥åï¼Œä¸èƒ½ç›´æ¥æŠ¥é”™ï¼Œè€Œåº”è¯¥è¿”å›ç”¨æˆ·ä¸€ä¸ªå‹å¥½æç¤ºæˆ–è€…é»˜è®¤ç»“æœï¼Œè¿™ä¸ªå°±æ˜¯å¤±è´¥é™çº§é€»è¾‘ã€‚

ç»™ FeignClient ç¼–å†™å¤±è´¥åçš„é™çº§é€»è¾‘

â‘ æ–¹å¼ä¸€ï¼šFallbackClassï¼Œä½†æ— æ³•å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†ã€‚

â‘¡æ–¹å¼äºŒï¼šFallbackFactoryï¼Œå¯ä»¥å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†ï¼Œæˆ‘ä»¬é€‰æ‹©è¿™ç§

è¿™é‡Œæˆ‘ä»¬æ¼”ç¤ºæ–¹å¼äºŒçš„å¤±è´¥é™çº§å¤„ç†ã€‚

**æ­¥éª¤ä¸€**ï¼šåœ¨ feing-api é¡¹ç›®ä¸­å®šä¹‰ç±»ï¼Œå®ç° FallbackFactory

![](https://cdn.xn2001.com/img/2022/202205091209104.png)

```java
package com.xn2001.feign.clients.fallback;

import com.xn2001.feign.clients.UserClient;
import com.xn2001.feign.pojo.User;
import feign.hystrix.FallbackFactory;
import lombok.extern.slf4j.Slf4j;

/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2022/5/9 14:24
 */

@Slf4j
public class UserClientFallbackFactory implements FallbackFactory<UserClient> {
    @Override
    public UserClient create(Throwable throwable) {
       return userClient -> {
           log.error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥",throwable);
           return new User();
       };
    }
}
```

**æ­¥éª¤äºŒ**ï¼šåœ¨ feing-api é¡¹ç›®ä¸­çš„ DefaultFeignConfiguration ç±»ä¸­å°† UserClientFallbackFactory æ³¨å†Œä¸ºä¸€ä¸ªBean

```java
@Bean
public UserClientFallbackFactory userClientFallbackFactory(){
    return new UserClientFallbackFactory();
}
```

**æ­¥éª¤ä¸‰**ï¼šåœ¨ feing-api é¡¹ç›®ä¸­çš„ UserClient æ¥å£ä¸­ä½¿ç”¨ UserClientFallbackFactory

```java
@FeignClient(value = "userservice", fallbackFactory = UserClientFallbackFactory.class)
public interface UserClient {
    @GetMapping("/user/{id}")
    User findById(@PathVariable("id") Long id);
}
```

é‡å¯åï¼Œè®¿é—®ä¸€æ¬¡è®¢å•æŸ¥è¯¢ä¸šåŠ¡ï¼Œç„¶åæŸ¥çœ‹ Sentinel æ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°æ–°çš„ç°‡ç‚¹é“¾è·¯

![](https://cdn.xn2001.com/img/2022/202205091210616.png)

## çº¿ç¨‹éš”ç¦»

çº¿ç¨‹éš”ç¦»ï¼ˆèˆ±å£æ¨¡å¼ï¼‰æœ‰ä¸¤ç§æ–¹å¼å®ç°

- çº¿ç¨‹æ± éš”ç¦»ï¼šç»™æ¯ä¸ªæœåŠ¡è°ƒç”¨ä¸šåŠ¡åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œåˆ©ç”¨çº¿ç¨‹æ± æœ¬èº«å®ç°éš”ç¦»æ•ˆæœã€‚

- ä¿¡å·é‡éš”ç¦»ï¼ˆSentinelé»˜è®¤é‡‡ç”¨ï¼‰ï¼šä¸åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œæ˜¯è®¡æ•°å™¨æ¨¡å¼ï¼Œè®°å½•ä¸šåŠ¡ä½¿ç”¨çš„çº¿ç¨‹æ•°é‡ï¼Œè¾¾åˆ°ä¿¡å·é‡ä¸Šé™æ—¶ï¼Œç¦æ­¢æ–°çš„è¯·æ±‚ã€‚

ä¸¤è€…çš„ä¼˜ç¼ºç‚¹

- çº¿ç¨‹æ± éš”ç¦»ï¼šåŸºäºçº¿ç¨‹æ± æ¨¡å¼ï¼Œæœ‰é¢å¤–å¼€é”€ï¼Œä½†éš”ç¦»æ§åˆ¶æ›´å¼º
- ä¿¡å·é‡éš”ç¦»ï¼šåŸºäºè®¡æ•°å™¨æ¨¡å¼ï¼Œç®€å•ï¼Œå¼€é”€å°

![](https://cdn.xn2001.com/img/2022/202205091501180.png)

![](https://cdn.xn2001.com/img/2022/202205091502961.png)

**Sentinel ä½¿ç”¨çš„æ˜¯ä¿¡å·é‡éš”ç¦»**ï¼Œè€Œ Hystrix åˆ™ä¸¤ç§çº¿ç¨‹éš”ç¦»éƒ½å¯ä»¥ï¼Œ18 å¹´Hystrixå·²ç»åœæ­¢æ›´æ–°ã€‚

å¦‚ä½•ä½¿ç”¨å‘¢ï¼Œåœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä¸¤ç§é˜ˆå€¼ç±»å‹

![](https://cdn.xn2001.com/img/2022/202205091500754.png)

- QPSï¼šå°±æ˜¯æ¯ç§’çš„è¯·æ±‚æ•°ï¼Œä¹‹å‰å·²ç»æ¼”ç¤ºè¿‡ã€‚

- çº¿ç¨‹æ•°ï¼šæ˜¯è¯¥èµ„æºèƒ½ä½¿ç”¨çš„ Tomcat çº¿ç¨‹æ•°çš„æœ€å¤§å€¼ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡é™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œå®ç°**çº¿ç¨‹éš”ç¦»**ï¼ˆèˆ±å£æ¨¡å¼ï¼‰ã€‚

**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™ order-service æœåŠ¡ä¸­çš„ UserClient çš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®æµæ§è§„åˆ™ï¼Œçº¿ç¨‹æ•°ä¸èƒ½è¶…è¿‡ 2ï¼Œç„¶ååˆ©ç”¨ JMeter æµ‹è¯•ã€‚

1ï¼‰é…ç½®éš”ç¦»è§„åˆ™ï¼Œé€‰æ‹© feign æ¥å£åé¢çš„æµæ§æŒ‰é’®

![](https://cdn.xn2001.com/img/2022/202205091507487.png)

![](https://cdn.xn2001.com/img/2022/202205091508076.png)

2ï¼‰JMeter æµ‹è¯•

![](https://cdn.xn2001.com/img/2022/202205091500777.png)

ä¸€æ¬¡å‘ç”Ÿ 10 ä¸ªè¯·æ±‚ï¼Œæœ‰è¾ƒå¤§æ¦‚ç‡å¹¶å‘çº¿ç¨‹æ•°è¶…è¿‡ 2ï¼Œè€Œè¶…å‡ºçš„è¯·æ±‚ä¼šèµ°ä¹‹å‰å®šä¹‰çš„å¤±è´¥é™çº§é€»è¾‘ã€‚

æŸ¥çœ‹è¿è¡Œç»“æœ

![](https://cdn.xn2001.com/img/2022/202205091500739.png)

å‘ç°è™½ç„¶ç»“æœéƒ½æ˜¯é€šè¿‡äº†ï¼Œä¸è¿‡éƒ¨åˆ†è¯·æ±‚å¾—åˆ°çš„å“åº”æ˜¯ã€Œé™çº§ã€è¿”å›çš„ null ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„é™çº§æ–¹æ³•ã€‚

## ç†”æ–­é™çº§

ç†”æ–­é™çº§æ˜¯è§£å†³é›ªå´©é—®é¢˜çš„é‡è¦æ‰‹æ®µã€‚å…¶æ€è·¯æ˜¯ç”±**æ–­è·¯å™¨**ç»Ÿè®¡æœåŠ¡è°ƒç”¨çš„å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è¯·æ±‚æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š**ç†”æ–­**è¯¥æœåŠ¡ã€‚å³æ‹¦æˆªè®¿é—®è¯¥æœåŠ¡çš„ä¸€åˆ‡è¯·æ±‚ï¼›è€Œå½“æœåŠ¡æ¢å¤æ—¶ï¼Œæ–­è·¯å™¨ä¼šæ”¾è¡Œè®¿é—®è¯¥æœåŠ¡çš„è¯·æ±‚ã€‚

æ–­è·¯å™¨æ§åˆ¶ç†”æ–­å’Œæ”¾è¡Œæ˜¯é€šè¿‡çŠ¶æ€æœºæ¥å®Œæˆçš„ï¼Œå¦‚ä¸‹å›¾å°±æ˜¯ä¸€ä¸ªæ–­è·¯å™¨çš„çŠ¶æ€æœº

![](https://cdn.xn2001.com/img/2022/202205091510676.png)

çŠ¶æ€æœºåŒ…æ‹¬ä¸‰ä¸ªçŠ¶æ€

- closedï¼šå…³é—­çŠ¶æ€ï¼Œæ–­è·¯å™¨æ”¾è¡Œæ‰€æœ‰è¯·æ±‚ï¼Œå¹¶å¼€å§‹ç»Ÿè®¡å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è¯·æ±‚æ¯”ä¾‹ã€‚ä¼šå»åˆ¤æ–­æ˜¯å¦è¾¾åˆ°ç†”æ–­æ¡ä»¶ï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬å«åšã€Œç†”æ–­ç­–ç•¥ã€ï¼Œè¾¾åˆ°è¯¥æ¡ä»¶åˆ™åˆ‡æ¢åˆ° open çŠ¶æ€ï¼Œæ‰“å¼€æ–­è·¯å™¨ã€‚
- openï¼šæ‰“å¼€çŠ¶æ€ï¼ŒæœåŠ¡è°ƒç”¨è¢«**ç†”æ–­**ï¼Œè®¿é—®è¢«ç†”æ–­æœåŠ¡çš„è¯·æ±‚ä¼šè¢«æ‹’ç»ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œç›´æ¥èµ°é™çº§é€»è¾‘ã€‚Open çŠ¶æ€ 5 ç§’åä¼šè¿›å…¥ half-open çŠ¶æ€ã€‚
- half-openï¼šåŠå¼€çŠ¶æ€ï¼Œä¼šä¸€æ®µæ—¶é—´æ”¾è¡Œä¸€æ¬¡è¯·æ±‚ï¼Œæ ¹æ®æ‰§è¡Œç»“æœæ¥åˆ¤æ–­æ¥ä¸‹æ¥çš„æ“ä½œã€‚è¯·æ±‚æˆåŠŸï¼šåˆ™åˆ‡æ¢åˆ° closed çŠ¶æ€ï¼›è¯·æ±‚å¤±è´¥ï¼šåˆ™åˆ‡æ¢åˆ° open çŠ¶æ€ã€‚

æ–­è·¯å™¨ç†”æ–­ç­–ç•¥æœ‰ä¸‰ç§ï¼šæ…¢è°ƒç”¨ã€å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°

#### æ…¢è°ƒç”¨

ä¸šåŠ¡çš„å“åº”æ—¶é•¿ï¼ˆRTï¼‰å¤§äºæŒ‡å®šæ—¶é•¿çš„è¯·æ±‚è®¤å®šä¸ºæ…¢è°ƒç”¨è¯·æ±‚ã€‚åœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œå¦‚æœè¯·æ±‚æ•°é‡è¶…è¿‡è®¾å®šçš„æœ€å°æ•°é‡ï¼Œæ…¢è°ƒç”¨æ¯”ä¾‹å¤§äºè®¾å®šçš„é˜ˆå€¼ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

ä¾‹å¦‚ä¸‹å›¾ï¼Œè®¾ç½® RT è¶…è¿‡ 500ms çš„è°ƒç”¨æ˜¯æ…¢è°ƒç”¨ï¼Œç»Ÿè®¡æœ€è¿‘ 10000ms å†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡ 10 æ¬¡ï¼Œå¹¶ä¸”æ…¢è°ƒç”¨æ¯”ä¾‹ä¸ä½äº 0.5ï¼Œåˆ™è§¦å‘ç†”æ–­ï¼Œç†”æ–­æ—¶é•¿ä¸º 5sï¼Œç„¶åè¿›å…¥ half-open çŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚åšæµ‹è¯•ã€‚

![](https://cdn.xn2001.com/img/2022/202205091520916.png)

**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™ UserClient çš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œæ…¢è°ƒç”¨çš„ RT é˜ˆå€¼ä¸º 50msï¼Œç»Ÿè®¡æ—¶é—´ä¸º 1s ï¼Œæœ€å°è¯·æ±‚æ•°é‡ä¸º 5ï¼Œå¤±è´¥é˜ˆå€¼æ¯”ä¾‹ä¸º 0.4ï¼Œç†”æ–­æ—¶é•¿ä¸º 5sï¼›

1ï¼‰è®¾ç½®æ…¢è°ƒç”¨

ä¿®æ”¹ user-service ä¸­çš„ /user/{id} è¿™ä¸ªæ¥å£çš„ä¸šåŠ¡ã€‚é€šè¿‡ä¼‘çœ æ¨¡æ‹Ÿä¸€ä¸ªå»¶è¿Ÿæ—¶é—´ã€‚

![](https://cdn.xn2001.com/img/2022/202205091538605.png)

æ­¤æ—¶ï¼ŒorderId = 101 çš„è®¢å•ï¼Œå…³è”çš„æ˜¯ id ä¸º 1 çš„ç”¨æˆ·ï¼Œè°ƒç”¨æ—¶é•¿ä¸º 60ms

![](https://cdn.xn2001.com/img/2022/202205091520928.png)

orderId = 102 çš„è®¢å•ï¼Œå…³è”çš„æ˜¯ id ä¸º 2 çš„ç”¨æˆ·ï¼Œè°ƒç”¨æ—¶é•¿ä¸ºéå¸¸çŸ­

![](https://cdn.xn2001.com/img/2022/202205091520932.png)

2ï¼‰è®¾ç½®ç†”æ–­è§„åˆ™

ä¸‹é¢ï¼Œç»™ feign æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œè¶…è¿‡ 50ms çš„è¯·æ±‚éƒ½ä¼šè¢«è®¤ä¸ºæ˜¯æ…¢è¯·æ±‚ã€‚

![](https://cdn.xn2001.com/img/2022/202205091624147.png)

![](https://cdn.xn2001.com/img/2022/202205091624535.png)

3ï¼‰æµ‹è¯•

åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8088/order/101ï¼Œå¿«é€Ÿåˆ·æ–°5æ¬¡ï¼Œå¯ä»¥å‘ç°ï¼Œè§¦å‘äº†ç†”æ–­ï¼Œè¯·æ±‚æ—¶é•¿ç¼©çŸ­è‡³ 5msï¼Œå¿«é€Ÿå¤±è´¥äº†ï¼Œå¹¶ä¸”èµ°é™çº§é€»è¾‘ï¼Œè¿”å›çš„ null

![](https://cdn.xn2001.com/img/2022/202205091624280.png)

æ­¤æ—¶åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8088/order/102ï¼Œä¹Ÿè¢«ç†”æ–­äº†

![](https://cdn.xn2001.com/img/2022/202205091625297.png)

#### å¼‚å¸¸

**å¼‚å¸¸æ¯”ä¾‹æˆ–å¼‚å¸¸æ•°**ï¼šç»Ÿè®¡æŒ‡å®šæ—¶é—´å†…çš„è°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨æ¬¡æ•°è¶…è¿‡æŒ‡å®šè¯·æ±‚æ•°ï¼Œå¹¶ä¸”å‡ºç°å¼‚å¸¸çš„æ¯”ä¾‹è¾¾åˆ°è®¾å®šçš„æ¯”ä¾‹é˜ˆå€¼ï¼ˆæˆ–è¶…è¿‡æŒ‡å®šå¼‚å¸¸æ•°ï¼‰ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

ä¾‹å¦‚ï¼Œå¼‚å¸¸æ¯”ä¾‹è®¾ç½®å¦‚ä¸‹ï¼Œç»Ÿè®¡æœ€è¿‘ 1000ms å†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡ 10 æ¬¡ï¼Œå¹¶ä¸”å¼‚å¸¸æ¯”ä¾‹ä¸ä½äº 0.4ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

![](https://cdn.xn2001.com/img/2022/202205091520106.png)

å¼‚å¸¸æ•°è®¾ç½®å¦‚ä¸‹ï¼Œç»Ÿè®¡æœ€è¿‘ 1000ms å†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡ 10 æ¬¡ï¼Œå¹¶ä¸”å¼‚å¸¸æ¯”ä¾‹ä¸ä½äº 2 æ¬¡ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

![](https://cdn.xn2001.com/img/2022/202205091520416.png)

**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™ UserClient çš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œç»Ÿè®¡æ—¶é—´ä¸º 1sï¼Œæœ€å°è¯·æ±‚æ•°é‡ä¸º 5ï¼Œå¤±è´¥é˜ˆå€¼æ¯”ä¾‹ä¸º 0.4ï¼Œç†”æ–­æ—¶é•¿ä¸º 5s

1ï¼‰è®¾ç½®å¼‚å¸¸è¯·æ±‚

é¦–å…ˆï¼Œä¿®æ”¹ user-service ä¸­çš„ /user/{id} è¿™ä¸ªæ¥å£çš„ä¸šåŠ¡ã€‚æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œä»¥è§¦å‘å¼‚å¸¸æ¯”ä¾‹çš„ç†”æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œid ä¸º 2æ—¶ï¼Œå°±ä¼šè§¦å‘å¼‚å¸¸ã€‚

![](https://cdn.xn2001.com/img/2022/202205091520469.png)

2ï¼‰è®¾ç½®ç†”æ–­è§„åˆ™

åœ¨ 5 æ¬¡è¯·æ±‚ä¸­ï¼Œåªè¦å¼‚å¸¸æ¯”ä¾‹è¶…è¿‡ 0.4ï¼Œä¹Ÿå°±æ˜¯æœ‰ 2 æ¬¡ä»¥ä¸Šçš„å¼‚å¸¸ï¼Œå°±ä¼šè§¦å‘ç†”æ–­ã€‚

![](https://cdn.xn2001.com/img/2022/202205091818818.png)

![](https://cdn.xn2001.com/img/2022/202205091520694.png)

3ï¼‰æµ‹è¯•

åœ¨æµè§ˆå™¨å¿«é€Ÿè®¿é—®ï¼šhttp://localhost:8088/order/102ï¼Œå¿«é€Ÿåˆ·æ–° 5 æ¬¡ï¼Œè§¦å‘ç†”æ–­é™çº§ã€‚

![](https://cdn.xn2001.com/img/2022/202205091821790.png)

æ­¤æ—¶ï¼Œæˆ‘ä»¬å»è®¿é—®æœ¬åº”è¯¥æ­£å¸¸çš„ 103ï¼Œå‘ç°ä¹Ÿè¢«é™çº§äº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205091520623.png)

## æˆæƒè§„åˆ™

æˆæƒè§„åˆ™å¯ä»¥å¯¹è¯·æ±‚æ–¹æ¥æºåšåˆ¤æ–­å’Œæ§åˆ¶ã€‚æˆæƒè§„åˆ™å¯ä»¥å¯¹è°ƒç”¨æ–¹çš„æ¥æºåšæ§åˆ¶ï¼Œæœ‰ç™½åå•å’Œé»‘åå•ä¸¤ç§æ–¹å¼ã€‚

æ¯”å¦‚æˆ‘ä»¬å¸Œæœ›æ§åˆ¶å¯¹èµ„æº `test` çš„è®¿é—®è®¾ç½®ç™½åå•ï¼Œåªæœ‰æ¥æºä¸º `appA` å’Œ `appB` çš„è¯·æ±‚æ‰å¯é€šè¿‡ã€‚

- ç™½åå•ï¼šæ¥æºï¼ˆoriginï¼‰åœ¨ç™½åå•å†…çš„è°ƒç”¨è€…å…è®¸è®¿é—®

- é»‘åå•ï¼šæ¥æºï¼ˆoriginï¼‰åœ¨é»‘åå•å†…çš„è°ƒç”¨è€…ä¸å…è®¸è®¿é—®

ç‚¹å‡»å·¦ä¾§èœå•çš„æˆæƒï¼Œå¯ä»¥çœ‹åˆ°æˆæƒè§„åˆ™

![](https://cdn.xn2001.com/img/2022/202205100008770.png)

- èµ„æºåï¼šå°±æ˜¯å—ä¿æŠ¤çš„èµ„æºï¼Œä¾‹å¦‚ /order/{orderId}

- æµæ§åº”ç”¨ï¼šæ˜¯æ¥æºè€…çš„åå•
  - å¦‚æœæ˜¯å‹¾é€‰ç™½åå•ï¼Œåˆ™åå•ä¸­çš„æ¥æºè¢«è®¸å¯è®¿é—®ã€‚
  - å¦‚æœæ˜¯å‹¾é€‰é»‘åå•ï¼Œåˆ™åå•ä¸­çš„æ¥æºè¢«ç¦æ­¢è®¿é—®ã€‚

æ¯”å¦‚æˆ‘ä»¬å…è®¸è¯·æ±‚ä» gateway åˆ° order-serviceï¼Œä¸å…è®¸æµè§ˆå™¨è®¿é—® order-serviceï¼Œé‚£ä¹ˆç™½åå•ä¸­å°±è¦å¡«å†™**ç½‘å…³çš„æ¥æºåç§°ï¼ˆoriginï¼‰**ã€‚

![](https://cdn.xn2001.com/img/2022/202205100008679.png)

Sentinel æ˜¯é€šè¿‡ RequestOriginParser è¿™ä¸ªæ¥å£çš„ parseOrigin() æ–¹æ³•æ¥è·å–è¯·æ±‚çš„æ¥æºçš„ã€‚

```java
public interface RequestOriginParser {
    /**
     * ä»è¯·æ±‚requestå¯¹è±¡ä¸­è·å–originï¼Œè·å–æ–¹å¼è‡ªå®šä¹‰
     */
    String parseOrigin(HttpServletRequest request);
}
```

è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯ä» request å¯¹è±¡ä¸­ï¼Œè·å–è¯·æ±‚è€…çš„ origin å€¼å¹¶è¿”å›ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSentinel ä¸ç®¡è¯·æ±‚è€…ä»å“ªé‡Œæ¥ï¼Œè¿”å›å€¼æ°¸è¿œæ˜¯ defaultï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€åˆ‡è¯·æ±‚çš„æ¥æºéƒ½è¢«è®¤ä¸ºæ˜¯ä¸€æ ·çš„å€¼ default

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰è¿™ä¸ªæ¥å£çš„å®ç°ï¼Œè®©**ä¸åŒçš„è¯·æ±‚ï¼Œè¿”å›ä¸åŒçš„ origin**

ä¾‹å¦‚ order-service æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª RequestOriginParser çš„å®ç°ç±»

```java
@Component
public class HeaderOriginParser implements RequestOriginParser {
    @Override
    public String parseOrigin(HttpServletRequest request) {
        // 1.è·å–è¯·æ±‚å¤´
        String origin = request.getHeader("origin");
        // 2.éç©ºåˆ¤æ–­
        if (StringUtils.isEmpty(origin)) {
            origin = "blank";
        }
        return origin;
    }
}
```

æˆ‘ä»¬å¿…é¡»è®©**æ‰€æœ‰ä» Gateway è·¯ç”±åˆ°å¾®æœåŠ¡çš„è¯·æ±‚éƒ½å¸¦ä¸Š origin å¤´**ã€‚è¿™ä¸ªéœ€è¦åˆ©ç”¨ä¹‹å‰å­¦ä¹ çš„ä¸€ä¸ª GatewayFilter æ¥å®ç°ï¼Œä½¿ç”¨ AddRequestHeaderGatewayFilterï¼Œä¿®æ”¹ Gateway æœåŠ¡ä¸­çš„ application.yml

```yaml
spring:
  cloud:
    gateway:
      default-filters:
        - AddRequestHeader=origin,gateway #originå‰é¢ä¸èƒ½å¸¦ç©ºæ ¼
```

è¿™æ ·ï¼Œä» Gateway è·¯ç”±çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå¸¦ä¸Š origin å¤´ï¼Œå€¼ä¸º gatewayã€‚è€Œä»å…¶å®ƒåœ°æ–¹åˆ°è¾¾å¾®æœåŠ¡çš„è¯·æ±‚ä¸€èˆ¬æ²¡æœ‰è¿™ä¸ªå¤´ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæˆæƒè§„åˆ™ï¼Œæ”¾è¡Œ origin å€¼ä¸º gateway çš„è¯·æ±‚ã€‚

![](https://cdn.xn2001.com/img/2022/202205100104446.png)

![](https://cdn.xn2001.com/img/2022/202205100104442.png)

ç°åœ¨ï¼Œæˆ‘ä»¬ç›´æ¥è·³è¿‡ç½‘å…³ï¼Œè®¿é—® order-service æœåŠ¡

![](https://cdn.xn2001.com/img/2022/202205100104100.png)

é€šè¿‡ç½‘å…³è®¿é—®

![](https://cdn.xn2001.com/img/2022/202205100104271.png)

## è‡ªå®šä¹‰å¼‚å¸¸ç»“æœ

é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘ç”Ÿé™æµã€é™çº§ã€æˆæƒæ‹¦æˆªæ—¶ï¼Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸åˆ°è°ƒç”¨æ–¹ã€‚å¼‚å¸¸ç»“æœéƒ½æ˜¯ flow limmitingï¼ˆé™æµï¼‰ã€‚è¿™æ ·ä¸å¤Ÿå‹å¥½ï¼Œæ— æ³•å¾—çŸ¥æ˜¯é™æµè¿˜æ˜¯é™çº§è¿˜æ˜¯æˆæƒæ‹¦æˆªã€‚

è€Œå¦‚æœè¦è‡ªå®šä¹‰å¼‚å¸¸æ—¶çš„è¿”å›ç»“æœï¼Œéœ€è¦å®ç° BlockExceptionHandler æ¥å£

```java
public interface BlockExceptionHandler {
    /**
     * å¤„ç†è¯·æ±‚è¢«é™æµã€é™çº§ã€æˆæƒæ‹¦æˆªæ—¶æŠ›å‡ºçš„å¼‚å¸¸ï¼šBlockException
     */
    void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception;
}
```

è¿™ä¸ªæ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼š

- HttpServletRequest requestï¼šrequest å¯¹è±¡
- HttpServletResponse responseï¼šresponse å¯¹è±¡
- BlockException eï¼šè¢« Sentinel æ‹¦æˆªæ—¶æŠ›å‡ºçš„å¼‚å¸¸

è¿™é‡Œçš„ BlockException åŒ…å«å¤šä¸ªä¸åŒçš„å­ç±»

| **å¼‚å¸¸**             | **è¯´æ˜**           |
| -------------------- | ------------------ |
| FlowException        | é™æµå¼‚å¸¸           |
| ParamFlowException   | çƒ­ç‚¹å‚æ•°é™æµçš„å¼‚å¸¸ |
| DegradeException     | é™çº§å¼‚å¸¸           |
| AuthorityException   | æˆæƒè§„åˆ™å¼‚å¸¸       |
| SystemBlockException | ç³»ç»Ÿè§„åˆ™å¼‚å¸¸       |

è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ï¼Œä¸‹é¢æˆ‘ä»¬å°±åœ¨ order-service å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ç±»

```java
@Component
public class SentinelExceptionHandler implements BlockExceptionHandler {
    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception {
        String msg = "æœªçŸ¥å¼‚å¸¸";
        int status = 429;

        if (e instanceof FlowException) {
            msg = "è¯·æ±‚è¢«é™æµäº†";
        } else if (e instanceof ParamFlowException) {
            msg = "è¯·æ±‚è¢«çƒ­ç‚¹å‚æ•°é™æµ";
        } else if (e instanceof DegradeException) {
            msg = "è¯·æ±‚è¢«é™çº§äº†";
        } else if (e instanceof AuthorityException) {
            msg = "æ²¡æœ‰æƒé™è®¿é—®";
            status = 401;
        }

        response.setContentType("application/json;charset=utf-8");
        response.setStatus(status);
        response.getWriter().println("{\"msg\": " + msg + ", \"status\": " + status + "}");
    }
}
```

é‡å¯æµ‹è¯•ï¼Œåœ¨ä¸åŒåœºæ™¯ä¸‹ï¼Œä¼šè¿”å›ä¸åŒçš„å¼‚å¸¸æ¶ˆæ¯ã€‚

é™æµï¼š

![](https://cdn.xn2001.com/img/2022/202205100112438.png)

æˆæƒæ‹¦æˆªæ—¶ï¼š

![](https://cdn.xn2001.com/img/2022/202205100122438.png)

## è§„åˆ™æŒä¹…åŒ–

ç°åœ¨ï¼ŒSentinel çš„æ‰€æœ‰è§„åˆ™éƒ½æ˜¯å†…å­˜å­˜å‚¨ï¼Œé‡å¯åæ‰€æœ‰è§„åˆ™éƒ½ä¼šä¸¢å¤±ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿è¿™äº›è§„åˆ™çš„æŒä¹…åŒ–ï¼Œé¿å…ä¸¢å¤±ã€‚

è§„åˆ™æ˜¯å¦èƒ½æŒä¹…åŒ–ï¼Œå–å†³äºè§„åˆ™ç®¡ç†æ¨¡å¼ï¼ŒSentinel æ”¯æŒä¸‰ç§è§„åˆ™ç®¡ç†æ¨¡å¼

- åŸå§‹æ¨¡å¼ï¼šSentinel çš„é»˜è®¤æ¨¡å¼ï¼Œå°†è§„åˆ™ä¿å­˜åœ¨å†…å­˜ï¼Œé‡å¯æœåŠ¡ä¼šä¸¢å¤±ã€‚
- pull æ¨¡å¼
- push æ¨¡å¼

### pullæ¨¡å¼

pull æ¨¡å¼ï¼šæ§åˆ¶å°å°†é…ç½®çš„è§„åˆ™æ¨é€åˆ° Sentinel å®¢æˆ·ç«¯ï¼Œè€Œå®¢æˆ·ç«¯ä¼šå°†é…ç½®è§„åˆ™ä¿å­˜åœ¨æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­ã€‚ä»¥åä¼šå®šæ—¶å»æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­æŸ¥è¯¢ï¼Œæ›´æ–°æœ¬åœ°è§„åˆ™ã€‚

![](https://cdn.xn2001.com/img/2022/202205100126168.png)

### pushæ¨¡å¼

push æ¨¡å¼ï¼šæ§åˆ¶å°å°†é…ç½®è§„åˆ™æ¨é€åˆ°è¿œç¨‹é…ç½®ä¸­å¿ƒï¼Œä¾‹å¦‚ Nacosï¼ŒSentinel å®¢æˆ·ç«¯ç›‘å¬ Nacosï¼Œè·å–é…ç½®å˜æ›´çš„æ¨é€æ¶ˆæ¯ï¼Œå®Œæˆæœ¬åœ°é…ç½®æ›´æ–°ã€‚è¿™ç§æ¨¡å¼æ˜¯æ¯”è¾ƒå¥½çš„ä¸€ç§ã€‚

![](https://cdn.xn2001.com/img/2022/202205100128564.png)

æˆ‘ä»¬ç®€å•äº†è§£ä¸€ä¸‹è¿™ç§æ–¹å¼ï¼Œé¦–å…ˆä¿®æ”¹ OrderServiceï¼Œè®©å…¶ç›‘å¬ Nacos ä¸­çš„ Sentinel è§„åˆ™é…ç½®ã€‚

åœ¨ order-service ä¸­å¼•å…¥Sentinel ç›‘å¬ Nacos çš„ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```

é…ç½® Nacos åœ°å€ï¼Œåœ¨ order-service ä¸­çš„ application.yml æ–‡ä»¶é…ç½® Nacos åœ°å€åŠç›‘å¬çš„é…ç½®ä¿¡æ¯

```yaml
spring:
  cloud:
    sentinel:
      datasource:
        flow:
          nacos:
            server-addr: localhost:8848 # nacosåœ°å€
            dataId: orderservice-flow-rules
            groupId: SENTINEL_GROUP
            rule-type: flow # è¿˜å¯ä»¥æ˜¯ï¼šdegradeã€authorityã€param-flow
```

ç„¶åéœ€è¦ä¿®æ”¹ sentinel-dashboard æºç ï¼ŒSentinelDashboard é»˜è®¤ä¸æ”¯æŒ Nacos çš„æŒä¹…åŒ–ï¼Œéœ€è¦ä¿®æ”¹æºç ã€‚

> ç›¸å½“äºå¼€æºå¼€ä¸€åŠï¼Œä¸»è¦ç»™é˜¿é‡Œäº‘ç”¨æˆ·å•†ä¸šä½¿ç”¨ã€‚
>
> ä»¥ä¸‹ä»¥ä¾›äº†è§£ï¼Œæœªå®æµ‹ã€‚

è§£å‹ Sentinel æºç åŒ…

![](https://cdn.xn2001.com/img/2022/202205101404663.png)

ç„¶åå¹¶ç”¨ IDEA æ‰“å¼€è¿™ä¸ªé¡¹ç›®ï¼Œç»“æ„å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2022/202205101404666.png)

åœ¨ sentinel-dashboard æºç çš„pomæ–‡ä»¶ä¸­ï¼Œnacos çš„ä¾èµ–é»˜è®¤çš„ scope æ˜¯ testï¼Œåªèƒ½åœ¨æµ‹è¯•æ—¶ä½¿ç”¨ï¼Œè¿™é‡Œè¦å»é™¤

![](https://cdn.xn2001.com/img/2022/202205101405160.png)

å°† sentinel-datasource-nacos ä¾èµ–çš„ scope å»æ‰ï¼Œæ”¹æˆä¸‹é¢è¿™æ ·ã€‚

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```

åœ¨ sentinel-dashboard çš„ test åŒ…ä¸‹ï¼Œå·²ç»ç¼–å†™äº†å¯¹ nacos çš„æ”¯æŒï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ‹·è´åˆ° main ä¸­ã€‚

![](https://cdn.xn2001.com/img/2022/202205101405035.png)

ç„¶åï¼Œè¿˜éœ€è¦ä¿®æ”¹æµ‹è¯•ä»£ç ä¸­çš„ NacosConfig ç±» 

![](https://cdn.xn2001.com/img/2022/202205101406914.png)

ä¿®æ”¹å…¶ä¸­çš„ Nacos åœ°å€ï¼Œè®©å…¶è¯»å– application.properties ä¸­çš„é…ç½®

![](https://cdn.xn2001.com/img/2022/202205101404688.png)

åœ¨ sentinel-dashboard çš„ application.properties ä¸­æ·»åŠ  Nacos åœ°å€é…ç½®

```properties
nacos.addr=localhost:8848
```

å¦å¤–ï¼Œè¿˜éœ€è¦ä¿®æ”¹ `com.alibaba.csp.sentinel.dashboard.controller.v2` åŒ…ä¸‹çš„ FlowControllerV2

![](https://cdn.xn2001.com/img/2022/202205101404531.png)

è®©æˆ‘ä»¬æ·»åŠ çš„ Nacos æ•°æ®æºç”Ÿæ•ˆ

![](https://cdn.xn2001.com/img/2022/202205101407560.png)

æ¥ä¸‹æ¥ï¼Œè¿˜è¦ä¿®æ”¹å‰ç«¯é¡µé¢ï¼Œæ·»åŠ ä¸€ä¸ªæ”¯æŒ nacos çš„èœå•ã€‚

ä¿®æ”¹ `src/main/webapp/resources/app/scripts/directives/sidebar/` ç›®å½•ä¸‹çš„ sidebar.html æ–‡ä»¶

![](https://cdn.xn2001.com/img/2022/202205101404891.png)

å°†å…¶ä¸­çš„è¿™éƒ¨åˆ†æ³¨é‡Šæ‰“å¼€

![](https://cdn.xn2001.com/img/2022/202205101408124.png)

ä¿®æ”¹å…¶ä¸­çš„æ–‡æœ¬

![](https://cdn.xn2001.com/img/2022/202205101408073.png)

è¿è¡Œ IDEA ä¸­çš„ maven æ’ä»¶ï¼Œç¼–è¯‘å’Œæ‰“åŒ…ä¿®æ”¹å¥½çš„ sentinel-dashboard

![](https://cdn.xn2001.com/img/2022/202205101408008.png)

å¯åŠ¨æ–¹å¼è·Ÿå®˜æ–¹ä¸€æ ·

```sh
java -jar sentinel-dashboard.jar
```

å¦‚æœè¦ä¿®æ”¹ Nacos åœ°å€ï¼Œå¯ä»¥æ·»åŠ å‚æ•°

```sh
java -jar -Dnacos.addr=localhost:8848 sentinel-dashboard.jar
```

# Seataåˆ†å¸ƒå¼äº‹åŠ¡

> ä»£ç å‚è€ƒï¼š
>
> Giteeï¼šhttps://gitee.com/xn2001/cloudcode/tree/master/11-seata-demo
>
> GitHubï¼šhttps://github.com/lexinhu/cloudcode/tree/master/11-seata-demo

## åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜

> æ­¤å¤„å¯ç»“åˆ MySQL äº‹åŠ¡ä¸€èµ·å­¦ä¹ ï¼Œå¯ç›´æ¥æŸ¥çœ‹è¯¥ç¬”è®°
>
> <a class="post_link" href="https://www.xn2001.com/archives/677.html"><i data-feather="file-text"></i>MySQLå…¥é—¨åˆ°ç²¾é€šï¼Ÿ</a>

åœ¨ä¼ ç»Ÿæ•°æ®åº“äº‹åŠ¡ä¸­ï¼Œå¿…é¡»è¦æ»¡è¶³å››ä¸ªåŸåˆ™ï¼Œæˆ‘ä»¬æŠŠä»–ç§°ä¸º ACID

![](https://cdn.xn2001.com/img/2022/202205231445816.png)

**åˆ†å¸ƒå¼äº‹åŠ¡**ï¼Œå°±æ˜¯æŒ‡ä¸æ˜¯åœ¨å•ä¸ªæœåŠ¡æˆ–å•ä¸ªæ•°æ®åº“æ¶æ„ä¸‹ï¼Œäº§ç”Ÿçš„äº‹åŠ¡ï¼Œä¾‹å¦‚

- è·¨æ•°æ®æºçš„åˆ†å¸ƒå¼äº‹åŠ¡
- è·¨æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡
- ç»¼åˆæƒ…å†µ

åœ¨æ•°æ®åº“æ°´å¹³æ‹†åˆ†ã€æœåŠ¡å‚ç›´æ‹†åˆ†ä¹‹åï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œé€šå¸¸è¦è·¨å¤šä¸ªæ•°æ®åº“ã€æœåŠ¡æ‰èƒ½å®Œæˆã€‚ä¾‹å¦‚ç”µå•†è¡Œä¸šä¸­æ¯”è¾ƒå¸¸è§çš„ä¸‹å•ä»˜æ¬¾æ¡ˆä¾‹ï¼ŒåŒ…æ‹¬ä¸‹é¢å‡ ä¸ªè¡Œä¸ºï¼š

1. åˆ›å»ºæ–°è®¢å•
2. æ‰£å‡å•†å“åº“å­˜
3. ä»ç”¨æˆ·è´¦æˆ·ä½™é¢æ‰£é™¤é‡‘é¢

å®Œæˆä¸Šé¢çš„æ“ä½œéœ€è¦è®¿é—®ä¸‰ä¸ªä¸åŒçš„å¾®æœåŠ¡å’Œä¸‰ä¸ªä¸åŒçš„æ•°æ®åº“ã€‚

![](https://cdn.xn2001.com/img/2022/202205231447738.png)

è®¢å•çš„åˆ›å»ºã€åº“å­˜çš„æ‰£å‡ã€è´¦æˆ·æ‰£æ¬¾åœ¨æ¯ä¸€ä¸ªæœåŠ¡å’Œæ•°æ®åº“å†…æ˜¯ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œå¯ä»¥ä¿è¯ ACID åŸåˆ™ã€‚

ä½†æ˜¯å½“æˆ‘ä»¬æŠŠä¸‰ä»¶äº‹æƒ…çœ‹åšä¸€ä¸ª"ä¸šåŠ¡"ï¼Œè¦æ»¡è¶³ä¿è¯â€œä¸šåŠ¡â€çš„åŸå­æ€§ï¼Œè¦ä¹ˆæ‰€æœ‰æ“ä½œå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å…è®¸å‡ºç°éƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥çš„ç°è±¡ï¼Œè¿™å°±æ˜¯**åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹çš„äº‹åŠ¡**ã€‚æ­¤æ—¶ ACID éš¾ä»¥æ»¡è¶³ï¼Œè¿™æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡è¦è§£å†³çš„é—®é¢˜ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªé¡¹ç›®æ¼”ç¤ºï¼Œå¦‚ä¸‹å›¾æœ‰ä¸€ä¸ªå¾®æœåŠ¡é¡¹ç›®

![](https://cdn.xn2001.com/img/2022/202205231502038.png)

å…¶ä¸­ï¼šseata-demo æ˜¯çˆ¶å·¥ç¨‹ï¼Œè´Ÿè´£ç®¡ç†é¡¹ç›®ä¾èµ–

- account-serviceï¼šè´¦æˆ·æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ã€‚æä¾›æ‰£å‡ä½™é¢çš„æ¥å£
- storage-serviceï¼šåº“å­˜æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†å•†å“åº“å­˜ã€‚æä¾›æ‰£å‡åº“å­˜çš„æ¥å£
- order-serviceï¼šè®¢å•æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†è®¢å•ã€‚åˆ›å»ºè®¢å•æ—¶ï¼Œéœ€è¦è°ƒç”¨ account-service å’Œ storage-service

æˆ‘ä»¬å»åˆ›å»ºè®¢å•ï¼Œå‘é€ POST è¯·æ±‚

```
curl --location --request POST 'http://localhost:8082/order?userId=user202103032042012&amp;commodityCode=100202003032041&amp;count=20&amp;money=200'
```

æµ‹è¯•å‘ç°ï¼Œå½“åº“å­˜ä¸è¶³æ—¶ï¼Œæ­¤æ—¶è´¦æˆ·ä½™é¢å·²ç»æ‰£å‡ï¼Œå¹¶ä¸ä¼šå›æ»šï¼Œå‡ºç°äº†åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ã€‚

![](https://cdn.xn2001.com/img/2022/202205231505539.png)

## è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡

### CAPå®šç†

1998å¹´ï¼ŒåŠ å·å¤§å­¦çš„è®¡ç®—æœºç§‘å­¦å®¶ Eric Brewer æå‡ºï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæœ‰ä¸‰ä¸ªæŒ‡æ ‡ã€‚

> - Consistencyï¼ˆä¸€è‡´æ€§ï¼‰
> - Availabilityï¼ˆå¯ç”¨æ€§ï¼‰
> - Partition tolerance ï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰

å®ƒä»¬çš„ç¬¬ä¸€ä¸ªå­—æ¯åˆ†åˆ«æ˜¯ Cã€Aã€Pã€‚

Eric Brewer è¯´ï¼Œè¿™ä¸‰ä¸ªæŒ‡æ ‡ä¸å¯èƒ½åŒæ—¶åšåˆ°ã€‚è¿™ä¸ªç»“è®ºå°±å«åš CAP å®šç†ã€‚

![](https://cdn.xn2001.com/img/2022/202205231506789.png)

#### Consistencyä¸€è‡´æ€§

Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šç”¨æˆ·è®¿é—®åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä»»æ„èŠ‚ç‚¹ï¼Œå¾—åˆ°çš„æ•°æ®å¿…é¡»ä¸€è‡´ã€‚

æ¯”å¦‚ç°åœ¨åŒ…å«ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå…¶ä¸­çš„åˆå§‹æ•°æ®æ˜¯ä¸€è‡´çš„

![](https://cdn.xn2001.com/img/2022/202205231506787.png)

å½“æˆ‘ä»¬ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®æ—¶ï¼Œä¸¤è€…çš„æ•°æ®äº§ç”Ÿäº†å·®å¼‚

![](https://cdn.xn2001.com/img/2022/202205231506790.png)

è¦æƒ³ä¿ä½ä¸€è‡´æ€§ï¼Œå°±å¿…é¡»å®ç° node01 åˆ° node02 çš„æ•°æ®åŒæ­¥

![](https://cdn.xn2001.com/img/2022/202205231506801.png)



#### Availabilityå¯ç”¨æ€§

Availability ï¼ˆå¯ç”¨æ€§ï¼‰ï¼šç”¨æˆ·è®¿é—®é›†ç¾¤ä¸­çš„ä»»æ„å¥åº·èŠ‚ç‚¹ï¼Œå¿…é¡»èƒ½å¾—åˆ°å“åº”ï¼Œè€Œä¸æ˜¯è¶…æ—¶æˆ–æ‹’ç»ã€‚

å¦‚å›¾ï¼Œæœ‰ä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œè®¿é—®ä»»ä½•ä¸€ä¸ªéƒ½å¯ä»¥åŠæ—¶å¾—åˆ°å“åº”

![](https://cdn.xn2001.com/img/2022/202205231506803.png)

å½“æœ‰éƒ¨åˆ†èŠ‚ç‚¹å› ä¸ºç½‘ç»œæ•…éšœæˆ–å…¶å®ƒåŸå› æ— æ³•è®¿é—®æ—¶ï¼Œä»£è¡¨èŠ‚ç‚¹ä¸å¯ç”¨

![](https://cdn.xn2001.com/img/2022/202205231506810.png)

#### Partition Toleranceåˆ†åŒºå®¹é”™

Partitionï¼ˆåˆ†åŒºï¼‰ï¼šå› ä¸ºç½‘ç»œæ•…éšœæˆ–å…¶å®ƒåŸå› å¯¼è‡´åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„éƒ¨åˆ†èŠ‚ç‚¹ä¸å…¶å®ƒèŠ‚ç‚¹å¤±å»è¿æ¥ï¼Œå½¢æˆç‹¬ç«‹åˆ†åŒºã€‚

Toleranceï¼ˆå®¹é”™ï¼‰ï¼šåœ¨é›†ç¾¤å‡ºç°åˆ†åŒºæ—¶ï¼Œæ•´ä¸ªç³»ç»Ÿä¹Ÿè¦æŒç»­å¯¹å¤–æä¾›æœåŠ¡ã€‚

![](https://cdn.xn2001.com/img/2022/202205231506703.png)

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç³»ç»Ÿé—´çš„ç½‘ç»œä¸èƒ½ 100% ä¿è¯å¥åº·ï¼Œä¸€å®šä¼šæœ‰æ•…éšœçš„æ—¶å€™ï¼Œè€ŒæœåŠ¡æœ‰å¿…é¡»å¯¹å¤–ä¿è¯æœåŠ¡ã€‚**å› æ­¤ Partition Tolerance ä¸å¯é¿å…ã€‚**å½“èŠ‚ç‚¹æ¥æ”¶åˆ°æ–°çš„æ•°æ®å˜æ›´æ—¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜äº†ã€‚

![](https://cdn.xn2001.com/img/2022/202205231506722.png)

å¦‚æœæ­¤æ—¶è¦ä¿è¯**ä¸€è‡´æ€§**ï¼Œå°±å¿…é¡»ç­‰å¾…ç½‘ç»œæ¢å¤ï¼Œå®Œæˆæ•°æ®åŒæ­¥åï¼Œæ•´ä¸ªé›†ç¾¤æ‰å¯¹å¤–æä¾›æœåŠ¡ï¼ŒæœåŠ¡å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å¯ç”¨ã€‚

å¦‚æœæ­¤æ—¶è¦ä¿è¯**å¯ç”¨æ€§**ï¼Œå°±ä¸èƒ½ç­‰å¾…ç½‘ç»œæ¢å¤ï¼Œé‚£ node01ã€node02 ä¸ node03 ä¹‹é—´å°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ P ä¸€å®šä¼šå‡ºç°çš„æƒ…å†µä¸‹ï¼ŒA å’Œ C ä¹‹é—´åªèƒ½å®ç°ä¸€ä¸ªã€‚

### BASEç†è®º

BASE ç†è®ºæ˜¯å¯¹ CAP çš„ä¸€ç§è§£å†³æ€è·¯ï¼ŒåŒ…å«ä¸‰ä¸ªæ€æƒ³ï¼š

- **Basically Available** **ï¼ˆåŸºæœ¬å¯ç”¨ï¼‰**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œå³ä¿è¯æ ¸å¿ƒå¯ç”¨ã€‚
- **Soft Stateï¼ˆè½¯çŠ¶æ€ï¼‰**ï¼šåœ¨ä¸€å®šæ—¶é—´å†…ï¼Œå…è®¸å‡ºç°ä¸­é—´çŠ¶æ€ï¼Œæ¯”å¦‚ä¸´æ—¶çš„ä¸ä¸€è‡´çŠ¶æ€ã€‚
- **Eventually Consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰**ï¼šè™½ç„¶æ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯åœ¨è½¯çŠ¶æ€ç»“æŸåï¼Œæœ€ç»ˆè¾¾åˆ°æ•°æ®ä¸€è‡´ã€‚

åˆ†å¸ƒå¼äº‹åŠ¡æœ€å¤§çš„é—®é¢˜æ˜¯å„ä¸ªå­äº‹åŠ¡çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå› æ­¤å¯ä»¥å€Ÿé‰´ CAPå®šç† å’Œ BASEç†è®ºï¼Œæœ‰ä¸¤ç§è§£å†³æ€è·¯

- AP æ¨¡å¼ï¼šå„å­äº‹åŠ¡åˆ†åˆ«æ‰§è¡Œå’Œæäº¤ï¼Œå…è®¸å‡ºç°ç»“æœä¸ä¸€è‡´ï¼Œç„¶åé‡‡ç”¨å¼¥è¡¥æªæ–½æ¢å¤æ•°æ®å³å¯ï¼Œå®ç°æœ€ç»ˆä¸€è‡´ã€‚

- CP æ¨¡å¼ï¼šå„ä¸ªå­äº‹åŠ¡æ‰§è¡Œåäº’ç›¸ç­‰å¾…ï¼ŒåŒæ—¶æäº¤ï¼ŒåŒæ—¶å›æ»šï¼Œè¾¾æˆå¼ºä¸€è‡´ã€‚ä½†äº‹åŠ¡ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¤„äºå¼±å¯ç”¨çŠ¶æ€ã€‚

> å‰é¢æˆ‘ä»¬æ‰€å­¦çš„ Elasticsearch é›†ç¾¤å°±æ˜¯ CP æ¨¡å¼ï¼Œä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚

è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå„ä¸ªå­ç³»ç»Ÿä¹‹é—´å¿…é¡»èƒ½æ„ŸçŸ¥å½¼æ­¤çš„äº‹åŠ¡çŠ¶æ€ï¼Œæ‰èƒ½ä¿è¯çŠ¶æ€ä¸€è‡´ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªäº‹åŠ¡åè°ƒè€…æ¥åè°ƒæ¯ä¸€ä¸ªäº‹åŠ¡çš„å‚ä¸è€…ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä¸€ä¸ªäº‹åŠ¡åè°ƒè€…ã€‚ï¼ˆTCï¼‰

å¦å¤–ï¼Œè¿™é‡Œçš„å­ç³»ç»Ÿäº‹åŠ¡ï¼Œç§°ä¸º**åˆ†æ”¯äº‹åŠ¡**ï¼›æœ‰å…³è”çš„å„ä¸ªåˆ†æ”¯äº‹åŠ¡åœ¨ä¸€èµ·ç§°ä¸º**å…¨å±€äº‹åŠ¡**ã€‚

![](https://cdn.xn2001.com/img/2022/202205231506031.png)

## éƒ¨ç½²Seata

Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚

å®˜ç½‘åœ°å€ï¼šhttp://seata.io/ï¼Œå…¶ä¸­çš„æ–‡æ¡£ã€æ’­å®¢ä¸­æä¾›äº†å¤§é‡çš„ä½¿ç”¨è¯´æ˜ã€æºç åˆ†æã€‚

![](https://cdn.xn2001.com/img/2022/202205231707983.png)

### Seataçš„æ¶æ„

Seata äº‹åŠ¡ç®¡ç†ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„è§’è‰²

- **TC (Transaction Coordinator) -** **äº‹åŠ¡åè°ƒè€…**ï¼šç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œåè°ƒå…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚

- **TM (Transaction Manager) -** **äº‹åŠ¡ç®¡ç†å™¨**ï¼šå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ã€å¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚

- **RM (Resource Manager) -** **èµ„æºç®¡ç†å™¨**ï¼šç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸ TC äº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚

![](https://cdn.xn2001.com/img/2022/202205231704030.png)

Seata åŸºäºä¸Šè¿°æ¶æ„æä¾›äº†å››ç§ä¸åŒçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ

- XA æ¨¡å¼ï¼šå¼ºä¸€è‡´æ€§åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œç‰ºç‰²äº†ä¸€å®šçš„å¯ç”¨æ€§ï¼Œæ— ä¸šåŠ¡ä¾µå…¥
- TCC æ¨¡å¼ï¼šæœ€ç»ˆä¸€è‡´çš„åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œæœ‰ä¸šåŠ¡ä¾µå…¥
- AT æ¨¡å¼ï¼šæœ€ç»ˆä¸€è‡´çš„åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œæ— ä¸šåŠ¡ä¾µå…¥ï¼Œä¹Ÿæ˜¯ Seata çš„é»˜è®¤æ¨¡å¼
- SAGA æ¨¡å¼ï¼šé•¿äº‹åŠ¡æ¨¡å¼ï¼Œæœ‰ä¸šåŠ¡ä¾µå…¥

æ— è®ºå“ªç§æ–¹æ¡ˆï¼Œéƒ½ç¦»ä¸å¼€ TCï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡çš„åè°ƒè€…ã€‚

![](https://cdn.xn2001.com/img/2022/202205232202909.png)

### éƒ¨ç½²TCæœåŠ¡

ä¸‹è½½ seata-server åŒ…ï¼Œhttps://seata.io/zh-cn/blog/download.html

åœ¨éä¸­æ–‡ç›®å½•è§£å‹ç¼©ï¼Œå…¶ç›®å½•ç»“æ„å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2022/202205241709346.png)

ä¿®æ”¹ conf ç›®å½•ä¸‹çš„ registry.conf æ–‡ä»¶

![](https://cdn.xn2001.com/img/2022/202205241709343.png)

```properties
registry {
  # tcæœåŠ¡çš„æ³¨å†Œä¸­å¿ƒç±»ï¼Œè¿™é‡Œé€‰æ‹©nacosï¼Œä¹Ÿå¯ä»¥æ˜¯eurekaã€zookeeperç­‰
  type = "nacos"

  nacos {
    # seata tc æœåŠ¡æ³¨å†Œåˆ° nacosçš„æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
    application = "seata-tc-server"
    serverAddr = "127.0.0.1:8848"
    group = "DEFAULT_GROUP"
    namespace = ""
    cluster = "SH"
    username = "nacos"
    password = "nacos"
  }
}

config {
  # è¯»å–tcæœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä»nacosé…ç½®ä¸­å¿ƒè¯»å–ï¼Œè¿™æ ·å¦‚æœtcæ˜¯é›†ç¾¤ï¼Œå¯ä»¥å…±äº«é…ç½®
  type = "nacos"
  # é…ç½®nacosåœ°å€ç­‰ä¿¡æ¯
  nacos {
    serverAddr = "127.0.0.1:8848"
    namespace = ""
    group = "DEFAULT_GROUP"
    username = "nacos"
    password = "nacos"
    dataId = "seataServer.properties"
  }
}
```

ä¸ºäº†è®© TC æœåŠ¡çš„é›†ç¾¤å¯ä»¥å…±äº«é…ç½®ï¼Œæˆ‘ä»¬é€‰æ‹©äº† Nacos ä½œä¸ºç»Ÿä¸€é…ç½®ä¸­å¿ƒã€‚å› æ­¤æœåŠ¡ç«¯é…ç½®æ–‡ä»¶ `seataServer.properties` æ–‡ä»¶éœ€è¦åœ¨Nacos ä¸­é…å¥½ã€‚åœ¨ Nacos åå°æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼šhttp://localhost:8848/nacos/

![](https://cdn.xn2001.com/img/2022/202205241709375.png)



é…ç½®å†…å®¹å¦‚ä¸‹

> æ³¨æ„ï¼šä¸€å®šè¦æŠŠæ³¨é‡Šåˆ æ‰ï¼è¦ä¿®æ”¹ä½ çš„æ•°æ®åº“ä¿¡æ¯ã€‚

```properties
# æ•°æ®å­˜å‚¨æ–¹å¼ï¼Œdbä»£è¡¨æ•°æ®åº“
store.mode=db
store.db.datasource=druid
store.db.dbType=mysql
# è¿™æ˜¯MySQL8çš„é©±åŠ¨ï¼ŒMySQL5ä½¿ç”¨çš„æ˜¯com.mysql.jdbc.Driver
store.db.driverClassName=com.mysql.cj.jdbc.Driver
# æ•°æ®åº“åœ°å€ã€ç”¨æˆ·åã€å¯†ç éƒ½éœ€è¦ä¿®æ”¹æˆä½ è‡ªå·±çš„æ•°æ®åº“ä¿¡æ¯ã€‚
store.db.url=jdbc:mysql://127.0.0.1:3306/seata?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=GMT%2B8
store.db.user=root
store.db.password=123456
store.db.minConn=5
store.db.maxConn=30
store.db.globalTable=global_table
store.db.branchTable=branch_table
store.db.queryLimit=100
store.db.lockTable=lock_table
store.db.maxWait=5000
# äº‹åŠ¡ã€æ—¥å¿—ç­‰é…ç½®
server.recovery.committingRetryPeriod=1000
server.recovery.asynCommittingRetryPeriod=1000
server.recovery.rollbackingRetryPeriod=1000
server.recovery.timeoutRetryPeriod=1000
server.maxCommitRetryTimeout=-1
server.maxRollbackRetryTimeout=-1
server.rollbackRetryTimeoutUnlockEnable=false
server.undo.logSaveDays=7
server.undo.logDeletePeriod=86400000
# å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¼ è¾“æ–¹å¼
transport.serialization=seata
transport.compressor=none
# å…³é—­metricsåŠŸèƒ½ï¼Œæé«˜æ€§èƒ½
metrics.enabled=false
metrics.registryType=compact
metrics.exporterList=prometheus
metrics.exporterPrometheusPort=9898
```

TC æœåŠ¡åœ¨ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œéœ€è¦è®°å½•äº‹åŠ¡ç›¸å…³æ•°æ®åˆ°æ•°æ®åº“ä¸­ï¼Œä½ éœ€è¦æå‰åˆ›å»ºå¥½è¿™äº›è¡¨ã€‚æ–°å»ºä¸€ä¸ªåä¸º seata çš„æ•°æ®åº“ï¼Œè¿è¡Œ SQL

è¿™äº›è¡¨ä¸»è¦è®°å½•å…¨å±€äº‹åŠ¡ã€åˆ†æ”¯äº‹åŠ¡ã€å…¨å±€é”ä¿¡æ¯ã€‚

```mysql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for branch_table
-- ----------------------------
DROP TABLE IF EXISTS `branch_table`;
CREATE TABLE `branch_table`  (
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `resource_group_id` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `resource_id` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `branch_type` varchar(8) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `status` tinyint(4) NULL DEFAULT NULL,
  `client_id` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `application_data` varchar(2000) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime(6) NULL DEFAULT NULL,
  `gmt_modified` datetime(6) NULL DEFAULT NULL,
  PRIMARY KEY (`branch_id`) USING BTREE,
  INDEX `idx_xid`(`xid`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- Records of branch_table
-- ----------------------------

-- ----------------------------
-- Table structure for global_table
-- ----------------------------
DROP TABLE IF EXISTS `global_table`;
CREATE TABLE `global_table`  (
  `xid` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `status` tinyint(4) NOT NULL,
  `application_id` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_service_group` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_name` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `timeout` int(11) NULL DEFAULT NULL,
  `begin_time` bigint(20) NULL DEFAULT NULL,
  `application_data` varchar(2000) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime NULL DEFAULT NULL,
  `gmt_modified` datetime NULL DEFAULT NULL,
  PRIMARY KEY (`xid`) USING BTREE,
  INDEX `idx_gmt_modified_status`(`gmt_modified`, `status`) USING BTREE,
  INDEX `idx_transaction_id`(`transaction_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- Records of global_table
-- ----------------------------


-- ----------------------------
-- Records of lock_table
-- ----------------------------

SET FOREIGN_KEY_CHECKS = 1;

```

è¿›å…¥ bin ç›®å½•ï¼Œè¿è¡Œå…¶ä¸­çš„ seata-server.bat å³å¯ã€‚

![](https://cdn.xn2001.com/img/2022/202205241709380.png)

å¯åŠ¨æˆåŠŸåï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® Nacos åœ°å€ï¼šhttp://localhost:8848ï¼Œç„¶åè¿›å…¥æœåŠ¡åˆ—è¡¨é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ° seata-tc-server çš„ä¿¡æ¯ã€‚

![](https://cdn.xn2001.com/img/2022/202205241709137.png)

### Seataå¾®æœåŠ¡é›†æˆ

> å¾ˆå¤šäººè¯´è¿™é‡Œå¾ˆéš¾ï¼Œå¯åŠ¨è€æ˜¯å¤±è´¥ï¼Œæ³¨æ„æ£€æŸ¥å¥½ä¸Šä¸€æ­¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œæ¯”å¦‚é›†ç¾¤æ˜¯å¦æ˜¯ SHï¼Œåˆ†åŒºæ˜¯å¦æ˜¯ DEFAULT_GROUPï¼Œå®ä¾‹åæ˜¯å¦æ˜¯ seata-tc-server

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¾®æœåŠ¡ä¸­å¼•å…¥ Seata ä¾èµ–

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
    <exclusions>
        <!--ç‰ˆæœ¬è¾ƒä½ï¼Œ1.3.0ï¼Œå› æ­¤æ’é™¤-->
        <exclusion>
            <artifactId>seata-spring-boot-starter</artifactId>
            <groupId>io.seata</groupId>
        </exclusion>
    </exclusions>
</dependency>
<!--seata starter é‡‡ç”¨1.4.2ç‰ˆæœ¬-->
<dependency>
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>${seata.version}</version>
</dependency>
```

éœ€è¦ä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œæ·»åŠ ä¸€äº›é…ç½®ï¼Œä¾‹å¦‚åœ¨ order-service æœåŠ¡ä¸­çš„ application.ymlï¼Œé…ç½® TC æœåŠ¡ä¿¡æ¯ï¼Œé€šè¿‡æ³¨å†Œä¸­å¿ƒ Nacosï¼Œç»“åˆæœåŠ¡åç§°è·å– TC åœ°å€

```yaml
seata:
  registry: # TCæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„é…ç½®ï¼Œå¾®æœåŠ¡æ ¹æ®è¿™äº›ä¿¡æ¯å»æ³¨å†Œä¸­å¿ƒè·å–tcæœåŠ¡åœ°å€
    type: nacos # æ³¨å†Œä¸­å¿ƒç±»å‹ nacos
    nacos:
      server-addr: 127.0.0.1:8848 # nacosåœ°å€
      namespace: "" # namespaceï¼Œé»˜è®¤ä¸ºç©º
      group: DEFAULT_GROUP # åˆ†ç»„ï¼Œé»˜è®¤æ˜¯DEFAULT_GROUP
      application: seata-tc-server # seataæœåŠ¡åç§°
      username: nacos
      password: nacos
  tx-service-group: seata-demo # äº‹åŠ¡ç»„åç§°
  service:
    vgroup-mapping: # äº‹åŠ¡ç»„ä¸clusterçš„æ˜ å°„å…³ç³»
      seata-demo: SH
```

å¾®æœåŠ¡å¦‚ä½•æ ¹æ®è¿™äº›é…ç½®å¯»æ‰¾ TC åœ°å€çš„ï¼Œæˆ‘ä»¬çŸ¥é“æ³¨å†Œåˆ° Nacos ä¸­çš„å¾®æœåŠ¡ï¼Œç¡®å®šä¸€ä¸ªå…·ä½“å®ä¾‹éœ€è¦å››ä¸ªä¿¡æ¯ï¼Œ`namespace+group+application+cluster`

- namespaceï¼šå‘½åç©ºé—´ï¼Œä¸ºç©ºå°±æ˜¯é»˜è®¤çš„ public
- groupï¼šåˆ†ç»„
- applicationï¼šæœåŠ¡å
- clusterï¼šé›†ç¾¤å

ä»¥ä¸Šå››ä¸ªä¿¡æ¯ï¼Œåœ¨åˆšæ‰çš„ yml æ–‡ä»¶ä¸­éƒ½èƒ½æ‰¾åˆ°ã€‚

![](https://cdn.xn2001.com/img/2022/202205241726339.png)

ç»“åˆèµ·æ¥ï¼ŒTC æœåŠ¡çš„ä¿¡æ¯å°±æ˜¯ï¼š`public@DEFAULT_GROUP@seata-tc-server@SH`ï¼Œè¿™æ ·å°±èƒ½ç¡®å®š TC æœåŠ¡é›†ç¾¤äº†ã€‚ç„¶åå°±å¯ä»¥å» Nacosæ‹‰å–å¯¹åº”çš„å®ä¾‹ä¿¡æ¯ã€‚

å¯åŠ¨å¾®æœåŠ¡åï¼ŒSeata æ§åˆ¶å°ä¼šæ˜¾ç¤ºè¿æ¥ä¸Šçš„æœåŠ¡ã€‚

![](https://cdn.xn2001.com/img/2022/202205242305852.png)

### TCæœåŠ¡å¼‚åœ°å®¹ç¾

1.æ¨¡æ‹Ÿå¼‚åœ°å®¹ç¾çš„ TC é›†ç¾¤

è®¡åˆ’å¯åŠ¨ä¸¤å° Seata çš„ TC æœåŠ¡èŠ‚ç‚¹

| èŠ‚ç‚¹åç§° | ipåœ°å€    | ç«¯å£å· | é›†ç¾¤åç§° |
| -------- | --------- | ------ | -------- |
| seata    | 127.0.0.1 | 8091   | SH       |
| seata2   | 127.0.0.1 | 8092   | HZ       |

ä¹‹å‰æˆ‘ä»¬å·²ç»å¯åŠ¨äº†ä¸€å° seata æœåŠ¡ï¼Œç«¯å£æ˜¯ 8091ï¼Œé›†ç¾¤åä¸º SHã€‚

ç°åœ¨ï¼Œå°† seata ç›®å½•å¤åˆ¶ä¸€ä»½ï¼Œèµ·åä¸º seata2

ä¿®æ”¹ seata2/conf/registry.conf å†…å®¹å¦‚ä¸‹

```nginx
registry {
  # tcæœåŠ¡çš„æ³¨å†Œä¸­å¿ƒç±»ï¼Œè¿™é‡Œé€‰æ‹©nacosï¼Œä¹Ÿå¯ä»¥æ˜¯eurekaã€zookeeperç­‰
  type = "nacos"

  nacos {
    # seata tc æœåŠ¡æ³¨å†Œåˆ° nacosçš„æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
    application = "seata-tc-server"
    serverAddr = "127.0.0.1:8848"
    group = "DEFAULT_GROUP"
    namespace = ""
    cluster = "HZ"
    username = "nacos"
    password = "nacos"
  }
}

config {
  # è¯»å–tcæœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä»nacosé…ç½®ä¸­å¿ƒè¯»å–ï¼Œè¿™æ ·å¦‚æœtcæ˜¯é›†ç¾¤ï¼Œå¯ä»¥å…±äº«é…ç½®
  type = "nacos"
  # é…ç½®nacosåœ°å€ç­‰ä¿¡æ¯
  nacos {
    serverAddr = "127.0.0.1:8848"
    namespace = ""
    group = "SEATA_GROUP"
    username = "nacos"
    password = "nacos"
    dataId = "seataServer.properties"
  }
}
```

è¿›å…¥ seata2/bin ç›®å½•ï¼Œç„¶åè¿è¡Œå‘½ä»¤

```powershell
seata-server.bat -p 8092
```

æ‰“å¼€ nacos æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æœåŠ¡åˆ—è¡¨

![](https://cdn.xn2001.com/img/2022/202205241709152.png)

![](https://cdn.xn2001.com/img/2022/202205241709154.png)

2.å°†äº‹åŠ¡ç»„æ˜ å°„é…ç½®åˆ° nacos

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°† tx-service-group ä¸ cluster çš„æ˜ å°„å…³ç³»éƒ½é…ç½®åˆ° Nacos é…ç½®ä¸­å¿ƒã€‚

æ–°å»ºä¸€ä¸ªé…ç½®

![](https://cdn.xn2001.com/img/2022/202205241709167.png)

é…ç½®çš„å†…å®¹å¦‚ä¸‹

```properties
# äº‹åŠ¡ç»„æ˜ å°„å…³ç³»
service.vgroupMapping.seata-demo=SH
service.enableDegrade=false
service.disableGlobalTransaction=false
# ä¸TCæœåŠ¡çš„é€šä¿¡é…ç½®
transport.type=TCP
transport.server=NIO
transport.heartbeat=true
transport.enableClientBatchSendRequest=false
transport.threadFactory.bossThreadPrefix=NettyBoss
transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker
transport.threadFactory.serverExecutorThreadPrefix=NettyServerBizHandler
transport.threadFactory.shareBossWorker=false
transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector
transport.threadFactory.clientSelectorThreadSize=1
transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread
transport.threadFactory.bossThreadSize=1
transport.threadFactory.workerThreadSize=default
transport.shutdown.wait=3
# RMé…ç½®
client.rm.asyncCommitBufferLimit=10000
client.rm.lock.retryInterval=10
client.rm.lock.retryTimes=30
client.rm.lock.retryPolicyBranchRollbackOnConflict=true
client.rm.reportRetryCount=5
client.rm.tableMetaCheckEnable=false
client.rm.tableMetaCheckerInterval=60000
client.rm.sqlParserType=druid
client.rm.reportSuccessEnable=false
client.rm.sagaBranchRegisterEnable=false
# TMé…ç½®
client.tm.commitRetryCount=5
client.tm.rollbackRetryCount=5
client.tm.defaultGlobalTransactionTimeout=60000
client.tm.degradeCheck=false
client.tm.degradeCheckAllowTimes=10
client.tm.degradeCheckPeriod=2000

# undoæ—¥å¿—é…ç½®
client.undo.dataValidation=true
client.undo.logSerialization=jackson
client.undo.onlyCareUpdateColumns=true
client.undo.logTable=undo_log
client.undo.compress.enable=true
client.undo.compress.type=zip
client.undo.compress.threshold=64k
client.log.exceptionRate=100
```

3.å¾®æœåŠ¡è¯»å–nacosé…ç½®

æ¥ä¸‹æ¥ï¼Œéœ€è¦ä¿®æ”¹æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„ application.yml æ–‡ä»¶ï¼Œè®©å¾®æœåŠ¡è¯»å– Nacos ä¸­çš„ client.properties æ–‡ä»¶

```yaml
seata:
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      username: nacos
      password: nacos
      group: SEATA_GROUP
      data-id: client.properties
```

é‡å¯å¾®æœåŠ¡ï¼Œç°åœ¨å¾®æœåŠ¡åˆ°åº•æ˜¯è¿æ¥ TC çš„ SH é›†ç¾¤ï¼Œè¿˜æ˜¯ TC çš„ HZ é›†ç¾¤ï¼Œéƒ½ç»Ÿä¸€ç”± Nacos çš„ client.properties æ¥å†³å®šäº†ã€‚

å¤§ä½“å…ˆäº†è§£è¿™ä¹ˆå¤šï¼Œå…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£å­¦ä¹ ï¼šhttps://seata.io/zh-cn/docs/overview/what-is-seata.html

## XAæ¨¡å¼

XA è§„èŒƒ æ˜¯ X/Open ç»„ç»‡å®šä¹‰çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ï¼ˆDTPï¼ŒDistributed Transaction Processingï¼‰æ ‡å‡†ï¼ŒXA è§„èŒƒæè¿°äº†å…¨å±€çš„ TM ä¸å±€éƒ¨çš„ RM ä¹‹é—´çš„æ¥å£ï¼Œå‡ ä¹æ‰€æœ‰ä¸»æµçš„æ•°æ®åº“éƒ½å¯¹ XA è§„èŒƒæä¾›äº†æ”¯æŒã€‚

XA æ˜¯è§„èŒƒï¼Œç›®å‰ä¸»æµæ•°æ®åº“éƒ½å®ç°äº†è¿™ç§è§„èŒƒï¼Œå®ç°çš„åŸç†éƒ½æ˜¯**åŸºäºä¸¤é˜¶æ®µæäº¤**ã€‚

æ­£å¸¸æƒ…å†µï¼š

![](https://cdn.xn2001.com/img/2022/202205242231750.png)

å¼‚å¸¸æƒ…å†µï¼š

![](https://cdn.xn2001.com/img/2022/202205242231755.png)

ä¸€é˜¶æ®µï¼š

1.äº‹åŠ¡åè°ƒè€…é€šçŸ¥æ¯ä¸ªäº‹ç‰©å‚ä¸è€…æ‰§è¡Œæœ¬åœ°äº‹åŠ¡

2.æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå®ŒæˆåæŠ¥å‘Šäº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ç»™äº‹åŠ¡åè°ƒè€…ï¼Œæ­¤æ—¶äº‹åŠ¡ä¸æäº¤ï¼Œç»§ç»­æŒæœ‰æ•°æ®åº“é”

äºŒé˜¶æ®µï¼š

- äº‹åŠ¡åè°ƒè€…åŸºäºä¸€é˜¶æ®µçš„æŠ¥å‘Šæ¥åˆ¤æ–­ä¸‹ä¸€æ­¥æ“ä½œ
  - å¦‚æœä¸€é˜¶æ®µéƒ½æˆåŠŸï¼Œåˆ™é€šçŸ¥æ‰€æœ‰äº‹åŠ¡å‚ä¸è€…ï¼Œæäº¤äº‹åŠ¡
  - å¦‚æœä¸€é˜¶æ®µä»»æ„ä¸€ä¸ªå‚ä¸è€…å¤±è´¥ï¼Œåˆ™é€šçŸ¥æ‰€æœ‰äº‹åŠ¡å‚ä¸è€…å›æ»šäº‹åŠ¡

Seata å¯¹åŸå§‹çš„ XA æ¨¡å¼åšäº†ç®€å•çš„å°è£…å’Œæ”¹é€ ï¼Œä»¥é€‚åº”è‡ªå·±çš„äº‹åŠ¡æ¨¡å‹ï¼ŒåŸºæœ¬æ¶æ„å¦‚ä¸‹å›¾

![](https://cdn.xn2001.com/img/2022/202205242231760.png)

RM ä¸€é˜¶æ®µçš„å·¥ä½œï¼š

â‘  æ³¨å†Œåˆ†æ”¯äº‹åŠ¡åˆ°TC

â‘¡ æ‰§è¡Œåˆ†æ”¯ä¸šåŠ¡ SQL ä½†ä¸æäº¤

â‘¢ æŠ¥å‘Šæ‰§è¡ŒçŠ¶æ€åˆ° TC

TC äºŒé˜¶æ®µçš„å·¥ä½œï¼š

- TC æ£€æµ‹å„åˆ†æ”¯äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€

  a.å¦‚æœéƒ½æˆåŠŸï¼Œé€šçŸ¥æ‰€æœ‰ RM æäº¤äº‹åŠ¡

  b.å¦‚æœæœ‰å¤±è´¥ï¼Œé€šçŸ¥æ‰€æœ‰ RM å›æ»šäº‹åŠ¡

RM äºŒé˜¶æ®µçš„å·¥ä½œï¼š

- æ¥æ”¶ TC æŒ‡ä»¤ï¼Œæäº¤æˆ–å›æ»šäº‹åŠ¡

### ä¼˜ç¼ºç‚¹

XA æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- äº‹åŠ¡çš„å¼ºä¸€è‡´æ€§ï¼Œæ»¡è¶³ ACID åŸåˆ™ã€‚
- å¸¸ç”¨æ•°æ®åº“éƒ½æ”¯æŒï¼Œå®ç°ç®€å•ï¼Œå¹¶ä¸”æ²¡æœ‰ä»£ç ä¾µå…¥ã€‚

XA æ¨¡å¼çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- å› ä¸ºä¸€é˜¶æ®µéœ€è¦é”å®šæ•°æ®åº“èµ„æºï¼Œç­‰å¾…äºŒé˜¶æ®µç»“æŸæ‰é‡Šæ”¾ï¼Œæ€§èƒ½è¾ƒå·®ã€‚
- ä¾èµ–å…³ç³»å‹æ•°æ®åº“å®ç°äº‹åŠ¡ã€‚

### å®ç°XAæ¨¡å¼

Seata çš„ starter å·²ç»å®Œæˆäº† XA æ¨¡å¼çš„è‡ªåŠ¨è£…é…ï¼Œå®ç°éå¸¸ç®€å•ï¼Œæ­¥éª¤å¦‚ä¸‹

1ï¼‰ä¿®æ”¹æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„ application.yml æ–‡ä»¶ï¼ˆæ¯ä¸ªå‚ä¸äº‹åŠ¡çš„å¾®æœåŠ¡ï¼‰ï¼Œå¼€å¯XAæ¨¡å¼ï¼š

```yaml
seata:
  data-source-proxy-mode: XA
```

2ï¼‰ç»™å‘èµ·å…¨å±€äº‹åŠ¡çš„å…¥å£æ–¹æ³•æ·»åŠ  `@GlobalTransactional` æ³¨è§£

æœ¬ä¾‹ä¸­æ˜¯ OrderServiceImpl ä¸­çš„ create æ–¹æ³•.

![](https://cdn.xn2001.com/img/2022/202205242231783.png)

3ï¼‰é‡å¯æœåŠ¡å¹¶æµ‹è¯•

é‡å¯ order-serviceï¼Œå†æ¬¡æµ‹è¯•ï¼Œå‘ç°æ— è®ºæ€æ ·å¼‚å¸¸æƒ…å†µï¼Œä¸‰ä¸ªå¾®æœåŠ¡éƒ½èƒ½æˆåŠŸå›æ»šã€‚

## ATæ¨¡å¼

AT æ¨¡å¼åŒæ ·æ˜¯åˆ†é˜¶æ®µæäº¤çš„äº‹åŠ¡æ¨¡å‹ï¼Œä¸è¿‡ç¼ºå¼¥è¡¥äº†XAæ¨¡å‹ä¸­èµ„æºé”å®šå‘¨æœŸè¿‡é•¿çš„ç¼ºé™·ã€‚

åŸºæœ¬æµç¨‹å›¾ï¼š

![](https://cdn.xn2001.com/img/2022/202205242258121.png)

é˜¶æ®µä¸€ RM çš„å·¥ä½œï¼š

- æ³¨å†Œåˆ†æ”¯äº‹åŠ¡
- **è®°å½• undo-logï¼ˆæ•°æ®å¿«ç…§ï¼‰**
- **æ‰§è¡Œä¸šåŠ¡ SQL å¹¶æäº¤äº‹åŠ¡**
- æŠ¥å‘Šäº‹åŠ¡çŠ¶æ€

é˜¶æ®µäºŒæäº¤æ—¶ RM çš„å·¥ä½œï¼š

- åˆ é™¤ undo-log å³å¯

é˜¶æ®µäºŒå›æ»šæ—¶ RM çš„å·¥ä½œï¼š

- æ ¹æ® undo-log æ¢å¤æ•°æ®åˆ°æ›´æ–°å‰

### æµç¨‹æ¢³ç†

æˆ‘ä»¬ç”¨ä¸€ä¸ªçœŸå®çš„ä¸šåŠ¡æ¥æ¢³ç†ä¸‹ AT æ¨¡å¼çš„åŸç†ã€‚

æ¯”å¦‚ï¼Œç°åœ¨æœ‰ä¸€ä¸ªæ•°æ®åº“è¡¨ï¼Œè®°å½•ç”¨æˆ·ä½™é¢

| **id** | **money** |
| ------ | --------- |
| 1      | 100       |

å…¶ä¸­ä¸€ä¸ªåˆ†æ”¯ä¸šåŠ¡è¦æ‰§è¡Œçš„ SQL ä¸º

```sql
update tb_account set money = money - 10 where id = 1
```

ATæ¨¡å¼ä¸‹ï¼Œå½“å‰åˆ†æ”¯äº‹åŠ¡æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

ä¸€é˜¶æ®µï¼š

1ï¼‰TM å‘èµ·å¹¶æ³¨å†Œå…¨å±€äº‹åŠ¡åˆ° TC

2ï¼‰TM è°ƒç”¨åˆ†æ”¯äº‹åŠ¡

3ï¼‰åˆ†æ”¯äº‹åŠ¡å‡†å¤‡æ‰§è¡Œä¸šåŠ¡ SQL

4ï¼‰RM æ‹¦æˆªä¸šåŠ¡ SQLï¼Œæ ¹æ® where æ¡ä»¶æŸ¥è¯¢åŸå§‹æ•°æ®ï¼Œå½¢æˆå¿«ç…§ã€‚

```json
{
    "id": 1, "money": 100
}
```

5ï¼‰RM æ‰§è¡Œä¸šåŠ¡ SQLï¼Œæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“é”ã€‚æ­¤æ—¶ `money = 90`

6ï¼‰RM æŠ¥å‘Šæœ¬åœ°äº‹åŠ¡çŠ¶æ€ç»™ TC

äºŒé˜¶æ®µï¼š

1ï¼‰TM é€šçŸ¥ TC äº‹åŠ¡ç»“æŸ

2ï¼‰TC æ£€æŸ¥åˆ†æ”¯äº‹åŠ¡çŠ¶æ€ã€‚å¦‚æœéƒ½æˆåŠŸï¼Œåˆ™ç«‹å³åˆ é™¤å¿«ç…§ï¼›å¦‚æœæœ‰åˆ†æ”¯äº‹åŠ¡å¤±è´¥ï¼Œéœ€è¦å›æ»šã€‚è¯»å–å¿«ç…§æ•°æ®`{"id": 1, "money": 100}`ï¼Œå°†å¿«ç…§æ¢å¤åˆ°æ•°æ®åº“ã€‚æ­¤æ—¶æ•°æ®åº“å†æ¬¡æ¢å¤ä¸º 100ã€‚

![](https://cdn.xn2001.com/img/2022/202205242258118.png)

### ATä¸XAçš„åŒºåˆ«

ç®€è¿° AT æ¨¡å¼ä¸ XA æ¨¡å¼æœ€å¤§çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- XA æ¨¡å¼ä¸€é˜¶æ®µä¸æäº¤äº‹åŠ¡ï¼Œé”å®šèµ„æºï¼›AT æ¨¡å¼ä¸€é˜¶æ®µç›´æ¥æäº¤ï¼Œä¸é”å®šèµ„æºã€‚
- XA æ¨¡å¼ä¾èµ–æ•°æ®åº“æœºåˆ¶å®ç°å›æ»šï¼›AT æ¨¡å¼åˆ©ç”¨æ•°æ®å¿«ç…§å®ç°æ•°æ®å›æ»šã€‚
- XA æ¨¡å¼å¼ºä¸€è‡´ï¼›AT æ¨¡å¼æœ€ç»ˆä¸€è‡´ã€‚

### è„å†™é—®é¢˜

> æ³¨æ„ï¼šæ­¤å¤„è„å†™æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„é—®é¢˜

åœ¨**å¤šçº¿ç¨‹å¹¶å‘**è®¿é—® AT æ¨¡å¼çš„åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œæœ‰å¯èƒ½å‡ºç°è„å†™é—®é¢˜ã€‚å¦‚å›¾ï¼Œå½“äº‹åŠ¡ 1 å› ä¸ºæŸäº›åŸå› è¦æ¢å¤å¿«ç…§æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹çš„äº‹åŠ¡ 2 ç™½æ›´æ–°äº†ä¸€æ¬¡æ•°æ®ï¼Œå‡ºç°äº†è„å†™é—®é¢˜ã€‚

![](https://cdn.xn2001.com/img/2022/202205242258122.png)

è§£å†³æ€è·¯å°±æ˜¯å¼•å…¥äº†å…¨å±€é”çš„æ¦‚å¿µã€‚åœ¨æäº¤äº‹åŠ¡ä¹‹å‰ï¼Œå…ˆå»æ‹¿å…¨å±€é”ï¼Œé¿å…åŒä¸€æ—¶åˆ»æœ‰å¦å¤–ä¸€ä¸ªäº‹åŠ¡åœ¨æ“ä½œå½“å‰æ•°æ®ï¼Œæ‹¿ä¸åˆ°å…¨å±€é”è¶…è¿‡ä¸€å®šæ—¶é—´åˆ™å›æ»šã€‚å¦‚å›¾ï¼Œè¿™æ ·ä¸€æ¥äº‹åŠ¡ 2 å°±æ›´æ–°å¤±è´¥äº†ï¼Œæ­¤æ—¶äº‹åŠ¡ 1 æ¢å¤æ•°æ®ä¸ä¼šç»™å¦ä¸€ä¸ªçº¿ç¨‹äº‹åŠ¡ 2 é€ æˆæ”¹äº†åˆæ²¡æ”¹çš„ç¦»è°±ç°è±¡ã€‚

![](https://cdn.xn2001.com/img/2022/202205242258136.png)

### ä¼˜ç¼ºç‚¹

AT æ¨¡å¼çš„ä¼˜ç‚¹ï¼š

- ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½æ¯”è¾ƒå¥½
- åˆ©ç”¨å…¨å±€é”å®ç°è¯»å†™éš”ç¦»
- æ²¡æœ‰ä»£ç ä¾µå…¥ï¼Œæ¡†æ¶è‡ªåŠ¨å®Œæˆå›æ»šå’Œæäº¤

AT æ¨¡å¼çš„ç¼ºç‚¹ï¼š

- ä¸¤é˜¶æ®µä¹‹é—´å±äºè½¯çŠ¶æ€ï¼Œå±äºæœ€ç»ˆä¸€è‡´
- æ¡†æ¶çš„å¿«ç…§åŠŸèƒ½ä¼šå½±å“æ€§èƒ½ï¼Œä½†æ¯”XAæ¨¡å¼è¦å¥½å¾ˆå¤š

### å®ç°ATæ¨¡å¼

AT æ¨¡å¼ä¸­çš„å¿«ç…§ç”Ÿæˆã€å›æ»šç­‰åŠ¨ä½œéƒ½æ˜¯ç”±æ¡†æ¶è‡ªåŠ¨å®Œæˆï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥ï¼Œå› æ­¤å®ç°éå¸¸ç®€å•ã€‚

åªä¸è¿‡ï¼ŒATæ¨¡å¼éœ€è¦ä¸€ä¸ªè¡¨æ¥è®°å½•å…¨å±€é”ã€å¦ä¸€å¼ è¡¨æ¥è®°å½•æ•°æ®å¿«ç…§ undo_log

1ï¼‰å¯¼å…¥æ•°æ®åº“è¡¨ï¼Œè®°å½•å…¨å±€é”

lock_table è¡¨å¯¼å…¥åˆ° TC æœåŠ¡å…³è”çš„æ•°æ®åº“ï¼Œæˆ‘è¿™é‡Œçš„ TC æœåŠ¡æ•°æ®åº“æ˜¯ seata

```sql
-- ----------------------------
-- Table structure for lock_table
-- ----------------------------
DROP TABLE IF EXISTS `lock_table`;
CREATE TABLE `lock_table`  (
  `row_key` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `xid` varchar(96) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `branch_id` bigint(20) NOT NULL,
  `resource_id` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `table_name` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `pk` varchar(36) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime NULL DEFAULT NULL,
  `gmt_modified` datetime NULL DEFAULT NULL,
  PRIMARY KEY (`row_key`) USING BTREE,
  INDEX `idx_branch_id`(`branch_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;
```

undo_log è¡¨å¯¼å…¥åˆ°å¾®æœåŠ¡å…³è”çš„æ•°æ®åº“ï¼Œæˆ‘è¿™é‡Œçš„å¾®æœåŠ¡æ•°æ®åº“æ˜¯ seata_demo

```sql
-- ----------------------------
-- Table structure for undo_log
-- ----------------------------
DROP TABLE IF EXISTS `undo_log`;
CREATE TABLE `undo_log`  (
  `branch_id` bigint(20) NOT NULL COMMENT 'branch transaction id',
  `xid` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT 'global transaction id',
  `context` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT 'undo_log context,such as serialization',
  `rollback_info` longblob NOT NULL COMMENT 'rollback info',
  `log_status` int(11) NOT NULL COMMENT '0:normal status,1:defense status',
  `log_created` datetime(6) NOT NULL COMMENT 'create datetime',
  `log_modified` datetime(6) NOT NULL COMMENT 'modify datetime',
  UNIQUE INDEX `ux_undo_log`(`xid`, `branch_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = 'AT transaction mode undo table' ROW_FORMAT = Compact;
```

2ï¼‰ä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œå°†äº‹åŠ¡æ¨¡å¼ä¿®æ”¹ä¸º AT æ¨¡å¼å³å¯ã€‚

```yaml
seata:
  data-source-proxy-mode: AT # é»˜è®¤å°±æ˜¯AT
```

3ï¼‰é‡å¯æœåŠ¡å¹¶æµ‹è¯•ã€‚

## TCCæ¨¡å¼

TCC æ¨¡å¼ä¸ AT æ¨¡å¼éå¸¸ç›¸ä¼¼ï¼Œæ¯é˜¶æ®µéƒ½æ˜¯ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸åŒçš„æ˜¯ TCC æ¨¡å¼é€šè¿‡äººå·¥ç¼–ç æ¥å®ç°æ•°æ®æ¢å¤ã€‚éœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š

- Tryï¼šèµ„æºçš„æ£€æµ‹å’Œé¢„ç•™ï¼› 

- Confirmï¼šå®Œæˆèµ„æºæ“ä½œä¸šåŠ¡ï¼›è¦æ±‚ Try æˆåŠŸ Confirm ä¸€å®šè¦èƒ½æˆåŠŸã€‚

- Cancelï¼šé¢„ç•™èµ„æºé‡Šæ”¾ï¼Œå¯ä»¥ç†è§£ä¸º try çš„åå‘æ“ä½œã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ªæ‰£å‡ç”¨æˆ·ä½™é¢çš„ä¸šåŠ¡ã€‚å‡è®¾è´¦æˆ· A åŸæ¥ä½™é¢æ˜¯ 100ï¼Œéœ€è¦ä½™é¢æ‰£å‡ 30 å…ƒã€‚

**é˜¶æ®µä¸€ï¼ˆ Try ï¼‰**ï¼šæ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³åˆ™å†»ç»“é‡‘é¢å¢åŠ  30 å…ƒï¼Œå¯ç”¨ä½™é¢æ‰£é™¤ 30

åˆå§‹ä½™é¢

![](https://cdn.xn2001.com/img/2022/202205261907452.png)

ä½™é¢å……è¶³ï¼Œå¯ä»¥å†»ç»“

![](https://cdn.xn2001.com/img/2022/202205261907455.png)

æ­¤æ—¶ï¼Œæ€»é‡‘é¢ = å†»ç»“é‡‘é¢ + å¯ç”¨é‡‘é¢ï¼Œæ•°é‡ä¾ç„¶æ˜¯ 100 ä¸å˜ã€‚äº‹åŠ¡ç›´æ¥æäº¤æ— éœ€ç­‰å¾…å…¶å®ƒäº‹åŠ¡ã€‚

**é˜¶æ®µäºŒï¼ˆConfirm)**ï¼šå‡å¦‚è¦æäº¤ï¼ˆConfirmï¼‰ï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡ 30

ç¡®è®¤å¯ä»¥æäº¤ï¼Œä¸è¿‡ä¹‹å‰å¯ç”¨é‡‘é¢å·²ç»æ‰£å‡è¿‡äº†ï¼Œè¿™é‡Œåªè¦æ¸…é™¤å†»ç»“é‡‘é¢å°±å¥½äº†

![](https://cdn.xn2001.com/img/2022/202205261907456.png)

æ­¤æ—¶ï¼Œæ€»é‡‘é¢ = å†»ç»“é‡‘é¢ + å¯ç”¨é‡‘é¢ = 0 + 70  = 70å…ƒ

**é˜¶æ®µäºŒ(Canncel)**ï¼šå¦‚æœè¦å›æ»šï¼ˆCancelï¼‰ï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡ 30ï¼Œå¯ç”¨ä½™é¢å¢åŠ  30

éœ€è¦å›æ»šï¼Œé‚£ä¹ˆå°±è¦é‡Šæ”¾å†»ç»“é‡‘é¢ï¼Œæ¢å¤å¯ç”¨é‡‘é¢

![](https://cdn.xn2001.com/img/2022/202205261907454.png)

Seata ä¸­çš„ TCC æ¨¡å‹ä¾ç„¶å»¶ç»­ä¹‹å‰çš„äº‹åŠ¡æ¶æ„ï¼Œå¦‚å›¾ï¼š

![](https://cdn.xn2001.com/img/2022/202205261907469.png)

### ä¼˜ç¼ºç‚¹

TCC æ¨¡å¼çš„æ¯ä¸ªé˜¶æ®µæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ

- Tryï¼šèµ„æºæ£€æŸ¥å’Œé¢„ç•™
- Confirmï¼šä¸šåŠ¡æ‰§è¡Œå’Œæäº¤
- Cancelï¼šé¢„ç•™èµ„æºçš„é‡Šæ”¾

TCC çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½å¥½
- ç›¸æ¯” AT æ¨¡å‹ï¼Œæ— éœ€ç”Ÿæˆå¿«ç…§ï¼Œæ— éœ€ä½¿ç”¨å…¨å±€é”ï¼Œæ€§èƒ½æœ€å¼º
- ä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼Œè€Œæ˜¯ä¾èµ–è¡¥å¿æ“ä½œï¼Œå¯ä»¥ç”¨äºéäº‹åŠ¡å‹æ•°æ®åº“

TCC çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- æœ‰ä»£ç ä¾µå…¥ï¼Œéœ€è¦äººä¸ºç¼–å†™ tryã€Confirm å’Œ Cancel æ¥å£ï¼Œå¤ªéº»çƒ¦
- è½¯çŠ¶æ€ï¼Œäº‹åŠ¡æ˜¯æœ€ç»ˆä¸€è‡´
- éœ€è¦è€ƒè™‘ Confirm å’Œ Cancel çš„å¤±è´¥æƒ…å†µï¼Œåšå¥½å¹‚ç­‰å¤„ç†

### ç©ºå›æ»š

å½“æŸåˆ†æ”¯äº‹åŠ¡çš„ try é˜¶æ®µ**é˜»å¡**æ—¶ï¼Œå¯èƒ½å¯¼è‡´å…¨å±€äº‹åŠ¡è¶…æ—¶è€Œè§¦å‘äºŒé˜¶æ®µçš„ cancel æ“ä½œã€‚åœ¨æœªæ‰§è¡Œ try æ“ä½œæ—¶å…ˆæ‰§è¡Œäº† cancel æ“ä½œï¼Œè¿™æ—¶cancel ä¸èƒ½åšå›æ»šï¼Œå°±æ˜¯**ç©ºå›æ»š**ã€‚æ‰§è¡Œ cancel æ“ä½œæ—¶ï¼Œåº”å½“åˆ¤æ–­ try æ˜¯å¦å·²ç»æ‰§è¡Œï¼Œå¦‚æœå°šæœªæ‰§è¡Œï¼Œåˆ™åº”è¯¥ç©ºå›æ»šã€‚

![](https://cdn.xn2001.com/img/2022/202205261921656.png)

### ä¸šåŠ¡æ‚¬æŒ‚

ç©ºå›æ»šåå‡ºç°çš„ä¸€ä¸ªæ–°é—®é¢˜ï¼šå¯¹äºå·²ç»ç©ºå›æ»šçš„ä¸šåŠ¡ï¼Œä¹‹å‰è¢«é˜»å¡çš„ try æ“ä½œæ¢å¤ï¼Œç»§ç»­æ‰§è¡Œ tryï¼Œå¯æ­¤æ—¶æ•´ä¸ªä¸šåŠ¡éƒ½å·²ç»ç»“æŸäº†ï¼Œéš¾é“æˆ‘ä»¬å¯ä»¥è®©ä»–å†å»èµ° confirm æˆ– cancel å—ï¼Œæ˜¾ç„¶ä¸è¡Œã€‚å› æ­¤äº‹åŠ¡ä¸€ç›´å¤„äºä¸­é—´çŠ¶æ€ï¼Œè¿™å°±æ˜¯**ä¸šåŠ¡æ‚¬æŒ‚**ï¼Œæˆ‘ä»¬åº”å½“å»é¿å…è¿™ç§æƒ…å†µã€‚æ‰€ä»¥æ‰§è¡Œ try æ“ä½œæ—¶ï¼Œåº”å½“åˆ¤æ–­ cancel æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡äº†ï¼Œå¦‚æœå·²ç»æ‰§è¡Œï¼Œ**åº”å½“é˜»æ­¢ç©ºå›æ»šåçš„ try æ“ä½œï¼Œé¿å…æ‚¬æŒ‚ã€‚**

### å®ç°TCCæ¨¡å¼

#### è®¾è®¡æ•°æ®è¡¨

å®ç° TCC æ¨¡å¼æˆ‘ä»¬éƒ½çŸ¥é“è¦å»è®°å½•å†»ç»“çŠ¶æ€ï¼Œæ‰€ä»¥è¿™å°±éœ€è¦ä¸€ä¸ªæ•°æ®è¡¨ã€‚

xidï¼šæ˜¯å…¨å±€äº‹åŠ¡ id

freeze_moneyï¼šç”¨æ¥è®°å½•ç”¨æˆ·å†»ç»“é‡‘é¢

stateï¼šç”¨æ¥è®°å½•äº‹åŠ¡çŠ¶æ€

```sql
CREATE TABLE `account_freeze_tbl` (
  `xid` varchar(128) NOT NULL,
  `user_id` varchar(255) DEFAULT NULL COMMENT 'ç”¨æˆ·id',
  `freeze_money` int(11) unsigned DEFAULT '0' COMMENT 'å†»ç»“é‡‘é¢',
  `state` int(1) DEFAULT NULL COMMENT 'äº‹åŠ¡çŠ¶æ€ï¼Œ0:tryï¼Œ1:confirmï¼Œ2:cancel',
  PRIMARY KEY (`xid`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;
```

- Try ä¸šåŠ¡
  - è®°å½•å†»ç»“é‡‘é¢å’Œäº‹åŠ¡çŠ¶æ€åˆ° account_freeze è¡¨
  - æ‰£å‡ account è¡¨å¯ç”¨é‡‘é¢
- Confirm ä¸šåŠ¡
  - æ ¹æ® xid åˆ é™¤ account_freeze è¡¨çš„å†»ç»“è®°å½•
- Cancel ä¸šåŠ¡
  - ä¿®æ”¹ account_freeze è¡¨ï¼Œå†»ç»“é‡‘é¢ä¸º 0ï¼Œstate ä¸º 2
  - ä¿®æ”¹ account è¡¨ï¼Œæ¢å¤å¯ç”¨é‡‘é¢
- å¦‚ä½•åˆ¤æ–­æ˜¯å¦ç©ºå›æ»š
  - cancel ä¸šåŠ¡ä¸­ï¼Œæ ¹æ® xid æŸ¥è¯¢ account_freezeï¼Œå¦‚æœä¸º null åˆ™è¯´æ˜ try è¿˜æ²¡åšï¼Œéœ€è¦ç©ºå›æ»š
- å¦‚ä½•é¿å…ä¸šåŠ¡æ‚¬æŒ‚
  - try ä¸šåŠ¡ä¸­ï¼Œæ ¹æ® xid æŸ¥è¯¢ account_freezeï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™è¯æ˜ Cancel å·²ç»æ‰§è¡Œï¼Œæ‹’ç»æ‰§è¡Œ try ä¸šåŠ¡

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ ¹æ®å®é™…ä¸šåŠ¡ä¿®æ”¹ account-serviceï¼Œåˆ©ç”¨ TCC å®ç°ä½™é¢æ‰£å‡åŠŸèƒ½ã€‚

#### å£°æ˜TCCæ¥å£

> Seata å…¨å±€äº‹åŠ¡çš„ id å¯ä»¥é€šè¿‡ `RootContext.getXID();` è·å–ï¼Œ
>
> ä¹Ÿå¯ä»¥é€šè¿‡ BusinessActionContext å‚æ•°çš„ getXid() æ–¹æ³•è·å–ã€‚

TCC çš„ Tryã€Confirmã€Cancel æ–¹æ³•éƒ½éœ€è¦åœ¨æ¥å£ä¸­åŸºäºæ³¨è§£æ¥å£°æ˜ï¼Œé¦–å…ˆæ˜¯æ¥å£ä¸Šè¦ç”¨ `@LocalTCC`ï¼Œtry é€»è¾‘æ–¹æ³•ç”¨æ³¨è§£`@TwoPhaseBusinessAction(name="try æ–¹æ³•å", commitMethod="confirm æ–¹æ³•å", rollbackMethod="cancel æ–¹æ³•å") `æ³¨æ˜ ï¼Œåœ¨è¯¥æ–¹æ³•å‚æ•°ä¸ŠåŠ å…¥ `@BusinessActionContextParameter(paramName="try æ–¹æ³•çš„å‚æ•°")`ï¼Œå¯ä»¥ä½¿å¾—è¯¥å‚æ•°ä¼ å…¥ `BusinessActionContext` ç±»ï¼Œä¾¿äº confirm å’Œ cancel è¯»å–ã€‚

![](https://cdn.xn2001.com/img/2022/202205281606688.png)

æˆ‘ä»¬åœ¨ account-service é¡¹ç›®ä¸­çš„ service åŒ…ä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå£°æ˜ TCC ä¸‰ä¸ªæ¥å£ã€‚

```java
@LocalTCC
public interface AccountTCCService {

    @TwoPhaseBusinessAction(name = "deduct", commitMethod = "confirm", rollbackMethod = "cancel")
    void deduct(@BusinessActionContextParameter(paramName = "userId") String userId,
                @BusinessActionContextParameter(paramName = "money")int money);

    boolean confirm(BusinessActionContext ctx);

    boolean cancel(BusinessActionContext ctx);
}
```

#### ç¼–å†™å®ç°ç±»

åœ¨ account-service æœåŠ¡ä¸­çš„ service.impl åŒ…ä¸‹æ–°å»ºä¸€ä¸ªç±»ï¼Œå®ç° TCC ä¸šåŠ¡

```java
@Service
@Slf4j
public class AccountTCCServiceImpl implements AccountTCCService {
    @Autowired
    private AccountMapper accountMapper;
    @Autowired
    private AccountFreezeMapper freezeMapper;

    @Override
    @Transactional
    public void deduct(String userId, int money) {
        // 0.è·å–äº‹åŠ¡id
        String xid = RootContext.getXID();
        // å¤„ç†ä¸šåŠ¡æ‚¬æŒ‚
        if (freezeMapper.selectById(xid) != null) {
            return;
        }
        // 1.æ‰£å‡å¯ç”¨ä½™é¢
        accountMapper.deduct(userId, money);
        // 2.è®°å½•å†»ç»“é‡‘é¢ï¼Œäº‹åŠ¡çŠ¶æ€
        AccountFreeze freeze = new AccountFreeze();
        freeze.setUserId(userId);
        freeze.setFreezeMoney(money);
        freeze.setState(AccountFreeze.State.TRY);
        freeze.setXid(xid);
        freezeMapper.insert(freeze);
    }

    @Override
    public boolean confirm(BusinessActionContext ctx) {
        // 1.è·å–äº‹åŠ¡id
        String xid = ctx.getXid();
        // 2.æ ¹æ®idåˆ é™¤å†»ç»“è®°å½•
        int count = freezeMapper.deleteById(xid);
        return count == 1;
    }

    @Override
    public boolean cancel(BusinessActionContext ctx) {
        // 0.æŸ¥è¯¢å†»ç»“è®°å½•
        String xid = ctx.getXid();
        AccountFreeze freeze = freezeMapper.selectById(xid);
        // å¤„ç†ç©ºå›æ»š
        if (freeze == null) {
            //ç©ºå›æ»š
            freeze = new AccountFreeze();
            String userId = ctx.getActionContext("userId").toString();
            freeze.setUserId(userId);
            freeze.setFreezeMoney(0);
            freeze.setState(AccountFreeze.State.CANCEL);
            freeze.setXid(xid);
            freezeMapper.insert(freeze);
            return true;
        }
        // å¹‚ç­‰åˆ¤æ–­
        if(freeze.getState() == AccountFreeze.State.CANCEL){
            // å·²ç»å¤„ç†è¿‡äº†cancelï¼Œæ— éœ€é‡å¤
            return true;
        }
        // 1.æ¢å¤å¯ç”¨ä½™é¢
        accountMapper.refund(freeze.getUserId(), freeze.getFreezeMoney());
        // 2.å°†å†»ç»“é‡‘é¢æ¸…é›¶ï¼ŒçŠ¶æ€æ”¹ä¸ºCANCEL
        freeze.setFreezeMoney(0);
        freeze.setState(AccountFreeze.State.CANCEL);
        int count = freezeMapper.updateById(freeze);
        return count == 1;
    }
}
```

## SAGAæ¨¡å¼

Saga æ¨¡å¼æ˜¯ Seata å³å°†å¼€æºçš„é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œå°†ç”±èš‚èšé‡‘æœä¸»è¦è´¡çŒ®ã€‚Seata å®˜ç½‘å¯¹äº Saga çš„æŒ‡å—ï¼šhttps://seata.io/zh-cn/docs/user/saga.html

åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¾æ¬¡æ‰§è¡Œå„å‚ä¸è€…çš„æ­£å‘æ“ä½œï¼Œå¦‚æœæ‰€æœ‰æ­£å‘æ“ä½œå‡æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡æäº¤ã€‚å¦‚æœä»»æ„ä¸€ä¸ªæ­£å‘æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¼šå»é€€å›å»æ‰§è¡Œå‰é¢å„å‚ä¸è€…çš„é€†å‘å›æ»šæ“ä½œï¼Œå›æ»šå·²æäº¤çš„å‚ä¸è€…ï¼Œä½¿åˆ†å¸ƒå¼äº‹åŠ¡å›åˆ°åˆå§‹çŠ¶æ€ã€‚

![](https://cdn.xn2001.com/img/2022/202205281708899.png)

Saga æ¨¡å¼ä¹Ÿåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ

- ä¸€é˜¶æ®µï¼šç›´æ¥æäº¤æœ¬åœ°äº‹åŠ¡
- äºŒé˜¶æ®µï¼šæˆåŠŸåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼›å¤±è´¥åˆ™é€šè¿‡ç¼–å†™è¡¥å¿ä¸šåŠ¡æ¥å›æ»š

### ä¼˜ç¼ºç‚¹

ä¼˜ç‚¹ï¼š

- äº‹åŠ¡å‚ä¸è€…å¯ä»¥åŸºäºäº‹ä»¶é©±åŠ¨å®ç°å¼‚æ­¥è°ƒç”¨ï¼Œååé«˜
- ä¸€é˜¶æ®µç›´æ¥æäº¤äº‹åŠ¡ï¼Œæ— é”ï¼Œæ€§èƒ½å¥½
- ä¸ç”¨ç¼–å†™ TCC ä¸­çš„ä¸‰ä¸ªé˜¶æ®µï¼Œå®ç°ç®€å•

ç¼ºç‚¹ï¼š

- è½¯çŠ¶æ€æŒç»­æ—¶é—´ä¸ç¡®å®šï¼Œæ—¶æ•ˆæ€§å·®
- æ²¡æœ‰é”ï¼Œæ²¡æœ‰äº‹åŠ¡éš”ç¦»ï¼Œä¼šæœ‰è„å†™

# Redisåˆ†å¸ƒå¼ç¼“å­˜

> é™ˆå¹´æ—§äº‹ Redisï¼šhttps://www.xn2001.com/archives/598.html

å•æœºçš„ Redis å­˜åœ¨ä»¥ä¸‹å››å¤§é—®é¢˜ï¼Œæˆ‘ä»¬å°†å­¦ç€å»è§£å†³ã€‚

![](https://cdn.xn2001.com/img/2022/202206142215082.png)

## RedisæŒä¹…åŒ–

- RDB æŒä¹…åŒ–
- AOF æŒä¹…åŒ–

### RDBæŒä¹…åŒ–

RDB å…¨ç§° Redis Database Backup fileï¼ˆRedisæ•°æ®å¤‡ä»½æ–‡ä»¶ï¼‰ï¼Œä¹Ÿè¢«å«åš Redis æ•°æ®å¿«ç…§ã€‚ç®€å•æ¥è¯´å°±æ˜¯æŠŠå†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è®°å½•åˆ°ç£ç›˜ä¸­ã€‚å½“ Redis å®ä¾‹æ•…éšœé‡å¯åï¼Œä»ç£ç›˜è¯»å–å¿«ç…§æ–‡ä»¶ï¼Œæ¢å¤æ•°æ®ã€‚å¿«ç…§æ–‡ä»¶ç§°ä¸º RDB æ–‡ä»¶ï¼Œ**é»˜è®¤æ˜¯ä¿å­˜åœ¨å½“å‰è¿è¡Œç›®å½•ã€‚**

RDB æŒä¹…åŒ–åœ¨å››ç§æƒ…å†µä¸‹ä¼šæ‰§è¡Œ

- æ‰§è¡Œ save å‘½ä»¤
- æ‰§è¡Œ bgsave å‘½ä»¤
- Redis åœæœºæ—¶
- è§¦å‘ RDB æ¡ä»¶æ—¶

**save å‘½ä»¤**

æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œä¸€æ¬¡ RDB

![](https://cdn.xn2001.com/img/2022/202206142216902.png)

save å‘½ä»¤ä¼šå¯¼è‡´ä¸»è¿›ç¨‹æ‰§è¡Œ RDBï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­å…¶å®ƒæ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«é˜»å¡ã€‚åªæœ‰åœ¨æ•°æ®è¿ç§»æ—¶å¯èƒ½ç”¨åˆ°ã€‚

**bgsave å‘½ä»¤**

ä¸‹é¢çš„å‘½ä»¤å¯ä»¥å¼‚æ­¥æ‰§è¡Œ RDB

![](https://cdn.xn2001.com/img/2022/202206142216906.png)

è¿™ä¸ªå‘½ä»¤æ‰§è¡Œåä¼šå¼€å¯ç‹¬ç«‹è¿›ç¨‹å®Œæˆ RDBï¼Œä¸»è¿›ç¨‹å¯ä»¥æŒç»­å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œä¸å—å½±å“ã€‚

**åœæœºæ—¶**

Redis åœæœºæ—¶ä¼šæ‰§è¡Œä¸€æ¬¡ save å‘½ä»¤ï¼Œå®ç° RDB æŒä¹…åŒ–ã€‚

**è‡ªåŠ¨è§¦å‘ RDB æ¡ä»¶**

Redis å†…éƒ¨æœ‰è§¦å‘ RDB çš„æœºåˆ¶ï¼Œå¯ä»¥åœ¨ redis.conf æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```properties
# 900ç§’å†…ï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyè¢«ä¿®æ”¹ï¼Œåˆ™æ‰§è¡Œbgsave
# save "" åˆ™è¡¨ç¤ºç¦ç”¨RDB
save 900 1  
save 300 10  
save 60 10000 
```

RDB çš„å…¶å®ƒé…ç½®ä¹Ÿå¯ä»¥åœ¨ redis.conf æ–‡ä»¶ä¸­è®¾ç½®

```properties
# æ˜¯å¦å‹ç¼© ,å»ºè®®ä¸å¼€å¯ï¼Œå‹ç¼©ä¹Ÿä¼šæ¶ˆè€—cpuï¼Œç£ç›˜çš„è¯ä¸å€¼é’±
rdbcompression yes
# RDBæ–‡ä»¶åç§°
dbfilename dump.rdb  
# æ–‡ä»¶ä¿å­˜çš„è·¯å¾„ç›®å½•
dir ./ 
```

bgsave å¼€å§‹æ—¶ä¼š fork ä¸»è¿›ç¨‹å¾—åˆ°å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å…±äº«ä¸»è¿›ç¨‹çš„å†…å­˜æ•°æ®ã€‚å®Œæˆ fork åè¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥ RDB æ–‡ä»¶ã€‚

fork é‡‡ç”¨çš„æ˜¯ copy-on-write æŠ€æœ¯ï¼šå½“ä¸»è¿›ç¨‹æ‰§è¡Œè¯»æ“ä½œæ—¶ï¼Œè®¿é—®å…±äº«å†…å­˜ï¼›å½“ä¸»è¿›ç¨‹æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œåˆ™ä¼šæ‹·è´ä¸€ä»½æ•°æ®ï¼Œæ‰§è¡Œå†™æ“ä½œã€‚

![](https://cdn.xn2001.com/img/2022/202206142216920.png)

RDB æ–¹å¼ bgsave çš„åŸºæœ¬æµç¨‹ï¼Ÿ

- forkä¸»è¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå…±äº«å†…å­˜ç©ºé—´
- å­è¿›ç¨‹è¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥æ–° çš„RDB æ–‡ä»¶
- ç”¨æ–° RDB æ–‡ä»¶æ›¿æ¢æ—§çš„ RDB æ–‡ä»¶

RDB ä¼šåœ¨ä»€ä¹ˆæ—¶å€™è‡ªåŠ¨æ‰§è¡Œï¼Ÿsave 60 1000ä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Ÿ

- é»˜è®¤æ˜¯æœåŠ¡åœæ­¢æ—¶
- ä»£è¡¨ 60s å†…è‡³å°‘æ‰§è¡Œ 1000 æ¬¡ä¿®æ”¹åˆ™è§¦å‘ RDB

RDB çš„ç¼ºç‚¹ï¼Ÿ

- RDB æ‰§è¡Œé—´éš”æ—¶é—´é•¿ï¼Œä¸¤æ¬¡ RDB ä¹‹é—´å†™å…¥æ•°æ®æœ‰ä¸¢å¤±çš„é£é™©
- fork å­è¿›ç¨‹ã€å‹ç¼©ã€å†™å‡º RDB æ–‡ä»¶éƒ½æ¯”è¾ƒè€—æ—¶

### AOFæŒä¹…åŒ–

AOF å…¨ç§°ä¸º Append Only Fileï¼ˆè¿½åŠ æ–‡ä»¶ï¼‰ï¼ŒRedis å¤„ç†çš„æ¯ä¸€ä¸ªå†™å‘½ä»¤éƒ½ä¼šè®°å½•åœ¨ AOF æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åšæ˜¯å‘½ä»¤æ—¥å¿—æ–‡ä»¶ã€‚

![](https://cdn.xn2001.com/img/2022/202206142216922.png)

AOF é»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦ä¿®æ”¹ redis.conf é…ç½®æ–‡ä»¶æ¥å¼€å¯ AOF

```properties
# æ˜¯å¦å¼€å¯AOFåŠŸèƒ½ï¼Œé»˜è®¤æ˜¯no
appendonly yes
# AOFæ–‡ä»¶çš„åç§°
appendfilename "appendonly.aof"
```

AOF çš„å‘½ä»¤è®°å½•çš„é¢‘ç‡ä¹Ÿå¯ä»¥é€šè¿‡ redis.conf æ–‡ä»¶æ¥é…

```properties
# è¡¨ç¤ºæ¯æ‰§è¡Œä¸€æ¬¡å†™å‘½ä»¤ï¼Œç«‹å³è®°å½•åˆ°AOFæ–‡ä»¶
appendfsync always 
# å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç„¶åè¡¨ç¤ºæ¯éš”1ç§’å°†ç¼“å†²åŒºæ•°æ®å†™åˆ°AOFæ–‡ä»¶ï¼Œæ˜¯é»˜è®¤æ–¹æ¡ˆ
appendfsync everysec 
# å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç£ç›˜
appendfsync no
```

ä¸‰ç§ç­–ç•¥å¯¹æ¯”

![](https://cdn.xn2001.com/img/2022/202206142216924.png)

**AOFæ–‡ä»¶é‡å†™**

å› ä¸ºæ˜¯è®°å½•å‘½ä»¤ï¼ŒAOF æ–‡ä»¶ä¼šæ¯” RDB æ–‡ä»¶å¤§çš„å¤šã€‚è€Œä¸” AOF ä¼šè®°å½•å¯¹åŒä¸€ä¸ª key çš„å¤šæ¬¡å†™æ“ä½œï¼Œä½†åªæœ‰æœ€åä¸€æ¬¡å†™æ“ä½œæ‰æœ‰æ„ä¹‰ã€‚é€šè¿‡æ‰§è¡Œ bgrewriteaof å‘½ä»¤ï¼Œå¯ä»¥è®© AOF æ–‡ä»¶æ‰§è¡Œé‡å†™åŠŸèƒ½ï¼Œç”¨æœ€å°‘çš„å‘½ä»¤è¾¾åˆ°ç›¸åŒæ•ˆæœã€‚

![](https://cdn.xn2001.com/img/2022/202206142216934.png)

å¦‚å›¾ï¼ŒAOF åŸæœ¬æœ‰ä¸‰ä¸ªå‘½ä»¤ï¼Œä½†æ˜¯è¿™ä¸‰ä¸ªéƒ½æ˜¯å¯¹ num çš„æ“ä½œï¼Œç¬¬äºŒæ¬¡ä¼šè¦†ç›–ç¬¬ä¸€æ¬¡çš„å€¼ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªå‘½ä»¤è®°å½•ä¸‹æ¥æ²¡æœ‰æ„ä¹‰ã€‚

æ‰€ä»¥é‡å†™å‘½ä»¤åï¼ŒAOFæ–‡ä»¶å†…å®¹å°±æ˜¯ï¼š`mset name jack num 666`

Redis ä¹Ÿä¼šåœ¨è§¦å‘é˜ˆå€¼æ—¶è‡ªåŠ¨å»é‡å†™ AOF æ–‡ä»¶ã€‚é˜ˆå€¼ä¹Ÿå¯ä»¥åœ¨ redis.conf ä¸­é…ç½®

```properties
# AOFæ–‡ä»¶æ¯”ä¸Šæ¬¡æ–‡ä»¶ å¢é•¿è¶…è¿‡å¤šå°‘ç™¾åˆ†æ¯”åˆ™è§¦å‘é‡å†™
auto-aof-rewrite-percentage 100
# AOFæ–‡ä»¶ä½“ç§¯æœ€å°å¤šå¤§ä»¥ä¸Šæ‰è§¦å‘é‡å†™ 
auto-aof-rewrite-min-size 64mb 
```

RDB å’Œ AOF å„æœ‰è‡ªå·±çš„ä¼˜ç¼ºç‚¹ï¼Œå¦‚æœå¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜ï¼Œåœ¨å®é™…å¼€å‘ä¸­å¾€å¾€ä¼šç»“åˆä¸¤è€…æ¥ä½¿ç”¨ã€‚

![](https://cdn.xn2001.com/img/2022/202206142216414.png)

Redis æ”¯æŒåŒæ—¶å¼€å¯ RDB å’Œ AOFï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å½“ Redis é‡å¯çš„æ—¶å€™ä¼šä¼˜å…ˆè½½å…¥ AOF æ–‡ä»¶æ¥æ¢å¤åŸå§‹çš„æ•°æ®ï¼Œå› ä¸ºåœ¨é€šå¸¸æƒ…å†µä¸‹ AOF æ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦æ¯” RDB æ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†å®Œæ•´ã€‚

## Redisä¸»ä»å¤åˆ¶

å•èŠ‚ç‚¹ Redis çš„å¹¶å‘èƒ½åŠ›æ˜¯æœ‰ä¸Šé™çš„ï¼Œè¦è¿›ä¸€æ­¥æé«˜ Redis çš„å¹¶å‘èƒ½åŠ›ï¼Œå°±éœ€è¦æ­å»ºä¸»ä»é›†ç¾¤ï¼Œå®ç°è¯»å†™åˆ†ç¦»ã€‚

![](https://cdn.xn2001.com/img/2022/202206142243954.png)

### æ­å»ºä¸»ä»

> è·³è¿‡éƒ¨ç½²ä¸‰ä¸ª Redisï¼Œå¾ˆç®€å•ã€‚

å…±åŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸¤ä¸ªä»èŠ‚ç‚¹ã€‚

è¿™é‡Œæˆ‘ä»¬åœ¨åŒä¸€å°è™šæ‹Ÿæœºä¸­å¼€å¯ 3 ä¸ª Redis å®ä¾‹ï¼Œæ¨¡æ‹Ÿä¸»ä»é›†ç¾¤ï¼Œä¿¡æ¯å¦‚ä¸‹ï¼š

|       IP        | PORT |  è§’è‰²  |
| :-------------: | :--: | :----: |
| 192.168.150.101 | 7001 | master |
| 192.168.150.101 | 7002 | slave  |
| 192.168.150.101 | 7003 | slave  |

ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬æ‰“å¼€ 3 ä¸ª ssh çª—å£ï¼Œåˆ†åˆ«å¯åŠ¨ Redis å®ä¾‹ï¼Œå¯åŠ¨å‘½ä»¤ï¼š

```sh
# ç¬¬1ä¸ª
redis-server 7001/redis.conf
# ç¬¬2ä¸ª
redis-server 7002/redis.conf
# ç¬¬3ä¸ª
redis-server 7003/redis.conf
```

![](https://cdn.xn2001.com/img/2022/202206150213482.png)

å¦‚æœè¦ä¸€é”®åœæ­¢ï¼Œå¯ä»¥è¿è¡Œä¸‹é¢å‘½ä»¤ï¼š

```sh
printf '%s\n' 7001 7002 7003 | xargs -I{} -t redis-cli -p {} shutdown
```

**å¼€å¯ä¸»ä»å…³ç³»**

ç°åœ¨ä¸‰ä¸ªå®ä¾‹è¿˜æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œè¦é…ç½®ä¸»ä»å¯ä»¥ä½¿ç”¨ `replicaof` æˆ–è€… `slaveof`ï¼ˆ5.0ä»¥å‰ï¼‰å‘½ä»¤ã€‚

æœ‰ä¸´æ—¶å’Œæ°¸ä¹…ä¸¤ç§æ¨¡å¼ï¼š

1.ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰

åœ¨ redis.conf ä¸­æ·»åŠ ä¸€è¡Œé…ç½®ï¼š```slaveof <masterip> <masterport>```

2.ä½¿ç”¨ redis-cli å®¢æˆ·ç«¯è¿æ¥åˆ°redisæœåŠ¡ï¼Œæ‰§è¡Œslaveofå‘½ä»¤ï¼ˆé‡å¯åå¤±æ•ˆï¼‰

`slaveof <masterip> <masterport>`

>  åœ¨ 5.0 ä»¥åæ–°å¢å‘½ä»¤ replicaofï¼Œä¸ salveof æ•ˆæœä¸€è‡´ã€‚

è¿™é‡Œæˆ‘ä»¬ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œä½¿ç”¨æ–¹å¼äºŒã€‚é€šè¿‡ redis-cli å‘½ä»¤è¿æ¥ 7002ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤

```sh
# è¿æ¥ 7002
redis-cli -p 7002
# æ‰§è¡Œslaveof
slaveof 192.168.150.101 7001
```

é€šè¿‡ redis-cli å‘½ä»¤è¿æ¥ 7003ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤

```sh
# è¿æ¥ 7003
redis-cli -p 7003
# æ‰§è¡Œslaveof
slaveof 192.168.150.101 7001
```

ç„¶åè¿æ¥ 7001 èŠ‚ç‚¹ï¼ŒæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š

```sh
# è¿æ¥ 7001
redis-cli -p 7001
# æŸ¥çœ‹çŠ¶æ€
info replication
```

![](https://cdn.xn2001.com/img/2022/202206150213485.png)

æ‰§è¡Œä¸‹åˆ—æ“ä½œä»¥æµ‹è¯•

- åˆ©ç”¨ redis-cli è¿æ¥7001ï¼Œæ‰§è¡Œ```set num 123```

- åˆ©ç”¨ redis-cli è¿æ¥7002ï¼Œæ‰§è¡Œ```get num```ï¼Œå†æ‰§è¡Œ```set num 666```

- åˆ©ç”¨ redis-cli è¿æ¥7003ï¼Œæ‰§è¡Œ```get num```ï¼Œå†æ‰§è¡Œ```set num 888```

å¯ä»¥å‘ç°ï¼Œåªæœ‰åœ¨ 7001 è¿™ä¸ª master èŠ‚ç‚¹ä¸Šå¯ä»¥æ‰§è¡Œå†™æ“ä½œï¼Œ7002 å’Œ 7003 è¿™ä¸¤ä¸ª slave èŠ‚ç‚¹åªèƒ½æ‰§è¡Œè¯»æ“ä½œã€‚

### åŒæ­¥åŸç†

#### å…¨é‡åŒæ­¥

ä¸»ä»ç¬¬ä¸€æ¬¡å»ºç«‹è¿æ¥æ—¶ï¼Œä¼šæ‰§è¡Œ**å…¨é‡åŒæ­¥**ï¼Œå°† master èŠ‚ç‚¹çš„æ‰€æœ‰æ•°æ®éƒ½æ‹·è´ç»™ slave èŠ‚ç‚¹ï¼Œæµç¨‹å¦‚ä¸‹

![](https://cdn.xn2001.com/img/2022/202206150222378.png)

æœ‰å‡ ä¸ªæ¦‚å¿µéœ€è¦çŸ¥é“ï¼š

- **Replication Id**ï¼šç®€ç§° replidï¼Œæ˜¯æ•°æ®é›†çš„æ ‡è®°ï¼Œid ä¸€è‡´åˆ™è¯´æ˜æ˜¯åŒä¸€æ•°æ®é›†ã€‚æ¯ä¸€ä¸ª master éƒ½æœ‰å”¯ä¸€çš„replidï¼Œslave åˆ™ä¼šç»§æ‰¿ master èŠ‚ç‚¹çš„ replidï¼›
- **offset**ï¼šåç§»é‡ï¼Œéšç€è®°å½•åœ¨ repl_baklog ä¸­çš„æ•°æ®å¢å¤šè€Œé€æ¸å¢å¤§ã€‚slave å®ŒæˆåŒæ­¥æ—¶ä¹Ÿä¼šè®°å½•å½“å‰åŒæ­¥çš„offsetï¼Œå³ slave çš„ offset æ°¸è¿œå°äºç­‰äº master çš„ offsetï¼›å½“ slave çš„ offset å°äº master çš„ offsetï¼Œè¯´æ˜ slave æ•°æ®è½åäº masterï¼Œéœ€è¦æ›´æ–°ã€‚

å› æ­¤ slave åšæ•°æ®åŒæ­¥ï¼Œå¿…é¡»å‘ master å£°æ˜è‡ªå·±çš„ replid å’Œ offsetï¼Œmaster æ‰å¯ä»¥åˆ¤æ–­åˆ°åº•éœ€è¦åŒæ­¥å“ªäº›æ•°æ®ã€‚è€Œ slave åŸæœ¬ä¹Ÿæ˜¯ä¸€ä¸ª masterï¼Œæœ‰è‡ªå·±çš„ replid å’Œ offsetï¼Œå½“ç¬¬ä¸€æ¬¡å˜æˆ slaveï¼Œä¸ master å»ºç«‹è¿æ¥æ—¶ï¼Œå‘é€çš„ replid å’Œ offset æ˜¯è‡ªå·±çš„ replid å’Œ offsetã€‚master åˆ¤æ–­å‘ç° slave å‘é€æ¥çš„ replid ä¸è‡ªå·±çš„ä¸ä¸€è‡´ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„ slaveï¼Œå°±çŸ¥é“è¦åšå…¨é‡åŒæ­¥äº†ã€‚master ä¼šå°†è‡ªå·±çš„ replid å’Œ offset éƒ½å‘é€ç»™è¿™ä¸ª slaveï¼Œslave ä¿å­˜è¿™äº›ä¿¡æ¯ã€‚ä»¥å slave çš„replid å°±ä¸ master ä¸€è‡´äº†ã€‚å› æ­¤ï¼Œ**masteråˆ¤æ–­ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥çš„ä¾æ®ï¼Œå°±æ˜¯çœ‹ replid æ˜¯å¦ä¸€è‡´**ã€‚

![](https://cdn.xn2001.com/img/2022/202206150222382.png)

å®Œæ•´æµç¨‹æè¿°ï¼š

- slave èŠ‚ç‚¹è¯·æ±‚å¢é‡åŒæ­¥
- master èŠ‚ç‚¹åˆ¤æ–­ replidï¼Œå‘ç°ä¸ä¸€è‡´ï¼Œæ‹’ç»å¢é‡åŒæ­¥ï¼Œé€‰æ‹©å…¨é‡åŒæ­¥
- master å°†å®Œæ•´å†…å­˜æ•°æ®ç”Ÿæˆ RDBï¼Œå‘é€ RDB åˆ° slave
- slave æ¸…ç©ºæœ¬åœ°æ•°æ®ï¼ŒåŠ è½½ master çš„ RDB
- master å°† RDB æœŸé—´çš„å‘½ä»¤è®°å½•åœ¨ repl_baklogï¼Œå¹¶æŒç»­å°† log ä¸­çš„å‘½ä»¤å‘é€ç»™ slave
- slave æ‰§è¡Œæ¥æ”¶åˆ°çš„å‘½ä»¤ï¼Œä¿æŒä¸ master ä¹‹é—´çš„åŒæ­¥

#### å¢é‡åŒæ­¥

å…¨é‡åŒæ­¥éœ€è¦å…ˆåš RDBï¼Œç„¶åå°† RDB æ–‡ä»¶é€šè¿‡ç½‘ç»œä¼ è¾“ç»™ slaveï¼Œæˆæœ¬å¤ªé«˜ã€‚å› æ­¤é™¤äº†ç¬¬ä¸€æ¬¡åšå…¨é‡åŒæ­¥ï¼Œå…¶å®ƒå¤§å¤šæ•°æ—¶å€™ slave ä¸ master éƒ½æ˜¯åš**å¢é‡åŒæ­¥**ã€‚

ä»€ä¹ˆæ˜¯å¢é‡åŒæ­¥ï¼Ÿå°±æ˜¯åªæ›´æ–° slave ä¸ master å­˜åœ¨å·®å¼‚çš„éƒ¨åˆ†æ•°æ®ã€‚

![](https://cdn.xn2001.com/img/2022/202206150222386.png)

**repl_backlog åŸç†**

master æ€ä¹ˆçŸ¥é“ slave ä¸è‡ªå·±çš„æ•°æ®å·®å¼‚åœ¨å“ªé‡Œï¼Ÿ

è¿™å°±è¦è¯´åˆ°å…¨é‡åŒæ­¥æ—¶çš„ repl_baklog æ–‡ä»¶äº†ã€‚

è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„ï¼Œåªä¸è¿‡æ•°ç»„æ˜¯ç¯å½¢ï¼Œä¹Ÿå°±æ˜¯è¯´**è§’æ ‡åˆ°è¾¾æ•°ç»„æœ«å°¾åï¼Œä¼šå†æ¬¡ä» 0 å¼€å§‹è¯»å†™**ï¼Œè¿™æ ·æ•°ç»„å¤´éƒ¨çš„æ•°æ®å°±ä¼šè¢«è¦†ç›–ã€‚repl_baklog ä¸­ä¼šè®°å½• Redis å¤„ç†è¿‡çš„å‘½ä»¤æ—¥å¿—åŠ offsetï¼ŒåŒ…æ‹¬ master å½“å‰çš„ offset å’Œ slave å·²ç»æ‹·è´åˆ°çš„ offset

![](https://cdn.xn2001.com/img/2022/202206150222384.png) 

slave ä¸ master çš„ offset ä¹‹é—´çš„å·®å¼‚ï¼Œå°±æ˜¯ salve éœ€è¦å¢é‡æ‹·è´çš„æ•°æ®äº†ã€‚

éšç€ä¸æ–­æœ‰æ•°æ®å†™å…¥ï¼Œmaster çš„ offset é€æ¸å˜å¤§ï¼Œslave ä¹Ÿä¸æ–­çš„æ‹·è´ï¼Œè¿½èµ¶ master çš„ offsetï¼Œç›´åˆ°æ•°ç»„è¢«å¡«æ»¡ï¼š

![](https://cdn.xn2001.com/img/2022/202206150222403.png) 

![](https://cdn.xn2001.com/img/2022/202206150222407.png) 

æ­¤æ—¶ï¼Œå¦‚æœæœ‰æ–°çš„æ•°æ®å†™å…¥ï¼Œå°±ä¼šè¦†ç›–æ•°ç»„ä¸­çš„æ—§æ•°æ®ã€‚ä¸è¿‡ï¼Œæ—§çš„æ•°æ®åªè¦æ˜¯ç»¿è‰²çš„ï¼Œè¯´æ˜æ˜¯å·²ç»è¢«åŒæ­¥åˆ°slave çš„æ•°æ®ï¼Œå³ä¾¿è¢«è¦†ç›–äº†ä¹Ÿæ²¡ä»€ä¹ˆå½±å“ã€‚å› ä¸ºæœªåŒæ­¥çš„ä»…ä»…æ˜¯çº¢è‰²éƒ¨åˆ†ã€‚ä½†æ˜¯ï¼Œå¦‚æœ slave å‡ºç°ç½‘ç»œé˜»å¡ï¼Œå¯¼è‡´ master çš„ offset è¿œè¿œè¶…è¿‡äº† slave çš„ offsetï¼Œå¦‚ä¸‹å›¾

![](https://cdn.xn2001.com/img/2022/202206150222063.png) 

å¦‚æœ master ç»§ç»­å†™å…¥æ–°æ•°æ®ï¼Œå…¶ offset å°±ä¼šè¦†ç›–æ—§çš„æ•°æ®ï¼Œç›´åˆ°å°† slave ç°åœ¨çš„ offset ä¹Ÿè¦†ç›–äº†

![](https://cdn.xn2001.com/img/2022/202206150222082.png) 

æ£•è‰²æ¡†ä¸­çš„çº¢è‰²éƒ¨åˆ†ï¼Œå°±æ˜¯å°šæœªåŒæ­¥ï¼Œä½†æ˜¯å´å·²ç»è¢«è¦†ç›–çš„æ•°æ®ã€‚æ­¤æ—¶å¦‚æœ slave æ¢å¤ï¼Œéœ€è¦åŒæ­¥ï¼Œå´å‘ç°è‡ªå·±çš„ offset éƒ½æ²¡æœ‰äº†ï¼Œ**æ— æ³•å®Œæˆå¢é‡åŒæ­¥äº†ï¼Œåªèƒ½åšå…¨é‡åŒæ­¥ã€‚**

![](https://cdn.xn2001.com/img/2022/202206150222104.png)

### ä¸»ä»åŒæ­¥ä¼˜åŒ–

ä¸»ä»åŒæ­¥å¯ä»¥ä¿è¯ä¸»ä»æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéå¸¸é‡è¦ã€‚å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥ä¼˜åŒ– Redis ä¸»ä»é›†ç¾¤

- åœ¨ master ä¸­é…ç½® `repl-diskless-sync yes` å¯ç”¨æ— ç£ç›˜å¤åˆ¶ï¼Œé¿å…å…¨é‡åŒæ­¥æ—¶çš„ç£ç›˜ IO
- Redis å•èŠ‚ç‚¹ä¸Šçš„å†…å­˜å ç”¨ä¸è¦å¤ªå¤§ï¼Œå‡å°‘ RDB å¯¼è‡´çš„è¿‡å¤šç£ç›˜IO
- é€‚å½“æé«˜ repl_baklog çš„å¤§å°ï¼Œå‘ç° slave å®•æœºæ—¶å°½å¿«å®ç°æ•…éšœæ¢å¤ï¼Œå°½å¯èƒ½é¿å…å…¨é‡åŒæ­¥
- é™åˆ¶ä¸€ä¸ª master ä¸Šçš„ slave èŠ‚ç‚¹æ•°é‡ï¼Œå¦‚æœå®åœ¨æ˜¯å¤ªå¤š slaveï¼Œåˆ™å¯ä»¥é‡‡ç”¨**ä¸»-ä»-ä»**é“¾å¼ç»“æ„ï¼Œå‡å°‘ master å‹åŠ›

![](https://cdn.xn2001.com/img/2022/202206150222112.png)

ç®€è¿°å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥åŒºåˆ«ï¼Ÿ

- å…¨é‡åŒæ­¥ï¼šmaster å°†å®Œæ•´å†…å­˜æ•°æ®ç”Ÿæˆ RDBï¼Œå‘é€ RDB åˆ° slaveã€‚åç»­å‘½ä»¤åˆ™è®°å½•åœ¨ repl_baklogï¼Œé€ä¸ªå‘é€ç»™slave
- å¢é‡åŒæ­¥ï¼šslave æäº¤è‡ªå·±çš„ offset åˆ° masterï¼Œmaster è·å– repl_baklog ä¸­ä» offset ä¹‹åçš„å‘½ä»¤ç»™slave

ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå…¨é‡åŒæ­¥ï¼Ÿ

- slave èŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥ master èŠ‚ç‚¹æ—¶
- slave èŠ‚ç‚¹æ–­å¼€æ—¶é—´å¤ªä¹…ï¼Œrepl_baklog ä¸­çš„ offset å·²ç»è¢«è¦†ç›–æ—¶

ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå¢é‡åŒæ­¥ï¼Ÿ

- slave èŠ‚ç‚¹æ–­å¼€åˆæ¢å¤ï¼Œå¹¶ä¸”åœ¨ repl_baklog ä¸­èƒ½æ‰¾åˆ° offset æ—¶

## Rediså“¨å…µ



## Redisåˆ†ç‰‡é›†ç¾¤